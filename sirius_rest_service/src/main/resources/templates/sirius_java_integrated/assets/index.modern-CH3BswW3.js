import{u as Q0,j as Cd,r as fr,G as ey,_ as Xi,l as le,g as rc,a as ty,c as ry,b as ny,d as iy,e as xf,t as Ad,f as as,h as ay,T as sy,P as oy,i as ly}from"./index-UNc6UntD.js";import{j as $c,a as cy}from"./emotion-react-jsx-runtime.browser.esm-BKKAi3Po.js";const uy=(a,e)=>Xi({WebkitFontSmoothing:"antialiased",MozOsxFontSmoothing:"grayscale",boxSizing:"border-box",WebkitTextSizeAdjust:"100%"},e&&!a.vars&&{colorScheme:a.palette.mode}),fy=a=>Xi({color:(a.vars||a).palette.text.primary},a.typography.body1,{backgroundColor:(a.vars||a).palette.background.default,"@media print":{backgroundColor:(a.vars||a).palette.common.white}}),hy=(a,e=!1)=>{var t;const n={};e&&a.colorSchemes&&Object.entries(a.colorSchemes).forEach(([s,o])=>{var l;n[a.getColorSchemeSelector(s).replace(/\s*&/,"")]={colorScheme:(l=o.palette)==null?void 0:l.mode}});let r=Xi({html:uy(a,e),"*, *::before, *::after":{boxSizing:"inherit"},"strong, b":{fontWeight:a.typography.fontWeightBold},body:Xi({margin:0},fy(a),{"&::backdrop":{backgroundColor:(a.vars||a).palette.background.default}})},n);const i=(t=a.components)==null||(t=t.MuiCssBaseline)==null?void 0:t.styleOverrides;return i&&(r=[r,i]),r};function dy(a){const e=Q0({props:a,name:"MuiCssBaseline"}),{children:t,enableColorScheme:n=!1}=e;return Cd.jsxs(fr.Fragment,{children:[Cd.jsx(ey,{styles:r=>hy(r,n)}),t]})}/**
 * @license
 * Copyright 2010-2021 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const Fv="131",py=0,Td=1,my=2,Qf=1,vy=2,js=3,ji=0,Ut=1,Yi=2,Bv=1,zn=0,$s=1,Rd=2,Ld=3,Pd=4,gy=5,Va=100,_y=101,yy=102,Nd=103,Id=104,xy=200,Sy=201,by=202,wy=203,zv=204,Vv=205,My=206,Ey=207,Cy=208,Ay=209,Ty=210,Ry=0,Ly=1,Py=2,nc=3,Ny=4,Iy=5,ky=6,Oy=7,_c=0,Dy=1,Fy=2,Hi=0,By=1,zy=2,Vy=3,Uy=4,Gy=5,yc=300,xc=301,Sc=302,Sf=303,bf=304,bc=306,eh=307,no=1e3,dr=1001,wf=1002,It=1003,kd=1004,Od=1005,pt=1006,Hy=1007,wc=1008,xi=1009,Wy=1010,Xy=1011,io=1012,jy=1013,ql=1014,yn=1015,Xa=1016,Yy=1017,qy=1018,$y=1019,Zs=1020,Zy=1021,fi=1022,Ft=1023,Uv=1024,Ky=1025,Jy=Ft,ja=1026,ao=1027,Qy=1028,e1=1029,t1=1030,r1=1031,n1=1032,i1=1033,Dd=33776,Fd=33777,Bd=33778,zd=33779,Vd=35840,Ud=35841,Gd=35842,Hd=35843,a1=36196,Wd=37492,Xd=37496,s1=37808,o1=37809,l1=37810,c1=37811,u1=37812,f1=37813,h1=37814,d1=37815,p1=37816,m1=37817,v1=37818,g1=37819,_1=37820,y1=37821,x1=36492,S1=37840,b1=37841,w1=37842,M1=37843,E1=37844,C1=37845,A1=37846,T1=37847,R1=37848,L1=37849,P1=37850,N1=37851,I1=37852,k1=37853,O1=2200,D1=2201,F1=2202,ic=2300,ac=2301,Zc=2302,Ga=2400,Ha=2401,sc=2402,th=2500,Gv=2501,B1=0,Cr=3e3,Mc=3001,rh=3007,nh=3002,z1=3003,Hv=3004,Wv=3005,Xv=3006,V1=3200,U1=3201,ss=0,G1=1,Kc=7680,H1=519,so=35044,oc=35048,jd="300 es";let Ji=class{addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const n=this._listeners;n[e]===void 0&&(n[e]=[]),n[e].indexOf(t)===-1&&n[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const n=this._listeners;return n[e]!==void 0&&n[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const r=this._listeners[e];if(r!==void 0){const i=r.indexOf(t);i!==-1&&r.splice(i,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const n=this._listeners[e.type];if(n!==void 0){e.target=this;const r=n.slice(0);for(let i=0,s=r.length;i<s;i++)r[i].call(this,e);e.target=null}}};const Kt=[];for(let a=0;a<256;a++)Kt[a]=(a<16?"0":"")+a.toString(16);let Yo=1234567;const Ya=Math.PI/180,oo=180/Math.PI;function on(){const a=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,n=Math.random()*4294967295|0;return(Kt[a&255]+Kt[a>>8&255]+Kt[a>>16&255]+Kt[a>>24&255]+"-"+Kt[e&255]+Kt[e>>8&255]+"-"+Kt[e>>16&15|64]+Kt[e>>24&255]+"-"+Kt[t&63|128]+Kt[t>>8&255]+"-"+Kt[t>>16&255]+Kt[t>>24&255]+Kt[n&255]+Kt[n>>8&255]+Kt[n>>16&255]+Kt[n>>24&255]).toUpperCase()}function Er(a,e,t){return Math.max(e,Math.min(t,a))}function ih(a,e){return(a%e+e)%e}function W1(a,e,t,n,r){return n+(a-e)*(r-n)/(t-e)}function X1(a,e,t){return a!==e?(t-a)/(e-a):0}function Ks(a,e,t){return(1-t)*a+t*e}function j1(a,e,t,n){return Ks(a,e,1-Math.exp(-t*n))}function Y1(a,e=1){return e-Math.abs(ih(a,e*2)-e)}function q1(a,e,t){return a<=e?0:a>=t?1:(a=(a-e)/(t-e),a*a*(3-2*a))}function $1(a,e,t){return a<=e?0:a>=t?1:(a=(a-e)/(t-e),a*a*a*(a*(a*6-15)+10))}function Z1(a,e){return a+Math.floor(Math.random()*(e-a+1))}function K1(a,e){return a+Math.random()*(e-a)}function J1(a){return a*(.5-Math.random())}function Q1(a){return a!==void 0&&(Yo=a%2147483647),Yo=Yo*16807%2147483647,(Yo-1)/2147483646}function ex(a){return a*Ya}function tx(a){return a*oo}function Mf(a){return(a&a-1)===0&&a!==0}function rx(a){return Math.pow(2,Math.ceil(Math.log(a)/Math.LN2))}function jv(a){return Math.pow(2,Math.floor(Math.log(a)/Math.LN2))}function nx(a,e,t,n,r){const i=Math.cos,s=Math.sin,o=i(t/2),l=s(t/2),c=i((e+n)/2),u=s((e+n)/2),f=i((e-n)/2),h=s((e-n)/2),d=i((n-e)/2),p=s((n-e)/2);switch(r){case"XYX":a.set(o*u,l*f,l*h,o*c);break;case"YZY":a.set(l*h,o*u,l*f,o*c);break;case"ZXZ":a.set(l*f,l*h,o*u,o*c);break;case"XZX":a.set(o*u,l*p,l*d,o*c);break;case"YXY":a.set(l*d,o*u,l*p,o*c);break;case"ZYZ":a.set(l*p,l*d,o*u,o*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}var Vn=Object.freeze({__proto__:null,DEG2RAD:Ya,RAD2DEG:oo,generateUUID:on,clamp:Er,euclideanModulo:ih,mapLinear:W1,inverseLerp:X1,lerp:Ks,damp:j1,pingpong:Y1,smoothstep:q1,smootherstep:$1,randInt:Z1,randFloat:K1,randFloatSpread:J1,seededRandom:Q1,degToRad:ex,radToDeg:tx,isPowerOfTwo:Mf,ceilPowerOfTwo:rx,floorPowerOfTwo:jv,setQuaternionFromProperEuler:nx});class ve{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6],this.y=r[1]*t+r[4]*n+r[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t,n){return n!==void 0&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),r=Math.sin(t),i=this.x-e.x,s=this.y-e.y;return this.x=i*n-s*r+e.x,this.y=i*r+s*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}}ve.prototype.isVector2=!0;class zt{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(e,t,n,r,i,s,o,l,c){const u=this.elements;return u[0]=e,u[1]=r,u[2]=o,u[3]=t,u[4]=i,u[5]=l,u[6]=n,u[7]=s,u[8]=c,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,r=t.elements,i=this.elements,s=n[0],o=n[3],l=n[6],c=n[1],u=n[4],f=n[7],h=n[2],d=n[5],p=n[8],v=r[0],_=r[3],m=r[6],g=r[1],y=r[4],x=r[7],S=r[2],M=r[5],E=r[8];return i[0]=s*v+o*g+l*S,i[3]=s*_+o*y+l*M,i[6]=s*m+o*x+l*E,i[1]=c*v+u*g+f*S,i[4]=c*_+u*y+f*M,i[7]=c*m+u*x+f*E,i[2]=h*v+d*g+p*S,i[5]=h*_+d*y+p*M,i[8]=h*m+d*x+p*E,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],l=e[6],c=e[7],u=e[8];return t*s*u-t*o*c-n*i*u+n*o*l+r*i*c-r*s*l}invert(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],l=e[6],c=e[7],u=e[8],f=u*s-o*c,h=o*l-u*i,d=c*i-s*l,p=t*f+n*h+r*d;if(p===0)return this.set(0,0,0,0,0,0,0,0,0);const v=1/p;return e[0]=f*v,e[1]=(r*c-u*n)*v,e[2]=(o*n-r*s)*v,e[3]=h*v,e[4]=(u*t-r*l)*v,e[5]=(r*i-o*t)*v,e[6]=d*v,e[7]=(n*l-c*t)*v,e[8]=(s*t-n*i)*v,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,r,i,s,o){const l=Math.cos(i),c=Math.sin(i);return this.set(n*l,n*c,-n*(l*s+c*o)+s+e,-r*c,r*l,-r*(-c*s+l*o)+o+t,0,0,1),this}scale(e,t){const n=this.elements;return n[0]*=e,n[3]*=e,n[6]*=e,n[1]*=t,n[4]*=t,n[7]*=t,this}rotate(e){const t=Math.cos(e),n=Math.sin(e),r=this.elements,i=r[0],s=r[3],o=r[6],l=r[1],c=r[4],u=r[7];return r[0]=t*i+n*l,r[3]=t*s+n*c,r[6]=t*o+n*u,r[1]=-n*i+t*l,r[4]=-n*s+t*c,r[7]=-n*o+t*u,this}translate(e,t){const n=this.elements;return n[0]+=e*n[2],n[3]+=e*n[5],n[6]+=e*n[8],n[1]+=t*n[2],n[4]+=t*n[5],n[7]+=t*n[8],this}equals(e){const t=this.elements,n=e.elements;for(let r=0;r<9;r++)if(t[r]!==n[r])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return new this.constructor().fromArray(this.elements)}}zt.prototype.isMatrix3=!0;let oa;class os{static getDataURL(e){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>"u")return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{oa===void 0&&(oa=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),oa.width=e.width,oa.height=e.height;const n=oa.getContext("2d");e instanceof ImageData?n.putImageData(e,0,0):n.drawImage(e,0,0,e.width,e.height),t=oa}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}}let ix=0;class Qt extends Ji{constructor(e=Qt.DEFAULT_IMAGE,t=Qt.DEFAULT_MAPPING,n=dr,r=dr,i=pt,s=wc,o=Ft,l=xi,c=1,u=Cr){super(),Object.defineProperty(this,"id",{value:ix++}),this.uuid=on(),this.name="",this.image=e,this.mipmaps=[],this.mapping=t,this.wrapS=n,this.wrapT=r,this.magFilter=i,this.minFilter=s,this.anisotropy=c,this.format=o,this.internalFormat=null,this.type=l,this.offset=new ve(0,0),this.repeat=new ve(1,1),this.center=new ve(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new zt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=u,this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];const n={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(this.image!==void 0){const r=this.image;if(r.uuid===void 0&&(r.uuid=on()),!t&&e.images[r.uuid]===void 0){let i;if(Array.isArray(r)){i=[];for(let s=0,o=r.length;s<o;s++)r[s].isDataTexture?i.push(Jc(r[s].image)):i.push(Jc(r[s]))}else i=Jc(r);e.images[r.uuid]={uuid:r.uuid,url:i}}n.image=r.uuid}return t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==yc)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case no:e.x=e.x-Math.floor(e.x);break;case dr:e.x=e.x<0?0:1;break;case wf:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case no:e.y=e.y-Math.floor(e.y);break;case dr:e.y=e.y<0?0:1;break;case wf:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&this.version++}}Qt.DEFAULT_IMAGE=void 0;Qt.DEFAULT_MAPPING=yc;Qt.prototype.isTexture=!0;function Jc(a){return typeof HTMLImageElement<"u"&&a instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&a instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&a instanceof ImageBitmap?os.getDataURL(a):a.data?{data:Array.prototype.slice.call(a.data),width:a.width,height:a.height,type:a.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}class ht{constructor(e=0,t=0,n=0,r=1){this.x=e,this.y=t,this.z=n,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,r=this.z,i=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*r+s[12]*i,this.y=s[1]*t+s[5]*n+s[9]*r+s[13]*i,this.z=s[2]*t+s[6]*n+s[10]*r+s[14]*i,this.w=s[3]*t+s[7]*n+s[11]*r+s[15]*i,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,r,i;const l=e.elements,c=l[0],u=l[4],f=l[8],h=l[1],d=l[5],p=l[9],v=l[2],_=l[6],m=l[10];if(Math.abs(u-h)<.01&&Math.abs(f-v)<.01&&Math.abs(p-_)<.01){if(Math.abs(u+h)<.1&&Math.abs(f+v)<.1&&Math.abs(p+_)<.1&&Math.abs(c+d+m-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const y=(c+1)/2,x=(d+1)/2,S=(m+1)/2,M=(u+h)/4,E=(f+v)/4,N=(p+_)/4;return y>x&&y>S?y<.01?(n=0,r=.707106781,i=.707106781):(n=Math.sqrt(y),r=M/n,i=E/n):x>S?x<.01?(n=.707106781,r=0,i=.707106781):(r=Math.sqrt(x),n=M/r,i=N/r):S<.01?(n=.707106781,r=.707106781,i=0):(i=Math.sqrt(S),n=E/i,r=N/i),this.set(n,r,i,t),this}let g=Math.sqrt((_-p)*(_-p)+(f-v)*(f-v)+(h-u)*(h-u));return Math.abs(g)<.001&&(g=1),this.x=(_-p)/g,this.y=(f-v)/g,this.z=(h-u)/g,this.w=Math.acos((c+d+m-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t,n){return n!==void 0&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}}ht.prototype.isVector4=!0;class Gt extends Ji{constructor(e,t,n={}){super(),this.width=e,this.height=t,this.depth=1,this.scissor=new ht(0,0,e,t),this.scissorTest=!1,this.viewport=new ht(0,0,e,t),this.texture=new Qt(void 0,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.encoding),this.texture.isRenderTargetTexture=!0,this.texture.image={width:e,height:t,depth:1},this.texture.generateMipmaps=n.generateMipmaps!==void 0?n.generateMipmaps:!1,this.texture.minFilter=n.minFilter!==void 0?n.minFilter:pt,this.depthBuffer=n.depthBuffer!==void 0?n.depthBuffer:!0,this.stencilBuffer=n.stencilBuffer!==void 0?n.stencilBuffer:!1,this.depthTexture=n.depthTexture!==void 0?n.depthTexture:null}setTexture(e){e.image={width:this.width,height:this.height,depth:this.depth},this.texture=e}setSize(e,t,n=1){(this.width!==e||this.height!==t||this.depth!==n)&&(this.width=e,this.height=t,this.depth=n,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=n,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.image={...this.texture.image},this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}Gt.prototype.isWebGLRenderTarget=!0;class ax extends Gt{constructor(e,t,n){super(e,t);const r=this.texture;this.texture=[];for(let i=0;i<n;i++)this.texture[i]=r.clone()}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let r=0,i=this.texture.length;r<i;r++)this.texture[r].image.width=e,this.texture[r].image.height=t,this.texture[r].image.depth=n;this.dispose()}return this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t),this}copy(e){this.dispose(),this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.set(0,0,this.width,this.height),this.scissor.set(0,0,this.width,this.height),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this.texture.length=0;for(let t=0,n=e.texture.length;t<n;t++)this.texture[t]=e.texture[t].clone();return this}}ax.prototype.isWebGLMultipleRenderTargets=!0;class Yv extends Gt{constructor(e,t,n){super(e,t,n),this.samples=4}copy(e){return super.copy.call(this,e),this.samples=e.samples,this}}Yv.prototype.isWebGLMultisampleRenderTarget=!0;class Xt{constructor(e=0,t=0,n=0,r=1){this._x=e,this._y=t,this._z=n,this._w=r}static slerp(e,t,n,r){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),n.slerpQuaternions(e,t,r)}static slerpFlat(e,t,n,r,i,s,o){let l=n[r+0],c=n[r+1],u=n[r+2],f=n[r+3];const h=i[s+0],d=i[s+1],p=i[s+2],v=i[s+3];if(o===0){e[t+0]=l,e[t+1]=c,e[t+2]=u,e[t+3]=f;return}if(o===1){e[t+0]=h,e[t+1]=d,e[t+2]=p,e[t+3]=v;return}if(f!==v||l!==h||c!==d||u!==p){let _=1-o;const m=l*h+c*d+u*p+f*v,g=m>=0?1:-1,y=1-m*m;if(y>Number.EPSILON){const S=Math.sqrt(y),M=Math.atan2(S,m*g);_=Math.sin(_*M)/S,o=Math.sin(o*M)/S}const x=o*g;if(l=l*_+h*x,c=c*_+d*x,u=u*_+p*x,f=f*_+v*x,_===1-o){const S=1/Math.sqrt(l*l+c*c+u*u+f*f);l*=S,c*=S,u*=S,f*=S}}e[t]=l,e[t+1]=c,e[t+2]=u,e[t+3]=f}static multiplyQuaternionsFlat(e,t,n,r,i,s){const o=n[r],l=n[r+1],c=n[r+2],u=n[r+3],f=i[s],h=i[s+1],d=i[s+2],p=i[s+3];return e[t]=o*p+u*f+l*d-c*h,e[t+1]=l*p+u*h+c*f-o*d,e[t+2]=c*p+u*d+o*h-l*f,e[t+3]=u*p-o*f-l*h-c*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,r){return this._x=e,this._y=t,this._z=n,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!(e&&e.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const n=e._x,r=e._y,i=e._z,s=e._order,o=Math.cos,l=Math.sin,c=o(n/2),u=o(r/2),f=o(i/2),h=l(n/2),d=l(r/2),p=l(i/2);switch(s){case"XYZ":this._x=h*u*f+c*d*p,this._y=c*d*f-h*u*p,this._z=c*u*p+h*d*f,this._w=c*u*f-h*d*p;break;case"YXZ":this._x=h*u*f+c*d*p,this._y=c*d*f-h*u*p,this._z=c*u*p-h*d*f,this._w=c*u*f+h*d*p;break;case"ZXY":this._x=h*u*f-c*d*p,this._y=c*d*f+h*u*p,this._z=c*u*p+h*d*f,this._w=c*u*f-h*d*p;break;case"ZYX":this._x=h*u*f-c*d*p,this._y=c*d*f+h*u*p,this._z=c*u*p-h*d*f,this._w=c*u*f+h*d*p;break;case"YZX":this._x=h*u*f+c*d*p,this._y=c*d*f+h*u*p,this._z=c*u*p-h*d*f,this._w=c*u*f-h*d*p;break;case"XZY":this._x=h*u*f-c*d*p,this._y=c*d*f-h*u*p,this._z=c*u*p+h*d*f,this._w=c*u*f+h*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return t!==!1&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,r=Math.sin(n);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],r=t[4],i=t[8],s=t[1],o=t[5],l=t[9],c=t[2],u=t[6],f=t[10],h=n+o+f;if(h>0){const d=.5/Math.sqrt(h+1);this._w=.25/d,this._x=(u-l)*d,this._y=(i-c)*d,this._z=(s-r)*d}else if(n>o&&n>f){const d=2*Math.sqrt(1+n-o-f);this._w=(u-l)/d,this._x=.25*d,this._y=(r+s)/d,this._z=(i+c)/d}else if(o>f){const d=2*Math.sqrt(1+o-n-f);this._w=(i-c)/d,this._x=(r+s)/d,this._y=.25*d,this._z=(l+u)/d}else{const d=2*Math.sqrt(1+f-n-o);this._w=(s-r)/d,this._x=(i+c)/d,this._y=(l+u)/d,this._z=.25*d}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Er(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(n===0)return this;const r=Math.min(1,t/n);return this.slerp(e,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return e===0?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return t!==void 0?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,r=e._y,i=e._z,s=e._w,o=t._x,l=t._y,c=t._z,u=t._w;return this._x=n*u+s*o+r*c-i*l,this._y=r*u+s*l+i*o-n*c,this._z=i*u+s*c+n*l-r*o,this._w=s*u-n*o-r*l-i*c,this._onChangeCallback(),this}slerp(e,t){if(t===0)return this;if(t===1)return this.copy(e);const n=this._x,r=this._y,i=this._z,s=this._w;let o=s*e._w+n*e._x+r*e._y+i*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=s,this._x=n,this._y=r,this._z=i,this;const l=1-o*o;if(l<=Number.EPSILON){const d=1-t;return this._w=d*s+t*this._w,this._x=d*n+t*this._x,this._y=d*r+t*this._y,this._z=d*i+t*this._z,this.normalize(),this._onChangeCallback(),this}const c=Math.sqrt(l),u=Math.atan2(c,o),f=Math.sin((1-t)*u)/c,h=Math.sin(t*u)/c;return this._w=s*f+this._w*h,this._x=n*f+this._x*h,this._y=r*f+this._y*h,this._z=i*f+this._z*h,this._onChangeCallback(),this}slerpQuaternions(e,t,n){this.copy(e).slerp(t,n)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Xt.prototype.isQuaternion=!0;class b{constructor(e=0,t=0,n=0){this.x=e,this.y=t,this.z=n}set(e,t,n){return n===void 0&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return t!==void 0?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return t!==void 0?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return t!==void 0?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Yd.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Yd.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6]*r,this.y=i[1]*t+i[4]*n+i[7]*r,this.z=i[2]*t+i[5]*n+i[8]*r,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,r=this.z,i=e.elements,s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s,this}applyQuaternion(e){const t=this.x,n=this.y,r=this.z,i=e.x,s=e.y,o=e.z,l=e.w,c=l*t+s*r-o*n,u=l*n+o*t-i*r,f=l*r+i*n-s*t,h=-i*t-s*n-o*r;return this.x=c*l+h*-i+u*-o-f*-s,this.y=u*l+h*-s+f*-i-c*-o,this.z=f*l+h*-o+c*-s-u*-i,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*r,this.y=i[1]*t+i[5]*n+i[9]*r,this.z=i[2]*t+i[6]*n+i[10]*r,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e,t){return t!==void 0?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,r=e.y,i=e.z,s=t.x,o=t.y,l=t.z;return this.x=r*l-i*o,this.y=i*s-n*l,this.z=n*o-r*s,this}projectOnVector(e){const t=e.lengthSq();if(t===0)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return Qc.copy(this).projectOnVector(e),this.sub(Qc)}reflect(e){return this.sub(Qc.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Er(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const r=Math.sin(t)*e;return this.x=r*Math.sin(n),this.y=Math.cos(t)*e,this.z=r*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=r,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,t*4)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,t*3)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,n){return n!==void 0&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}}b.prototype.isVector3=!0;const Qc=new b,Yd=new Xt;class Vt{constructor(e=new b(1/0,1/0,1/0),t=new b(-1/0,-1/0,-1/0)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=1/0,n=1/0,r=1/0,i=-1/0,s=-1/0,o=-1/0;for(let l=0,c=e.length;l<c;l+=3){const u=e[l],f=e[l+1],h=e[l+2];u<t&&(t=u),f<n&&(n=f),h<r&&(r=h),u>i&&(i=u),f>s&&(s=f),h>o&&(o=h)}return this.min.set(t,n,r),this.max.set(i,s,o),this}setFromBufferAttribute(e){let t=1/0,n=1/0,r=1/0,i=-1/0,s=-1/0,o=-1/0;for(let l=0,c=e.count;l<c;l++){const u=e.getX(l),f=e.getY(l),h=e.getZ(l);u<t&&(t=u),f<n&&(n=f),h<r&&(r=h),u>i&&(i=u),f>s&&(s=f),h>o&&(o=h)}return this.min.set(t,n,r),this.max.set(i,s,o),this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=Ms.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;t!==void 0&&(t.boundingBox===null&&t.computeBoundingBox(),eu.copy(t.boundingBox),eu.applyMatrix4(e.matrixWorld),this.union(eu));const n=e.children;for(let r=0,i=n.length;r<i;r++)this.expandByObject(n[r]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,Ms),Ms.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Es),qo.subVectors(this.max,Es),la.subVectors(e.a,Es),ca.subVectors(e.b,Es),ua.subVectors(e.c,Es),jn.subVectors(ca,la),Yn.subVectors(ua,ca),Ni.subVectors(la,ua);let t=[0,-jn.z,jn.y,0,-Yn.z,Yn.y,0,-Ni.z,Ni.y,jn.z,0,-jn.x,Yn.z,0,-Yn.x,Ni.z,0,-Ni.x,-jn.y,jn.x,0,-Yn.y,Yn.x,0,-Ni.y,Ni.x,0];return!tu(t,la,ca,ua,qo)||(t=[1,0,0,0,1,0,0,0,1],!tu(t,la,ca,ua,qo))?!1:($o.crossVectors(jn,Yn),t=[$o.x,$o.y,$o.z],tu(t,la,ca,ua,qo))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return Ms.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return this.getCenter(e.center),e.radius=this.getSize(Ms).length()*.5,e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(An[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),An[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),An[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),An[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),An[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),An[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),An[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),An[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(An),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}Vt.prototype.isBox3=!0;const An=[new b,new b,new b,new b,new b,new b,new b,new b],Ms=new b,eu=new Vt,la=new b,ca=new b,ua=new b,jn=new b,Yn=new b,Ni=new b,Es=new b,qo=new b,$o=new b,Ii=new b;function tu(a,e,t,n,r){for(let i=0,s=a.length-3;i<=s;i+=3){Ii.fromArray(a,i);const o=r.x*Math.abs(Ii.x)+r.y*Math.abs(Ii.y)+r.z*Math.abs(Ii.z),l=e.dot(Ii),c=t.dot(Ii),u=n.dot(Ii);if(Math.max(-Math.max(l,c,u),Math.min(l,c,u))>o)return!1}return!0}const sx=new Vt,qd=new b,ru=new b,nu=new b;class Lr{constructor(e=new b,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;t!==void 0?n.copy(t):sx.setFromPoints(e).getCenter(n);let r=0;for(let i=0,s=e.length;i<s;i++)r=Math.max(r,n.distanceToSquared(e[i]));return this.radius=Math.sqrt(r),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){nu.subVectors(e,this.center);const t=nu.lengthSq();if(t>this.radius*this.radius){const n=Math.sqrt(t),r=(n-this.radius)*.5;this.center.add(nu.multiplyScalar(r/n)),this.radius+=r}return this}union(e){return ru.subVectors(e.center,this.center).normalize().multiplyScalar(e.radius),this.expandByPoint(qd.copy(e.center).add(ru)),this.expandByPoint(qd.copy(e.center).sub(ru)),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}}const Tn=new b,iu=new b,Zo=new b,qn=new b,au=new b,Ko=new b,su=new b;class Ei{constructor(e=new b,t=new b(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.direction).multiplyScalar(e).add(this.origin)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Tn)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(n).add(this.origin)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Tn.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Tn.copy(this.direction).multiplyScalar(t).add(this.origin),Tn.distanceToSquared(e))}distanceSqToSegment(e,t,n,r){iu.copy(e).add(t).multiplyScalar(.5),Zo.copy(t).sub(e).normalize(),qn.copy(this.origin).sub(iu);const i=e.distanceTo(t)*.5,s=-this.direction.dot(Zo),o=qn.dot(this.direction),l=-qn.dot(Zo),c=qn.lengthSq(),u=Math.abs(1-s*s);let f,h,d,p;if(u>0)if(f=s*l-o,h=s*o-l,p=i*u,f>=0)if(h>=-p)if(h<=p){const v=1/u;f*=v,h*=v,d=f*(f+s*h+2*o)+h*(s*f+h+2*l)+c}else h=i,f=Math.max(0,-(s*h+o)),d=-f*f+h*(h+2*l)+c;else h=-i,f=Math.max(0,-(s*h+o)),d=-f*f+h*(h+2*l)+c;else h<=-p?(f=Math.max(0,-(-s*i+o)),h=f>0?-i:Math.min(Math.max(-i,-l),i),d=-f*f+h*(h+2*l)+c):h<=p?(f=0,h=Math.min(Math.max(-i,-l),i),d=h*(h+2*l)+c):(f=Math.max(0,-(s*i+o)),h=f>0?i:Math.min(Math.max(-i,-l),i),d=-f*f+h*(h+2*l)+c);else h=s>0?-i:i,f=Math.max(0,-(s*h+o)),d=-f*f+h*(h+2*l)+c;return n&&n.copy(this.direction).multiplyScalar(f).add(this.origin),r&&r.copy(Zo).multiplyScalar(h).add(iu),d}intersectSphere(e,t){Tn.subVectors(e.center,this.origin);const n=Tn.dot(this.direction),r=Tn.dot(Tn)-n*n,i=e.radius*e.radius;if(r>i)return null;const s=Math.sqrt(i-r),o=n-s,l=n+s;return o<0&&l<0?null:o<0?this.at(l,t):this.at(o,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t===0)return e.distanceToPoint(this.origin)===0?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return n===null?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,r,i,s,o,l;const c=1/this.direction.x,u=1/this.direction.y,f=1/this.direction.z,h=this.origin;return c>=0?(n=(e.min.x-h.x)*c,r=(e.max.x-h.x)*c):(n=(e.max.x-h.x)*c,r=(e.min.x-h.x)*c),u>=0?(i=(e.min.y-h.y)*u,s=(e.max.y-h.y)*u):(i=(e.max.y-h.y)*u,s=(e.min.y-h.y)*u),n>s||i>r||((i>n||n!==n)&&(n=i),(s<r||r!==r)&&(r=s),f>=0?(o=(e.min.z-h.z)*f,l=(e.max.z-h.z)*f):(o=(e.max.z-h.z)*f,l=(e.min.z-h.z)*f),n>l||o>r)||((o>n||n!==n)&&(n=o),(l<r||r!==r)&&(r=l),r<0)?null:this.at(n>=0?n:r,t)}intersectsBox(e){return this.intersectBox(e,Tn)!==null}intersectTriangle(e,t,n,r,i){au.subVectors(t,e),Ko.subVectors(n,e),su.crossVectors(au,Ko);let s=this.direction.dot(su),o;if(s>0){if(r)return null;o=1}else if(s<0)o=-1,s=-s;else return null;qn.subVectors(this.origin,e);const l=o*this.direction.dot(Ko.crossVectors(qn,Ko));if(l<0)return null;const c=o*this.direction.dot(au.cross(qn));if(c<0||l+c>s)return null;const u=-o*qn.dot(su);return u<0?null:this.at(u/s,i)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class Ce{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(e,t,n,r,i,s,o,l,c,u,f,h,d,p,v,_){const m=this.elements;return m[0]=e,m[4]=t,m[8]=n,m[12]=r,m[1]=i,m[5]=s,m[9]=o,m[13]=l,m[2]=c,m[6]=u,m[10]=f,m[14]=h,m[3]=d,m[7]=p,m[11]=v,m[15]=_,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new Ce().fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,r=1/fa.setFromMatrixColumn(e,0).length(),i=1/fa.setFromMatrixColumn(e,1).length(),s=1/fa.setFromMatrixColumn(e,2).length();return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=0,t[4]=n[4]*i,t[5]=n[5]*i,t[6]=n[6]*i,t[7]=0,t[8]=n[8]*s,t[9]=n[9]*s,t[10]=n[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const t=this.elements,n=e.x,r=e.y,i=e.z,s=Math.cos(n),o=Math.sin(n),l=Math.cos(r),c=Math.sin(r),u=Math.cos(i),f=Math.sin(i);if(e.order==="XYZ"){const h=s*u,d=s*f,p=o*u,v=o*f;t[0]=l*u,t[4]=-l*f,t[8]=c,t[1]=d+p*c,t[5]=h-v*c,t[9]=-o*l,t[2]=v-h*c,t[6]=p+d*c,t[10]=s*l}else if(e.order==="YXZ"){const h=l*u,d=l*f,p=c*u,v=c*f;t[0]=h+v*o,t[4]=p*o-d,t[8]=s*c,t[1]=s*f,t[5]=s*u,t[9]=-o,t[2]=d*o-p,t[6]=v+h*o,t[10]=s*l}else if(e.order==="ZXY"){const h=l*u,d=l*f,p=c*u,v=c*f;t[0]=h-v*o,t[4]=-s*f,t[8]=p+d*o,t[1]=d+p*o,t[5]=s*u,t[9]=v-h*o,t[2]=-s*c,t[6]=o,t[10]=s*l}else if(e.order==="ZYX"){const h=s*u,d=s*f,p=o*u,v=o*f;t[0]=l*u,t[4]=p*c-d,t[8]=h*c+v,t[1]=l*f,t[5]=v*c+h,t[9]=d*c-p,t[2]=-c,t[6]=o*l,t[10]=s*l}else if(e.order==="YZX"){const h=s*l,d=s*c,p=o*l,v=o*c;t[0]=l*u,t[4]=v-h*f,t[8]=p*f+d,t[1]=f,t[5]=s*u,t[9]=-o*u,t[2]=-c*u,t[6]=d*f+p,t[10]=h-v*f}else if(e.order==="XZY"){const h=s*l,d=s*c,p=o*l,v=o*c;t[0]=l*u,t[4]=-f,t[8]=c*u,t[1]=h*f+v,t[5]=s*u,t[9]=d*f-p,t[2]=p*f-d,t[6]=o*u,t[10]=v*f+h}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(ox,e,lx)}lookAt(e,t,n){const r=this.elements;return Ir.subVectors(e,t),Ir.lengthSq()===0&&(Ir.z=1),Ir.normalize(),$n.crossVectors(n,Ir),$n.lengthSq()===0&&(Math.abs(n.z)===1?Ir.x+=1e-4:Ir.z+=1e-4,Ir.normalize(),$n.crossVectors(n,Ir)),$n.normalize(),Jo.crossVectors(Ir,$n),r[0]=$n.x,r[4]=Jo.x,r[8]=Ir.x,r[1]=$n.y,r[5]=Jo.y,r[9]=Ir.y,r[2]=$n.z,r[6]=Jo.z,r[10]=Ir.z,this}multiply(e,t){return t!==void 0?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,r=t.elements,i=this.elements,s=n[0],o=n[4],l=n[8],c=n[12],u=n[1],f=n[5],h=n[9],d=n[13],p=n[2],v=n[6],_=n[10],m=n[14],g=n[3],y=n[7],x=n[11],S=n[15],M=r[0],E=r[4],N=r[8],B=r[12],V=r[1],O=r[5],W=r[9],z=r[13],C=r[2],T=r[6],A=r[10],F=r[14],X=r[3],Y=r[7],ne=r[11],ae=r[15];return i[0]=s*M+o*V+l*C+c*X,i[4]=s*E+o*O+l*T+c*Y,i[8]=s*N+o*W+l*A+c*ne,i[12]=s*B+o*z+l*F+c*ae,i[1]=u*M+f*V+h*C+d*X,i[5]=u*E+f*O+h*T+d*Y,i[9]=u*N+f*W+h*A+d*ne,i[13]=u*B+f*z+h*F+d*ae,i[2]=p*M+v*V+_*C+m*X,i[6]=p*E+v*O+_*T+m*Y,i[10]=p*N+v*W+_*A+m*ne,i[14]=p*B+v*z+_*F+m*ae,i[3]=g*M+y*V+x*C+S*X,i[7]=g*E+y*O+x*T+S*Y,i[11]=g*N+y*W+x*A+S*ne,i[15]=g*B+y*z+x*F+S*ae,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],r=e[8],i=e[12],s=e[1],o=e[5],l=e[9],c=e[13],u=e[2],f=e[6],h=e[10],d=e[14],p=e[3],v=e[7],_=e[11],m=e[15];return p*(+i*l*f-r*c*f-i*o*h+n*c*h+r*o*d-n*l*d)+v*(+t*l*d-t*c*h+i*s*h-r*s*d+r*c*u-i*l*u)+_*(+t*c*f-t*o*d-i*s*f+n*s*d+i*o*u-n*c*u)+m*(-r*o*u-t*l*f+t*o*h+r*s*f-n*s*h+n*l*u)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=t,r[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],l=e[6],c=e[7],u=e[8],f=e[9],h=e[10],d=e[11],p=e[12],v=e[13],_=e[14],m=e[15],g=f*_*c-v*h*c+v*l*d-o*_*d-f*l*m+o*h*m,y=p*h*c-u*_*c-p*l*d+s*_*d+u*l*m-s*h*m,x=u*v*c-p*f*c+p*o*d-s*v*d-u*o*m+s*f*m,S=p*f*l-u*v*l-p*o*h+s*v*h+u*o*_-s*f*_,M=t*g+n*y+r*x+i*S;if(M===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const E=1/M;return e[0]=g*E,e[1]=(v*h*i-f*_*i-v*r*d+n*_*d+f*r*m-n*h*m)*E,e[2]=(o*_*i-v*l*i+v*r*c-n*_*c-o*r*m+n*l*m)*E,e[3]=(f*l*i-o*h*i-f*r*c+n*h*c+o*r*d-n*l*d)*E,e[4]=y*E,e[5]=(u*_*i-p*h*i+p*r*d-t*_*d-u*r*m+t*h*m)*E,e[6]=(p*l*i-s*_*i-p*r*c+t*_*c+s*r*m-t*l*m)*E,e[7]=(s*h*i-u*l*i+u*r*c-t*h*c-s*r*d+t*l*d)*E,e[8]=x*E,e[9]=(p*f*i-u*v*i-p*n*d+t*v*d+u*n*m-t*f*m)*E,e[10]=(s*v*i-p*o*i+p*n*c-t*v*c-s*n*m+t*o*m)*E,e[11]=(u*o*i-s*f*i-u*n*c+t*f*c+s*n*d-t*o*d)*E,e[12]=S*E,e[13]=(u*v*r-p*f*r+p*n*h-t*v*h-u*n*_+t*f*_)*E,e[14]=(p*o*r-s*v*r-p*n*l+t*v*l+s*n*_-t*o*_)*E,e[15]=(s*f*r-u*o*r+u*n*l-t*f*l-s*n*h+t*o*h)*E,this}scale(e){const t=this.elements,n=e.x,r=e.y,i=e.z;return t[0]*=n,t[4]*=r,t[8]*=i,t[1]*=n,t[5]*=r,t[9]*=i,t[2]*=n,t[6]*=r,t[10]*=i,t[3]*=n,t[7]*=r,t[11]*=i,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,r))}makeTranslation(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),r=Math.sin(t),i=1-n,s=e.x,o=e.y,l=e.z,c=i*s,u=i*o;return this.set(c*s+n,c*o-r*l,c*l+r*o,0,c*o+r*l,u*o+n,u*l-r*s,0,c*l-r*o,u*l+r*s,i*l*l+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,r,i,s){return this.set(1,n,i,0,e,1,s,0,t,r,1,0,0,0,0,1),this}compose(e,t,n){const r=this.elements,i=t._x,s=t._y,o=t._z,l=t._w,c=i+i,u=s+s,f=o+o,h=i*c,d=i*u,p=i*f,v=s*u,_=s*f,m=o*f,g=l*c,y=l*u,x=l*f,S=n.x,M=n.y,E=n.z;return r[0]=(1-(v+m))*S,r[1]=(d+x)*S,r[2]=(p-y)*S,r[3]=0,r[4]=(d-x)*M,r[5]=(1-(h+m))*M,r[6]=(_+g)*M,r[7]=0,r[8]=(p+y)*E,r[9]=(_-g)*E,r[10]=(1-(h+v))*E,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}decompose(e,t,n){const r=this.elements;let i=fa.set(r[0],r[1],r[2]).length();const s=fa.set(r[4],r[5],r[6]).length(),o=fa.set(r[8],r[9],r[10]).length();this.determinant()<0&&(i=-i),e.x=r[12],e.y=r[13],e.z=r[14],Qr.copy(this);const c=1/i,u=1/s,f=1/o;return Qr.elements[0]*=c,Qr.elements[1]*=c,Qr.elements[2]*=c,Qr.elements[4]*=u,Qr.elements[5]*=u,Qr.elements[6]*=u,Qr.elements[8]*=f,Qr.elements[9]*=f,Qr.elements[10]*=f,t.setFromRotationMatrix(Qr),n.x=i,n.y=s,n.z=o,this}makePerspective(e,t,n,r,i,s){s===void 0&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,l=2*i/(t-e),c=2*i/(n-r),u=(t+e)/(t-e),f=(n+r)/(n-r),h=-(s+i)/(s-i),d=-2*s*i/(s-i);return o[0]=l,o[4]=0,o[8]=u,o[12]=0,o[1]=0,o[5]=c,o[9]=f,o[13]=0,o[2]=0,o[6]=0,o[10]=h,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,r,i,s){const o=this.elements,l=1/(t-e),c=1/(n-r),u=1/(s-i),f=(t+e)*l,h=(n+r)*c,d=(s+i)*u;return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-f,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-h,o[2]=0,o[6]=0,o[10]=-2*u,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let r=0;r<16;r++)if(t[r]!==n[r])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}Ce.prototype.isMatrix4=!0;const fa=new b,Qr=new Ce,ox=new b(0,0,0),lx=new b(1,1,1),$n=new b,Jo=new b,Ir=new b,$d=new Ce,Zd=new Xt;class Un{constructor(e=0,t=0,n=0,r=Un.DefaultOrder){this._x=e,this._y=t,this._z=n,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,r=this._order){return this._x=e,this._y=t,this._z=n,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const r=e.elements,i=r[0],s=r[4],o=r[8],l=r[1],c=r[5],u=r[9],f=r[2],h=r[6],d=r[10];switch(t){case"XYZ":this._y=Math.asin(Er(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-u,d),this._z=Math.atan2(-s,i)):(this._x=Math.atan2(h,c),this._z=0);break;case"YXZ":this._x=Math.asin(-Er(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-f,i),this._z=0);break;case"ZXY":this._x=Math.asin(Er(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-f,d),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(l,i));break;case"ZYX":this._y=Math.asin(-Er(f,-1,1)),Math.abs(f)<.9999999?(this._x=Math.atan2(h,d),this._z=Math.atan2(l,i)):(this._x=0,this._z=Math.atan2(-s,c));break;case"YZX":this._z=Math.asin(Er(l,-1,1)),Math.abs(l)<.9999999?(this._x=Math.atan2(-u,c),this._y=Math.atan2(-f,i)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-Er(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(h,c),this._y=Math.atan2(o,i)):(this._x=Math.atan2(-u,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,n===!0&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return $d.makeRotationFromQuaternion(e),this.setFromRotationMatrix($d,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Zd.setFromEuler(this),this.setFromQuaternion(Zd,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==void 0&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}toVector3(e){return e?e.set(this._x,this._y,this._z):new b(this._x,this._y,this._z)}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Un.prototype.isEuler=!0;Un.DefaultOrder="XYZ";Un.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class ah{constructor(){this.mask=1}set(e){this.mask=1<<e|0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!==0}}let cx=0;const Kd=new b,ha=new Xt,Rn=new Ce,Qo=new b,Cs=new b,ux=new b,fx=new Xt,Jd=new b(1,0,0),Qd=new b(0,1,0),ep=new b(0,0,1),hx={type:"added"},tp={type:"removed"};class lt extends Ji{constructor(){super(),Object.defineProperty(this,"id",{value:cx++}),this.uuid=on(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=lt.DefaultUp.clone();const e=new b,t=new Un,n=new Xt,r=new b(1,1,1);function i(){n.setFromEuler(t,!1)}function s(){t.setFromQuaternion(n,void 0,!1)}t._onChange(i),n._onChange(s),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new Ce},normalMatrix:{value:new zt}}),this.matrix=new Ce,this.matrixWorld=new Ce,this.matrixAutoUpdate=lt.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new ah,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return ha.setFromAxisAngle(e,t),this.quaternion.multiply(ha),this}rotateOnWorldAxis(e,t){return ha.setFromAxisAngle(e,t),this.quaternion.premultiply(ha),this}rotateX(e){return this.rotateOnAxis(Jd,e)}rotateY(e){return this.rotateOnAxis(Qd,e)}rotateZ(e){return this.rotateOnAxis(ep,e)}translateOnAxis(e,t){return Kd.copy(e).applyQuaternion(this.quaternion),this.position.add(Kd.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Jd,e)}translateY(e){return this.translateOnAxis(Qd,e)}translateZ(e){return this.translateOnAxis(ep,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(Rn.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?Qo.copy(e):Qo.set(e,t,n);const r=this.parent;this.updateWorldMatrix(!0,!1),Cs.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Rn.lookAt(Cs,Qo,this.up):Rn.lookAt(Qo,Cs,this.up),this.quaternion.setFromRotationMatrix(Rn),r&&(Rn.extractRotation(r.matrixWorld),ha.setFromRotationMatrix(Rn),this.quaternion.premultiply(ha.invert()))}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(hx)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let n=0;n<arguments.length;n++)this.remove(arguments[n]);return this}const t=this.children.indexOf(e);return t!==-1&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(tp)),this}removeFromParent(){const e=this.parent;return e!==null&&e.remove(this),this}clear(){for(let e=0;e<this.children.length;e++){const t=this.children[e];t.parent=null,t.dispatchEvent(tp)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),Rn.copy(this.matrixWorld).invert(),e.parent!==null&&(e.parent.updateWorldMatrix(!0,!1),Rn.multiply(e.parent.matrixWorld)),e.applyMatrix4(Rn),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,r=this.children.length;n<r;n++){const s=this.children[n].getObjectByProperty(e,t);if(s!==void 0)return s}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Cs,e,ux),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Cs,fx,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,r=t.length;n<r;n++)t[n].traverse(e)}traverseVisible(e){if(this.visible===!1)return;e(this);const t=this.children;for(let n=0,r=t.length;n<r;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;t!==null&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,r=t.length;n<r;n++)t[n].updateMatrixWorld(e)}updateWorldMatrix(e,t){const n=this.parent;if(e===!0&&n!==null&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),t===!0){const r=this.children;for(let i=0,s=r.length;i<s;i++)r[i].updateWorldMatrix(!1,!0)}}toJSON(e){const t=e===void 0||typeof e=="string",n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},n.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const r={};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.castShadow===!0&&(r.castShadow=!0),this.receiveShadow===!0&&(r.receiveShadow=!0),this.visible===!1&&(r.visible=!1),this.frustumCulled===!1&&(r.frustumCulled=!1),this.renderOrder!==0&&(r.renderOrder=this.renderOrder),JSON.stringify(this.userData)!=="{}"&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),this.matrixAutoUpdate===!1&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(r.instanceColor=this.instanceColor.toJSON()));function i(o,l){return o[l.uuid]===void 0&&(o[l.uuid]=l.toJSON(e)),l.uuid}if(this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&(r.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=i(e.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const l=o.shapes;if(Array.isArray(l))for(let c=0,u=l.length;c<u;c++){const f=l[c];i(e.shapes,f)}else i(e.shapes,l)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(i(e.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let l=0,c=this.material.length;l<c;l++)o.push(i(e.materials,this.material[l]));r.material=o}else r.material=i(e.materials,this.material);if(this.children.length>0){r.children=[];for(let o=0;o<this.children.length;o++)r.children.push(this.children[o].toJSON(e).object)}if(this.animations.length>0){r.animations=[];for(let o=0;o<this.animations.length;o++){const l=this.animations[o];r.animations.push(i(e.animations,l))}}if(t){const o=s(e.geometries),l=s(e.materials),c=s(e.textures),u=s(e.images),f=s(e.shapes),h=s(e.skeletons),d=s(e.animations);o.length>0&&(n.geometries=o),l.length>0&&(n.materials=l),c.length>0&&(n.textures=c),u.length>0&&(n.images=u),f.length>0&&(n.shapes=f),h.length>0&&(n.skeletons=h),d.length>0&&(n.animations=d)}return n.object=r,n;function s(o){const l=[];for(const c in o){const u=o[c];delete u.metadata,l.push(u)}return l}}clone(e){return new this.constructor().copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(let n=0;n<e.children.length;n++){const r=e.children[n];this.add(r.clone())}return this}}lt.DefaultUp=new b(0,1,0);lt.DefaultMatrixAutoUpdate=!0;lt.prototype.isObject3D=!0;const en=new b,Ln=new b,ou=new b,Pn=new b,da=new b,pa=new b,rp=new b,lu=new b,cu=new b,uu=new b;let Br=class Ua{constructor(e=new b,t=new b,n=new b){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,r){r.subVectors(n,t),en.subVectors(e,t),r.cross(en);const i=r.lengthSq();return i>0?r.multiplyScalar(1/Math.sqrt(i)):r.set(0,0,0)}static getBarycoord(e,t,n,r,i){en.subVectors(r,t),Ln.subVectors(n,t),ou.subVectors(e,t);const s=en.dot(en),o=en.dot(Ln),l=en.dot(ou),c=Ln.dot(Ln),u=Ln.dot(ou),f=s*c-o*o;if(f===0)return i.set(-2,-1,-1);const h=1/f,d=(c*l-o*u)*h,p=(s*u-o*l)*h;return i.set(1-d-p,p,d)}static containsPoint(e,t,n,r){return this.getBarycoord(e,t,n,r,Pn),Pn.x>=0&&Pn.y>=0&&Pn.x+Pn.y<=1}static getUV(e,t,n,r,i,s,o,l){return this.getBarycoord(e,t,n,r,Pn),l.set(0,0),l.addScaledVector(i,Pn.x),l.addScaledVector(s,Pn.y),l.addScaledVector(o,Pn.z),l}static isFrontFacing(e,t,n,r){return en.subVectors(n,t),Ln.subVectors(e,t),en.cross(Ln).dot(r)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,r){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[r]),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return en.subVectors(this.c,this.b),Ln.subVectors(this.a,this.b),en.cross(Ln).length()*.5}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Ua.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Ua.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,n,r,i){return Ua.getUV(e,this.a,this.b,this.c,t,n,r,i)}containsPoint(e){return Ua.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Ua.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,r=this.b,i=this.c;let s,o;da.subVectors(r,n),pa.subVectors(i,n),lu.subVectors(e,n);const l=da.dot(lu),c=pa.dot(lu);if(l<=0&&c<=0)return t.copy(n);cu.subVectors(e,r);const u=da.dot(cu),f=pa.dot(cu);if(u>=0&&f<=u)return t.copy(r);const h=l*f-u*c;if(h<=0&&l>=0&&u<=0)return s=l/(l-u),t.copy(n).addScaledVector(da,s);uu.subVectors(e,i);const d=da.dot(uu),p=pa.dot(uu);if(p>=0&&d<=p)return t.copy(i);const v=d*c-l*p;if(v<=0&&c>=0&&p<=0)return o=c/(c-p),t.copy(n).addScaledVector(pa,o);const _=u*p-d*f;if(_<=0&&f-u>=0&&d-p>=0)return rp.subVectors(i,r),o=(f-u)/(f-u+(d-p)),t.copy(r).addScaledVector(rp,o);const m=1/(_+v+h);return s=v*m,o=h*m,t.copy(n).addScaledVector(da,s).addScaledVector(pa,o)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}},dx=0;class er extends Ji{constructor(){super(),Object.defineProperty(this,"id",{value:dx++}),this.uuid=on(),this.name="",this.type="Material",this.fog=!0,this.blending=$s,this.side=ji,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=zv,this.blendDst=Vv,this.blendEquation=Va,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=nc,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=H1,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Kc,this.stencilZFail=Kc,this.stencilZPass=Kc,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}onBuild(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(e!==void 0)for(const t in e){const n=e[t];if(n===void 0){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if(t==="shading"){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=n===Bv;continue}const r=this[t];if(r===void 0){console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.");continue}r&&r.isColor?r.set(n):r&&r.isVector3&&n&&n.isVector3?r.copy(n):this[t]=n}}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{}});const n={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};n.uuid=this.uuid,n.type=this.type,this.name!==""&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),this.roughness!==void 0&&(n.roughness=this.roughness),this.metalness!==void 0&&(n.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(n.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(n.specularIntensity=this.specularIntensity),this.specularTint&&this.specularTint.isColor&&(n.specularTint=this.specularTint.getHex()),this.shininess!==void 0&&(n.shininess=this.shininess),this.clearcoat!==void 0&&(n.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularTintMap&&this.specularTintMap.isTexture&&(n.specularTintMap=this.specularTintMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,this.combine!==void 0&&(n.combine=this.combine)),this.envMapIntensity!==void 0&&(n.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(n.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),this.transmission!==void 0&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),this.thickness!==void 0&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),this.attenuationDistance!==void 0&&(n.attenuationDistance=this.attenuationDistance),this.attenuationTint!==void 0&&(n.attenuationTint=this.attenuationTint.getHex()),this.size!==void 0&&(n.size=this.size),this.shadowSide!==null&&(n.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(n.sizeAttenuation=this.sizeAttenuation),this.blending!==$s&&(n.blending=this.blending),this.side!==ji&&(n.side=this.side),this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),this.transparent===!0&&(n.transparent=this.transparent),n.depthFunc=this.depthFunc,n.depthTest=this.depthTest,n.depthWrite=this.depthWrite,n.colorWrite=this.colorWrite,n.stencilWrite=this.stencilWrite,n.stencilWriteMask=this.stencilWriteMask,n.stencilFunc=this.stencilFunc,n.stencilRef=this.stencilRef,n.stencilFuncMask=this.stencilFuncMask,n.stencilFail=this.stencilFail,n.stencilZFail=this.stencilZFail,n.stencilZPass=this.stencilZPass,this.rotation&&this.rotation!==0&&(n.rotation=this.rotation),this.polygonOffset===!0&&(n.polygonOffset=!0),this.polygonOffsetFactor!==0&&(n.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(n.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&this.linewidth!==1&&(n.linewidth=this.linewidth),this.dashSize!==void 0&&(n.dashSize=this.dashSize),this.gapSize!==void 0&&(n.gapSize=this.gapSize),this.scale!==void 0&&(n.scale=this.scale),this.dithering===!0&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),this.alphaToCoverage===!0&&(n.alphaToCoverage=this.alphaToCoverage),this.premultipliedAlpha===!0&&(n.premultipliedAlpha=this.premultipliedAlpha),this.wireframe===!0&&(n.wireframe=this.wireframe),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(n.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(n.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(n.flatShading=this.flatShading),this.visible===!1&&(n.visible=!1),this.toneMapped===!1&&(n.toneMapped=!1),JSON.stringify(this.userData)!=="{}"&&(n.userData=this.userData);function r(i){const s=[];for(const o in i){const l=i[o];delete l.metadata,s.push(l)}return s}if(t){const i=r(e.textures),s=r(e.images);i.length>0&&(n.textures=i),s.length>0&&(n.images=s)}return n}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(t!==null){const r=t.length;n=new Array(r);for(let i=0;i!==r;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}}er.prototype.isMaterial=!0;const qv={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},tn={h:0,s:0,l:0},el={h:0,s:0,l:0};function fu(a,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?a+(e-a)*6*t:t<1/2?e:t<2/3?a+(e-a)*6*(2/3-t):a}function hu(a){return a<.04045?a*.0773993808:Math.pow(a*.9478672986+.0521327014,2.4)}function du(a){return a<.0031308?a*12.92:1.055*Math.pow(a,.41666)-.055}class ze{constructor(e,t,n){return t===void 0&&n===void 0?this.set(e):this.setRGB(e,t,n)}set(e){return e&&e.isColor?this.copy(e):typeof e=="number"?this.setHex(e):typeof e=="string"&&this.setStyle(e),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this}setRGB(e,t,n){return this.r=e,this.g=t,this.b=n,this}setHSL(e,t,n){if(e=ih(e,1),t=Er(t,0,1),n=Er(n,0,1),t===0)this.r=this.g=this.b=n;else{const r=n<=.5?n*(1+t):n+t-n*t,i=2*n-r;this.r=fu(i,r,e+1/3),this.g=fu(i,r,e),this.b=fu(i,r,e-1/3)}return this}setStyle(e){function t(r){r!==void 0&&parseFloat(r)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let n;if(n=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let r;const i=n[1],s=n[2];switch(i){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,t(r[4]),this;if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,t(r[4]),this;break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s)){const o=parseFloat(r[1])/360,l=parseInt(r[2],10)/100,c=parseInt(r[3],10)/100;return t(r[4]),this.setHSL(o,l,c)}break}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(e)){const r=n[1],i=r.length;if(i===3)return this.r=parseInt(r.charAt(0)+r.charAt(0),16)/255,this.g=parseInt(r.charAt(1)+r.charAt(1),16)/255,this.b=parseInt(r.charAt(2)+r.charAt(2),16)/255,this;if(i===6)return this.r=parseInt(r.charAt(0)+r.charAt(1),16)/255,this.g=parseInt(r.charAt(2)+r.charAt(3),16)/255,this.b=parseInt(r.charAt(4)+r.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this}setColorName(e){const t=qv[e.toLowerCase()];return t!==void 0?this.setHex(t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyGammaToLinear(e,t=2){return this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this}copyLinearToGamma(e,t=2){const n=t>0?1/t:1;return this.r=Math.pow(e.r,n),this.g=Math.pow(e.g,n),this.b=Math.pow(e.b,n),this}convertGammaToLinear(e){return this.copyGammaToLinear(this,e),this}convertLinearToGamma(e){return this.copyLinearToGamma(this,e),this}copySRGBToLinear(e){return this.r=hu(e.r),this.g=hu(e.g),this.b=hu(e.b),this}copyLinearToSRGB(e){return this.r=du(e.r),this.g=du(e.g),this.b=du(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return this.r*255<<16^this.g*255<<8^this.b*255<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(e){const t=this.r,n=this.g,r=this.b,i=Math.max(t,n,r),s=Math.min(t,n,r);let o,l;const c=(s+i)/2;if(s===i)o=0,l=0;else{const u=i-s;switch(l=c<=.5?u/(i+s):u/(2-i-s),i){case t:o=(n-r)/u+(n<r?6:0);break;case n:o=(r-t)/u+2;break;case r:o=(t-n)/u+4;break}o/=6}return e.h=o,e.s=l,e.l=c,e}getStyle(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}offsetHSL(e,t,n){return this.getHSL(tn),tn.h+=e,tn.s+=t,tn.l+=n,this.setHSL(tn.h,tn.s,tn.l),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(tn),e.getHSL(el);const n=Ks(tn.h,el.h,t),r=Ks(tn.s,el.s,t),i=Ks(tn.l,el.l,t);return this.setHSL(n,r,i),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),e.normalized===!0&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}ze.NAMES=qv;ze.prototype.isColor=!0;ze.prototype.r=1;ze.prototype.g=1;ze.prototype.b=1;class Ec extends er{constructor(e){super(),this.type="MeshBasicMaterial",this.color=new ze(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}Ec.prototype.isMeshBasicMaterial=!0;const St=new b,tl=new ve;class Ze{constructor(e,t,n){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=e!==void 0?e.length/t:0,this.normalized=n===!0,this.usage=so,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let r=0,i=this.itemSize;r<i;r++)this.array[e+r]=t.array[n+r];return this}copyArray(e){return this.array.set(e),this}copyColorsArray(e){const t=this.array;let n=0;for(let r=0,i=e.length;r<i;r++){let s=e[r];s===void 0&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",r),s=new ze),t[n++]=s.r,t[n++]=s.g,t[n++]=s.b}return this}copyVector2sArray(e){const t=this.array;let n=0;for(let r=0,i=e.length;r<i;r++){let s=e[r];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),s=new ve),t[n++]=s.x,t[n++]=s.y}return this}copyVector3sArray(e){const t=this.array;let n=0;for(let r=0,i=e.length;r<i;r++){let s=e[r];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",r),s=new b),t[n++]=s.x,t[n++]=s.y,t[n++]=s.z}return this}copyVector4sArray(e){const t=this.array;let n=0;for(let r=0,i=e.length;r<i;r++){let s=e[r];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",r),s=new ht),t[n++]=s.x,t[n++]=s.y,t[n++]=s.z,t[n++]=s.w}return this}applyMatrix3(e){if(this.itemSize===2)for(let t=0,n=this.count;t<n;t++)tl.fromBufferAttribute(this,t),tl.applyMatrix3(e),this.setXY(t,tl.x,tl.y);else if(this.itemSize===3)for(let t=0,n=this.count;t<n;t++)St.fromBufferAttribute(this,t),St.applyMatrix3(e),this.setXYZ(t,St.x,St.y,St.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)St.x=this.getX(t),St.y=this.getY(t),St.z=this.getZ(t),St.applyMatrix4(e),this.setXYZ(t,St.x,St.y,St.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)St.x=this.getX(t),St.y=this.getY(t),St.z=this.getZ(t),St.applyNormalMatrix(e),this.setXYZ(t,St.x,St.y,St.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)St.x=this.getX(t),St.y=this.getY(t),St.z=this.getZ(t),St.transformDirection(e),this.setXYZ(t,St.x,St.y,St.z);return this}set(e,t=0){return this.array.set(e,t),this}getX(e){return this.array[e*this.itemSize]}setX(e,t){return this.array[e*this.itemSize]=t,this}getY(e){return this.array[e*this.itemSize+1]}setY(e,t){return this.array[e*this.itemSize+1]=t,this}getZ(e){return this.array[e*this.itemSize+2]}setZ(e,t){return this.array[e*this.itemSize+2]=t,this}getW(e){return this.array[e*this.itemSize+3]}setW(e,t){return this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=r,this}setXYZW(e,t,n,r,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=r,this.array[e+3]=i,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return this.name!==""&&(e.name=this.name),this.usage!==so&&(e.usage=this.usage),(this.updateRange.offset!==0||this.updateRange.count!==-1)&&(e.updateRange=this.updateRange),e}}Ze.prototype.isBufferAttribute=!0;class sh extends Ze{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class $v extends Ze{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class px extends Ze{constructor(e,t,n){super(new Uint16Array(e),t,n)}}px.prototype.isFloat16BufferAttribute=!0;class wt extends Ze{constructor(e,t,n){super(new Float32Array(e),t,n)}}function Zv(a){if(a.length===0)return-1/0;let e=a[0];for(let t=1,n=a.length;t<n;++t)a[t]>e&&(e=a[t]);return e}let mx=0;const Xr=new Ce,pu=new lt,ma=new b,kr=new Vt,As=new Vt,jt=new b;class at extends Ji{constructor(){super(),Object.defineProperty(this,"id",{value:mx++}),this.uuid=on(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Zv(e)>65535?$v:sh)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return this.attributes[e]!==void 0}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;t!==void 0&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(n!==void 0){const i=new zt().getNormalMatrix(e);n.applyNormalMatrix(i),n.needsUpdate=!0}const r=this.attributes.tangent;return r!==void 0&&(r.transformDirection(e),r.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(e){return Xr.makeRotationFromQuaternion(e),this.applyMatrix4(Xr),this}rotateX(e){return Xr.makeRotationX(e),this.applyMatrix4(Xr),this}rotateY(e){return Xr.makeRotationY(e),this.applyMatrix4(Xr),this}rotateZ(e){return Xr.makeRotationZ(e),this.applyMatrix4(Xr),this}translate(e,t,n){return Xr.makeTranslation(e,t,n),this.applyMatrix4(Xr),this}scale(e,t,n){return Xr.makeScale(e,t,n),this.applyMatrix4(Xr),this}lookAt(e){return pu.lookAt(e),pu.updateMatrix(),this.applyMatrix4(pu.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(ma).negate(),this.translate(ma.x,ma.y,ma.z),this}setFromPoints(e){const t=[];for(let n=0,r=e.length;n<r;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}return this.setAttribute("position",new wt(t,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Vt);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingBox.set(new b(-1/0,-1/0,-1/0),new b(1/0,1/0,1/0));return}if(e!==void 0){if(this.boundingBox.setFromBufferAttribute(e),t)for(let n=0,r=t.length;n<r;n++){const i=t[n];kr.setFromBufferAttribute(i),this.morphTargetsRelative?(jt.addVectors(this.boundingBox.min,kr.min),this.boundingBox.expandByPoint(jt),jt.addVectors(this.boundingBox.max,kr.max),this.boundingBox.expandByPoint(jt)):(this.boundingBox.expandByPoint(kr.min),this.boundingBox.expandByPoint(kr.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Lr);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingSphere.set(new b,1/0);return}if(e){const n=this.boundingSphere.center;if(kr.setFromBufferAttribute(e),t)for(let i=0,s=t.length;i<s;i++){const o=t[i];As.setFromBufferAttribute(o),this.morphTargetsRelative?(jt.addVectors(kr.min,As.min),kr.expandByPoint(jt),jt.addVectors(kr.max,As.max),kr.expandByPoint(jt)):(kr.expandByPoint(As.min),kr.expandByPoint(As.max))}kr.getCenter(n);let r=0;for(let i=0,s=e.count;i<s;i++)jt.fromBufferAttribute(e,i),r=Math.max(r,n.distanceToSquared(jt));if(t)for(let i=0,s=t.length;i<s;i++){const o=t[i],l=this.morphTargetsRelative;for(let c=0,u=o.count;c<u;c++)jt.fromBufferAttribute(o,c),l&&(ma.fromBufferAttribute(e,c),jt.add(ma)),r=Math.max(r,n.distanceToSquared(jt))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeFaceNormals(){}computeTangents(){const e=this.index,t=this.attributes;if(e===null||t.position===void 0||t.normal===void 0||t.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const n=e.array,r=t.position.array,i=t.normal.array,s=t.uv.array,o=r.length/3;t.tangent===void 0&&this.setAttribute("tangent",new Ze(new Float32Array(4*o),4));const l=t.tangent.array,c=[],u=[];for(let V=0;V<o;V++)c[V]=new b,u[V]=new b;const f=new b,h=new b,d=new b,p=new ve,v=new ve,_=new ve,m=new b,g=new b;function y(V,O,W){f.fromArray(r,V*3),h.fromArray(r,O*3),d.fromArray(r,W*3),p.fromArray(s,V*2),v.fromArray(s,O*2),_.fromArray(s,W*2),h.sub(f),d.sub(f),v.sub(p),_.sub(p);const z=1/(v.x*_.y-_.x*v.y);isFinite(z)&&(m.copy(h).multiplyScalar(_.y).addScaledVector(d,-v.y).multiplyScalar(z),g.copy(d).multiplyScalar(v.x).addScaledVector(h,-_.x).multiplyScalar(z),c[V].add(m),c[O].add(m),c[W].add(m),u[V].add(g),u[O].add(g),u[W].add(g))}let x=this.groups;x.length===0&&(x=[{start:0,count:n.length}]);for(let V=0,O=x.length;V<O;++V){const W=x[V],z=W.start,C=W.count;for(let T=z,A=z+C;T<A;T+=3)y(n[T+0],n[T+1],n[T+2])}const S=new b,M=new b,E=new b,N=new b;function B(V){E.fromArray(i,V*3),N.copy(E);const O=c[V];S.copy(O),S.sub(E.multiplyScalar(E.dot(O))).normalize(),M.crossVectors(N,O);const z=M.dot(u[V])<0?-1:1;l[V*4]=S.x,l[V*4+1]=S.y,l[V*4+2]=S.z,l[V*4+3]=z}for(let V=0,O=x.length;V<O;++V){const W=x[V],z=W.start,C=W.count;for(let T=z,A=z+C;T<A;T+=3)B(n[T+0]),B(n[T+1]),B(n[T+2])}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(t!==void 0){let n=this.getAttribute("normal");if(n===void 0)n=new Ze(new Float32Array(t.count*3),3),this.setAttribute("normal",n);else for(let h=0,d=n.count;h<d;h++)n.setXYZ(h,0,0,0);const r=new b,i=new b,s=new b,o=new b,l=new b,c=new b,u=new b,f=new b;if(e)for(let h=0,d=e.count;h<d;h+=3){const p=e.getX(h+0),v=e.getX(h+1),_=e.getX(h+2);r.fromBufferAttribute(t,p),i.fromBufferAttribute(t,v),s.fromBufferAttribute(t,_),u.subVectors(s,i),f.subVectors(r,i),u.cross(f),o.fromBufferAttribute(n,p),l.fromBufferAttribute(n,v),c.fromBufferAttribute(n,_),o.add(u),l.add(u),c.add(u),n.setXYZ(p,o.x,o.y,o.z),n.setXYZ(v,l.x,l.y,l.z),n.setXYZ(_,c.x,c.y,c.z)}else for(let h=0,d=t.count;h<d;h+=3)r.fromBufferAttribute(t,h+0),i.fromBufferAttribute(t,h+1),s.fromBufferAttribute(t,h+2),u.subVectors(s,i),f.subVectors(r,i),u.cross(f),n.setXYZ(h+0,u.x,u.y,u.z),n.setXYZ(h+1,u.x,u.y,u.z),n.setXYZ(h+2,u.x,u.y,u.z);this.normalizeNormals(),n.needsUpdate=!0}}merge(e,t){if(!(e&&e.isBufferGeometry)){console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);return}t===void 0&&(t=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const n=this.attributes;for(const r in n){if(e.attributes[r]===void 0)continue;const s=n[r].array,o=e.attributes[r],l=o.array,c=o.itemSize*t,u=Math.min(l.length,s.length-c);for(let f=0,h=c;f<u;f++,h++)s[h]=l[f]}return this}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)jt.fromBufferAttribute(e,t),jt.normalize(),e.setXYZ(t,jt.x,jt.y,jt.z)}toNonIndexed(){function e(o,l){const c=o.array,u=o.itemSize,f=o.normalized,h=new c.constructor(l.length*u);let d=0,p=0;for(let v=0,_=l.length;v<_;v++){o.isInterleavedBufferAttribute?d=l[v]*o.data.stride+o.offset:d=l[v]*u;for(let m=0;m<u;m++)h[p++]=c[d++]}return new Ze(h,u,f)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new at,n=this.index.array,r=this.attributes;for(const o in r){const l=r[o],c=e(l,n);t.setAttribute(o,c)}const i=this.morphAttributes;for(const o in i){const l=[],c=i[o];for(let u=0,f=c.length;u<f;u++){const h=c[u],d=e(h,n);l.push(d)}t.morphAttributes[o]=l}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let o=0,l=s.length;o<l;o++){const c=s[o];t.addGroup(c.start,c.count,c.materialIndex)}return t}toJSON(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,this.name!==""&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),this.parameters!==void 0){const l=this.parameters;for(const c in l)l[c]!==void 0&&(e[c]=l[c]);return e}e.data={attributes:{}};const t=this.index;t!==null&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const l in n){const c=n[l];e.data.attributes[l]=c.toJSON(e.data)}const r={};let i=!1;for(const l in this.morphAttributes){const c=this.morphAttributes[l],u=[];for(let f=0,h=c.length;f<h;f++){const d=c[f];u.push(d.toJSON(e.data))}u.length>0&&(r[l]=u,i=!0)}i&&(e.data.morphAttributes=r,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return o!==null&&(e.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),e}clone(){return new at().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;n!==null&&this.setIndex(n.clone(t));const r=e.attributes;for(const c in r){const u=r[c];this.setAttribute(c,u.clone(t))}const i=e.morphAttributes;for(const c in i){const u=[],f=i[c];for(let h=0,d=f.length;h<d;h++)u.push(f[h].clone(t));this.morphAttributes[c]=u}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let c=0,u=s.length;c<u;c++){const f=s[c];this.addGroup(f.start,f.count,f.materialIndex)}const o=e.boundingBox;o!==null&&(this.boundingBox=o.clone());const l=e.boundingSphere;return l!==null&&(this.boundingSphere=l.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}at.prototype.isBufferGeometry=!0;const np=new Ce,va=new Ei,mu=new Lr,Zn=new b,Kn=new b,Jn=new b,vu=new b,gu=new b,_u=new b,rl=new b,nl=new b,il=new b,al=new ve,sl=new ve,ol=new ve,yu=new b,ll=new b;class ft extends lt{constructor(e=new at,t=new Ec){super(),this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),e.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),e.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,n=Object.keys(t);if(n.length>0){const r=t[n[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,s=r.length;i<s;i++){const o=r[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=i}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}raycast(e,t){const n=this.geometry,r=this.material,i=this.matrixWorld;if(r===void 0||(n.boundingSphere===null&&n.computeBoundingSphere(),mu.copy(n.boundingSphere),mu.applyMatrix4(i),e.ray.intersectsSphere(mu)===!1)||(np.copy(i).invert(),va.copy(e.ray).applyMatrix4(np),n.boundingBox!==null&&va.intersectsBox(n.boundingBox)===!1))return;let s;if(n.isBufferGeometry){const o=n.index,l=n.attributes.position,c=n.morphAttributes.position,u=n.morphTargetsRelative,f=n.attributes.uv,h=n.attributes.uv2,d=n.groups,p=n.drawRange;if(o!==null)if(Array.isArray(r))for(let v=0,_=d.length;v<_;v++){const m=d[v],g=r[m.materialIndex],y=Math.max(m.start,p.start),x=Math.min(m.start+m.count,p.start+p.count);for(let S=y,M=x;S<M;S+=3){const E=o.getX(S),N=o.getX(S+1),B=o.getX(S+2);s=cl(this,g,e,va,l,c,u,f,h,E,N,B),s&&(s.faceIndex=Math.floor(S/3),s.face.materialIndex=m.materialIndex,t.push(s))}}else{const v=Math.max(0,p.start),_=Math.min(o.count,p.start+p.count);for(let m=v,g=_;m<g;m+=3){const y=o.getX(m),x=o.getX(m+1),S=o.getX(m+2);s=cl(this,r,e,va,l,c,u,f,h,y,x,S),s&&(s.faceIndex=Math.floor(m/3),t.push(s))}}else if(l!==void 0)if(Array.isArray(r))for(let v=0,_=d.length;v<_;v++){const m=d[v],g=r[m.materialIndex],y=Math.max(m.start,p.start),x=Math.min(m.start+m.count,p.start+p.count);for(let S=y,M=x;S<M;S+=3){const E=S,N=S+1,B=S+2;s=cl(this,g,e,va,l,c,u,f,h,E,N,B),s&&(s.faceIndex=Math.floor(S/3),s.face.materialIndex=m.materialIndex,t.push(s))}}else{const v=Math.max(0,p.start),_=Math.min(l.count,p.start+p.count);for(let m=v,g=_;m<g;m+=3){const y=m,x=m+1,S=m+2;s=cl(this,r,e,va,l,c,u,f,h,y,x,S),s&&(s.faceIndex=Math.floor(m/3),t.push(s))}}}else n.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}ft.prototype.isMesh=!0;function vx(a,e,t,n,r,i,s,o){let l;if(e.side===Ut?l=n.intersectTriangle(s,i,r,!0,o):l=n.intersectTriangle(r,i,s,e.side!==Yi,o),l===null)return null;ll.copy(o),ll.applyMatrix4(a.matrixWorld);const c=t.ray.origin.distanceTo(ll);return c<t.near||c>t.far?null:{distance:c,point:ll.clone(),object:a}}function cl(a,e,t,n,r,i,s,o,l,c,u,f){Zn.fromBufferAttribute(r,c),Kn.fromBufferAttribute(r,u),Jn.fromBufferAttribute(r,f);const h=a.morphTargetInfluences;if(i&&h){rl.set(0,0,0),nl.set(0,0,0),il.set(0,0,0);for(let p=0,v=i.length;p<v;p++){const _=h[p],m=i[p];_!==0&&(vu.fromBufferAttribute(m,c),gu.fromBufferAttribute(m,u),_u.fromBufferAttribute(m,f),s?(rl.addScaledVector(vu,_),nl.addScaledVector(gu,_),il.addScaledVector(_u,_)):(rl.addScaledVector(vu.sub(Zn),_),nl.addScaledVector(gu.sub(Kn),_),il.addScaledVector(_u.sub(Jn),_)))}Zn.add(rl),Kn.add(nl),Jn.add(il)}a.isSkinnedMesh&&(a.boneTransform(c,Zn),a.boneTransform(u,Kn),a.boneTransform(f,Jn));const d=vx(a,e,t,n,Zn,Kn,Jn,yu);if(d){o&&(al.fromBufferAttribute(o,c),sl.fromBufferAttribute(o,u),ol.fromBufferAttribute(o,f),d.uv=Br.getUV(yu,Zn,Kn,Jn,al,sl,ol,new ve)),l&&(al.fromBufferAttribute(l,c),sl.fromBufferAttribute(l,u),ol.fromBufferAttribute(l,f),d.uv2=Br.getUV(yu,Zn,Kn,Jn,al,sl,ol,new ve));const p={a:c,b:u,c:f,normal:new b,materialIndex:0};Br.getNormal(Zn,Kn,Jn,p.normal),d.face=p}return d}class So extends at{constructor(e=1,t=1,n=1,r=1,i=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:r,heightSegments:i,depthSegments:s};const o=this;r=Math.floor(r),i=Math.floor(i),s=Math.floor(s);const l=[],c=[],u=[],f=[];let h=0,d=0;p("z","y","x",-1,-1,n,t,e,s,i,0),p("z","y","x",1,-1,n,t,-e,s,i,1),p("x","z","y",1,1,e,n,t,r,s,2),p("x","z","y",1,-1,e,n,-t,r,s,3),p("x","y","z",1,-1,e,t,n,r,i,4),p("x","y","z",-1,-1,e,t,-n,r,i,5),this.setIndex(l),this.setAttribute("position",new wt(c,3)),this.setAttribute("normal",new wt(u,3)),this.setAttribute("uv",new wt(f,2));function p(v,_,m,g,y,x,S,M,E,N,B){const V=x/E,O=S/N,W=x/2,z=S/2,C=M/2,T=E+1,A=N+1;let F=0,X=0;const Y=new b;for(let ne=0;ne<A;ne++){const ae=ne*O-z;for(let xe=0;xe<T;xe++){const be=xe*V-W;Y[v]=be*g,Y[_]=ae*y,Y[m]=C,c.push(Y.x,Y.y,Y.z),Y[v]=0,Y[_]=0,Y[m]=M>0?1:-1,u.push(Y.x,Y.y,Y.z),f.push(xe/E),f.push(1-ne/N),F+=1}}for(let ne=0;ne<N;ne++)for(let ae=0;ae<E;ae++){const xe=h+ae+T*ne,be=h+ae+T*(ne+1),ge=h+(ae+1)+T*(ne+1),we=h+(ae+1)+T*ne;l.push(xe,be,we),l.push(be,ge,we),X+=6}o.addGroup(d,X,B),d+=X,h+=F}}static fromJSON(e){return new So(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function ts(a){const e={};for(const t in a){e[t]={};for(const n in a[t]){const r=a[t][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?e[t][n]=r.clone():Array.isArray(r)?e[t][n]=r.slice():e[t][n]=r}}return e}function tr(a){const e={};for(let t=0;t<a.length;t++){const n=ts(a[t]);for(const r in n)e[r]=n[r]}return e}const qi={clone:ts,merge:tr};var gx=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,_x=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class cn extends er{constructor(e){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=gx,this.fragmentShader=_x,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&(e.attributes!==void 0&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=ts(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const r in this.uniforms){const s=this.uniforms[r].value;s&&s.isTexture?t.uniforms[r]={type:"t",value:s.toJSON(e).uuid}:s&&s.isColor?t.uniforms[r]={type:"c",value:s.getHex()}:s&&s.isVector2?t.uniforms[r]={type:"v2",value:s.toArray()}:s&&s.isVector3?t.uniforms[r]={type:"v3",value:s.toArray()}:s&&s.isVector4?t.uniforms[r]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?t.uniforms[r]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?t.uniforms[r]={type:"m4",value:s.toArray()}:t.uniforms[r]={value:s}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const n={};for(const r in this.extensions)this.extensions[r]===!0&&(n[r]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}cn.prototype.isShaderMaterial=!0;class oh extends lt{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new Ce,this.projectionMatrix=new Ce,this.projectionMatrixInverse=new Ce}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}oh.prototype.isCamera=!0;class Bt extends oh{constructor(e=50,t=1,n=.1,r=2e3){super(),this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=r,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=e.view===null?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=oo*2*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(Ya*.5*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return oo*2*Math.atan(Math.tan(Ya*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,n,r,i,s){this.aspect=e/t,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=r,this.view.width=i,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(Ya*.5*this.fov)/this.zoom,n=2*t,r=this.aspect*n,i=-.5*r;const s=this.view;if(this.view!==null&&this.view.enabled){const l=s.fullWidth,c=s.fullHeight;i+=s.offsetX*r/l,t-=s.offsetY*n/c,r*=s.width/l,n*=s.height/c}const o=this.filmOffset;o!==0&&(i+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+r,t,t-n,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,this.view!==null&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}Bt.prototype.isPerspectiveCamera=!0;const ga=90,_a=1;class lh extends lt{constructor(e,t,n){if(super(),this.type="CubeCamera",n.isWebGLCubeRenderTarget!==!0){console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");return}this.renderTarget=n;const r=new Bt(ga,_a,e,t);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new b(1,0,0)),this.add(r);const i=new Bt(ga,_a,e,t);i.layers=this.layers,i.up.set(0,-1,0),i.lookAt(new b(-1,0,0)),this.add(i);const s=new Bt(ga,_a,e,t);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new b(0,1,0)),this.add(s);const o=new Bt(ga,_a,e,t);o.layers=this.layers,o.up.set(0,0,-1),o.lookAt(new b(0,-1,0)),this.add(o);const l=new Bt(ga,_a,e,t);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new b(0,0,1)),this.add(l);const c=new Bt(ga,_a,e,t);c.layers=this.layers,c.up.set(0,-1,0),c.lookAt(new b(0,0,-1)),this.add(c)}update(e,t){this.parent===null&&this.updateMatrixWorld();const n=this.renderTarget,[r,i,s,o,l,c]=this.children,u=e.xr.enabled,f=e.getRenderTarget();e.xr.enabled=!1;const h=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0),e.render(t,r),e.setRenderTarget(n,1),e.render(t,i),e.setRenderTarget(n,2),e.render(t,s),e.setRenderTarget(n,3),e.render(t,o),e.setRenderTarget(n,4),e.render(t,l),n.texture.generateMipmaps=h,e.setRenderTarget(n,5),e.render(t,c),e.setRenderTarget(f),e.xr.enabled=u}}class Cc extends Qt{constructor(e,t,n,r,i,s,o,l,c,u){e=e!==void 0?e:[],t=t!==void 0?t:xc,o=o!==void 0?o:fi,super(e,t,n,r,i,s,o,l,c,u),this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}Cc.prototype.isCubeTexture=!0;class Kv extends Gt{constructor(e,t,n){Number.isInteger(t)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),t=n),super(e,e,t),t=t||{},this.texture=new Cc(void 0,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=t.generateMipmaps!==void 0?t.generateMipmaps:!1,this.texture.minFilter=t.minFilter!==void 0?t.minFilter:pt,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.format=Ft,this.texture.encoding=t.encoding,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},r=new So(5,5,5),i=new cn({name:"CubemapFromEquirect",uniforms:ts(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:Ut,blending:zn});i.uniforms.tEquirect.value=t;const s=new ft(r,i),o=t.minFilter;return t.minFilter===wc&&(t.minFilter=pt),new lh(1,10,this).update(e,s),t.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(e,t,n,r){const i=e.getRenderTarget();for(let s=0;s<6;s++)e.setRenderTarget(this,s),e.clear(t,n,r);e.setRenderTarget(i)}}Kv.prototype.isWebGLCubeRenderTarget=!0;const xu=new b,yx=new b,xx=new zt;class an{constructor(e=new b(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,r){return this.normal.set(e,t,n),this.constant=r,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const r=xu.subVectors(n,t).cross(yx.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}intersectLine(e,t){const n=e.delta(xu),r=this.normal.dot(n);if(r===0)return this.distanceToPoint(e.start)===0?t.copy(e.start):null;const i=-(e.start.dot(this.normal)+this.constant)/r;return i<0||i>1?null:t.copy(n).multiplyScalar(i).add(e.start)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||xx.getNormalMatrix(e),r=this.coplanarPoint(xu).applyMatrix4(e),i=this.normal.applyMatrix3(n).normalize();return this.constant=-r.dot(i),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}an.prototype.isPlane=!0;const ya=new Lr,ul=new b;class Ac{constructor(e=new an,t=new an,n=new an,r=new an,i=new an,s=new an){this.planes=[e,t,n,r,i,s]}set(e,t,n,r,i,s){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(r),o[4].copy(i),o[5].copy(s),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e){const t=this.planes,n=e.elements,r=n[0],i=n[1],s=n[2],o=n[3],l=n[4],c=n[5],u=n[6],f=n[7],h=n[8],d=n[9],p=n[10],v=n[11],_=n[12],m=n[13],g=n[14],y=n[15];return t[0].setComponents(o-r,f-l,v-h,y-_).normalize(),t[1].setComponents(o+r,f+l,v+h,y+_).normalize(),t[2].setComponents(o+i,f+c,v+d,y+m).normalize(),t[3].setComponents(o-i,f-c,v-d,y-m).normalize(),t[4].setComponents(o-s,f-u,v-p,y-g).normalize(),t[5].setComponents(o+s,f+u,v+p,y+g).normalize(),this}intersectsObject(e){const t=e.geometry;return t.boundingSphere===null&&t.computeBoundingSphere(),ya.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(ya)}intersectsSprite(e){return ya.center.set(0,0,0),ya.radius=.7071067811865476,ya.applyMatrix4(e.matrixWorld),this.intersectsSphere(ya)}intersectsSphere(e){const t=this.planes,n=e.center,r=-e.radius;for(let i=0;i<6;i++)if(t[i].distanceToPoint(n)<r)return!1;return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const r=t[n];if(ul.x=r.normal.x>0?e.max.x:e.min.x,ul.y=r.normal.y>0?e.max.y:e.min.y,ul.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(ul)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}function Jv(){let a=null,e=!1,t=null,n=null;function r(i,s){t(i,s),n=a.requestAnimationFrame(r)}return{start:function(){e!==!0&&t!==null&&(n=a.requestAnimationFrame(r),e=!0)},stop:function(){a.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(i){t=i},setContext:function(i){a=i}}}function Sx(a,e){const t=e.isWebGL2,n=new WeakMap;function r(c,u){const f=c.array,h=c.usage,d=a.createBuffer();a.bindBuffer(u,d),a.bufferData(u,f,h),c.onUploadCallback();let p=5126;return f instanceof Float32Array?p=5126:f instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):f instanceof Uint16Array?c.isFloat16BufferAttribute?t?p=5131:console.warn("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2."):p=5123:f instanceof Int16Array?p=5122:f instanceof Uint32Array?p=5125:f instanceof Int32Array?p=5124:f instanceof Int8Array?p=5120:(f instanceof Uint8Array||f instanceof Uint8ClampedArray)&&(p=5121),{buffer:d,type:p,bytesPerElement:f.BYTES_PER_ELEMENT,version:c.version}}function i(c,u,f){const h=u.array,d=u.updateRange;a.bindBuffer(f,c),d.count===-1?a.bufferSubData(f,0,h):(t?a.bufferSubData(f,d.offset*h.BYTES_PER_ELEMENT,h,d.offset,d.count):a.bufferSubData(f,d.offset*h.BYTES_PER_ELEMENT,h.subarray(d.offset,d.offset+d.count)),d.count=-1)}function s(c){return c.isInterleavedBufferAttribute&&(c=c.data),n.get(c)}function o(c){c.isInterleavedBufferAttribute&&(c=c.data);const u=n.get(c);u&&(a.deleteBuffer(u.buffer),n.delete(c))}function l(c,u){if(c.isGLBufferAttribute){const h=n.get(c);(!h||h.version<c.version)&&n.set(c,{buffer:c.buffer,type:c.type,bytesPerElement:c.elementSize,version:c.version});return}c.isInterleavedBufferAttribute&&(c=c.data);const f=n.get(c);f===void 0?n.set(c,r(c,u)):f.version<c.version&&(i(f.buffer,c,u),f.version=c.version)}return{get:s,remove:o,update:l}}class Ci extends at{constructor(e=1,t=1,n=1,r=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:r};const i=e/2,s=t/2,o=Math.floor(n),l=Math.floor(r),c=o+1,u=l+1,f=e/o,h=t/l,d=[],p=[],v=[],_=[];for(let m=0;m<u;m++){const g=m*h-s;for(let y=0;y<c;y++){const x=y*f-i;p.push(x,-g,0),v.push(0,0,1),_.push(y/o),_.push(1-m/l)}}for(let m=0;m<l;m++)for(let g=0;g<o;g++){const y=g+c*m,x=g+c*(m+1),S=g+1+c*(m+1),M=g+1+c*m;d.push(y,x,M),d.push(x,S,M)}this.setIndex(d),this.setAttribute("position",new wt(p,3)),this.setAttribute("normal",new wt(v,3)),this.setAttribute("uv",new wt(_,2))}static fromJSON(e){return new Ci(e.width,e.height,e.widthSegments,e.heightSegments)}}var bx=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vUv ).g;
#endif`,wx=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,Mx=`#ifdef ALPHATEST
	if ( diffuseColor.a < ALPHATEST ) discard;
#endif`,Ex=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );
	#endif
#endif`,Cx=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,Ax="vec3 transformed = vec3( position );",Tx=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,Rx=`vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	return vec2( -1.04, 1.04 ) * a004 + r.zw;
}
float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
#if defined ( PHYSICALLY_CORRECT_LIGHTS )
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
	if( cutoffDistance > 0.0 ) {
		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
	}
	return distanceFalloff;
#else
	if( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
		return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );
	}
	return 1.0;
#endif
}
vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in vec3 f90, const in float dotVH ) {
	float fresnel = exp2( ( -5.55473 * dotVH - 6.98316 ) * dotVH );
	return ( f90 - f0 ) * fresnel + f0;
}
vec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {
	float fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );
	vec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;
	return Fr * fresnel + F0;
}
float G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	return 1.0 / ( gl * gv );
}
float G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
vec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in vec3 f90, const in float roughness ) {
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( incidentLight.direction + viewDir );
	float dotNL = saturate( dot( normal, incidentLight.direction ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotLH = saturate( dot( incidentLight.direction, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotLH );
	float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );
	float D = D_GGX( alpha, dotNH );
	return F * ( G * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
vec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	vec2 brdf = integrateSpecularBRDF( dotNV, roughness );
	return specularColor * brdf.x + brdf.y;
}
void BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
	float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
	vec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );
	vec2 brdf = integrateSpecularBRDF( dotNV, roughness );
	vec3 FssEss = F * brdf.x + brdf.y;
	float Ess = brdf.x + brdf.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );
	float dotNH = saturate( dot( geometry.normal, halfDir ) );
	float dotLH = saturate( dot( incidentLight.direction, halfDir ) );
	vec3 F = F_Schlick( specularColor, vec3( 1.0 ), dotLH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
}
float GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {
	return ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );
}
float BlinnExponentToGGXRoughness( const in float blinnExponent ) {
	return sqrt( 2.0 / ( blinnExponent + 2.0 ) );
}
#if defined( USE_SHEEN )
float D_Charlie(float roughness, float NoH) {
	float invAlpha = 1.0 / roughness;
	float cos2h = NoH * NoH;
	float sin2h = max(1.0 - cos2h, 0.0078125);	return (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);
}
float V_Neubelt(float NoV, float NoL) {
	return saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));
}
vec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {
	vec3 N = geometry.normal;
	vec3 V = geometry.viewDir;
	vec3 H = normalize( V + L );
	float dotNH = saturate( dot( N, H ) );
	return specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );
}
#endif`,Lx=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vUv );
		vec2 dSTdy = dFdy( vUv );
		float Hll = bumpScale * texture2D( bumpMap, vUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );
		vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,Px=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,Nx=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,Ix=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,kx=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,Ox=`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,Dx=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,Fx=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	varying vec3 vColor;
#endif`,Bx=`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif`,zx=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate(a) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement(a) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract(sin(sn) * c);
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
struct GeometricContext {
	vec3 position;
	vec3 normal;
	vec3 viewDir;
#ifdef CLEARCOAT
	vec3 clearcoatNormal;
#endif
};
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
vec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {
	float distance = dot( planeNormal, point - pointOnPlane );
	return - distance * planeNormal + point;
}
float sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {
	return sign( dot( point - pointOnPlane, planeNormal ) );
}
vec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {
	return lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float linearToRelativeLuminance( const in vec3 color ) {
	vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );
	return dot( weights, color.rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}`,Vx=`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_maxMipLevel 8.0
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_maxTileSize 256.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		float texelSize = 1.0 / ( 3.0 * cubeUV_maxTileSize );
		vec2 uv = getUV( direction, face ) * ( faceSize - 1.0 );
		vec2 f = fract( uv );
		uv += 0.5 - f;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		if ( mipInt < cubeUV_maxMipLevel ) {
			uv.y += 2.0 * cubeUV_maxTileSize;
		}
		uv.y += filterInt * 2.0 * cubeUV_minTileSize;
		uv.x += 3.0 * max( 0.0, cubeUV_maxTileSize - 2.0 * faceSize );
		uv *= texelSize;
		vec3 tl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x += texelSize;
		vec3 tr = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.y += texelSize;
		vec3 br = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		uv.x -= texelSize;
		vec3 bl = envMapTexelToLinear( texture2D( envMap, uv ) ).rgb;
		vec3 tm = mix( tl, tr, f.x );
		vec3 bm = mix( bl, br, f.x );
		return mix( tm, bm, f.y );
	}
	#define r0 1.0
	#define v0 0.339
	#define m0 - 2.0
	#define r1 0.8
	#define v1 0.276
	#define m1 - 1.0
	#define r4 0.4
	#define v4 0.046
	#define m4 2.0
	#define r5 0.305
	#define v5 0.016
	#define m5 3.0
	#define r6 0.21
	#define v6 0.0038
	#define m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= r1 ) {
			mip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;
		} else if ( roughness >= r4 ) {
			mip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;
		} else if ( roughness >= r5 ) {
			mip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;
		} else if ( roughness >= r6 ) {
			mip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), m0, cubeUV_maxMipLevel );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,Ux=`vec3 transformedNormal = objectNormal;
#ifdef USE_INSTANCING
	mat3 m = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
	transformedNormal = m * transformedNormal;
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,Gx=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,Hx=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );
#endif`,Wx=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vUv );
	emissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,Xx=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,jx="gl_FragColor = linearToOutputTexel( gl_FragColor );",Yx=`
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );
}
vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );
}
vec4 sRGBToLinear( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 LinearTosRGB( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 RGBEToLinear( in vec4 value ) {
	return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );
}
vec4 LinearToRGBE( in vec4 value ) {
	float maxComponent = max( max( value.r, value.g ), value.b );
	float fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );
	return vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );
}
vec4 RGBMToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * value.a * maxRange, 1.0 );
}
vec4 LinearToRGBM( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float M = clamp( maxRGB / maxRange, 0.0, 1.0 );
	M = ceil( M * 255.0 ) / 255.0;
	return vec4( value.rgb / ( M * maxRange ), M );
}
vec4 RGBDToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );
}
vec4 LinearToRGBD( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float D = max( maxRange / maxRGB, 1.0 );
	D = clamp( floor( D ) / 255.0, 0.0, 1.0 );
	return vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );
}
const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );
vec4 LinearToLogLuv( in vec4 value ) {
	vec3 Xp_Y_XYZp = cLogLuvM * value.rgb;
	Xp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );
	vec4 vResult;
	vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;
	float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;
	vResult.w = fract( Le );
	vResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;
	return vResult;
}
const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );
vec4 LogLuvToLinear( in vec4 value ) {
	float Le = value.z * 255.0 + value.w;
	vec3 Xp_Y_XYZp;
	Xp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );
	Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;
	Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;
	vec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;
	return vec4( max( vRGB, 0.0 ), 1.0 );
}`,qx=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifndef ENVMAP_TYPE_CUBE_UV
		envColor = envMapTexelToLinear( envColor );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,$x=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform int maxMipLevel;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,Zx=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,Kx=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,Jx=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,Qx=`#ifdef USE_FOG
	fogDepth = - mvPosition.z;
#endif`,eS=`#ifdef USE_FOG
	varying float fogDepth;
#endif`,tS=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, fogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,rS=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float fogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,nS=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return texture2D( gradientMap, coord ).rgb;
	#else
		return ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );
	#endif
}`,iS=`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel= texture2D( lightMap, vUv2 );
	reflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
#endif`,aS=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,sS=`vec3 diffuse = vec3( 1.0 );
GeometricContext geometry;
geometry.position = mvPosition.xyz;
geometry.normal = normalize( transformedNormal );
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );
GeometricContext backGeometry;
backGeometry.position = geometry.position;
backGeometry.normal = -geometry.normal;
backGeometry.viewDir = geometry.viewDir;
vLightFront = vec3( 0.0 );
vIndirectFront = vec3( 0.0 );
#ifdef DOUBLE_SIDED
	vLightBack = vec3( 0.0 );
	vIndirectBack = vec3( 0.0 );
#endif
IncidentLight directLight;
float dotNL;
vec3 directLightColor_Diffuse;
vIndirectFront += getAmbientLightIrradiance( ambientLightColor );
vIndirectFront += getLightProbeIrradiance( lightProbe, geometry );
#ifdef DOUBLE_SIDED
	vIndirectBack += getAmbientLightIrradiance( ambientLightColor );
	vIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );
#endif
#if NUM_POINT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		getPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_SPOT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		getSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_DIR_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		getDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_HEMI_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
		vIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		#ifdef DOUBLE_SIDED
			vIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );
		#endif
	}
	#pragma unroll_loop_end
#endif`,oS=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
uniform vec3 lightProbe[ 9 ];
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {
	vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	return irradiance;
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {
		directLight.color = directionalLight.color;
		directLight.direction = directionalLight.direction;
		directLight.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {
		vec3 lVector = pointLight.position - geometry.position;
		directLight.direction = normalize( lVector );
		float lightDistance = length( lVector );
		directLight.color = pointLight.color;
		directLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );
		directLight.visible = ( directLight.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight ) {
		vec3 lVector = spotLight.position - geometry.position;
		directLight.direction = normalize( lVector );
		float lightDistance = length( lVector );
		float angleCos = dot( directLight.direction, spotLight.direction );
		if ( angleCos > spotLight.coneCos ) {
			float spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );
			directLight.color = spotLight.color;
			directLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );
			directLight.visible = true;
		} else {
			directLight.color = vec3( 0.0 );
			directLight.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {
		float dotNL = dot( geometry.normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			irradiance *= PI;
		#endif
		return irradiance;
	}
#endif`,lS=`#if defined( USE_ENVMAP )
	#ifdef ENVMAP_MODE_REFRACTION
		uniform float refractionRatio;
	#endif
	vec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {
		vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
		#ifdef ENVMAP_TYPE_CUBE
			vec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );
			#ifdef TEXTURE_LOD_EXT
				vec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );
			#else
				vec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );
			#endif
			envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;
		#elif defined( ENVMAP_TYPE_CUBE_UV )
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
		#else
			vec4 envMapColor = vec4( 0.0 );
		#endif
		return PI * envMapColor.rgb * envMapIntensity;
	}
	float getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {
		float maxMIPLevelScalar = float( maxMIPLevel );
		float sigma = PI * roughness * roughness / ( 1.0 + roughness );
		float desiredMIPLevel = maxMIPLevelScalar + log2( sigma );
		return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );
	}
	vec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( -viewDir, normal );
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
		#else
			vec3 reflectVec = refract( -viewDir, normal, refractionRatio );
		#endif
		reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
		float specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );
		#ifdef ENVMAP_TYPE_CUBE
			vec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );
			#ifdef TEXTURE_LOD_EXT
				vec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );
			#else
				vec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );
			#endif
			envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;
		#elif defined( ENVMAP_TYPE_CUBE_UV )
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
		#endif
		return envMapColor.rgb * envMapIntensity;
	}
#endif`,cS=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,uS=`varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon
#define Material_LightProbeLOD( material )	(0)`,fS=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,hS=`varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
#define Material_LightProbeLOD( material )	(0)`,dS=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;
material.specularRoughness = min( material.specularRoughness, 1.0 );
#ifdef REFLECTIVITY
	#ifdef SPECULAR
		vec3 specularIntensityFactor = vec3( specularIntensity );
		vec3 specularTintFactor = specularTint;
		#ifdef USE_SPECULARINTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;
		#endif
		#ifdef USE_SPECULARTINTMAP
			specularTintFactor *= specularTintMapTexelToLinear( texture2D( specularTintMap, vUv ) ).rgb;
		#endif
		material.specularColorF90 = mix( specularIntensityFactor, vec3( 1.0 ), metalnessFactor );
	#else
		vec3 specularIntensityFactor = vec3( 1.0 );
		vec3 specularTintFactor = vec3( 1.0 );
		material.specularColorF90 = vec3( 1.0 );
	#endif
	material.specularColor = mix( min( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ) * specularTintFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );
	material.specularColorF90 = vec3( 1.0 );
#endif
#ifdef CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheen;
#endif`,pS=`struct PhysicalMaterial {
	vec3 diffuseColor;
	float specularRoughness;
	vec3 specularColor;
	vec3 specularColorF90;
#ifdef CLEARCOAT
	float clearcoat;
	float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	vec3 sheenColor;
#endif
};
#define MAXIMUM_SPECULAR_COEFFICIENT 0.16
#define DEFAULT_SPECULAR_COEFFICIENT 0.04
float clearcoatDHRApprox( const in float roughness, const in float dotNL ) {
	return DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometry.normal;
		vec3 viewDir = geometry.viewDir;
		vec3 position = geometry.position;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.specularRoughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	#ifdef CLEARCOAT
		float ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = ccDotNL * directLight.color;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			ccIrradiance *= PI;
		#endif
		float clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );
		reflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), vec3( 1.0 ), material.clearcoatRoughness );
	#else
		float clearcoatDHR = 0.0;
	#endif
	#ifdef USE_SHEEN
		reflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(
			material.specularRoughness,
			directLight.direction,
			geometry,
			material.sheenColor
		);
	#else
		reflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularColorF90, material.specularRoughness);
	#endif
	reflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef CLEARCOAT
		float ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );
		reflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );
		float ccDotNL = ccDotNV;
		float clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );
	#else
		float clearcoatDHR = 0.0;
	#endif
	float clearcoatInv = 1.0 - clearcoatDHR;
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	BRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );
	vec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );
	reflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,mS=`
GeometricContext geometry;
geometry.position = - vViewPosition;
geometry.normal = normal;
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
#ifdef CLEARCOAT
	geometry.clearcoatNormal = clearcoatNormal;
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointDirectLightIrradiance( pointLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotDirectLightIrradiance( spotLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	irradiance += getLightProbeIrradiance( lightProbe, geometry );
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,vS=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			lightMapIrradiance *= PI;
		#endif
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	radiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );
	#ifdef CLEARCOAT
		clearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );
	#endif
#endif`,gS=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );
#endif`,_S=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,yS=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,xS=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,SS=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,bS=`#ifdef USE_MAP
	vec4 texelColor = texture2D( map, vUv );
	texelColor = mapTexelToLinear( texelColor );
	diffuseColor *= texelColor;
#endif`,wS=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,MS=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
#endif
#ifdef USE_MAP
	vec4 mapTexel = texture2D( map, uv );
	diffuseColor *= mapTexelToLinear( mapTexel );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,ES=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	uniform mat3 uvTransform;
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,CS=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vUv );
	metalnessFactor *= texelMetalness.b;
#endif`,AS=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,TS=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
	objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
	objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
	objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
#endif`,RS=`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifndef USE_MORPHNORMALS
		uniform float morphTargetInfluences[ 8 ];
	#else
		uniform float morphTargetInfluences[ 4 ];
	#endif
#endif`,LS=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	transformed += morphTarget0 * morphTargetInfluences[ 0 ];
	transformed += morphTarget1 * morphTargetInfluences[ 1 ];
	transformed += morphTarget2 * morphTargetInfluences[ 2 ];
	transformed += morphTarget3 * morphTargetInfluences[ 3 ];
	#ifndef USE_MORPHNORMALS
		transformed += morphTarget4 * morphTargetInfluences[ 4 ];
		transformed += morphTarget5 * morphTargetInfluences[ 5 ];
		transformed += morphTarget6 * morphTargetInfluences[ 6 ];
		transformed += morphTarget7 * morphTargetInfluences[ 7 ];
	#endif
#endif`,PS=`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );
	vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	#ifdef USE_TANGENT
		vec3 tangent = normalize( vTangent );
		vec3 bitangent = normalize( vBitangent );
		#ifdef DOUBLE_SIDED
			tangent = tangent * faceDirection;
			bitangent = bitangent * faceDirection;
		#endif
		#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )
			mat3 vTBN = mat3( tangent, bitangent, normal );
		#endif
	#endif
#endif
vec3 geometryNormal = normal;`,NS=`#ifdef OBJECTSPACE_NORMALMAP
	normal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( TANGENTSPACE_NORMALMAP )
	vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	#ifdef USE_TANGENT
		normal = normalize( vTBN * mapN );
	#else
		normal = perturbNormal2Arb( -vViewPosition, normal, mapN, faceDirection );
	#endif
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,IS=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef OBJECTSPACE_NORMALMAP
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )
	vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {
		vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );
		vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );
		vec2 st0 = dFdx( vUv.st );
		vec2 st1 = dFdy( vUv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );
		return normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );
	}
#endif`,kS=`#ifdef CLEARCOAT
	vec3 clearcoatNormal = geometryNormal;
#endif`,OS=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	#ifdef USE_TANGENT
		clearcoatNormal = normalize( vTBN * clearcoatMapN );
	#else
		clearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );
	#endif
#endif`,DS=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif`,FS=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
	return linearClipZ * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return (( near + viewZ ) * far ) / (( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * invClipZ - far );
}`,BS=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,zS=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,VS=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,US=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,GS=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vUv );
	roughnessFactor *= texelRoughness.g;
#endif`,HS=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,WS=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );
		bool inFrustum = all( inFrustumVec );
		bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );
		bool frustumTest = all( frustumTestVec );
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,XS=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,jS=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0
		vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		vec4 shadowWorldPosition;
	#endif
	#if NUM_DIR_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
		vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );
		vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
		vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
#endif`,YS=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,qS=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,$S=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	#ifdef BONE_TEXTURE
		uniform highp sampler2D boneTexture;
		uniform int boneTextureSize;
		mat4 getBoneMatrix( const in float i ) {
			float j = i * 4.0;
			float x = mod( j, float( boneTextureSize ) );
			float y = floor( j / float( boneTextureSize ) );
			float dx = 1.0 / float( boneTextureSize );
			float dy = 1.0 / float( boneTextureSize );
			y = dy * ( y + 0.5 );
			vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );
			vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );
			vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );
			vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );
			mat4 bone = mat4( v1, v2, v3, v4 );
			return bone;
		}
	#else
		uniform mat4 boneMatrices[ MAX_BONES ];
		mat4 getBoneMatrix( const in float i ) {
			mat4 bone = boneMatrices[ int(i) ];
			return bone;
		}
	#endif
#endif`,ZS=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,KS=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,JS=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,QS=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,eb=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,tb=`#ifndef saturate
#define saturate(a) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return toneMappingExposure * color;
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,rb=`#ifdef USE_TRANSMISSION
	float transmissionFactor = transmission;
	float thicknessFactor = thickness;
	#ifdef USE_TRANSMISSIONMAP
		transmissionFactor *= texture2D( transmissionMap, vUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		thicknessFactor *= texture2D( thicknessMap, vUv ).g;
	#endif
	vec3 pos = vWorldPosition.xyz / vWorldPosition.w;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	float ior = ( 1.0 + 0.4 * reflectivity ) / ( 1.0 - 0.4 * reflectivity );
	vec3 transmission = transmissionFactor * getIBLVolumeRefraction(
		n, v, roughnessFactor, material.diffuseColor, material.specularColor,
		pos, modelMatrix, viewMatrix, projectionMatrix, ior, thicknessFactor,
		attenuationTint, attenuationDistance );
	totalDiffuse = mix( totalDiffuse, transmission, transmissionFactor );
#endif`,nb=`#ifdef USE_TRANSMISSION
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec4 vWorldPosition;
	vec3 getVolumeTransmissionRay(vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix) {
		vec3 refractionVector = refract(-v, normalize(n), 1.0 / ior);
		vec3 modelScale;
		modelScale.x = length(vec3(modelMatrix[0].xyz));
		modelScale.y = length(vec3(modelMatrix[1].xyz));
		modelScale.z = length(vec3(modelMatrix[2].xyz));
		return normalize(refractionVector) * thickness * modelScale;
	}
	float applyIorToRoughness(float roughness, float ior) {
		return roughness * clamp(ior * 2.0 - 2.0, 0.0, 1.0);
	}
	vec3 getTransmissionSample(vec2 fragCoord, float roughness, float ior) {
		float framebufferLod = log2(transmissionSamplerSize.x) * applyIorToRoughness(roughness, ior);
		return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod).rgb;
	}
	vec3 applyVolumeAttenuation(vec3 radiance, float transmissionDistance, vec3 attenuationColor, float attenuationDistance) {
		if (attenuationDistance == 0.0) {
			return radiance;
		} else {
			vec3 attenuationCoefficient = -log(attenuationColor) / attenuationDistance;
			vec3 transmittance = exp(-attenuationCoefficient * transmissionDistance);			return transmittance * radiance;
		}
	}
	vec3 getIBLVolumeRefraction(vec3 n, vec3 v, float perceptualRoughness, vec3 baseColor, vec3 specularColor,
		vec3 position, mat4 modelMatrix, mat4 viewMatrix, mat4 projMatrix, float ior, float thickness,
		vec3 attenuationColor, float attenuationDistance) {
		vec3 transmissionRay = getVolumeTransmissionRay(n, v, thickness, ior, modelMatrix);
		vec3 refractedRayExit = position + transmissionRay;
		vec4 ndcPos = projMatrix * viewMatrix * vec4(refractedRayExit, 1.0);
		vec2 refractionCoords = ndcPos.xy / ndcPos.w;
		refractionCoords += 1.0;
		refractionCoords /= 2.0;
		vec3 transmittedLight = getTransmissionSample(refractionCoords, perceptualRoughness, ior);
		vec3 attenuatedColor = applyVolumeAttenuation(transmittedLight, length(transmissionRay), attenuationColor, attenuationDistance);
		return (1.0 - specularColor) * attenuatedColor * baseColor;
	}
#endif`,ib=`#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )
	varying vec2 vUv;
#endif`,ab=`#ifdef USE_UV
	#ifdef UVS_VERTEX_ONLY
		vec2 vUv;
	#else
		varying vec2 vUv;
	#endif
	uniform mat3 uvTransform;
#endif`,sb=`#ifdef USE_UV
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
#endif`,ob=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	varying vec2 vUv2;
#endif`,lb=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	attribute vec2 uv2;
	varying vec2 vUv2;
	uniform mat3 uv2Transform;
#endif`,cb=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	vUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;
#endif`,ub=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION )
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`,fb=`uniform sampler2D t2D;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,hb=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,db=`#include <envmap_common_pars_fragment>
uniform float opacity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	vec3 vReflect = vWorldDirection;
	#include <envmap_fragment>
	gl_FragColor = envColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,pb=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,mb=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,vb=`#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,gb=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,_b=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,yb=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	vec4 texColor = texture2D( tEquirect, sampleUV );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,xb=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,Sb=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,bb=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,wb=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
	
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Mb=`#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,Eb=`uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <fog_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <emissivemap_fragment>
	#ifdef DOUBLE_SIDED
		reflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;
	#else
		reflectedLight.indirectDiffuse += vIndirectFront;
	#endif
	#include <lightmap_fragment>
	reflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );
	#ifdef DOUBLE_SIDED
		reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;
	#else
		reflectedLight.directDiffuse = vLightFront;
	#endif
	reflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Cb=`#define LAMBERT
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <bsdfs>
#include <lights_pars_begin>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <lights_lambert_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Ab=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <fog_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
		matcapColor = matcapTexelToLinear( matcapColor );
	#else
		vec4 matcapColor = vec4( 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Tb=`#define MATCAP
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#ifndef FLAT_SHADED
		vNormal = normalize( transformedNormal );
		#ifdef USE_TANGENT
			vTangent = normalize( transformedTangent );
			vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
		#endif
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,Rb=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Lb=`#define TOON
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Pb=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Nb=`#define PHONG
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Ib=`#define STANDARD
#ifdef PHYSICAL
	#define REFLECTIVITY
	#define CLEARCOAT
	#define SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationTint;
#endif
#ifdef REFLECTIVITY
	uniform float reflectivity;
#endif
#ifdef SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularTint;
	#ifdef USE_SPECULARINTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
	#ifdef USE_SPECULARTINTMAP
		uniform sampler2D specularTintMap;
	#endif
#endif
#ifdef CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheen;
#endif
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <bsdfs>
#include <transmission_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <lights_physical_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,kb=`#define STANDARD
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#ifdef USE_TRANSMISSION
	varying vec4 vWorldPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition;
#endif
}`,Ob=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <packing>
#include <uv_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
}`,Db=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	vViewPosition = - mvPosition.xyz;
#endif
}`,Fb=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,Bb=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,zb=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,Vb=`#include <common>
#include <fog_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <begin_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Ub=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,Gb=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`;const ct={alphamap_fragment:bx,alphamap_pars_fragment:wx,alphatest_fragment:Mx,aomap_fragment:Ex,aomap_pars_fragment:Cx,begin_vertex:Ax,beginnormal_vertex:Tx,bsdfs:Rx,bumpmap_pars_fragment:Lx,clipping_planes_fragment:Px,clipping_planes_pars_fragment:Nx,clipping_planes_pars_vertex:Ix,clipping_planes_vertex:kx,color_fragment:Ox,color_pars_fragment:Dx,color_pars_vertex:Fx,color_vertex:Bx,common:zx,cube_uv_reflection_fragment:Vx,defaultnormal_vertex:Ux,displacementmap_pars_vertex:Gx,displacementmap_vertex:Hx,emissivemap_fragment:Wx,emissivemap_pars_fragment:Xx,encodings_fragment:jx,encodings_pars_fragment:Yx,envmap_fragment:qx,envmap_common_pars_fragment:$x,envmap_pars_fragment:Zx,envmap_pars_vertex:Kx,envmap_physical_pars_fragment:lS,envmap_vertex:Jx,fog_vertex:Qx,fog_pars_vertex:eS,fog_fragment:tS,fog_pars_fragment:rS,gradientmap_pars_fragment:nS,lightmap_fragment:iS,lightmap_pars_fragment:aS,lights_lambert_vertex:sS,lights_pars_begin:oS,lights_toon_fragment:cS,lights_toon_pars_fragment:uS,lights_phong_fragment:fS,lights_phong_pars_fragment:hS,lights_physical_fragment:dS,lights_physical_pars_fragment:pS,lights_fragment_begin:mS,lights_fragment_maps:vS,lights_fragment_end:gS,logdepthbuf_fragment:_S,logdepthbuf_pars_fragment:yS,logdepthbuf_pars_vertex:xS,logdepthbuf_vertex:SS,map_fragment:bS,map_pars_fragment:wS,map_particle_fragment:MS,map_particle_pars_fragment:ES,metalnessmap_fragment:CS,metalnessmap_pars_fragment:AS,morphnormal_vertex:TS,morphtarget_pars_vertex:RS,morphtarget_vertex:LS,normal_fragment_begin:PS,normal_fragment_maps:NS,normalmap_pars_fragment:IS,clearcoat_normal_fragment_begin:kS,clearcoat_normal_fragment_maps:OS,clearcoat_pars_fragment:DS,packing:FS,premultiplied_alpha_fragment:BS,project_vertex:zS,dithering_fragment:VS,dithering_pars_fragment:US,roughnessmap_fragment:GS,roughnessmap_pars_fragment:HS,shadowmap_pars_fragment:WS,shadowmap_pars_vertex:XS,shadowmap_vertex:jS,shadowmask_pars_fragment:YS,skinbase_vertex:qS,skinning_pars_vertex:$S,skinning_vertex:ZS,skinnormal_vertex:KS,specularmap_fragment:JS,specularmap_pars_fragment:QS,tonemapping_fragment:eb,tonemapping_pars_fragment:tb,transmission_fragment:rb,transmission_pars_fragment:nb,uv_pars_fragment:ib,uv_pars_vertex:ab,uv_vertex:sb,uv2_pars_fragment:ob,uv2_pars_vertex:lb,uv2_vertex:cb,worldpos_vertex:ub,background_frag:fb,background_vert:hb,cube_frag:db,cube_vert:pb,depth_frag:mb,depth_vert:vb,distanceRGBA_frag:gb,distanceRGBA_vert:_b,equirect_frag:yb,equirect_vert:xb,linedashed_frag:Sb,linedashed_vert:bb,meshbasic_frag:wb,meshbasic_vert:Mb,meshlambert_frag:Eb,meshlambert_vert:Cb,meshmatcap_frag:Ab,meshmatcap_vert:Tb,meshtoon_frag:Rb,meshtoon_vert:Lb,meshphong_frag:Pb,meshphong_vert:Nb,meshphysical_frag:Ib,meshphysical_vert:kb,normal_frag:Ob,normal_vert:Db,points_frag:Fb,points_vert:Bb,shadow_frag:zb,shadow_vert:Vb,sprite_frag:Ub,sprite_vert:Gb},Ue={common:{diffuse:{value:new ze(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new zt},uv2Transform:{value:new zt},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new ve(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ze(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new ze(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new zt}},sprite:{diffuse:{value:new ze(16777215)},opacity:{value:1},center:{value:new ve(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new zt}}},_n={basic:{uniforms:tr([Ue.common,Ue.specularmap,Ue.envmap,Ue.aomap,Ue.lightmap,Ue.fog]),vertexShader:ct.meshbasic_vert,fragmentShader:ct.meshbasic_frag},lambert:{uniforms:tr([Ue.common,Ue.specularmap,Ue.envmap,Ue.aomap,Ue.lightmap,Ue.emissivemap,Ue.fog,Ue.lights,{emissive:{value:new ze(0)}}]),vertexShader:ct.meshlambert_vert,fragmentShader:ct.meshlambert_frag},phong:{uniforms:tr([Ue.common,Ue.specularmap,Ue.envmap,Ue.aomap,Ue.lightmap,Ue.emissivemap,Ue.bumpmap,Ue.normalmap,Ue.displacementmap,Ue.fog,Ue.lights,{emissive:{value:new ze(0)},specular:{value:new ze(1118481)},shininess:{value:30}}]),vertexShader:ct.meshphong_vert,fragmentShader:ct.meshphong_frag},standard:{uniforms:tr([Ue.common,Ue.envmap,Ue.aomap,Ue.lightmap,Ue.emissivemap,Ue.bumpmap,Ue.normalmap,Ue.displacementmap,Ue.roughnessmap,Ue.metalnessmap,Ue.fog,Ue.lights,{emissive:{value:new ze(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:ct.meshphysical_vert,fragmentShader:ct.meshphysical_frag},toon:{uniforms:tr([Ue.common,Ue.aomap,Ue.lightmap,Ue.emissivemap,Ue.bumpmap,Ue.normalmap,Ue.displacementmap,Ue.gradientmap,Ue.fog,Ue.lights,{emissive:{value:new ze(0)}}]),vertexShader:ct.meshtoon_vert,fragmentShader:ct.meshtoon_frag},matcap:{uniforms:tr([Ue.common,Ue.bumpmap,Ue.normalmap,Ue.displacementmap,Ue.fog,{matcap:{value:null}}]),vertexShader:ct.meshmatcap_vert,fragmentShader:ct.meshmatcap_frag},points:{uniforms:tr([Ue.points,Ue.fog]),vertexShader:ct.points_vert,fragmentShader:ct.points_frag},dashed:{uniforms:tr([Ue.common,Ue.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ct.linedashed_vert,fragmentShader:ct.linedashed_frag},depth:{uniforms:tr([Ue.common,Ue.displacementmap]),vertexShader:ct.depth_vert,fragmentShader:ct.depth_frag},normal:{uniforms:tr([Ue.common,Ue.bumpmap,Ue.normalmap,Ue.displacementmap,{opacity:{value:1}}]),vertexShader:ct.normal_vert,fragmentShader:ct.normal_frag},sprite:{uniforms:tr([Ue.sprite,Ue.fog]),vertexShader:ct.sprite_vert,fragmentShader:ct.sprite_frag},background:{uniforms:{uvTransform:{value:new zt},t2D:{value:null}},vertexShader:ct.background_vert,fragmentShader:ct.background_frag},cube:{uniforms:tr([Ue.envmap,{opacity:{value:1}}]),vertexShader:ct.cube_vert,fragmentShader:ct.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ct.equirect_vert,fragmentShader:ct.equirect_frag},distanceRGBA:{uniforms:tr([Ue.common,Ue.displacementmap,{referencePosition:{value:new b},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ct.distanceRGBA_vert,fragmentShader:ct.distanceRGBA_frag},shadow:{uniforms:tr([Ue.lights,Ue.fog,{color:{value:new ze(0)},opacity:{value:1}}]),vertexShader:ct.shadow_vert,fragmentShader:ct.shadow_frag}};_n.physical={uniforms:tr([_n.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new ve(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new ze(0)},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new ve},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationTint:{value:new ze(0)},specularIntensity:{value:0},specularIntensityMap:{value:null},specularTint:{value:new ze(1,1,1)},specularTintMap:{value:null}}]),vertexShader:ct.meshphysical_vert,fragmentShader:ct.meshphysical_frag};function Hb(a,e,t,n,r){const i=new ze(0);let s=0,o,l,c=null,u=0,f=null;function h(p,v){let _=!1,m=v.isScene===!0?v.background:null;m&&m.isTexture&&(m=e.get(m));const g=a.xr,y=g.getSession&&g.getSession();y&&y.environmentBlendMode==="additive"&&(m=null),m===null?d(i,s):m&&m.isColor&&(d(m,1),_=!0),(a.autoClear||_)&&a.clear(a.autoClearColor,a.autoClearDepth,a.autoClearStencil),m&&(m.isCubeTexture||m.mapping===bc)?(l===void 0&&(l=new ft(new So(1,1,1),new cn({name:"BackgroundCubeMaterial",uniforms:ts(_n.cube.uniforms),vertexShader:_n.cube.vertexShader,fragmentShader:_n.cube.fragmentShader,side:Ut,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),l.geometry.deleteAttribute("uv"),l.onBeforeRender=function(x,S,M){this.matrixWorld.copyPosition(M.matrixWorld)},Object.defineProperty(l.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(l)),l.material.uniforms.envMap.value=m,l.material.uniforms.flipEnvMap.value=m.isCubeTexture&&m.isRenderTargetTexture===!1?-1:1,(c!==m||u!==m.version||f!==a.toneMapping)&&(l.material.needsUpdate=!0,c=m,u=m.version,f=a.toneMapping),p.unshift(l,l.geometry,l.material,0,0,null)):m&&m.isTexture&&(o===void 0&&(o=new ft(new Ci(2,2),new cn({name:"BackgroundMaterial",uniforms:ts(_n.background.uniforms),vertexShader:_n.background.vertexShader,fragmentShader:_n.background.fragmentShader,side:ji,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),Object.defineProperty(o.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(o)),o.material.uniforms.t2D.value=m,m.matrixAutoUpdate===!0&&m.updateMatrix(),o.material.uniforms.uvTransform.value.copy(m.matrix),(c!==m||u!==m.version||f!==a.toneMapping)&&(o.material.needsUpdate=!0,c=m,u=m.version,f=a.toneMapping),p.unshift(o,o.geometry,o.material,0,0,null))}function d(p,v){t.buffers.color.setClear(p.r,p.g,p.b,v,r)}return{getClearColor:function(){return i},setClearColor:function(p,v=1){i.set(p),s=v,d(i,s)},getClearAlpha:function(){return s},setClearAlpha:function(p){s=p,d(i,s)},render:h}}function Wb(a,e,t,n){const r=a.getParameter(34921),i=n.isWebGL2?null:e.get("OES_vertex_array_object"),s=n.isWebGL2||i!==null,o={},l=v(null);let c=l;function u(z,C,T,A,F){let X=!1;if(s){const Y=p(A,T,C);c!==Y&&(c=Y,h(c.object)),X=_(A,F),X&&m(A,F)}else{const Y=C.wireframe===!0;(c.geometry!==A.id||c.program!==T.id||c.wireframe!==Y)&&(c.geometry=A.id,c.program=T.id,c.wireframe=Y,X=!0)}z.isInstancedMesh===!0&&(X=!0),F!==null&&t.update(F,34963),X&&(E(z,C,T,A),F!==null&&a.bindBuffer(34963,t.get(F).buffer))}function f(){return n.isWebGL2?a.createVertexArray():i.createVertexArrayOES()}function h(z){return n.isWebGL2?a.bindVertexArray(z):i.bindVertexArrayOES(z)}function d(z){return n.isWebGL2?a.deleteVertexArray(z):i.deleteVertexArrayOES(z)}function p(z,C,T){const A=T.wireframe===!0;let F=o[z.id];F===void 0&&(F={},o[z.id]=F);let X=F[C.id];X===void 0&&(X={},F[C.id]=X);let Y=X[A];return Y===void 0&&(Y=v(f()),X[A]=Y),Y}function v(z){const C=[],T=[],A=[];for(let F=0;F<r;F++)C[F]=0,T[F]=0,A[F]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:C,enabledAttributes:T,attributeDivisors:A,object:z,attributes:{},index:null}}function _(z,C){const T=c.attributes,A=z.attributes;let F=0;for(const X in A){const Y=T[X],ne=A[X];if(Y===void 0||Y.attribute!==ne||Y.data!==ne.data)return!0;F++}return c.attributesNum!==F||c.index!==C}function m(z,C){const T={},A=z.attributes;let F=0;for(const X in A){const Y=A[X],ne={};ne.attribute=Y,Y.data&&(ne.data=Y.data),T[X]=ne,F++}c.attributes=T,c.attributesNum=F,c.index=C}function g(){const z=c.newAttributes;for(let C=0,T=z.length;C<T;C++)z[C]=0}function y(z){x(z,0)}function x(z,C){const T=c.newAttributes,A=c.enabledAttributes,F=c.attributeDivisors;T[z]=1,A[z]===0&&(a.enableVertexAttribArray(z),A[z]=1),F[z]!==C&&((n.isWebGL2?a:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](z,C),F[z]=C)}function S(){const z=c.newAttributes,C=c.enabledAttributes;for(let T=0,A=C.length;T<A;T++)C[T]!==z[T]&&(a.disableVertexAttribArray(T),C[T]=0)}function M(z,C,T,A,F,X){n.isWebGL2===!0&&(T===5124||T===5125)?a.vertexAttribIPointer(z,C,T,F,X):a.vertexAttribPointer(z,C,T,A,F,X)}function E(z,C,T,A){if(n.isWebGL2===!1&&(z.isInstancedMesh||A.isInstancedBufferGeometry)&&e.get("ANGLE_instanced_arrays")===null)return;g();const F=A.attributes,X=T.getAttributes(),Y=C.defaultAttributeValues;for(const ne in X){const ae=X[ne];if(ae>=0){const xe=F[ne];if(xe!==void 0){const be=xe.normalized,ge=xe.itemSize,we=t.get(xe);if(we===void 0)continue;const q=we.buffer,Ge=we.type,Te=we.bytesPerElement;if(xe.isInterleavedBufferAttribute){const Pe=xe.data,Ee=Pe.stride,_e=xe.offset;Pe&&Pe.isInstancedInterleavedBuffer?(x(ae,Pe.meshPerAttribute),A._maxInstanceCount===void 0&&(A._maxInstanceCount=Pe.meshPerAttribute*Pe.count)):y(ae),a.bindBuffer(34962,q),M(ae,ge,Ge,be,Ee*Te,_e*Te)}else xe.isInstancedBufferAttribute?(x(ae,xe.meshPerAttribute),A._maxInstanceCount===void 0&&(A._maxInstanceCount=xe.meshPerAttribute*xe.count)):y(ae),a.bindBuffer(34962,q),M(ae,ge,Ge,be,0,0)}else if(ne==="instanceMatrix"){const be=t.get(z.instanceMatrix);if(be===void 0)continue;const ge=be.buffer,we=be.type;x(ae+0,1),x(ae+1,1),x(ae+2,1),x(ae+3,1),a.bindBuffer(34962,ge),a.vertexAttribPointer(ae+0,4,we,!1,64,0),a.vertexAttribPointer(ae+1,4,we,!1,64,16),a.vertexAttribPointer(ae+2,4,we,!1,64,32),a.vertexAttribPointer(ae+3,4,we,!1,64,48)}else if(ne==="instanceColor"){const be=t.get(z.instanceColor);if(be===void 0)continue;const ge=be.buffer,we=be.type;x(ae,1),a.bindBuffer(34962,ge),a.vertexAttribPointer(ae,3,we,!1,12,0)}else if(Y!==void 0){const be=Y[ne];if(be!==void 0)switch(be.length){case 2:a.vertexAttrib2fv(ae,be);break;case 3:a.vertexAttrib3fv(ae,be);break;case 4:a.vertexAttrib4fv(ae,be);break;default:a.vertexAttrib1fv(ae,be)}}}}S()}function N(){O();for(const z in o){const C=o[z];for(const T in C){const A=C[T];for(const F in A)d(A[F].object),delete A[F];delete C[T]}delete o[z]}}function B(z){if(o[z.id]===void 0)return;const C=o[z.id];for(const T in C){const A=C[T];for(const F in A)d(A[F].object),delete A[F];delete C[T]}delete o[z.id]}function V(z){for(const C in o){const T=o[C];if(T[z.id]===void 0)continue;const A=T[z.id];for(const F in A)d(A[F].object),delete A[F];delete T[z.id]}}function O(){W(),c!==l&&(c=l,h(c.object))}function W(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:u,reset:O,resetDefaultState:W,dispose:N,releaseStatesOfGeometry:B,releaseStatesOfProgram:V,initAttributes:g,enableAttribute:y,disableUnusedAttributes:S}}function Xb(a,e,t,n){const r=n.isWebGL2;let i;function s(c){i=c}function o(c,u){a.drawArrays(i,c,u),t.update(u,i,1)}function l(c,u,f){if(f===0)return;let h,d;if(r)h=a,d="drawArraysInstanced";else if(h=e.get("ANGLE_instanced_arrays"),d="drawArraysInstancedANGLE",h===null){console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}h[d](i,c,u,f),t.update(u,i,f)}this.setMode=s,this.render=o,this.renderInstances=l}function jb(a,e,t){let n;function r(){if(n!==void 0)return n;if(e.has("EXT_texture_filter_anisotropic")===!0){const E=e.get("EXT_texture_filter_anisotropic");n=a.getParameter(E.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n}function i(E){if(E==="highp"){if(a.getShaderPrecisionFormat(35633,36338).precision>0&&a.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";E="mediump"}return E==="mediump"&&a.getShaderPrecisionFormat(35633,36337).precision>0&&a.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const s=typeof WebGL2RenderingContext<"u"&&a instanceof WebGL2RenderingContext||typeof WebGL2ComputeRenderingContext<"u"&&a instanceof WebGL2ComputeRenderingContext;let o=t.precision!==void 0?t.precision:"highp";const l=i(o);l!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",l,"instead."),o=l);const c=s||e.has("WEBGL_draw_buffers"),u=t.logarithmicDepthBuffer===!0,f=a.getParameter(34930),h=a.getParameter(35660),d=a.getParameter(3379),p=a.getParameter(34076),v=a.getParameter(34921),_=a.getParameter(36347),m=a.getParameter(36348),g=a.getParameter(36349),y=h>0,x=s||e.has("OES_texture_float"),S=y&&x,M=s?a.getParameter(36183):0;return{isWebGL2:s,drawBuffers:c,getMaxAnisotropy:r,getMaxPrecision:i,precision:o,logarithmicDepthBuffer:u,maxTextures:f,maxVertexTextures:h,maxTextureSize:d,maxCubemapSize:p,maxAttributes:v,maxVertexUniforms:_,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:y,floatFragmentTextures:x,floatVertexTextures:S,maxSamples:M}}function Yb(a){const e=this;let t=null,n=0,r=!1,i=!1;const s=new an,o=new zt,l={value:null,needsUpdate:!1};this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(f,h,d){const p=f.length!==0||h||n!==0||r;return r=h,t=u(f,d,0),n=f.length,p},this.beginShadows=function(){i=!0,u(null)},this.endShadows=function(){i=!1,c()},this.setState=function(f,h,d){const p=f.clippingPlanes,v=f.clipIntersection,_=f.clipShadows,m=a.get(f);if(!r||p===null||p.length===0||i&&!_)i?u(null):c();else{const g=i?0:n,y=g*4;let x=m.clippingState||null;l.value=x,x=u(p,h,y,d);for(let S=0;S!==y;++S)x[S]=t[S];m.clippingState=x,this.numIntersection=v?this.numPlanes:0,this.numPlanes+=g}};function c(){l.value!==t&&(l.value=t,l.needsUpdate=n>0),e.numPlanes=n,e.numIntersection=0}function u(f,h,d,p){const v=f!==null?f.length:0;let _=null;if(v!==0){if(_=l.value,p!==!0||_===null){const m=d+v*4,g=h.matrixWorldInverse;o.getNormalMatrix(g),(_===null||_.length<m)&&(_=new Float32Array(m));for(let y=0,x=d;y!==v;++y,x+=4)s.copy(f[y]).applyMatrix4(g,o),s.normal.toArray(_,x),_[x+3]=s.constant}l.value=_,l.needsUpdate=!0}return e.numPlanes=v,e.numIntersection=0,_}}function qb(a){let e=new WeakMap;function t(s,o){return o===Sf?s.mapping=xc:o===bf&&(s.mapping=Sc),s}function n(s){if(s&&s.isTexture&&s.isRenderTargetTexture===!1){const o=s.mapping;if(o===Sf||o===bf)if(e.has(s)){const l=e.get(s).texture;return t(l,s.mapping)}else{const l=s.image;if(l&&l.height>0){const c=a.getRenderTarget(),u=new Kv(l.height/2);return u.fromEquirectangularTexture(a,s),e.set(s,u),a.setRenderTarget(c),s.addEventListener("dispose",r),t(u.texture,s.mapping)}else return null}}return s}function r(s){const o=s.target;o.removeEventListener("dispose",r);const l=e.get(o);l!==void 0&&(e.delete(o),l.dispose())}function i(){e=new WeakMap}return{get:n,dispose:i}}class ls extends oh{constructor(e=-1,t=1,n=1,r=-1,i=.1,s=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=r,this.near=i,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,t,n,r,i,s){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=r,this.view.width=i,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let i=n-e,s=n+e,o=r+t,l=r-t;if(this.view!==null&&this.view.enabled){const c=(this.right-this.left)/this.view.fullWidth/this.zoom,u=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=c*this.view.offsetX,s=i+c*this.view.width,o-=u*this.view.offsetY,l=o-u*this.view.height}this.projectionMatrix.makeOrthographic(i,s,o,l,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,this.view!==null&&(t.object.view=Object.assign({},this.view)),t}}ls.prototype.isOrthographicCamera=!0;class Ur extends cn{constructor(e){super(e),this.type="RawShaderMaterial"}}Ur.prototype.isRawShaderMaterial=!0;const qa=4,hi=8,vn=Math.pow(2,hi),Qv=[.125,.215,.35,.446,.526,.582],eg=hi-qa+1+Qv.length,xa=20,xn={[Cr]:0,[Mc]:1,[nh]:2,[Hv]:3,[Wv]:4,[Xv]:5,[rh]:6},Bi=new Ec({side:Ut,depthWrite:!1,depthTest:!1}),$b=new ft(new So,Bi),Su=new ls,{_lodPlanes:Ts,_sizeLods:ip,_sigmas:fl}=Jb(),ap=new ze;let bu=null;const zi=(1+Math.sqrt(5))/2,Sa=1/zi,sp=[new b(1,1,1),new b(-1,1,1),new b(1,1,-1),new b(-1,1,-1),new b(0,zi,Sa),new b(0,zi,-Sa),new b(Sa,0,zi),new b(-Sa,0,zi),new b(zi,Sa,0),new b(-zi,Sa,0)];function op(a){const e=Math.max(a.r,a.g,a.b),t=Math.min(Math.max(Math.ceil(Math.log2(e)),-128),127);return a.multiplyScalar(Math.pow(2,-t)),(t+128)/255}class Zb{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._blurMaterial=Qb(xa),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,r=100){bu=this._renderer.getRenderTarget();const i=this._allocateTargets();return this._sceneToCubeUV(e,n,r,i),t>0&&this._blur(i,0,0,t),this._applyPMREM(i),this._cleanup(i),i}fromEquirectangular(e){return this._fromTexture(e)}fromCubemap(e){return this._fromTexture(e)}compileCubemapShader(){this._cubemapShader===null&&(this._cubemapShader=up(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){this._equirectShader===null&&(this._equirectShader=cp(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),this._cubemapShader!==null&&this._cubemapShader.dispose(),this._equirectShader!==null&&this._equirectShader.dispose();for(let e=0;e<Ts.length;e++)Ts[e].dispose()}_cleanup(e){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(bu),e.scissorTest=!1,hl(e,0,0,e.width,e.height)}_fromTexture(e){bu=this._renderer.getRenderTarget();const t=this._allocateTargets(e);return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(e){const t={magFilter:It,minFilter:It,generateMipmaps:!1,type:xi,format:Jy,encoding:Kb(e)?e.encoding:nh,depthBuffer:!1},n=lp(t);return n.depthBuffer=!e,this._pingPongRenderTarget=lp(t),n}_compileMaterial(e){const t=new ft(Ts[0],e);this._renderer.compile(t,Su)}_sceneToCubeUV(e,t,n,r){const o=new Bt(90,1,t,n),l=[1,-1,1,1,1,1],c=[1,1,1,-1,-1,-1],u=this._renderer,f=u.autoClear,h=u.outputEncoding,d=u.toneMapping;u.getClearColor(ap),u.toneMapping=Hi,u.outputEncoding=Cr,u.autoClear=!1;let p=!1;const v=e.background;if(v){if(v.isColor){Bi.color.copy(v).convertSRGBToLinear(),e.background=null;const _=op(Bi.color);Bi.opacity=_,p=!0}}else{Bi.color.copy(ap).convertSRGBToLinear();const _=op(Bi.color);Bi.opacity=_,p=!0}for(let _=0;_<6;_++){const m=_%3;m==0?(o.up.set(0,l[_],0),o.lookAt(c[_],0,0)):m==1?(o.up.set(0,0,l[_]),o.lookAt(0,c[_],0)):(o.up.set(0,l[_],0),o.lookAt(0,0,c[_])),hl(r,m*vn,_>2?vn:0,vn,vn),u.setRenderTarget(r),p&&u.render($b,o),u.render(e,o)}u.toneMapping=d,u.outputEncoding=h,u.autoClear=f}_textureToCubeUV(e,t){const n=this._renderer;e.isCubeTexture?this._cubemapShader==null&&(this._cubemapShader=up()):this._equirectShader==null&&(this._equirectShader=cp());const r=e.isCubeTexture?this._cubemapShader:this._equirectShader,i=new ft(Ts[0],r),s=r.uniforms;s.envMap.value=e,e.isCubeTexture||s.texelSize.value.set(1/e.image.width,1/e.image.height),s.inputEncoding.value=xn[e.encoding],s.outputEncoding.value=xn[t.texture.encoding],hl(t,0,0,3*vn,2*vn),n.setRenderTarget(t),n.render(i,Su)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;for(let r=1;r<eg;r++){const i=Math.sqrt(fl[r]*fl[r]-fl[r-1]*fl[r-1]),s=sp[(r-1)%sp.length];this._blur(e,r-1,r,i,s)}t.autoClear=n}_blur(e,t,n,r,i){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,r,"latitudinal",i),this._halfBlur(s,e,n,n,r,"longitudinal",i)}_halfBlur(e,t,n,r,i,s,o){const l=this._renderer,c=this._blurMaterial;s!=="latitudinal"&&s!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const u=3,f=new ft(Ts[r],c),h=c.uniforms,d=ip[n]-1,p=isFinite(i)?Math.PI/(2*d):2*Math.PI/(2*xa-1),v=i/p,_=isFinite(i)?1+Math.floor(u*v):xa;_>xa&&console.warn(`sigmaRadians, ${i}, is too large and will clip, as it requested ${_} samples when the maximum is set to ${xa}`);const m=[];let g=0;for(let M=0;M<xa;++M){const E=M/v,N=Math.exp(-E*E/2);m.push(N),M==0?g+=N:M<_&&(g+=2*N)}for(let M=0;M<m.length;M++)m[M]=m[M]/g;h.envMap.value=e.texture,h.samples.value=_,h.weights.value=m,h.latitudinal.value=s==="latitudinal",o&&(h.poleAxis.value=o),h.dTheta.value=p,h.mipInt.value=hi-n,h.inputEncoding.value=xn[e.texture.encoding],h.outputEncoding.value=xn[e.texture.encoding];const y=ip[r],x=3*Math.max(0,vn-2*y),S=(r===0?0:2*vn)+2*y*(r>hi-qa?r-hi+qa:0);hl(t,x,S,3*y,2*y),l.setRenderTarget(t),l.render(f,Su)}}function Kb(a){return a===void 0||a.type!==xi?!1:a.encoding===Cr||a.encoding===Mc||a.encoding===rh}function Jb(){const a=[],e=[],t=[];let n=hi;for(let r=0;r<eg;r++){const i=Math.pow(2,n);e.push(i);let s=1/i;r>hi-qa?s=Qv[r-hi+qa-1]:r==0&&(s=0),t.push(s);const o=1/(i-1),l=-o/2,c=1+o/2,u=[l,l,c,l,c,c,l,l,c,c,l,c],f=6,h=6,d=3,p=2,v=1,_=new Float32Array(d*h*f),m=new Float32Array(p*h*f),g=new Float32Array(v*h*f);for(let x=0;x<f;x++){const S=x%3*2/3-1,M=x>2?0:-1,E=[S,M,0,S+2/3,M,0,S+2/3,M+1,0,S,M,0,S+2/3,M+1,0,S,M+1,0];_.set(E,d*h*x),m.set(u,p*h*x);const N=[x,x,x,x,x,x];g.set(N,v*h*x)}const y=new at;y.setAttribute("position",new Ze(_,d)),y.setAttribute("uv",new Ze(m,p)),y.setAttribute("faceIndex",new Ze(g,v)),a.push(y),n>qa&&n--}return{_lodPlanes:a,_sizeLods:e,_sigmas:t}}function lp(a){const e=new Gt(3*vn,3*vn,a);return e.texture.mapping=bc,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function hl(a,e,t,n,r){a.viewport.set(e,t,n,r),a.scissor.set(e,t,n,r)}function Qb(a){const e=new Float32Array(a),t=new b(0,1,0);return new Ur({name:"SphericalGaussianBlur",defines:{n:a},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:t},inputEncoding:{value:xn[Cr]},outputEncoding:{value:xn[Cr]}},vertexShader:ch(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			${uh()}

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:zn,depthTest:!1,depthWrite:!1})}function cp(){const a=new ve(1,1);return new Ur({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:a},inputEncoding:{value:xn[Cr]},outputEncoding:{value:xn[Cr]}},vertexShader:ch(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform vec2 texelSize;

			${uh()}

			#include <common>

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				vec2 f = fract( uv / texelSize - 0.5 );
				uv -= f * texelSize;
				vec3 tl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x += texelSize.x;
				vec3 tr = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.y += texelSize.y;
				vec3 br = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;
				uv.x -= texelSize.x;
				vec3 bl = envMapTexelToLinear( texture2D ( envMap, uv ) ).rgb;

				vec3 tm = mix( tl, tr, f.x );
				vec3 bm = mix( bl, br, f.x );
				gl_FragColor.rgb = mix( tm, bm, f.y );

				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:zn,depthTest:!1,depthWrite:!1})}function up(){return new Ur({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:xn[Cr]},outputEncoding:{value:xn[Cr]}},vertexShader:ch(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			${uh()}

			void main() {

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb = envMapTexelToLinear( textureCube( envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ) ) ).rgb;
				gl_FragColor = linearToOutputTexel( gl_FragColor );

			}
		`,blending:zn,depthTest:!1,depthWrite:!1})}function ch(){return`

		precision mediump float;
		precision mediump int;

		attribute vec3 position;
		attribute vec2 uv;
		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function uh(){return`

		uniform int inputEncoding;
		uniform int outputEncoding;

		#include <encodings_pars_fragment>

		vec4 inputTexelToLinear( vec4 value ) {

			if ( inputEncoding == 0 ) {

				return value;

			} else if ( inputEncoding == 1 ) {

				return sRGBToLinear( value );

			} else if ( inputEncoding == 2 ) {

				return RGBEToLinear( value );

			} else if ( inputEncoding == 3 ) {

				return RGBMToLinear( value, 7.0 );

			} else if ( inputEncoding == 4 ) {

				return RGBMToLinear( value, 16.0 );

			} else if ( inputEncoding == 5 ) {

				return RGBDToLinear( value, 256.0 );

			} else {

				return GammaToLinear( value, 2.2 );

			}

		}

		vec4 linearToOutputTexel( vec4 value ) {

			if ( outputEncoding == 0 ) {

				return value;

			} else if ( outputEncoding == 1 ) {

				return LinearTosRGB( value );

			} else if ( outputEncoding == 2 ) {

				return LinearToRGBE( value );

			} else if ( outputEncoding == 3 ) {

				return LinearToRGBM( value, 7.0 );

			} else if ( outputEncoding == 4 ) {

				return LinearToRGBM( value, 16.0 );

			} else if ( outputEncoding == 5 ) {

				return LinearToRGBD( value, 256.0 );

			} else {

				return LinearToGamma( value, 2.2 );

			}

		}

		vec4 envMapTexelToLinear( vec4 color ) {

			return inputTexelToLinear( color );

		}
	`}function ew(a){let e=new WeakMap,t=null;function n(o){if(o&&o.isTexture&&o.isRenderTargetTexture===!1){const l=o.mapping,c=l===Sf||l===bf,u=l===xc||l===Sc;if(c||u){if(e.has(o))return e.get(o).texture;{const f=o.image;if(c&&f&&f.height>0||u&&f&&r(f)){const h=a.getRenderTarget();t===null&&(t=new Zb(a));const d=c?t.fromEquirectangular(o):t.fromCubemap(o);return e.set(o,d),a.setRenderTarget(h),o.addEventListener("dispose",i),d.texture}else return null}}}return o}function r(o){let l=0;const c=6;for(let u=0;u<c;u++)o[u]!==void 0&&l++;return l===c}function i(o){const l=o.target;l.removeEventListener("dispose",i);const c=e.get(l);c!==void 0&&(c.delete(l),c.dispose())}function s(){e=new WeakMap,t!==null&&(t.dispose(),t=null)}return{get:n,dispose:s}}function tw(a){const e={};function t(n){if(e[n]!==void 0)return e[n];let r;switch(n){case"WEBGL_depth_texture":r=a.getExtension("WEBGL_depth_texture")||a.getExtension("MOZ_WEBGL_depth_texture")||a.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=a.getExtension("WEBGL_compressed_texture_s3tc")||a.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=a.getExtension("WEBGL_compressed_texture_pvrtc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=a.getExtension(n)}return e[n]=r,r}return{has:function(n){return t(n)!==null},init:function(n){n.isWebGL2?t("EXT_color_buffer_float"):(t("WEBGL_depth_texture"),t("OES_texture_float"),t("OES_texture_half_float"),t("OES_texture_half_float_linear"),t("OES_standard_derivatives"),t("OES_element_index_uint"),t("OES_vertex_array_object"),t("ANGLE_instanced_arrays")),t("OES_texture_float_linear"),t("EXT_color_buffer_half_float")},get:function(n){const r=t(n);return r===null&&console.warn("THREE.WebGLRenderer: "+n+" extension not supported."),r}}}function rw(a,e,t,n){const r={},i=new WeakMap;function s(f){const h=f.target;h.index!==null&&e.remove(h.index);for(const p in h.attributes)e.remove(h.attributes[p]);h.removeEventListener("dispose",s),delete r[h.id];const d=i.get(h);d&&(e.remove(d),i.delete(h)),n.releaseStatesOfGeometry(h),h.isInstancedBufferGeometry===!0&&delete h._maxInstanceCount,t.memory.geometries--}function o(f,h){return r[h.id]===!0||(h.addEventListener("dispose",s),r[h.id]=!0,t.memory.geometries++),h}function l(f){const h=f.attributes;for(const p in h)e.update(h[p],34962);const d=f.morphAttributes;for(const p in d){const v=d[p];for(let _=0,m=v.length;_<m;_++)e.update(v[_],34962)}}function c(f){const h=[],d=f.index,p=f.attributes.position;let v=0;if(d!==null){const g=d.array;v=d.version;for(let y=0,x=g.length;y<x;y+=3){const S=g[y+0],M=g[y+1],E=g[y+2];h.push(S,M,M,E,E,S)}}else{const g=p.array;v=p.version;for(let y=0,x=g.length/3-1;y<x;y+=3){const S=y+0,M=y+1,E=y+2;h.push(S,M,M,E,E,S)}}const _=new(Zv(h)>65535?$v:sh)(h,1);_.version=v;const m=i.get(f);m&&e.remove(m),i.set(f,_)}function u(f){const h=i.get(f);if(h){const d=f.index;d!==null&&h.version<d.version&&c(f)}else c(f);return i.get(f)}return{get:o,update:l,getWireframeAttribute:u}}function nw(a,e,t,n){const r=n.isWebGL2;let i;function s(h){i=h}let o,l;function c(h){o=h.type,l=h.bytesPerElement}function u(h,d){a.drawElements(i,d,o,h*l),t.update(d,i,1)}function f(h,d,p){if(p===0)return;let v,_;if(r)v=a,_="drawElementsInstanced";else if(v=e.get("ANGLE_instanced_arrays"),_="drawElementsInstancedANGLE",v===null){console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}v[_](i,d,o,h*l,p),t.update(d,i,p)}this.setMode=s,this.setIndex=c,this.render=u,this.renderInstances=f}function iw(a){const e={geometries:0,textures:0},t={frame:0,calls:0,triangles:0,points:0,lines:0};function n(i,s,o){switch(t.calls++,s){case 4:t.triangles+=o*(i/3);break;case 1:t.lines+=o*(i/2);break;case 3:t.lines+=o*(i-1);break;case 2:t.lines+=o*i;break;case 0:t.points+=o*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",s);break}}function r(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0}return{memory:e,render:t,programs:null,autoReset:!0,reset:r,update:n}}function aw(a,e){return a[0]-e[0]}function sw(a,e){return Math.abs(e[1])-Math.abs(a[1])}function ow(a){const e={},t=new Float32Array(8),n=[];for(let i=0;i<8;i++)n[i]=[i,0];function r(i,s,o,l){const c=i.morphTargetInfluences,u=c===void 0?0:c.length;let f=e[s.id];if(f===void 0||f.length!==u){f=[];for(let _=0;_<u;_++)f[_]=[_,0];e[s.id]=f}for(let _=0;_<u;_++){const m=f[_];m[0]=_,m[1]=c[_]}f.sort(sw);for(let _=0;_<8;_++)_<u&&f[_][1]?(n[_][0]=f[_][0],n[_][1]=f[_][1]):(n[_][0]=Number.MAX_SAFE_INTEGER,n[_][1]=0);n.sort(aw);const h=s.morphAttributes.position,d=s.morphAttributes.normal;let p=0;for(let _=0;_<8;_++){const m=n[_],g=m[0],y=m[1];g!==Number.MAX_SAFE_INTEGER&&y?(h&&s.getAttribute("morphTarget"+_)!==h[g]&&s.setAttribute("morphTarget"+_,h[g]),d&&s.getAttribute("morphNormal"+_)!==d[g]&&s.setAttribute("morphNormal"+_,d[g]),t[_]=y,p+=y):(h&&s.hasAttribute("morphTarget"+_)===!0&&s.deleteAttribute("morphTarget"+_),d&&s.hasAttribute("morphNormal"+_)===!0&&s.deleteAttribute("morphNormal"+_),t[_]=0)}const v=s.morphTargetsRelative?1:1-p;l.getUniforms().setValue(a,"morphTargetBaseInfluence",v),l.getUniforms().setValue(a,"morphTargetInfluences",t)}return{update:r}}function lw(a,e,t,n){let r=new WeakMap;function i(l){const c=n.render.frame,u=l.geometry,f=e.get(l,u);return r.get(f)!==c&&(e.update(f),r.set(f,c)),l.isInstancedMesh&&(l.hasEventListener("dispose",o)===!1&&l.addEventListener("dispose",o),t.update(l.instanceMatrix,34962),l.instanceColor!==null&&t.update(l.instanceColor,34962)),f}function s(){r=new WeakMap}function o(l){const c=l.target;c.removeEventListener("dispose",o),t.remove(c.instanceMatrix),c.instanceColor!==null&&t.remove(c.instanceColor)}return{update:i,dispose:s}}class tg extends Qt{constructor(e=null,t=1,n=1,r=1){super(null),this.image={data:e,width:t,height:n,depth:r},this.magFilter=It,this.minFilter=It,this.wrapR=dr,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}tg.prototype.isDataTexture2DArray=!0;class rg extends Qt{constructor(e=null,t=1,n=1,r=1){super(null),this.image={data:e,width:t,height:n,depth:r},this.magFilter=It,this.minFilter=It,this.wrapR=dr,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}rg.prototype.isDataTexture3D=!0;const ng=new Qt,cw=new tg,uw=new rg,ig=new Cc,fp=[],hp=[],dp=new Float32Array(16),pp=new Float32Array(9),mp=new Float32Array(4);function cs(a,e,t){const n=a[0];if(n<=0||n>0)return a;const r=e*t;let i=fp[r];if(i===void 0&&(i=new Float32Array(r),fp[r]=i),e!==0){n.toArray(i,0);for(let s=1,o=0;s!==e;++s)o+=t,a[s].toArray(i,o)}return i}function pr(a,e){if(a.length!==e.length)return!1;for(let t=0,n=a.length;t<n;t++)if(a[t]!==e[t])return!1;return!0}function ir(a,e){for(let t=0,n=e.length;t<n;t++)a[t]=e[t]}function ag(a,e){let t=hp[e];t===void 0&&(t=new Int32Array(e),hp[e]=t);for(let n=0;n!==e;++n)t[n]=a.allocateTextureUnit();return t}function fw(a,e){const t=this.cache;t[0]!==e&&(a.uniform1f(this.addr,e),t[0]=e)}function hw(a,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(a.uniform2f(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(pr(t,e))return;a.uniform2fv(this.addr,e),ir(t,e)}}function dw(a,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(a.uniform3f(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else if(e.r!==void 0)(t[0]!==e.r||t[1]!==e.g||t[2]!==e.b)&&(a.uniform3f(this.addr,e.r,e.g,e.b),t[0]=e.r,t[1]=e.g,t[2]=e.b);else{if(pr(t,e))return;a.uniform3fv(this.addr,e),ir(t,e)}}function pw(a,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(a.uniform4f(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(pr(t,e))return;a.uniform4fv(this.addr,e),ir(t,e)}}function mw(a,e){const t=this.cache,n=e.elements;if(n===void 0){if(pr(t,e))return;a.uniformMatrix2fv(this.addr,!1,e),ir(t,e)}else{if(pr(t,n))return;mp.set(n),a.uniformMatrix2fv(this.addr,!1,mp),ir(t,n)}}function vw(a,e){const t=this.cache,n=e.elements;if(n===void 0){if(pr(t,e))return;a.uniformMatrix3fv(this.addr,!1,e),ir(t,e)}else{if(pr(t,n))return;pp.set(n),a.uniformMatrix3fv(this.addr,!1,pp),ir(t,n)}}function gw(a,e){const t=this.cache,n=e.elements;if(n===void 0){if(pr(t,e))return;a.uniformMatrix4fv(this.addr,!1,e),ir(t,e)}else{if(pr(t,n))return;dp.set(n),a.uniformMatrix4fv(this.addr,!1,dp),ir(t,n)}}function _w(a,e){const t=this.cache;t[0]!==e&&(a.uniform1i(this.addr,e),t[0]=e)}function yw(a,e){const t=this.cache;pr(t,e)||(a.uniform2iv(this.addr,e),ir(t,e))}function xw(a,e){const t=this.cache;pr(t,e)||(a.uniform3iv(this.addr,e),ir(t,e))}function Sw(a,e){const t=this.cache;pr(t,e)||(a.uniform4iv(this.addr,e),ir(t,e))}function bw(a,e){const t=this.cache;t[0]!==e&&(a.uniform1ui(this.addr,e),t[0]=e)}function ww(a,e){const t=this.cache;pr(t,e)||(a.uniform2uiv(this.addr,e),ir(t,e))}function Mw(a,e){const t=this.cache;pr(t,e)||(a.uniform3uiv(this.addr,e),ir(t,e))}function Ew(a,e){const t=this.cache;pr(t,e)||(a.uniform4uiv(this.addr,e),ir(t,e))}function Cw(a,e,t){const n=this.cache,r=t.allocateTextureUnit();n[0]!==r&&(a.uniform1i(this.addr,r),n[0]=r),t.safeSetTexture2D(e||ng,r)}function Aw(a,e,t){const n=this.cache,r=t.allocateTextureUnit();n[0]!==r&&(a.uniform1i(this.addr,r),n[0]=r),t.setTexture3D(e||uw,r)}function Tw(a,e,t){const n=this.cache,r=t.allocateTextureUnit();n[0]!==r&&(a.uniform1i(this.addr,r),n[0]=r),t.safeSetTextureCube(e||ig,r)}function Rw(a,e,t){const n=this.cache,r=t.allocateTextureUnit();n[0]!==r&&(a.uniform1i(this.addr,r),n[0]=r),t.setTexture2DArray(e||cw,r)}function Lw(a){switch(a){case 5126:return fw;case 35664:return hw;case 35665:return dw;case 35666:return pw;case 35674:return mw;case 35675:return vw;case 35676:return gw;case 5124:case 35670:return _w;case 35667:case 35671:return yw;case 35668:case 35672:return xw;case 35669:case 35673:return Sw;case 5125:return bw;case 36294:return ww;case 36295:return Mw;case 36296:return Ew;case 35678:case 36198:case 36298:case 36306:case 35682:return Cw;case 35679:case 36299:case 36307:return Aw;case 35680:case 36300:case 36308:case 36293:return Tw;case 36289:case 36303:case 36311:case 36292:return Rw}}function Pw(a,e){a.uniform1fv(this.addr,e)}function Nw(a,e){const t=cs(e,this.size,2);a.uniform2fv(this.addr,t)}function Iw(a,e){const t=cs(e,this.size,3);a.uniform3fv(this.addr,t)}function kw(a,e){const t=cs(e,this.size,4);a.uniform4fv(this.addr,t)}function Ow(a,e){const t=cs(e,this.size,4);a.uniformMatrix2fv(this.addr,!1,t)}function Dw(a,e){const t=cs(e,this.size,9);a.uniformMatrix3fv(this.addr,!1,t)}function Fw(a,e){const t=cs(e,this.size,16);a.uniformMatrix4fv(this.addr,!1,t)}function Bw(a,e){a.uniform1iv(this.addr,e)}function zw(a,e){a.uniform2iv(this.addr,e)}function Vw(a,e){a.uniform3iv(this.addr,e)}function Uw(a,e){a.uniform4iv(this.addr,e)}function Gw(a,e){a.uniform1uiv(this.addr,e)}function Hw(a,e){a.uniform2uiv(this.addr,e)}function Ww(a,e){a.uniform3uiv(this.addr,e)}function Xw(a,e){a.uniform4uiv(this.addr,e)}function jw(a,e,t){const n=e.length,r=ag(t,n);a.uniform1iv(this.addr,r);for(let i=0;i!==n;++i)t.safeSetTexture2D(e[i]||ng,r[i])}function Yw(a,e,t){const n=e.length,r=ag(t,n);a.uniform1iv(this.addr,r);for(let i=0;i!==n;++i)t.safeSetTextureCube(e[i]||ig,r[i])}function qw(a){switch(a){case 5126:return Pw;case 35664:return Nw;case 35665:return Iw;case 35666:return kw;case 35674:return Ow;case 35675:return Dw;case 35676:return Fw;case 5124:case 35670:return Bw;case 35667:case 35671:return zw;case 35668:case 35672:return Vw;case 35669:case 35673:return Uw;case 5125:return Gw;case 36294:return Hw;case 36295:return Ww;case 36296:return Xw;case 35678:case 36198:case 36298:case 36306:case 35682:return jw;case 35680:case 36300:case 36308:case 36293:return Yw}}function $w(a,e,t){this.id=a,this.addr=t,this.cache=[],this.setValue=Lw(e.type)}function sg(a,e,t){this.id=a,this.addr=t,this.cache=[],this.size=e.size,this.setValue=qw(e.type)}sg.prototype.updateCache=function(a){const e=this.cache;a instanceof Float32Array&&e.length!==a.length&&(this.cache=new Float32Array(a.length)),ir(e,a)};function og(a){this.id=a,this.seq=[],this.map={}}og.prototype.setValue=function(a,e,t){const n=this.seq;for(let r=0,i=n.length;r!==i;++r){const s=n[r];s.setValue(a,e[s.id],t)}};const wu=/(\w+)(\])?(\[|\.)?/g;function vp(a,e){a.seq.push(e),a.map[e.id]=e}function Zw(a,e,t){const n=a.name,r=n.length;for(wu.lastIndex=0;;){const i=wu.exec(n),s=wu.lastIndex;let o=i[1];const l=i[2]==="]",c=i[3];if(l&&(o=o|0),c===void 0||c==="["&&s+2===r){vp(t,c===void 0?new $w(o,a,e):new sg(o,a,e));break}else{let f=t.map[o];f===void 0&&(f=new og(o),vp(t,f)),t=f}}}function di(a,e){this.seq=[],this.map={};const t=a.getProgramParameter(e,35718);for(let n=0;n<t;++n){const r=a.getActiveUniform(e,n),i=a.getUniformLocation(e,r.name);Zw(r,i,this)}}di.prototype.setValue=function(a,e,t,n){const r=this.map[e];r!==void 0&&r.setValue(a,t,n)};di.prototype.setOptional=function(a,e,t){const n=e[t];n!==void 0&&this.setValue(a,t,n)};di.upload=function(a,e,t,n){for(let r=0,i=e.length;r!==i;++r){const s=e[r],o=t[s.id];o.needsUpdate!==!1&&s.setValue(a,o.value,n)}};di.seqWithValue=function(a,e){const t=[];for(let n=0,r=a.length;n!==r;++n){const i=a[n];i.id in e&&t.push(i)}return t};function gp(a,e,t){const n=a.createShader(e);return a.shaderSource(n,t),a.compileShader(n),n}let Kw=0;function Jw(a){const e=a.split(`
`);for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join(`
`)}function lg(a){switch(a){case Cr:return["Linear","( value )"];case Mc:return["sRGB","( value )"];case nh:return["RGBE","( value )"];case Hv:return["RGBM","( value, 7.0 )"];case Wv:return["RGBM","( value, 16.0 )"];case Xv:return["RGBD","( value, 256.0 )"];case rh:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case z1:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",a),["Linear","( value )"]}}function _p(a,e,t){const n=a.getShaderParameter(e,35713),r=a.getShaderInfoLog(e).trim();if(n&&r==="")return"";const i=a.getShaderSource(e);return"THREE.WebGLShader: gl.getShaderInfoLog() "+t+`
`+r+Jw(i)}function ba(a,e){const t=lg(e);return"vec4 "+a+"( vec4 value ) { return "+t[0]+"ToLinear"+t[1]+"; }"}function Qw(a,e){const t=lg(e);return"vec4 "+a+"( vec4 value ) { return LinearTo"+t[0]+t[1]+"; }"}function eM(a,e){let t;switch(e){case By:t="Linear";break;case zy:t="Reinhard";break;case Vy:t="OptimizedCineon";break;case Uy:t="ACESFilmic";break;case Gy:t="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),t="Linear"}return"vec3 "+a+"( vec3 color ) { return "+t+"ToneMapping( color ); }"}function tM(a){return[a.extensionDerivatives||a.envMapCubeUV||a.bumpMap||a.tangentSpaceNormalMap||a.clearcoatNormalMap||a.flatShading||a.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(a.extensionFragDepth||a.logarithmicDepthBuffer)&&a.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",a.extensionDrawBuffers&&a.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(a.extensionShaderTextureLOD||a.envMap||a.transmission>0)&&a.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Ys).join(`
`)}function rM(a){const e=[];for(const t in a){const n=a[t];n!==!1&&e.push("#define "+t+" "+n)}return e.join(`
`)}function nM(a,e){const t={},n=a.getProgramParameter(e,35721);for(let r=0;r<n;r++){const s=a.getActiveAttrib(e,r).name;t[s]=a.getAttribLocation(e,s)}return t}function Ys(a){return a!==""}function yp(a,e){return a.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function xp(a,e){return a.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const iM=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ef(a){return a.replace(iM,aM)}function aM(a,e){const t=ct[e];if(t===void 0)throw new Error("Can not resolve #include <"+e+">");return Ef(t)}const sM=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,oM=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Sp(a){return a.replace(oM,cg).replace(sM,lM)}function lM(a,e,t,n){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),cg(a,e,t,n)}function cg(a,e,t,n){let r="";for(let i=parseInt(e);i<parseInt(t);i++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+i+" ]").replace(/UNROLLED_LOOP_INDEX/g,i);return r}function bp(a){let e="precision "+a.precision+` float;
precision `+a.precision+" int;";return a.precision==="highp"?e+=`
#define HIGH_PRECISION`:a.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:a.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}function cM(a){let e="SHADOWMAP_TYPE_BASIC";return a.shadowMapType===Qf?e="SHADOWMAP_TYPE_PCF":a.shadowMapType===vy?e="SHADOWMAP_TYPE_PCF_SOFT":a.shadowMapType===js&&(e="SHADOWMAP_TYPE_VSM"),e}function uM(a){let e="ENVMAP_TYPE_CUBE";if(a.envMap)switch(a.envMapMode){case xc:case Sc:e="ENVMAP_TYPE_CUBE";break;case bc:case eh:e="ENVMAP_TYPE_CUBE_UV";break}return e}function fM(a){let e="ENVMAP_MODE_REFLECTION";if(a.envMap)switch(a.envMapMode){case Sc:case eh:e="ENVMAP_MODE_REFRACTION";break}return e}function hM(a){let e="ENVMAP_BLENDING_NONE";if(a.envMap)switch(a.combine){case _c:e="ENVMAP_BLENDING_MULTIPLY";break;case Dy:e="ENVMAP_BLENDING_MIX";break;case Fy:e="ENVMAP_BLENDING_ADD";break}return e}function dM(a,e,t,n){const r=a.getContext(),i=t.defines;let s=t.vertexShader,o=t.fragmentShader;const l=cM(t),c=uM(t),u=fM(t),f=hM(t),h=a.gammaFactor>0?a.gammaFactor:1,d=t.isWebGL2?"":tM(t),p=rM(i),v=r.createProgram();let _,m,g=t.glslVersion?"#version "+t.glslVersion+`
`:"";t.isRawShaderMaterial?(_=[p].filter(Ys).join(`
`),_.length>0&&(_+=`
`),m=[d,p].filter(Ys).join(`
`),m.length>0&&(m+=`
`)):(_=[bp(t),"#define SHADER_NAME "+t.shaderName,p,t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+h,"#define MAX_BONES "+t.maxBones,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+u:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",t.normalMap&&t.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.displacementMap&&t.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",t.specularTintMap?"#define USE_SPECULARTINTMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUvs?"#define USE_UV":"",t.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.useVertexTexture?"#define BONE_TEXTURE":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&t.flatShading===!1?"#define USE_MORPHNORMALS":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+l:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(Ys).join(`
`),m=[d,bp(t),"#define SHADER_NAME "+t.shaderName,p,t.alphaTest?"#define ALPHATEST "+t.alphaTest+(t.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+h,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+c:"",t.envMap?"#define "+u:"",t.envMap?"#define "+f:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMap&&t.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",t.normalMap&&t.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",t.specularTintMap?"#define USE_SPECULARTINTMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.sheen?"#define USE_SHEEN":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUvs?"#define USE_UV":"",t.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+l:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",t.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==Hi?"#define TONE_MAPPING":"",t.toneMapping!==Hi?ct.tonemapping_pars_fragment:"",t.toneMapping!==Hi?eM("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",ct.encodings_pars_fragment,t.map?ba("mapTexelToLinear",t.mapEncoding):"",t.matcap?ba("matcapTexelToLinear",t.matcapEncoding):"",t.envMap?ba("envMapTexelToLinear",t.envMapEncoding):"",t.emissiveMap?ba("emissiveMapTexelToLinear",t.emissiveMapEncoding):"",t.specularTintMap?ba("specularTintMapTexelToLinear",t.specularTintMapEncoding):"",t.lightMap?ba("lightMapTexelToLinear",t.lightMapEncoding):"",Qw("linearToOutputTexel",t.outputEncoding),t.depthPacking?"#define DEPTH_PACKING "+t.depthPacking:"",`
`].filter(Ys).join(`
`)),s=Ef(s),s=yp(s,t),s=xp(s,t),o=Ef(o),o=yp(o,t),o=xp(o,t),s=Sp(s),o=Sp(o),t.isWebGL2&&t.isRawShaderMaterial!==!0&&(g=`#version 300 es
`,_=["#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+_,m=["#define varying in",t.glslVersion===jd?"":"out highp vec4 pc_fragColor;",t.glslVersion===jd?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+m);const y=g+_+s,x=g+m+o,S=gp(r,35633,y),M=gp(r,35632,x);if(r.attachShader(v,S),r.attachShader(v,M),t.index0AttributeName!==void 0?r.bindAttribLocation(v,0,t.index0AttributeName):t.morphTargets===!0&&r.bindAttribLocation(v,0,"position"),r.linkProgram(v),a.debug.checkShaderErrors){const B=r.getProgramInfoLog(v).trim(),V=r.getShaderInfoLog(S).trim(),O=r.getShaderInfoLog(M).trim();let W=!0,z=!0;if(r.getProgramParameter(v,35714)===!1){W=!1;const C=_p(r,S,"vertex"),T=_p(r,M,"fragment");console.error("THREE.WebGLProgram: shader error: ",r.getError(),"35715",r.getProgramParameter(v,35715),"gl.getProgramInfoLog",B,C,T)}else B!==""?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",B):(V===""||O==="")&&(z=!1);z&&(this.diagnostics={runnable:W,programLog:B,vertexShader:{log:V,prefix:_},fragmentShader:{log:O,prefix:m}})}r.deleteShader(S),r.deleteShader(M);let E;this.getUniforms=function(){return E===void 0&&(E=new di(r,v)),E};let N;return this.getAttributes=function(){return N===void 0&&(N=nM(r,v)),N},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(v),this.program=void 0},this.name=t.shaderName,this.id=Kw++,this.cacheKey=e,this.usedTimes=1,this.program=v,this.vertexShader=S,this.fragmentShader=M,this}function pM(a,e,t,n,r,i,s){const o=[],l=r.isWebGL2,c=r.logarithmicDepthBuffer,u=r.floatVertexTextures,f=r.maxVertexUniforms,h=r.vertexTextures;let d=r.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},v=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","specularIntensityMap","specularTintMap","specularTintMapEncoding","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexAlphas","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen","transmission","transmissionMap","thicknessMap"];function _(E){const B=E.skeleton.bones;if(u)return 1024;{const O=Math.floor((f-20)/4),W=Math.min(O,B.length);return W<B.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+B.length+" bones. This GPU supports "+W+"."),0):W}}function m(E){let N;return E&&E.isTexture?N=E.encoding:E&&E.isWebGLRenderTarget?(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),N=E.texture.encoding):N=Cr,N}function g(E,N,B,V,O){const W=V.fog,z=E.isMeshStandardMaterial?V.environment:null,C=(E.isMeshStandardMaterial?t:e).get(E.envMap||z),T=p[E.type],A=O.isSkinnedMesh?_(O):0;E.precision!==null&&(d=r.getMaxPrecision(E.precision),d!==E.precision&&console.warn("THREE.WebGLProgram.getParameters:",E.precision,"not supported, using",d,"instead."));let F,X;if(T){const ae=_n[T];F=ae.vertexShader,X=ae.fragmentShader}else F=E.vertexShader,X=E.fragmentShader;const Y=a.getRenderTarget();return{isWebGL2:l,shaderID:T,shaderName:E.type,vertexShader:F,fragmentShader:X,defines:E.defines,isRawShaderMaterial:E.isRawShaderMaterial===!0,glslVersion:E.glslVersion,precision:d,instancing:O.isInstancedMesh===!0,instancingColor:O.isInstancedMesh===!0&&O.instanceColor!==null,supportsVertexTextures:h,outputEncoding:Y!==null?m(Y.texture):a.outputEncoding,map:!!E.map,mapEncoding:m(E.map),matcap:!!E.matcap,matcapEncoding:m(E.matcap),envMap:!!C,envMapMode:C&&C.mapping,envMapEncoding:m(C),envMapCubeUV:!!C&&(C.mapping===bc||C.mapping===eh),lightMap:!!E.lightMap,lightMapEncoding:m(E.lightMap),aoMap:!!E.aoMap,emissiveMap:!!E.emissiveMap,emissiveMapEncoding:m(E.emissiveMap),bumpMap:!!E.bumpMap,normalMap:!!E.normalMap,objectSpaceNormalMap:E.normalMapType===G1,tangentSpaceNormalMap:E.normalMapType===ss,clearcoatMap:!!E.clearcoatMap,clearcoatRoughnessMap:!!E.clearcoatRoughnessMap,clearcoatNormalMap:!!E.clearcoatNormalMap,displacementMap:!!E.displacementMap,roughnessMap:!!E.roughnessMap,metalnessMap:!!E.metalnessMap,specularMap:!!E.specularMap,specularIntensityMap:!!E.specularIntensityMap,specularTintMap:!!E.specularTintMap,specularTintMapEncoding:m(E.specularTintMap),alphaMap:!!E.alphaMap,gradientMap:!!E.gradientMap,sheen:!!E.sheen,transmission:!!E.transmission,transmissionMap:!!E.transmissionMap,thicknessMap:!!E.thicknessMap,combine:E.combine,vertexTangents:!!E.normalMap&&!!O.geometry&&!!O.geometry.attributes.tangent,vertexColors:E.vertexColors,vertexAlphas:E.vertexColors===!0&&!!O.geometry&&!!O.geometry.attributes.color&&O.geometry.attributes.color.itemSize===4,vertexUvs:!!E.map||!!E.bumpMap||!!E.normalMap||!!E.specularMap||!!E.alphaMap||!!E.emissiveMap||!!E.roughnessMap||!!E.metalnessMap||!!E.clearcoatMap||!!E.clearcoatRoughnessMap||!!E.clearcoatNormalMap||!!E.displacementMap||!!E.transmissionMap||!!E.thicknessMap||!!E.specularIntensityMap||!!E.specularTintMap,uvsVertexOnly:!(E.map||E.bumpMap||E.normalMap||E.specularMap||E.alphaMap||E.emissiveMap||E.roughnessMap||E.metalnessMap||E.clearcoatNormalMap||E.transmission||E.transmissionMap||E.thicknessMap||E.specularIntensityMap||E.specularTintMap)&&!!E.displacementMap,fog:!!W,useFog:E.fog,fogExp2:W&&W.isFogExp2,flatShading:!!E.flatShading,sizeAttenuation:E.sizeAttenuation,logarithmicDepthBuffer:c,skinning:O.isSkinnedMesh===!0&&A>0,maxBones:A,useVertexTexture:u,morphTargets:!!O.geometry&&!!O.geometry.morphAttributes.position,morphNormals:!!O.geometry&&!!O.geometry.morphAttributes.normal,numDirLights:N.directional.length,numPointLights:N.point.length,numSpotLights:N.spot.length,numRectAreaLights:N.rectArea.length,numHemiLights:N.hemi.length,numDirLightShadows:N.directionalShadowMap.length,numPointLightShadows:N.pointShadowMap.length,numSpotLightShadows:N.spotShadowMap.length,numClippingPlanes:s.numPlanes,numClipIntersection:s.numIntersection,dithering:E.dithering,shadowMapEnabled:a.shadowMap.enabled&&B.length>0,shadowMapType:a.shadowMap.type,toneMapping:E.toneMapped?a.toneMapping:Hi,physicallyCorrectLights:a.physicallyCorrectLights,premultipliedAlpha:E.premultipliedAlpha,alphaTest:E.alphaTest,doubleSided:E.side===Yi,flipSided:E.side===Ut,depthPacking:E.depthPacking!==void 0?E.depthPacking:!1,index0AttributeName:E.index0AttributeName,extensionDerivatives:E.extensions&&E.extensions.derivatives,extensionFragDepth:E.extensions&&E.extensions.fragDepth,extensionDrawBuffers:E.extensions&&E.extensions.drawBuffers,extensionShaderTextureLOD:E.extensions&&E.extensions.shaderTextureLOD,rendererExtensionFragDepth:l||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:l||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:l||n.has("EXT_shader_texture_lod"),customProgramCacheKey:E.customProgramCacheKey()}}function y(E){const N=[];if(E.shaderID?N.push(E.shaderID):(N.push(E.fragmentShader),N.push(E.vertexShader)),E.defines!==void 0)for(const B in E.defines)N.push(B),N.push(E.defines[B]);if(E.isRawShaderMaterial===!1){for(let B=0;B<v.length;B++)N.push(E[v[B]]);N.push(a.outputEncoding),N.push(a.gammaFactor)}return N.push(E.customProgramCacheKey),N.join()}function x(E){const N=p[E.type];let B;if(N){const V=_n[N];B=qi.clone(V.uniforms)}else B=E.uniforms;return B}function S(E,N){let B;for(let V=0,O=o.length;V<O;V++){const W=o[V];if(W.cacheKey===N){B=W,++B.usedTimes;break}}return B===void 0&&(B=new dM(a,N,E,i),o.push(B)),B}function M(E){if(--E.usedTimes===0){const N=o.indexOf(E);o[N]=o[o.length-1],o.pop(),E.destroy()}}return{getParameters:g,getProgramCacheKey:y,getUniforms:x,acquireProgram:S,releaseProgram:M,programs:o}}function mM(){let a=new WeakMap;function e(i){let s=a.get(i);return s===void 0&&(s={},a.set(i,s)),s}function t(i){a.delete(i)}function n(i,s,o){a.get(i)[s]=o}function r(){a=new WeakMap}return{get:e,remove:t,update:n,dispose:r}}function vM(a,e){return a.groupOrder!==e.groupOrder?a.groupOrder-e.groupOrder:a.renderOrder!==e.renderOrder?a.renderOrder-e.renderOrder:a.program!==e.program?a.program.id-e.program.id:a.material.id!==e.material.id?a.material.id-e.material.id:a.z!==e.z?a.z-e.z:a.id-e.id}function wp(a,e){return a.groupOrder!==e.groupOrder?a.groupOrder-e.groupOrder:a.renderOrder!==e.renderOrder?a.renderOrder-e.renderOrder:a.z!==e.z?e.z-a.z:a.id-e.id}function Mp(a){const e=[];let t=0;const n=[],r=[],i=[],s={id:-1};function o(){t=0,n.length=0,r.length=0,i.length=0}function l(d,p,v,_,m,g){let y=e[t];const x=a.get(v);return y===void 0?(y={id:d.id,object:d,geometry:p,material:v,program:x.program||s,groupOrder:_,renderOrder:d.renderOrder,z:m,group:g},e[t]=y):(y.id=d.id,y.object=d,y.geometry=p,y.material=v,y.program=x.program||s,y.groupOrder=_,y.renderOrder=d.renderOrder,y.z=m,y.group=g),t++,y}function c(d,p,v,_,m,g){const y=l(d,p,v,_,m,g);v.transmission>0?r.push(y):v.transparent===!0?i.push(y):n.push(y)}function u(d,p,v,_,m,g){const y=l(d,p,v,_,m,g);v.transmission>0?r.unshift(y):v.transparent===!0?i.unshift(y):n.unshift(y)}function f(d,p){n.length>1&&n.sort(d||vM),r.length>1&&r.sort(p||wp),i.length>1&&i.sort(p||wp)}function h(){for(let d=t,p=e.length;d<p;d++){const v=e[d];if(v.id===null)break;v.id=null,v.object=null,v.geometry=null,v.material=null,v.program=null,v.group=null}}return{opaque:n,transmissive:r,transparent:i,init:o,push:c,unshift:u,finish:h,sort:f}}function gM(a){let e=new WeakMap;function t(r,i){let s;return e.has(r)===!1?(s=new Mp(a),e.set(r,[s])):i>=e.get(r).length?(s=new Mp(a),e.get(r).push(s)):s=e.get(r)[i],s}function n(){e=new WeakMap}return{get:t,dispose:n}}function _M(){const a={};return{get:function(e){if(a[e.id]!==void 0)return a[e.id];let t;switch(e.type){case"DirectionalLight":t={direction:new b,color:new ze};break;case"SpotLight":t={position:new b,direction:new b,color:new ze,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new b,color:new ze,distance:0,decay:0};break;case"HemisphereLight":t={direction:new b,skyColor:new ze,groundColor:new ze};break;case"RectAreaLight":t={color:new ze,position:new b,halfWidth:new b,halfHeight:new b};break}return a[e.id]=t,t}}}function yM(){const a={};return{get:function(e){if(a[e.id]!==void 0)return a[e.id];let t;switch(e.type){case"DirectionalLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ve};break;case"SpotLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ve};break;case"PointLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ve,shadowCameraNear:1,shadowCameraFar:1e3};break}return a[e.id]=t,t}}}let xM=0;function SM(a,e){return(e.castShadow?1:0)-(a.castShadow?1:0)}function bM(a,e){const t=new _M,n=yM(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let u=0;u<9;u++)r.probe.push(new b);const i=new b,s=new Ce,o=new Ce;function l(u){let f=0,h=0,d=0;for(let E=0;E<9;E++)r.probe[E].set(0,0,0);let p=0,v=0,_=0,m=0,g=0,y=0,x=0,S=0;u.sort(SM);for(let E=0,N=u.length;E<N;E++){const B=u[E],V=B.color,O=B.intensity,W=B.distance,z=B.shadow&&B.shadow.map?B.shadow.map.texture:null;if(B.isAmbientLight)f+=V.r*O,h+=V.g*O,d+=V.b*O;else if(B.isLightProbe)for(let C=0;C<9;C++)r.probe[C].addScaledVector(B.sh.coefficients[C],O);else if(B.isDirectionalLight){const C=t.get(B);if(C.color.copy(B.color).multiplyScalar(B.intensity),B.castShadow){const T=B.shadow,A=n.get(B);A.shadowBias=T.bias,A.shadowNormalBias=T.normalBias,A.shadowRadius=T.radius,A.shadowMapSize=T.mapSize,r.directionalShadow[p]=A,r.directionalShadowMap[p]=z,r.directionalShadowMatrix[p]=B.shadow.matrix,y++}r.directional[p]=C,p++}else if(B.isSpotLight){const C=t.get(B);if(C.position.setFromMatrixPosition(B.matrixWorld),C.color.copy(V).multiplyScalar(O),C.distance=W,C.coneCos=Math.cos(B.angle),C.penumbraCos=Math.cos(B.angle*(1-B.penumbra)),C.decay=B.decay,B.castShadow){const T=B.shadow,A=n.get(B);A.shadowBias=T.bias,A.shadowNormalBias=T.normalBias,A.shadowRadius=T.radius,A.shadowMapSize=T.mapSize,r.spotShadow[_]=A,r.spotShadowMap[_]=z,r.spotShadowMatrix[_]=B.shadow.matrix,S++}r.spot[_]=C,_++}else if(B.isRectAreaLight){const C=t.get(B);C.color.copy(V).multiplyScalar(O),C.halfWidth.set(B.width*.5,0,0),C.halfHeight.set(0,B.height*.5,0),r.rectArea[m]=C,m++}else if(B.isPointLight){const C=t.get(B);if(C.color.copy(B.color).multiplyScalar(B.intensity),C.distance=B.distance,C.decay=B.decay,B.castShadow){const T=B.shadow,A=n.get(B);A.shadowBias=T.bias,A.shadowNormalBias=T.normalBias,A.shadowRadius=T.radius,A.shadowMapSize=T.mapSize,A.shadowCameraNear=T.camera.near,A.shadowCameraFar=T.camera.far,r.pointShadow[v]=A,r.pointShadowMap[v]=z,r.pointShadowMatrix[v]=B.shadow.matrix,x++}r.point[v]=C,v++}else if(B.isHemisphereLight){const C=t.get(B);C.skyColor.copy(B.color).multiplyScalar(O),C.groundColor.copy(B.groundColor).multiplyScalar(O),r.hemi[g]=C,g++}}m>0&&(e.isWebGL2||a.has("OES_texture_float_linear")===!0?(r.rectAreaLTC1=Ue.LTC_FLOAT_1,r.rectAreaLTC2=Ue.LTC_FLOAT_2):a.has("OES_texture_half_float_linear")===!0?(r.rectAreaLTC1=Ue.LTC_HALF_1,r.rectAreaLTC2=Ue.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=f,r.ambient[1]=h,r.ambient[2]=d;const M=r.hash;(M.directionalLength!==p||M.pointLength!==v||M.spotLength!==_||M.rectAreaLength!==m||M.hemiLength!==g||M.numDirectionalShadows!==y||M.numPointShadows!==x||M.numSpotShadows!==S)&&(r.directional.length=p,r.spot.length=_,r.rectArea.length=m,r.point.length=v,r.hemi.length=g,r.directionalShadow.length=y,r.directionalShadowMap.length=y,r.pointShadow.length=x,r.pointShadowMap.length=x,r.spotShadow.length=S,r.spotShadowMap.length=S,r.directionalShadowMatrix.length=y,r.pointShadowMatrix.length=x,r.spotShadowMatrix.length=S,M.directionalLength=p,M.pointLength=v,M.spotLength=_,M.rectAreaLength=m,M.hemiLength=g,M.numDirectionalShadows=y,M.numPointShadows=x,M.numSpotShadows=S,r.version=xM++)}function c(u,f){let h=0,d=0,p=0,v=0,_=0;const m=f.matrixWorldInverse;for(let g=0,y=u.length;g<y;g++){const x=u[g];if(x.isDirectionalLight){const S=r.directional[h];S.direction.setFromMatrixPosition(x.matrixWorld),i.setFromMatrixPosition(x.target.matrixWorld),S.direction.sub(i),S.direction.transformDirection(m),h++}else if(x.isSpotLight){const S=r.spot[p];S.position.setFromMatrixPosition(x.matrixWorld),S.position.applyMatrix4(m),S.direction.setFromMatrixPosition(x.matrixWorld),i.setFromMatrixPosition(x.target.matrixWorld),S.direction.sub(i),S.direction.transformDirection(m),p++}else if(x.isRectAreaLight){const S=r.rectArea[v];S.position.setFromMatrixPosition(x.matrixWorld),S.position.applyMatrix4(m),o.identity(),s.copy(x.matrixWorld),s.premultiply(m),o.extractRotation(s),S.halfWidth.set(x.width*.5,0,0),S.halfHeight.set(0,x.height*.5,0),S.halfWidth.applyMatrix4(o),S.halfHeight.applyMatrix4(o),v++}else if(x.isPointLight){const S=r.point[d];S.position.setFromMatrixPosition(x.matrixWorld),S.position.applyMatrix4(m),d++}else if(x.isHemisphereLight){const S=r.hemi[_];S.direction.setFromMatrixPosition(x.matrixWorld),S.direction.transformDirection(m),S.direction.normalize(),_++}}}return{setup:l,setupView:c,state:r}}function Ep(a,e){const t=new bM(a,e),n=[],r=[];function i(){n.length=0,r.length=0}function s(f){n.push(f)}function o(f){r.push(f)}function l(){t.setup(n)}function c(f){t.setupView(n,f)}return{init:i,state:{lightsArray:n,shadowsArray:r,lights:t},setupLights:l,setupLightsView:c,pushLight:s,pushShadow:o}}function wM(a,e){let t=new WeakMap;function n(i,s=0){let o;return t.has(i)===!1?(o=new Ep(a,e),t.set(i,[o])):s>=t.get(i).length?(o=new Ep(a,e),t.get(i).push(o)):o=t.get(i)[s],o}function r(){t=new WeakMap}return{get:n,dispose:r}}class ug extends er{constructor(e){super(),this.type="MeshDepthMaterial",this.depthPacking=V1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}ug.prototype.isMeshDepthMaterial=!0;class fg extends er{constructor(e){super(),this.type="MeshDistanceMaterial",this.referencePosition=new b,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}fg.prototype.isMeshDistanceMaterial=!0;var MM=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
	float mean = 0.0;
	float squared_mean = 0.0;
	float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );
	for ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, i ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean * HALF_SAMPLE_RATE;
	squared_mean = squared_mean * HALF_SAMPLE_RATE;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`,EM=`void main() {
	gl_Position = vec4( position, 1.0 );
}`;function hg(a,e,t){let n=new Ac;const r=new ve,i=new ve,s=new ht,o=new ug({depthPacking:U1}),l=new fg,c={},u=t.maxTextureSize,f={0:Ut,1:ji,2:Yi},h=new cn({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new ve},radius:{value:4}},vertexShader:EM,fragmentShader:MM}),d=h.clone();d.defines.HORIZONTAL_PASS=1;const p=new at;p.setAttribute("position",new Ze(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const v=new ft(p,h),_=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=Qf,this.render=function(x,S,M){if(_.enabled===!1||_.autoUpdate===!1&&_.needsUpdate===!1||x.length===0)return;const E=a.getRenderTarget(),N=a.getActiveCubeFace(),B=a.getActiveMipmapLevel(),V=a.state;V.setBlending(zn),V.buffers.color.setClear(1,1,1,1),V.buffers.depth.setTest(!0),V.setScissorTest(!1);for(let O=0,W=x.length;O<W;O++){const z=x[O],C=z.shadow;if(C===void 0){console.warn("THREE.WebGLShadowMap:",z,"has no shadow.");continue}if(C.autoUpdate===!1&&C.needsUpdate===!1)continue;r.copy(C.mapSize);const T=C.getFrameExtents();if(r.multiply(T),i.copy(C.mapSize),(r.x>u||r.y>u)&&(r.x>u&&(i.x=Math.floor(u/T.x),r.x=i.x*T.x,C.mapSize.x=i.x),r.y>u&&(i.y=Math.floor(u/T.y),r.y=i.y*T.y,C.mapSize.y=i.y)),C.map===null&&!C.isPointLightShadow&&this.type===js){const F={minFilter:pt,magFilter:pt,format:Ft};C.map=new Gt(r.x,r.y,F),C.map.texture.name=z.name+".shadowMap",C.mapPass=new Gt(r.x,r.y,F),C.camera.updateProjectionMatrix()}if(C.map===null){const F={minFilter:It,magFilter:It,format:Ft};C.map=new Gt(r.x,r.y,F),C.map.texture.name=z.name+".shadowMap",C.camera.updateProjectionMatrix()}a.setRenderTarget(C.map),a.clear();const A=C.getViewportCount();for(let F=0;F<A;F++){const X=C.getViewport(F);s.set(i.x*X.x,i.y*X.y,i.x*X.z,i.y*X.w),V.viewport(s),C.updateMatrices(z,F),n=C.getFrustum(),y(S,M,C.camera,z,this.type)}!C.isPointLightShadow&&this.type===js&&m(C,M),C.needsUpdate=!1}_.needsUpdate=!1,a.setRenderTarget(E,N,B)};function m(x,S){const M=e.update(v);h.uniforms.shadow_pass.value=x.map.texture,h.uniforms.resolution.value=x.mapSize,h.uniforms.radius.value=x.radius,a.setRenderTarget(x.mapPass),a.clear(),a.renderBufferDirect(S,null,M,h,v,null),d.uniforms.shadow_pass.value=x.mapPass.texture,d.uniforms.resolution.value=x.mapSize,d.uniforms.radius.value=x.radius,a.setRenderTarget(x.map),a.clear(),a.renderBufferDirect(S,null,M,d,v,null)}function g(x,S,M,E,N,B,V){let O=null;const W=E.isPointLight===!0?x.customDistanceMaterial:x.customDepthMaterial;if(W!==void 0?O=W:O=E.isPointLight===!0?l:o,a.localClippingEnabled&&M.clipShadows===!0&&M.clippingPlanes.length!==0){const z=O.uuid,C=M.uuid;let T=c[z];T===void 0&&(T={},c[z]=T);let A=T[C];A===void 0&&(A=O.clone(),T[C]=A),O=A}return O.visible=M.visible,O.wireframe=M.wireframe,V===js?O.side=M.shadowSide!==null?M.shadowSide:M.side:O.side=M.shadowSide!==null?M.shadowSide:f[M.side],O.clipShadows=M.clipShadows,O.clippingPlanes=M.clippingPlanes,O.clipIntersection=M.clipIntersection,O.wireframeLinewidth=M.wireframeLinewidth,O.linewidth=M.linewidth,E.isPointLight===!0&&O.isMeshDistanceMaterial===!0&&(O.referencePosition.setFromMatrixPosition(E.matrixWorld),O.nearDistance=N,O.farDistance=B),O}function y(x,S,M,E,N){if(x.visible===!1)return;if(x.layers.test(S.layers)&&(x.isMesh||x.isLine||x.isPoints)&&(x.castShadow||x.receiveShadow&&N===js)&&(!x.frustumCulled||n.intersectsObject(x))){x.modelViewMatrix.multiplyMatrices(M.matrixWorldInverse,x.matrixWorld);const O=e.update(x),W=x.material;if(Array.isArray(W)){const z=O.groups;for(let C=0,T=z.length;C<T;C++){const A=z[C],F=W[A.materialIndex];if(F&&F.visible){const X=g(x,O,F,E,M.near,M.far,N);a.renderBufferDirect(M,null,O,X,x,A)}}}else if(W.visible){const z=g(x,O,W,E,M.near,M.far,N);a.renderBufferDirect(M,null,O,z,x,null)}}const V=x.children;for(let O=0,W=V.length;O<W;O++)y(V[O],S,M,E,N)}}function CM(a,e,t){const n=t.isWebGL2;function r(){let w=!1;const L=new ht;let R=null;const j=new ht(0,0,0,0);return{setMask:function(U){R!==U&&!w&&(a.colorMask(U,U,U,U),R=U)},setLocked:function(U){w=U},setClear:function(U,me,ye,Ne,Ve){Ve===!0&&(U*=Ne,me*=Ne,ye*=Ne),L.set(U,me,ye,Ne),j.equals(L)===!1&&(a.clearColor(U,me,ye,Ne),j.copy(L))},reset:function(){w=!1,R=null,j.set(-1,0,0,0)}}}function i(){let w=!1,L=null,R=null,j=null;return{setTest:function(U){U?ge(2929):we(2929)},setMask:function(U){L!==U&&!w&&(a.depthMask(U),L=U)},setFunc:function(U){if(R!==U){if(U)switch(U){case Ry:a.depthFunc(512);break;case Ly:a.depthFunc(519);break;case Py:a.depthFunc(513);break;case nc:a.depthFunc(515);break;case Ny:a.depthFunc(514);break;case Iy:a.depthFunc(518);break;case ky:a.depthFunc(516);break;case Oy:a.depthFunc(517);break;default:a.depthFunc(515)}else a.depthFunc(515);R=U}},setLocked:function(U){w=U},setClear:function(U){j!==U&&(a.clearDepth(U),j=U)},reset:function(){w=!1,L=null,R=null,j=null}}}function s(){let w=!1,L=null,R=null,j=null,U=null,me=null,ye=null,Ne=null,Ve=null;return{setTest:function(Ie){w||(Ie?ge(2960):we(2960))},setMask:function(Ie){L!==Ie&&!w&&(a.stencilMask(Ie),L=Ie)},setFunc:function(Ie,et,gt){(R!==Ie||j!==et||U!==gt)&&(a.stencilFunc(Ie,et,gt),R=Ie,j=et,U=gt)},setOp:function(Ie,et,gt){(me!==Ie||ye!==et||Ne!==gt)&&(a.stencilOp(Ie,et,gt),me=Ie,ye=et,Ne=gt)},setLocked:function(Ie){w=Ie},setClear:function(Ie){Ve!==Ie&&(a.clearStencil(Ie),Ve=Ie)},reset:function(){w=!1,L=null,R=null,j=null,U=null,me=null,ye=null,Ne=null,Ve=null}}}const o=new r,l=new i,c=new s;let u={},f=null,h={},d=null,p=!1,v=null,_=null,m=null,g=null,y=null,x=null,S=null,M=!1,E=null,N=null,B=null,V=null,O=null;const W=a.getParameter(35661);let z=!1,C=0;const T=a.getParameter(7938);T.indexOf("WebGL")!==-1?(C=parseFloat(/^WebGL (\d)/.exec(T)[1]),z=C>=1):T.indexOf("OpenGL ES")!==-1&&(C=parseFloat(/^OpenGL ES (\d)/.exec(T)[1]),z=C>=2);let A=null,F={};const X=a.getParameter(3088),Y=a.getParameter(2978),ne=new ht().fromArray(X),ae=new ht().fromArray(Y);function xe(w,L,R){const j=new Uint8Array(4),U=a.createTexture();a.bindTexture(w,U),a.texParameteri(w,10241,9728),a.texParameteri(w,10240,9728);for(let me=0;me<R;me++)a.texImage2D(L+me,0,6408,1,1,0,6408,5121,j);return U}const be={};be[3553]=xe(3553,3553,1),be[34067]=xe(34067,34069,6),o.setClear(0,0,0,1),l.setClear(1),c.setClear(0),ge(2929),l.setFunc(nc),oe(!1),K(Td),ge(2884),_e(zn);function ge(w){u[w]!==!0&&(a.enable(w),u[w]=!0)}function we(w){u[w]!==!1&&(a.disable(w),u[w]=!1)}function q(w){w!==f&&(a.bindFramebuffer(36160,w),f=w)}function Ge(w,L){return L===null&&f!==null&&(L=f),h[w]!==L?(a.bindFramebuffer(w,L),h[w]=L,n&&(w===36009&&(h[36160]=L),w===36160&&(h[36009]=L)),!0):!1}function Te(w){return d!==w?(a.useProgram(w),d=w,!0):!1}const Pe={[Va]:32774,[_y]:32778,[yy]:32779};if(n)Pe[Nd]=32775,Pe[Id]=32776;else{const w=e.get("EXT_blend_minmax");w!==null&&(Pe[Nd]=w.MIN_EXT,Pe[Id]=w.MAX_EXT)}const Ee={[xy]:0,[Sy]:1,[by]:768,[zv]:770,[Ty]:776,[Cy]:774,[My]:772,[wy]:769,[Vv]:771,[Ay]:775,[Ey]:773};function _e(w,L,R,j,U,me,ye,Ne){if(w===zn){p===!0&&(we(3042),p=!1);return}if(p===!1&&(ge(3042),p=!0),w!==gy){if(w!==v||Ne!==M){if((_!==Va||y!==Va)&&(a.blendEquation(32774),_=Va,y=Va),Ne)switch(w){case $s:a.blendFuncSeparate(1,771,1,771);break;case Rd:a.blendFunc(1,1);break;case Ld:a.blendFuncSeparate(0,0,769,771);break;case Pd:a.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",w);break}else switch(w){case $s:a.blendFuncSeparate(770,771,1,771);break;case Rd:a.blendFunc(770,1);break;case Ld:a.blendFunc(0,769);break;case Pd:a.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",w);break}m=null,g=null,x=null,S=null,v=w,M=Ne}return}U=U||L,me=me||R,ye=ye||j,(L!==_||U!==y)&&(a.blendEquationSeparate(Pe[L],Pe[U]),_=L,y=U),(R!==m||j!==g||me!==x||ye!==S)&&(a.blendFuncSeparate(Ee[R],Ee[j],Ee[me],Ee[ye]),m=R,g=j,x=me,S=ye),v=w,M=null}function ie(w,L){w.side===Yi?we(2884):ge(2884);let R=w.side===Ut;L&&(R=!R),oe(R),w.blending===$s&&w.transparent===!1?_e(zn):_e(w.blending,w.blendEquation,w.blendSrc,w.blendDst,w.blendEquationAlpha,w.blendSrcAlpha,w.blendDstAlpha,w.premultipliedAlpha),l.setFunc(w.depthFunc),l.setTest(w.depthTest),l.setMask(w.depthWrite),o.setMask(w.colorWrite);const j=w.stencilWrite;c.setTest(j),j&&(c.setMask(w.stencilWriteMask),c.setFunc(w.stencilFunc,w.stencilRef,w.stencilFuncMask),c.setOp(w.stencilFail,w.stencilZFail,w.stencilZPass)),he(w.polygonOffset,w.polygonOffsetFactor,w.polygonOffsetUnits),w.alphaToCoverage===!0?ge(32926):we(32926)}function oe(w){E!==w&&(w?a.frontFace(2304):a.frontFace(2305),E=w)}function K(w){w!==py?(ge(2884),w!==N&&(w===Td?a.cullFace(1029):w===my?a.cullFace(1028):a.cullFace(1032))):we(2884),N=w}function de(w){w!==B&&(z&&a.lineWidth(w),B=w)}function he(w,L,R){w?(ge(32823),(V!==L||O!==R)&&(a.polygonOffset(L,R),V=L,O=R)):we(32823)}function I(w){w?ge(3089):we(3089)}function P(w){w===void 0&&(w=33984+W-1),A!==w&&(a.activeTexture(w),A=w)}function ee(w,L){A===null&&P();let R=F[A];R===void 0&&(R={type:void 0,texture:void 0},F[A]=R),(R.type!==w||R.texture!==L)&&(a.bindTexture(w,L||be[w]),R.type=w,R.texture=L)}function pe(){const w=F[A];w!==void 0&&w.type!==void 0&&(a.bindTexture(w.type,null),w.type=void 0,w.texture=void 0)}function Me(){try{a.compressedTexImage2D.apply(a,arguments)}catch(w){console.error("THREE.WebGLState:",w)}}function Re(){try{a.texImage2D.apply(a,arguments)}catch(w){console.error("THREE.WebGLState:",w)}}function He(){try{a.texImage3D.apply(a,arguments)}catch(w){console.error("THREE.WebGLState:",w)}}function Oe(w){ne.equals(w)===!1&&(a.scissor(w.x,w.y,w.z,w.w),ne.copy(w))}function ke(w){ae.equals(w)===!1&&(a.viewport(w.x,w.y,w.z,w.w),ae.copy(w))}function De(){a.disable(3042),a.disable(2884),a.disable(2929),a.disable(32823),a.disable(3089),a.disable(2960),a.disable(32926),a.blendEquation(32774),a.blendFunc(1,0),a.blendFuncSeparate(1,0,1,0),a.colorMask(!0,!0,!0,!0),a.clearColor(0,0,0,0),a.depthMask(!0),a.depthFunc(513),a.clearDepth(1),a.stencilMask(4294967295),a.stencilFunc(519,0,4294967295),a.stencilOp(7680,7680,7680),a.clearStencil(0),a.cullFace(1029),a.frontFace(2305),a.polygonOffset(0,0),a.activeTexture(33984),a.bindFramebuffer(36160,null),n===!0&&(a.bindFramebuffer(36009,null),a.bindFramebuffer(36008,null)),a.useProgram(null),a.lineWidth(1),a.scissor(0,0,a.canvas.width,a.canvas.height),a.viewport(0,0,a.canvas.width,a.canvas.height),u={},A=null,F={},f=null,h={},d=null,p=!1,v=null,_=null,m=null,g=null,y=null,x=null,S=null,M=!1,E=null,N=null,B=null,V=null,O=null,ne.set(0,0,a.canvas.width,a.canvas.height),ae.set(0,0,a.canvas.width,a.canvas.height),o.reset(),l.reset(),c.reset()}return{buffers:{color:o,depth:l,stencil:c},enable:ge,disable:we,bindFramebuffer:Ge,bindXRFramebuffer:q,useProgram:Te,setBlending:_e,setMaterial:ie,setFlipSided:oe,setCullFace:K,setLineWidth:de,setPolygonOffset:he,setScissorTest:I,activeTexture:P,bindTexture:ee,unbindTexture:pe,compressedTexImage2D:Me,texImage2D:Re,texImage3D:He,scissor:Oe,viewport:ke,reset:De}}function AM(a,e,t,n,r,i,s){const o=r.isWebGL2,l=r.maxTextures,c=r.maxCubemapSize,u=r.maxTextureSize,f=r.maxSamples,h=new WeakMap;let d,p=!1;try{p=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function v(I,P){return p?new OffscreenCanvas(I,P):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function _(I,P,ee,pe){let Me=1;if((I.width>pe||I.height>pe)&&(Me=pe/Math.max(I.width,I.height)),Me<1||P===!0)if(typeof HTMLImageElement<"u"&&I instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&I instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&I instanceof ImageBitmap){const Re=P?jv:Math.floor,He=Re(Me*I.width),Oe=Re(Me*I.height);d===void 0&&(d=v(He,Oe));const ke=ee?v(He,Oe):d;return ke.width=He,ke.height=Oe,ke.getContext("2d").drawImage(I,0,0,He,Oe),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+I.width+"x"+I.height+") to ("+He+"x"+Oe+")."),ke}else return"data"in I&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+I.width+"x"+I.height+")."),I;return I}function m(I){return Mf(I.width)&&Mf(I.height)}function g(I){return o?!1:I.wrapS!==dr||I.wrapT!==dr||I.minFilter!==It&&I.minFilter!==pt}function y(I,P){return I.generateMipmaps&&P&&I.minFilter!==It&&I.minFilter!==pt}function x(I,P,ee,pe,Me=1){a.generateMipmap(I);const Re=n.get(P);Re.__maxMipLevel=Math.log2(Math.max(ee,pe,Me))}function S(I,P,ee){if(o===!1)return P;if(I!==null){if(a[I]!==void 0)return a[I];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+I+"'")}let pe=P;return P===6403&&(ee===5126&&(pe=33326),ee===5131&&(pe=33325),ee===5121&&(pe=33321)),P===6407&&(ee===5126&&(pe=34837),ee===5131&&(pe=34843),ee===5121&&(pe=32849)),P===6408&&(ee===5126&&(pe=34836),ee===5131&&(pe=34842),ee===5121&&(pe=32856)),(pe===33325||pe===33326||pe===34842||pe===34836)&&e.get("EXT_color_buffer_float"),pe}function M(I){return I===It||I===kd||I===Od?9728:9729}function E(I){const P=I.target;P.removeEventListener("dispose",E),B(P),P.isVideoTexture&&h.delete(P),s.memory.textures--}function N(I){const P=I.target;P.removeEventListener("dispose",N),V(P)}function B(I){const P=n.get(I);P.__webglInit!==void 0&&(a.deleteTexture(P.__webglTexture),n.remove(I))}function V(I){const P=I.texture,ee=n.get(I),pe=n.get(P);if(I){if(pe.__webglTexture!==void 0&&(a.deleteTexture(pe.__webglTexture),s.memory.textures--),I.depthTexture&&I.depthTexture.dispose(),I.isWebGLCubeRenderTarget)for(let Me=0;Me<6;Me++)a.deleteFramebuffer(ee.__webglFramebuffer[Me]),ee.__webglDepthbuffer&&a.deleteRenderbuffer(ee.__webglDepthbuffer[Me]);else a.deleteFramebuffer(ee.__webglFramebuffer),ee.__webglDepthbuffer&&a.deleteRenderbuffer(ee.__webglDepthbuffer),ee.__webglMultisampledFramebuffer&&a.deleteFramebuffer(ee.__webglMultisampledFramebuffer),ee.__webglColorRenderbuffer&&a.deleteRenderbuffer(ee.__webglColorRenderbuffer),ee.__webglDepthRenderbuffer&&a.deleteRenderbuffer(ee.__webglDepthRenderbuffer);if(I.isWebGLMultipleRenderTargets)for(let Me=0,Re=P.length;Me<Re;Me++){const He=n.get(P[Me]);He.__webglTexture&&(a.deleteTexture(He.__webglTexture),s.memory.textures--),n.remove(P[Me])}n.remove(P),n.remove(I)}}let O=0;function W(){O=0}function z(){const I=O;return I>=l&&console.warn("THREE.WebGLTextures: Trying to use "+I+" texture units while this GPU supports only "+l),O+=1,I}function C(I,P){const ee=n.get(I);if(I.isVideoTexture&&ie(I),I.version>0&&ee.__version!==I.version){const pe=I.image;if(pe===void 0)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else if(pe.complete===!1)console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete");else{xe(ee,I,P);return}}t.activeTexture(33984+P),t.bindTexture(3553,ee.__webglTexture)}function T(I,P){const ee=n.get(I);if(I.version>0&&ee.__version!==I.version){xe(ee,I,P);return}t.activeTexture(33984+P),t.bindTexture(35866,ee.__webglTexture)}function A(I,P){const ee=n.get(I);if(I.version>0&&ee.__version!==I.version){xe(ee,I,P);return}t.activeTexture(33984+P),t.bindTexture(32879,ee.__webglTexture)}function F(I,P){const ee=n.get(I);if(I.version>0&&ee.__version!==I.version){be(ee,I,P);return}t.activeTexture(33984+P),t.bindTexture(34067,ee.__webglTexture)}const X={[no]:10497,[dr]:33071,[wf]:33648},Y={[It]:9728,[kd]:9984,[Od]:9986,[pt]:9729,[Hy]:9985,[wc]:9987};function ne(I,P,ee){if(ee?(a.texParameteri(I,10242,X[P.wrapS]),a.texParameteri(I,10243,X[P.wrapT]),(I===32879||I===35866)&&a.texParameteri(I,32882,X[P.wrapR]),a.texParameteri(I,10240,Y[P.magFilter]),a.texParameteri(I,10241,Y[P.minFilter])):(a.texParameteri(I,10242,33071),a.texParameteri(I,10243,33071),(I===32879||I===35866)&&a.texParameteri(I,32882,33071),(P.wrapS!==dr||P.wrapT!==dr)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),a.texParameteri(I,10240,M(P.magFilter)),a.texParameteri(I,10241,M(P.minFilter)),P.minFilter!==It&&P.minFilter!==pt&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),e.has("EXT_texture_filter_anisotropic")===!0){const pe=e.get("EXT_texture_filter_anisotropic");if(P.type===yn&&e.has("OES_texture_float_linear")===!1||o===!1&&P.type===Xa&&e.has("OES_texture_half_float_linear")===!1)return;(P.anisotropy>1||n.get(P).__currentAnisotropy)&&(a.texParameterf(I,pe.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(P.anisotropy,r.getMaxAnisotropy())),n.get(P).__currentAnisotropy=P.anisotropy)}}function ae(I,P){I.__webglInit===void 0&&(I.__webglInit=!0,P.addEventListener("dispose",E),I.__webglTexture=a.createTexture(),s.memory.textures++)}function xe(I,P,ee){let pe=3553;P.isDataTexture2DArray&&(pe=35866),P.isDataTexture3D&&(pe=32879),ae(I,P),t.activeTexture(33984+ee),t.bindTexture(pe,I.__webglTexture),a.pixelStorei(37440,P.flipY),a.pixelStorei(37441,P.premultiplyAlpha),a.pixelStorei(3317,P.unpackAlignment),a.pixelStorei(37443,0);const Me=g(P)&&m(P.image)===!1,Re=_(P.image,Me,!1,u),He=m(Re)||o,Oe=i.convert(P.format);let ke=i.convert(P.type),De=S(P.internalFormat,Oe,ke);ne(pe,P,He);let w;const L=P.mipmaps;if(P.isDepthTexture)De=6402,o?P.type===yn?De=36012:P.type===ql?De=33190:P.type===Zs?De=35056:De=33189:P.type===yn&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),P.format===ja&&De===6402&&P.type!==io&&P.type!==ql&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),P.type=io,ke=i.convert(P.type)),P.format===ao&&De===6402&&(De=34041,P.type!==Zs&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),P.type=Zs,ke=i.convert(P.type))),t.texImage2D(3553,0,De,Re.width,Re.height,0,Oe,ke,null);else if(P.isDataTexture)if(L.length>0&&He){for(let R=0,j=L.length;R<j;R++)w=L[R],t.texImage2D(3553,R,De,w.width,w.height,0,Oe,ke,w.data);P.generateMipmaps=!1,I.__maxMipLevel=L.length-1}else t.texImage2D(3553,0,De,Re.width,Re.height,0,Oe,ke,Re.data),I.__maxMipLevel=0;else if(P.isCompressedTexture){for(let R=0,j=L.length;R<j;R++)w=L[R],P.format!==Ft&&P.format!==fi?Oe!==null?t.compressedTexImage2D(3553,R,De,w.width,w.height,0,w.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):t.texImage2D(3553,R,De,w.width,w.height,0,Oe,ke,w.data);I.__maxMipLevel=L.length-1}else if(P.isDataTexture2DArray)t.texImage3D(35866,0,De,Re.width,Re.height,Re.depth,0,Oe,ke,Re.data),I.__maxMipLevel=0;else if(P.isDataTexture3D)t.texImage3D(32879,0,De,Re.width,Re.height,Re.depth,0,Oe,ke,Re.data),I.__maxMipLevel=0;else if(L.length>0&&He){for(let R=0,j=L.length;R<j;R++)w=L[R],t.texImage2D(3553,R,De,Oe,ke,w);P.generateMipmaps=!1,I.__maxMipLevel=L.length-1}else t.texImage2D(3553,0,De,Oe,ke,Re),I.__maxMipLevel=0;y(P,He)&&x(pe,P,Re.width,Re.height),I.__version=P.version,P.onUpdate&&P.onUpdate(P)}function be(I,P,ee){if(P.image.length!==6)return;ae(I,P),t.activeTexture(33984+ee),t.bindTexture(34067,I.__webglTexture),a.pixelStorei(37440,P.flipY),a.pixelStorei(37441,P.premultiplyAlpha),a.pixelStorei(3317,P.unpackAlignment),a.pixelStorei(37443,0);const pe=P&&(P.isCompressedTexture||P.image[0].isCompressedTexture),Me=P.image[0]&&P.image[0].isDataTexture,Re=[];for(let R=0;R<6;R++)!pe&&!Me?Re[R]=_(P.image[R],!1,!0,c):Re[R]=Me?P.image[R].image:P.image[R];const He=Re[0],Oe=m(He)||o,ke=i.convert(P.format),De=i.convert(P.type),w=S(P.internalFormat,ke,De);ne(34067,P,Oe);let L;if(pe){for(let R=0;R<6;R++){L=Re[R].mipmaps;for(let j=0;j<L.length;j++){const U=L[j];P.format!==Ft&&P.format!==fi?ke!==null?t.compressedTexImage2D(34069+R,j,w,U.width,U.height,0,U.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):t.texImage2D(34069+R,j,w,U.width,U.height,0,ke,De,U.data)}}I.__maxMipLevel=L.length-1}else{L=P.mipmaps;for(let R=0;R<6;R++)if(Me){t.texImage2D(34069+R,0,w,Re[R].width,Re[R].height,0,ke,De,Re[R].data);for(let j=0;j<L.length;j++){const me=L[j].image[R].image;t.texImage2D(34069+R,j+1,w,me.width,me.height,0,ke,De,me.data)}}else{t.texImage2D(34069+R,0,w,ke,De,Re[R]);for(let j=0;j<L.length;j++){const U=L[j];t.texImage2D(34069+R,j+1,w,ke,De,U.image[R])}}I.__maxMipLevel=L.length}y(P,Oe)&&x(34067,P,He.width,He.height),I.__version=P.version,P.onUpdate&&P.onUpdate(P)}function ge(I,P,ee,pe,Me){const Re=i.convert(ee.format),He=i.convert(ee.type),Oe=S(ee.internalFormat,Re,He);Me===32879||Me===35866?t.texImage3D(Me,0,Oe,P.width,P.height,P.depth,0,Re,He,null):t.texImage2D(Me,0,Oe,P.width,P.height,0,Re,He,null),t.bindFramebuffer(36160,I),a.framebufferTexture2D(36160,pe,Me,n.get(ee).__webglTexture,0),t.bindFramebuffer(36160,null)}function we(I,P,ee){if(a.bindRenderbuffer(36161,I),P.depthBuffer&&!P.stencilBuffer){let pe=33189;if(ee){const Me=P.depthTexture;Me&&Me.isDepthTexture&&(Me.type===yn?pe=36012:Me.type===ql&&(pe=33190));const Re=_e(P);a.renderbufferStorageMultisample(36161,Re,pe,P.width,P.height)}else a.renderbufferStorage(36161,pe,P.width,P.height);a.framebufferRenderbuffer(36160,36096,36161,I)}else if(P.depthBuffer&&P.stencilBuffer){if(ee){const pe=_e(P);a.renderbufferStorageMultisample(36161,pe,35056,P.width,P.height)}else a.renderbufferStorage(36161,34041,P.width,P.height);a.framebufferRenderbuffer(36160,33306,36161,I)}else{const pe=P.isWebGLMultipleRenderTargets===!0?P.texture[0]:P.texture,Me=i.convert(pe.format),Re=i.convert(pe.type),He=S(pe.internalFormat,Me,Re);if(ee){const Oe=_e(P);a.renderbufferStorageMultisample(36161,Oe,He,P.width,P.height)}else a.renderbufferStorage(36161,He,P.width,P.height)}a.bindRenderbuffer(36161,null)}function q(I,P){if(P&&P.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,I),!(P.depthTexture&&P.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");(!n.get(P.depthTexture).__webglTexture||P.depthTexture.image.width!==P.width||P.depthTexture.image.height!==P.height)&&(P.depthTexture.image.width=P.width,P.depthTexture.image.height=P.height,P.depthTexture.needsUpdate=!0),C(P.depthTexture,0);const pe=n.get(P.depthTexture).__webglTexture;if(P.depthTexture.format===ja)a.framebufferTexture2D(36160,36096,3553,pe,0);else if(P.depthTexture.format===ao)a.framebufferTexture2D(36160,33306,3553,pe,0);else throw new Error("Unknown depthTexture format")}function Ge(I){const P=n.get(I),ee=I.isWebGLCubeRenderTarget===!0;if(I.depthTexture){if(ee)throw new Error("target.depthTexture not supported in Cube render targets");q(P.__webglFramebuffer,I)}else if(ee){P.__webglDepthbuffer=[];for(let pe=0;pe<6;pe++)t.bindFramebuffer(36160,P.__webglFramebuffer[pe]),P.__webglDepthbuffer[pe]=a.createRenderbuffer(),we(P.__webglDepthbuffer[pe],I,!1)}else t.bindFramebuffer(36160,P.__webglFramebuffer),P.__webglDepthbuffer=a.createRenderbuffer(),we(P.__webglDepthbuffer,I,!1);t.bindFramebuffer(36160,null)}function Te(I){const P=I.texture,ee=n.get(I),pe=n.get(P);I.addEventListener("dispose",N),I.isWebGLMultipleRenderTargets!==!0&&(pe.__webglTexture=a.createTexture(),pe.__version=P.version,s.memory.textures++);const Me=I.isWebGLCubeRenderTarget===!0,Re=I.isWebGLMultipleRenderTargets===!0,He=I.isWebGLMultisampleRenderTarget===!0,Oe=P.isDataTexture3D||P.isDataTexture2DArray,ke=m(I)||o;if(o&&P.format===fi&&(P.type===yn||P.type===Xa)&&(P.format=Ft,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),Me){ee.__webglFramebuffer=[];for(let De=0;De<6;De++)ee.__webglFramebuffer[De]=a.createFramebuffer()}else if(ee.__webglFramebuffer=a.createFramebuffer(),Re)if(r.drawBuffers){const De=I.texture;for(let w=0,L=De.length;w<L;w++){const R=n.get(De[w]);R.__webglTexture===void 0&&(R.__webglTexture=a.createTexture(),s.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");else if(He)if(o){ee.__webglMultisampledFramebuffer=a.createFramebuffer(),ee.__webglColorRenderbuffer=a.createRenderbuffer(),a.bindRenderbuffer(36161,ee.__webglColorRenderbuffer);const De=i.convert(P.format),w=i.convert(P.type),L=S(P.internalFormat,De,w),R=_e(I);a.renderbufferStorageMultisample(36161,R,L,I.width,I.height),t.bindFramebuffer(36160,ee.__webglMultisampledFramebuffer),a.framebufferRenderbuffer(36160,36064,36161,ee.__webglColorRenderbuffer),a.bindRenderbuffer(36161,null),I.depthBuffer&&(ee.__webglDepthRenderbuffer=a.createRenderbuffer(),we(ee.__webglDepthRenderbuffer,I,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(Me){t.bindTexture(34067,pe.__webglTexture),ne(34067,P,ke);for(let De=0;De<6;De++)ge(ee.__webglFramebuffer[De],I,P,36064,34069+De);y(P,ke)&&x(34067,P,I.width,I.height),t.bindTexture(34067,null)}else if(Re){const De=I.texture;for(let w=0,L=De.length;w<L;w++){const R=De[w],j=n.get(R);t.bindTexture(3553,j.__webglTexture),ne(3553,R,ke),ge(ee.__webglFramebuffer,I,R,36064+w,3553),y(R,ke)&&x(3553,R,I.width,I.height)}t.bindTexture(3553,null)}else{let De=3553;Oe&&(o?De=P.isDataTexture3D?32879:35866:console.warn("THREE.DataTexture3D and THREE.DataTexture2DArray only supported with WebGL2.")),t.bindTexture(De,pe.__webglTexture),ne(De,P,ke),ge(ee.__webglFramebuffer,I,P,36064,De),y(P,ke)&&x(De,P,I.width,I.height,I.depth),t.bindTexture(De,null)}I.depthBuffer&&Ge(I)}function Pe(I){const P=m(I)||o,ee=I.isWebGLMultipleRenderTargets===!0?I.texture:[I.texture];for(let pe=0,Me=ee.length;pe<Me;pe++){const Re=ee[pe];if(y(Re,P)){const He=I.isWebGLCubeRenderTarget?34067:3553,Oe=n.get(Re).__webglTexture;t.bindTexture(He,Oe),x(He,Re,I.width,I.height),t.bindTexture(He,null)}}}function Ee(I){if(I.isWebGLMultisampleRenderTarget)if(o){const P=I.width,ee=I.height;let pe=16384;I.depthBuffer&&(pe|=256),I.stencilBuffer&&(pe|=1024);const Me=n.get(I);t.bindFramebuffer(36008,Me.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,Me.__webglFramebuffer),a.blitFramebuffer(0,0,P,ee,0,0,P,ee,pe,9728),t.bindFramebuffer(36008,null),t.bindFramebuffer(36009,Me.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")}function _e(I){return o&&I.isWebGLMultisampleRenderTarget?Math.min(f,I.samples):0}function ie(I){const P=s.render.frame;h.get(I)!==P&&(h.set(I,P),I.update())}let oe=!1,K=!1;function de(I,P){I&&I.isWebGLRenderTarget&&(oe===!1&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),oe=!0),I=I.texture),C(I,P)}function he(I,P){I&&I.isWebGLCubeRenderTarget&&(K===!1&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),K=!0),I=I.texture),F(I,P)}this.allocateTextureUnit=z,this.resetTextureUnits=W,this.setTexture2D=C,this.setTexture2DArray=T,this.setTexture3D=A,this.setTextureCube=F,this.setupRenderTarget=Te,this.updateRenderTargetMipmap=Pe,this.updateMultisampleRenderTarget=Ee,this.safeSetTexture2D=de,this.safeSetTextureCube=he}function TM(a,e,t){const n=t.isWebGL2;function r(i){let s;if(i===xi)return 5121;if(i===Yy)return 32819;if(i===qy)return 32820;if(i===$y)return 33635;if(i===Wy)return 5120;if(i===Xy)return 5122;if(i===io)return 5123;if(i===jy)return 5124;if(i===ql)return 5125;if(i===yn)return 5126;if(i===Xa)return n?5131:(s=e.get("OES_texture_half_float"),s!==null?s.HALF_FLOAT_OES:null);if(i===Zy)return 6406;if(i===fi)return 6407;if(i===Ft)return 6408;if(i===Uv)return 6409;if(i===Ky)return 6410;if(i===ja)return 6402;if(i===ao)return 34041;if(i===Qy)return 6403;if(i===e1)return 36244;if(i===t1)return 33319;if(i===r1)return 33320;if(i===n1)return 36248;if(i===i1)return 36249;if(i===Dd||i===Fd||i===Bd||i===zd)if(s=e.get("WEBGL_compressed_texture_s3tc"),s!==null){if(i===Dd)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===Fd)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===Bd)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===zd)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(i===Vd||i===Ud||i===Gd||i===Hd)if(s=e.get("WEBGL_compressed_texture_pvrtc"),s!==null){if(i===Vd)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===Ud)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Gd)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===Hd)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(i===a1)return s=e.get("WEBGL_compressed_texture_etc1"),s!==null?s.COMPRESSED_RGB_ETC1_WEBGL:null;if((i===Wd||i===Xd)&&(s=e.get("WEBGL_compressed_texture_etc"),s!==null)){if(i===Wd)return s.COMPRESSED_RGB8_ETC2;if(i===Xd)return s.COMPRESSED_RGBA8_ETC2_EAC}if(i===s1||i===o1||i===l1||i===c1||i===u1||i===f1||i===h1||i===d1||i===p1||i===m1||i===v1||i===g1||i===_1||i===y1||i===S1||i===b1||i===w1||i===M1||i===E1||i===C1||i===A1||i===T1||i===R1||i===L1||i===P1||i===N1||i===I1||i===k1)return s=e.get("WEBGL_compressed_texture_astc"),s!==null?i:null;if(i===x1)return s=e.get("EXT_texture_compression_bptc"),s!==null?i:null;if(i===Zs)return n?34042:(s=e.get("WEBGL_depth_texture"),s!==null?s.UNSIGNED_INT_24_8_WEBGL:null)}return{convert:r}}class dg extends Bt{constructor(e=[]){super(),this.cameras=e}}dg.prototype.isArrayCamera=!0;class nr extends lt{constructor(){super(),this.type="Group"}}nr.prototype.isGroup=!0;const RM={type:"move"};class Mu{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new nr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new nr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new b,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new b),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new nr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new b,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new b),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,t,n){let r=null,i=null,s=null;const o=this._targetRay,l=this._grip,c=this._hand;if(e&&t.session.visibilityState!=="visible-blurred")if(o!==null&&(r=t.getPose(e.targetRaySpace,n),r!==null&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(RM))),c&&e.hand){s=!0;for(const v of e.hand.values()){const _=t.getJointPose(v,n);if(c.joints[v.jointName]===void 0){const g=new nr;g.matrixAutoUpdate=!1,g.visible=!1,c.joints[v.jointName]=g,c.add(g)}const m=c.joints[v.jointName];_!==null&&(m.matrix.fromArray(_.transform.matrix),m.matrix.decompose(m.position,m.rotation,m.scale),m.jointRadius=_.radius),m.visible=_!==null}const u=c.joints["index-finger-tip"],f=c.joints["thumb-tip"],h=u.position.distanceTo(f.position),d=.02,p=.005;c.inputState.pinching&&h>d+p?(c.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!c.inputState.pinching&&h<=d-p&&(c.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else l!==null&&e.gripSpace&&(i=t.getPose(e.gripSpace,n),i!==null&&(l.matrix.fromArray(i.transform.matrix),l.matrix.decompose(l.position,l.rotation,l.scale),i.linearVelocity?(l.hasLinearVelocity=!0,l.linearVelocity.copy(i.linearVelocity)):l.hasLinearVelocity=!1,i.angularVelocity?(l.hasAngularVelocity=!0,l.angularVelocity.copy(i.angularVelocity)):l.hasAngularVelocity=!1));return o!==null&&(o.visible=r!==null),l!==null&&(l.visible=i!==null),c!==null&&(c.visible=s!==null),this}}class LM extends Ji{constructor(e,t){super();const n=this,r=e.state;let i=null,s=1,o=null,l="local-floor",c=null,u=null,f=null,h=null,d=null;const p=[],v=new Map,_=new Bt;_.layers.enable(1),_.viewport=new ht;const m=new Bt;m.layers.enable(2),m.viewport=new ht;const g=[_,m],y=new dg;y.layers.enable(1),y.layers.enable(2);let x=null,S=null;this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(A){let F=p[A];return F===void 0&&(F=new Mu,p[A]=F),F.getTargetRaySpace()},this.getControllerGrip=function(A){let F=p[A];return F===void 0&&(F=new Mu,p[A]=F),F.getGripSpace()},this.getHand=function(A){let F=p[A];return F===void 0&&(F=new Mu,p[A]=F),F.getHandSpace()};function M(A){const F=v.get(A.inputSource);F&&F.dispatchEvent({type:A.type,data:A.inputSource})}function E(){v.forEach(function(A,F){A.disconnect(F)}),v.clear(),x=null,S=null,r.bindXRFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),T.stop(),n.isPresenting=!1,n.dispatchEvent({type:"sessionend"})}this.setFramebufferScaleFactor=function(A){s=A,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(A){l=A,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return o},this.getSession=function(){return i},this.setSession=async function(A){if(i=A,i!==null){i.addEventListener("select",M),i.addEventListener("selectstart",M),i.addEventListener("selectend",M),i.addEventListener("squeeze",M),i.addEventListener("squeezestart",M),i.addEventListener("squeezeend",M),i.addEventListener("end",E),i.addEventListener("inputsourceschange",N);const F=t.getContextAttributes();if(F.xrCompatible!==!0&&await t.makeXRCompatible(),i.renderState.layers===void 0){const X={antialias:F.antialias,alpha:F.alpha,depth:F.depth,stencil:F.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(i,t,X),i.updateRenderState({baseLayer:d})}else{let X=0;if(F.antialias){const Y={antialias:!0,alpha:F.alpha,depth:F.depth,stencil:F.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(i,t,Y),i.updateRenderState({layers:[d]})}else{F.depth&&(X=F.stencil?34041:6402);const Y={colorFormat:F.alpha?6408:6407,depthFormat:X,scaleFactor:s};u=new XRWebGLBinding(i,t),h=u.createProjectionLayer(Y),f=t.createFramebuffer(),i.updateRenderState({layers:[h]})}}o=await i.requestReferenceSpace(l),T.setContext(i),T.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}};function N(A){const F=i.inputSources;for(let X=0;X<p.length;X++)v.set(F[X],p[X]);for(let X=0;X<A.removed.length;X++){const Y=A.removed[X],ne=v.get(Y);ne&&(ne.dispatchEvent({type:"disconnected",data:Y}),v.delete(Y))}for(let X=0;X<A.added.length;X++){const Y=A.added[X],ne=v.get(Y);ne&&ne.dispatchEvent({type:"connected",data:Y})}}const B=new b,V=new b;function O(A,F,X){B.setFromMatrixPosition(F.matrixWorld),V.setFromMatrixPosition(X.matrixWorld);const Y=B.distanceTo(V),ne=F.projectionMatrix.elements,ae=X.projectionMatrix.elements,xe=ne[14]/(ne[10]-1),be=ne[14]/(ne[10]+1),ge=(ne[9]+1)/ne[5],we=(ne[9]-1)/ne[5],q=(ne[8]-1)/ne[0],Ge=(ae[8]+1)/ae[0],Te=xe*q,Pe=xe*Ge,Ee=Y/(-q+Ge),_e=Ee*-q;F.matrixWorld.decompose(A.position,A.quaternion,A.scale),A.translateX(_e),A.translateZ(Ee),A.matrixWorld.compose(A.position,A.quaternion,A.scale),A.matrixWorldInverse.copy(A.matrixWorld).invert();const ie=xe+Ee,oe=be+Ee,K=Te-_e,de=Pe+(Y-_e),he=ge*be/oe*ie,I=we*be/oe*ie;A.projectionMatrix.makePerspective(K,de,he,I,ie,oe)}function W(A,F){F===null?A.matrixWorld.copy(A.matrix):A.matrixWorld.multiplyMatrices(F.matrixWorld,A.matrix),A.matrixWorldInverse.copy(A.matrixWorld).invert()}this.updateCamera=function(A){if(i===null)return;y.near=m.near=_.near=A.near,y.far=m.far=_.far=A.far,(x!==y.near||S!==y.far)&&(i.updateRenderState({depthNear:y.near,depthFar:y.far}),x=y.near,S=y.far);const F=A.parent,X=y.cameras;W(y,F);for(let ne=0;ne<X.length;ne++)W(X[ne],F);y.matrixWorld.decompose(y.position,y.quaternion,y.scale),A.position.copy(y.position),A.quaternion.copy(y.quaternion),A.scale.copy(y.scale),A.matrix.copy(y.matrix),A.matrixWorld.copy(y.matrixWorld);const Y=A.children;for(let ne=0,ae=Y.length;ne<ae;ne++)Y[ne].updateMatrixWorld(!0);X.length===2?O(y,_,m):y.projectionMatrix.copy(_.projectionMatrix)},this.getCamera=function(){return y},this.getFoveation=function(){if(h!==null)return h.fixedFoveation;if(d!==null)return d.fixedFoveation},this.setFoveation=function(A){h!==null&&(h.fixedFoveation=A),d!==null&&d.fixedFoveation!==void 0&&(d.fixedFoveation=A)};let z=null;function C(A,F){if(c=F.getViewerPose(o),c!==null){const Y=c.views;d!==null&&r.bindXRFramebuffer(d.framebuffer);let ne=!1;Y.length!==y.cameras.length&&(y.cameras.length=0,ne=!0);for(let ae=0;ae<Y.length;ae++){const xe=Y[ae];let be=null;if(d!==null)be=d.getViewport(xe);else{const we=u.getViewSubImage(h,xe);r.bindXRFramebuffer(f),we.depthStencilTexture!==void 0&&t.framebufferTexture2D(36160,36096,3553,we.depthStencilTexture,0),t.framebufferTexture2D(36160,36064,3553,we.colorTexture,0),be=we.viewport}const ge=g[ae];ge.matrix.fromArray(xe.transform.matrix),ge.projectionMatrix.fromArray(xe.projectionMatrix),ge.viewport.set(be.x,be.y,be.width,be.height),ae===0&&y.matrix.copy(ge.matrix),ne===!0&&y.cameras.push(ge)}}const X=i.inputSources;for(let Y=0;Y<p.length;Y++){const ne=p[Y],ae=X[Y];ne.update(ae,F,o)}z&&z(A,F)}const T=new Jv;T.setAnimationLoop(C),this.setAnimationLoop=function(A){z=A},this.dispose=function(){}}}function PM(a){function e(m,g){m.fogColor.value.copy(g.color),g.isFog?(m.fogNear.value=g.near,m.fogFar.value=g.far):g.isFogExp2&&(m.fogDensity.value=g.density)}function t(m,g,y,x,S){g.isMeshBasicMaterial?n(m,g):g.isMeshLambertMaterial?(n(m,g),l(m,g)):g.isMeshToonMaterial?(n(m,g),u(m,g)):g.isMeshPhongMaterial?(n(m,g),c(m,g)):g.isMeshStandardMaterial?(n(m,g),g.isMeshPhysicalMaterial?h(m,g,S):f(m,g)):g.isMeshMatcapMaterial?(n(m,g),d(m,g)):g.isMeshDepthMaterial?(n(m,g),p(m,g)):g.isMeshDistanceMaterial?(n(m,g),v(m,g)):g.isMeshNormalMaterial?(n(m,g),_(m,g)):g.isLineBasicMaterial?(r(m,g),g.isLineDashedMaterial&&i(m,g)):g.isPointsMaterial?s(m,g,y,x):g.isSpriteMaterial?o(m,g):g.isShadowMaterial?(m.color.value.copy(g.color),m.opacity.value=g.opacity):g.isShaderMaterial&&(g.uniformsNeedUpdate=!1)}function n(m,g){m.opacity.value=g.opacity,g.color&&m.diffuse.value.copy(g.color),g.emissive&&m.emissive.value.copy(g.emissive).multiplyScalar(g.emissiveIntensity),g.map&&(m.map.value=g.map),g.alphaMap&&(m.alphaMap.value=g.alphaMap),g.specularMap&&(m.specularMap.value=g.specularMap);const y=a.get(g).envMap;if(y){m.envMap.value=y,m.flipEnvMap.value=y.isCubeTexture&&y.isRenderTargetTexture===!1?-1:1,m.reflectivity.value=g.reflectivity,m.refractionRatio.value=g.refractionRatio;const M=a.get(y).__maxMipLevel;M!==void 0&&(m.maxMipLevel.value=M)}g.lightMap&&(m.lightMap.value=g.lightMap,m.lightMapIntensity.value=g.lightMapIntensity),g.aoMap&&(m.aoMap.value=g.aoMap,m.aoMapIntensity.value=g.aoMapIntensity);let x;g.map?x=g.map:g.specularMap?x=g.specularMap:g.displacementMap?x=g.displacementMap:g.normalMap?x=g.normalMap:g.bumpMap?x=g.bumpMap:g.roughnessMap?x=g.roughnessMap:g.metalnessMap?x=g.metalnessMap:g.alphaMap?x=g.alphaMap:g.emissiveMap?x=g.emissiveMap:g.clearcoatMap?x=g.clearcoatMap:g.clearcoatNormalMap?x=g.clearcoatNormalMap:g.clearcoatRoughnessMap?x=g.clearcoatRoughnessMap:g.specularIntensityMap?x=g.specularIntensityMap:g.specularTintMap&&(x=g.specularTintMap),x!==void 0&&(x.isWebGLRenderTarget&&(x=x.texture),x.matrixAutoUpdate===!0&&x.updateMatrix(),m.uvTransform.value.copy(x.matrix));let S;g.aoMap?S=g.aoMap:g.lightMap&&(S=g.lightMap),S!==void 0&&(S.isWebGLRenderTarget&&(S=S.texture),S.matrixAutoUpdate===!0&&S.updateMatrix(),m.uv2Transform.value.copy(S.matrix))}function r(m,g){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity}function i(m,g){m.dashSize.value=g.dashSize,m.totalSize.value=g.dashSize+g.gapSize,m.scale.value=g.scale}function s(m,g,y,x){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity,m.size.value=g.size*y,m.scale.value=x*.5,g.map&&(m.map.value=g.map),g.alphaMap&&(m.alphaMap.value=g.alphaMap);let S;g.map?S=g.map:g.alphaMap&&(S=g.alphaMap),S!==void 0&&(S.matrixAutoUpdate===!0&&S.updateMatrix(),m.uvTransform.value.copy(S.matrix))}function o(m,g){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity,m.rotation.value=g.rotation,g.map&&(m.map.value=g.map),g.alphaMap&&(m.alphaMap.value=g.alphaMap);let y;g.map?y=g.map:g.alphaMap&&(y=g.alphaMap),y!==void 0&&(y.matrixAutoUpdate===!0&&y.updateMatrix(),m.uvTransform.value.copy(y.matrix))}function l(m,g){g.emissiveMap&&(m.emissiveMap.value=g.emissiveMap)}function c(m,g){m.specular.value.copy(g.specular),m.shininess.value=Math.max(g.shininess,1e-4),g.emissiveMap&&(m.emissiveMap.value=g.emissiveMap),g.bumpMap&&(m.bumpMap.value=g.bumpMap,m.bumpScale.value=g.bumpScale,g.side===Ut&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,m.normalScale.value.copy(g.normalScale),g.side===Ut&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias)}function u(m,g){g.gradientMap&&(m.gradientMap.value=g.gradientMap),g.emissiveMap&&(m.emissiveMap.value=g.emissiveMap),g.bumpMap&&(m.bumpMap.value=g.bumpMap,m.bumpScale.value=g.bumpScale,g.side===Ut&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,m.normalScale.value.copy(g.normalScale),g.side===Ut&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias)}function f(m,g){m.roughness.value=g.roughness,m.metalness.value=g.metalness,g.roughnessMap&&(m.roughnessMap.value=g.roughnessMap),g.metalnessMap&&(m.metalnessMap.value=g.metalnessMap),g.emissiveMap&&(m.emissiveMap.value=g.emissiveMap),g.bumpMap&&(m.bumpMap.value=g.bumpMap,m.bumpScale.value=g.bumpScale,g.side===Ut&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,m.normalScale.value.copy(g.normalScale),g.side===Ut&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias),a.get(g).envMap&&(m.envMapIntensity.value=g.envMapIntensity)}function h(m,g,y){f(m,g),m.reflectivity.value=g.reflectivity,m.clearcoat.value=g.clearcoat,m.clearcoatRoughness.value=g.clearcoatRoughness,g.sheen&&m.sheen.value.copy(g.sheen),g.clearcoatMap&&(m.clearcoatMap.value=g.clearcoatMap),g.clearcoatRoughnessMap&&(m.clearcoatRoughnessMap.value=g.clearcoatRoughnessMap),g.clearcoatNormalMap&&(m.clearcoatNormalScale.value.copy(g.clearcoatNormalScale),m.clearcoatNormalMap.value=g.clearcoatNormalMap,g.side===Ut&&m.clearcoatNormalScale.value.negate()),m.transmission.value=g.transmission,g.transmissionMap&&(m.transmissionMap.value=g.transmissionMap),g.transmission>0&&(m.transmissionSamplerMap.value=y.texture,m.transmissionSamplerSize.value.set(y.width,y.height)),m.thickness.value=g.thickness,g.thicknessMap&&(m.thicknessMap.value=g.thicknessMap),m.attenuationDistance.value=g.attenuationDistance,m.attenuationTint.value.copy(g.attenuationTint),m.specularIntensity.value=g.specularIntensity,m.specularTint.value.copy(g.specularTint),g.specularIntensityMap&&(m.specularIntensityMap.value=g.specularIntensityMap),g.specularTintMap&&(m.specularTintMap.value=g.specularTintMap)}function d(m,g){g.matcap&&(m.matcap.value=g.matcap),g.bumpMap&&(m.bumpMap.value=g.bumpMap,m.bumpScale.value=g.bumpScale,g.side===Ut&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,m.normalScale.value.copy(g.normalScale),g.side===Ut&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias)}function p(m,g){g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias)}function v(m,g){g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias),m.referencePosition.value.copy(g.referencePosition),m.nearDistance.value=g.nearDistance,m.farDistance.value=g.farDistance}function _(m,g){g.bumpMap&&(m.bumpMap.value=g.bumpMap,m.bumpScale.value=g.bumpScale,g.side===Ut&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,m.normalScale.value.copy(g.normalScale),g.side===Ut&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias)}return{refreshFogUniforms:e,refreshMaterialUniforms:t}}function NM(){const a=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return a.style.display="block",a}function mt(a={}){const e=a.canvas!==void 0?a.canvas:NM(),t=a.context!==void 0?a.context:null,n=a.alpha!==void 0?a.alpha:!1,r=a.depth!==void 0?a.depth:!0,i=a.stencil!==void 0?a.stencil:!0,s=a.antialias!==void 0?a.antialias:!1,o=a.premultipliedAlpha!==void 0?a.premultipliedAlpha:!0,l=a.preserveDrawingBuffer!==void 0?a.preserveDrawingBuffer:!1,c=a.powerPreference!==void 0?a.powerPreference:"default",u=a.failIfMajorPerformanceCaveat!==void 0?a.failIfMajorPerformanceCaveat:!1;let f=null,h=null;const d=[],p=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=Cr,this.physicallyCorrectLights=!1,this.toneMapping=Hi,this.toneMappingExposure=1;const v=this;let _=!1,m=0,g=0,y=null,x=-1,S=null;const M=new ht,E=new ht;let N=null,B=e.width,V=e.height,O=1,W=null,z=null;const C=new ht(0,0,B,V),T=new ht(0,0,B,V);let A=!1;const F=[],X=new Ac;let Y=!1,ne=!1,ae=null;const xe=new Ce,be=new b,ge={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function we(){return y===null?O:1}let q=t;function Ge(k,te){for(let J=0;J<k.length;J++){const se=k[J],Ae=e.getContext(se,te);if(Ae!==null)return Ae}return null}try{const k={alpha:n,depth:r,stencil:i,antialias:s,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:u};if(e.addEventListener("webglcontextlost",ye,!1),e.addEventListener("webglcontextrestored",Ne,!1),q===null){const te=["webgl2","webgl","experimental-webgl"];if(v.isWebGL1Renderer===!0&&te.shift(),q=Ge(te,k),q===null)throw Ge(te)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}q.getShaderPrecisionFormat===void 0&&(q.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(k){throw console.error("THREE.WebGLRenderer: "+k.message),k}let Te,Pe,Ee,_e,ie,oe,K,de,he,I,P,ee,pe,Me,Re,He,Oe,ke,De,w,L,R,j;function U(){Te=new tw(q),Pe=new jb(q,Te,a),Te.init(Pe),R=new TM(q,Te,Pe),Ee=new CM(q,Te,Pe),F[0]=1029,_e=new iw,ie=new mM,oe=new AM(q,Te,Ee,ie,Pe,R,_e),K=new qb(v),de=new ew(v),he=new Sx(q,Pe),j=new Wb(q,Te,he,Pe),I=new rw(q,he,_e,j),P=new lw(q,I,he,_e),De=new ow(q),He=new Yb(ie),ee=new pM(v,K,de,Te,Pe,j,He),pe=new PM(ie),Me=new gM(ie),Re=new wM(Te,Pe),ke=new Hb(v,K,Ee,P,o),Oe=new hg(v,P,Pe),w=new Xb(q,Te,_e,Pe),L=new nw(q,Te,_e,Pe),_e.programs=ee.programs,v.capabilities=Pe,v.extensions=Te,v.properties=ie,v.renderLists=Me,v.shadowMap=Oe,v.state=Ee,v.info=_e}U();const me=new LM(v,q);this.xr=me,this.getContext=function(){return q},this.getContextAttributes=function(){return q.getContextAttributes()},this.forceContextLoss=function(){const k=Te.get("WEBGL_lose_context");k&&k.loseContext()},this.forceContextRestore=function(){const k=Te.get("WEBGL_lose_context");k&&k.restoreContext()},this.getPixelRatio=function(){return O},this.setPixelRatio=function(k){k!==void 0&&(O=k,this.setSize(B,V,!1))},this.getSize=function(k){return k.set(B,V)},this.setSize=function(k,te,J){if(me.isPresenting){console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting.");return}B=k,V=te,e.width=Math.floor(k*O),e.height=Math.floor(te*O),J!==!1&&(e.style.width=k+"px",e.style.height=te+"px"),this.setViewport(0,0,k,te)},this.getDrawingBufferSize=function(k){return k.set(B*O,V*O).floor()},this.setDrawingBufferSize=function(k,te,J){B=k,V=te,O=J,e.width=Math.floor(k*J),e.height=Math.floor(te*J),this.setViewport(0,0,k,te)},this.getCurrentViewport=function(k){return k.copy(M)},this.getViewport=function(k){return k.copy(C)},this.setViewport=function(k,te,J,se){k.isVector4?C.set(k.x,k.y,k.z,k.w):C.set(k,te,J,se),Ee.viewport(M.copy(C).multiplyScalar(O).floor())},this.getScissor=function(k){return k.copy(T)},this.setScissor=function(k,te,J,se){k.isVector4?T.set(k.x,k.y,k.z,k.w):T.set(k,te,J,se),Ee.scissor(E.copy(T).multiplyScalar(O).floor())},this.getScissorTest=function(){return A},this.setScissorTest=function(k){Ee.setScissorTest(A=k)},this.setOpaqueSort=function(k){W=k},this.setTransparentSort=function(k){z=k},this.getClearColor=function(k){return k.copy(ke.getClearColor())},this.setClearColor=function(){ke.setClearColor.apply(ke,arguments)},this.getClearAlpha=function(){return ke.getClearAlpha()},this.setClearAlpha=function(){ke.setClearAlpha.apply(ke,arguments)},this.clear=function(k,te,J){let se=0;(k===void 0||k)&&(se|=16384),(te===void 0||te)&&(se|=256),(J===void 0||J)&&(se|=1024),q.clear(se)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",ye,!1),e.removeEventListener("webglcontextrestored",Ne,!1),Me.dispose(),Re.dispose(),ie.dispose(),K.dispose(),de.dispose(),P.dispose(),j.dispose(),me.dispose(),me.removeEventListener("sessionstart",Fe),me.removeEventListener("sessionend",Xe),ae&&(ae.dispose(),ae=null),$.stop()};function ye(k){k.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),_=!0}function Ne(){console.log("THREE.WebGLRenderer: Context Restored."),_=!1;const k=_e.autoReset,te=Oe.enabled,J=Oe.autoUpdate,se=Oe.needsUpdate,Ae=Oe.type;U(),_e.autoReset=k,Oe.enabled=te,Oe.autoUpdate=J,Oe.needsUpdate=se,Oe.type=Ae}function Ve(k){const te=k.target;te.removeEventListener("dispose",Ve),Ie(te)}function Ie(k){et(k),ie.remove(k)}function et(k){const te=ie.get(k).programs;te!==void 0&&te.forEach(function(J){ee.releaseProgram(J)})}function gt(k,te){k.render(function(J){v.renderBufferImmediate(J,te)})}this.renderBufferImmediate=function(k,te){j.initAttributes();const J=ie.get(k);k.hasPositions&&!J.position&&(J.position=q.createBuffer()),k.hasNormals&&!J.normal&&(J.normal=q.createBuffer()),k.hasUvs&&!J.uv&&(J.uv=q.createBuffer()),k.hasColors&&!J.color&&(J.color=q.createBuffer());const se=te.getAttributes();k.hasPositions&&(q.bindBuffer(34962,J.position),q.bufferData(34962,k.positionArray,35048),j.enableAttribute(se.position),q.vertexAttribPointer(se.position,3,5126,!1,0,0)),k.hasNormals&&(q.bindBuffer(34962,J.normal),q.bufferData(34962,k.normalArray,35048),j.enableAttribute(se.normal),q.vertexAttribPointer(se.normal,3,5126,!1,0,0)),k.hasUvs&&(q.bindBuffer(34962,J.uv),q.bufferData(34962,k.uvArray,35048),j.enableAttribute(se.uv),q.vertexAttribPointer(se.uv,2,5126,!1,0,0)),k.hasColors&&(q.bindBuffer(34962,J.color),q.bufferData(34962,k.colorArray,35048),j.enableAttribute(se.color),q.vertexAttribPointer(se.color,3,5126,!1,0,0)),j.disableUnusedAttributes(),q.drawArrays(4,0,k.count),k.count=0},this.renderBufferDirect=function(k,te,J,se,Ae,Qe){te===null&&(te=ge);const je=Ae.isMesh&&Ae.matrixWorld.determinant()<0,We=Hr(k,te,se,Ae);Ee.setMaterial(se,je);let $e=J.index;const tt=J.attributes.position;if($e===null){if(tt===void 0||tt.count===0)return}else if($e.count===0)return;let Ke=1;se.wireframe===!0&&($e=I.getWireframeAttribute(J),Ke=2),(J.morphAttributes.position!==void 0||J.morphAttributes.normal!==void 0)&&De.update(Ae,J,se,We),j.setup(Ae,se,We,J,$e);let it,Ye=w;$e!==null&&(it=he.get($e),Ye=L,Ye.setIndex(it));const lr=$e!==null?$e.count:tt.count,vt=J.drawRange.start*Ke,cr=J.drawRange.count*Ke,At=Qe!==null?Qe.start*Ke:0,pn=Qe!==null?Qe.count*Ke:1/0,Jr=Math.max(vt,At),Ot=Math.min(lr,vt+cr,At+pn)-1,_r=Math.max(0,Ot-Jr+1);if(_r!==0){if(Ae.isMesh)se.wireframe===!0?(Ee.setLineWidth(se.wireframeLinewidth*we()),Ye.setMode(1)):Ye.setMode(4);else if(Ae.isLine){let $t=se.linewidth;$t===void 0&&($t=1),Ee.setLineWidth($t*we()),Ae.isLineSegments?Ye.setMode(1):Ae.isLineLoop?Ye.setMode(2):Ye.setMode(3)}else Ae.isPoints?Ye.setMode(0):Ae.isSprite&&Ye.setMode(4);if(Ae.isInstancedMesh)Ye.renderInstances(Jr,_r,Ae.count);else if(J.isInstancedBufferGeometry){const $t=Math.min(J.instanceCount,J._maxInstanceCount);Ye.renderInstances(Jr,_r,$t)}else Ye.render(Jr,_r)}},this.compile=function(k,te){h=Re.get(k),h.init(),p.push(h),k.traverseVisible(function(J){J.isLight&&J.layers.test(te.layers)&&(h.pushLight(J),J.castShadow&&h.pushShadow(J))}),h.setupLights(),k.traverse(function(J){const se=J.material;if(se)if(Array.isArray(se))for(let Ae=0;Ae<se.length;Ae++){const Qe=se[Ae];_t(Qe,k,J)}else _t(se,k,J)}),p.pop(),h=null};let Mt=null;function ot(k){Mt&&Mt(k)}function Fe(){$.stop()}function Xe(){$.start()}const $=new Jv;$.setAnimationLoop(ot),typeof window<"u"&&$.setContext(window),this.setAnimationLoop=function(k){Mt=k,me.setAnimationLoop(k),k===null?$.stop():$.start()},me.addEventListener("sessionstart",Fe),me.addEventListener("sessionend",Xe),this.render=function(k,te){if(te!==void 0&&te.isCamera!==!0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(_===!0)return;k.autoUpdate===!0&&k.updateMatrixWorld(),te.parent===null&&te.updateMatrixWorld(),me.enabled===!0&&me.isPresenting===!0&&(me.cameraAutoUpdate===!0&&me.updateCamera(te),te=me.getCamera()),k.isScene===!0&&k.onBeforeRender(v,k,te,y),h=Re.get(k,p.length),h.init(),p.push(h),xe.multiplyMatrices(te.projectionMatrix,te.matrixWorldInverse),X.setFromProjectionMatrix(xe),ne=this.localClippingEnabled,Y=He.init(this.clippingPlanes,ne,te),f=Me.get(k,d.length),f.init(),d.push(f),nt(k,te,0,v.sortObjects),f.finish(),v.sortObjects===!0&&f.sort(W,z),Y===!0&&He.beginShadows();const J=h.state.shadowsArray;Oe.render(J,k,te),h.setupLights(),h.setupLightsView(te),Y===!0&&He.endShadows(),this.info.autoReset===!0&&this.info.reset(),ke.render(f,k);const se=f.opaque,Ae=f.transmissive,Qe=f.transparent;se.length>0&&ut(se,k,te),Ae.length>0&&Z(se,Ae,k,te),Qe.length>0&&ut(Qe,k,te),y!==null&&(oe.updateMultisampleRenderTarget(y),oe.updateRenderTargetMipmap(y)),k.isScene===!0&&k.onAfterRender(v,k,te),Ee.buffers.depth.setTest(!0),Ee.buffers.depth.setMask(!0),Ee.buffers.color.setMask(!0),Ee.setPolygonOffset(!1),j.resetDefaultState(),x=-1,S=null,p.pop(),p.length>0?h=p[p.length-1]:h=null,d.pop(),d.length>0?f=d[d.length-1]:f=null};function nt(k,te,J,se){if(k.visible===!1)return;if(k.layers.test(te.layers)){if(k.isGroup)J=k.renderOrder;else if(k.isLOD)k.autoUpdate===!0&&k.update(te);else if(k.isLight)h.pushLight(k),k.castShadow&&h.pushShadow(k);else if(k.isSprite){if(!k.frustumCulled||X.intersectsSprite(k)){se&&be.setFromMatrixPosition(k.matrixWorld).applyMatrix4(xe);const je=P.update(k),We=k.material;We.visible&&f.push(k,je,We,J,be.z,null)}}else if(k.isImmediateRenderObject)se&&be.setFromMatrixPosition(k.matrixWorld).applyMatrix4(xe),f.push(k,null,k.material,J,be.z,null);else if((k.isMesh||k.isLine||k.isPoints)&&(k.isSkinnedMesh&&k.skeleton.frame!==_e.render.frame&&(k.skeleton.update(),k.skeleton.frame=_e.render.frame),!k.frustumCulled||X.intersectsObject(k))){se&&be.setFromMatrixPosition(k.matrixWorld).applyMatrix4(xe);const je=P.update(k),We=k.material;if(Array.isArray(We)){const $e=je.groups;for(let tt=0,Ke=$e.length;tt<Ke;tt++){const it=$e[tt],Ye=We[it.materialIndex];Ye&&Ye.visible&&f.push(k,je,Ye,J,be.z,it)}}else We.visible&&f.push(k,je,We,J,be.z,null)}}const Qe=k.children;for(let je=0,We=Qe.length;je<We;je++)nt(Qe[je],te,J,se)}function Z(k,te,J,se){if(ae===null){const We=s===!0&&Pe.isWebGL2===!0?Yv:Gt;ae=new We(1024,1024,{generateMipmaps:!0,type:R.convert(Xa)!==null?Xa:xi,minFilter:wc,magFilter:It,wrapS:dr,wrapT:dr})}const Ae=v.getRenderTarget();v.setRenderTarget(ae),v.clear();const Qe=v.toneMapping;v.toneMapping=Hi,ut(k,J,se),v.toneMapping=Qe,oe.updateMultisampleRenderTarget(ae),oe.updateRenderTargetMipmap(ae),v.setRenderTarget(Ae),ut(te,J,se)}function ut(k,te,J){const se=te.isScene===!0?te.overrideMaterial:null;if(J.isArrayCamera){const Ae=J.cameras;for(let Qe=0,je=Ae.length;Qe<je;Qe++){const We=Ae[Qe];Ee.viewport(M.copy(We.viewport)),h.setupLightsView(We);for(let $e=0,tt=k.length;$e<tt;$e++){const Ke=k[$e],it=Ke.object,Ye=Ke.geometry,lr=se===null?Ke.material:se,vt=Ke.group;it.layers.test(We.layers)&&ce(it,te,We,Ye,lr,vt)}}}else for(let Ae=0,Qe=k.length;Ae<Qe;Ae++){const je=k[Ae],We=je.object,$e=je.geometry,tt=se===null?je.material:se,Ke=je.group;ce(We,te,J,$e,tt,Ke)}}function ce(k,te,J,se,Ae,Qe){if(k.onBeforeRender(v,te,J,se,Ae,Qe),k.modelViewMatrix.multiplyMatrices(J.matrixWorldInverse,k.matrixWorld),k.normalMatrix.getNormalMatrix(k.modelViewMatrix),k.isImmediateRenderObject){const je=Hr(J,te,Ae,k);Ee.setMaterial(Ae),j.reset(),gt(k,je)}else Ae.transparent===!0&&Ae.side===Yi?(Ae.side=Ut,Ae.needsUpdate=!0,v.renderBufferDirect(J,te,se,Ae,k,Qe),Ae.side=ji,Ae.needsUpdate=!0,v.renderBufferDirect(J,te,se,Ae,k,Qe),Ae.side=Yi):v.renderBufferDirect(J,te,se,Ae,k,Qe);k.onAfterRender(v,te,J,se,Ae,Qe)}function _t(k,te,J){te.isScene!==!0&&(te=ge);const se=ie.get(k),Ae=h.state.lights,Qe=h.state.shadowsArray,je=Ae.state.version,We=ee.getParameters(k,Ae.state,Qe,te,J),$e=ee.getProgramCacheKey(We);let tt=se.programs;se.environment=k.isMeshStandardMaterial?te.environment:null,se.fog=te.fog,se.envMap=(k.isMeshStandardMaterial?de:K).get(k.envMap||se.environment),tt===void 0&&(k.addEventListener("dispose",Ve),tt=new Map,se.programs=tt);let Ke=tt.get($e);if(Ke!==void 0){if(se.currentProgram===Ke&&se.lightsStateVersion===je)return Ct(k,We),Ke}else We.uniforms=ee.getUniforms(k),k.onBuild(We,v),k.onBeforeCompile(We,v),Ke=ee.acquireProgram(We,$e),tt.set($e,Ke),se.uniforms=We.uniforms;const it=se.uniforms;(!k.isShaderMaterial&&!k.isRawShaderMaterial||k.clipping===!0)&&(it.clippingPlanes=He.uniform),Ct(k,We),se.needsLights=or(k),se.lightsStateVersion=je,se.needsLights&&(it.ambientLightColor.value=Ae.state.ambient,it.lightProbe.value=Ae.state.probe,it.directionalLights.value=Ae.state.directional,it.directionalLightShadows.value=Ae.state.directionalShadow,it.spotLights.value=Ae.state.spot,it.spotLightShadows.value=Ae.state.spotShadow,it.rectAreaLights.value=Ae.state.rectArea,it.ltc_1.value=Ae.state.rectAreaLTC1,it.ltc_2.value=Ae.state.rectAreaLTC2,it.pointLights.value=Ae.state.point,it.pointLightShadows.value=Ae.state.pointShadow,it.hemisphereLights.value=Ae.state.hemi,it.directionalShadowMap.value=Ae.state.directionalShadowMap,it.directionalShadowMatrix.value=Ae.state.directionalShadowMatrix,it.spotShadowMap.value=Ae.state.spotShadowMap,it.spotShadowMatrix.value=Ae.state.spotShadowMatrix,it.pointShadowMap.value=Ae.state.pointShadowMap,it.pointShadowMatrix.value=Ae.state.pointShadowMatrix);const Ye=Ke.getUniforms(),lr=di.seqWithValue(Ye.seq,it);return se.currentProgram=Ke,se.uniformsList=lr,Ke}function Ct(k,te){const J=ie.get(k);J.outputEncoding=te.outputEncoding,J.instancing=te.instancing,J.skinning=te.skinning,J.morphTargets=te.morphTargets,J.morphNormals=te.morphNormals,J.numClippingPlanes=te.numClippingPlanes,J.numIntersection=te.numClipIntersection,J.vertexAlphas=te.vertexAlphas,J.vertexTangents=te.vertexTangents}function Hr(k,te,J,se){te.isScene!==!0&&(te=ge),oe.resetTextureUnits();const Ae=te.fog,Qe=J.isMeshStandardMaterial?te.environment:null,je=y===null?v.outputEncoding:y.texture.encoding,We=(J.isMeshStandardMaterial?de:K).get(J.envMap||Qe),$e=J.vertexColors===!0&&!!se.geometry&&!!se.geometry.attributes.color&&se.geometry.attributes.color.itemSize===4,tt=!!se.geometry&&!!se.geometry.attributes.tangent,Ke=!!se.geometry&&!!se.geometry.morphAttributes.position,it=!!se.geometry&&!!se.geometry.morphAttributes.normal,Ye=ie.get(J),lr=h.state.lights;if(Y===!0&&(ne===!0||k!==S)){const $t=k===S&&J.id===x;He.setState(J,k,$t)}let vt=!1;J.version===Ye.__version?(Ye.needsLights&&Ye.lightsStateVersion!==lr.state.version||Ye.outputEncoding!==je||se.isInstancedMesh&&Ye.instancing===!1||!se.isInstancedMesh&&Ye.instancing===!0||se.isSkinnedMesh&&Ye.skinning===!1||!se.isSkinnedMesh&&Ye.skinning===!0||Ye.envMap!==We||J.fog&&Ye.fog!==Ae||Ye.numClippingPlanes!==void 0&&(Ye.numClippingPlanes!==He.numPlanes||Ye.numIntersection!==He.numIntersection)||Ye.vertexAlphas!==$e||Ye.vertexTangents!==tt||Ye.morphTargets!==Ke||Ye.morphNormals!==it)&&(vt=!0):(vt=!0,Ye.__version=J.version);let cr=Ye.currentProgram;vt===!0&&(cr=_t(J,te,se));let At=!1,pn=!1,Jr=!1;const Ot=cr.getUniforms(),_r=Ye.uniforms;if(Ee.useProgram(cr.program)&&(At=!0,pn=!0,Jr=!0),J.id!==x&&(x=J.id,pn=!0),At||S!==k){if(Ot.setValue(q,"projectionMatrix",k.projectionMatrix),Pe.logarithmicDepthBuffer&&Ot.setValue(q,"logDepthBufFC",2/(Math.log(k.far+1)/Math.LN2)),S!==k&&(S=k,pn=!0,Jr=!0),J.isShaderMaterial||J.isMeshPhongMaterial||J.isMeshToonMaterial||J.isMeshStandardMaterial||J.envMap){const $t=Ot.map.cameraPosition;$t!==void 0&&$t.setValue(q,be.setFromMatrixPosition(k.matrixWorld))}(J.isMeshPhongMaterial||J.isMeshToonMaterial||J.isMeshLambertMaterial||J.isMeshBasicMaterial||J.isMeshStandardMaterial||J.isShaderMaterial)&&Ot.setValue(q,"isOrthographic",k.isOrthographicCamera===!0),(J.isMeshPhongMaterial||J.isMeshToonMaterial||J.isMeshLambertMaterial||J.isMeshBasicMaterial||J.isMeshStandardMaterial||J.isShaderMaterial||J.isShadowMaterial||se.isSkinnedMesh)&&Ot.setValue(q,"viewMatrix",k.matrixWorldInverse)}if(se.isSkinnedMesh){Ot.setOptional(q,se,"bindMatrix"),Ot.setOptional(q,se,"bindMatrixInverse");const $t=se.skeleton;$t&&(Pe.floatVertexTextures?($t.boneTexture===null&&$t.computeBoneTexture(),Ot.setValue(q,"boneTexture",$t.boneTexture,oe),Ot.setValue(q,"boneTextureSize",$t.boneTextureSize)):Ot.setOptional(q,$t,"boneMatrices"))}return(pn||Ye.receiveShadow!==se.receiveShadow)&&(Ye.receiveShadow=se.receiveShadow,Ot.setValue(q,"receiveShadow",se.receiveShadow)),pn&&(Ot.setValue(q,"toneMappingExposure",v.toneMappingExposure),Ye.needsLights&&Wr(_r,Jr),Ae&&J.fog&&pe.refreshFogUniforms(_r,Ae),pe.refreshMaterialUniforms(_r,J,O,V,ae),di.upload(q,Ye.uniformsList,_r,oe)),J.isShaderMaterial&&J.uniformsNeedUpdate===!0&&(di.upload(q,Ye.uniformsList,_r,oe),J.uniformsNeedUpdate=!1),J.isSpriteMaterial&&Ot.setValue(q,"center",se.center),Ot.setValue(q,"modelViewMatrix",se.modelViewMatrix),Ot.setValue(q,"normalMatrix",se.normalMatrix),Ot.setValue(q,"modelMatrix",se.matrixWorld),cr}function Wr(k,te){k.ambientLightColor.needsUpdate=te,k.lightProbe.needsUpdate=te,k.directionalLights.needsUpdate=te,k.directionalLightShadows.needsUpdate=te,k.pointLights.needsUpdate=te,k.pointLightShadows.needsUpdate=te,k.spotLights.needsUpdate=te,k.spotLightShadows.needsUpdate=te,k.rectAreaLights.needsUpdate=te,k.hemisphereLights.needsUpdate=te}function or(k){return k.isMeshLambertMaterial||k.isMeshToonMaterial||k.isMeshPhongMaterial||k.isMeshStandardMaterial||k.isShadowMaterial||k.isShaderMaterial&&k.lights===!0}this.getActiveCubeFace=function(){return m},this.getActiveMipmapLevel=function(){return g},this.getRenderTarget=function(){return y},this.setRenderTarget=function(k,te=0,J=0){y=k,m=te,g=J,k&&ie.get(k).__webglFramebuffer===void 0&&oe.setupRenderTarget(k);let se=null,Ae=!1,Qe=!1;if(k){const We=k.texture;(We.isDataTexture3D||We.isDataTexture2DArray)&&(Qe=!0);const $e=ie.get(k).__webglFramebuffer;k.isWebGLCubeRenderTarget?(se=$e[te],Ae=!0):k.isWebGLMultisampleRenderTarget?se=ie.get(k).__webglMultisampledFramebuffer:se=$e,M.copy(k.viewport),E.copy(k.scissor),N=k.scissorTest}else M.copy(C).multiplyScalar(O).floor(),E.copy(T).multiplyScalar(O).floor(),N=A;if(Ee.bindFramebuffer(36160,se)&&Pe.drawBuffers){let We=!1;if(k)if(k.isWebGLMultipleRenderTargets){const $e=k.texture;if(F.length!==$e.length||F[0]!==36064){for(let tt=0,Ke=$e.length;tt<Ke;tt++)F[tt]=36064+tt;F.length=$e.length,We=!0}}else(F.length!==1||F[0]!==36064)&&(F[0]=36064,F.length=1,We=!0);else(F.length!==1||F[0]!==1029)&&(F[0]=1029,F.length=1,We=!0);We&&(Pe.isWebGL2?q.drawBuffers(F):Te.get("WEBGL_draw_buffers").drawBuffersWEBGL(F))}if(Ee.viewport(M),Ee.scissor(E),Ee.setScissorTest(N),Ae){const We=ie.get(k.texture);q.framebufferTexture2D(36160,36064,34069+te,We.__webglTexture,J)}else if(Qe){const We=ie.get(k.texture),$e=te||0;q.framebufferTextureLayer(36160,36064,We.__webglTexture,J||0,$e)}},this.readRenderTargetPixels=function(k,te,J,se,Ae,Qe,je){if(!(k&&k.isWebGLRenderTarget)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let We=ie.get(k).__webglFramebuffer;if(k.isWebGLCubeRenderTarget&&je!==void 0&&(We=We[je]),We){Ee.bindFramebuffer(36160,We);try{const $e=k.texture,tt=$e.format,Ke=$e.type;if(tt!==Ft&&R.convert(tt)!==q.getParameter(35739)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}const it=Ke===Xa&&(Te.has("EXT_color_buffer_half_float")||Pe.isWebGL2&&Te.has("EXT_color_buffer_float"));if(Ke!==xi&&R.convert(Ke)!==q.getParameter(35738)&&!(Ke===yn&&(Pe.isWebGL2||Te.has("OES_texture_float")||Te.has("WEBGL_color_buffer_float")))&&!it){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}q.checkFramebufferStatus(36160)===36053?te>=0&&te<=k.width-se&&J>=0&&J<=k.height-Ae&&q.readPixels(te,J,se,Ae,R.convert(tt),R.convert(Ke),Qe):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{const $e=y!==null?ie.get(y).__webglFramebuffer:null;Ee.bindFramebuffer(36160,$e)}}},this.copyFramebufferToTexture=function(k,te,J=0){const se=Math.pow(2,-J),Ae=Math.floor(te.image.width*se),Qe=Math.floor(te.image.height*se);let je=R.convert(te.format);Pe.isWebGL2&&(je===6407&&(je=32849),je===6408&&(je=32856)),oe.setTexture2D(te,0),q.copyTexImage2D(3553,J,je,k.x,k.y,Ae,Qe,0),Ee.unbindTexture()},this.copyTextureToTexture=function(k,te,J,se=0){const Ae=te.image.width,Qe=te.image.height,je=R.convert(J.format),We=R.convert(J.type);oe.setTexture2D(J,0),q.pixelStorei(37440,J.flipY),q.pixelStorei(37441,J.premultiplyAlpha),q.pixelStorei(3317,J.unpackAlignment),te.isDataTexture?q.texSubImage2D(3553,se,k.x,k.y,Ae,Qe,je,We,te.image.data):te.isCompressedTexture?q.compressedTexSubImage2D(3553,se,k.x,k.y,te.mipmaps[0].width,te.mipmaps[0].height,je,te.mipmaps[0].data):q.texSubImage2D(3553,se,k.x,k.y,je,We,te.image),se===0&&J.generateMipmaps&&q.generateMipmap(3553),Ee.unbindTexture()},this.copyTextureToTexture3D=function(k,te,J,se,Ae=0){if(v.isWebGL1Renderer){console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");return}const Qe=k.max.x-k.min.x+1,je=k.max.y-k.min.y+1,We=k.max.z-k.min.z+1,$e=R.convert(se.format),tt=R.convert(se.type);let Ke;if(se.isDataTexture3D)oe.setTexture3D(se,0),Ke=32879;else if(se.isDataTexture2DArray)oe.setTexture2DArray(se,0),Ke=35866;else{console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");return}q.pixelStorei(37440,se.flipY),q.pixelStorei(37441,se.premultiplyAlpha),q.pixelStorei(3317,se.unpackAlignment);const it=q.getParameter(3314),Ye=q.getParameter(32878),lr=q.getParameter(3316),vt=q.getParameter(3315),cr=q.getParameter(32877),At=J.isCompressedTexture?J.mipmaps[0]:J.image;q.pixelStorei(3314,At.width),q.pixelStorei(32878,At.height),q.pixelStorei(3316,k.min.x),q.pixelStorei(3315,k.min.y),q.pixelStorei(32877,k.min.z),J.isDataTexture||J.isDataTexture3D?q.texSubImage3D(Ke,Ae,te.x,te.y,te.z,Qe,je,We,$e,tt,At.data):J.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),q.compressedTexSubImage3D(Ke,Ae,te.x,te.y,te.z,Qe,je,We,$e,At.data)):q.texSubImage3D(Ke,Ae,te.x,te.y,te.z,Qe,je,We,$e,tt,At),q.pixelStorei(3314,it),q.pixelStorei(32878,Ye),q.pixelStorei(3316,lr),q.pixelStorei(3315,vt),q.pixelStorei(32877,cr),Ae===0&&se.generateMipmaps&&q.generateMipmap(Ke),Ee.unbindTexture()},this.initTexture=function(k){oe.setTexture2D(k,0),Ee.unbindTexture()},this.resetState=function(){m=0,g=0,y=null,Ee.reset(),j.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}class pg extends mt{}pg.prototype.isWebGL1Renderer=!0;class lo{constructor(e,t=1,n=1e3){this.name="",this.color=new ze(e),this.near=t,this.far=n}clone(){return new lo(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}lo.prototype.isFog=!0;class pi extends lt{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return this.fog!==null&&(t.object.fog=this.fog.toJSON()),t}}pi.prototype.isScene=!0;class bo{constructor(e,t){this.array=e,this.stride=t,this.count=e!==void 0?e.length/t:0,this.usage=so,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=on()}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,n){e*=this.stride,n*=t.stride;for(let r=0,i=this.stride;r<i;r++)this.array[e+r]=t.array[n+r];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=on()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),n=new this.constructor(t,this.stride);return n.setUsage(this.usage),n}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=on()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}bo.prototype.isInterleavedBuffer=!0;const Dt=new b;class co{constructor(e,t,n,r=!1){this.name="",this.data=e,this.itemSize=t,this.offset=n,this.normalized=r===!0}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,n=this.data.count;t<n;t++)Dt.x=this.getX(t),Dt.y=this.getY(t),Dt.z=this.getZ(t),Dt.applyMatrix4(e),this.setXYZ(t,Dt.x,Dt.y,Dt.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Dt.x=this.getX(t),Dt.y=this.getY(t),Dt.z=this.getZ(t),Dt.applyNormalMatrix(e),this.setXYZ(t,Dt.x,Dt.y,Dt.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Dt.x=this.getX(t),Dt.y=this.getY(t),Dt.z=this.getZ(t),Dt.transformDirection(e),this.setXYZ(t,Dt.x,Dt.y,Dt.z);return this}setX(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){return this.data.array[e*this.data.stride+this.offset]}getY(e){return this.data.array[e*this.data.stride+this.offset+1]}getZ(e){return this.data.array[e*this.data.stride+this.offset+2]}getW(e){return this.data.array[e*this.data.stride+this.offset+3]}setXY(e,t,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this}setXYZ(e,t,n,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this}setXYZW(e,t,n,r,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this.data.array[e+3]=i,this}clone(e){if(e===void 0){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let n=0;n<this.count;n++){const r=n*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)t.push(this.data.array[r+i])}return new Ze(new this.array.constructor(t),this.itemSize,this.normalized)}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new co(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(e===void 0){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const t=[];for(let n=0;n<this.count;n++){const r=n*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)t.push(this.data.array[r+i])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}co.prototype.isInterleavedBufferAttribute=!0;class mg extends er{constructor(e){super(),this.type="SpriteMaterial",this.color=new ze(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this}}mg.prototype.isSpriteMaterial=!0;let wa;const Rs=new b,Ma=new b,Ea=new b,Ca=new ve,Ls=new ve,vg=new Ce,dl=new b,Ps=new b,pl=new b,Cp=new ve,Eu=new ve,Ap=new ve;class IM extends lt{constructor(e){if(super(),this.type="Sprite",wa===void 0){wa=new at;const t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),n=new bo(t,5);wa.setIndex([0,1,2,0,2,3]),wa.setAttribute("position",new co(n,3,0,!1)),wa.setAttribute("uv",new co(n,2,3,!1))}this.geometry=wa,this.material=e!==void 0?e:new mg,this.center=new ve(.5,.5)}raycast(e,t){e.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Ma.setFromMatrixScale(this.matrixWorld),vg.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),Ea.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&Ma.multiplyScalar(-Ea.z);const n=this.material.rotation;let r,i;n!==0&&(i=Math.cos(n),r=Math.sin(n));const s=this.center;ml(dl.set(-.5,-.5,0),Ea,s,Ma,r,i),ml(Ps.set(.5,-.5,0),Ea,s,Ma,r,i),ml(pl.set(.5,.5,0),Ea,s,Ma,r,i),Cp.set(0,0),Eu.set(1,0),Ap.set(1,1);let o=e.ray.intersectTriangle(dl,Ps,pl,!1,Rs);if(o===null&&(ml(Ps.set(-.5,.5,0),Ea,s,Ma,r,i),Eu.set(0,1),o=e.ray.intersectTriangle(dl,pl,Ps,!1,Rs),o===null))return;const l=e.ray.origin.distanceTo(Rs);l<e.near||l>e.far||t.push({distance:l,point:Rs.clone(),uv:Br.getUV(Rs,dl,Ps,pl,Cp,Eu,Ap,new ve),face:null,object:this})}copy(e){return super.copy(e),e.center!==void 0&&this.center.copy(e.center),this.material=e.material,this}}IM.prototype.isSprite=!0;function ml(a,e,t,n,r,i){Ca.subVectors(a,t).addScalar(.5).multiply(n),r!==void 0?(Ls.x=i*Ca.x-r*Ca.y,Ls.y=r*Ca.x+i*Ca.y):Ls.copy(Ca),a.copy(e),a.x+=Ls.x,a.y+=Ls.y,a.applyMatrix4(vg)}const Tp=new b,Rp=new ht,Lp=new ht,kM=new b,Pp=new Ce;class gg extends ft{constructor(e,t){super(e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Ce,this.bindMatrixInverse=new Ce}copy(e){return super.copy(e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this}bind(e,t){this.skeleton=e,t===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new ht,t=this.geometry.attributes.skinWeight;for(let n=0,r=t.count;n<r;n++){e.x=t.getX(n),e.y=t.getY(n),e.z=t.getZ(n),e.w=t.getW(n);const i=1/e.manhattanLength();i!==1/0?e.multiplyScalar(i):e.set(1,0,0,0),t.setXYZW(n,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode==="attached"?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode==="detached"?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}boneTransform(e,t){const n=this.skeleton,r=this.geometry;Rp.fromBufferAttribute(r.attributes.skinIndex,e),Lp.fromBufferAttribute(r.attributes.skinWeight,e),Tp.fromBufferAttribute(r.attributes.position,e).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let i=0;i<4;i++){const s=Lp.getComponent(i);if(s!==0){const o=Rp.getComponent(i);Pp.multiplyMatrices(n.bones[o].matrixWorld,n.boneInverses[o]),t.addScaledVector(kM.copy(Tp).applyMatrix4(Pp),s)}}return t.applyMatrix4(this.bindMatrixInverse)}}gg.prototype.isSkinnedMesh=!0;class OM extends lt{constructor(){super(),this.type="Bone"}}OM.prototype.isBone=!0;class fh extends Qt{constructor(e=null,t=1,n=1,r,i,s,o,l,c=It,u=It,f,h){super(null,s,o,l,c,u,r,i,f,h),this.image={data:e,width:t,height:n},this.magFilter=c,this.minFilter=u,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}fh.prototype.isDataTexture=!0;const Np=new Ce,Ip=new Ce,vl=[],Ns=new ft;let DM=class extends ft{constructor(e,t,n){super(e,t),this.instanceMatrix=new Ze(new Float32Array(n*16),16),this.instanceColor=null,this.count=n,this.frustumCulled=!1}copy(e){return super.copy(e),this.instanceMatrix.copy(e.instanceMatrix),e.instanceColor!==null&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,this}getColorAt(e,t){t.fromArray(this.instanceColor.array,e*3)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,e*16)}raycast(e,t){const n=this.matrixWorld,r=this.count;if(Ns.geometry=this.geometry,Ns.material=this.material,Ns.material!==void 0)for(let i=0;i<r;i++){this.getMatrixAt(i,Np),Ip.multiplyMatrices(n,Np),Ns.matrixWorld=Ip,Ns.raycast(e,vl);for(let s=0,o=vl.length;s<o;s++){const l=vl[s];l.instanceId=i,l.object=this,t.push(l)}vl.length=0}}setColorAt(e,t){this.instanceColor===null&&(this.instanceColor=new Ze(new Float32Array(this.instanceMatrix.count*3),3)),t.toArray(this.instanceColor.array,e*3)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,e*16)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}};DM.prototype.isInstancedMesh=!0;class Qi extends er{constructor(e){super(),this.type="LineBasicMaterial",this.color=new ze(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this}}Qi.prototype.isLineBasicMaterial=!0;const kp=new b,Op=new b,Dp=new Ce,Cu=new Ei,gl=new Lr;class ea extends lt{constructor(e=new at,t=new Qi){super(),this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry)if(e.index===null){const t=e.attributes.position,n=[0];for(let r=1,i=t.count;r<i;r++)kp.fromBufferAttribute(t,r-1),Op.fromBufferAttribute(t,r),n[r]=n[r-1],n[r]+=kp.distanceTo(Op);e.setAttribute("lineDistance",new wt(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.Line.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}raycast(e,t){const n=this.geometry,r=this.matrixWorld,i=e.params.Line.threshold,s=n.drawRange;if(n.boundingSphere===null&&n.computeBoundingSphere(),gl.copy(n.boundingSphere),gl.applyMatrix4(r),gl.radius+=i,e.ray.intersectsSphere(gl)===!1)return;Dp.copy(r).invert(),Cu.copy(e.ray).applyMatrix4(Dp);const o=i/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o,c=new b,u=new b,f=new b,h=new b,d=this.isLineSegments?2:1;if(n.isBufferGeometry){const p=n.index,_=n.attributes.position;if(p!==null){const m=Math.max(0,s.start),g=Math.min(p.count,s.start+s.count);for(let y=m,x=g-1;y<x;y+=d){const S=p.getX(y),M=p.getX(y+1);if(c.fromBufferAttribute(_,S),u.fromBufferAttribute(_,M),Cu.distanceSqToSegment(c,u,h,f)>l)continue;h.applyMatrix4(this.matrixWorld);const N=e.ray.origin.distanceTo(h);N<e.near||N>e.far||t.push({distance:N,point:f.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}else{const m=Math.max(0,s.start),g=Math.min(_.count,s.start+s.count);for(let y=m,x=g-1;y<x;y+=d){if(c.fromBufferAttribute(_,y),u.fromBufferAttribute(_,y+1),Cu.distanceSqToSegment(c,u,h,f)>l)continue;h.applyMatrix4(this.matrixWorld);const M=e.ray.origin.distanceTo(h);M<e.near||M>e.far||t.push({distance:M,point:f.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}}else n.isGeometry&&console.error("THREE.Line.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,n=Object.keys(t);if(n.length>0){const r=t[n[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,s=r.length;i<s;i++){const o=r[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=i}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}ea.prototype.isLine=!0;const Fp=new b,Bp=new b;class Gr extends ea{constructor(e,t){super(e,t),this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry)if(e.index===null){const t=e.attributes.position,n=[];for(let r=0,i=t.count;r<i;r+=2)Fp.fromBufferAttribute(t,r),Bp.fromBufferAttribute(t,r+1),n[r]=r===0?0:n[r-1],n[r+1]=n[r]+Fp.distanceTo(Bp);e.setAttribute("lineDistance",new wt(n,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else e.isGeometry&&console.error("THREE.LineSegments.computeLineDistances() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.");return this}}Gr.prototype.isLineSegments=!0;class FM extends ea{constructor(e,t){super(e,t),this.type="LineLoop"}}FM.prototype.isLineLoop=!0;class _g extends er{constructor(e){super(),this.type="PointsMaterial",this.color=new ze(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this}}_g.prototype.isPointsMaterial=!0;const zp=new Ce,Cf=new Ei,_l=new Lr,yl=new b;class BM extends lt{constructor(e=new at,t=new _g){super(),this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}raycast(e,t){const n=this.geometry,r=this.matrixWorld,i=e.params.Points.threshold,s=n.drawRange;if(n.boundingSphere===null&&n.computeBoundingSphere(),_l.copy(n.boundingSphere),_l.applyMatrix4(r),_l.radius+=i,e.ray.intersectsSphere(_l)===!1)return;zp.copy(r).invert(),Cf.copy(e.ray).applyMatrix4(zp);const o=i/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o;if(n.isBufferGeometry){const c=n.index,f=n.attributes.position;if(c!==null){const h=Math.max(0,s.start),d=Math.min(c.count,s.start+s.count);for(let p=h,v=d;p<v;p++){const _=c.getX(p);yl.fromBufferAttribute(f,_),Vp(yl,_,l,r,e,t,this)}}else{const h=Math.max(0,s.start),d=Math.min(f.count,s.start+s.count);for(let p=h,v=d;p<v;p++)yl.fromBufferAttribute(f,p),Vp(yl,p,l,r,e,t,this)}}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,n=Object.keys(t);if(n.length>0){const r=t[n[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,s=r.length;i<s;i++){const o=r[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=i}}}}else{const t=e.morphTargets;t!==void 0&&t.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}BM.prototype.isPoints=!0;function Vp(a,e,t,n,r,i,s){const o=Cf.distanceSqToPoint(a);if(o<t){const l=new b;Cf.closestPointToPoint(a,l),l.applyMatrix4(n);const c=r.ray.origin.distanceTo(l);if(c<r.near||c>r.far)return;i.push({distance:c,distanceToRay:Math.sqrt(o),point:l,index:e,face:null,object:s})}}class zM extends Qt{constructor(e,t,n,r,i,s,o,l,c){super(e,t,n,r,i,s,o,l,c),this.format=o!==void 0?o:fi,this.minFilter=s!==void 0?s:pt,this.magFilter=i!==void 0?i:pt,this.generateMipmaps=!1;const u=this;function f(){u.needsUpdate=!0,e.requestVideoFrameCallback(f)}"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(f)}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;"requestVideoFrameCallback"in e===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}zM.prototype.isVideoTexture=!0;class VM extends Qt{constructor(e,t,n,r,i,s,o,l,c,u,f,h){super(null,s,o,l,c,u,r,i,f,h),this.image={width:t,height:n},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}VM.prototype.isCompressedTexture=!0;class UM extends Qt{constructor(e,t,n,r,i,s,o,l,c){super(e,t,n,r,i,s,o,l,c),this.needsUpdate=!0}}UM.prototype.isCanvasTexture=!0;class yg extends Qt{constructor(e,t,n,r,i,s,o,l,c,u){if(u=u!==void 0?u:ja,u!==ja&&u!==ao)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");n===void 0&&u===ja&&(n=io),n===void 0&&u===ao&&(n=Zs),super(null,r,i,s,o,l,u,n,c),this.image={width:e,height:t},this.magFilter=o!==void 0?o:It,this.minFilter=l!==void 0?l:It,this.flipY=!1,this.generateMipmaps=!1}}yg.prototype.isDepthTexture=!0;class wo extends at{constructor(e=1,t=1,n=1,r=8,i=1,s=!1,o=0,l=Math.PI*2){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:r,heightSegments:i,openEnded:s,thetaStart:o,thetaLength:l};const c=this;r=Math.floor(r),i=Math.floor(i);const u=[],f=[],h=[],d=[];let p=0;const v=[],_=n/2;let m=0;g(),s===!1&&(e>0&&y(!0),t>0&&y(!1)),this.setIndex(u),this.setAttribute("position",new wt(f,3)),this.setAttribute("normal",new wt(h,3)),this.setAttribute("uv",new wt(d,2));function g(){const x=new b,S=new b;let M=0;const E=(t-e)/n;for(let N=0;N<=i;N++){const B=[],V=N/i,O=V*(t-e)+e;for(let W=0;W<=r;W++){const z=W/r,C=z*l+o,T=Math.sin(C),A=Math.cos(C);S.x=O*T,S.y=-V*n+_,S.z=O*A,f.push(S.x,S.y,S.z),x.set(T,E,A).normalize(),h.push(x.x,x.y,x.z),d.push(z,1-V),B.push(p++)}v.push(B)}for(let N=0;N<r;N++)for(let B=0;B<i;B++){const V=v[B][N],O=v[B+1][N],W=v[B+1][N+1],z=v[B][N+1];u.push(V,O,z),u.push(O,W,z),M+=6}c.addGroup(m,M,0),m+=M}function y(x){const S=p,M=new ve,E=new b;let N=0;const B=x===!0?e:t,V=x===!0?1:-1;for(let W=1;W<=r;W++)f.push(0,_*V,0),h.push(0,V,0),d.push(.5,.5),p++;const O=p;for(let W=0;W<=r;W++){const C=W/r*l+o,T=Math.cos(C),A=Math.sin(C);E.x=B*A,E.y=_*V,E.z=B*T,f.push(E.x,E.y,E.z),h.push(0,V,0),M.x=T*.5+.5,M.y=A*.5*V+.5,d.push(M.x,M.y),p++}for(let W=0;W<r;W++){const z=S+W,C=O+W;x===!0?u.push(C,C+1,z):u.push(C+1,C,z),N+=3}c.addGroup(m,N,x===!0?1:2),m+=N}}static fromJSON(e){return new wo(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Yr{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,t){const n=this.getUtoTmapping(e);return this.getPoint(n,t)}getPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return t}getSpacedPoints(e=5){const t=[];for(let n=0;n<=e;n++)t.push(this.getPointAt(n/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let n,r=this.getPoint(0),i=0;t.push(0);for(let s=1;s<=e;s++)n=this.getPoint(s/e),i+=n.distanceTo(r),t.push(i),r=n;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const n=this.getLengths();let r=0;const i=n.length;let s;t?s=t:s=e*n[i-1];let o=0,l=i-1,c;for(;o<=l;)if(r=Math.floor(o+(l-o)/2),c=n[r]-s,c<0)o=r+1;else if(c>0)l=r-1;else{l=r;break}if(r=l,n[r]===s)return r/(i-1);const u=n[r],h=n[r+1]-u,d=(s-u)/h;return(r+d)/(i-1)}getTangent(e,t){let r=e-1e-4,i=e+1e-4;r<0&&(r=0),i>1&&(i=1);const s=this.getPoint(r),o=this.getPoint(i),l=t||(s.isVector2?new ve:new b);return l.copy(o).sub(s).normalize(),l}getTangentAt(e,t){const n=this.getUtoTmapping(e);return this.getTangent(n,t)}computeFrenetFrames(e,t){const n=new b,r=[],i=[],s=[],o=new b,l=new Ce;for(let d=0;d<=e;d++){const p=d/e;r[d]=this.getTangentAt(p,new b),r[d].normalize()}i[0]=new b,s[0]=new b;let c=Number.MAX_VALUE;const u=Math.abs(r[0].x),f=Math.abs(r[0].y),h=Math.abs(r[0].z);u<=c&&(c=u,n.set(1,0,0)),f<=c&&(c=f,n.set(0,1,0)),h<=c&&n.set(0,0,1),o.crossVectors(r[0],n).normalize(),i[0].crossVectors(r[0],o),s[0].crossVectors(r[0],i[0]);for(let d=1;d<=e;d++){if(i[d]=i[d-1].clone(),s[d]=s[d-1].clone(),o.crossVectors(r[d-1],r[d]),o.length()>Number.EPSILON){o.normalize();const p=Math.acos(Er(r[d-1].dot(r[d]),-1,1));i[d].applyMatrix4(l.makeRotationAxis(o,p))}s[d].crossVectors(r[d],i[d])}if(t===!0){let d=Math.acos(Er(i[0].dot(i[e]),-1,1));d/=e,r[0].dot(o.crossVectors(i[0],i[e]))>0&&(d=-d);for(let p=1;p<=e;p++)i[p].applyMatrix4(l.makeRotationAxis(r[p],d*p)),s[p].crossVectors(r[p],i[p])}return{tangents:r,normals:i,binormals:s}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Tc extends Yr{constructor(e=0,t=0,n=1,r=1,i=0,s=Math.PI*2,o=!1,l=0){super(),this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=r,this.aStartAngle=i,this.aEndAngle=s,this.aClockwise=o,this.aRotation=l}getPoint(e,t){const n=t||new ve,r=Math.PI*2;let i=this.aEndAngle-this.aStartAngle;const s=Math.abs(i)<Number.EPSILON;for(;i<0;)i+=r;for(;i>r;)i-=r;i<Number.EPSILON&&(s?i=0:i=r),this.aClockwise===!0&&!s&&(i===r?i=-r:i=i-r);const o=this.aStartAngle+e*i;let l=this.aX+this.xRadius*Math.cos(o),c=this.aY+this.yRadius*Math.sin(o);if(this.aRotation!==0){const u=Math.cos(this.aRotation),f=Math.sin(this.aRotation),h=l-this.aX,d=c-this.aY;l=h*u-d*f+this.aX,c=h*f+d*u+this.aY}return n.set(l,c)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}Tc.prototype.isEllipseCurve=!0;class xg extends Tc{constructor(e,t,n,r,i,s){super(e,t,n,n,r,i,s),this.type="ArcCurve"}}xg.prototype.isArcCurve=!0;function hh(){let a=0,e=0,t=0,n=0;function r(i,s,o,l){a=i,e=o,t=-3*i+3*s-2*o-l,n=2*i-2*s+o+l}return{initCatmullRom:function(i,s,o,l,c){r(s,o,c*(o-i),c*(l-s))},initNonuniformCatmullRom:function(i,s,o,l,c,u,f){let h=(s-i)/c-(o-i)/(c+u)+(o-s)/u,d=(o-s)/u-(l-s)/(u+f)+(l-o)/f;h*=u,d*=u,r(s,o,h,d)},calc:function(i){const s=i*i,o=s*i;return a+e*i+t*s+n*o}}}const xl=new b,Au=new hh,Tu=new hh,Ru=new hh;class Sg extends Yr{constructor(e=[],t=!1,n="centripetal",r=.5){super(),this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=n,this.tension=r}getPoint(e,t=new b){const n=t,r=this.points,i=r.length,s=(i-(this.closed?0:1))*e;let o=Math.floor(s),l=s-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/i)+1)*i:l===0&&o===i-1&&(o=i-2,l=1);let c,u;this.closed||o>0?c=r[(o-1)%i]:(xl.subVectors(r[0],r[1]).add(r[0]),c=xl);const f=r[o%i],h=r[(o+1)%i];if(this.closed||o+2<i?u=r[(o+2)%i]:(xl.subVectors(r[i-1],r[i-2]).add(r[i-1]),u=xl),this.curveType==="centripetal"||this.curveType==="chordal"){const d=this.curveType==="chordal"?.5:.25;let p=Math.pow(c.distanceToSquared(f),d),v=Math.pow(f.distanceToSquared(h),d),_=Math.pow(h.distanceToSquared(u),d);v<1e-4&&(v=1),p<1e-4&&(p=v),_<1e-4&&(_=v),Au.initNonuniformCatmullRom(c.x,f.x,h.x,u.x,p,v,_),Tu.initNonuniformCatmullRom(c.y,f.y,h.y,u.y,p,v,_),Ru.initNonuniformCatmullRom(c.z,f.z,h.z,u.z,p,v,_)}else this.curveType==="catmullrom"&&(Au.initCatmullRom(c.x,f.x,h.x,u.x,this.tension),Tu.initCatmullRom(c.y,f.y,h.y,u.y,this.tension),Ru.initCatmullRom(c.z,f.z,h.z,u.z,this.tension));return n.set(Au.calc(l),Tu.calc(l),Ru.calc(l)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const r=e.points[t];this.points.push(r.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const r=this.points[t];e.points.push(r.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const r=e.points[t];this.points.push(new b().fromArray(r))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}Sg.prototype.isCatmullRomCurve3=!0;function Up(a,e,t,n,r){const i=(n-e)*.5,s=(r-t)*.5,o=a*a,l=a*o;return(2*t-2*n+i+s)*l+(-3*t+3*n-2*i-s)*o+i*a+t}function GM(a,e){const t=1-a;return t*t*e}function HM(a,e){return 2*(1-a)*a*e}function WM(a,e){return a*a*e}function Js(a,e,t,n){return GM(a,e)+HM(a,t)+WM(a,n)}function XM(a,e){const t=1-a;return t*t*t*e}function jM(a,e){const t=1-a;return 3*t*t*a*e}function YM(a,e){return 3*(1-a)*a*a*e}function qM(a,e){return a*a*a*e}function Qs(a,e,t,n,r){return XM(a,e)+jM(a,t)+YM(a,n)+qM(a,r)}class dh extends Yr{constructor(e=new ve,t=new ve,n=new ve,r=new ve){super(),this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=n,this.v3=r}getPoint(e,t=new ve){const n=t,r=this.v0,i=this.v1,s=this.v2,o=this.v3;return n.set(Qs(e,r.x,i.x,s.x,o.x),Qs(e,r.y,i.y,s.y,o.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}dh.prototype.isCubicBezierCurve=!0;class bg extends Yr{constructor(e=new b,t=new b,n=new b,r=new b){super(),this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=n,this.v3=r}getPoint(e,t=new b){const n=t,r=this.v0,i=this.v1,s=this.v2,o=this.v3;return n.set(Qs(e,r.x,i.x,s.x,o.x),Qs(e,r.y,i.y,s.y,o.y),Qs(e,r.z,i.z,s.z,o.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}bg.prototype.isCubicBezierCurve3=!0;class Rc extends Yr{constructor(e=new ve,t=new ve){super(),this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new ve){const n=t;return e===1?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t){const n=t||new ve;return n.copy(this.v2).sub(this.v1).normalize(),n}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}Rc.prototype.isLineCurve=!0;class $M extends Yr{constructor(e=new b,t=new b){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=e,this.v2=t}getPoint(e,t=new b){const n=t;return e===1?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(e).add(this.v1)),n}getPointAt(e,t){return this.getPoint(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class ph extends Yr{constructor(e=new ve,t=new ve,n=new ve){super(),this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new ve){const n=t,r=this.v0,i=this.v1,s=this.v2;return n.set(Js(e,r.x,i.x,s.x),Js(e,r.y,i.y,s.y)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}ph.prototype.isQuadraticBezierCurve=!0;class wg extends Yr{constructor(e=new b,t=new b,n=new b){super(),this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=n}getPoint(e,t=new b){const n=t,r=this.v0,i=this.v1,s=this.v2;return n.set(Js(e,r.x,i.x,s.x),Js(e,r.y,i.y,s.y),Js(e,r.z,i.z,s.z)),n}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}wg.prototype.isQuadraticBezierCurve3=!0;class mh extends Yr{constructor(e=[]){super(),this.type="SplineCurve",this.points=e}getPoint(e,t=new ve){const n=t,r=this.points,i=(r.length-1)*e,s=Math.floor(i),o=i-s,l=r[s===0?s:s-1],c=r[s],u=r[s>r.length-2?r.length-1:s+1],f=r[s>r.length-3?r.length-1:s+2];return n.set(Up(o,l.x,c.x,u.x,f.x),Up(o,l.y,c.y,u.y,f.y)),n}copy(e){super.copy(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const r=e.points[t];this.points.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,n=this.points.length;t<n;t++){const r=this.points[t];e.points.push(r.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,n=e.points.length;t<n;t++){const r=e.points[t];this.points.push(new ve().fromArray(r))}return this}}mh.prototype.isSplineCurve=!0;var Mg=Object.freeze({__proto__:null,ArcCurve:xg,CatmullRomCurve3:Sg,CubicBezierCurve:dh,CubicBezierCurve3:bg,EllipseCurve:Tc,LineCurve:Rc,LineCurve3:$M,QuadraticBezierCurve:ph,QuadraticBezierCurve3:wg,SplineCurve:mh});const ZM={triangulate:function(a,e,t=2){const n=e&&e.length,r=n?e[0]*t:a.length;let i=Eg(a,0,r,t,!0);const s=[];if(!i||i.next===i.prev)return s;let o,l,c,u,f,h,d;if(n&&(i=tE(a,e,i,t)),a.length>80*t){o=c=a[0],l=u=a[1];for(let p=t;p<r;p+=t)f=a[p],h=a[p+1],f<o&&(o=f),h<l&&(l=h),f>c&&(c=f),h>u&&(u=h);d=Math.max(c-o,u-l),d=d!==0?1/d:0}return uo(i,s,t,o,l,d),s}};function Eg(a,e,t,n,r){let i,s;if(r===hE(a,e,t,n)>0)for(i=e;i<t;i+=n)s=Gp(i,a[i],a[i+1],s);else for(i=t-n;i>=e;i-=n)s=Gp(i,a[i],a[i+1],s);return s&&Lc(s,s.next)&&(ho(s),s=s.next),s}function Si(a,e){if(!a)return a;e||(e=a);let t=a,n;do if(n=!1,!t.steiner&&(Lc(t,t.next)||kt(t.prev,t,t.next)===0)){if(ho(t),t=e=t.prev,t===t.next)break;n=!0}else t=t.next;while(n||t!==e);return e}function uo(a,e,t,n,r,i,s){if(!a)return;!s&&i&&sE(a,n,r,i);let o=a,l,c;for(;a.prev!==a.next;){if(l=a.prev,c=a.next,i?JM(a,n,r,i):KM(a)){e.push(l.i/t),e.push(a.i/t),e.push(c.i/t),ho(a),a=c.next,o=c.next;continue}if(a=c,a===o){s?s===1?(a=QM(Si(a),e,t),uo(a,e,t,n,r,i,2)):s===2&&eE(a,e,t,n,r,i):uo(Si(a),e,t,n,r,i,1);break}}}function KM(a){const e=a.prev,t=a,n=a.next;if(kt(e,t,n)>=0)return!1;let r=a.next.next;for(;r!==a.prev;){if(Wa(e.x,e.y,t.x,t.y,n.x,n.y,r.x,r.y)&&kt(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function JM(a,e,t,n){const r=a.prev,i=a,s=a.next;if(kt(r,i,s)>=0)return!1;const o=r.x<i.x?r.x<s.x?r.x:s.x:i.x<s.x?i.x:s.x,l=r.y<i.y?r.y<s.y?r.y:s.y:i.y<s.y?i.y:s.y,c=r.x>i.x?r.x>s.x?r.x:s.x:i.x>s.x?i.x:s.x,u=r.y>i.y?r.y>s.y?r.y:s.y:i.y>s.y?i.y:s.y,f=Af(o,l,e,t,n),h=Af(c,u,e,t,n);let d=a.prevZ,p=a.nextZ;for(;d&&d.z>=f&&p&&p.z<=h;){if(d!==a.prev&&d!==a.next&&Wa(r.x,r.y,i.x,i.y,s.x,s.y,d.x,d.y)&&kt(d.prev,d,d.next)>=0||(d=d.prevZ,p!==a.prev&&p!==a.next&&Wa(r.x,r.y,i.x,i.y,s.x,s.y,p.x,p.y)&&kt(p.prev,p,p.next)>=0))return!1;p=p.nextZ}for(;d&&d.z>=f;){if(d!==a.prev&&d!==a.next&&Wa(r.x,r.y,i.x,i.y,s.x,s.y,d.x,d.y)&&kt(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;p&&p.z<=h;){if(p!==a.prev&&p!==a.next&&Wa(r.x,r.y,i.x,i.y,s.x,s.y,p.x,p.y)&&kt(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function QM(a,e,t){let n=a;do{const r=n.prev,i=n.next.next;!Lc(r,i)&&Cg(r,n,n.next,i)&&fo(r,i)&&fo(i,r)&&(e.push(r.i/t),e.push(n.i/t),e.push(i.i/t),ho(n),ho(n.next),n=a=i),n=n.next}while(n!==a);return Si(n)}function eE(a,e,t,n,r,i){let s=a;do{let o=s.next.next;for(;o!==s.prev;){if(s.i!==o.i&&cE(s,o)){let l=Ag(s,o);s=Si(s,s.next),l=Si(l,l.next),uo(s,e,t,n,r,i),uo(l,e,t,n,r,i);return}o=o.next}s=s.next}while(s!==a)}function tE(a,e,t,n){const r=[];let i,s,o,l,c;for(i=0,s=e.length;i<s;i++)o=e[i]*n,l=i<s-1?e[i+1]*n:a.length,c=Eg(a,o,l,n,!1),c===c.next&&(c.steiner=!0),r.push(lE(c));for(r.sort(rE),i=0;i<r.length;i++)nE(r[i],t),t=Si(t,t.next);return t}function rE(a,e){return a.x-e.x}function nE(a,e){if(e=iE(a,e),e){const t=Ag(e,a);Si(e,e.next),Si(t,t.next)}}function iE(a,e){let t=e;const n=a.x,r=a.y;let i=-1/0,s;do{if(r<=t.y&&r>=t.next.y&&t.next.y!==t.y){const h=t.x+(r-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(h<=n&&h>i){if(i=h,h===n){if(r===t.y)return t;if(r===t.next.y)return t.next}s=t.x<t.next.x?t:t.next}}t=t.next}while(t!==e);if(!s)return null;if(n===i)return s;const o=s,l=s.x,c=s.y;let u=1/0,f;t=s;do n>=t.x&&t.x>=l&&n!==t.x&&Wa(r<c?n:i,r,l,c,r<c?i:n,r,t.x,t.y)&&(f=Math.abs(r-t.y)/(n-t.x),fo(t,a)&&(f<u||f===u&&(t.x>s.x||t.x===s.x&&aE(s,t)))&&(s=t,u=f)),t=t.next;while(t!==o);return s}function aE(a,e){return kt(a.prev,a,e.prev)<0&&kt(e.next,a,a.next)<0}function sE(a,e,t,n){let r=a;do r.z===null&&(r.z=Af(r.x,r.y,e,t,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==a);r.prevZ.nextZ=null,r.prevZ=null,oE(r)}function oE(a){let e,t,n,r,i,s,o,l,c=1;do{for(t=a,a=null,i=null,s=0;t;){for(s++,n=t,o=0,e=0;e<c&&(o++,n=n.nextZ,!!n);e++);for(l=c;o>0||l>0&&n;)o!==0&&(l===0||!n||t.z<=n.z)?(r=t,t=t.nextZ,o--):(r=n,n=n.nextZ,l--),i?i.nextZ=r:a=r,r.prevZ=i,i=r;t=n}i.nextZ=null,c*=2}while(s>1);return a}function Af(a,e,t,n,r){return a=32767*(a-t)*r,e=32767*(e-n)*r,a=(a|a<<8)&16711935,a=(a|a<<4)&252645135,a=(a|a<<2)&858993459,a=(a|a<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,a|e<<1}function lE(a){let e=a,t=a;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==a);return t}function Wa(a,e,t,n,r,i,s,o){return(r-s)*(e-o)-(a-s)*(i-o)>=0&&(a-s)*(n-o)-(t-s)*(e-o)>=0&&(t-s)*(i-o)-(r-s)*(n-o)>=0}function cE(a,e){return a.next.i!==e.i&&a.prev.i!==e.i&&!uE(a,e)&&(fo(a,e)&&fo(e,a)&&fE(a,e)&&(kt(a.prev,a,e.prev)||kt(a,e.prev,e))||Lc(a,e)&&kt(a.prev,a,a.next)>0&&kt(e.prev,e,e.next)>0)}function kt(a,e,t){return(e.y-a.y)*(t.x-e.x)-(e.x-a.x)*(t.y-e.y)}function Lc(a,e){return a.x===e.x&&a.y===e.y}function Cg(a,e,t,n){const r=bl(kt(a,e,t)),i=bl(kt(a,e,n)),s=bl(kt(t,n,a)),o=bl(kt(t,n,e));return!!(r!==i&&s!==o||r===0&&Sl(a,t,e)||i===0&&Sl(a,n,e)||s===0&&Sl(t,a,n)||o===0&&Sl(t,e,n))}function Sl(a,e,t){return e.x<=Math.max(a.x,t.x)&&e.x>=Math.min(a.x,t.x)&&e.y<=Math.max(a.y,t.y)&&e.y>=Math.min(a.y,t.y)}function bl(a){return a>0?1:a<0?-1:0}function uE(a,e){let t=a;do{if(t.i!==a.i&&t.next.i!==a.i&&t.i!==e.i&&t.next.i!==e.i&&Cg(t,t.next,a,e))return!0;t=t.next}while(t!==a);return!1}function fo(a,e){return kt(a.prev,a,a.next)<0?kt(a,e,a.next)>=0&&kt(a,a.prev,e)>=0:kt(a,e,a.prev)<0||kt(a,a.next,e)<0}function fE(a,e){let t=a,n=!1;const r=(a.x+e.x)/2,i=(a.y+e.y)/2;do t.y>i!=t.next.y>i&&t.next.y!==t.y&&r<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(n=!n),t=t.next;while(t!==a);return n}function Ag(a,e){const t=new Tf(a.i,a.x,a.y),n=new Tf(e.i,e.x,e.y),r=a.next,i=e.prev;return a.next=e,e.prev=a,t.next=r,r.prev=t,n.next=t,t.prev=n,i.next=n,n.prev=i,n}function Gp(a,e,t,n){const r=new Tf(a,e,t);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function ho(a){a.next.prev=a.prev,a.prev.next=a.next,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ)}function Tf(a,e,t){this.i=a,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function hE(a,e,t,n){let r=0;for(let i=e,s=t-n;i<t;i+=n)r+=(a[s]-a[i])*(a[i+1]+a[s+1]),s=i;return r}class mi{static area(e){const t=e.length;let n=0;for(let r=t-1,i=0;i<t;r=i++)n+=e[r].x*e[i].y-e[i].x*e[r].y;return n*.5}static isClockWise(e){return mi.area(e)<0}static triangulateShape(e,t){const n=[],r=[],i=[];Hp(e),Wp(n,e);let s=e.length;t.forEach(Hp);for(let l=0;l<t.length;l++)r.push(s),s+=t[l].length,Wp(n,t[l]);const o=ZM.triangulate(n,r);for(let l=0;l<o.length;l+=3)i.push(o.slice(l,l+3));return i}}function Hp(a){const e=a.length;e>2&&a[e-1].equals(a[0])&&a.pop()}function Wp(a,e){for(let t=0;t<e.length;t++)a.push(e[t].x),a.push(e[t].y)}class us extends at{constructor(e,t){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const n=this,r=[],i=[];for(let o=0,l=e.length;o<l;o++){const c=e[o];s(c)}this.setAttribute("position",new wt(r,3)),this.setAttribute("uv",new wt(i,2)),this.computeVertexNormals();function s(o){const l=[],c=t.curveSegments!==void 0?t.curveSegments:12,u=t.steps!==void 0?t.steps:1;let f=t.depth!==void 0?t.depth:100,h=t.bevelEnabled!==void 0?t.bevelEnabled:!0,d=t.bevelThickness!==void 0?t.bevelThickness:6,p=t.bevelSize!==void 0?t.bevelSize:d-2,v=t.bevelOffset!==void 0?t.bevelOffset:0,_=t.bevelSegments!==void 0?t.bevelSegments:3;const m=t.extrudePath,g=t.UVGenerator!==void 0?t.UVGenerator:dE;t.amount!==void 0&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),f=t.amount);let y,x=!1,S,M,E,N;m&&(y=m.getSpacedPoints(u),x=!0,h=!1,S=m.computeFrenetFrames(u,!1),M=new b,E=new b,N=new b),h||(_=0,d=0,p=0,v=0);const B=o.extractPoints(c);let V=B.shape;const O=B.holes;if(!mi.isClockWise(V)){V=V.reverse();for(let ie=0,oe=O.length;ie<oe;ie++){const K=O[ie];mi.isClockWise(K)&&(O[ie]=K.reverse())}}const z=mi.triangulateShape(V,O),C=V;for(let ie=0,oe=O.length;ie<oe;ie++){const K=O[ie];V=V.concat(K)}function T(ie,oe,K){return oe||console.error("THREE.ExtrudeGeometry: vec does not exist"),oe.clone().multiplyScalar(K).add(ie)}const A=V.length,F=z.length;function X(ie,oe,K){let de,he,I;const P=ie.x-oe.x,ee=ie.y-oe.y,pe=K.x-ie.x,Me=K.y-ie.y,Re=P*P+ee*ee,He=P*Me-ee*pe;if(Math.abs(He)>Number.EPSILON){const Oe=Math.sqrt(Re),ke=Math.sqrt(pe*pe+Me*Me),De=oe.x-ee/Oe,w=oe.y+P/Oe,L=K.x-Me/ke,R=K.y+pe/ke,j=((L-De)*Me-(R-w)*pe)/(P*Me-ee*pe);de=De+P*j-ie.x,he=w+ee*j-ie.y;const U=de*de+he*he;if(U<=2)return new ve(de,he);I=Math.sqrt(U/2)}else{let Oe=!1;P>Number.EPSILON?pe>Number.EPSILON&&(Oe=!0):P<-Number.EPSILON?pe<-Number.EPSILON&&(Oe=!0):Math.sign(ee)===Math.sign(Me)&&(Oe=!0),Oe?(de=-ee,he=P,I=Math.sqrt(Re)):(de=P,he=ee,I=Math.sqrt(Re/2))}return new ve(de/I,he/I)}const Y=[];for(let ie=0,oe=C.length,K=oe-1,de=ie+1;ie<oe;ie++,K++,de++)K===oe&&(K=0),de===oe&&(de=0),Y[ie]=X(C[ie],C[K],C[de]);const ne=[];let ae,xe=Y.concat();for(let ie=0,oe=O.length;ie<oe;ie++){const K=O[ie];ae=[];for(let de=0,he=K.length,I=he-1,P=de+1;de<he;de++,I++,P++)I===he&&(I=0),P===he&&(P=0),ae[de]=X(K[de],K[I],K[P]);ne.push(ae),xe=xe.concat(ae)}for(let ie=0;ie<_;ie++){const oe=ie/_,K=d*Math.cos(oe*Math.PI/2),de=p*Math.sin(oe*Math.PI/2)+v;for(let he=0,I=C.length;he<I;he++){const P=T(C[he],Y[he],de);Ge(P.x,P.y,-K)}for(let he=0,I=O.length;he<I;he++){const P=O[he];ae=ne[he];for(let ee=0,pe=P.length;ee<pe;ee++){const Me=T(P[ee],ae[ee],de);Ge(Me.x,Me.y,-K)}}}const be=p+v;for(let ie=0;ie<A;ie++){const oe=h?T(V[ie],xe[ie],be):V[ie];x?(E.copy(S.normals[0]).multiplyScalar(oe.x),M.copy(S.binormals[0]).multiplyScalar(oe.y),N.copy(y[0]).add(E).add(M),Ge(N.x,N.y,N.z)):Ge(oe.x,oe.y,0)}for(let ie=1;ie<=u;ie++)for(let oe=0;oe<A;oe++){const K=h?T(V[oe],xe[oe],be):V[oe];x?(E.copy(S.normals[ie]).multiplyScalar(K.x),M.copy(S.binormals[ie]).multiplyScalar(K.y),N.copy(y[ie]).add(E).add(M),Ge(N.x,N.y,N.z)):Ge(K.x,K.y,f/u*ie)}for(let ie=_-1;ie>=0;ie--){const oe=ie/_,K=d*Math.cos(oe*Math.PI/2),de=p*Math.sin(oe*Math.PI/2)+v;for(let he=0,I=C.length;he<I;he++){const P=T(C[he],Y[he],de);Ge(P.x,P.y,f+K)}for(let he=0,I=O.length;he<I;he++){const P=O[he];ae=ne[he];for(let ee=0,pe=P.length;ee<pe;ee++){const Me=T(P[ee],ae[ee],de);x?Ge(Me.x,Me.y+y[u-1].y,y[u-1].x+K):Ge(Me.x,Me.y,f+K)}}}ge(),we();function ge(){const ie=r.length/3;if(h){let oe=0,K=A*oe;for(let de=0;de<F;de++){const he=z[de];Te(he[2]+K,he[1]+K,he[0]+K)}oe=u+_*2,K=A*oe;for(let de=0;de<F;de++){const he=z[de];Te(he[0]+K,he[1]+K,he[2]+K)}}else{for(let oe=0;oe<F;oe++){const K=z[oe];Te(K[2],K[1],K[0])}for(let oe=0;oe<F;oe++){const K=z[oe];Te(K[0]+A*u,K[1]+A*u,K[2]+A*u)}}n.addGroup(ie,r.length/3-ie,0)}function we(){const ie=r.length/3;let oe=0;q(C,oe),oe+=C.length;for(let K=0,de=O.length;K<de;K++){const he=O[K];q(he,oe),oe+=he.length}n.addGroup(ie,r.length/3-ie,1)}function q(ie,oe){let K=ie.length;for(;--K>=0;){const de=K;let he=K-1;he<0&&(he=ie.length-1);for(let I=0,P=u+_*2;I<P;I++){const ee=A*I,pe=A*(I+1),Me=oe+de+ee,Re=oe+he+ee,He=oe+he+pe,Oe=oe+de+pe;Pe(Me,Re,He,Oe)}}}function Ge(ie,oe,K){l.push(ie),l.push(oe),l.push(K)}function Te(ie,oe,K){Ee(ie),Ee(oe),Ee(K);const de=r.length/3,he=g.generateTopUV(n,r,de-3,de-2,de-1);_e(he[0]),_e(he[1]),_e(he[2])}function Pe(ie,oe,K,de){Ee(ie),Ee(oe),Ee(de),Ee(oe),Ee(K),Ee(de);const he=r.length/3,I=g.generateSideWallUV(n,r,he-6,he-3,he-2,he-1);_e(I[0]),_e(I[1]),_e(I[3]),_e(I[1]),_e(I[2]),_e(I[3])}function Ee(ie){r.push(l[ie*3+0]),r.push(l[ie*3+1]),r.push(l[ie*3+2])}function _e(ie){i.push(ie.x),i.push(ie.y)}}}toJSON(){const e=super.toJSON(),t=this.parameters.shapes,n=this.parameters.options;return pE(t,n,e)}static fromJSON(e,t){const n=[];for(let i=0,s=e.shapes.length;i<s;i++){const o=t[e.shapes[i]];n.push(o)}const r=e.options.extrudePath;return r!==void 0&&(e.options.extrudePath=new Mg[r.type]().fromJSON(r)),new us(n,e.options)}}const dE={generateTopUV:function(a,e,t,n,r){const i=e[t*3],s=e[t*3+1],o=e[n*3],l=e[n*3+1],c=e[r*3],u=e[r*3+1];return[new ve(i,s),new ve(o,l),new ve(c,u)]},generateSideWallUV:function(a,e,t,n,r,i){const s=e[t*3],o=e[t*3+1],l=e[t*3+2],c=e[n*3],u=e[n*3+1],f=e[n*3+2],h=e[r*3],d=e[r*3+1],p=e[r*3+2],v=e[i*3],_=e[i*3+1],m=e[i*3+2];return Math.abs(o-u)<Math.abs(s-c)?[new ve(s,1-l),new ve(c,1-f),new ve(h,1-p),new ve(v,1-m)]:[new ve(o,1-l),new ve(u,1-f),new ve(d,1-p),new ve(_,1-m)]}};function pE(a,e,t){if(t.shapes=[],Array.isArray(a))for(let n=0,r=a.length;n<r;n++){const i=a[n];t.shapes.push(i.uuid)}else t.shapes.push(a.uuid);return e.extrudePath!==void 0&&(t.options.extrudePath=e.extrudePath.toJSON()),t}class vh extends at{constructor(e,t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const n=[],r=[],i=[],s=[];let o=0,l=0;if(Array.isArray(e)===!1)c(e);else for(let u=0;u<e.length;u++)c(e[u]),this.addGroup(o,l,u),o+=l,l=0;this.setIndex(n),this.setAttribute("position",new wt(r,3)),this.setAttribute("normal",new wt(i,3)),this.setAttribute("uv",new wt(s,2));function c(u){const f=r.length/3,h=u.extractPoints(t);let d=h.shape;const p=h.holes;mi.isClockWise(d)===!1&&(d=d.reverse());for(let _=0,m=p.length;_<m;_++){const g=p[_];mi.isClockWise(g)===!0&&(p[_]=g.reverse())}const v=mi.triangulateShape(d,p);for(let _=0,m=p.length;_<m;_++){const g=p[_];d=d.concat(g)}for(let _=0,m=d.length;_<m;_++){const g=d[_];r.push(g.x,g.y,0),i.push(0,0,1),s.push(g.x,g.y)}for(let _=0,m=v.length;_<m;_++){const g=v[_],y=g[0]+f,x=g[1]+f,S=g[2]+f;n.push(y,x,S),l+=3}}}toJSON(){const e=super.toJSON(),t=this.parameters.shapes;return mE(t,e)}static fromJSON(e,t){const n=[];for(let r=0,i=e.shapes.length;r<i;r++){const s=t[e.shapes[r]];n.push(s)}return new vh(n,e.curveSegments)}}function mE(a,e){if(e.shapes=[],Array.isArray(a))for(let t=0,n=a.length;t<n;t++){const r=a[t];e.shapes.push(r.uuid)}else e.shapes.push(a.uuid);return e}class Pc extends at{constructor(e=1,t=32,n=16,r=0,i=Math.PI*2,s=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:r,phiLength:i,thetaStart:s,thetaLength:o},t=Math.max(3,Math.floor(t)),n=Math.max(2,Math.floor(n));const l=Math.min(s+o,Math.PI);let c=0;const u=[],f=new b,h=new b,d=[],p=[],v=[],_=[];for(let m=0;m<=n;m++){const g=[],y=m/n;let x=0;m==0&&s==0?x=.5/t:m==n&&l==Math.PI&&(x=-.5/t);for(let S=0;S<=t;S++){const M=S/t;f.x=-e*Math.cos(r+M*i)*Math.sin(s+y*o),f.y=e*Math.cos(s+y*o),f.z=e*Math.sin(r+M*i)*Math.sin(s+y*o),p.push(f.x,f.y,f.z),h.copy(f).normalize(),v.push(h.x,h.y,h.z),_.push(M+x,1-y),g.push(c++)}u.push(g)}for(let m=0;m<n;m++)for(let g=0;g<t;g++){const y=u[m][g+1],x=u[m][g],S=u[m+1][g],M=u[m+1][g+1];(m!==0||s>0)&&d.push(y,x,M),(m!==n-1||l<Math.PI)&&d.push(x,S,M)}this.setIndex(d),this.setAttribute("position",new wt(p,3)),this.setAttribute("normal",new wt(v,3)),this.setAttribute("uv",new wt(_,2))}static fromJSON(e){return new Pc(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class vE extends er{constructor(e){super(),this.type="ShadowMaterial",this.color=new ze(0),this.transparent=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this}}vE.prototype.isShadowMaterial=!0;class Tg extends er{constructor(e){super(),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new ze(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ze(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ss,this.normalScale=new ve(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}Tg.prototype.isMeshStandardMaterial=!0;class gE extends Tg{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ve(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,Object.defineProperty(this,"ior",{get:function(){return(1+.4*this.reflectivity)/(1-.4*this.reflectivity)},set:function(t){this.reflectivity=Er(2.5*(t-1)/(t+1),0,1)}}),this.sheen=null,this.transmission=0,this.transmissionMap=null,this.thickness=.01,this.thicknessMap=null,this.attenuationDistance=0,this.attenuationTint=new ze(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularTint=new ze(1,1,1),this.specularTintMap=null,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.reflectivity=e.reflectivity,e.sheen?this.sheen=(this.sheen||new ze).copy(e.sheen):this.sheen=null,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationTint.copy(e.attenuationTint),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularTint.copy(e.specularTint),this.specularTintMap=e.specularTintMap,this}}gE.prototype.isMeshPhysicalMaterial=!0;class _E extends er{constructor(e){super(),this.type="MeshPhongMaterial",this.color=new ze(16777215),this.specular=new ze(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ze(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ss,this.normalScale=new ve(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}_E.prototype.isMeshPhongMaterial=!0;class yE extends er{constructor(e){super(),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new ze(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ze(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ss,this.normalScale=new ve(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}yE.prototype.isMeshToonMaterial=!0;class xE extends er{constructor(e){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ss,this.normalScale=new ve(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}xE.prototype.isMeshNormalMaterial=!0;class SE extends er{constructor(e){super(),this.type="MeshLambertMaterial",this.color=new ze(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ze(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}SE.prototype.isMeshLambertMaterial=!0;class bE extends er{constructor(e){super(),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new ze(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ss,this.normalScale=new ve(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this}}bE.prototype.isMeshMatcapMaterial=!0;class wE extends Qi{constructor(e){super(),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}wE.prototype.isLineDashedMaterial=!0;const Tt={arraySlice:function(a,e,t){return Tt.isTypedArray(a)?new a.constructor(a.subarray(e,t!==void 0?t:a.length)):a.slice(e,t)},convertArray:function(a,e,t){return!a||!t&&a.constructor===e?a:typeof e.BYTES_PER_ELEMENT=="number"?new e(a):Array.prototype.slice.call(a)},isTypedArray:function(a){return ArrayBuffer.isView(a)&&!(a instanceof DataView)},getKeyframeOrder:function(a){function e(r,i){return a[r]-a[i]}const t=a.length,n=new Array(t);for(let r=0;r!==t;++r)n[r]=r;return n.sort(e),n},sortedArray:function(a,e,t){const n=a.length,r=new a.constructor(n);for(let i=0,s=0;s!==n;++i){const o=t[i]*e;for(let l=0;l!==e;++l)r[s++]=a[o+l]}return r},flattenJSON:function(a,e,t,n){let r=1,i=a[0];for(;i!==void 0&&i[n]===void 0;)i=a[r++];if(i===void 0)return;let s=i[n];if(s!==void 0)if(Array.isArray(s))do s=i[n],s!==void 0&&(e.push(i.time),t.push.apply(t,s)),i=a[r++];while(i!==void 0);else if(s.toArray!==void 0)do s=i[n],s!==void 0&&(e.push(i.time),s.toArray(t,t.length)),i=a[r++];while(i!==void 0);else do s=i[n],s!==void 0&&(e.push(i.time),t.push(s)),i=a[r++];while(i!==void 0)},subclip:function(a,e,t,n,r=30){const i=a.clone();i.name=e;const s=[];for(let l=0;l<i.tracks.length;++l){const c=i.tracks[l],u=c.getValueSize(),f=[],h=[];for(let d=0;d<c.times.length;++d){const p=c.times[d]*r;if(!(p<t||p>=n)){f.push(c.times[d]);for(let v=0;v<u;++v)h.push(c.values[d*u+v])}}f.length!==0&&(c.times=Tt.convertArray(f,c.times.constructor),c.values=Tt.convertArray(h,c.values.constructor),s.push(c))}i.tracks=s;let o=1/0;for(let l=0;l<i.tracks.length;++l)o>i.tracks[l].times[0]&&(o=i.tracks[l].times[0]);for(let l=0;l<i.tracks.length;++l)i.tracks[l].shift(-1*o);return i.resetDuration(),i},makeClipAdditive:function(a,e=0,t=a,n=30){n<=0&&(n=30);const r=t.tracks.length,i=e/n;for(let s=0;s<r;++s){const o=t.tracks[s],l=o.ValueTypeName;if(l==="bool"||l==="string")continue;const c=a.tracks.find(function(m){return m.name===o.name&&m.ValueTypeName===l});if(c===void 0)continue;let u=0;const f=o.getValueSize();o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(u=f/3);let h=0;const d=c.getValueSize();c.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(h=d/3);const p=o.times.length-1;let v;if(i<=o.times[0]){const m=u,g=f-u;v=Tt.arraySlice(o.values,m,g)}else if(i>=o.times[p]){const m=p*f+u,g=m+f-u;v=Tt.arraySlice(o.values,m,g)}else{const m=o.createInterpolant(),g=u,y=f-u;m.evaluate(i),v=Tt.arraySlice(m.resultBuffer,g,y)}l==="quaternion"&&new Xt().fromArray(v).normalize().conjugate().toArray(v);const _=c.times.length;for(let m=0;m<_;++m){const g=m*d+h;if(l==="quaternion")Xt.multiplyQuaternionsFlat(c.values,g,v,0,c.values,g);else{const y=d-h*2;for(let x=0;x<y;++x)c.values[g+x]-=v[x]}}}return a.blendMode=Gv,a}};class bi{constructor(e,t,n,r){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=r!==void 0?r:new t.constructor(n),this.sampleValues=t,this.valueSize=n,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let n=this._cachedIndex,r=t[n],i=t[n-1];e:{t:{let s;r:{n:if(!(e<r)){for(let o=n+2;;){if(r===void 0){if(e<i)break n;return n=t.length,this._cachedIndex=n,this.afterEnd_(n-1,e,i)}if(n===o)break;if(i=r,r=t[++n],e<r)break t}s=t.length;break r}if(!(e>=i)){const o=t[1];e<o&&(n=2,i=o);for(let l=n-2;;){if(i===void 0)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(n===l)break;if(r=i,i=t[--n-1],e>=i)break t}s=n,n=0;break r}break e}for(;n<s;){const o=n+s>>>1;e<t[o]?s=o:n=o+1}if(r=t[n],i=t[n-1],i===void 0)return this._cachedIndex=0,this.beforeStart_(0,e,r);if(r===void 0)return n=t.length,this._cachedIndex=n,this.afterEnd_(n-1,i,e)}this._cachedIndex=n,this.intervalChanged_(n,i,r)}return this.interpolate_(n,i,e,r)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r;for(let s=0;s!==r;++s)t[s]=n[i+s];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}bi.prototype.beforeStart_=bi.prototype.copySampleValue_;bi.prototype.afterEnd_=bi.prototype.copySampleValue_;class ME extends bi{constructor(e,t,n,r){super(e,t,n,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Ga,endingEnd:Ga}}intervalChanged_(e,t,n){const r=this.parameterPositions;let i=e-2,s=e+1,o=r[i],l=r[s];if(o===void 0)switch(this.getSettings_().endingStart){case Ha:i=e,o=2*t-n;break;case sc:i=r.length-2,o=t+r[i]-r[i+1];break;default:i=e,o=n}if(l===void 0)switch(this.getSettings_().endingEnd){case Ha:s=e,l=2*n-t;break;case sc:s=1,l=n+r[1]-r[0];break;default:s=e-1,l=t}const c=(n-t)*.5,u=this.valueSize;this._weightPrev=c/(t-o),this._weightNext=c/(l-n),this._offsetPrev=i*u,this._offsetNext=s*u}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,u=this._offsetPrev,f=this._offsetNext,h=this._weightPrev,d=this._weightNext,p=(n-t)/(r-t),v=p*p,_=v*p,m=-h*_+2*h*v-h*p,g=(1+h)*_+(-1.5-2*h)*v+(-.5+h)*p+1,y=(-1-d)*_+(1.5+d)*v+.5*p,x=d*_-d*v;for(let S=0;S!==o;++S)i[S]=m*s[u+S]+g*s[c+S]+y*s[l+S]+x*s[f+S];return i}}class Rg extends bi{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,u=(n-t)/(r-t),f=1-u;for(let h=0;h!==o;++h)i[h]=s[c+h]*f+s[l+h]*u;return i}}class EE extends bi{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e){return this.copySampleValue_(e-1)}}class En{constructor(e,t,n,r){if(e===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(t===void 0||t.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=Tt.convertArray(t,this.TimeBufferType),this.values=Tt.convertArray(n,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let n;if(t.toJSON!==this.toJSON)n=t.toJSON(e);else{n={name:e.name,times:Tt.convertArray(e.times,Array),values:Tt.convertArray(e.values,Array)};const r=e.getInterpolation();r!==e.DefaultInterpolation&&(n.interpolation=r)}return n.type=e.ValueTypeName,n}InterpolantFactoryMethodDiscrete(e){return new EE(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Rg(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new ME(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case ic:t=this.InterpolantFactoryMethodDiscrete;break;case ac:t=this.InterpolantFactoryMethodLinear;break;case Zc:t=this.InterpolantFactoryMethodSmooth;break}if(t===void 0){const n="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0)if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw new Error(n);return console.warn("THREE.KeyframeTrack:",n),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return ic;case this.InterpolantFactoryMethodLinear:return ac;case this.InterpolantFactoryMethodSmooth:return Zc}}getValueSize(){return this.values.length/this.times.length}shift(e){if(e!==0){const t=this.times;for(let n=0,r=t.length;n!==r;++n)t[n]+=e}return this}scale(e){if(e!==1){const t=this.times;for(let n=0,r=t.length;n!==r;++n)t[n]*=e}return this}trim(e,t){const n=this.times,r=n.length;let i=0,s=r-1;for(;i!==r&&n[i]<e;)++i;for(;s!==-1&&n[s]>t;)--s;if(++s,i!==0||s!==r){i>=s&&(s=Math.max(s,1),i=s-1);const o=this.getValueSize();this.times=Tt.arraySlice(n,i,s),this.values=Tt.arraySlice(this.values,i*o,s*o)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const n=this.times,r=this.values,i=n.length;i===0&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let s=null;for(let o=0;o!==i;o++){const l=n[o];if(typeof l=="number"&&isNaN(l)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,o,l),e=!1;break}if(s!==null&&s>l){console.error("THREE.KeyframeTrack: Out of order keys.",this,o,l,s),e=!1;break}s=l}if(r!==void 0&&Tt.isTypedArray(r))for(let o=0,l=r.length;o!==l;++o){const c=r[o];if(isNaN(c)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,o,c),e=!1;break}}return e}optimize(){const e=Tt.arraySlice(this.times),t=Tt.arraySlice(this.values),n=this.getValueSize(),r=this.getInterpolation()===Zc,i=e.length-1;let s=1;for(let o=1;o<i;++o){let l=!1;const c=e[o],u=e[o+1];if(c!==u&&(o!==1||c!==e[0]))if(r)l=!0;else{const f=o*n,h=f-n,d=f+n;for(let p=0;p!==n;++p){const v=t[f+p];if(v!==t[h+p]||v!==t[d+p]){l=!0;break}}}if(l){if(o!==s){e[s]=e[o];const f=o*n,h=s*n;for(let d=0;d!==n;++d)t[h+d]=t[f+d]}++s}}if(i>0){e[s]=e[i];for(let o=i*n,l=s*n,c=0;c!==n;++c)t[l+c]=t[o+c];++s}return s!==e.length?(this.times=Tt.arraySlice(e,0,s),this.values=Tt.arraySlice(t,0,s*n)):(this.times=e,this.values=t),this}clone(){const e=Tt.arraySlice(this.times,0),t=Tt.arraySlice(this.values,0),n=this.constructor,r=new n(this.name,e,t);return r.createInterpolant=this.createInterpolant,r}}En.prototype.TimeBufferType=Float32Array;En.prototype.ValueBufferType=Float32Array;En.prototype.DefaultInterpolation=ac;class fs extends En{}fs.prototype.ValueTypeName="bool";fs.prototype.ValueBufferType=Array;fs.prototype.DefaultInterpolation=ic;fs.prototype.InterpolantFactoryMethodLinear=void 0;fs.prototype.InterpolantFactoryMethodSmooth=void 0;class Lg extends En{}Lg.prototype.ValueTypeName="color";class lc extends En{}lc.prototype.ValueTypeName="number";class CE extends bi{constructor(e,t,n,r){super(e,t,n,r)}interpolate_(e,t,n,r){const i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=(n-t)/(r-t);let c=e*o;for(let u=c+o;c!==u;c+=4)Xt.slerpFlat(i,0,s,c-o,s,c,l);return i}}class Mo extends En{InterpolantFactoryMethodLinear(e){return new CE(this.times,this.values,this.getValueSize(),e)}}Mo.prototype.ValueTypeName="quaternion";Mo.prototype.DefaultInterpolation=ac;Mo.prototype.InterpolantFactoryMethodSmooth=void 0;class hs extends En{}hs.prototype.ValueTypeName="string";hs.prototype.ValueBufferType=Array;hs.prototype.DefaultInterpolation=ic;hs.prototype.InterpolantFactoryMethodLinear=void 0;hs.prototype.InterpolantFactoryMethodSmooth=void 0;class cc extends En{}cc.prototype.ValueTypeName="vector";class Xp{constructor(e,t=-1,n,r=th){this.name=e,this.tracks=n,this.duration=t,this.blendMode=r,this.uuid=on(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],n=e.tracks,r=1/(e.fps||1);for(let s=0,o=n.length;s!==o;++s)t.push(TE(n[s]).scale(r));const i=new this(e.name,e.duration,t,e.blendMode);return i.uuid=e.uuid,i}static toJSON(e){const t=[],n=e.tracks,r={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let i=0,s=n.length;i!==s;++i)t.push(En.toJSON(n[i]));return r}static CreateFromMorphTargetSequence(e,t,n,r){const i=t.length,s=[];for(let o=0;o<i;o++){let l=[],c=[];l.push((o+i-1)%i,o,(o+1)%i),c.push(0,1,0);const u=Tt.getKeyframeOrder(l);l=Tt.sortedArray(l,1,u),c=Tt.sortedArray(c,1,u),!r&&l[0]===0&&(l.push(i),c.push(c[0])),s.push(new lc(".morphTargetInfluences["+t[o].name+"]",l,c).scale(1/n))}return new this(e,-1,s)}static findByName(e,t){let n=e;if(!Array.isArray(e)){const r=e;n=r.geometry&&r.geometry.animations||r.animations}for(let r=0;r<n.length;r++)if(n[r].name===t)return n[r];return null}static CreateClipsFromMorphTargetSequences(e,t,n){const r={},i=/^([\w-]*?)([\d]+)$/;for(let o=0,l=e.length;o<l;o++){const c=e[o],u=c.name.match(i);if(u&&u.length>1){const f=u[1];let h=r[f];h||(r[f]=h=[]),h.push(c)}}const s=[];for(const o in r)s.push(this.CreateFromMorphTargetSequence(o,r[o],t,n));return s}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const n=function(f,h,d,p,v){if(d.length!==0){const _=[],m=[];Tt.flattenJSON(d,_,m,p),_.length!==0&&v.push(new f(h,_,m))}},r=[],i=e.name||"default",s=e.fps||30,o=e.blendMode;let l=e.length||-1;const c=e.hierarchy||[];for(let f=0;f<c.length;f++){const h=c[f].keys;if(!(!h||h.length===0))if(h[0].morphTargets){const d={};let p;for(p=0;p<h.length;p++)if(h[p].morphTargets)for(let v=0;v<h[p].morphTargets.length;v++)d[h[p].morphTargets[v]]=-1;for(const v in d){const _=[],m=[];for(let g=0;g!==h[p].morphTargets.length;++g){const y=h[p];_.push(y.time),m.push(y.morphTarget===v?1:0)}r.push(new lc(".morphTargetInfluence["+v+"]",_,m))}l=d.length*s}else{const d=".bones["+t[f].name+"]";n(cc,d+".position",h,"pos",r),n(Mo,d+".quaternion",h,"rot",r),n(cc,d+".scale",h,"scl",r)}}return r.length===0?null:new this(i,l,r,o)}resetDuration(){const e=this.tracks;let t=0;for(let n=0,r=e.length;n!==r;++n){const i=this.tracks[n];t=Math.max(t,i.times[i.times.length-1])}return this.duration=t,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function AE(a){switch(a.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return lc;case"vector":case"vector2":case"vector3":case"vector4":return cc;case"color":return Lg;case"quaternion":return Mo;case"bool":case"boolean":return fs;case"string":return hs}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+a)}function TE(a){if(a.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=AE(a.type);if(a.times===void 0){const t=[],n=[];Tt.flattenJSON(a.keys,t,n,"value"),a.times=t,a.values=n}return e.parse!==void 0?e.parse(a):new e(a.name,a.times,a.values,a.interpolation)}const rs={enabled:!1,files:{},add:function(a,e){this.enabled!==!1&&(this.files[a]=e)},get:function(a){if(this.enabled!==!1)return this.files[a]},remove:function(a){delete this.files[a]},clear:function(){this.files={}}};class RE{constructor(e,t,n){const r=this;let i=!1,s=0,o=0,l;const c=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(u){o++,i===!1&&r.onStart!==void 0&&r.onStart(u,s,o),i=!0},this.itemEnd=function(u){s++,r.onProgress!==void 0&&r.onProgress(u,s,o),s===o&&(i=!1,r.onLoad!==void 0&&r.onLoad())},this.itemError=function(u){r.onError!==void 0&&r.onError(u)},this.resolveURL=function(u){return l?l(u):u},this.setURLModifier=function(u){return l=u,this},this.addHandler=function(u,f){return c.push(u,f),this},this.removeHandler=function(u){const f=c.indexOf(u);return f!==-1&&c.splice(f,2),this},this.getHandler=function(u){for(let f=0,h=c.length;f<h;f+=2){const d=c[f],p=c[f+1];if(d.global&&(d.lastIndex=0),d.test(u))return p}return null}}}const LE=new RE;let Ai=class{constructor(e){this.manager=e!==void 0?e:LE,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const n=this;return new Promise(function(r,i){n.load(e,r,t,i)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}};const rn={};let PE=class extends Ai{constructor(e){super(e)}load(e,t,n,r){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,s=rs.get(e);if(s!==void 0)return i.manager.itemStart(e),setTimeout(function(){t&&t(s),i.manager.itemEnd(e)},0),s;if(rn[e]!==void 0){rn[e].push({onLoad:t,onProgress:n,onError:r});return}const o=/^data:(.*?)(;base64)?,(.*)$/,l=e.match(o);let c;if(l){const u=l[1],f=!!l[2];let h=l[3];h=decodeURIComponent(h),f&&(h=atob(h));try{let d;const p=(this.responseType||"").toLowerCase();switch(p){case"arraybuffer":case"blob":const v=new Uint8Array(h.length);for(let m=0;m<h.length;m++)v[m]=h.charCodeAt(m);p==="blob"?d=new Blob([v.buffer],{type:u}):d=v.buffer;break;case"document":d=new DOMParser().parseFromString(h,u);break;case"json":d=JSON.parse(h);break;default:d=h;break}setTimeout(function(){t&&t(d),i.manager.itemEnd(e)},0)}catch(d){setTimeout(function(){r&&r(d),i.manager.itemError(e),i.manager.itemEnd(e)},0)}}else{rn[e]=[],rn[e].push({onLoad:t,onProgress:n,onError:r}),c=new XMLHttpRequest,c.open("GET",e,!0),c.addEventListener("load",function(u){const f=this.response,h=rn[e];if(delete rn[e],this.status===200||this.status===0){this.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),rs.add(e,f);for(let d=0,p=h.length;d<p;d++){const v=h[d];v.onLoad&&v.onLoad(f)}i.manager.itemEnd(e)}else{for(let d=0,p=h.length;d<p;d++){const v=h[d];v.onError&&v.onError(u)}i.manager.itemError(e),i.manager.itemEnd(e)}},!1),c.addEventListener("progress",function(u){const f=rn[e];for(let h=0,d=f.length;h<d;h++){const p=f[h];p.onProgress&&p.onProgress(u)}},!1),c.addEventListener("error",function(u){const f=rn[e];delete rn[e];for(let h=0,d=f.length;h<d;h++){const p=f[h];p.onError&&p.onError(u)}i.manager.itemError(e),i.manager.itemEnd(e)},!1),c.addEventListener("abort",function(u){const f=rn[e];delete rn[e];for(let h=0,d=f.length;h<d;h++){const p=f[h];p.onError&&p.onError(u)}i.manager.itemError(e),i.manager.itemEnd(e)},!1),this.responseType!==void 0&&(c.responseType=this.responseType),this.withCredentials!==void 0&&(c.withCredentials=this.withCredentials),c.overrideMimeType&&c.overrideMimeType(this.mimeType!==void 0?this.mimeType:"text/plain");for(const u in this.requestHeader)c.setRequestHeader(u,this.requestHeader[u]);c.send(null)}return i.manager.itemStart(e),c}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}};class Pg extends Ai{constructor(e){super(e)}load(e,t,n,r){this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,s=rs.get(e);if(s!==void 0)return i.manager.itemStart(e),setTimeout(function(){t&&t(s),i.manager.itemEnd(e)},0),s;const o=document.createElementNS("http://www.w3.org/1999/xhtml","img");function l(){o.removeEventListener("load",l,!1),o.removeEventListener("error",c,!1),rs.add(e,this),t&&t(this),i.manager.itemEnd(e)}function c(u){o.removeEventListener("load",l,!1),o.removeEventListener("error",c,!1),r&&r(u),i.manager.itemError(e),i.manager.itemEnd(e)}return o.addEventListener("load",l,!1),o.addEventListener("error",c,!1),e.substr(0,5)!=="data:"&&this.crossOrigin!==void 0&&(o.crossOrigin=this.crossOrigin),i.manager.itemStart(e),o.src=e,o}}class NE extends Ai{constructor(e){super(e)}load(e,t,n,r){const i=new Cc,s=new Pg(this.manager);s.setCrossOrigin(this.crossOrigin),s.setPath(this.path);let o=0;function l(c){s.load(e[c],function(u){i.images[c]=u,o++,o===6&&(i.needsUpdate=!0,t&&t(i))},void 0,r)}for(let c=0;c<e.length;++c)l(c);return i}}class IE extends Ai{constructor(e){super(e)}load(e,t,n,r){const i=new Qt,s=new Pg(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,function(o){i.image=o;const l=e.search(/\.jpe?g($|\?)/i)>0||e.search(/^data\:image\/jpeg/)===0;i.format=l?fi:Ft,i.needsUpdate=!0,t!==void 0&&t(i)},n,r),i}}class kE extends Yr{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Rc(t,e))}getPoint(e){const t=e*this.getLength(),n=this.getCurveLengths();let r=0;for(;r<n.length;){if(n[r]>=t){const i=n[r]-t,s=this.curves[r],o=s.getLength(),l=o===0?0:1-i/o;return s.getPointAt(l)}r++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let n=0,r=this.curves.length;n<r;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let n=0;n<=e;n++)t.push(this.getPoint(n/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let n;for(let r=0,i=this.curves;r<i.length;r++){const s=i[r],o=s&&s.isEllipseCurve?e*2:s&&(s.isLineCurve||s.isLineCurve3)?1:s&&s.isSplineCurve?e*s.points.length:e,l=s.getPoints(o);for(let c=0;c<l.length;c++){const u=l[c];n&&n.equals(u)||(t.push(u),n=u)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,n=e.curves.length;t<n;t++){const r=e.curves[t];this.curves.push(r.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,n=this.curves.length;t<n;t++){const r=this.curves[t];e.curves.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,n=e.curves.length;t<n;t++){const r=e.curves[t];this.curves.push(new Mg[r.type]().fromJSON(r))}return this}}class Rf extends kE{constructor(e){super(),this.type="Path",this.currentPoint=new ve,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const n=new Rc(this.currentPoint.clone(),new ve(e,t));return this.curves.push(n),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,n,r){const i=new ph(this.currentPoint.clone(),new ve(e,t),new ve(n,r));return this.curves.push(i),this.currentPoint.set(n,r),this}bezierCurveTo(e,t,n,r,i,s){const o=new dh(this.currentPoint.clone(),new ve(e,t),new ve(n,r),new ve(i,s));return this.curves.push(o),this.currentPoint.set(i,s),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),n=new mh(t);return this.curves.push(n),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,n,r,i,s){const o=this.currentPoint.x,l=this.currentPoint.y;return this.absarc(e+o,t+l,n,r,i,s),this}absarc(e,t,n,r,i,s){return this.absellipse(e,t,n,n,r,i,s),this}ellipse(e,t,n,r,i,s,o,l){const c=this.currentPoint.x,u=this.currentPoint.y;return this.absellipse(e+c,t+u,n,r,i,s,o,l),this}absellipse(e,t,n,r,i,s,o,l){const c=new Tc(e,t,n,r,i,s,o,l);if(this.curves.length>0){const f=c.getPoint(0);f.equals(this.currentPoint)||this.lineTo(f.x,f.y)}this.curves.push(c);const u=c.getPoint(1);return this.currentPoint.copy(u),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class gh extends Rf{constructor(e){super(e),this.uuid=on(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let n=0,r=this.holes.length;n<r;n++)t[n]=this.holes[n].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,n=e.holes.length;t<n;t++){const r=e.holes[t];this.holes.push(r.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,n=this.holes.length;t<n;t++){const r=this.holes[t];e.holes.push(r.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,n=e.holes.length;t<n;t++){const r=e.holes[t];this.holes.push(new Rf().fromJSON(r))}return this}}class bn extends lt{constructor(e,t=1){super(),this.type="Light",this.color=new ze(e),this.intensity=t}dispose(){}copy(e){return super.copy(e),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,this.groundColor!==void 0&&(t.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(t.object.distance=this.distance),this.angle!==void 0&&(t.object.angle=this.angle),this.decay!==void 0&&(t.object.decay=this.decay),this.penumbra!==void 0&&(t.object.penumbra=this.penumbra),this.shadow!==void 0&&(t.object.shadow=this.shadow.toJSON()),t}}bn.prototype.isLight=!0;class OE extends bn{constructor(e,t,n){super(e,n),this.type="HemisphereLight",this.position.copy(lt.DefaultUp),this.updateMatrix(),this.groundColor=new ze(t)}copy(e){return bn.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}OE.prototype.isHemisphereLight=!0;const jp=new Ce,Yp=new b,qp=new b;class _h{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new ve(512,512),this.map=null,this.mapPass=null,this.matrix=new Ce,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Ac,this._frameExtents=new ve(1,1),this._viewportCount=1,this._viewports=[new ht(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;Yp.setFromMatrixPosition(e.matrixWorld),t.position.copy(Yp),qp.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(qp),t.updateMatrixWorld(),jp.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(jp),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(t.projectionMatrix),n.multiply(t.matrixWorldInverse)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const e={};return this.bias!==0&&(e.bias=this.bias),this.normalBias!==0&&(e.normalBias=this.normalBias),this.radius!==1&&(e.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Ng extends _h{constructor(){super(new Bt(50,1,.5,500)),this.focus=1}updateMatrices(e){const t=this.camera,n=oo*2*e.angle*this.focus,r=this.mapSize.width/this.mapSize.height,i=e.distance||t.far;(n!==t.fov||r!==t.aspect||i!==t.far)&&(t.fov=n,t.aspect=r,t.far=i,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}Ng.prototype.isSpotLightShadow=!0;class DE extends bn{constructor(e,t,n=0,r=Math.PI/3,i=0,s=1){super(e,t),this.type="SpotLight",this.position.copy(lt.DefaultUp),this.updateMatrix(),this.target=new lt,this.distance=n,this.angle=r,this.penumbra=i,this.decay=s,this.shadow=new Ng}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}DE.prototype.isSpotLight=!0;const $p=new Ce,Is=new b,Lu=new b;class Ig extends _h{constructor(){super(new Bt(90,1,.5,500)),this._frameExtents=new ve(4,2),this._viewportCount=6,this._viewports=[new ht(2,1,1,1),new ht(0,1,1,1),new ht(3,1,1,1),new ht(1,1,1,1),new ht(3,0,1,1),new ht(1,0,1,1)],this._cubeDirections=[new b(1,0,0),new b(-1,0,0),new b(0,0,1),new b(0,0,-1),new b(0,1,0),new b(0,-1,0)],this._cubeUps=[new b(0,1,0),new b(0,1,0),new b(0,1,0),new b(0,1,0),new b(0,0,1),new b(0,0,-1)]}updateMatrices(e,t=0){const n=this.camera,r=this.matrix,i=e.distance||n.far;i!==n.far&&(n.far=i,n.updateProjectionMatrix()),Is.setFromMatrixPosition(e.matrixWorld),n.position.copy(Is),Lu.copy(n.position),Lu.add(this._cubeDirections[t]),n.up.copy(this._cubeUps[t]),n.lookAt(Lu),n.updateMatrixWorld(),r.makeTranslation(-Is.x,-Is.y,-Is.z),$p.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix($p)}}Ig.prototype.isPointLightShadow=!0;class FE extends bn{constructor(e,t,n=0,r=1){super(e,t),this.type="PointLight",this.distance=n,this.decay=r,this.shadow=new Ig}get power(){return this.intensity*4*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}FE.prototype.isPointLight=!0;class kg extends _h{constructor(){super(new ls(-5,5,5,-5,.5,500))}}kg.prototype.isDirectionalLightShadow=!0;class Og extends bn{constructor(e,t){super(e,t),this.type="DirectionalLight",this.position.copy(lt.DefaultUp),this.updateMatrix(),this.target=new lt,this.shadow=new kg}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}Og.prototype.isDirectionalLight=!0;class Dg extends bn{constructor(e,t){super(e,t),this.type="AmbientLight"}}Dg.prototype.isAmbientLight=!0;class BE extends bn{constructor(e,t,n=10,r=10){super(e,t),this.type="RectAreaLight",this.width=n,this.height=r}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}BE.prototype.isRectAreaLight=!0;class Fg{constructor(){this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new b)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const n=e.x,r=e.y,i=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.282095),t.addScaledVector(s[1],.488603*r),t.addScaledVector(s[2],.488603*i),t.addScaledVector(s[3],.488603*n),t.addScaledVector(s[4],1.092548*(n*r)),t.addScaledVector(s[5],1.092548*(r*i)),t.addScaledVector(s[6],.315392*(3*i*i-1)),t.addScaledVector(s[7],1.092548*(n*i)),t.addScaledVector(s[8],.546274*(n*n-r*r)),t}getIrradianceAt(e,t){const n=e.x,r=e.y,i=e.z,s=this.coefficients;return t.copy(s[0]).multiplyScalar(.886227),t.addScaledVector(s[1],2*.511664*r),t.addScaledVector(s[2],2*.511664*i),t.addScaledVector(s[3],2*.511664*n),t.addScaledVector(s[4],2*.429043*n*r),t.addScaledVector(s[5],2*.429043*r*i),t.addScaledVector(s[6],.743125*i*i-.247708),t.addScaledVector(s[7],2*.429043*n*i),t.addScaledVector(s[8],.429043*(n*n-r*r)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let n=0;n<9;n++)this.coefficients[n].addScaledVector(e.coefficients[n],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let n=0;n<9;n++)this.coefficients[n].lerp(e.coefficients[n],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(e,t=0){const n=this.coefficients;for(let r=0;r<9;r++)n[r].fromArray(e,t+r*3);return this}toArray(e=[],t=0){const n=this.coefficients;for(let r=0;r<9;r++)n[r].toArray(e,t+r*3);return e}static getBasisAt(e,t){const n=e.x,r=e.y,i=e.z;t[0]=.282095,t[1]=.488603*r,t[2]=.488603*i,t[3]=.488603*n,t[4]=1.092548*n*r,t[5]=1.092548*r*i,t[6]=.315392*(3*i*i-1),t[7]=1.092548*n*i,t[8]=.546274*(n*n-r*r)}}Fg.prototype.isSphericalHarmonics3=!0;class yh extends bn{constructor(e=new Fg,t=1){super(void 0,t),this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}yh.prototype.isLightProbe=!0;class zE{static decodeText(e){if(typeof TextDecoder<"u")return new TextDecoder().decode(e);let t="";for(let n=0,r=e.length;n<r;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch{return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substr(0,t+1)}}class wi extends at{constructor(){super(),this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}clone(){return new this.constructor().copy(this)}toJSON(){const e=super.toJSON(this);return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}wi.prototype.isInstancedBufferGeometry=!0;class Mr extends Ze{constructor(e,t,n,r=1){typeof n=="number"&&(r=n,n=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),super(e,t,n),this.meshPerAttribute=r}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}Mr.prototype.isInstancedBufferAttribute=!0;class VE extends Ai{constructor(e){super(e),typeof createImageBitmap>"u"&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,n,r){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const i=this,s=rs.get(e);if(s!==void 0)return i.manager.itemStart(e),setTimeout(function(){t&&t(s),i.manager.itemEnd(e)},0),s;const o={};o.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",o.headers=this.requestHeader,fetch(e,o).then(function(l){return l.blob()}).then(function(l){return createImageBitmap(l,Object.assign(i.options,{colorSpaceConversion:"none"}))}).then(function(l){rs.add(e,l),t&&t(l),i.manager.itemEnd(e)}).catch(function(l){r&&r(l),i.manager.itemError(e),i.manager.itemEnd(e)}),i.manager.itemStart(e)}}VE.prototype.isImageBitmapLoader=!0;let wl;const UE={getContext:function(){return wl===void 0&&(wl=new(window.AudioContext||window.webkitAudioContext)),wl},setContext:function(a){wl=a}};class GE extends Ai{constructor(e){super(e)}load(e,t,n,r){const i=this,s=new PE(this.manager);s.setResponseType("arraybuffer"),s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(o){try{const l=o.slice(0);UE.getContext().decodeAudioData(l,function(u){t(u)})}catch(l){r?r(l):console.error(l),i.manager.itemError(e)}},n,r)}}class HE extends yh{constructor(e,t,n=1){super(void 0,n);const r=new ze().set(e),i=new ze().set(t),s=new b(r.r,r.g,r.b),o=new b(i.r,i.g,i.b),l=Math.sqrt(Math.PI),c=l*Math.sqrt(.75);this.sh.coefficients[0].copy(s).add(o).multiplyScalar(l),this.sh.coefficients[1].copy(s).sub(o).multiplyScalar(c)}}HE.prototype.isHemisphereLightProbe=!0;class WE extends yh{constructor(e,t=1){super(void 0,t);const n=new ze().set(e);this.sh.coefficients[0].set(n.r,n.g,n.b).multiplyScalar(2*Math.sqrt(Math.PI))}}WE.prototype.isAmbientLightProbe=!0;const Zp=new Ce,Kp=new Ce;class Bg{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Bt,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Bt,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep;const r=e.projectionMatrix.clone(),i=t.eyeSep/2,s=i*t.near/t.focus,o=t.near*Math.tan(Ya*t.fov*.5)/t.zoom;let l,c;Kp.elements[12]=-i,Zp.elements[12]=i,l=-o*t.aspect+s,c=o*t.aspect+s,r.elements[0]=2*t.near/(c-l),r.elements[8]=(c+l)/(c-l),this.cameraL.projectionMatrix.copy(r),l=-o*t.aspect-s,c=o*t.aspect-s,r.elements[0]=2*t.near/(c-l),r.elements[8]=(c+l)/(c-l),this.cameraR.projectionMatrix.copy(r)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(Kp),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(Zp)}}class XE extends lt{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(this.isPlaying===!0){console.warn("THREE.Audio: Audio is already playing.");return}if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.isPlaying===!0&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,this.loop===!0&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this}stop(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}getFilters(){return this.filters}setFilters(e){return e||(e=[]),this._connected===!0?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){if(this.detune=e,this.source.detune!==void 0)return this.isPlaying===!0&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.playbackRate=e,this.isPlaying===!0&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.loop=e,this.isPlaying===!0&&(this.source.loop=this.loop),this}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}class jE{constructor(e,t,n){this.binding=e,this.valueSize=n;let r,i,s;switch(t){case"quaternion":r=this._slerp,i=this._slerpAdditive,s=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(n*6),this._workIndex=5;break;case"string":case"bool":r=this._select,i=this._select,s=this._setAdditiveIdentityOther,this.buffer=new Array(n*5);break;default:r=this._lerp,i=this._lerpAdditive,s=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(n*5)}this._mixBufferRegion=r,this._mixBufferRegionAdditive=i,this._setIdentity=s,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const n=this.buffer,r=this.valueSize,i=e*r+r;let s=this.cumulativeWeight;if(s===0){for(let o=0;o!==r;++o)n[i+o]=n[o];s=t}else{s+=t;const o=t/s;this._mixBufferRegion(n,i,0,o,r)}this.cumulativeWeight=s}accumulateAdditive(e){const t=this.buffer,n=this.valueSize,r=n*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(t,r,0,e,n),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,n=this.buffer,r=e*t+t,i=this.cumulativeWeight,s=this.cumulativeWeightAdditive,o=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,i<1){const l=t*this._origIndex;this._mixBufferRegion(n,r,l,1-i,t)}s>0&&this._mixBufferRegionAdditive(n,r,this._addIndex*t,1,t);for(let l=t,c=t+t;l!==c;++l)if(n[l]!==n[l+t]){o.setValue(n,r);break}}saveOriginalState(){const e=this.binding,t=this.buffer,n=this.valueSize,r=n*this._origIndex;e.getValue(t,r);for(let i=n,s=r;i!==s;++i)t[i]=t[r+i%n];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=this.valueSize*3;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let n=e;n<t;n++)this.buffer[n]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let n=0;n<this.valueSize;n++)this.buffer[t+n]=this.buffer[e+n]}_select(e,t,n,r,i){if(r>=.5)for(let s=0;s!==i;++s)e[t+s]=e[n+s]}_slerp(e,t,n,r){Xt.slerpFlat(e,t,e,t,e,n,r)}_slerpAdditive(e,t,n,r,i){const s=this._workIndex*i;Xt.multiplyQuaternionsFlat(e,s,e,t,e,n),Xt.slerpFlat(e,t,e,t,e,s,r)}_lerp(e,t,n,r,i){const s=1-r;for(let o=0;o!==i;++o){const l=t+o;e[l]=e[l]*s+e[n+o]*r}}_lerpAdditive(e,t,n,r,i){for(let s=0;s!==i;++s){const o=t+s;e[o]=e[o]+e[n+s]*r}}}const xh="\\[\\]\\.:\\/",YE=new RegExp("["+xh+"]","g"),Sh="[^"+xh+"]",qE="[^"+xh.replace("\\.","")+"]",$E=/((?:WC+[\/:])*)/.source.replace("WC",Sh),ZE=/(WCOD+)?/.source.replace("WCOD",qE),KE=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Sh),JE=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Sh),QE=new RegExp("^"+$E+ZE+KE+JE+"$"),eC=["material","materials","bones"];class tC{constructor(e,t,n){const r=n||yt.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,r)}getValue(e,t){this.bind();const n=this._targetGroup.nCachedObjects_,r=this._bindings[n];r!==void 0&&r.getValue(e,t)}setValue(e,t){const n=this._bindings;for(let r=this._targetGroup.nCachedObjects_,i=n.length;r!==i;++r)n[r].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].unbind()}}class yt{constructor(e,t,n){this.path=t,this.parsedPath=n||yt.parseTrackName(t),this.node=yt.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,n){return e&&e.isAnimationObjectGroup?new yt.Composite(e,t,n):new yt(e,t,n)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(YE,"")}static parseTrackName(e){const t=QE.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const n={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},r=n.nodeName&&n.nodeName.lastIndexOf(".");if(r!==void 0&&r!==-1){const i=n.nodeName.substring(r+1);eC.indexOf(i)!==-1&&(n.nodeName=n.nodeName.substring(0,r),n.objectName=i)}if(n.propertyName===null||n.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return n}static findNode(e,t){if(!t||t===""||t==="."||t===-1||t===e.name||t===e.uuid)return e;if(e.skeleton){const n=e.skeleton.getBoneByName(t);if(n!==void 0)return n}if(e.children){const n=function(i){for(let s=0;s<i.length;s++){const o=i[s];if(o.name===t||o.uuid===t)return o;const l=n(o.children);if(l)return l}return null},r=n(e.children);if(r)return r}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.node[this.propertyName]}_getValue_array(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)e[t++]=n[r]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const n=this.resolvedProperty;for(let r=0,i=n.length;r!==i;++r)n[r]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,n=t.objectName,r=t.propertyName;let i=t.propertyIndex;if(e||(e=yt.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e){console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");return}if(n){let c=t.objectIndex;switch(n){case"materials":if(!e.material){console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.materials){console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);return}e=e.material.materials;break;case"bones":if(!e.skeleton){console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);return}e=e.skeleton.bones;for(let u=0;u<e.length;u++)if(e[u].name===c){c=u;break}break;default:if(e[n]===void 0){console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);return}e=e[n]}if(c!==void 0){if(e[c]===void 0){console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);return}e=e[c]}}const s=e[r];if(s===void 0){const c=t.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+c+"."+r+" but it wasn't found.",e);return}let o=this.Versioning.None;this.targetObject=e,e.needsUpdate!==void 0?o=this.Versioning.NeedsUpdate:e.matrixWorldNeedsUpdate!==void 0&&(o=this.Versioning.MatrixWorldNeedsUpdate);let l=this.BindingType.Direct;if(i!==void 0){if(r==="morphTargetInfluences"){if(!e.geometry){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);return}if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);return}e.morphTargetDictionary[i]!==void 0&&(i=e.morphTargetDictionary[i])}else{console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);return}}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=i}else s.fromArray!==void 0&&s.toArray!==void 0?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=r;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}yt.Composite=tC;yt.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3};yt.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2};yt.prototype.GetterByBindingType=[yt.prototype._getValue_direct,yt.prototype._getValue_array,yt.prototype._getValue_arrayElement,yt.prototype._getValue_toArray];yt.prototype.SetterByBindingTypeAndVersioning=[[yt.prototype._setValue_direct,yt.prototype._setValue_direct_setNeedsUpdate,yt.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[yt.prototype._setValue_array,yt.prototype._setValue_array_setNeedsUpdate,yt.prototype._setValue_array_setMatrixWorldNeedsUpdate],[yt.prototype._setValue_arrayElement,yt.prototype._setValue_arrayElement_setNeedsUpdate,yt.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[yt.prototype._setValue_fromArray,yt.prototype._setValue_fromArray_setNeedsUpdate,yt.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class rC{constructor(e,t,n=null,r=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=n,this.blendMode=r;const i=t.tracks,s=i.length,o=new Array(s),l={endingStart:Ga,endingEnd:Ga};for(let c=0;c!==s;++c){const u=i[c].createInterpolant(null);o[c]=u,u.settings=l}this._interpolantSettings=l,this._interpolants=o,this._propertyBindings=new Array(s),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=D1,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,n){if(e.fadeOut(t),this.fadeIn(t),n){const r=this._clip.duration,i=e._clip.duration,s=i/r,o=r/i;e.warp(1,s,t),this.warp(o,1,t)}return this}crossFadeTo(e,t,n){return e.crossFadeFrom(this,t,n)}stopFading(){const e=this._weightInterpolant;return e!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,n){const r=this._mixer,i=r.time,s=this.timeScale;let o=this._timeScaleInterpolant;o===null&&(o=r._lendControlInterpolant(),this._timeScaleInterpolant=o);const l=o.parameterPositions,c=o.sampleValues;return l[0]=i,l[1]=i+n,c[0]=e/s,c[1]=t/s,this}stopWarping(){const e=this._timeScaleInterpolant;return e!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,n,r){if(!this.enabled){this._updateWeight(e);return}const i=this._startTime;if(i!==null){const l=(e-i)*n;if(l<0||n===0)return;this._startTime=null,t=n*l}t*=this._updateTimeScale(e);const s=this._updateTime(t),o=this._updateWeight(e);if(o>0){const l=this._interpolants,c=this._propertyBindings;switch(this.blendMode){case Gv:for(let u=0,f=l.length;u!==f;++u)l[u].evaluate(s),c[u].accumulateAdditive(o);break;case th:default:for(let u=0,f=l.length;u!==f;++u)l[u].evaluate(s),c[u].accumulate(r,o)}}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const n=this._weightInterpolant;if(n!==null){const r=n.evaluate(e)[0];t*=r,e>n.parameterPositions[1]&&(this.stopFading(),r===0&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const n=this._timeScaleInterpolant;if(n!==null){const r=n.evaluate(e)[0];t*=r,e>n.parameterPositions[1]&&(this.stopWarping(),t===0?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,n=this.loop;let r=this.time+e,i=this._loopCount;const s=n===F1;if(e===0)return i===-1?r:s&&(i&1)===1?t-r:r;if(n===O1){i===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(r>=t)r=t;else if(r<0)r=0;else{this.time=r;break e}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(i===-1&&(e>=0?(i=0,this._setEndings(!0,this.repetitions===0,s)):this._setEndings(this.repetitions===0,!0,s)),r>=t||r<0){const o=Math.floor(r/t);r-=t*o,i+=Math.abs(o);const l=this.repetitions-i;if(l<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,r=e>0?t:0,this.time=r,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(l===1){const c=e<0;this._setEndings(c,!c,s)}else this._setEndings(!1,!1,s);this._loopCount=i,this.time=r,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}else this.time=r;if(s&&(i&1)===1)return t-r}return r}_setEndings(e,t,n){const r=this._interpolantSettings;n?(r.endingStart=Ha,r.endingEnd=Ha):(e?r.endingStart=this.zeroSlopeAtStart?Ha:Ga:r.endingStart=sc,t?r.endingEnd=this.zeroSlopeAtEnd?Ha:Ga:r.endingEnd=sc)}_scheduleFading(e,t,n){const r=this._mixer,i=r.time;let s=this._weightInterpolant;s===null&&(s=r._lendControlInterpolant(),this._weightInterpolant=s);const o=s.parameterPositions,l=s.sampleValues;return o[0]=i,l[0]=t,o[1]=i+e,l[1]=n,this}}class nC extends Ji{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const n=e._localRoot||this._root,r=e._clip.tracks,i=r.length,s=e._propertyBindings,o=e._interpolants,l=n.uuid,c=this._bindingsByRootAndName;let u=c[l];u===void 0&&(u={},c[l]=u);for(let f=0;f!==i;++f){const h=r[f],d=h.name;let p=u[d];if(p!==void 0)s[f]=p;else{if(p=s[f],p!==void 0){p._cacheIndex===null&&(++p.referenceCount,this._addInactiveBinding(p,l,d));continue}const v=t&&t._propertyBindings[f].binding.parsedPath;p=new jE(yt.create(n,d,v),h.ValueTypeName,h.getValueSize()),++p.referenceCount,this._addInactiveBinding(p,l,d),s[f]=p}o[f].resultBuffer=p.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(e._cacheIndex===null){const n=(e._localRoot||this._root).uuid,r=e._clip.uuid,i=this._actionsByClip[r];this._bindAction(e,i&&i.knownActions[0]),this._addInactiveAction(e,r,n)}const t=e._propertyBindings;for(let n=0,r=t.length;n!==r;++n){const i=t[n];i.useCount++===0&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let n=0,r=t.length;n!==r;++n){const i=t[n];--i.useCount===0&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return t!==null&&t<this._nActiveActions}_addInactiveAction(e,t,n){const r=this._actions,i=this._actionsByClip;let s=i[t];if(s===void 0)s={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,i[t]=s;else{const o=s.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=r.length,r.push(e),s.actionByRoot[n]=e}_removeInactiveAction(e){const t=this._actions,n=t[t.length-1],r=e._cacheIndex;n._cacheIndex=r,t[r]=n,t.pop(),e._cacheIndex=null;const i=e._clip.uuid,s=this._actionsByClip,o=s[i],l=o.knownActions,c=l[l.length-1],u=e._byClipCacheIndex;c._byClipCacheIndex=u,l[u]=c,l.pop(),e._byClipCacheIndex=null;const f=o.actionByRoot,h=(e._localRoot||this._root).uuid;delete f[h],l.length===0&&delete s[i],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let n=0,r=t.length;n!==r;++n){const i=t[n];--i.referenceCount===0&&this._removeInactiveBinding(i)}}_lendAction(e){const t=this._actions,n=e._cacheIndex,r=this._nActiveActions++,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_takeBackAction(e){const t=this._actions,n=e._cacheIndex,r=--this._nActiveActions,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_addInactiveBinding(e,t,n){const r=this._bindingsByRootAndName,i=this._bindings;let s=r[t];s===void 0&&(s={},r[t]=s),s[n]=e,e._cacheIndex=i.length,i.push(e)}_removeInactiveBinding(e){const t=this._bindings,n=e.binding,r=n.rootNode.uuid,i=n.path,s=this._bindingsByRootAndName,o=s[r],l=t[t.length-1],c=e._cacheIndex;l._cacheIndex=c,t[c]=l,t.pop(),delete o[i],Object.keys(o).length===0&&delete s[r]}_lendBinding(e){const t=this._bindings,n=e._cacheIndex,r=this._nActiveBindings++,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_takeBackBinding(e){const t=this._bindings,n=e._cacheIndex,r=--this._nActiveBindings,i=t[r];e._cacheIndex=r,t[r]=e,i._cacheIndex=n,t[n]=i}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let n=e[t];return n===void 0&&(n=new Rg(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),n.__cacheIndex=t,e[t]=n),n}_takeBackControlInterpolant(e){const t=this._controlInterpolants,n=e.__cacheIndex,r=--this._nActiveControlInterpolants,i=t[r];e.__cacheIndex=r,t[r]=e,i.__cacheIndex=n,t[n]=i}clipAction(e,t,n){const r=t||this._root,i=r.uuid;let s=typeof e=="string"?Xp.findByName(r,e):e;const o=s!==null?s.uuid:e,l=this._actionsByClip[o];let c=null;if(n===void 0&&(s!==null?n=s.blendMode:n=th),l!==void 0){const f=l.actionByRoot[i];if(f!==void 0&&f.blendMode===n)return f;c=l.knownActions[0],s===null&&(s=c._clip)}if(s===null)return null;const u=new rC(this,s,t,n);return this._bindAction(u,c),this._addInactiveAction(u,o,i),u}existingAction(e,t){const n=t||this._root,r=n.uuid,i=typeof e=="string"?Xp.findByName(n,e):e,s=i?i.uuid:e,o=this._actionsByClip[s];return o!==void 0&&o.actionByRoot[r]||null}stopAllAction(){const e=this._actions,t=this._nActiveActions;for(let n=t-1;n>=0;--n)e[n].stop();return this}update(e){e*=this.timeScale;const t=this._actions,n=this._nActiveActions,r=this.time+=e,i=Math.sign(e),s=this._accuIndex^=1;for(let c=0;c!==n;++c)t[c]._update(r,e,i,s);const o=this._bindings,l=this._nActiveBindings;for(let c=0;c!==l;++c)o[c].apply(s);return this}setTime(e){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,n=e.uuid,r=this._actionsByClip,i=r[n];if(i!==void 0){const s=i.knownActions;for(let o=0,l=s.length;o!==l;++o){const c=s[o];this._deactivateAction(c);const u=c._cacheIndex,f=t[t.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,f._cacheIndex=u,t[u]=f,t.pop(),this._removeInactiveBindingsForAction(c)}delete r[n]}}uncacheRoot(e){const t=e.uuid,n=this._actionsByClip;for(const s in n){const o=n[s].actionByRoot,l=o[t];l!==void 0&&(this._deactivateAction(l),this._removeInactiveAction(l))}const r=this._bindingsByRootAndName,i=r[t];if(i!==void 0)for(const s in i){const o=i[s];o.restoreOriginalState(),this._removeInactiveBinding(o)}}uncacheAction(e,t){const n=this.existingAction(e,t);n!==null&&(this._deactivateAction(n),this._removeInactiveAction(n))}}nC.prototype._controlInterpolantsResultBuffer=new Float32Array(1);class iC extends bo{constructor(e,t,n=1){super(e,t),this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}iC.prototype.isInstancedInterleavedBuffer=!0;class zg{constructor(e,t,n=0,r=1/0){this.ray=new Ei(e,t),this.near=n,this.far=r,this.camera=null,this.layers=new ah,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}intersectObject(e,t=!1,n=[]){return Lf(e,this,n,t),n.sort(Jp),n}intersectObjects(e,t=!1,n=[]){for(let r=0,i=e.length;r<i;r++)Lf(e[r],this,n,t);return n.sort(Jp),n}}function Jp(a,e){return a.distance-e.distance}function Lf(a,e,t,n){if(a.layers.test(e.layers)&&a.raycast(e,t),n===!0){const r=a.children;for(let i=0,s=r.length;i<s;i++)Lf(r[i],e,t,!0)}}class aC extends lt{constructor(e){super(),this.material=e,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}}aC.prototype.isImmediateRenderObject=!0;const Qn=new b,Ml=new Ce,Pu=new Ce;class sC extends Gr{constructor(e){const t=Vg(e),n=new at,r=[],i=[],s=new ze(0,0,1),o=new ze(0,1,0);for(let c=0;c<t.length;c++){const u=t[c];u.parent&&u.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),i.push(s.r,s.g,s.b),i.push(o.r,o.g,o.b))}n.setAttribute("position",new wt(r,3)),n.setAttribute("color",new wt(i,3));const l=new Qi({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0});super(n,l),this.type="SkeletonHelper",this.isSkeletonHelper=!0,this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){const t=this.bones,n=this.geometry,r=n.getAttribute("position");Pu.copy(this.root.matrixWorld).invert();for(let i=0,s=0;i<t.length;i++){const o=t[i];o.parent&&o.parent.isBone&&(Ml.multiplyMatrices(Pu,o.matrixWorld),Qn.setFromMatrixPosition(Ml),r.setXYZ(s,Qn.x,Qn.y,Qn.z),Ml.multiplyMatrices(Pu,o.parent.matrixWorld),Qn.setFromMatrixPosition(Ml),r.setXYZ(s+1,Qn.x,Qn.y,Qn.z),s+=2)}n.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}}function Vg(a){const e=[];a&&a.isBone&&e.push(a);for(let t=0;t<a.children.length;t++)e.push.apply(e,Vg(a.children[t]));return e}class oC extends Gr{constructor(e=10,t=10,n=4473924,r=8947848){n=new ze(n),r=new ze(r);const i=t/2,s=e/t,o=e/2,l=[],c=[];for(let h=0,d=0,p=-o;h<=t;h++,p+=s){l.push(-o,0,p,o,0,p),l.push(p,0,-o,p,0,o);const v=h===i?n:r;v.toArray(c,d),d+=3,v.toArray(c,d),d+=3,v.toArray(c,d),d+=3,v.toArray(c,d),d+=3}const u=new at;u.setAttribute("position",new wt(l,3)),u.setAttribute("color",new wt(c,3));const f=new Qi({vertexColors:!0,toneMapped:!1});super(u,f),this.type="GridHelper"}}class lC extends Gr{constructor(e=1){const t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],n=[1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],r=new at;r.setAttribute("position",new wt(t,3)),r.setAttribute("color",new wt(n,3));const i=new Qi({vertexColors:!0,toneMapped:!1});super(r,i),this.type="AxesHelper"}setColors(e,t,n){const r=new ze,i=this.geometry.attributes.color.array;return r.set(e),r.toArray(i,0),r.toArray(i,3),r.set(t),r.toArray(i,6),r.toArray(i,9),r.set(n),r.toArray(i,12),r.toArray(i,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}const cC=new Float32Array(1);new Int32Array(cC.buffer);Yr.create=function(a,e){return console.log("THREE.Curve.create() has been deprecated"),a.prototype=Object.create(Yr.prototype),a.prototype.constructor=a,a.prototype.getPoint=e,a};Rf.prototype.fromPoints=function(a){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(a)};oC.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")};sC.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")};Ai.prototype.extractUrlBase=function(a){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),zE.extractUrlBase(a)};Ai.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}};Vt.prototype.center=function(a){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(a)};Vt.prototype.empty=function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()};Vt.prototype.isIntersectionBox=function(a){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(a)};Vt.prototype.isIntersectionSphere=function(a){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(a)};Vt.prototype.size=function(a){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(a)};Lr.prototype.empty=function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()};Ac.prototype.setFromMatrix=function(a){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(a)};zt.prototype.flattenToArrayOffset=function(a,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(a,e)};zt.prototype.multiplyVector3=function(a){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),a.applyMatrix3(this)};zt.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")};zt.prototype.applyToBufferAttribute=function(a){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),a.applyMatrix3(this)};zt.prototype.applyToVector3Array=function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")};zt.prototype.getInverse=function(a){return console.warn("THREE.Matrix3: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(a).invert()};Ce.prototype.extractPosition=function(a){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(a)};Ce.prototype.flattenToArrayOffset=function(a,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(a,e)};Ce.prototype.getPosition=function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),new b().setFromMatrixColumn(this,3)};Ce.prototype.setRotationFromQuaternion=function(a){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(a)};Ce.prototype.multiplyToArray=function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")};Ce.prototype.multiplyVector3=function(a){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)};Ce.prototype.multiplyVector4=function(a){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)};Ce.prototype.multiplyVector3Array=function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")};Ce.prototype.rotateAxis=function(a){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),a.transformDirection(this)};Ce.prototype.crossVector=function(a){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)};Ce.prototype.translate=function(){console.error("THREE.Matrix4: .translate() has been removed.")};Ce.prototype.rotateX=function(){console.error("THREE.Matrix4: .rotateX() has been removed.")};Ce.prototype.rotateY=function(){console.error("THREE.Matrix4: .rotateY() has been removed.")};Ce.prototype.rotateZ=function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")};Ce.prototype.rotateByAxis=function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")};Ce.prototype.applyToBufferAttribute=function(a){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)};Ce.prototype.applyToVector3Array=function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")};Ce.prototype.makeFrustum=function(a,e,t,n,r,i){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(a,e,n,t,r,i)};Ce.prototype.getInverse=function(a){return console.warn("THREE.Matrix4: .getInverse() has been removed. Use matrixInv.copy( matrix ).invert(); instead."),this.copy(a).invert()};an.prototype.isIntersectionLine=function(a){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(a)};Xt.prototype.multiplyVector3=function(a){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),a.applyQuaternion(this)};Xt.prototype.inverse=function(){return console.warn("THREE.Quaternion: .inverse() has been renamed to invert()."),this.invert()};Ei.prototype.isIntersectionBox=function(a){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(a)};Ei.prototype.isIntersectionPlane=function(a){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(a)};Ei.prototype.isIntersectionSphere=function(a){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(a)};Br.prototype.area=function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()};Br.prototype.barycoordFromPoint=function(a,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(a,e)};Br.prototype.midpoint=function(a){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(a)};Br.prototypenormal=function(a){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(a)};Br.prototype.plane=function(a){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(a)};Br.barycoordFromPoint=function(a,e,t,n,r){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Br.getBarycoord(a,e,t,n,r)};Br.normal=function(a,e,t,n){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Br.getNormal(a,e,t,n)};gh.prototype.extractAllPoints=function(a){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(a)};gh.prototype.extrude=function(a){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new us(this,a)};gh.prototype.makeGeometry=function(a){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new vh(this,a)};ve.prototype.fromAttribute=function(a,e,t){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(a,e,t)};ve.prototype.distanceToManhattan=function(a){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(a)};ve.prototype.lengthManhattan=function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};b.prototype.setEulerFromRotationMatrix=function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")};b.prototype.setEulerFromQuaternion=function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")};b.prototype.getPositionFromMatrix=function(a){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(a)};b.prototype.getScaleFromMatrix=function(a){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(a)};b.prototype.getColumnFromMatrix=function(a,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,a)};b.prototype.applyProjection=function(a){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(a)};b.prototype.fromAttribute=function(a,e,t){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(a,e,t)};b.prototype.distanceToManhattan=function(a){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(a)};b.prototype.lengthManhattan=function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};ht.prototype.fromAttribute=function(a,e,t){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(a,e,t)};ht.prototype.lengthManhattan=function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()};lt.prototype.getChildByName=function(a){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(a)};lt.prototype.renderDepth=function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")};lt.prototype.translate=function(a,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,a)};lt.prototype.getWorldRotation=function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")};lt.prototype.applyMatrix=function(a){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(a)};Object.defineProperties(lt.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(a){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=a}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}});ft.prototype.setDrawMode=function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")};Object.defineProperties(ft.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),B1},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}});gg.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")};Bt.prototype.setLens=function(a,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),e!==void 0&&(this.filmGauge=e),this.setFocalLength(a)};Object.defineProperties(bn.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(a){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=a}},shadowCameraLeft:{set:function(a){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=a}},shadowCameraRight:{set:function(a){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=a}},shadowCameraTop:{set:function(a){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=a}},shadowCameraBottom:{set:function(a){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=a}},shadowCameraNear:{set:function(a){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=a}},shadowCameraFar:{set:function(a){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=a}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(a){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=a}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(a){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=a}},shadowMapHeight:{set:function(a){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=a}}});Object.defineProperties(Ze.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===oc},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(oc)}}});Ze.prototype.setDynamic=function(a){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(a===!0?oc:so),this};Ze.prototype.copyIndicesArray=function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},Ze.prototype.setArray=function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")};at.prototype.addIndex=function(a){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(a)};at.prototype.addAttribute=function(a,e){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),!(e&&e.isBufferAttribute)&&!(e&&e.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(a,new Ze(arguments[1],arguments[2]))):a==="index"?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):this.setAttribute(a,e)};at.prototype.addDrawCall=function(a,e,t){t!==void 0&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(a,e)};at.prototype.clearDrawCalls=function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()};at.prototype.computeOffsets=function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")};at.prototype.removeAttribute=function(a){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(a)};at.prototype.applyMatrix=function(a){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(a)};Object.defineProperties(at.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}});bo.prototype.setDynamic=function(a){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(a===!0?oc:so),this};bo.prototype.setArray=function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")};us.prototype.getArrays=function(){console.error("THREE.ExtrudeGeometry: .getArrays() has been removed.")};us.prototype.addShapeList=function(){console.error("THREE.ExtrudeGeometry: .addShapeList() has been removed.")};us.prototype.addShape=function(){console.error("THREE.ExtrudeGeometry: .addShape() has been removed.")};pi.prototype.dispose=function(){console.error("THREE.Scene: .dispose() has been removed.")};Object.defineProperties(er.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new ze}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(a){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=a===Bv}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(a){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=a}},vertexTangents:{get:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")},set:function(){console.warn("THREE."+this.type+": .vertexTangents has been removed.")}}});Object.defineProperties(cn.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(a){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=a}}});mt.prototype.clearTarget=function(a,e,t,n){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(a),this.clear(e,t,n)};mt.prototype.animate=function(a){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(a)};mt.prototype.getCurrentRenderTarget=function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()};mt.prototype.getMaxAnisotropy=function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()};mt.prototype.getPrecision=function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision};mt.prototype.resetGLState=function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()};mt.prototype.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")};mt.prototype.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")};mt.prototype.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")};mt.prototype.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")};mt.prototype.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")};mt.prototype.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")};mt.prototype.supportsVertexTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures};mt.prototype.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")};mt.prototype.enableScissorTest=function(a){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(a)};mt.prototype.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")};mt.prototype.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")};mt.prototype.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")};mt.prototype.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")};mt.prototype.setFaceCulling=function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")};mt.prototype.allocTextureUnit=function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")};mt.prototype.setTexture=function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")};mt.prototype.setTexture2D=function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")};mt.prototype.setTextureCube=function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")};mt.prototype.getActiveMipMapLevel=function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()};Object.defineProperties(mt.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(a){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=a}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(a){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=a}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(a){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=a===!0?Mc:Cr}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}});Object.defineProperties(hg.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}});Object.defineProperties(Gt.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(a){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=a}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(a){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=a}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(a){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=a}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(a){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=a}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(a){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=a}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(a){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=a}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(a){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=a}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(a){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=a}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(a){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=a}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(a){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=a}}});XE.prototype.load=function(a){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const e=this;return new GE().load(a,function(n){e.setBuffer(n)}),this};lh.prototype.updateCubeMap=function(a,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(a,e)};lh.prototype.clear=function(a,e,t,n){return console.warn("THREE.CubeCamera: .clear() is now .renderTarget.clear()."),this.renderTarget.clear(a,e,t,n)};os.crossOrigin=void 0;os.loadTexture=function(a,e,t,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const r=new IE;r.setCrossOrigin(this.crossOrigin);const i=r.load(a,t,void 0,n);return e&&(i.mapping=e),i};os.loadTextureCube=function(a,e,t,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const r=new NE;r.setCrossOrigin(this.crossOrigin);const i=r.load(a,t,void 0,n);return e&&(i.mapping=e),i};os.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")};os.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Fv}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=Fv);function wn(a){"@babel/helpers - typeof";return wn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},wn(a)}function G(a,e){if(!(a instanceof e))throw new TypeError("Cannot call a class as a function")}function Qp(a,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(a,n.key,n)}}function H(a,e,t){return e&&Qp(a.prototype,e),t&&Qp(a,t),Object.defineProperty(a,"prototype",{writable:!1}),a}function qr(a){if(a===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function po(a,e){return po=Object.setPrototypeOf||function(n,r){return n.__proto__=r,n},po(a,e)}function re(a,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");Object.defineProperty(a,"prototype",{value:Object.create(e&&e.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),writable:!1}),e&&po(a,e)}function ue(a,e){if(e&&(wn(e)==="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return qr(a)}function D(a){return D=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},D(a)}function uC(a){if(Array.isArray(a))return a}function fC(a,e){var t=a==null?null:typeof Symbol<"u"&&a[Symbol.iterator]||a["@@iterator"];if(t!=null){var n=[],r=!0,i=!1,s,o;try{for(t=t.call(a);!(r=(s=t.next()).done)&&(n.push(s.value),!(e&&n.length===e));r=!0);}catch(l){i=!0,o=l}finally{try{!r&&t.return!=null&&t.return()}finally{if(i)throw o}}return n}}function Pf(a,e){(e==null||e>a.length)&&(e=a.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=a[t];return n}function Ug(a,e){if(a){if(typeof a=="string")return Pf(a,e);var t=Object.prototype.toString.call(a).slice(8,-1);if(t==="Object"&&a.constructor&&(t=a.constructor.name),t==="Map"||t==="Set")return Array.from(a);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Pf(a,e)}}function hC(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Lt(a,e){return uC(a)||fC(a,e)||Ug(a,e)||hC()}var uc=function(){return uc=Object.assign||function(a){for(var e,t=1,n=arguments.length;t<n;t++){e=arguments[t];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(a[r]=e[r])}return a},uc.apply(this,arguments)},dC={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",fadeColor:"transparent",animation:"spinner-line-fade-default",rotate:0,direction:1,speed:1,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:"0 0 1px transparent",position:"absolute"},pC=function(){function a(e){e===void 0&&(e={}),this.opts=uc(uc({},dC),e)}return a.prototype.spin=function(e){return this.stop(),this.el=document.createElement("div"),this.el.className=this.opts.className,this.el.setAttribute("role","progressbar"),Nf(this.el,{position:this.opts.position,width:0,zIndex:this.opts.zIndex,left:this.opts.left,top:this.opts.top,transform:"scale("+this.opts.scale+")"}),e&&e.insertBefore(this.el,e.firstChild||null),mC(this.el,this.opts),this},a.prototype.stop=function(){return this.el&&(typeof requestAnimationFrame<"u"?cancelAnimationFrame(this.animateId):clearTimeout(this.animateId),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.el=void 0),this},a}();function Nf(a,e){for(var t in e)a.style[t]=e[t];return a}function em(a,e){return typeof a=="string"?a:a[e%a.length]}function mC(a,e){var t=Math.round(e.corners*e.width*500)/1e3+"px",n="none";e.shadow===!0?n="0 2px 4px #000":typeof e.shadow=="string"&&(n=e.shadow);for(var r=vC(n),i=0;i<e.lines;i++){var s=~~(360/e.lines*i+e.rotate),o=Nf(document.createElement("div"),{position:"absolute",top:-e.width/2+"px",width:e.length+e.width+"px",height:e.width+"px",background:em(e.fadeColor,i),borderRadius:t,transformOrigin:"left",transform:"rotate("+s+"deg) translateX("+e.radius+"px)"}),l=i*e.direction/e.lines/e.speed;l-=1/e.speed;var c=Nf(document.createElement("div"),{width:"100%",height:"100%",background:em(e.color,i),borderRadius:t,boxShadow:gC(r,s),animation:1/e.speed+"s linear "+l+"s infinite "+e.animation});o.appendChild(c),a.appendChild(o)}}function vC(a){for(var e=/^\s*([a-zA-Z]+\s+)?(-?\d+(\.\d+)?)([a-zA-Z]*)\s+(-?\d+(\.\d+)?)([a-zA-Z]*)(.*)$/,t=[],n=0,r=a.split(",");n<r.length;n++){var i=r[n],s=i.match(e);if(s!==null){var o=+s[2],l=+s[5],c=s[4],u=s[7];o===0&&!c&&(c=u),l===0&&!u&&(u=c),c===u&&t.push({prefix:s[1]||"",x:o,y:l,xUnits:c,yUnits:u,end:s[8]})}}return t}function gC(a,e){for(var t=[],n=0,r=a;n<r.length;n++){var i=r[n],s=_C(i.x,i.y,e);t.push(i.prefix+s[0]+i.xUnits+" "+s[1]+i.yUnits+i.end)}return t.join(", ")}function _C(a,e,t){var n=t*Math.PI/180,r=Math.sin(n),i=Math.cos(n);return[Math.round((a*i+e*r)*1e3)/1e3,Math.round((-a*r+e*i)*1e3)/1e3]}var Nc=function(){function a(){G(this,a),this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}return H(a,[{key:"start",value:function(){this.startTime=a.now(),this.oldTime=this.startTime,this.running=!0}},{key:"stop",value:function(){this.getElapsedTime(),this.running=!1}},{key:"getElapsedTime",value:function(){return this.update(),this.elapsedTime}},{key:"update",value:function(){var t=0;if(this.running){var n=a.now();t=.001*(n-this.oldTime),this.oldTime=n,this.elapsedTime+=t}return t}}]),a}();Nc.now=function(){var a=typeof window<"u"&&window.performance;return a&&a.now?a.now.bind(a):Date.now}();var tm=Nc.now;function rm(a,e,t){var n=document.createElement(a);return n.id=e,n.style.cssText=t,n}var yC=function(){function a(){G(this,a),this.domElement=rm("div","stats","padding:8px"),this._text=rm("p","fps","margin:0;color:silver;font-size:large"),this.domElement.appendChild(this._text),this._startTime=tm(),this._prevTime=this._startTime,this._deltas=new Array(20),this._index=0,this._total=0,this._count=0}return H(a,[{key:"end",value:function(){var t=tm(),n=t-this._startTime;return this._count<this._deltas.length?this._count++:this._total-=this._deltas[this._index],this._total+=n,this._deltas[this._index]=n,this._index=(this._index+1)%this._deltas.length,this.ms=this._total/this._count,this.fps=1e3/this.ms,t>this._prevTime+1e3&&(this._text.textContent=this.fps.toPrecision(2),this._prevTime=t),t}},{key:"update",value:function(){this._startTime=this.end()}},{key:"show",value:function(t){t===void 0&&(t=!0),this.domElement.style.display=t?"block":"none"}}]),a}();function xC(a){return Function.toString.call(a).indexOf("[native code]")!==-1}function SC(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function eo(a,e,t){return SC()?eo=Reflect.construct:eo=function(r,i,s){var o=[null];o.push.apply(o,i);var l=Function.bind.apply(r,o),c=new l;return s&&po(c,s.prototype),c},eo.apply(null,arguments)}function mo(a){var e=typeof Map=="function"?new Map:void 0;return mo=function(n){if(n===null||!xC(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,r)}function r(){return eo(n,arguments,D(this).constructor)}return r.prototype=Object.create(n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),po(r,n)},mo(a)}function Nu(a,e){return!a||a===e}function gr(){this._handlers={}}gr.prototype.addEventListener=function(a,e,t){var n=this._handlers[a];n||(this._handlers[a]=[],n=this._handlers[a]);var r=[e,t];function i(s){return s[0]===r[0]&&s[1]===r[1]}le.find(n,i)===void 0&&n.push(r)};gr.prototype.removeEventListener=function(a,e,t){var n=this;le.forEach(n._handlers,function(r,i){le.remove(r,function(s){return Nu(a,i)&&Nu(e,s[0])&&Nu(t,s[1]||n)})}),this._handlers=le.omitBy(n._handlers,function(r){return r.length===0})};gr.prototype.dispatchEvent=function(a){var e=this;le.forEach(this._handlers[a.type],function(t){var n=t[1]||e;t[0].apply(n,[a])})};var un={debug:0,info:1,report:2,warn:3,error:4};function mr(){gr.call(this),this.console=!1,this._priority=un.warn}mr.prototype=Object.create(gr.prototype);mr.prototype.constructor=mr;mr.prototype.instantiate=function(){return new mr};function Gg(a){if(!le.isNumber(a))throw new Error("Wrong log level specified!");return a}Object.defineProperty(mr.prototype,"level",{get:function(){var e=this;return le.findKey(un,function(t){return t===e._priority})},set:function(e){this._priority=Gg(un[e])}});mr.prototype.levels=function(){return Object.keys(un)};mr.prototype.message=function(a,e){var t=Gg(un[a]);this._message(t,e)};mr.prototype.debug=function(a){this._message(un.debug,a)};mr.prototype.info=function(a){this._message(un.info,a)};mr.prototype.report=function(a){this._message(un.report,a)};mr.prototype.warn=function(a){this._message(un.warn,a)};mr.prototype.error=function(a){this._message(un.error,a)};mr.prototype._message=function(a,e){if(!(a<this._priority)){var t=le.findKey(un,function(r){return r===a});if(e=String(e),this.console){var n="miew:".concat(t,": ").concat(e);t==="error"?console.error(n):t==="warn"?console.warn(n):console.log(n)}this.dispatchEvent({type:"message",level:t,message:e})}};var Wt=new mr;function bC(a){var e=wC();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function wC(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var If={DEFAULT:0,SAFARI:1};function MC(a,e){var t=function(r){return String.fromCharCode(parseInt(r.substr(1),16))};return encodeURIComponent(a).replace(e,t).replace(/%20/g,"+")}function kf(a){return decodeURIComponent(a.replace(/\+/g," "))}function Hg(a){a=a||window.location.search;for(var e=a.substring(a.indexOf("?")+1),t=/([^&=]+)=?([^&]*)/g,n=[],r;(r=t.exec(e))!==null;)n.push([kf(r[1]),kf(r[2])]);return n}function EC(a){for(var e={},t=Hg(a),n=0;n<t.length;++n){var r=Lt(t[n],2),i=r[0],s=r[1];e[i]=s}return e}function CC(a){if(typeof URL<"u")try{return typeof window<"u"?new URL(a,window.location).href:new URL(a).href}catch{}if(typeof document<"u"){var e=document.createElement("a");return e.href=a,e.href}return a}function AC(a){for(var e=[],t=0,n=a.length;t<n;++t)e[e.length]=a[t].charCodeAt(0).toString(16);var r=e.join("|");return new RegExp("%(?:".concat(r,")"),"gi")}function TC(a,e,t){var n=document.createElement(a),r,i;if(e){var s=Object.keys(e);for(r=0,i=s.length;r<i;++r){var o=s[r];n.setAttribute(o,e[o])}}if(t)for(t instanceof Array||(t=[t]),r=0,i=t.length;r<i;++r){var l=t[r];typeof l=="string"?n.appendChild(document.createTextNode(l)):l instanceof HTMLElement&&n.appendChild(l)}return n}function RC(a,e,t,n){return a.prototype=le.assign(Object.create(e.prototype),{constructor:a},t),n&&le.assign(a,n),a}function Of(a,e){var t=a,n,r;if(a instanceof Array)for(t=new Array(a.length),n=0,r=a.length;n<r;++n)t[n]=Of(a[n]);else if(a instanceof Object){t=Object.create(a);var i=Object.keys(a);for(n=0,r=i.length;n<r;++n){var s=i[n],o=a[s],l=Of(o);l!==o&&(t[s]=l)}e&&Object.keys(t).length>0&&(t=Object.create(t))}return t}function LC(a){var e="0000000".concat(a.toString(16)).substr(-6);return"#".concat(e)}function bh(a){var e=!1;this.enable=function(c){e=c};var t=0,n=Object.keys(a);function r(c,u){return function(){var f=bh.spaces.substr(0,t*2);e&&Wt.debug("".concat(f+u," {")),t++;for(var h=arguments.length,d=new Array(h),p=0;p<h;p++)d[p]=arguments[p];var v=c.apply(this,d);return t--,e&&Wt.debug("".concat(f,"} // ").concat(u)),v}}for(var i=0,s=n.length;i<s;++i){var o=n[i],l=a[o];l instanceof Function&&o!=="constructor"&&(a[o]=r(l,o))}}bh.spaces="                                                                                          ";var Wg=function(a){re(t,a);var e=bC(t);function t(n){var r;return G(this,t),r=e.call(this),r.name="OutOfMemoryError",r.message=n,r}return H(t)}(mo(Error));function PC(a,e){var t=null;try{t=new a(e)}catch(n){throw n instanceof RangeError?new Wg(n.message):n}return t}function Xg(a){for(var e=new Uint8Array(a),t="",n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return window.btoa(t)}function wh(a){for(var e=window.atob(a),t=new Uint8Array(e.length),n=0;n<t.length;++n)t[n]=e[n].charCodeAt(0);return t.buffer}function NC(a,e){return Xg(new e(a).buffer)}function IC(a,e){return Array.prototype.slice.call(new e(wh(a)))}function kC(a,e){var t=[];if(e&&a){for(var n=Object.keys(a),r=0;r<n.length;++r){var i=n[r],s=a[i];!(s instanceof Object)&&typeof e[i]<"u"&&e[i]!==s&&t.push("".concat(i,":").concat(s))}if(t.length>0)return"!".concat(t.join())}return""}function Df(a){if(le.isPlainObject(a))return!0;var e=a&&Object.getPrototypeOf(a);return!!e&&!e.hasOwnProperty("constructor")&&Df(e)}function jg(a,e){var t={};return le.forIn(a,function(n,r){var i=e[r];if(Df(n)&&Df(i)){var s=jg(n,i);le.isEmpty(s)||(t[r]=s)}else le.isEqual(n,i)||(t[r]=n)}),t}function OC(a,e){function t(n,r){le.forIn(n,function(i,s){var o=r+(r.length>0?".":"");i instanceof Object?t(i,o+s):i!==void 0&&e(i,o+s)})}t(a,"")}function DC(a){return le.isString(a)?'"'.concat(a.replace(/"/g,'\\"'),'"'):a}function FC(a){if(!le.isString(a))return a;if(a[0]==='"'&&a[a.length-1]==='"')return a=a.slice(1,a.length-1),a.replace(/\\"/g,'"');if(a[0]==="'"&&a[a.length-1]==="'")return a=a.slice(1,a.length-1),a.replace(/\\'/g,"'");throw new SyntaxError("Incorrect string format, can't unqute it")}function Yg(a){return a.slice(Math.max(0,a.lastIndexOf("."))||1/0)}function BC(a){var e=Yg(a),t=a.slice(0,a.length-e.length);return[t,e]}function nm(a){var e=a.split(/[:;,]/),t=e.length;return t>=3&&e[t-2]==="base64"?new Blob([wh(e[t-1])]):null}function zC(){return navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&navigator.userAgent.indexOf("CriOS")===-1&&navigator.userAgent.indexOf("FxiOS")===-1?If.SAFARI:If.DEFAULT}function VC(a){typeof window<"u"&&window.open().document.write('<body style="margin:0"><img src="'.concat(a,'" /></body>'))}function UC(a,e){if(!(!a||a.substr(0,5)!=="data:")){if(e||(e=["screenshot-",+new Date,".png"].join("")),typeof window<"u"&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(nm(a),e);else if(typeof document<"u"){var t=document.createElement("a");t.download=e,t.innerHTML="download",t.href=window.URL.createObjectURL(nm(a)),document.body.appendChild(t),t.click(),document.body.removeChild(t)}}}function GC(a,e,t){var n=new Blob([a]);if(e||(e=["data",+new Date].join("")),t?e+=".".concat(t):e+=n.type||".bin",typeof window<"u"&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(n,e);else if(typeof document<"u"){var r=document.createElement("a");r.download=e,r.innerHTML="download",r.href=window.URL.createObjectURL(n),document.body.appendChild(r),r.click(),document.body.removeChild(r)}}function HC(a,e,t,n){for(var r=0,i=t.length;r<i;++r)for(var s=0;s<n;++s)e[r*n+s]=a[t[r]*n+s]}function WC(a){var e=a.cloneNode(!0);return e.worldPos=a.worldPos,e}var XC=/^[a-zA-Z0-9_]*$/,im=['"',"",'"'];function jC(a){return XC.test(a)?a:(im[1]=a,im.join(""))}function YC(a,e){var t=new a.constructor(a.length+e.length);return t.set(a),t.set(e,a.length),t}function qC(a){if(a.length<=0)return null;for(var e=a.reduce(function(s,o){return s+o.length},0),t=new a[0].constructor(e),n=0,r=0;n<a.length;n++){var i=a[n].length;t.set(a[n],r),r+=i}return t}var Se={browserType:If,encodeQueryComponent:MC,decodeQueryComponent:kf,getUrlParameters:Hg,getUrlParametersAsDict:EC,resolveURL:CC,generateRegExp:AC,createElement:TC,deriveClass:RC,deriveDeep:Of,hexColor:LC,DebugTracer:bh,OutOfMemoryError:Wg,allocateTyped:PC,bytesFromBase64:wh,bytesToBase64:Xg,arrayFromBase64:IC,arrayToBase64:NC,compareOptionsWithDefaults:kC,objectsDiff:jg,forInRecursive:OC,enquoteString:DC,unquoteString:FC,getBrowser:zC,shotOpen:VC,shotDownload:UC,copySubArrays:HC,shallowCloneNode:WC,correctSelectorIdentifier:jC,getFileExtension:Yg,splitFileName:BC,download:GC,concatTypedArraysUnsafe:YC,mergeTypedArraysUnsafe:qC};function $C(a){var e=ZC();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function ZC(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var KC=function(a){re(t,a);var e=$C(t);function t(){var n;return G(this,t),n=e.call(this),n._shouldCancel=!1,n}return H(t,[{key:"cancel",value:function(){this._shouldCancel=!0,this.dispatchEvent({type:"cancel"})}},{key:"shouldCancel",value:function(){return this._shouldCancel}},{key:"notify",value:function(r){this.dispatchEvent({type:"notification",slaveEvent:r})}}]),t}(gr),am=0,ks={modes:{BS:{atom:.23,bond:.15,space:.5,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},VW:{polyComplexity:{poor:4,low:6,medium:8,high:16,ultra:32}},LN:{multibond:!0,showarom:!0,offsarom:.2,chunkarom:10,atom:.23,lineWidth:2},LC:{bond:.2,space:0,multibond:!0,aromrad:.1,showarom:!0,polyComplexity:{poor:3,low:4,medium:6,high:12,ultra:32}},SA:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},SE:{zClip:!1,probeRadius:1.5,subset:"",wireframe:!1,polyComplexity:{poor:6,low:8,medium:16,high:30,ultra:60}},QS:{isoValue:.5,gaussLim:{poor:1.5,low:2,medium:2.5,high:3,ultra:4},scale:1,wireframe:!1,gridSpacing:{poor:2,low:1.5,medium:1,high:.5,ultra:.25},subset:"",zClip:!1},CS:{probeRadius:1.4,isoValue:1.5,wireframe:!1,probePositions:30,polyComplexity:{poor:.5,low:1,medium:1.5,high:1.75,ultra:2},subset:"",zClip:!1},TR:{radius:.3,polyComplexity:{poor:12,low:16,medium:32,high:64,ultra:64}},TU:{radius:.3,heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},CA:{radius:.3,depth:.25,ss:{helix:{width:1,arrow:2},strand:{width:1,arrow:2}},heightSegmentsRatio:1.5,tension:-.7,polyComplexity:{poor:4,low:6,medium:10,high:18,ultra:34}},TX:{template:"{{Chain}}.{{Residue}}{{Sequence}}.{{Name}}",horizontalAlign:"center",verticalAlign:"middle",dx:0,dy:0,dz:1,fg:"none",bg:"0x202020",showBg:!0},VD:{kSigma:1,kSigmaMed:2,kSigmaMax:4,frame:!0,isoMode:!1,polyComplexity:{poor:2,low:3,medium:4,high:8,ultra:10}}},colorers:{EL:{carbon:-1},UN:{color:16777215},CO:{subset:"charged",color:16711680,baseColor:16777215},CB:{color:9474192,factor:.6},SQ:{gradient:"rainbow"},TM:{gradient:"temp",min:5,max:40},OC:{gradient:"reds"},HY:{gradient:"blue-red"},MO:{gradient:"rainbow"}},antialias:!0,camFov:45,camNear:.5,camFar:100,camDistance:2.5,radiusToFit:1,fogNearFactor:.5,fogFarFactor:1,fogAlpha:1,fogColor:0,fogColorEnable:!1,palette:"JM",resolution:"medium",autoResolution:!1,autoPreset:!0,preset:"default",presets:{default:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],empty:[],wire:[{mode:"LN",colorer:"EL",selector:"all",material:"SF"}],small:[{mode:"BS",colorer:"EL",selector:"all",material:"SF"}],macro:[{mode:"CA",colorer:"SS",selector:"not hetatm",material:"SF"},{mode:"BS",colorer:"EL",selector:"hetatm and not water",material:"SF"}]},objects:{line:{color:4294967295,dashSize:.3,gapSize:.05}},bg:{color:2105376,transparent:!1},draft:{clipPlane:!1,clipPlaneFactor:.5,clipPlaneSpeed:3e-5},plugins:{},axes:!0,fog:!0,fps:!0,zSprites:!0,isoSurfaceFakeOpacity:!0,suspendRender:!0,nowater:!1,autobuild:!0,fxaa:!0,outline:{on:!1,color:0,threshold:.1,thickness:1},ao:!1,shadow:{on:!1,type:"random",radius:1},autoRotation:0,maxfps:30,fbxprec:4,autoRotationAxisFixed:!0,zooming:!0,picking:!0,pick:"atom",editing:!1,aromatic:!1,singleUnit:!0,stereo:"NONE",interpolateViews:!0,transparency:"prepass",translationSpeed:2,debug:{example:3.5,text:"hello!",good:!0,ssaoKernelRadius:.7,ssaoFactor:.7,stereoBarrel:.25},use:{multiFile:!1}};function qg(){gr.call(this),this.old=null,this.now={},this._changed={},this.reset()}Se.deriveClass(qg,gr,{defaults:ks,set:function(e,t){if(le.isString(e)){var n=le.get(this.now,e);n!==t&&(le.set(this.now,e,t),this._notifyChange(e,t))}else{var r=Se.objectsDiff(e,this.now);le.isEmpty(r)||(le.merge(this.now,r),this._notifyChanges(r))}},get:function(e,t){return le.get(this.now,e,t)},reset:function(){var e=Se.objectsDiff(ks,this.now);this.now=le.cloneDeep(ks),this.old=null,this._notifyChanges(e),this._changed={}},checkpoint:function(){this.old=le.cloneDeep(this.now),this._changed={}},_notifyChange:function(e,t){this._changed[e]=!0,this.dispatchEvent({type:"change:".concat(e),value:t})},_notifyChanges:function(e){var t=this;Se.forInRecursive(e,function(n,r){t._notifyChange(r,n)})},changed:function(){if(!this.old)return[];var e=this.old,t=this.now,n=le.filter(Object.keys(this._changed),function(r){return le.get(e,r)!==le.get(t,r)});return n},applyDiffs:function(e){if(e.hasOwnProperty("VERSION")&&e.VERSION!==am)throw new Error("Settings version does not match!");delete e.VERSION,this.reset(),this.set(e)},getDiffs:function(e){var t=Se.objectsDiff(this.now,ks);return e&&(t.VERSION=am),t},setPluginOpts:function(e,t){ks.plugins[e]=le.cloneDeep(t),this.now.plugins[e]=le.cloneDeep(t)}});var Q=new qg,Jt=0;function $g(a){return!(!a||a==="0"||le.isString(a)&&a.toLowerCase()==="false")}var Mh={string:String,number:Number,boolean:$g},JC="=",Eh="!",Zg=":",Kg=",",Jg="$;@/?";function QC(){var a=":,";return Se.generateRegExp(Jg+a)}function eA(){var a=" ";return Se.generateRegExp(Jg+a)}var tA=QC();function sm(a){return Se.encodeQueryComponent(a,tA)}var rA=eA();function om(a){return Se.encodeQueryComponent(a,rA)}function $l(a){var e=a.reps;if(!e){var t=Q.now.presets,n=a.preset||Q.now.preset;if(e=t[n],!e){Wt.warn('Unknown preset "'.concat(n,'"'));var r=Object.keys(t),i=Lt(r,1);n=i[0],e=t[n]}a.preset=n,a.reps=Se.deriveDeep(e,!0)}}function El(a,e,t){$l(a);var n=a.reps[Jt];n.hasOwnProperty(e)&&(Jt=a.reps.length,a.reps[Jt]=Se.deriveDeep(n,!0)),t!==void 0&&(a.reps[Jt][e]=t)}function nA(a,e,t){a._objects===void 0&&(a._objects=[]);var n=Lt(t,2),r=n[0],i=n[1],s={type:r,params:e};i!==void 0&&(s.opts=i),a._objects[a._objects.length]=s}function iA(a,e){var t=a.indexOf(",");return t>=0?(e.push(a.substr(t+1).split(",")),a.substr(0,t)):a}function Cl(a,e,t){if(a){var n=a.indexOf(Eh),r=iA(a.substr(0,n>=0?n:void 0),t);if(n>=0){var i=a.substr(n+1).split(Kg);if(a=r,e){var s=e[a],o=Se.deriveDeep(s,!0);i.forEach(function(l){var c=l.split(Zg,2),u=decodeURIComponent(c[0]),f=decodeURIComponent(c[1]),h=Mh[wn(le.get(s,u))];h?le.set(o,u,h(f)):Wt.warn('Unknown argument "'.concat(u,'" for option "').concat(a,'"'))}),Object.keys(o).length>0&&(a=[a,o])}}else a=r}return a}var Iu={l:"load",load:String,t:"type",type:String,v:"view",view:String,u:"unit",unit:Number,menu:$g,o:"object",object:function(e,t){var n=[],r=Cl(e,Q.defaults.objects,n);Array.isArray(r)||(r=[r]),nA(t,n[0],r)},p:"preset",preset:function(e,t){t.preset=e,t.reps=null,$l(t)},r:"rep",rep:function(e,t){$l(t),Jt=Number(e),Jt=Jt<=t.reps.length?Jt<0?0:Jt:t.reps.length,Jt===t.reps.length&&(t.reps[Jt]=Jt>0?Se.deriveDeep(t.reps[Jt-1],!0):Se.deriveDeep(Q.defaults.presets.default[0],!0))},s:"select",select:function(e,t){El(t,"selector",e)},m:"mode",mode:function(e,t){El(t,"mode",Cl(e,Q.defaults.modes))},c:"color",color:function(e,t){El(t,"colorer",Cl(e,Q.defaults.colorers))},mt:"material",material:function(e,t){El(t,"material",Cl(e,Q.defaults.materials))},dup:function(e,t){$l(t);var n=t.reps,r=n[Jt];Jt=n.length,n[Jt]=Se.deriveDeep(r,!0)},ar:"autoResolution"};function Qg(a){Jt=0;for(var e={},t=0,n=a.length;t<n;++t){var r=a[t],i=r[0],s=r[1];if(Iu.hasOwnProperty(i)){for(var o=Iu[i];le.isString(o);)i=o,o=Iu[i];if(typeof o=="function"){var l=o(s,e);l!==void 0&&(e[i]=l)}}else{var c=Mh[wn(le.get(Q.defaults,i))];c?le.set(e,"settings.".concat(i),c(s)):Wt.warn('Unknown option "'.concat(i,'"'))}}return e}function aA(a){return Qg(Se.getUrlParameters("?".concat(a||"")))}function sA(a){return Qg(Se.getUrlParameters(a))}function e_(a){var e=[],t=0;return Se.forInRecursive(a,function(n,r){e[t++]=om(r)+Zg+om(n)}),e.join(Kg)}function ku(a){return le.isArray(a)?a.length<2?a[0]:"".concat(a[0]).concat(Eh).concat(e_(a[1])):a}function oA(a){if(!(!a||!a.type)){var e=a.type;return le.isArray(a.params)&&a.params.length>0&&(e+=",".concat(a.params.join(","))),a.opts&&(e+=Eh+e_(a.opts)),e}}function lA(a){var e=[],t=0;function n(c,u){u!=null&&(e[t++]=sm(c)+JC+sm(u))}function r(c){if(c)for(var u=0,f=c.length;u<f;++u)le.isEmpty(c[u])||(n("r",u),n("s",c[u].selector),n("m",ku(c[u].mode)),n("c",ku(c[u].colorer)),n("mt",ku(c[u].material)))}function i(c){if(c)for(var u=0,f=c.length;u<f;++u)n("o",oA(c[u]))}n("l",a.load),n("u",a.unit),n("p",a.preset),r(a.reps),i(a._objects),n("v",a.view),Se.forInRecursive(a.settings,function(c,u){u!=="preset"&&n(u,c)});var s="";if(typeof window<"u"){var o=window,l=o.location;s="".concat(l.protocol,"//").concat(l.host).concat(l.pathname)}return e.length>0&&(s+="?".concat(e.join("&"))),s}function t_(a){var e=[],t=0;return Se.forInRecursive(a,function(n,r){e[t++]="".concat(r,"=").concat(Se.enquoteString(n))}),e.join(" ")}function Ou(a){return le.isArray(a)?a.length<2?a[0]:"".concat(a[0]," ").concat(t_(a[1])):a}function cA(a){if(!(!a||!a.type)){var e=a.type;return le.isArray(a.params)&&a.params.length>0&&(e+=" ".concat(a.params.map(Se.enquoteString).join(" "))),a.opts&&(e+=" ".concat(t_(a.opts))),e}}function uA(a,e){var t=[],n=0;function r(i,s){s!=null&&(t[n++]=i+s)}return le.isEmpty(a)?null:(r("",e),r("s=",Se.enquoteString(a.selector)),r("m=",Ou(a.mode)),r("c=",Ou(a.colorer)),r("mt=",Ou(a.material)),t.join(" "))}function fA(a){var e=[],t=0;function n(s,o,l){if(o!=null){var c=typeof o=="string"&&l?'"':"";e[t++]="".concat(s," ").concat(c).concat(o).concat(c).trim()}}function r(s){if(s)for(var o=0,l=s.length;o<l;++o)n("rep",uA(s[o],o))}function i(s){if(s)for(var o=0,l=s.length;o<l;++o)n("",cA(s[o]))}return n("set","autobuild false"),n("load",a.load,!0),n("unit",a.unit),n("preset",a.preset),r(a.reps),i(a._objects),Se.forInRecursive(a.settings,function(s,o){o!=="preset"&&n("set ".concat(o),s,!0)}),n("view",a.view),n("set","autobuild true"),e.join(`
`)}var Ff={fromURL:sA,fromAttr:aA,adapters:Mh,toURL:lA,toScript:fA};function Le(a,e,t){return e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}var ln=function(){function a(e,t,n,r,i,s,o,l,c,u,f){G(this,a),this.index=-1,this.residue=e,this.name=t,this.element=n,this.position=r,this.role=i,this.mask=1,this.het=s,this.serial=o,this.location=(l||" ").charCodeAt(0),this.occupancy=c||1,this.temperature=u,this.charge=f,this.hydrogenCount=-1,this.radicalCount=0,this.valence=-1,this.bonds=[],this.flags=0,n.name==="H"?this.flags|=a.Flags.HYDROGEN:n.name==="C"&&(this.flags|=a.Flags.CARBON)}return H(a,[{key:"isHet",value:function(){return this.het}},{key:"isHydrogen",value:function(){return this.element.number===1}},{key:"getVisualName",value:function(){var t=this.name;return t.length>0?t:this.element.name.trim()}},{key:"forEachBond",value:function(t){for(var n=this.bonds,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"getFullName",value:function(){var t="";return this.residue!==null&&(this.residue._chain!==null&&(t+="".concat(this.residue._chain.getName(),".")),t+="".concat(this.residue._sequence,".")),t+=this.name,t}}]),a}();Le(ln,"Flags",{CARBON:1,HYDROGEN:8,NONPOLARH:4104});var fe=H(function a(e,t,n,r,i,s,o){G(this,a),this.number=e,this.name=t,this.fullName=n,this.weight=r,this.radius=i,this.radiusBonding=s,this.hydrogenValency=o});Le(fe,"Constants",{U1:1,Lead:2,U2:3,Wing:4,U18:18});Le(fe,"Role",{N:fe.Constants.U1,CA:fe.Constants.Lead,C:fe.Constants.U2,O:fe.Constants.Wing,SG:fe.Constants.U18});Le(fe,"ByAtomicNumber",[null,new fe(1,"H","Hydrogen",1.008,1.2,.23,[1]),new fe(2,"HE","Helium",4.003,1.4,.93,[0]),new fe(3,"LI","Lithium",6.941,1.82,.68,[1]),new fe(4,"BE","Beryllium",9.012,1.7,.35,[2]),new fe(5,"B","Boron",10.81,2.08,.83,[3]),new fe(6,"C","Carbon",12.011,1.95,.68,[4]),new fe(7,"N","Nitrogen",14.007,1.85,.68,[3,5]),new fe(8,"O","Oxygen",15.999,1.7,.68,[2,4]),new fe(9,"F","Fluorine",18.998,1.73,.64,[1]),new fe(10,"NE","Neon",20.18,1.54,1.12,[0]),new fe(11,"NA","Sodium",22.99,2.27,.97,[1]),new fe(12,"MG","Magnesium",24.305,1.73,1.1,[2]),new fe(13,"AL","Aluminum",26.981,2.05,1.35,[3]),new fe(14,"SI","Silicon",28.086,2.1,1.2,[4]),new fe(15,"P","Phosphorus",30.974,2.08,.75,[3,5]),new fe(16,"S","Sulfur",32.07,2,1.02,[2,4,6]),new fe(17,"CL","Chlorine",35.453,1.97,.99,[1,3,5,7]),new fe(18,"AR","Argon",39.948,1.88,1.57,[0]),new fe(19,"K","Potassium",39.1,2.75,1.33,[1]),new fe(20,"CA","Calcium",40.08,1.973,.99,[2]),new fe(21,"SC","Scandium",44.956,1.7,1.44,[0]),new fe(22,"TI","Titanium",47.88,1.7,1.47,[0]),new fe(23,"V","Vanadium",50.941,1.7,1.33,[0]),new fe(24,"CR","Chromium",52,1.7,1.35,[0]),new fe(25,"MN","Manganese",54.938,1.7,1.35,[0]),new fe(26,"FE","Iron",55.847,1.7,1.34,[0]),new fe(27,"CO","Cobalt",58.93,1.7,1.33,[0]),new fe(28,"NI","Nickel",58.69,1.63,1.5,[0]),new fe(29,"CU","Copper",63.55,1.4,1.52,[0]),new fe(30,"ZN","Zinc",65.39,1.39,1.45,[0]),new fe(31,"GA","Gallium",69.72,1.87,1.22,[3]),new fe(32,"GE","Germanium",72.61,1.7,1.17,[4]),new fe(33,"AS","Arsenic",74.92,1.85,1.21,[3,5]),new fe(34,"SE","Selenium",78.96,1.9,1.22,[2,4,6]),new fe(35,"BR","Bromine",79.9,2.1,1.21,[1,3,5,7]),new fe(36,"KR","Krypton",83.8,2.02,1.91,[0]),new fe(37,"RB","Rubidium",85.47,1.7,1.47,[1]),new fe(38,"SR","Strontium",87.62,1.7,1.12,[2]),new fe(39,"Y","Yttrium",88.91,1.7,1.78,[0]),new fe(40,"ZR","Zirconium",91.22,1.7,1.56,[0]),new fe(41,"NB","Niobium",92.91,1.7,1.48,[0]),new fe(42,"MO","Molybdenum",95.94,1.7,1.47,[0]),new fe(43,"TC","Technetium",98.91,1.7,1.35,[0]),new fe(44,"RU","Ruthenium",101.07,1.7,1.4,[0]),new fe(45,"RH","Rhodium",102.91,1.7,1.45,[0]),new fe(46,"PD","Palladium",106.42,1.63,1.5,[0]),new fe(47,"AG","Silver",107.87,1.72,1.59,[0]),new fe(48,"CD","Cadmium",112.41,1.58,1.69,[0]),new fe(49,"IN","Indium",114.82,1.93,1.63,[3]),new fe(50,"SN","Tin",118.71,2.17,1.46,[2,4]),new fe(51,"SB","Antimony",121.75,2.2,1.46,[3,5]),new fe(52,"TE","Tellurium",127.6,2.06,1.47,[2,4,6]),new fe(53,"I","Iodine",126.91,2.15,1.4,[1,3,5,7]),new fe(54,"XE","Xenon",131.29,2.16,1.98,[0]),new fe(55,"CS","Cesium",132.91,1.7,1.67,[1]),new fe(56,"BA","Barium",137.33,1.7,1.34,[2]),new fe(57,"LA","Lanthanum",138.91,1.7,1.87,[0]),new fe(58,"CE","Cerium",140.12,1.7,1.83,[0]),new fe(59,"PR","Praseodymium",140.91,1.7,1.82,[0]),new fe(60,"ND","Neodymium",144.24,1.7,1.81,[0]),new fe(61,"PM","Promethium",144.9,1.7,1.8,[0]),new fe(62,"SM","Samarium",150.36,1.7,1.8,[0]),new fe(63,"EU","Europium",151.96,1.7,1.99,[0]),new fe(64,"GD","Gadolinium",157.25,1.7,1.79,[0]),new fe(65,"TB","Terbium",158.93,1.7,1.76,[0]),new fe(66,"DY","Dysprosium",162.5,1.7,1.75,[0]),new fe(67,"HO","Holmium",164.93,1.7,1.74,[0]),new fe(68,"ER","Erbium",167.26,1.7,1.73,[0]),new fe(69,"TM","Thulium",168.93,1.7,1.72,[0]),new fe(70,"YB","Ytterbium",173.04,1.7,1.94,[0]),new fe(71,"LU","Lutetium",174.97,1.7,1.72,[0]),new fe(72,"HF","Hafnium",178.49,1.7,1.57,[0]),new fe(73,"TA","Tantalum",180.95,1.7,1.43,[0]),new fe(74,"W","Tungsten",183.85,1.7,1.37,[0]),new fe(75,"RE","Rhenium",186.21,1.7,1.35,[0]),new fe(76,"OS","Osmium",190.2,1.7,1.37,[0]),new fe(77,"IR","Iridium",192.22,1.7,1.32,[0]),new fe(78,"PT","Platinum",195.08,1.72,1.5,[0]),new fe(79,"AU","Gold",196.97,1.66,1.5,[0]),new fe(80,"HG","Mercury",200.59,1.55,1.7,[0]),new fe(81,"TL","Thallium",204.38,1.96,1.55,[1,3]),new fe(82,"PB","Lead",207.2,2.02,1.54,[2,4]),new fe(83,"BI","Bismuth",208.98,1.7,1.54,[3,5]),new fe(84,"PO","Polonium",210,1.7,1.68,[2,4,6]),new fe(85,"AT","Astatine",210,1.7,1.7,[1,3,5,7]),new fe(86,"RN","Radon",222,1.7,2.4,[0]),new fe(87,"FR","Francium",223,1.7,2,[1]),new fe(88,"RA","Radium",226.03,1.7,1.9,[2]),new fe(89,"AC","Actinium",227.03,1.7,1.88,[0]),new fe(90,"TH","Thorium",232.04,1.7,1.79,[0]),new fe(91,"PA","Protactinium",231.04,1.7,1.61,[0]),new fe(92,"U","Uranium",238.03,1.86,1.58,[0]),new fe(93,"NP","Neptunium",237.05,1.7,1.55,[0]),new fe(94,"PU","Plutonium",239.1,1.7,1.53,[0]),new fe(95,"AM","Americium",243.1,1.7,1.51,[0]),new fe(96,"CM","Curium",247.1,1.7,1.5,[0]),new fe(97,"BK","Berkelium",247.1,1.7,1.5,[0]),new fe(98,"CF","Californium",252.1,1.7,1.5,[0]),new fe(99,"ES","Einsteinium",252.1,1.7,1.5,[0]),new fe(100,"FM","Fermium",257.1,1.7,1.5,[0]),new fe(101,"MD","Mendelevium",256.1,1.7,1.5,[0]),new fe(102,"NO","Nobelium",259.1,1.7,1.5,[0]),new fe(103,"LR","Lawrencium",260.1,1.7,1.5,[0]),new fe(104,"RF","Rutherfordium",261,1.7,1.6,[0]),new fe(105,"DB","Dubnium",262,1.7,1.6,[0]),new fe(106,"SG","Seaborgium",263,1.7,1.6,[0]),new fe(107,"BH","Bohrium",262,1.7,1.6,[0]),new fe(108,"HS","Hassium",265,1.7,1.6,[0]),new fe(109,"MT","Meitnerium",268,1.7,1.6,[0])]);Le(fe,"ByName",{D:new fe(1,"D","Deuterium",2.014,1.2,.23,[1]),T:new fe(1,"T","Tritium",3.016,1.2,.23,[1])});(function(){for(var a=fe.ByAtomicNumber,e=fe.ByName,t=0,n=a.length;t<n;++t){var r=a[t];r&&(e[r.name]=r)}})();fe.getByName=function(a){var e=fe.ByName[a];return e||(e=fe.ByName[a]=new fe(0,a,"Unknown",0,1,.01,[0])),e};var r_={UNKNOWN:0,COVALENT:1,AROMATIC:2};function hA(a){return a.position}var ta=function(){function a(e,t,n,r,i){if(G(this,a),this._left=e,this._right=t,this._fixed=i,this._index=-1,e>t)throw new Error("In a bond atom indices must be in increasing order");this._order=n,this._type=r}return H(a,[{key:"getLeft",value:function(){return this._left}},{key:"getRight",value:function(){return this._right}},{key:"getOrder",value:function(){return this._order}},{key:"calcLength",value:function(){return this._left.position.distanceTo(this._right.position)}},{key:"_forEachNeighbour",value:function(t,n){for(var r=t.bonds,i=0,s=r.length;i<s;++i)n(r[i]._left!==t?r[i]._left:r[i]._right)}},{key:"forEachLevelOne",value:function(t){var n=this._left,r=this._right;this._forEachNeighbour(n,function(i){i!==r&&t(i)}),this._forEachNeighbour(r,function(i){i!==n&&t(i)})}},{key:"forEachLevelTwo",value:function(t){var n=this._left,r=this._right,i=this;i._forEachNeighbour(n,function(s){s!==r&&i._forEachNeighbour(s,function(o){o!==n&&t(o)})}),i._forEachNeighbour(r,function(s){s!==n&&i._forEachNeighbour(s,function(o){o!==r&&t(o)})})}},{key:"_fixDir",value:function(t,n,r){var i=0,s=0,o=t.clone();function l(h){o.copy(r(h)),o.sub(t);var d=n.dot(o);d>0?++i:++s}function c(h){h.element.name==="C"&&l(h)}for(var u=[[this.forEachLevelOne,c],[this.forEachLevelOne,l],[this.forEachLevelTwo,c],[this.forEachLevelTwo,l]],f=0;f<u.length;++f){if(u[f][0].call(this,u[f][1]),s>i)return n.multiplyScalar(-1);if(s<i)return n}return n}},{key:"calcNormalDir",value:function(t){var n=this._left,r=this._right,i=n,s=r;t=t===void 0?hA:t,n.bonds.length>r.bonds.length&&(i=r,s=n);for(var o=i,l=0,c=s,u=c.bonds,f=0,h=u.length;f<h;++f){var d=u[f]._left;u[f]._left===s&&(d=u[f]._right),d.bonds.length>l&&d!==i&&(o=d,l=d.bonds.length)}var p=t(s),v=t(i).clone().sub(p),_=t(o).clone().sub(p);return _.crossVectors(v,_),_.lengthSq()<1e-4&&_.set(0,1,0),v.normalize(),_.normalize(),v.crossVectors(_,v),v.lengthSq()<1e-4&&v.set(0,1,0),v.normalize(),this._fixDir(p,v,t)}}]),a}();Le(ta,"BondType",r_);ta.prototype.BondType=r_;var dA=["C3'","C3*","P","H5T","H3T"],lm=["OP1","O1P"],cm=["OP2","O2P"],pA=["C3'","C3*","C1","C1'","C1*","P"],Al=[{types:["A","DA","G","DG"],atoms:["N1"]},{types:["C","DC"],atoms:["N3"]},{types:["T","DT","U","DU"],atoms:["O4"]}],fc=function(){function a(e,t,n,r){G(this,a),this._chain=e,this._component=null,this._type=t,this._sequence=n,this._icode=r,this._mask=1,this._index=-1,this._atoms=[],this._secondary=null,this._firstAtom=null,this._leadAtom=null,this._wingAtom=null,this._lastAtom=null,this._controlPoint=null,this._midPoint=null,this._wingVector=null,this._cylinders=null,this._isValid=!0,this._het=!1,this._molecule=null,this.temperature=null,this.occupancy=null}return H(a,[{key:"getChain",value:function(){return this._chain}},{key:"getMolecule",value:function(){return this._molecule}},{key:"getType",value:function(){return this._type}},{key:"getSequence",value:function(){return this._sequence}},{key:"getSecondary",value:function(){return this._secondary}},{key:"getICode",value:function(){return this._icode}},{key:"addAtom",value:function(t,n,r,i,s,o,l,c,u,f){var h=new ln(this,t,n,r,i,s,o,l,c,u,f),d=this._chain.getComplex();return d.addAtom(h),this._atoms.push(h),this._het=this._het||s,h}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"forEachAtom",value:function(t){for(var n=this._atoms,r=0,i=n.length;r<i&&!t(n[r]);++r);}},{key:"_findAtomByName",value:function(t){var n=null;return this.forEachAtom(function(r){return r.name===t?(n=r,!0):!1}),n}},{key:"_findFirstAtomInList",value:function(t){for(var n=null,r=0;r<t.length;++r)if(n=this._findAtomByName(t[r]),n!==null)return n;return n}},{key:"collectMask",value:function(){for(var t=4294967295,n=this._atoms,r=0,i=n.length;r<i;++r)t&=n[r].mask;this._mask=t}},{key:"getCylinderTargetList",value:function(){for(var t=this._type._name,n=0,r=Al.length;n<r;++n)for(var i=0,s=Al[n].types.length;i<s;++i)if(t===Al[n].types[i])return Al[n].atoms;return null}},{key:"_detectLeadWing",value:function(t,n,r){var i=this._findFirstAtomInList(dA),s=this._findFirstAtomInList(lm),o=this._findFirstAtomInList(cm);if(s===null&&n!==null&&(s=n._findFirstAtomInList(lm)),o===null&&n!==null&&(o=n._findFirstAtomInList(cm)),!(i===null||s===null||o===null)){t._leadAtom=i,t._controlPoint=r(i),t._wingVector=r(o).clone().sub(r(s)),t._isValid=!0;var l=this._findFirstAtomInList(pA),c=this.getCylinderTargetList(),u=c!==null?this._findFirstAtomInList(c):null;l===null||u===null||(t._cylinders=[r(l),r(u)])}}},{key:"calcWing",value:function(t,n,r,i){var s=n.clone().sub(t),o=t.clone().sub(r);if(o.crossVectors(s,o),o.crossVectors(s,o).normalize(),i!==null&&i.length()>1e-4){var l=o.length()>1e-4&&Math.abs(i.angleTo(o))>Math.PI/2;l&&o.negate()}return o}},{key:"_innerFinalize",value:function(t,n,r,i,s,o){var l=n===null,c=o(this._leadAtom),u=new b(c.x,c.y,c.z);if(s){this._detectLeadWing(i,r,o);return}if(l)i._midPoint=o(this._firstAtom).clone();else{var f=n._controlPoint;i._midPoint=f.clone().lerp(u,.5),i._wingVector=this.calcWing(f,u,o(t._wingAtom),n._wingVector)}i._controlPoint=u}},{key:"_finalize2",value:function(t,n,r){this._innerFinalize(t,t,n,this,r,function(i){return i.position})}},{key:"isConnected",value:function(t){if(this._chain!==t._chain)return!1;if(this===t)return!0;var n=!1;return this.forEachAtom(function(r){for(var i=r.bonds,s=0,o=i.length;s<o;++s){var l=i[s];if(l._left.residue===t||l._right.residue===t)return n=!0,!0}return!1}),n}},{key:"_finalize",value:function(){var t=this,n=Lt(this._atoms,1);this._firstAtom=n[0],this._lastAtom=this._atoms[this._atoms.length-1],this._leadAtom=null,this._wingAtom=null;var r=0,i=0,s=0,o=0;this.forEachAtom(function(l){return t._leadAtom===null&&l.role===fe.Constants.Lead&&(t._leadAtom=l),t._wingAtom===null&&l.role===fe.Constants.Wing&&(t._wingAtom=l),l.temperature&&(i+=l.temperature,r++),l.occupancy&&(o+=l.occupancy,s++),t._leadAtom!==null&&t._wingAtom!==null}),r>0&&(this.temperature=i/r),s>0&&(this.occupancy=o/s),(this._leadAtom===null||this._wingAtom===null)&&(this._isValid=!1),this._leadAtom===null&&(this._leadAtom=this._firstAtom),this._wingAtom===null&&(this._wingAtom=this._lastAtom)}}]),a}(),Be=function(){function a(e,t,n){G(this,a),this._name=e,this._fullName=t,this.letterCode=n,this.flags=0}return H(a,[{key:"getName",value:function(){return this._name}}]),a}();Le(Be,"StandardTypes",{ALA:new Be("ALA","Alanine","A"),ARG:new Be("ARG","Arginine","R"),ASN:new Be("ASN","Asparagine","N"),ASP:new Be("ASP","Aspartic Acid","D"),CYS:new Be("CYS","Cysteine","C"),GLN:new Be("GLN","Glutamine","Q"),GLU:new Be("GLU","Glutamic Acid","E"),GLY:new Be("GLY","Glycine","G"),HIS:new Be("HIS","Histidine","H"),ILE:new Be("ILE","Isoleucine","I"),LEU:new Be("LEU","Leucine","L"),LYS:new Be("LYS","Lysine","K"),MET:new Be("MET","Methionine","M"),PHE:new Be("PHE","Phenylalanine","F"),PRO:new Be("PRO","Proline","P"),PYL:new Be("PYL","Pyrrolysine","O"),SEC:new Be("SEC","Selenocysteine","U"),SER:new Be("SER","Serine","S"),THR:new Be("THR","Threonine","T"),TRP:new Be("TRP","Tryptophan","W"),TYR:new Be("TYR","Tyrosine","Y"),VAL:new Be("VAL","Valine","V"),A:new Be("A","Adenine","A"),C:new Be("C","Cytosine","C"),G:new Be("G","Guanine","G"),I:new Be("I","Inosine","I"),T:new Be("T","Thymine","T"),U:new Be("U","Uracil","U"),DA:new Be("DA","Adenine","A"),DC:new Be("DC","Cytosine","C"),DG:new Be("DG","Guanine","G"),DI:new Be("DI","Inosine","I"),DT:new Be("DT","Thymine","T"),DU:new Be("DU","Uracil","U"),"+A":new Be("+A","Adenine","A"),"+C":new Be("+C","Cytosine","C"),"+G":new Be("+G","Guanine","G"),"+I":new Be("+I","Inosine","I"),"+T":new Be("+T","Thymine","T"),"+U":new Be("+U","Uracil","U"),WAT:new Be("WAT","Water",""),H2O:new Be("H2O","Water",""),HOH:new Be("HOH","Water",""),DOD:new Be("DOD","Water",""),UNK:new Be("UNK","Unknown",""),UNL:new Be("UNL","Unknown Ligand","")});Le(Be,"Flags",{PROTEIN:1,BASIC:2,ACIDIC:4,POLAR:8,NONPOLAR:16,AROMATIC:32,NUCLEIC:256,PURINE:512,PYRIMIDINE:1024,DNA:2048,RNA:4096,WATER:65536});function $r(a,e){for(var t=0,n=e.length;t<n;++t){var r=Be.StandardTypes[e[t]];r&&(r.flags|=a)}}var Zr=Be.Flags;$r(Zr.WATER,["WAT","H2O","HOH","DOD"]);$r(Zr.PROTEIN,["ALA","ARG","ASN","ASP","CYS","GLY","GLU","GLN","HIS","ILE","LEU","LYS","MET","PHE","PRO","PYL","SEC","SER","THR","TRP","TYR","VAL"]);$r(Zr.BASIC,["ARG","HIS","LYS"]);$r(Zr.ACIDIC,["ASP","GLU"]);$r(Zr.POLAR,["ASN","CYS","GLN","SER","THR","TYR"]);$r(Zr.NONPOLAR,["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL","GLY"]);$r(Zr.AROMATIC,["PHE","TRP","TYR"]);$r(Zr.NUCLEIC,["A","G","I","DA","DG","DI","+A","+G","+I","C","T","U","DC","DT","DU","+C","+T","+U"]);$r(Zr.PURINE,["A","G","I","DA","DG","DI","+A","+G","+I"]);$r(Zr.PYRIMIDINE,["C","T","U","DC","DT","DU","+C","+T","+U"]);$r(Zr.DNA,["DA","DG","DI","DC","DT","DU"]);$r(Zr.RNA,["A","G","I","C","T","U"]);var mA={ILE:4.5,VAL:4.2,LEU:3.8,PHE:2.8,CYS:2.5,MET:1.9,ALA:1.8,GLY:-.4,THR:-.7,SER:-.8,TRP:-.9,TYR:-1.3,PRO:-1.6,HIS:-3.2,GLU:-3.5,GLN:-3.5,ASP:-3.5,ASN:-3.5,LYS:-3.9,ARG:-4.5};function vA(a,e){for(var t=Object.keys(e),n=0,r=t.length;n<r;++n){var i=t[n],s=e[i];Be.StandardTypes[i][a]=s}}vA("hydrophobicity",mA);var Os={UNKNOWN:0,PROTEIN:1,NUCLEIC:2},n_=function(){function a(e,t){G(this,a),this._complex=e,this._name=t,this._mask=1,this._index=-1,this._residues=[],this.minSequence=Number.POSITIVE_INFINITY,this.maxSequence=Number.NEGATIVE_INFINITY}return H(a,[{key:"getComplex",value:function(){return this._complex}},{key:"getName",value:function(){return this._name}},{key:"getResidues",value:function(){return this._residues}},{key:"_determineType",value:function(){var t=this._residues,n=Be.Flags,r=n.PROTEIN,i=n.NUCLEIC;this.type=Os.UNKNOWN;for(var s=0,o=t.length;s<o;++s){var l=t[s]._type.flags;if(l&i){this.type=Os.NUCLEIC;break}else if(l&r){this.type=Os.PROTEIN;break}}}},{key:"findResidue",value:function(t,n){for(var r=this._residues,i=0,s=r.length;i<s;++i){var o=r[i];if(o._sequence===t&&o._icode===n)return[o,i]}return null}},{key:"_finalize",value:function(){this._determineType();for(var t=this._residues,n=null,r=0,i=t.length;r<i;++r){var s=r+1<i?t[r+1]:null,o=t[r];o._finalize2(n,s,this.type===Os.NUCLEIC),n=o}if(t.length>1&&t[1]._wingVector){var l=t[1]._wingVector;t[0]._wingVector=new b(l.x,l.y,l.z)}else t.length>0&&(t[0]._wingVector=new b(1,0,0))}},{key:"updateToFrame",value:function(t){var n=this._residues,r=null,i=null,s=t._residues,o=n.length;function l(d){return t.getAtomPos(d.index)}for(var c=0;c<o;++c){var u=n[c],f=s[u._index],h=c+1<o?n[c+1]:null;u._innerFinalize(r,i,h,f,this.type===Os.NUCLEIC,l),r=u,i=f}s[n[0]._index]._wingVector=o>1?s[n[1]._index]._wingVector:new b(1,0,0)}},{key:"addResidue",value:function(t,n,r){var i=this._complex.getResidueType(t);i===null&&(i=this._complex.addResidueType(t));var s=new fc(this,i,n,r);return this._complex.addResidue(s),this._residues.push(s),i.flags&(Be.Flags.NUCLEIC|Be.Flags.PROTEIN)&&(this.maxSequence<n&&(this.maxSequence=n),this.minSequence>n&&(this.minSequence=n)),s}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"forEachResidue",value:function(t){for(var n=this._residues,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"collectMask",value:function(){for(var t=4294967295,n=this._residues,r=0,i=n.length;r<i;++r)t&=n[r]._mask;this._mask=t}}]),a}(),ki,qt=function(){function a(e,t,n){G(this,a),this.type=e,this.generic=a.genericByType[this.type]||"loop",this.init=t,this.term=n}return H(a,[{key:"_finalize",value:function(t,n,r){if(!(this.init instanceof fc&&this.term instanceof fc)){for(var i=r.splitUnifiedSerial(this.init),s=r.splitUnifiedSerial(this.term),o=i.chain;o<=s.chain;o++)for(var l=i.serial;l<=s.serial;l++)for(var c=i.iCode;c<=s.iCode;c++){var u=r.getUnifiedSerial(o,l,c);n[u]&&(n[u]._secondary=this)}this.init=n[this.init],this.term=n[this.term]}}}]),a}();qt.Type={STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",HELIX:"X",TURN_310:"3",TURN_ALPHA:"4",TURN_PI:"5",TURN:"T",BEND:"S",COIL:"C"};qt.Generic={STRAND:"strand",HELIX:"helix",LOOP:"loop"};var Ds=qt.Type,Fs=qt.Generic;qt.genericByType=(ki={},Le(ki,Ds.STRAND,Fs.STRAND),Le(ki,Ds.HELIX_310,Fs.HELIX),Le(ki,Ds.HELIX_ALPHA,Fs.HELIX),Le(ki,Ds.HELIX_PI,Fs.HELIX),Le(ki,Ds.HELIX,Fs.HELIX),ki);function gA(a){var e=_A();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function _A(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Du=qt.Type,i_={1:Du.HELIX_ALPHA,3:Du.HELIX_PI,5:Du.HELIX_310},Bf=function(a){re(t,a);var e=gA(t);function t(n,r,i,s,o,l,c){var u;return G(this,t),u=e.call(this,i_[n]||qt.Type.HELIX,r,i),u.serial=s,u.name=o,u.comment=l,u.length=c,u}return H(t)}(qt);function yA(a,e){for(;!Object.prototype.hasOwnProperty.call(a,e)&&(a=D(a),a!==null););return a}function xt(){return typeof Reflect<"u"&&Reflect.get?xt=Reflect.get:xt=function(e,t,n){var r=yA(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},xt.apply(this,arguments)}function xA(a){var e=SA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function SA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Ch=function(a){re(t,a);var e=xA(t);function t(n,r,i,s,o,l){var c;return G(this,t),c=e.call(this,qt.Type.STRAND,r,i),c.sheet=n,c.sense=s,c.atomCur=o,c.atomPrev=l,c}return H(t,[{key:"_finalize",value:function(r,i,s){xt(D(t.prototype),"_finalize",this).call(this,r,i,s);var o=this.atomCur;o!==null&&!Number.isNaN(o)&&(this.atomCur=r[o]),o=this.atomPrev,o!==null&&!Number.isNaN(o)&&(this.atomPrev=r[o])}}]),t}(qt),a_=function(){function a(e,t){G(this,a),this._name=e,this._width=t,this._strands=[]}return H(a,[{key:"getName",value:function(){return this._name}},{key:"getWidth",value:function(){return this._width}},{key:"addStrand",value:function(t){this._strands.push(t),this._width=this._strands.length}},{key:"addEmptyStrand",value:function(){this._strands.push(new Ch(null,null,null,null,null,null))}},{key:"_finalize",value:function(t,n,r){for(var i=this._strands,s=0,o=i.length;s<o;++s)i[s]._finalize(t,n,r);if(this._width||(this._width=i.length),i.length!==this._width)throw new Error("Sheet ".concat(this._name," is inconsistent."))}}]),a}(),bA=function(){function a(e,t,n,r,i){G(this,a),this._id=e,this._name=t,this._position=n||new b,this._atoms=r||[],this._charge=0,this._repeat=1,this._center=null,this.xmlNodeRef=i||null}return H(a,[{key:"getName",value:function(){return this._name}},{key:"getPosition",value:function(){return this._position}},{key:"getCentralPoint",value:function(){return this._center}},{key:"_rebuildSGroupOnAtomChange",value:function(){var t=1e8;if(this._center!==null){for(var n=new b(t,t,t),r=new b(-1e8,-1e8,-1e8),i=0,s=this._atoms.length;i<s;i++){var o=this._atoms[i].position;n.set(Math.min(n.x,o.x),Math.min(n.y,o.y),Math.min(n.z,o.z)),r.set(Math.max(r.x,o.x),Math.max(r.y,o.y),Math.max(r.z,o.z))}this._center.addVectors(n,r),this._center.multiplyScalar(.5)}}}]),a}(),s_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof rc<"u"?rc:typeof self<"u"?self:{},wA=function(){var a=function(y,x,S,M){for(S=S||{},M=y.length;M--;S[y[M]]=x);return S},e=[1,4],t=[1,5],n=[1,6],r=[1,7],i=[1,8],s=[1,9],o=[1,11],l=[1,12],c=[5,7,8,11],u=[1,17],f=[1,22],h=[1,20],d=[1,21],p=[5,7,8,11,19],v={trace:function(){},yy:{},symbols_:{error:2,Program:3,Expression:4,EOF:5,Selector:6,OR:7,AND:8,NOT:9,"(":10,")":11,SELECTOR:12,NAMED_SELECTOR:13,SELECTOR_RANGED:14,RangeList:15,SELECTOR_NAMED:16,NameList:17,Range:18,",":19,NUMBER:20,":":21,Name:22,IDENTIFIER:23,STRING:24,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"OR",8:"AND",9:"NOT",10:"(",11:")",12:"SELECTOR",13:"NAMED_SELECTOR",14:"SELECTOR_RANGED",16:"SELECTOR_NAMED",19:",",20:"NUMBER",21:":",23:"IDENTIFIER",24:"STRING"},productions_:[0,[3,2],[4,1],[4,3],[4,3],[4,2],[4,3],[6,1],[6,1],[6,2],[6,2],[15,1],[15,3],[18,1],[18,3],[17,1],[17,3],[22,1],[22,1],[22,1]],performAction:function(y,x,S,M,E,N,B){var V=N.length-1;switch(E){case 1:return N[V-1];case 3:this.$=M.keyword("or")(N[V-2],N[V]);break;case 4:this.$=M.keyword("and")(N[V-2],N[V]);break;case 5:this.$=M.keyword("not")(N[V]);break;case 6:this.$=N[V-1];break;case 7:this.$=M.keyword(N[V])();break;case 8:this.$=M.GetSelector(N[V].toLowerCase().slice(1,N[V].length));break;case 9:case 10:this.$=M.keyword(N[V-1])(N[V]);break;case 11:this.$=new M.RangeList(N[V]);break;case 12:case 16:this.$=N[V-2].append(N[V]);break;case 13:this.$=new M.Range(Number(N[V]));break;case 14:this.$=new M.Range(Number(N[V-2]),Number(N[V]));break;case 15:this.$=new M.ValueList(N[V]);break}},table:[{3:1,4:2,6:3,9:e,10:t,12:n,13:r,14:i,16:s},{1:[3]},{5:[1,10],7:o,8:l},a(c,[2,2]),{4:13,6:3,9:e,10:t,12:n,13:r,14:i,16:s},{4:14,6:3,9:e,10:t,12:n,13:r,14:i,16:s},a(c,[2,7]),a(c,[2,8]),{15:15,18:16,20:u},{17:18,20:f,22:19,23:h,24:d},{1:[2,1]},{4:23,6:3,9:e,10:t,12:n,13:r,14:i,16:s},{4:24,6:3,9:e,10:t,12:n,13:r,14:i,16:s},a(c,[2,5]),{7:o,8:l,11:[1,25]},a(c,[2,9],{19:[1,26]}),a(p,[2,11]),a(p,[2,13],{21:[1,27]}),a(c,[2,10],{19:[1,28]}),a(p,[2,15]),a(p,[2,17]),a(p,[2,18]),a(p,[2,19]),a([5,7,11],[2,3],{8:l}),a(c,[2,4]),a(c,[2,6]),{18:29,20:u},{20:[1,30]},{20:f,22:31,23:h,24:d},a(p,[2,12]),a(p,[2,14]),a(p,[2,16])],defaultActions:{10:[2,1]},parseError:function(y,x){if(x.recoverable)this.trace(y);else{var S=new Error(y);throw S.hash=x,S}},parse:function(y){var x=this,S=[0],M=[],E=[null],N=[],B=this.table,V="",O=0,W=0,z=2,C=1,T=N.slice.call(arguments,1),A=Object.create(this.lexer),F={yy:{}};for(var X in this.yy)Object.prototype.hasOwnProperty.call(this.yy,X)&&(F.yy[X]=this.yy[X]);A.setInput(y,F.yy),F.yy.lexer=A,F.yy.parser=this,typeof A.yylloc>"u"&&(A.yylloc={});var Y=A.yylloc;N.push(Y);var ne=A.options&&A.options.ranges;typeof F.yy.parseError=="function"?this.parseError=F.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;function ae(){var ie;return ie=M.pop()||A.lex()||C,typeof ie!="number"&&(ie instanceof Array&&(M=ie,ie=M.pop()),ie=x.symbols_[ie]||ie),ie}for(var xe,be,ge,we,q={},Ge,Te,Pe,Ee;;){if(be=S[S.length-1],this.defaultActions[be]?ge=this.defaultActions[be]:((xe===null||typeof xe>"u")&&(xe=ae()),ge=B[be]&&B[be][xe]),typeof ge>"u"||!ge.length||!ge[0]){var _e="";Ee=[];for(Ge in B[be])this.terminals_[Ge]&&Ge>z&&Ee.push("'"+this.terminals_[Ge]+"'");A.showPosition?_e="Parse error on line "+(O+1)+`:
`+A.showPosition()+`
Expecting `+Ee.join(", ")+", got '"+(this.terminals_[xe]||xe)+"'":_e="Parse error on line "+(O+1)+": Unexpected "+(xe==C?"end of input":"'"+(this.terminals_[xe]||xe)+"'"),this.parseError(_e,{text:A.match,token:this.terminals_[xe]||xe,line:A.yylineno,loc:Y,expected:Ee})}if(ge[0]instanceof Array&&ge.length>1)throw new Error("Parse Error: multiple actions possible at state: "+be+", token: "+xe);switch(ge[0]){case 1:S.push(xe),E.push(A.yytext),N.push(A.yylloc),S.push(ge[1]),xe=null,W=A.yyleng,V=A.yytext,O=A.yylineno,Y=A.yylloc;break;case 2:if(Te=this.productions_[ge[1]][1],q.$=E[E.length-Te],q._$={first_line:N[N.length-(Te||1)].first_line,last_line:N[N.length-1].last_line,first_column:N[N.length-(Te||1)].first_column,last_column:N[N.length-1].last_column},ne&&(q._$.range=[N[N.length-(Te||1)].range[0],N[N.length-1].range[1]]),we=this.performAction.apply(q,[V,W,O,F.yy,ge[1],E,N].concat(T)),typeof we<"u")return we;Te&&(S=S.slice(0,-1*Te*2),E=E.slice(0,-1*Te),N=N.slice(0,-1*Te)),S.push(this.productions_[ge[1]][0]),E.push(q.$),N.push(q._$),Pe=B[S[S.length-2]][S[S.length-1]],S.push(Pe);break;case 3:return!0}}return!0}},_=function(){var g={EOF:1,parseError:function(x,S){if(this.yy.parser)this.yy.parser.parseError(x,S);else throw new Error(x)},setInput:function(x,S){return this.yy=S||this.yy||{},this._input=x,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var x=this._input[0];this.yytext+=x,this.yyleng++,this.offset++,this.match+=x,this.matched+=x;var S=x.match(/(?:\r\n?|\n).*/g);return S?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),x},unput:function(x){var S=x.length,M=x.split(/(?:\r\n?|\n)/g);this._input=x+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-S),this.offset-=S;var E=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),M.length-1&&(this.yylineno-=M.length-1);var N=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:M?(M.length===E.length?this.yylloc.first_column:0)+E[E.length-M.length].length-M[0].length:this.yylloc.first_column-S},this.options.ranges&&(this.yylloc.range=[N[0],N[0]+this.yyleng-S]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){if(this.options.backtrack_lexer)this._backtrack=!0;else return this.parseError("Lexical error on line "+(this.yylineno+1)+`. You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).
`+this.showPosition(),{text:"",token:null,line:this.yylineno});return this},less:function(x){this.unput(this.match.slice(x))},pastInput:function(){var x=this.matched.substr(0,this.matched.length-this.match.length);return(x.length>20?"...":"")+x.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var x=this.match;return x.length<20&&(x+=this._input.substr(0,20-x.length)),(x.substr(0,20)+(x.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var x=this.pastInput(),S=new Array(x.length+1).join("-");return x+this.upcomingInput()+`
`+S+"^"},test_match:function(x,S){var M,E,N;if(this.options.backtrack_lexer&&(N={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(N.yylloc.range=this.yylloc.range.slice(0))),E=x[0].match(/(?:\r\n?|\n).*/g),E&&(this.yylineno+=E.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:E?E[E.length-1].length-E[E.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+x[0].length},this.yytext+=x[0],this.match+=x[0],this.matches=x,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(x[0].length),this.matched+=x[0],M=this.performAction.call(this,this.yy,this,S,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),M)return M;if(this._backtrack){for(var B in N)this[B]=N[B];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var x,S,M,E;this._more||(this.yytext="",this.match="");for(var N=this._currentRules(),B=0;B<N.length;B++)if(M=this._input.match(this.rules[N[B]]),M&&(!S||M[0].length>S[0].length)){if(S=M,E=B,this.options.backtrack_lexer){if(x=this.test_match(M,N[B]),x!==!1)return x;if(this._backtrack){S=!1;continue}else return!1}else if(!this.options.flex)break}return S?(x=this.test_match(S,N[E]),x!==!1?x:!1):this._input===""?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+`. Unrecognized text.
`+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var x=this.next();return x||this.lex()},begin:function(x){this.conditionStack.push(x)},popState:function(){var x=this.conditionStack.length-1;return x>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(x){return x=this.conditionStack.length-1-Math.abs(x||0),x>=0?this.conditionStack[x]:"INITIAL"},pushState:function(x){this.begin(x)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(x,S,M,E){switch(M){case 0:break;case 1:return 20;case 2:return 7;case 3:return 8;case 4:return 9;case 5:return 12;case 6:return 16;case 7:return 14;case 8:return 10;case 9:return 11;case 10:return 19;case 11:return 21;case 12:return"<=";case 13:return">=";case 14:return"<";case 15:return">";case 16:return S.yytext=S.yytext.substr(1,S.yyleng-2),24;case 17:return 13;case 18:return 23;case 19:return 5;case 20:return"INVALID"}},rules:[/^(?:\s+)/i,/^(?:(-?(?:[1-9][0-9]+|[0-9]))\b)/i,/^(?:OR\b)/i,/^(?:AND\b)/i,/^(?:NOT\b)/i,/^(?:((ALL|NONE|HETATM|PROTEIN|BASIC|ACIDIC|CHARGED|POLAR|NONPOLAR|AROMATIC|NUCLEIC|PURINE|PYRIMIDINE|WATER|POLARH|NONPOLARH))\b)/i,/^(?:((NAME|ELEM|TYPE|RESIDUE|ICODE|CHAIN|ALTLOC))\b)/i,/^(?:((SERIAL|SEQUENCE|RESIDX))\b)/i,/^(?:\()/i,/^(?:\))/i,/^(?:,)/i,/^(?::)/i,/^(?:<=)/i,/^(?:>=)/i,/^(?:<)/i,/^(?:>)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:(@[_A-Z0-9]+))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:.)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],inclusive:!0}}};return g}();v.lexer=_;function m(){this.yy={}}return m.prototype=v,v.Parser=m,new m}(),hc={parser:wA};function o_(a){var e=MA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function MA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var EA=function(){function a(e,t){G(this,a),this.min=e,this.max=typeof t>"u"?e:t}return H(a,[{key:"includes",value:function(t){return this.min<=t&&t<=this.max}},{key:"toString",value:function(){var t=this.min,n=this.max;return t===n?String(t):[t,n].join(":")}},{key:"toJSON",value:function(){return[this.min,this.max]}}]),a}(),l_=function(){function a(e){if(G(this,a),e instanceof this.constructor)return e;e instanceof Array?this._values=e.slice(0):e?this._values=[e]:this._values=[]}return H(a,[{key:"append",value:function(t){var n=this._values;return n[n.length]=t,this}},{key:"remove",value:function(t){var n=this._values,r=n.indexOf(t);return r>=0&&n.splice(r,1),this}},{key:"toString",value:function(){return this._values.join(",")}},{key:"toJSON",value:function(){for(var t=this._values,n=[],r=0,i=t.length;r<i;++r){var s=t[r];n[r]=s.toJSON?s.toJSON():s}return n}}]),a}(),c_=function(a){re(t,a);var e=o_(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includes",value:function(r){for(var i=this._values,s=0,o=i.length;s<o;++s)if(i[s].includes(r))return!0;return!1}}]),t}(l_),Fu=[],u_=function(a){re(t,a);var e=o_(t);function t(n,r){var i;G(this,t);var s=i=e.call(this,n);if(r){i.upperOnly=!0;for(var o=s._values,l=0,c=o.length;l<c;++l){var u=o[l];typeof u=="string"&&(o[l]=u.toUpperCase())}}else i.upperOnly=!1;return ue(i,s)}return H(t,[{key:"includes",value:function(r){return this._values.indexOf(r)!==-1}},{key:"toString",value:function(){var r=this._values;Fu.length=0;for(var i=0,s=r.length;i<s;++i)Fu[i]=Se.correctSelectorIdentifier(String(r[i]));return Fu.join(",")}},{key:"_validate",value:function(r){return this.upperOnly&&typeof r=="string"?r.toUpperCase():r}},{key:"append",value:function(r){return xt(D(t.prototype),"append",this).call(this,this._validate(r)),this}},{key:"remove",value:function(r){return xt(D(t.prototype),"remove",this).call(this,this._validate(r)),this}}]),t}(l_);function Eo(a){var e=CA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function CA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Kr=function(){function a(){G(this,a)}return H(a,[{key:"toString",value:function(){return this.keyword}},{key:"toJSON",value:function(){return[this.name]}}]),a}();Kr.prototype.name="Error";Kr.prototype.keyword="error";var f_=function(a){re(t,a);var e=Eo(t);function t(n){var r;return G(this,t),r=e.call(this),r.list=n,r}return H(t,[{key:"toString",value:function(){return"".concat(this.keyword," ").concat(this.list)}},{key:"toJSON",value:function(){return[this.name,this.list.toJSON()]}}]),t}(Kr),Ic=function(a){re(t,a);var e=Eo(t);function t(n){return G(this,t),e.call(this,new c_(n))}return H(t)}(f_),ra=function(a){re(t,a);var e=Eo(t);function t(n,r){return G(this,t),e.call(this,new u_(n,!r))}return H(t)}(f_),kc=function(a){re(t,a);var e=Eo(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return!1}}]),t}(Kr);kc.prototype.name="None";kc.prototype.keyword="none";var Ah=function(a){re(t,a);var e=Eo(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return!0}}]),t}(Kr);Ah.prototype.name="All";Ah.prototype.keyword="all";function h_(a){var e=AA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function AA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var zf=new kc,Th=function(a){re(t,a);var e=h_(t);function t(n){var r;return G(this,t),r=e.call(this),r.rhs=n||zf,r}return H(t,[{key:"toString",value:function(){var r=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(this.keyword," ").concat(r)}},{key:"toJSON",value:function(){return[this.name,this.rhs.toJSON()]}}]),t}(Kr);Th.prototype.priority=1;var Oc=function(a){re(t,a);var e=h_(t);function t(n,r){var i;return G(this,t),i=e.call(this),i.lhs=n||zf,i.rhs=r||zf,i}return H(t,[{key:"toString",value:function(){var r=this.lhs.priority&&this.lhs.priority>this.priority?"(".concat(this.lhs,")"):this.lhs,i=this.rhs.priority&&this.rhs.priority>this.priority?"(".concat(this.rhs,")"):this.rhs;return"".concat(r," ").concat(this.keyword," ").concat(i)}},{key:"toJSON",value:function(){return[this.name,this.lhs.toJSON(),this.rhs.toJSON()]}}]),t}(Kr);Oc.prototype.priority=1e3;function ar(a){var e=TA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function TA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var vo={};function sr(a,e){var t=a.toLowerCase();e.prototype.keyword=t,e.prototype.name=a;var n=function(){for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];return eo(e,s)};return n.SelectorClass=e,vo[t]=n,e}sr("Serial",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.serial)}}]),t}(Ic));sr("Name",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.name)}}]),t}(ra));sr("AltLoc",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(String.fromCharCode(r.location))}}]),t}(ra));sr("Elem",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.element.name)}}]),t}(ra));sr("Residue",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.residue._type._name)}}]),t}(ra));sr("Sequence",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.residue._sequence)}}]),t}(Ic));sr("ICode",function(a){re(t,a);var e=ar(t);function t(n){return G(this,t),e.call(this,n,!0)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.residue._icode)}}]),t}(ra));sr("ResIdx",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.residue._index)}}]),t}(Ic));sr("Chain",function(a){re(t,a);var e=ar(t);function t(n){return G(this,t),e.call(this,n,!0)}return H(t,[{key:"includesAtom",value:function(r){return this.list.includes(r.residue._chain._name)}}]),t}(ra));sr("Hetatm",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return r.het}}]),t}(Kr));sr("PolarH",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return(r.flags&ln.Flags.NONPOLARH)===ln.Flags.HYDROGEN}}]),t}(Kr));sr("NonPolarH",function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return(r.flags&ln.Flags.NONPOLARH)===ln.Flags.NONPOLARH}}]),t}(Kr));sr("All",Ah);sr("None",kc);var d_=vo.none();function Rh(a,e,t){return t.prototype.priority=e,sr(a,t)}Rh("Not",1,function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return!this.rhs.includesAtom(r)}}]),t}(Th));Rh("And",2,function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.lhs.includesAtom(r)&&this.rhs.includesAtom(r)}}]),t}(Oc));Rh("Or",3,function(a){re(t,a);var e=ar(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"includesAtom",value:function(r){return this.lhs.includesAtom(r)||this.rhs.includesAtom(r)}}]),t}(Oc));function fn(a,e){return sr(e,function(t){re(r,t);var n=ar(r);function r(){return G(this,r),n.apply(this,arguments)}return H(r,[{key:"includesAtom",value:function(s){return(s.residue._type.flags&a)!==0}}]),r}(Kr))}fn(Be.Flags.PROTEIN,"Protein");fn(Be.Flags.BASIC,"Basic");fn(Be.Flags.ACIDIC,"Acidic");fn(Be.Flags.BASIC|Be.Flags.ACIDIC,"Charged");fn(Be.Flags.POLAR,"Polar");fn(Be.Flags.NONPOLAR,"NonPolar");fn(Be.Flags.AROMATIC,"Aromatic");fn(Be.Flags.NUCLEIC,"Nucleic");fn(Be.Flags.PURINE,"Purine");fn(Be.Flags.PYRIMIDINE,"Pyrimidine");fn(Be.Flags.WATER,"Water");var Et=Object.create(vo);Et.Selector=Kr;Et.RangeListSelector=Ic;Et.ValueListSelector=ra;Et.Range=EA;Et.RangeList=c_;Et.ValueList=u_;Et.PrefixOperator=Th;Et.InfixOperator=Oc;Et.Context=Object.create({});Et.GetSelector=function(a){if(!Et.Context.hasOwnProperty(a)){var e={message:"selector ".concat(a," is not registered")};throw e}return Et.Context[a]||d_};Et.ClearContext=function(){Object.keys(Et.Context).forEach(function(a){delete Et.Context[a]})};Et.keyword=function(a){return vo[a.toLowerCase()]||vo.none};Et.parse=function(a){var e={};try{e.selector=hc.parser.parse(a)}catch(t){e.selector=d_,e.error=t.message}return e};hc.parser.yy=Et;hc.parser.yy.parseError=hc.parser.parseError;var p_=function(){function a(e){G(this,a),this._complex=e,this._selector=Et.keyword("All")(),this._boundaries={boundingBox:new Vt,boundingSphere:new Lr}}return H(a,[{key:"computeBoundaries",value:function(){var t=this._complex._atoms,n=t.length,r=this._selector,i=this._boundaries.boundingBox;if(i.makeEmpty(),n===1){i.expandByPoint(t[0].position);var s=new b;i.getCenter(s);var o=2*t[0].element.radius;i.setFromCenterAndSize(s,new b(o,o,o))}else for(var l=0;l<n;++l)r.includesAtom(t[l])&&i.expandByPoint(t[l].position);var c=0,u=new b;if(i.getCenter(u),n===1)this._boundaries.boundingSphere.set(u,t[0].element.radius);else{for(var f=0;f<n;++f)if(r.includesAtom(t[f])){var h=t[f].position,d=u.distanceToSquared(h);c<d&&(c=d)}this._boundaries.boundingSphere.set(u,Math.sqrt(c))}}},{key:"getTransforms",value:function(){return[]}},{key:"getSelector",value:function(){return this._selector}},{key:"getBoundaries",value:function(){return this._boundaries}},{key:"finalize",value:function(){}}]),a}();function RA(a){var e=LA();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function LA(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Lh=function(a){re(t,a);var e=RA(t);function t(n){var r;return G(this,t),r=e.call(this,n),r.chains=[],r.matrices=[],r}return H(t,[{key:"computeBoundaries",value:function(){xt(D(t.prototype),"computeBoundaries",this).call(this);var r=this.matrices,i=this._boundaries.boundingSphere.center,s=this._boundaries.boundingSphere.radius,o=this._boundaries.boundingBox=new Vt;o.makeEmpty();for(var l=0,c=r.length;l<c;++l)o.expandByPoint(i.clone().applyMatrix4(r[l]));var u=o.max.distanceTo(o.min)/2+s,f=new b;o.getCenter(f),this._boundaries.boundingSphere=new Lr().set(f,u),o.max.addScalar(s),o.min.subScalar(s)}},{key:"addChain",value:function(r){this.chains[this.chains.length]=r}},{key:"addMatrix",value:function(r){this.matrices[this.matrices.length]=r}},{key:"getTransforms",value:function(){return this.matrices}},{key:"finalize",value:function(){this.chains.length>0?this._selector=Et.keyword("Chain")(this.chains):this._selector=Et.keyword("None")()}}]),t}(p_),um=function(){function a(e){G(this,a),this._complex=e,this._index=-1,this._residueIndices=[],this._cycles=[],this._subDivs=[],this._residueCount=0}return H(a,[{key:"getResidues",value:function(){return this._complex._residues}},{key:"getResidueCount",value:function(){return this._residueCount}},{key:"forEachResidue",value:function(t){for(var n=this._complex._residues,r=this._residueIndices,i=0,s=r.length;i<s;++i)for(var o=r[i].start,l=r[i].end;o<=l;++o)t(n[o])}},{key:"setSubDivs",value:function(t){this._subDivs=t;for(var n=0,r=[],i=0,s=0,o=t.length;s<o;++s)if(s===o-1||t[s].end+1!==t[s+1].start){var l=t[n].start,c=t[s].end;r[r.length]={start:l,end:c},i+=c-l+1,n=s+1}this._residueIndices=r,this._residueCount=i}},{key:"getComplex",value:function(){return this._complex}},{key:"forEachBond",value:function(t){for(var n=this._complex._bonds,r=0,i=n.length;r<i;++r){var s=n[r];s._left.residue._component===this&&t(s)}}},{key:"update",value:function(){this.forEachCycle(function(t){t.update()})}},{key:"forEachAtom",value:function(t){this.forEachResidue(function(n){n.forEachAtom(t)})}},{key:"addCycle",value:function(t){this._cycles.push(t)}},{key:"forEachCycle",value:function(t){for(var n=this._cycles,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"markResidues",value:function(){var t=this;t.forEachResidue(function(n){n._component=t})}},{key:"_forEachSubChain",value:function(t,n){for(var r=this._complex._residues,i=this._subDivs,s=0,o=i.length;s<o;++s)for(var l=i[s].start,c=i[s].end;l<=c;++l){var u=r[l];if(t&u._mask&&u._isValid){for(var f=l+1;f<=c;++f){var h=r[f];if(!(t&h._mask&&h._isValid))break}n(s,l,f-1),l=f}}}},{key:"getMaskedSequences",value:function(t){var n=[],r=0;return this._forEachSubChain(t,function(i,s,o){n[r++]={start:s,end:o}}),n}},{key:"getMaskedSubdivSequences",value:function(t){var n=[],r=-1,i=-1,s=this._subDivs;return this._forEachSubChain(t,function(o,l,c){i!==o&&(++r,n[r]={arr:[],boundaries:s[o]},i=o),n[r].arr[n[r].arr.length]={start:l,end:c}}),n}}]),a}(),Bs=32,Bu=1024*1024,zu=4,PA=14,Vu=-1,NA=89237,m_=function(){function a(e){G(this,a),this.numPairs=0,this.numMaxPairs=e,this.intBuffer=Se.allocateTyped(Int32Array,e*zu);for(var t=0;t<e*zu;t++)this.intBuffer[t]=Vu;this.hashBuffer=Se.allocateTyped(Int32Array,Bu*Bs);for(var n=0;n<Bu*Bs;n++)this.hashBuffer[n]=Vu}return H(a,[{key:"destroy",value:function(){this.intBuffer=null,this.hashBuffer=null}},{key:"addPair",value:function(t,n){for(var r=t<n?t:n,i=t>n?t:n,s=r+(i<<PA),o=r+i*NA&Bu-1,l=o*Bs,c=0;c<Bs;c++){var u=this.hashBuffer[l+c];if(u===Vu)break;if(u===s)return!1}if(c>=Bs)throw new Error("addPair: increase cMaxPairsForHashCode");if(this.hashBuffer[l+c]=s,this.numPairs>=this.numMaxPairs)throw new Error("addPair: increase num pairs");return l=this.numPairs*zu,this.intBuffer[l]=r,this.intBuffer[l+1]=i,this.intBuffer[l+2]=s,this.numPairs++,!0}}]),a}(),IA=4,fm=32,hm=.45,kA=.001;function dm(a){var e=a.element;if(e)return e.radiusBonding;throw new Error("_getBondingRadius: Logic error.")}function OA(a){return!a.isHet()||a.bonds&&a.bonds.length===0}var DA=function(){function a(e){G(this,a),this._complex=e,this._maxRad=1.8;var t=this._complex.getDefaultBoundaries().boundingBox;this._vBoxMin=t.min.clone(),this._vBoxMax=t.max.clone(),this._pairCollection=null}return H(a,[{key:"_addExistingPairs",value:function(){for(var t=this._complex.getAtoms(),n=t.length,r=0,i=this._pairCollection;r<n;r++)for(var s=t[r].bonds,o=s.length,l=0;l<o;l++){var c=s[l],u=c._left.index;u===r&&i.addPair(r,c._right.index)}return 0}},{key:"_findPairs",value:function(){var t=this._complex.getVoxelWorld();if(t!==null)for(var n=this._complex._atoms,r=n.length,i=this,s,o,l,c,u,f=function(p){if(!(o&&p.isHydrogen())){var v=p.location;if(!(c!==fm&&v!==fm&&c!==v)){var _=l.distanceToSquared(p.position),m=p.element.radiusBonding,g=s+m+hm;_>g*g||_<kA||i._pairCollection.addPair(u.index,p.index)}}},h=0;h<r;++h)u=n[h],OA(u)&&(s=u.element.radiusBonding,o=u.isHydrogen(),l=u.position,c=u.location,t.forEachAtomWithinRadius(l,2*this._maxRad+hm,f))}},{key:"_addPairs",value:function(){for(var t=this._complex._atoms,n=0,r=0;n<this._pairCollection.numPairs;n++,r+=4){var i=this._pairCollection.intBuffer[r],s=this._pairCollection.intBuffer[r+1];this._addPair(t[i],t[s])}}},{key:"_addPair",value:function(t,n){for(var r=t.bonds,i=t.index,s=n.index,o=0,l=r.length;o<l;++o){var c=r[o];if(c._left.index===s||c._right.index===s)return}var u=i<s?t:n,f=i<s?n:t,h=this._complex.addBond(u,f,0,ta.BondType.UNKNOWN,!1);r.push(h),n.bonds.push(h)}},{key:"build",value:function(){this._buildInner()}},{key:"_buildInner",value:function(){var t=this._complex._atoms;if(!(t.length<2)){if(t[0].index<0)throw new Error("AutoBond: Atoms in complex were not indexed.");this._calcBoundingBox(),this._pairCollection=new m_(t.length*IA),this._addExistingPairs(),this._findPairs(),this._addPairs()}}},{key:"_calcBoundingBox",value:function(){for(var t=this._complex._atoms,n=t.length,r=dm(t[0]),i=1;i<n;++i)r=Math.max(r,dm(t[i]));this._vBoxMax.addScalar(r),this._vBoxMin.addScalar(-r),this._maxRad=r*1.2}},{key:"destroy",value:function(){this._pairCollection&&this._pairCollection.destroy()}}]),a}(),FA=.1,Ph=ta.BondType.AROMATIC,pm=[fe.ByName.C.number,fe.ByName.N.number],BA=function(){var a=new b,e=new b,t=new b;return function(n,r){return a.copy(n).normalize(),e.copy(r).normalize(),t.crossVectors(a,e),t.length()>FA?!1:a.dot(e)>=0}}();function mm(a,e){for(var t=0;t<a.length&&a[t]<e;)++t;a.splice(t,0,e)}function vm(a,e){return a._left===e?a._right:a._left}function zA(a,e){var t=a.dot(e)/Math.sqrt(a.lengthSq()*e.lengthSq());return Vn.clamp(t,-1,1)}function VA(a){a._type=Ph}var UA=function(){function a(e){G(this,a),this.atoms=e,this.update()}return H(a,[{key:"update",value:function(){for(var t=this.atoms,n=new b,r=t.length,i=0;i<r;++i)n.add(t[i].position);n.multiplyScalar(1/r),this.center=n,this.radius=n.distanceTo(t[0].position.clone().lerp(t[1].position,.5))}},{key:"forEachBond",value:function(t){var n=this.atoms,r=n.length,i=n[0],s;function o(c){(c._left===s||c._right===s)&&t(c)}for(var l=0;l<r;++l)s=n[(l+1)%r],i.forEachBond(o),i=s}}]),a}();function gm(a){return a._type===Ph}function GA(a){if(a.type===Ph)return!0;var e=pm.indexOf(a._right.element.number),t=pm.indexOf(a._left.element.number);return e!==-1&&t!==-1}function HA(a){return a.length>3}function WA(a){return console.assert(a.length>2),!0}var XA=function(){function a(e){G(this,a),this._complex=e;for(var t=new Array(e._bonds.length),n=new Array(e._bonds.length),r=0,i=t.length;r<i;++r)t[r]=[],n[r]=!1;this._bondsData=t,this._bondMarks=n,this._resetCycles()}return H(a,[{key:"_resetCycles",value:function(){this._cycles=[],this._currIdx=-1}},{key:"_haveSameCycle",value:function(t,n,r){for(var i=t[n._index],s=t[r._index],o=i.length,l=s.length,c=0,u=0;c<o&&u<l;){if(i[c]===s[u])return!0;i[c]>s[u]?++u:++c}return!1}},{key:"_tryBond",value:function(t,n,r){var i=[],s=this._bondsData,o=vm(t,n),l=n.position.clone().sub(o.position),c=this._currStart,u=this,f=this._bondMarks,h=this._checkBond;f[t._index]=!0,h=h===void 0?gm:h,n.forEachBond(function(m){if(!(!h(m)||m===t||f[m._index]||u._haveSameCycle(s,t,m))){var g=vm(m,n),y=g.position.clone().sub(n.position),x=g===c?-2:1-zA(l,y),S=y.cross(l);if(BA(S,r)){for(var M=0;M<i.length&&i[M].val<x;)++M;i.splice(M,0,{bond:m,val:x,dir:S})}}});for(var d=0,p=i.length;d<p;++d){var v=i[d].bond,_=v._left===n?v._right:v._left;if(_===c)return++this._currIdx,this._cycles.push([n]),f[t._index]=!1,!0;if(this._tryBond(v,_,i[d].dir))return mm(s[v._index],this._currIdx),this._cycles[this._currIdx].push(n),f[t._index]=!1,!0}return f[t._index]=!1,!1}},{key:"_startCycle",value:function(t){this._currStart=t._left,this._tryBond(t,t._right,new b)&&(mm(this._bondsData[t._index],this._currIdx),this._cycles[this._currIdx].push(t._left))}},{key:"_findLoops",value:function(t,n){this._checkBond=t;var r=this._complex,i=this;r.forEachComponent(function(s){i._resetCycles(),s.forEachBond(function(h){t(h)&&i._startCycle(h)});for(var o=i._cycles,l=0,c=o.length;l<c;++l){var u=o[l];if(n(u)){var f=new UA(u);f.forEachBond(VA),s.addCycle(f)}}})}},{key:"markCycles",value:function(){this._findLoops(gm,HA)}},{key:"detectCycles",value:function(){this._findLoops(GA,WA)}}]),a}();function jA(a,e,t,n){var r=t-a.z,i=n-a.z,s=Math.sqrt(Math.max(e*e-r*r,0)),o=Math.sqrt(Math.max(e*e-i*i,0)),l=Math.min(s,o),c;return t<=a.z&&n>=a.z?c=e:c=Math.max(s,o),[l,c]}function YA(a,e,t,n){var r=t-a.y,i=n-a.y,s=Math.sqrt(Math.max(e*e-r*r,0)),o=Math.sqrt(Math.max(e*e-i*i,0)),l=Math.min(s,o),c;return t<=a.y&&n>=a.y?c=e:c=Math.max(s,o),[l,c]}var Ti=function(){function a(e,t){G(this,a),this._box=e.clone();var n=new b;e.getSize(n),this._count=n.clone().divide(t).floor().max(new b(1,1,1)),this._last=this._count.clone().subScalar(1),this._cellSize=n.clone().divide(this._count),this._cellInnerR=.5*Math.min(Math.min(this._cellSize.x,this._cellSize.y),this._cellSize.z),this._cellOuterR=.5*Math.sqrt(this._cellSize.dot(this._cellSize));var r=this._count.x*this._count.y*this._count.z;this._voxels=Se.allocateTyped(Int32Array,r);for(var i=0;i<r;++i)this._voxels[i]=-1;this._atoms=[]}return H(a,[{key:"addAtoms",value:function(t){var n=this,r=this._atoms.length;this._atoms.length+=2*t.getAtomCount(),t.forEachAtom(function(i){var s=n._findVoxel(i.position);n._atoms[r]=i,n._atoms[r+1]=n._voxels[s],n._voxels[s]=r,r+=2})}},{key:"_findVoxel",value:function(t){var n=a._zero,r=a._voxel;return r.copy(t).sub(this._box.min).divide(this._cellSize).floor().clamp(n,this._last),r.x+this._count.x*(r.y+this._count.y*r.z)}},{key:"_forEachAtomInVoxel",value:function(t,n){for(var r=this._voxels[t];r>=0;r=this._atoms[r+1])n(this._atoms[r])}},{key:"_forEachVoxelWithinRadius",value:function(t,n,r){var i=a._xRange,s=a._yRange,o=a._zRange;if(n/this._cellInnerR<10){this._forEachVoxelWithinRadiusSimple(t,n,r);return}var l,c,u,f,h,d,p,v;o.set(t.z-n,t.z+n),o.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor().clampScalar(0,this._count.z-1);for(var _=o.x;_<=o.y;++_){h=[this._box.min.z+_*this._cellSize.z,this._box.min.z+(_+1)*this._cellSize.z],v=t.z-n<=h[0]&&h[1]<=t.z+n,l=jA(t,n,h[0],h[1]),s.set(t.y-l[1],t.y+l[1]),s.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor().clampScalar(0,this._count.y-1);for(var m=s.x;m<=s.y;++m){f=[this._box.min.y+m*this._cellSize.y,this._box.min.y+(m+1)*this._cellSize.y],p=t.y-l[0]<=f[0]&&f[1]<=t.y+l[0],c=YA(t,l[1],f[0],f[1]),i.set(t.x-c[1],t.x+c[1]),i.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor().clampScalar(0,this._count.x-1);for(var g=i.x;g<=i.y;++g)u=[this._box.min.x+g*this._cellSize.x,this._box.min.x+(g+1)*this._cellSize.x],d=t.x-c[0]<=u[0]&&u[1]<=t.x+c[0],r(g+this._count.x*(m+this._count.y*_),d&&p&&v)}}}},{key:"_forEachVoxelWithinRadiusSimple",value:function(t,n,r){var i=a._xRange,s=a._yRange,o=a._zRange,l=a._vCenter,c=(n+this._cellOuterR)*(n+this._cellOuterR),u=-1;n>this._cellOuterR&&(u=(n-this._cellOuterR)*(n-this._cellOuterR)),i.set(t.x-n,t.x+n),i.subScalar(this._box.min.x).divideScalar(this._cellSize.x).floor(),i.x=Math.min(Math.max(i.x,0),this._count.x-1),i.y=Math.min(Math.max(i.y,0),this._count.x-1),s.set(t.y-n,t.y+n),s.subScalar(this._box.min.y).divideScalar(this._cellSize.y).floor(),s.x=Math.min(Math.max(s.x,0),this._count.y-1),s.y=Math.min(Math.max(s.y,0),this._count.y-1),o.set(t.z-n,t.z+n),o.subScalar(this._box.min.z).divideScalar(this._cellSize.z).floor(),o.x=Math.min(Math.max(o.x,0),this._count.z-1),o.y=Math.min(Math.max(o.y,0),this._count.z-1);for(var f=o.x;f<=o.y;++f){var h=[this._box.min.z+f*this._cellSize.z,this._box.min.z+(f+1)*this._cellSize.z];l.z=.5*(h[0]+h[1]);for(var d=s.x;d<=s.y;++d){var p=[this._box.min.y+d*this._cellSize.y,this._box.min.y+(d+1)*this._cellSize.y];l.y=.5*(p[0]+p[1]);for(var v=i.x;v<=i.y;++v){var _=[this._box.min.x+v*this._cellSize.x,this._box.min.x+(v+1)*this._cellSize.x];l.x=.5*(_[0]+_[1]);var m=t.distanceToSquared(l);m<=c&&r(v+this._count.x*(d+this._count.y*f),m<=u)}}}}},{key:"forEachAtomWithinRadius",value:function(t,n,r){var i=this,s=n*n;i._forEachVoxelWithinRadius(t,n,function(o,l){l?i._forEachAtomInVoxel(o,r):i._forEachAtomInVoxel(o,function(c){t.distanceToSquared(c.position)<=s&&r(c)})})}},{key:"forEachAtomWithinDistFromMasked",value:function(t,n,r,i){this._forEachAtomWithinDistFromGroup(function(s){t.forEachAtom(function(o){o.mask&n&&s(o)})},r,i)}},{key:"forEachAtomWithinDistFromSelected",value:function(t,n,r,i){this._forEachAtomWithinDistFromGroup(function(s){t.forEachAtom(function(o){n.includesAtom(o)&&s(o)})},r,i)}},{key:"_forEachAtomWithinDistFromGroup",value:function(t,n,r){var i=this,s=n*n,o=[],l=[],c=0;t(function(h){i._forEachVoxelWithinRadius(h.position,n,function(d,p){p?o[d]=-1:typeof o[d]>"u"?(l.push(h),l.push(-1),o[d]=c,c+=2):o[d]!==-1&&(l.push(h),l.push(o[d]),o[d]=c,c+=2)})});var u,f=function(d){if(!(typeof o[u]>"u")){if(c=o[u],c===-1){r(d);return}for(;c>=0;c=l[c+1])if(d.position.distanceToSquared(l[c].position)<s){r(d);break}}};for(u in o)o.hasOwnProperty(u)&&i._forEachAtomInVoxel(u,f)}}]),a}();Le(Ti,"_zero",new b(0,0,0));Le(Ti,"_voxel",new b);Le(Ti,"_xRange",new ve);Le(Ti,"_yRange",new ve);Le(Ti,"_zRange",new ve);Le(Ti,"_vCenter",new b);var Tl=.5,Uu=-9.9,_m=-.5,Rl=-27.888,qA=5,$A=1e3,ZA=function(){function a(e){G(this,a),this._complex=e,this._hbonds=[],this._complex._residues.length>$A?this._buildVW():this._build()}return H(a,[{key:"isBond",value:function(t,n){if(this._hbonds[t]){var r=Lt(this._hbonds[t].acceptor,2),i=r[0],s=r[1];if(i&&i.residue===n&&i.energy<_m||s&&s.residue===n&&s.energy<_m)return!0}return!1}},{key:"_build",value:function(){for(var t=this,n=0;n<this._complex._residues.length-1;++n){var r=this._complex._residues[n];if(r.getType().flags&Be.Flags.PROTEIN){var i=null;n>0&&this._complex._residues[n-1].getType().flags&Be.Flags.PROTEIN&&r._sequence===this._complex._residues[n-1]._sequence+1&&(i=this._complex._residues[n-1]);for(var s=n+1;s<this._complex._residues.length;++s){var o=this._complex._residues[s];if(o.getType().flags&Be.Flags.PROTEIN){var l=null;this._complex._residues[s-1].getType().flags&Be.Flags.PROTEIN&&o._sequence===this._complex._residues[s-1]._sequence+1&&(l=this._complex._residues[s-1]),t._calcHBondEnergy(i,r,o),s!==n+1&&t._calcHBondEnergy(l,o,r)}}}}}},{key:"_buildVW",value:function(){var t=this,n=this._complex._residues,r,i,s=this._complex.getVoxelWorld();if(s===null)return;var o=new m_(this._complex._residues.length*this._complex._residues.length/2);function l(u){var f=u.residue;if(f._index!==r._index&&f.getType().flags&Be.Flags.PROTEIN&&o.addPair(r._index,f._index)){var h=f._index>0?n[f._index-1]:null;h&&(!(h.getType().flags&Be.Flags.PROTEIN)||f._sequence!==h._sequence+1)&&(h=null),t._calcHBondEnergy(i,r,f),f._index!==r._index+1&&t._calcHBondEnergy(h,f,r)}}for(var c=0;c<n.length-1;++c)r=n[c],r.getType().flags&Be.Flags.PROTEIN&&(i=c>0?n[c-1]:null,i&&(!(i.getType().flags&Be.Flags.PROTEIN)||r._sequence!==i._sequence+1)&&(i=null),s.forEachAtomWithinRadius(this._residueGetCAlpha(r),qA,l))}},{key:"_residueGetCAlpha",value:function(t){for(var n=0;n<t._atoms.length;++n){var r=t._atoms[n].name;if(r==="CA"||r==="C1")return t._atoms[n].position}return null}},{key:"_residueGetCO",value:function(t){var n=null,r=null;return t.forEachAtom(function(i){i.name==="C"?n=i.position:i.name==="O"&&(r=i.position)}),[n,r]}},{key:"_residueGetNH",value:function(t,n){var r=this._residueGetCO(t),i=Lt(r,2),s=i[0],o=i[1],l;if(n.forEachAtom(function(u){u.name==="N"&&(l=u.position)}),s&&o&&l){var c=s.clone();return c.sub(o),c.multiplyScalar(1/c.length()),c.add(l),[l,c]}return[null,null]}},{key:"_calcHBondEnergy",value:function(t,n,r){var i=0;if(t===null)return i;if(n.getType().getName()!=="PRO"){var s=this._residueGetNH(t,n),o=Lt(s,2),l=o[0],c=o[1],u=this._residueGetCO(r),f=Lt(u,2),h=f[0],d=f[1];if(l===null||c===null||h===null||d===null)return i;var p=c.distanceTo(d),v=c.distanceTo(h),_=l.distanceTo(h),m=l.distanceTo(d);p<Tl||v<Tl||_<Tl||m<Tl?i=Uu:i=Rl/p-Rl/v+Rl/_-Rl/m,i=Math.round(i*1e3)/1e3,i<Uu&&(i=Uu)}typeof this._hbonds[n._index]>"u"&&(this._hbonds[n._index]={donor:[],acceptor:[]});var g=this._hbonds[n._index];g.acceptor.length<2&&g.acceptor.push({residue:r._index,energy:i}),g.acceptor.length>1&&(i<g.acceptor[0].energy?(g.acceptor[1].residue=g.acceptor[0].residue,g.acceptor[1].energy=g.acceptor[0].energy,g.acceptor[0].residue=r._index,g.acceptor[0].energy=i):i<g.acceptor[1].energy&&(g.acceptor[1].residue=r._index,g.acceptor[1].energy=i)),typeof this._hbonds[r._index]>"u"&&(this._hbonds[r._index]={donor:[],acceptor:[]});var y=this._hbonds[r._index];return y.donor.length<2&&y.donor.push({residue:n._index,energy:i}),y.donor.length>1&&(i<y.donor[0].energy?(y.donor[1].residue=y.donor[0].residue,y.donor[1].energy=y.donor[0].energy,y.donor[0].residue=n._index,y.donor[0].energy=i):i<y.donor[1].energy&&(y.donor[1].residue=n._index,y.donor[1].energy=i)),i}}]),a}();function Oi(a,e){var t=typeof Symbol<"u"&&a[Symbol.iterator]||a["@@iterator"];if(!t){if(Array.isArray(a)||(t=KA(a))||e){t&&(a=t);var n=0,r=function(){};return{s:r,n:function(){return n>=a.length?{done:!0}:{done:!1,value:a[n++]}},e:function(c){throw c},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,s=!1,o;return{s:function(){t=t.call(a)},n:function(){var c=t.next();return i=c.done,c},e:function(c){s=!0,o=c},f:function(){try{!i&&t.return!=null&&t.return()}finally{if(s)throw o}}}}function KA(a,e){if(a){if(typeof a=="string")return ym(a,e);var t=Object.prototype.toString.call(a).slice(8,-1);if(t==="Object"&&a.constructor&&(t=a.constructor.name),t==="Map"||t==="Set")return Array.from(a);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return ym(a,e)}}function ym(a,e){(e==null||e>a.length)&&(e=a.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=a[t];return n}var Nn=Object.freeze({NO_BRIDGE:0,PARALLEL:1,ANTI_PARALLEL:2}),Di=Object.freeze({START:1,MIDDLE:2,END:3,START_AND_END:4}),Dr=Object.freeze({STRAND:"E",BRIDGE:"B",HELIX_310:"G",HELIX_ALPHA:"H",HELIX_PI:"I",TURN:"T",BEND:"S",LOOP:" "}),Nh=function(){function a(e){G(this,a),this._complex=e,this._build()}return H(a,[{key:"_build",value:function(){var t=this;this._hbonds=new ZA(this._complex),this._ss=[],this._sheet=[],this._betaPartners=[],this._bend=[];for(var n=0;n<this._complex.getResidues().length;++n)this._betaPartners[n]=[];this._helixFlags=[],this._helixFlags[3]=[],this._helixFlags[4]=[],this._helixFlags[5]=[],this._chainLengths=[];for(var r=0;r<this._complex._chains.length;++r){for(var i=this._complex._chains[r].getResidues(),s=0;s<i.length&&i[s].getType().flags&Be.Flags.PROTEIN;++s);this._chainLengths[r]=s}this._buildBetaSheets();for(var o=0;o<this._complex._chains.length;++o)t._buildAlphaHelices(this._complex._chains[o].getResidues(),this._chainLengths[o],!1)}},{key:"_buildAlphaHelices",value:function(t,n,r){for(var i=3;i<=5&&!(t.length<i);++i)for(var s=0;s+i<n;++s)if(this._hbonds.isBond(t[s+i]._index,t[s]._index)){this._helixFlags[i][t[s+i]._index]=Di.END;for(var o=s+1;o<s+i;++o)typeof this._helixFlags[i][t[o]._index]>"u"&&(this._helixFlags[i][t[o]._index]=Di.MIDDLE);this._helixFlags[i][t[s]._index]===Di.END?this._helixFlags[i][t[s]._index]=Di.START_AND_END:this._helixFlags[i][t[s]._index]=Di.START}for(var l=2;l<n-2;++l){var c=this._kappa(t[l-2],t[l],t[l+2]);this._bend[t[l]._index]=c!==360&&c>70}for(var u=1;u+4<n;++u)if(this._isHelixStart(t[u]._index,4)&&this._isHelixStart(t[u-1]._index,4))for(var f=u;f<=u+3;++f)this._ss[t[f]._index]=Dr.HELIX_ALPHA;for(var h=1;h+3<n;++h)if(this._isHelixStart(t[h]._index,3)&&this._isHelixStart(t[h-1]._index,3)){for(var d=!0,p=h;d&&p<=h+2;++p)d=typeof this._ss[t[p]._index]>"u"||this._ss[t[p]._index]===Dr.HELIX_310;if(d)for(var v=h;v<=h+2;++v)this._ss[t[v]._index]=Dr.HELIX_310}for(var _=1;_+5<n;++_)if(this._isHelixStart(t[_]._index,5)&&this._isHelixStart(t[_-1]._index,5)){for(var m=!0,g=_;m&&g<=_+4;++g)m=typeof this._ss[t[g]._index]>"u"||this._ss[t[g]._index]===Dr.HELIX_PI||r&&this._ss[t[g]._index]===Dr.HELIX_ALPHA;if(m)for(var y=_;y<=_+4;++y)this._ss[t[y]._index]=Dr.HELIX_PI}for(var x=1;x+1<n;++x)if(typeof this._ss[t[x]._index]>"u"){for(var S=!1,M=3;M<=5&&!S;++M)for(var E=1;E<M&&!S;++E)S=x>=E&&this._isHelixStart(t[x-E]._index,M);S?this._ss[t[x]._index]=Dr.TURN:this._bend[t[x]._index]&&(this._ss[t[x]._index]=Dr.BEND)}}},{key:"_residueGetCAlpha",value:function(t){for(var n=0;n<t._atoms.length;++n){var r=t._atoms[n].name;if(r==="CA"||r==="C1")return t._atoms[n].position}return null}},{key:"_cosinusAngle",value:function(t,n,r,i){var s=t.clone().sub(n),o=r.clone().sub(i),l=0,c=s.dot(s)*o.dot(o);return c>0&&(l=s.dot(o)/Math.sqrt(c)),l}},{key:"_kappa",value:function(t,n,r){var i=this._residueGetCAlpha(n),s=this._residueGetCAlpha(t),o=this._residueGetCAlpha(r);if(i===null||s===null||o===null)return 180;var l=this._cosinusAngle(i,s,o,i),c=Math.sqrt(1-l*l);return Math.atan2(c,l)*180/Math.PI}},{key:"_isHelixStart",value:function(t,n){return this._helixFlags[n][t]===Di.START||this._helixFlags[n][t]===Di.START_AND_END}},{key:"_buildBetaSheets",value:function(){for(var t=[],n=0;n<this._complex._chains.length;++n){var r=this._chainLengths[n];if(!(r<=4))for(var i=this._complex._chains[n].getResidues(),s=n;s<this._complex._chains.length;++s){var o=this._chainLengths[s];if(!(o<=4))for(var l=this._complex._chains[s].getResidues(),c=1;c+1<r;++c){var u=i[c],f=1;for(s===n&&(f=c+3);f+1<o;++f){var h=l[f],d=this._testBridge(i,c,l,f);if(d!==Nn.NO_BRIDGE){var p=!1,v=Oi(t),_;try{for(v.s();!(_=v.n()).done;){var m=_.value;if(!(d!==m.type||u._index!==m.i[m.i.length-1]+1)){if(d===Nn.PARALLEL&&m.j[m.j.length-1]+1===h._index){m.i.push(u._index),m.j.push(h._index),p=!0;break}if(d===Nn.ANTI_PARALLEL&&m.j[0]-1===h._index){m.i.push(u._index),m.j.unshift(h._index),p=!0;break}}}}catch(ke){v.e(ke)}finally{v.f()}p||t.push({type:d,i:[u._index],chainI:u.getChain()._index,j:[h._index],chainJ:h.getChain()._index})}}}}}t.sort(function(ke,De){return ke.chainI<De.chainI||ke.chainI===De.chainI&&ke.i[0]<De.i[0]?-1:1});for(var g=0;g<t.length;++g)for(var y=g+1;y<t.length;++y){var x=t[g].i[0],S=t[g].i[t[g].i.length-1],M=t[g].j[0],E=t[g].j[t[g].j.length-1],N=t[y].i[0],B=t[y].i[t[y].i.length-1],V=t[y].j[0],O=t[y].j[t[y].j.length-1];if(!(t[g].type!==t[y].type||this._hasChainBreak(Math.min(x,N),Math.max(S,B))||this._hasChainBreak(Math.min(M,V),Math.max(E,O))||N-S>=6||S>=N&&x<=B)){var W=!1;t[g].type===Nn.PARALLEL?W=V-E<6&&N-S<3||V-E<3:W=M-O<6&&N-S<3||M-O<3,W&&(t[g].i=t[g].i.concat(t[y].i),t[g].type===Nn.PARALLEL?t[g].j=t[g].j.concat(t[y].j):t[g].j=t[y].j.concat(t[g].j),t.splice(y--,1))}}for(var z=new Set,C=0;C<t.length;++C)z.add(t[C]);for(var T=1,A=0;z.size>0;){var F=z.values().next().value;z.delete(F);var X=new Set;X.add(F);var Y=void 0;do{Y=new Set;var ne=Oi(X.values()),ae;try{for(ne.s();!(ae=ne.n()).done;){var xe=ae.value,be=Oi(z.values()),ge;try{for(be.s();!(ge=be.n()).done;){var we=ge.value;this._areBridgesLinked(xe,we)&&Y.add(we)}}catch(ke){be.e(ke)}finally{be.f()}}}catch(ke){ne.e(ke)}finally{ne.f()}var q=Oi(Y.values()),Ge;try{for(q.s();!(Ge=q.n()).done;)F=Ge.value,X.add(F),z.delete(F)}catch(ke){q.e(ke)}finally{q.f()}}while(Y.size>0);var Te=Oi(X.values()),Pe;try{for(Te.s();!(Pe=Te.n()).done;)F=Pe.value,F.ladder=A,F.sheet=T,F.link=X,++A}catch(ke){Te.e(ke)}finally{Te.f()}++T}for(var Ee=0;Ee<t.length;++Ee){for(var _e=t[Ee],ie=0,oe=0,K=0;K<_e.i.length;++K)if(this._betaPartners[_e.i[K]][0]){ie=1;break}for(var de=0;de<_e.j.length;++de)if(this._betaPartners[_e.j[de]][0]){oe=1;break}var he=Dr.BRIDGE;if(_e.i.length>1&&(he=Dr.STRAND),_e.type===Nn.PARALLEL){for(var I=0,P=0;P<_e.i.length;++P)this._betaPartners[_e.i[P]][ie]={residue:_e.j[I++],ladder:_e.ladder,parallel:!0};I=0;for(var ee=0;ee<_e.j.length;++ee)this._betaPartners[_e.j[ee]][oe]={residue:_e.i[I++],ladder:_e.ladder,parallel:!0}}else{for(var pe=_e.j.length-1,Me=0;Me<_e.i.length;++Me)this._betaPartners[_e.i[Me]][ie]={residue:_e.j[pe--],ladder:_e.ladder,parallel:!1};pe=_e.i.length-1;for(var Re=0;Re<_e.j.length;++Re)this._betaPartners[_e.j[Re]][oe]={residue:_e.i[pe--],ladder:_e.ladder,parallel:!1}}for(var He=_e.i[0];He<=_e.i[_e.i.length-1];++He)this._ss[He]!==Dr.STRAND&&(this._ss[He]=he,this._sheet[He]=_e.sheet);for(var Oe=_e.j[0];Oe<=_e.j[_e.j.length-1];++Oe)this._ss[Oe]!==Dr.STRAND&&(this._ss[Oe]=he,this._sheet[Oe]=_e.sheet)}}},{key:"_testBridge",value:function(t,n,r,i){var s=Nn.NO_BRIDGE,o=t[n-1]._index,l=t[n]._index,c=t[n+1]._index,u=r[i-1]._index,f=r[i]._index,h=r[i+1]._index,d=this._hbonds.isBond.bind(this._hbonds);return d(c,f)&&d(f,o)||d(h,l)&&d(l,u)?s=Nn.PARALLEL:(d(c,u)&&d(h,o)||d(f,l)&&d(l,f))&&(s=Nn.ANTI_PARALLEL),s}},{key:"_areBridgesLinked",value:function(t,n){var r=new Set(t.i),i=new Set(t.j),s=Oi(n.i),o;try{for(s.s();!(o=s.n()).done;){var l=o.value;if(r.has(l)||i.has(l))return!0}}catch(h){s.e(h)}finally{s.f()}var c=Oi(n.j),u;try{for(c.s();!(u=c.n()).done;){var f=u.value;if(r.has(f)||i.has(f))return!0}}catch(h){c.e(h)}finally{c.f()}return!1}},{key:"_hasChainBreak",value:function(t,n){for(var r=t+1;r<=n;++r)if(this._complex._residues[r]._sequence!==this._complex._residues[r-1]._sequence+1)return!0;return!1}}]),a}();Nh.StructureType=Dr;var zs,Aa,Gu=5,ci=Nh.StructureType,Ll=qt.Type,JA=(zs={},Le(zs,ci.HELIX_ALPHA,1),Le(zs,ci.HELIX_PI,3),Le(zs,ci.HELIX_310,5),zs),QA=(Aa={},Le(Aa,ci.BRIDGE,Ll.BRIDGE),Le(Aa,ci.TURN,Ll.TURN),Le(Aa,ci.BEND,Ll.BEND),Le(Aa,ci.LOOP,Ll.COIL),Aa),Co=function(){function a(){G(this,a),this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._residueTypes=Object.create(Be.StandardTypes),this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[],this._molecules=[],this._maskNeedsUpdate=!1,this.metadata={},this.symmetry=[],this.units=[new p_(this)],this._currentUnit=0}return H(a,[{key:"addAtom",value:function(t){var n=this._atoms.length;return this._atoms.push(t),n}},{key:"addSheet",value:function(t){var n=this._sheets.length;return this._sheets.push(t),n}},{key:"addHelix",value:function(t){var n=this._helices.length;return this._helices.push(t),n}},{key:"getAtoms",value:function(){return this._atoms}},{key:"getBonds",value:function(){return this._bonds}},{key:"getAtomCount",value:function(){return this._atoms.length}},{key:"addResidue",value:function(t){var n=this._residues.length;return this._residues.push(t),n}},{key:"updateToFrame",value:function(t){this.forEachChain(function(n){n.updateToFrame(t)})}},{key:"addResidueType",value:function(t){var n=this._residueTypes[t]=new Be(t,"Unknown","");return n}},{key:"getResidueCount",value:function(){return this._residues.length}},{key:"getResidues",value:function(){return this._residues}},{key:"getSGroupCount",value:function(){return this._sgroups.length}},{key:"getSGroups",value:function(){return this._sgroups}},{key:"getAtomByFullname",value:function(t){var n=t.split(".");if(n.length!==3)return null;var r=n[0],i=parseInt(n[1],10);if(Number.isNaN(i))return null;var s=n[2].toUpperCase(),o=null;return this.forEachChain(function(l){o||l._name.localeCompare(r)===0&&l.forEachResidue(function(c){o||c._sequence===i&&c.forEachAtom(function(u){o||s.localeCompare(u.name)===0&&(o=u)})})}),o}},{key:"addChain",value:function(t){var n=new n_(this,t);return this._chains.push(n),n}},{key:"getChain",value:function(t){for(var n=0,r=this._chains.length;n<r;++n){var i=this._chains[n];if(i.getName()===t)return i}return null}},{key:"getChainCount",value:function(){return this._chains.length}},{key:"getMolecules",value:function(){return this._molecules}},{key:"getMoleculeCount",value:function(){return this._molecules.length}},{key:"forEachAtom",value:function(t){for(var n=this._atoms,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachBond",value:function(t){for(var n=this._bonds,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachResidue",value:function(t){for(var n=this._residues,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachChain",value:function(t){for(var n=this._chains,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachMolecule",value:function(t){for(var n=this._molecules,r=n.length,i=0;i<r;++i)t(n[i])}},{key:"forEachSGroup",value:function(t){for(var n=this._sgroups,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachComponent",value:function(t){for(var n=this._components,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"forEachVisibleComponent",value:function(t){for(var n=this._components,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"addBond",value:function(t,n,r,i,s){var o=new ta(t,n,r,i,s);return this._bonds.push(o),o}},{key:"getBondCount",value:function(){return this._bonds.length}},{key:"getResidueType",value:function(t){return this._residueTypes[t]||null}},{key:"getUnifiedSerial",value:function(t,n,r){var i=65536,s=i*256;return n+r*i+t*s}},{key:"splitUnifiedSerial",value:function(t){var n=65536,r=n*256,i=Math.floor(t/r),s=t-i*r,o=Math.floor(s/n),l=s-o*n;return{chain:i,serial:l,iCode:o}}},{key:"_fillCmpEdit",value:function(){var t=this,n=this._components;function r(){var i=new um(t);return i._index=n.length,n[i._index]=i,i}this.forEachChain(function(i){var s=i._residues,o=s.length;if(!(o<1))for(var l=r(),c=s[0]._index,u=0;u<o;++u){var f=s[u];f._component=l;var h=u===o-1?null:s[u+1];(!h||!f.isConnected(h)||f._index!==h._index-1)&&(l.setSubDivs([{start:c,end:f._index}]),h&&(c=h._index,l=r()))}})}},{key:"_fillCmpNoedit",value:function(){var t=new um(this);t._index=0;var n=this._residues,r=n.length;if(r!==0){for(var i=[],s=0,o=0;o<r;++o){var l=n[o];l._component=t;var c=o===r-1?null:n[o+1];(!c||!l.isConnected(c))&&(i[i.length]={start:s,end:o},c&&(s=o+1))}t.setSubDivs(i),this._components[t._index]=t}}},{key:"_fillComponents",value:function(t){t?this._fillCmpEdit():this._fillCmpNoedit()}},{key:"getCurrentUnit",value:function(){return this._currentUnit}},{key:"getDefaultBoundaries",value:function(){return this.units[0].getBoundaries()}},{key:"getBoundaries",value:function(){return this.units[this._currentUnit].getBoundaries()}},{key:"getTransforms",value:function(){return this.units[this._currentUnit].getTransforms()}},{key:"getSelector",value:function(){return this.units[this._currentUnit].getSelector()}},{key:"resetCurrentUnit",value:function(){this._currentUnit=0,this.setCurrentUnit(1)}},{key:"setCurrentUnit",value:function(t){return t!=null&&t!==this._currentUnit&&t>=0&&t<this.units.length?(this._currentUnit=t,!0):!1}},{key:"_computeBounds",value:function(){for(var t=this.units,n=0,r=t.length;n<r;++n)t[n].computeBoundaries()}},{key:"onAtomPositionChanged",value:function(){this.forEachChain(function(t){t._finalize()}),this.forEachComponent(function(t){t.update()}),this._computeBounds(),this._finalizeBonds(),this.forEachSGroup(function(t){t._rebuildSGroupOnAtomChange()})}},{key:"update",value:function(){this._maskNeedsUpdate&&(this.updateStructuresMask(),this._maskNeedsUpdate=!1)}},{key:"_finalizeBonds",value:function(){for(var t=this.getBonds(),n=t.length,r=0;r<n;++r)t[r]._index=r}},{key:"finalize",value:function(t){t=t||{};var n=this._bonds,r,i;for(r=n.length-1;r>=0;r--){var s=n[r];s._left===null||s._right===null?n.splice(r,1):(s._left.bonds.push(s),s._right.bonds.push(s))}var o=this._residues;for(r=0,i=o.length;r<i;++r)o[r]._finalize();this.forEachChain(function(M){M._finalize()});var l=this.units;for(r=0,i=l.length;r<i;++r)l[r].finalize();this.setCurrentUnit(1);var c={};for(r=0,i=o.length;r<i;++r){var u=o[r];c[this.getUnifiedSerial(u.getChain().getName().charCodeAt(0),u.getSequence(),u.getICode().charCodeAt(0))]=u}var f=this.structures;for(r=0,i=f.length;r<i;++r)f[r]._finalize(t.serialAtomMap,c,this);var h=this._helices;for(r=0,i=h.length;r<i;++r)h[r]._finalize(t.serialAtomMap,c,this);var d=this._sheets;for(r=0,i=d.length;r<i;++r)d[r]._finalize(t.serialAtomMap,c,this);this._computeBounds();var p=this._atoms;for(r=0,i=p.length;r<i;++r){var v=p[r];v.index=r}if(t.needAutoBonding){var _=new DA(this);_.build(),_.destroy()}var m=this._chains;for(r=0,i=m.length;r<i;++r)m[r]._index=r;for(r=0,i=o.length;r<i;++r)o[r]._index=r;for(r=0,i=p.length;r<i;++r){var g=p[r];if(g.flags&ln.Flags.HYDROGEN&&g.bonds.length===1){var y=g.bonds[0],x=y._left!==g&&y._left||y._right;x.flags&ln.Flags.CARBON&&(g.flags|=ln.Flags.NONPOLARH)}}this._finalizeBonds(),this._fillComponents(t.enableEditing);var S=new XA(this);S.markCycles(),t.detectAromaticLoops&&S.detectCycles(),this._finalizeMolecules()}},{key:"_finalizeMolecules",value:function(){for(var t=0;t<this._molecules.length;t++)for(var n=this._molecules[t],r=n.residues.length,i=0;i<r;i++){var s=n.residues[i];s._molecule=n}}},{key:"updateStructuresMask",value:function(){var t=function(r){return r.collectMask()};this.forEachResidue(t),this.forEachChain(t),this.forEachMolecule(t)}},{key:"countAtomsByMask",value:function(t){var n=0;return this.forEachAtom(function(r){r.mask&t&&n++}),n}},{key:"getNumAtomsBySelector",value:function(t){var n=0;return this.forEachAtom(function(r){t.includesAtom(r)&&n++}),n}},{key:"resetAtomMask",value:function(t){this.forEachAtom(function(n){n.mask=t})}},{key:"markAtoms",value:function(t,n){var r=n,i=~r,s=0,o=Et.keyword("And")(t,this.getSelector());return this.forEachAtom(function(l){o.includesAtom(l)?(l.mask|=r,s++):l.mask&=i}),this._maskNeedsUpdate=!0,s}},{key:"markAtomsAdditionally",value:function(t,n){var r=n,i=0;return this.forEachAtom(function(s){t.includesAtom(s)&&(s.mask&n)!==n&&(s.mask|=r,i++)}),i}},{key:"clearAtomBits",value:function(t){var n=~t;this.forEachAtom(function(i){i.mask&=n});var r=function(s){s._mask&=n};this.forEachAtom(r),this.forEachResidue(r),this.forEachChain(r),this.forEachMolecule(r)}},{key:"getAtomNames",value:function(){if(this.hasOwnProperty("_atomNames"))return this._atomNames;var t={};return this.forEachAtom(function(n){t[n.name]=1}),this._atomNames=Object.keys(t),this._atomNames}},{key:"getElements",value:function(){if(this.hasOwnProperty("_elements"))return this._elements;var t={};return this.forEachAtom(function(n){t[n.element.name]=1}),this._elements=Object.keys(t),this._elements}},{key:"getResidueNames",value:function(){if(this.hasOwnProperty("_residueNames"))return this._residueNames;var t={};return this.forEachResidue(function(n){t[n._type._name]=1}),this._residueNames=Object.keys(t),this._residueNames}},{key:"getChainNames",value:function(){if(this.hasOwnProperty("_chainNames"))return this._chainNames;var t={};return this.forEachChain(function(n){t[n._name]=1}),this._chainNames=Object.keys(t),this._chainNames}},{key:"getAltLocNames",value:function(){if(this.hasOwnProperty("_altlocNames"))return this._altlocNames;var t={};return this.forEachAtom(function(n){t[String.fromCharCode(n.location)]=1}),this._altlocNames=Object.keys(t),this._altlocNames}},{key:"getVoxelWorld",value:function(){if(!this.hasOwnProperty("_voxelWorld"))try{this._voxelWorld=new Ti(this.getDefaultBoundaries().boundingBox,new b(Gu,Gu,Gu)),this._voxelWorld.addAtoms(this)}catch{Wt.warn("Unable to create voxel world"),this._voxelWorld=null}return this._voxelWorld}},{key:"addElement",value:function(t,n,r,i){for(var s=t.length,o=0;o<s;++o){var l=t[o];i(l,r),n.push(l)}}},{key:"joinComplexes",value:function(t){this._chains=[],this._components=[],this._helices=[],this._sheets=[],this.structures=[],this._atoms=[],this._residues=[],this._bonds=[],this._sgroups=[];var n=this,r=0,i=0,s=0,o=0,l=0;function c(g,y){g.serial+=y,g.index+=y}function u(g,y){g._index+=y}function f(g,y){g._index+=y}function h(g,y){g._complex=n,g._index+=y}function d(g,y){g._complex=n,g._index+=y}function p(){}for(var v=0;v<t.length;++v){var _=t[v];this.addElement(_._atoms,this._atoms,r,c),this.addElement(_._bonds,this._bonds,i,u),this.addElement(_._residues,this._residues,s,f),this.addElement(_._chains,this._chains,o,h),this.addElement(_._sheets,this._sheets,0,p),this.addElement(_._helices,this._helices,0,p),this.addElement(_._sgroups,this._sgroups,0,p),this.addElement(_._components,this._components,l,d),this.addElement(_.structures,this.structures,0,p);for(var m in _._residueTypes)_._residueTypes.hasOwnProperty(m)&&(this._residueTypes[m]=_._residueTypes[m]);r+=_._atoms.length,i+=_._bonds.length,s+=_._residues.length,o+=_._chains.length,l+=_._components.length}this._computeBounds()}},{key:"dssp",value:function(){for(var t=new Nh(this),n=this.structures=[],r=this._helices=[],i=this._sheets=[],s=function(x){var S=i[x];return S||(S=i[x]=new a_(String(x),0)),S},o,l,c=0,u=null,f=0,h=this._residues.length;f<h;++f){var d=t._ss[f],p=this._residues[f],v=t._sheet[f];if(d===o&&v===l){p._secondary=u,u&&(u.term=p),u instanceof Bf&&u.length++;continue}var _=JA[d],m=QA[d];if(d===ci.STRAND){var g=s(v);u=new Ch(g,p,p,0,null,null),g.addStrand(u)}else _!==void 0?(c++,u=new Bf(_,p,p,c,String(c),"",1),r.push(u)):m!==void 0?u=new qt(m,p,p):u=null;u&&n.push(u),p._secondary=u,o=d,l=v}this._sheets=i.filter(function(y){return!0})}}]),a}();Co.prototype.id="Complex";Co.prototype.name="";function xm(a){var e=2;for(a=a-1>>1;a;)e<<=1,a>>=1;return e}var Ih=function(){function a(e,t,n,r,i,s){if(G(this,a),this._box=n.clone(),this._dimVec=Math.max(Math.floor(r||1),1),this._volumeInfo=s,t instanceof Array){var o=Lt(t,3);this._dimX=o[0],this._dimY=o[1],this._dimZ=o[2]}else this._dimX=t.x,this._dimY=t.y,this._dimZ=t.z;switch(this._dimX=Math.max(Math.floor(this._dimX),1),this._dimY=Math.max(Math.floor(this._dimY),1),this._dimZ=Math.max(Math.floor(this._dimZ),1),this._rowElements=this._dimVec*this._dimX,this._planeElements=this._rowElements*this._dimY,this._totalElements=this._planeElements*this._dimZ,this._data=i||Se.allocateTyped(e,this._totalElements),this._dimVec){case 1:break;case 2:this.getValue=function(l,c,u){var f=l*this._dimVec+c*this._rowElements+u*this._planeElements;return[this._data[f],this._data[f+1]]},this.setValue=function(l,c,u,f,h){var d=l*this._dimVec+c*this._rowElements+u*this._planeElements;this._data[d]=f,this._data[d+1]=h},this.addValue=function(l,c,u,f,h){var d=l*this._dimVec+c*this._rowElements+u*this._planeElements;this._data[d]+=f,this._data[d+1]+=h};break;case 3:this.getValue=function(l,c,u){var f=l*this._dimVec+c*this._rowElements+u*this._planeElements;return[this._data[f],this._data[f+1],this._data[f+2]]},this.setValue=function(l,c,u,f,h,d){var p=l*this._dimVec+c*this._rowElements+u*this._planeElements;this._data[p]=f,this._data[p+1]=h,this._data[p+2]=d},this.addValue=function(l,c,u,f,h,d){var p=l*this._dimVec+c*this._rowElements+u*this._planeElements;this._data[p]+=f,this._data[p+1]+=h,this._data[p+2]+=d};break;default:throw new Error("Volume: invalid vector dimension")}}return H(a,[{key:"getValue",value:function(t,n,r){return this._data[t+n*this._rowElements+r*this._planeElements]}},{key:"setValue",value:function(t,n,r,i){this._data[t+n*this._rowElements+r*this._planeElements]=i}},{key:"addValue",value:function(t,n,r,i){this._data[t+n*this._rowElements+r*this._planeElements]+=i}},{key:"getDimensions",value:function(){return[this._dimX,this._dimY,this._dimZ]}},{key:"getBox",value:function(){return this._box}},{key:"getVolumeInfo",value:function(){return this._volumeInfo}},{key:"getCellSize",value:function(){var t=new b;this._box.getSize(t);var n=new b;return n.x=this._dimX>1?t.x/(this._dimX-1):0,n.y=this._dimY>1?t.y/(this._dimY-1):0,n.z=this._dimZ>1?t.z/(this._dimZ-1):0,n}},{key:"computeGradient",value:function(){if(this._dimVec!==1)return null;var t=new a(Float32Array,[this._dimX,this._dimY,this._dimZ],this._box,3),n=this.getCellSize(),r=new b(-.5/n.x,-.5/n.y,-.5/n.z);function i(x,S,M){return Math.min(M,Math.max(S,x))}var s=this._dimX,o=this._dimY,l=this._dimZ,c=this._data;function u(x,S,M){return c[M*s*o+S*s+x]}for(var f=0;f<l;++f)for(var h=i(f-1,0,l-1),d=i(f+1,0,l-1),p=0;p<o;++p)for(var v=i(p-1,0,o-1),_=i(p+1,0,o-1),m=0;m<s;++m){var g=i(m-1,0,s-1),y=i(m+1,0,s-1);t.setValue(m,p,f,(u(y,p,f)-u(g,p,f))*r.x,(u(m,_,f)-u(m,v,f))*r.y,(u(m,p,d)-u(m,p,h))*r.z)}return t}},{key:"normalize",value:function(){for(var t=this._data,n=t[0],r=t[0],i=1;i<t.length;++i)n=Math.min(n,t[i]),r=Math.max(r,t[i]);var s=1/(r-n);if(s!==0)for(var o=0;o<t.length;++o)t[o]=s*(t[o]-n)}},{key:"getTiledTextureStride",value:function(){return[this._dimX+2,this._dimY+2]}},{key:"buildTiledTexture",value:function(){var t=Math.ceil(Math.sqrt(this._dimZ*this._dimY/this._dimX)),n=t*(this._dimX+2)-1;n=xm(n),t=Math.floor(n/(this._dimX+2));var r=Math.ceil(this._dimZ/t),i=r*(this._dimY+2)-1;i=xm(i);for(var s=new Uint8Array(n*i),o,l,c=0;c<r;++c)for(var u=0;u<this._dimY;++u){o=c*t*this._planeElements+u*this._rowElements,l=n*(c*(this._dimY+2)+u);for(var f=0;f<t;++f){for(var h=0;h<this._dimX;++h)s[l++]=255*this._data[o++];s[l++]=255*this._data[o-1],f<t-1&&(o+=this._planeElements-this._rowElements,s[l++]=255*this._data[o])}}for(var d=0;d<r;++d){o=n*(d*(this._dimY+2)+this._dimY-1),l=o+n;for(var p=0;p<n;++p)s[l++]=s[o++];if(d<r-1){o=n*(d+1)*(this._dimY+2),l=o-n;for(var v=0;v<n;++v)s[l++]=s[o++]}}var _=new fh(s,n,i,Uv,xi,yc,dr,dr,pt,pt);return _.needsUpdate=!0,_}},{key:"getData",value:function(){return this._data}},{key:"getDirectIdx",value:function(t,n,r){return t*this._dimVec+n*this._rowElements+r*this._planeElements}},{key:"getStrideX",value:function(){return this._dimVec}},{key:"getStrideY",value:function(){return this._rowElements}},{key:"getStrideZ",value:function(){return this._planeElements}}]),a}();Ih.prototype.id="Volume";var eT=function(){function a(e,t,n){G(this,a),this.complex=e,this.name=t||"",this.residues=[],this.mask=1,this.index=n||-1}return H(a,[{key:"forEachResidue",value:function(t){for(var n=this.residues,r=0,i=n.length;r<i;++r)t(n[r])}},{key:"collectMask",value:function(){for(var t=4294967295,n=this.residues,r=0,i=n.length;r<i;++r)t&=n[r]._mask;this.mask=t}}]),a}(),qe={Atom:ln,Element:fe,Bond:ta,Residue:fc,ResidueType:Be,Chain:n_,Helix:Bf,Strand:Ch,Sheet:a_,SGroup:bA,Assembly:Lh,Complex:Co,Volume:Ih,VoxelWorld:Ti,selectors:Et,Molecule:eT};function tT(a){var e=rT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function rT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var kh=function(a){re(t,a);var e=tT(t);function t(n){var r;G(this,t),r=e.call(this);var i=qr(r);return r._element=n,r._element.style.position="absolute",r.addEventListener("removed",function(){i._element.parentNode!==null&&i._element.parentNode.removeChild(i._element)}),r}return H(t,[{key:"getElement",value:function(){return this._element}},{key:"setTransparency",value:function(r){var i=this.getElement();if(i!==null){if(r===1){i.style.display="none";return}i.style.display="inline";var s=1-r,o=s.toString(),l=s*100;i.style.opacity=o,i.style.filter="alpha(opacity=".concat(l,")")}}},{key:"clone",value:function(){var r=new t(this._element);return r.copy(this),r}}]),t}(lt);function nT(a){var e=iT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function iT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var na=function(a){re(t,a);var e=nT(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"raycast",value:function(r,i){if(this.visible)for(var s=this.children,o=0,l=s.length;o<l;++o)s[o].raycast(r,i)}},{key:"enableSubset",value:function(r,i){for(var s=this.children,o=0,l=s.length;o<l;++o)s[o].enableSubset&&s[o].enableSubset(r,i)}},{key:"disableSubset",value:function(r,i){for(var s=this.children,o=0,l=s.length;o<l;++o)s[o].disableSubset&&s[o].disableSubset(r,i)}},{key:"isEmpty",value:function(){return this.children.length===0}},{key:"updateToFrame",value:function(r){for(var i=this.children,s=0,o=i.length;s<o;++s)i[s].updateToFrame&&i[s].updateToFrame(r)}},{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=o.length;l<c;++l)o[l].getSubset&&Array.prototype.push.apply(s,o[l].getSubset(r,i));return s}}]),t}(nr),Ri=`uniform mat4 projectionMatrix;\r
uniform mat4 modelViewMatrix;\r
\r
attribute vec2 uv;\r
attribute vec3 position;\r
\r
varying vec2 vUv;\r
\r
void main() {\r
  vUv = uv;\r
  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r
}\r
`,aT=`precision highp float;\r
\r
varying vec2 vUv;\r
uniform sampler2D srcTex;\r
uniform float opacity;\r
\r
void main() {\r
  vec4 color = texture2D(srcTex, vUv);\r
  gl_FragColor = vec4(color.xyz, color.a * opacity);\r
}\r
`,sT=`precision highp float;\r
\r
varying vec2 vUv;\r
uniform sampler2D srcTex;\r
uniform float coef;\r
\r
void main() {\r
  vec2 uv = vUv * 2.0 - 1.0;\r
  float r2 = dot(uv, uv);\r
  vec2 tc = uv * (1.0 + coef * r2);\r
  if (!all(lessThan(abs(tc), vec2(1.0))))\r
    discard;\r
  tc = 0.5 * (tc + 1.0);\r
  gl_FragColor = texture2D(srcTex, tc);\r
}\r
`;function oT(a){var e=lT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function lT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Vf={DEFAULT:0,VOLUME:1,TRANSPARENT:2,PREPASS_TRANSPARENT:3,VOLUME_BFPLANE:4,COLOR_FROM_POSITION:5,SHADOWMAP:6},Sm=[Vf.DEFAULT,Vf.TRANSPARENT];lt.prototype.resetTransform=function(){this.position.set(0,0,0),this.quaternion.set(0,0,0,1),this.scale.set(1,1,1)};lt.prototype.updateMatrixWorldRecursive=function(){this.parent!=null&&this.parent.updateMatrixWorldRecursive(),this.updateMatrixWorld()};lt.prototype.addSavingWorldTransform=function(){var a=new Ce;return function(e){e instanceof lt&&(a.copy(this.matrixWorld).invert(),a.multiply(e.matrixWorld),e.matrix.copy(a),e.matrix.decompose(e.position,e.quaternion,e.scale),this.add(e))}}();mt.prototype.renderDummyQuad=function(){var a=new Ec({transparent:!0,opacity:0,depthWrite:!1}),e=new pi,t=new ft(new Ci(.01,.01),a);e.add(t);var n=new ls(-.5,.5,.5,-.5,-1e4,1e4);return n.position.z=100,function(){this.render(e,n)}}();mt.prototype.renderScreenQuad=function(){var a=new pi,e=new ft(new Ci(1,1));a.add(e);var t=new ls(-.5,.5,.5,-.5,-1e4,1e4);return t.position.z=100,function(n){e.material=n,this.render(a,t)}}();Ce.prototype.isIdentity=function(){var a=new Ce;return function(){return a.equals(this)}}();Ce.prototype.applyToPointsArray=function(a,e,t){if(!a||!e||e<3)return a;t=t||0;for(var n=this.elements,r=0;r<a.length;r+=e){var i=a[r],s=a[r+1],o=a[r+2],l=1/(n[3]*i+n[7]*s+n[11]*o+n[15]);a[r]=(n[0]*i+n[4]*s+n[8]*o+n[12]*t)*l,a[r+1]=(n[1]*i+n[5]*s+n[9]*o+n[13]*t)*l,a[r+2]=(n[2]*i+n[6]*s+n[10]*o+n[14]*t)*l}return a};var v_=function(a){re(t,a);var e=oT(t);function t(n){return G(this,t),n.uniforms===void 0&&(n.uniforms={}),n.uniforms.srcTex={type:"t",value:null},n.vertexShader=Ri,n.transparent=!1,n.depthTest=!1,n.depthWrite=!1,e.call(this,n)}return H(t)}(Ur);mt.prototype.renderScreenQuadFromTex=function(){var a=new v_({uniforms:{opacity:{type:"f",value:1}},fragmentShader:aT,transparent:!0});return function(e,t){a.uniforms.srcTex.value=e,a.transparent=t<1,a.uniforms.opacity.value=t,this.renderScreenQuad(a)}}();mt.prototype.renderScreenQuadFromTexWithDistortion=function(){var a=new v_({uniforms:{coef:{type:"f",value:1}},fragmentShader:sT});return function(e,t){a.uniforms.srcTex.value=e,a.uniforms.coef.value=t,this.renderScreenQuad(a)}}();Bt.prototype.setMinimalFov=function(a){this.aspect>=1?this.fov=a:this.fov=Vn.radToDeg(2*Math.atan(Math.tan(Vn.degToRad(a)*.5)/this.aspect))};Bg.prototype.updateHalfSized=function(a,e){var t=a.aspect,n=a.fov;a.aspect=t/2,a.setMinimalFov(e),a.updateProjectionMatrix(),this.update(a),a.aspect=t,a.fov=n,a.updateProjectionMatrix()};Bt.prototype.setDistanceToFit=function(a,e){this.position.z=a/Math.sin(.5*Vn.degToRad(e))};zg.prototype.intersectVisibleObject=function(a,e,t,n){var r=this.intersectObject(a,!1);if(r.length===0)return null;var i=Math.min(e.near,t),s,o=r[0],l=new b;for(s=0;s<r.length&&(o=r[s],l.copy(o.point),l.applyMatrix4(e.matrixWorldInverse),!(l.z<=-i));++s);if(s===r.length)return null;var c=Math.min(e.far,n);return l.copy(o.point),l.applyMatrix4(e.matrixWorldInverse),l.z<=-c?null:o};Ce.prototype.extractScale=function(){var a=new b;return function(e){e===void 0&&(Wt.debug("extractScale(): new is too expensive operation to do it on-the-fly"),e=a.clone());var t=this.elements;e.x=a.set(t[0],t[1],t[2]).length(),e.y=a.set(t[4],t[5],t[6]).length(),e.z=a.set(t[8],t[9],t[10]).length();var n=this.determinant();return n<0&&(e.x=-e.x),e}}();function cT(a,e,t){var n=a.clone().lerp(e,.5),r=new Ce;r.makeScale(t,a.distanceTo(e),t);var i=new Ce;i.makeRotationX(Math.PI/2);var s=new Ce,o=new b(0,1,0);return s.lookAt(n,e,o),s.multiply(i),s.multiply(r),s.setPosition(n),s}function uT(a,e,t,n){var r=new Ce;r.makeScale(n.x,n.y,0);var i=new Ce;return i.lookAt(a,e,t),i.multiply(r),i.setPosition(a),i}function fT(a){var e=!1;return a.traverse(function(t){(t.hasOwnProperty("geometry")||t instanceof kh)&&(e=!0)}),e}function hT(a,e,t){function n(u){for(var f=1e-5,h=0,d=u,p=1;Math.abs(d-h)>f;)p=1+t*d,h=d,d=u/(p*p);return 1/p}for(var r=new Ci(2,2,a,e),i=r.getAttribute("position"),s=0;s<i.count;++s){var o=i.array[3*s],l=i.array[3*s+1],c=n(o*o+l*l);i.setXY(s,c*o,c*l)}return r}Ze.prototype.copyAtList=function(a,e){console.assert(this.itemSize===a.itemSize,"false: BufferAttribute.copyAtList buffers have different item size.");for(var t=this.itemSize,n=0,r=e.length;n<r;++n)for(var i=0;i<t;++i)this.array[n*t+i]=a.array[e[n]*t+i];return this};function dT(a,e,t,n){t=typeof t<"u"?t:0,n=typeof n<"u"?n:a.length;for(var r=t;r<n;++r)a[r]=e}function pT(a){for(var e=a.children,t=0,n=e.length;t<n;++t){var r=e[t];r.parent=null,r.dispatchEvent({type:"removed"})}a.children=[]}function g_(a){a.traverse(function(e){(e instanceof ft||e instanceof Gr||e instanceof ea)&&e.geometry.dispose()}),pT(a)}function mT(a){g_(a),a.parent?a.parent.remove(a):a.dispatchEvent({type:"removed"})}function vT(a){for(var e=0;e<Sm.length;e++)if((a.layers.mask>>Sm[e]&1)===1)return!0;return!1}function gT(a,e){var t=+(e!=="BA");a.traverse(function(n){n.isGroup&&(n.renderOrder=t)})}function _T(a){a.traverse(function(e){"material"in e&&(e.material=e.material.clone(!0),e.material.setValues({depthFunc:nc,overrideColor:!0,fog:!1,lights:!1,shadowmap:!1}),e.material.setUberOptions({fixedColor:new ze(16776960),zOffset:-1e-6}))})}function yT(a,e,t){var n=t||new b;return n.set(0,0,0),n.addScaledVector(a,.5),n.addScaledVector(e,.5),n}var xT=wi.prototype.copy;wi.prototype.copy=function(a){xT.call(this,a),this.instanceCount===void 0&&(this.instanceCount=1/0)};var Je={calcCylinderMatrix:cT,calcChunkMatrix:uT,groupHasGeometryToRender:fT,buildDistorionMesh:hT,RCGroup:na,fillArray:dT,clearTree:g_,destroyObject:mT,belongToSelectLayers:vT,processObjRenderOrder:gT,applySelectionMaterial:_T,getMiddlePoint:yT,LAYERS:Vf};function ST(a){var e=bT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function bT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var wT={boundingBox:new Vt(new b(-1,-1,-1),new b(1,1,1)),boundingSphere:new Lr(new b(0,0,0),1)},go=function(a){re(t,a);var e=ST(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i.name=n,i._dataSource=r,i}return H(t,[{key:"release",value:function(){this.parent&&this.parent.remove(this)}},{key:"getDataSource",value:function(){return this._dataSource}},{key:"getBoundaries",value:function(){return wT}}]),t}(Je.RCGroup);function MT(a){if(Array.isArray(a))return Pf(a)}function ET(a){if(typeof Symbol<"u"&&a[Symbol.iterator]!=null||a["@@iterator"]!=null)return Array.from(a)}function CT(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function $i(a){return MT(a)||ET(a)||Ug(a)||CT()}function bm(a){return a==null||Array.isArray(a)?a:[a]}var ia=function(){function a(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["id"];G(this,a),this._list=[],this._dict={},this._indices=$i(n),this._indices.forEach(function(r){e._dict[r]={}}),t.forEach(function(r){return e.register(r)})}return H(a,[{key:"register",value:function(t){var n=this;a.registerInList(this._list,t),this._indices.forEach(function(r){a.registerInDict(n._dict[r],bm(t[r]),t)})}},{key:"unregister",value:function(t){var n=this;a.unregisterFromList(this._list,t),this._indices.forEach(function(r){a.unregisterFromDict(n._dict[r],bm(t[r]),t)})}},{key:"all",get:function(){return $i(this._list)}},{key:"first",get:function(){return this._list[0]}},{key:"keys",value:function(t){return Object.keys(this._dict[t||this._indices[0]])}},{key:"get",value:function(t,n){var r=this._dict[n||this._indices[0]];if(r){var i=r[t&&t.toLowerCase()];return i&&i.length>0?i[0]:void 0}}}],[{key:"registerInList",value:function(t,n){t.includes(n)||t.push(n)}},{key:"unregisterFromList",value:function(t,n){var r=t.indexOf(n);r!==-1&&t.splice(r,1)}},{key:"registerInDict",value:function(t,n,r){n.forEach(function(i){i=i.toLowerCase();var s=t[i]=t[i]||[];s.includes(r)||s.push(r)})}},{key:"unregisterFromDict",value:function(t,n,r){n.forEach(function(i){i=i.toLowerCase();var s=t[i];if(s){var o=s.indexOf(r);o!==-1&&s.splice(o,1),s.length===0&&delete t[i]}})}}]),a}();function Ao(a){Object.defineProperties(a,{logger:{get:function(){return this.context&&this.context.logger?this.context.logger:Wt}},settings:{get:function(){return this.context&&this.context.settings?this.context.settings:Q}}})}function AT(a){var e=TT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function TT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var __=function(){function a(e,t){G(this,a),this._position=e,this._radius=t}return H(a,[{key:"raycast",value:function(t){var n=a._sphere;n.set(this._position,this._radius);var r=new b;return t.ray.intersectSphere(n,r)?{distance:t.ray.origin.distanceTo(r),point:r}:null}}]),a}();Le(__,"_sphere",new Lr);var Oh=function(e){return function(t){re(r,t);var n=AT(r);function r(i){var s;G(this,r);for(var o=arguments.length,l=new Array(o>1?o-1:0),c=1;c<o;c++)l[c-1]=arguments[c];return s=n.call.apply(n,[this].concat(l)),s._objects=new Array(i),s.boundingSphere=null,s.boundingBox=null,s}return H(r,[{key:"setSphere",value:function(s,o,l){this._objects[s]=new __(o,l)}},{key:"raycast",value:function(s,o){for(var l=0,c=this._objects.length;l<c;++l){var u=this._objects[l].raycast(s);u&&(u.chunkIdx=l,o.push(u))}}},{key:"computeBoundingBox",value:function(){var s=this._objects,o=this.boundingBox;o===null&&(this.boundingBox=o=new Vt),o.makeEmpty();for(var l=0,c=s.length;l<c;++l)o.expandByPoint(s[l]._position)}},{key:"computeBoundingSphere",value:function(){this.computeBoundingBox();var s=this._objects,o=this.boundingBox,l=0,c=new b;o.getCenter(c);for(var u=0,f=s.length;u<f;++u){var h=s[u]._position,d=c.distanceToSquared(h);l<d&&(l=d)}this.boundingSphere===null&&(this.boundingSphere=new Lr),this.boundingSphere.set(c,Math.sqrt(l))}}]),r}(e)};function RT(a){var e=LT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function LT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Pl=new ze,Nl=4,Il=3,wm=Se.copySubArrays;function PT(a,e,t,n,r){a[e]=t,a[e+1]=n,a[e+2]=r}function NT(a,e,t,n,r,i){a[e]=t,a[e+1]=n,a[e+2]=r,a[e+3]=i}var y_=function(a){re(t,a);var e=RT(t);function t(n,r,i){var s;return G(this,t),s=e.call(this,n),s._sphGeometry=i?new Ci(2,2,1,1):new Pc(1,r*2,r,0,Math.PI*2,0,Math.PI),s._init(n,s._sphGeometry),s}return H(t,[{key:"setItem",value:function(r,i,s){NT(this._offsets,r*Nl,i.x,i.y,i.z,s),this.setSphere(r,i,s)}},{key:"setColor",value:function(r,i){Pl.set(i),PT(this._colors,r*Il,Pl.r,Pl.g,Pl.b)}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("offset").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(r,i){for(var s=this._alpha,o=0,l=r.length;o<l;++o)s[r[o]]=i;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(r){var i=r.length,s=new wi;return this._init.call(s,i,this._sphGeometry),wm(this._offsets,s._offsets,r,Nl),wm(this._colors,s._colors,r,Il),s.boundingSphere=this.boundingSphere,s.boundingBox=this.boundingBox,[s]}},{key:"_init",value:function(r,i){this.copy(i),this._offsets=Se.allocateTyped(Float32Array,r*Nl),this._colors=Se.allocateTyped(Float32Array,r*Il);var s=this._alpha=Se.allocateTyped(Float32Array,r);le.fill(s,1),this.setAttribute("offset",new Mr(this._offsets,Nl,!1,1)),this.setAttribute("color",new Mr(this._colors,Il,!1,1)),this.setAttribute("alphaColor",new Mr(s,1,!1,1))}}]),t}(Oh(wi));function IT(a){var e=kT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function kT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var OT=65535,ei=3,kl=new ze,Dc=function(a){re(t,a);var e=IT(t);function t(n,r){var i;if(G(this,t),i=e.call(this),i.constructor===t)throw new Error("Can not instantiate abstract class!");return i._chunkGeo=n,i._init(n,r),i}return H(t,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("normal").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0}},{key:"setColor",value:function(r,i){kl.set(i);for(var s=this._colors,o=this._chunkSize,l=r*o,c=l+o;l<c;++l){var u=l*ei;s[u]=kl.r,s[u+1]=kl.g,s[u+2]=kl.b}}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(r,i){for(var s=this._alpha,o=this._chunkSize,l=0,c=r.length;l<c;++l){var u=r[l]*o;le.fill(s,i,u,u+o)}this.getAttribute("alphaColor").needsUpdate=!0}},{key:"raycast",value:function(r,i){var s=[],o=new ft;o.geometry=this,o.raycast(r,s);for(var l=this._chunkGeo.index.count/3,c=0,u=s.length;c<u;++c)s[c].hasOwnProperty("faceIndex")&&(s[c].chunkIdx=Math.floor(s[c].faceIndex/l),i.push(s[c]))}},{key:"getSubset",value:function(r){var i=r.length,s=new at;this._init.call(s,this._chunkGeo,i);for(var o=this._positions,l=this._normals,c=this._colors,u=s._positions,f=s._normals,h=s._colors,d=this._chunkSize*ei,p=0,v=r.length;p<v;++p){var _=p*d,m=r[p]*d,g=m+d;u.set(o.subarray(m,g),_),f.set(l.subarray(m,g),_),h.set(c.subarray(m,g),_)}return s.boundingSphere=this.boundingSphere,s.boundingBox=this.boundingBox,[s]}},{key:"_init",value:function(r,i){var s=this._chunkSize=r.attributes.position.count,o=r.index.array,l=o.length,c=this._chunkSize*i,u=c>OT,f=l*i,h=this._index=Se.allocateTyped(u?Uint32Array:Uint16Array,f);this._positions=Se.allocateTyped(Float32Array,c*ei),this._normals=Se.allocateTyped(Float32Array,c*ei),this._colors=Se.allocateTyped(Float32Array,c*ei);var d=this._alpha=Se.allocateTyped(Float32Array,c);le.fill(d,1);for(var p=0;p<i;++p){var v=p*l,_=p*s;h.set(o,v);for(var m=0;m<l;++m)h[v+m]+=_}this.setIndex(new Ze(this._index,1)),this.setAttribute("position",new Ze(this._positions,ei)),this.setAttribute("normal",new Ze(this._normals,ei)),this.setAttribute("color",new Ze(this._colors,ei)),this.setAttribute("alphaColor",new Ze(d,1))}}]),t}(at);function DT(a){var e=FT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function FT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Hu=3,BT=function(a){re(t,a);var e=DT(t);function t(n,r){var i;G(this,t);var s=new Pc(1,r*2,r,0,Math.PI*2,0,Math.PI);i=e.call(this,n,s,n);var o=i._normals,l=s.attributes.normal.array,c=i._chunkSize;i._chunkPos=i._chunkGeo.attributes.position.array,i._tmpPositions=Se.allocateTyped(Float32Array,c*Hu);for(var u=0;u<n;++u)o.set(l,c*Hu*u);return i}return H(t,[{key:"setItem",value:function(r,i,s){for(var o=this._tmpPositions,l=this._chunkSize,c=this._chunkPos,u=0;u<l;++u){var f=u*3;o[f]=i.x+c[f]*s,o[f+1]=i.y+c[f+1]*s,o[f+2]=i.z+c[f+2]*s}this._positions.set(o,l*r*Hu),this.setSphere(r,i,s)}}]),t}(Oh(Dc));function zT(a){var e=VT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function VT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Ta=3,Ra=new b,La=new b,Mm=new zt,Dh=function(a){re(t,a);var e=zT(t);function t(n,r){var i;G(this,t);var s=new wo(1,1,1,Math.max(3,r),2,!0);i=e.call(this,s,2*n);var o=i._chunkSize;return i._chunkPos=i._chunkGeo.attributes.position.array,i._chunkNorms=i._chunkGeo.attributes.normal.array,i._tmpVector=Se.allocateTyped(Float32Array,o*Ta),i}return H(t,[{key:"setItem",value:function(r,i,s,o){var l=this._chunkSize,c=l*2*r*Ta,u=c+l*Ta,f=this._tmpVector,h=this._chunkPos,d=this._chunkNorms;Ra.lerpVectors(i,s,.5);var p=Je.calcCylinderMatrix(i,Ra,o);Mm.getNormalMatrix(p);for(var v,_=0;_<l;++_)v=_*Ta,La.fromArray(h,v),La.applyMatrix4(p),La.toArray(f,v);this._positions.set(f,c),Ra.sub(i);for(var m=0;m<l;++m)v=m*Ta,f[v]+=Ra.x,f[v+1]+=Ra.y,f[v+2]+=Ra.z;this._positions.set(f,u);for(var g=0;g<l;++g)v=g*Ta,La.fromArray(d,v),La.applyMatrix3(Mm),La.toArray(f,v);this._normals.set(f,c),this._normals.set(f,u)}},{key:"setColor",value:function(r,i,s){var o=2*r;xt(D(t.prototype),"setColor",this).call(this,o,i);var l=o+1;xt(D(t.prototype),"setColor",this).call(this,l,s)}}]),t}(Dc);function UT(a){var e=GT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function GT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var HT=65536,Vs=3,WT=function(a){re(t,a);var e=UT(t);function t(n,r,i,s,o,l){var c;G(this,t),c=e.call(this);var u=0,f=2*Math.PI;c.type="CylinderBufferGeometry",c.parameters={radiusTop:n,radiusBottom:r,height:i,radialSegments:s,heightSegments:o,openEnded:l};var h=l===!1&&n>0,d=l===!1&&r>0,p=(o+1)*s+h*(s+1)+d*(s+1),v=(2*o+h+d)*s,_=i/2,m=new Ze(Se.allocateTyped(Float32Array,p*3),3),g=new Ze(Se.allocateTyped(Float32Array,p*3),3),y=new sh(Se.allocateTyped(Uint16Array,v*Vs),1),x=new Ze(Se.allocateTyped(Float32Array,p*2),2);console.assert(p<HT,"false: Cylinder Geometry has too many vertices (65536 max).");for(var S=0,M=0,E=-(r-n)/i,N=0;N<=o;N++){if(N!==o)for(var B=0;B<s;B++){var V=S+B,O=S+s+B,W=S+s+(B+1)%s,z=S+(B+1)%s;y.setXYZ(M*Vs,V,z,O),M++,y.setXYZ(M*Vs,O,z,W),M++}for(var C=N/o,T=C*(r-n)+n,A=0;A<s;A++){var F=A/s,X=T*Math.sin(F*f+u),Y=C*i-_,ne=T*Math.cos(F*f+u),ae=new b(X,Math.sqrt(X*X+ne*ne)*E,ne).normalize();m.setXYZ(S,X,Y,ne),g.setXYZ(S,ae.x,ae.y,ae.z),x.setXY(S,F,C),++S}}if(h){for(var xe=S,be=S+s,ge=0;ge<s;++ge){var we=S-s;m.setXYZ(S,m.getX(we),m.getY(we),m.getZ(we)),g.setXYZ(S,0,1,0),x.setXY(S,1,1);var q=xe+(ge+1)%s;y.setXYZ(M*Vs,S,q,be),M++,S++}m.setXYZ(S,0,_,0),g.setXYZ(S,0,1,0),x.setXY(S,1,1),++S}if(d){for(var Ge=S,Te=S+s,Pe=0;Pe<s;++Pe){var Ee=Pe;m.setXYZ(S,m.getX(Ee),m.getY(Ee),m.getZ(Ee)),g.setXYZ(S,0,-1,0),x.setXY(S,0,0);var _e=Ge+(Pe+1)%s;y.setXYZ(M*Vs,_e,S,Te),M++,S++}m.setXYZ(S,0,-_,0),g.setXYZ(S,0,-1,0),x.setXY(S,0,0)}return c.setIndex(y),c.setAttribute("position",m),c.setAttribute("normal",g),c.setAttribute("uv",x),c}return H(t,[{key:"clone",value:function(){var r=this.parameters;return new t(r.radiusTop,r.radiusBottom,r.height,r.radialSegments,r.heightSegments,r.openEnded)}}]),t}(at);function XT(a){var e=jT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function jT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ti=new ze,Em=new Ce,Ht=4,Fn=3,ri=Se.copySubArrays;function Cm(a,e,t,n,r){a[e]=t,a[e+1]=n,a[e+2]=r}function Pa(a,e,t,n,r,i){a[e]=t,a[e+1]=n,a[e+2]=r,a[e+3]=i}function YT(a,e){return a-e}function qT(a){a.sort(YT);for(var e=[],t=[],n=0,r=a.length;n<r;++n){var i=a[n],s=(i|0)%2===0,o={first:!1,second:!1};s?(o.first=!0,o.second=n+1<r&&a[n+1]===a[n]+1,o.second&&++n):o.second=!0,e.push(Math.floor(i/2)),t.push(o)}return{indices:e,cylinderInfo:t}}function $T(a,e,t){for(var n=0,r=a.length;n<r;++n){var i=a[n];i.first||(e[Fn*n]=-.5),i.second||(t[Fn*n]=-.5)}}var x_=function(a){re(t,a);var e=XT(t);function t(n,r,i,s){var o;return G(this,t),o=e.call(this),o._useZSprites=i,o._cylGeometry=i?new Ci(2,2,1,1):new WT(1,1,1,Math.max(3,r),2,s),o._init(n,o._cylGeometry,o._useZSprites),o._collisionGeo=new Dh(n,3),o}return H(t,[{key:"setItem",value:function(r,i,s,o){var l=Je.calcCylinderMatrix(i,s,o),c=l.elements,u=r*Ht;this._collisionGeo.setItem(r,i,s,o),Pa(this._matVector1,u,c[0],c[4],c[8],c[12]),Pa(this._matVector2,u,c[1],c[5],c[9],c[13]),Pa(this._matVector3,u,c[2],c[6],c[10],c[14]),this._useZSprites&&(Em.copy(l).invert(),c=Em.elements,Pa(this._invmatVector1,u,c[0],c[4],c[8],c[12]),Pa(this._invmatVector2,u,c[1],c[5],c[9],c[13]),Pa(this._invmatVector3,u,c[2],c[6],c[10],c[14]))}},{key:"setColor",value:function(r,i,s){var o=r*Fn;ti.set(i),Cm(this._color1,o,ti.r,ti.g,ti.b),ti.set(s),Cm(this._color2,o,ti.r,ti.g,ti.b)}},{key:"computeBoundingSphere",value:function(){this._collisionGeo.computeBoundingSphere(),this.boundingSphere=this._collisionGeo.boundingSphere}},{key:"computeBoundingBox",value:function(){this._collisionGeo.computeBoundingBox(),this.boundingBox=this._collisionGeo.boundingBox}},{key:"raycast",value:function(r,i){this._collisionGeo.raycast(r,i)}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("matVector1").needsUpdate=!0,this.getAttribute("matVector2").needsUpdate=!0,this.getAttribute("matVector3").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("color2").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this._useZSprites&&(this.getAttribute("invmatVector1").needsUpdate=!0,this.getAttribute("invmatVector2").needsUpdate=!0,this.getAttribute("invmatVector3").needsUpdate=!0),this._collisionGeo.finishUpdate()}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(r,i){for(var s=this._alpha,o=0,l=r.length;o<l;++o)s[Math.floor(r[o]/2)]=i;this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubset",value:function(r){var i=qT(r),s=i.indices,o=s.length,l=new wi;return this._init.call(l,o,this._cylGeometry,this._useZSprites),ri(this._matVector1,l._matVector1,s,Ht),ri(this._matVector2,l._matVector2,s,Ht),ri(this._matVector3,l._matVector3,s,Ht),this._useZSprites&&(ri(this._invmatVector1,l._invmatVector1,s,Ht),ri(this._invmatVector2,l._invmatVector2,s,Ht),ri(this._invmatVector3,l._invmatVector3,s,Ht)),ri(this._color1,l._color1,s,Fn),ri(this._color2,l._color2,s,Fn),$T(i.cylinderInfo,l._color1,l._color2),l.boundingSphere=this.boundingSphere,l.boundingBox=this.boundingBox,[l]}},{key:"getGeoParams",value:function(){return this._cylGeometry.parameters}},{key:"_init",value:function(r,i,s){this.copy(i),this._matVector1=Se.allocateTyped(Float32Array,r*Ht),this._matVector2=Se.allocateTyped(Float32Array,r*Ht),this._matVector3=Se.allocateTyped(Float32Array,r*Ht),this._color1=Se.allocateTyped(Float32Array,r*Fn),this._color2=Se.allocateTyped(Float32Array,r*Fn);var o=this._alpha=Se.allocateTyped(Float32Array,r);le.fill(o,1),this.setAttribute("matVector1",new Mr(this._matVector1,Ht,!1,1)),this.setAttribute("matVector2",new Mr(this._matVector2,Ht,!1,1)),this.setAttribute("matVector3",new Mr(this._matVector3,Ht,!1,1)),this.setAttribute("color",new Mr(this._color1,Fn,!1,1)),this.setAttribute("color2",new Mr(this._color2,Fn,!1,1)),this.setAttribute("alphaColor",new Mr(this._alpha,1,!1,1)),s&&(this._invmatVector1=Se.allocateTyped(Float32Array,r*Ht),this._invmatVector2=Se.allocateTyped(Float32Array,r*Ht),this._invmatVector3=Se.allocateTyped(Float32Array,r*Ht),this.setAttribute("invmatVector1",new Mr(this._invmatVector1,Ht,!1,1)),this.setAttribute("invmatVector2",new Mr(this._invmatVector2,Ht,!1,1)),this.setAttribute("invmatVector3",new Mr(this._invmatVector3,Ht,!1,1)))}}]),t}(wi);function ZT(a){var e=KT();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function KT(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var rr=3,Wu=3,Na=new b,Ia=new b,Ol=new b,JT=new b(1,0,0),Am=new b,Tm=new b;function QT(a,e){for(var t=new at,n=a.length,r=n*e,i=r<=65536?Uint16Array:Uint32Array,s=(e-1)*n*2,o=new Ze(Se.allocateTyped(i,s*Wu),1),l=0,c=0,u=0;u<e;u++){if(u!==e-1)for(var f=0;f<n;f++){var h=l+f,d=l+n+f,p=l+n+(f+1)%n,v=l+(f+1)%n;o.setXYZ(c*Wu,h,v,d),c++,o.setXYZ(c*Wu,d,v,p),c++}l+=n}t.setIndex(o);var _=Se.allocateTyped(Float32Array,r*rr);return t.setAttribute("position",new Ze(_,rr)),t._positions=a,t}var e2=function(a){re(t,a);var e=ZT(t);function t(n,r,i){var s;G(this,t);var o=QT(n,r);s=e.call(this,o,i),s._ringsCount=r;for(var l=s._tmpShape=[],c=0;c<n.length;++c)l[c]=new b;return s}return H(t,[{key:"setItem",value:function(r,i){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,l=this._chunkGeo._positions.length,c=this._ringsCount,u=l*this._ringsCount*r*rr;this._setPoints(i,l,c,u),s?this._setSlopeNormals(l,c,u):this._setBaseNormals(l,c,u),o&&this._addCut(l,c,u)}},{key:"_setPoints",value:function(r,i,s,o){for(var l=this._tmpShape,c=this._positions,u=this._chunkGeo._positions,f=0,h=o;f<s;++f)for(var d=r[f],p=0;p<i;++p,h+=rr)l[p].copy(u[p]).applyMatrix4(d).toArray(c,h)}},{key:"_setBaseNormals",value:function(r,i,s){for(var o=r*rr,l=0,c=s;l<i;++l,c+=o)this._countNormalsInRing(r,c,!1)}},{key:"_setSlopeNormals",value:function(r,i,s){for(var o=this._normals,l=r*rr,c=s,u=0;u<r;++u,c+=rr)JT.toArray(o,c);if(c-2*l>0)for(var f=0;f<r;++f,c+=rr)Ol.fromArray(o,c-2*l).toArray(o,c);else this._countNormalsInRing(r,c,!0,+l),c+=l;for(var h=2;h<i;++h,c+=l)this._countNormalsInRing(r,c,!0,-l)}},{key:"_countNormalsInRing",value:function(r,i,s,o){var l=this._tmpShape,c=this._normals;l[0].fromArray(this._positions,i),l[r-1].fromArray(this._positions,i+(r-1)*rr);for(var u=0;u<r;++u,i+=rr)u<r-1&&l[u+1].fromArray(this._positions,i+rr),s?(Tm.fromArray(this._positions,i+o),Na.subVectors(l[(u+r-1)%r],l[(u+1)%r]).normalize(),Ia.subVectors(l[u],Tm).normalize(),Ol.crossVectors(Ia,Na).normalize().toArray(c,i)):(Na.subVectors(l[u],l[(u+r-1)%r]).normalize(),Ia.subVectors(l[u],l[(u+1)%r]).normalize(),Ol.addVectors(Na,Ia).normalize().toArray(c,i))}},{key:"_addCut",value:function(r,i,s){if(!(r<3||i<2)){var o=this._positions,l=this._normals,c=this._tmpShape,u=r*rr;c[0].fromArray(o,s),c[1].fromArray(o,s+rr),c[2].fromArray(o,s+2*rr),Na.subVectors(c[1],c[0]).normalize(),Ia.subVectors(c[1],c[2]).normalize(),Am.crossVectors(Na,Ia).normalize();for(var f=s,h=0;h<r*2;++h,f+=rr)Am.toArray(l,f);if(i>2)for(var d=0;d<r;++d,f+=rr)Ol.fromArray(o,f-u).toArray(o,f)}}}]),t}(Dc);function t2(a){var e=r2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function r2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var n2=65535,Fr=4,In=4,ni=3,ii=3,Or=new ze,yr=new b;function ai(a,e,t,n,r){a[e]=t,a[e+1]=n,a[e+2]=r}function Dl(a,e,t,n,r,i){a[e]=t,a[e+1]=n,a[e+2]=r,a[e+3]=i}function Fl(a,e,t,n){var r=e*Fr,i=r+t*Fr;return a.subarray(r*n,i*n)}var S_=function(a){re(t,a);var e=t2(t);function t(n){var r;return G(this,t),r=e.call(this),r._initVertices(n),r}return H(t,[{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.getAttribute("position").needsUpdate=!0,this.getAttribute("color").needsUpdate=!0,this.getAttribute("alphaColor").needsUpdate=!0,this.getAttribute("direction").needsUpdate=!0}},{key:"setColor",value:function(r,i){Or.set(i);var s=r*Fr*ii;ai(this._colors,s,Or.r,Or.g,Or.b),s+=ii,ai(this._colors,s,Or.r,Or.g,Or.b),s+=ii,ai(this._colors,s,Or.r,Or.g,Or.b),s+=ii,ai(this._colors,s,Or.r,Or.g,Or.b)}},{key:"setSegment",value:function(r,i,s){yr.subVectors(i,s),yr.normalize();var o=this._positions,l=this._directions,c=r*Fr*In,u=r*Fr*ni;Dl(o,c,i.x,i.y,i.z,.5),ai(l,u,yr.x,yr.y,yr.z),c+=In,u+=ni,Dl(o,c,i.x,i.y,i.z,-.5),ai(l,u,yr.x,yr.y,yr.z),c+=In,u+=ni,Dl(o,c,s.x,s.y,s.z,.5),ai(l,u,yr.x,yr.y,yr.z),c+=In,u+=ni,Dl(o,c,s.x,s.y,s.z,-.5),ai(l,u,yr.x,yr.y,yr.z)}},{key:"setOpacity",value:function(r,i,s){var o=r*Fr,l=i*Fr;le.fill(this.alpha,s,l,o),this.getAttribute("alphaColor").needsUpdate=!0}},{key:"getSubsetSegments",value:function(r,i){return[Fl(this._positions,r,i,In),Fl(this._directions,r,i,ni)]}},{key:"getSubsetColors",value:function(r,i){return Fl(this._colors,r,i,ii)}},{key:"getSubsetOpacities",value:function(r,i){return Fl(this._alpha,r,i,1)}},{key:"getNumVertexPerSegment",value:function(){return Fr}},{key:"getPositionSize",value:function(){return In}},{key:"setSegments",value:function(r,i){var s=r*Fr*In;if(i instanceof Array&&i.length===2){this._positions.set(i[0],s);var o=r*Fr*ni;this._directions.set(i[1],o)}else this._positions.set(i,s)}},{key:"setColors",value:function(r,i){var s=r*Fr*ii;this._colors.set(i,s)}},{key:"_initVertices",value:function(r){this._buffersSize=r*Fr;var i=this._buffersSize,s=i>n2;this._index=Se.allocateTyped(s?Uint32Array:Uint16Array,r*6),this._positions=Se.allocateTyped(Float32Array,i*In),this._colors=Se.allocateTyped(Float32Array,i*ii),this._directions=Se.allocateTyped(Float32Array,i*ni);var o=this._alpha=Se.allocateTyped(Float32Array,i);le.fill(o,1);for(var l=this._index,c=0,u=0,f=0;f<r;f++,c+=6,u+=Fr)l[c]=u,l[c+1]=u+1,l[c+2]=u+3,l[c+3]=u,l[c+4]=u+2,l[c+5]=u+3;this.setIndex(new Ze(this._index,1)),this.setAttribute("position",new Ze(this._positions,In)),this.setAttribute("color",new Ze(this._colors,ii)),this.setAttribute("alphaColor",new Ze(o,1)),this.setAttribute("direction",new Ze(this._directions,ni))}}]),t}(at);function i2(a){var e=a2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function a2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var b_=function(a){re(t,a);var e=i2(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var r=this.boundingBox,i=0,s=new b;r&&r.getCenter(s);for(var o=this._positions,l=this.boundingSphere||new Lr,c=this._positions.length,u=new b,f=this.getPositionSize(),h=0;h<c;h+=f){u.set(o[h],o[h+1],o[h+2]);var d=s.distanceToSquared(u);i<d&&(i=d)}l.set(s,Math.sqrt(i)),this.boundingSphere=l}},{key:"computeBoundingBox",value:function(){for(var r=this._positions,i=new Vt,s=this._positions.length,o=new b,l=this.getPositionSize(),c=0;c<s;c+=l)o.set(r[c],r[c+1],r[c+2]),i.expandByPoint(o);this.boundingBox=i}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}}]),t}(S_);function s2(a){var e=o2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function o2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Bl=3,ka=new b,Rm=new zt,l2=function(a){re(t,a);var e=s2(t);function t(n,r){var i;G(this,t);var s=new wo(1,1,1,Math.max(3,r),2,!0);i=e.call(this,s,n);var o=i._chunkSize;return i._chunkPos=i._chunkGeo.attributes.position.array,i._chunkNorms=i._chunkGeo.attributes.normal.array,i._tmpVector=Se.allocateTyped(Float32Array,o*Bl),i}return H(t,[{key:"setItem",value:function(r,i,s,o){var l=this._chunkSize,c=l*r*Bl,u=this._tmpVector,f=this._chunkPos,h=this._chunkNorms,d=Je.calcCylinderMatrix(i,s,o);Rm.getNormalMatrix(d);for(var p,v=0;v<l;++v)p=v*Bl,ka.fromArray(f,p),ka.applyMatrix4(d),ka.toArray(u,p);this._positions.set(u,c);for(var _=0;_<l;++_)p=_*Bl,ka.fromArray(h,p),ka.applyMatrix3(Rm),ka.toArray(u,p);this._normals.set(u,c)}}]),t}(Dc);function c2(a){var e=u2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function u2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var f2=.1,w_=function(a){re(t,a);var e=c2(t);function t(n,r,i){var s;return G(this,t),s=e.call(this,n*r),s._init(r),s._collisionGeo=i?new l2(n*r,3):null,s}return H(t,[{key:"startUpdate",value:function(){return!0}},{key:"computeBoundingSphere",value:function(){var r=this._collisionGeo;if(r){r.computeBoundingSphere(),this.boundingSphere=r.boundingSphere;return}xt(D(t.prototype),"computeBoundingSphere",this).call(this)}},{key:"computeBoundingBox",value:function(){var r=this._collisionGeo;if(r){r.computeBoundingBox(),this.boundingBox=r.boundingBox;return}xt(D(t.prototype),"computeBoundingBox",this).call(this)}},{key:"raycast",value:function(r,i){var s=this._collisionGeo;if(s){var o=this._chunkSize;this._collisionGeo.raycast(r,i);for(var l=0,c=i.length;l<c;++l){var u=i[l].chunkIdx;u!==void 0&&(u=u/o|0,i[l].chunkIdx=u)}}}},{key:"setColor",value:function(r,i){for(var s=this._chunkSize,o=r*s,l=o+s;o<l;++o)xt(D(t.prototype),"setColor",this).call(this,o,i)}},{key:"setSegment",value:function(r,i,s,o){var l=this._chunkSize,c=r*l+i;xt(D(t.prototype),"setSegment",this).call(this,c,s,o),this._collisionGeo&&this._collisionGeo.setItem(r*l+i,s,o,f2)}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"setOpacity",value:function(r,i){for(var s=this._chunkSize,o=0,l=r.length;o<l;++o){var c=r[o]*s;xt(D(t.prototype),"setOpacity",this).call(this,c,c+s-1,i)}}},{key:"getSubset",value:function(r){for(var i=r.length,s=this._chunkSize,o=new t(i,s,!1),l=0,c=r.length;l<c;++l){var u=l*s,f=r[l]*s;o.setSegments(u,this.getSubsetSegments(f,s)),o.setColors(u,this.getSubsetColors(f,s))}return o.boundingSphere=this.boundingSphere,o.boundingBox=this.boundingBox,[o]}},{key:"_init",value:function(r){this._chunkSize=r}}]),t}(b_);function h2(a){var e=d2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function d2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var p2=.3,Xu=new b,m2=function(a){re(t,a);var e=h2(t);function t(n){var r;return G(this,t),r=e.call(this,n*2),r._init(n),r._collisionGeo=new Dh(n,3),r}return H(t,[{key:"setItem",value:function(r,i,s){this._collisionGeo.setItem(r,i,s,p2);var o=2*r;Xu.lerpVectors(i,s,.5),xt(D(t.prototype),"setSegment",this).call(this,o,i,Xu),xt(D(t.prototype),"setSegment",this).call(this,o+1,Xu,s)}},{key:"setColor",value:function(r,i,s){var o=2*r;xt(D(t.prototype),"setColor",this).call(this,o,i),xt(D(t.prototype),"setColor",this).call(this,o+1,s)}},{key:"raycast",value:function(r,i){this._collisionGeo&&this._collisionGeo.raycast(r,i)}},{key:"getSubset",value:function(r){for(var i=r.length,s=new t(i),o=0,l=i;o<l;++o){var c=r[o];s.setSegments(o,this.getSubsetSegments(c,1)),s.setColors(o,this.getSubsetColors(c,1))}return s.boundingSphere=this.boundingSphere,s.boundingBox=this.boundingBox,[s]}},{key:"_init",value:function(r){this._segCounts=r*2}}]),t}(b_);function v2(a){var e=g2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function g2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Vi=[new b(1,0,0),new b(-1,0,0),new b(0,1,0),new b(0,-1,0),new b(0,0,1),new b(0,0,-1)],Lm=Vi.length,zl=new b,Vl=new b,_2=function(a){re(t,a);var e=v2(t);function t(n){return G(this,t),e.call(this,n,n,Lm/2|0,!1)}return H(t,[{key:"setItem",value:function(r,i,s){this.setSphere(r,i,s);for(var o=0;o<Lm/2;++o){var l=o*2;zl.x=i.x+Vi[l].x*s,zl.y=i.y+Vi[l].y*s,zl.z=i.z+Vi[l].z*s;var c=l+1;Vl.x=i.x+Vi[c].x*s,Vl.y=i.y+Vi[c].y*s,Vl.z=i.z+Vi[c].z*s,this.setSegment(r,o,zl,Vl)}}}]),t}(Oh(w_));function y2(a){var e=x2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function x2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Pm=4,Nm=3,Ul=new ze,M_=function(a){re(t,a);var e=y2(t);function t(n,r){var i;return G(this,t),i=e.call(this),i._opts=r,i.zClip=i._opts.zClip,i._posRad=Se.allocateTyped(Float32Array,n*Pm),i._colors=Se.allocateTyped(Float32Array,n*Nm),i}return H(t,[{key:"setItem",value:function(r,i,s){var o=this._posRad,l=Pm*r;o[l++]=i.x,o[l++]=i.y,o[l++]=i.z,o[l]=s}},{key:"setColor",value:function(r,i){Ul.set(i);var s=this._colors,o=Nm*r;s[o++]=Ul.r,s[o++]=Ul.g,s[o]=Ul.b}},{key:"finalize",value:function(){this.finishUpdate(),this.computeBoundingSphere()}},{key:"finishUpdate",value:function(){this._build()}},{key:"setOpacity",value:function(){}},{key:"raycast",value:function(){}},{key:"getSubset",value:function(){return[]}}]),t}(at),Fh=function(){function a(){G(this,a),this.pointsValuesLinear=null,this.hasIntersection=null,this.bitsInside=null}return H(a,[{key:"create",value:function(t){var n=117440512,r=t*t*t;if(r>n)throw new Error("Too large cube dimension: lead to memory huge uasge");return this.pointsValuesLinear=Se.allocateTyped(Float32Array,32*r),this.hasIntersection=Se.allocateTyped(Int32Array,r),this.bitsInside=Se.allocateTyped(Int32Array,r),0}},{key:"destroy",value:function(){this.bitsInside=null,this.hasIntersection=null,this.pointsValuesLinear=null}}]),a}();Fh.prototype.striIndicesMarchCube=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];var Im=[0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0];function S2(a,e,t){var n=a.getValue(e.x,e.y,e.z);t.set(n[0],n[1],n[2])}var b2=H(function a(){G(this,a),this._arrSize=8,this.p=new Array(this._arrSize),this.g=new Array(this._arrSize),this.val=new Array(this._arrSize);for(var e=0;e<this._arrSize;++e)this.p[e]=new b,this.g[e]=new b;this.cubeIndex=0}),w2=H(function a(){G(this,a),this.a={p:new b,n:new b},this.b={p:new b,n:new b},this.c={p:new b,n:new b}});function E_(a){for(var e=new Array(a),t=0;t<a;++t)e[t]=new b;return e}var Gn=function(){function a(){G(this,a),this._numTriangles=0,this._numVertices=0,this._position=[],this._normals=[],this._colors=null,this._indices=[],this._volumetricData=null,this._xAxis=new b,this._yAxis=new b,this._zAxis=new b,this._xDir=new b,this._yDir=new b,this._zDir=new b}return H(a,[{key:"_prepareAxesAndDirs",value:function(){var t=this._volumetricData,n=t.getCellSize(),r=this._xAxis,i=this._yAxis,s=this._zAxis,o=this._xDir,l=this._yDir,c=this._zDir;r.set(n.x,0,0),i.set(0,n.y,0),s.set(0,0,n.z),o.set(1,0,0),l.set(0,1,0),c.set(0,0,1);var u=new b;if(u.crossVectors(o,l),u.dot(c)<0&&(o.negate(),l.negate(),c.negate()),o.x<0||o.y<0||o.z<0||l.x<0||l.y<0||l.z<0||c.x<0||c.y<0||c.z<0)return!1;var f=function(d){return Math.abs(d)>Number.EPSILON};return!(f(r.y)||f(r.z)||f(i.x)||f(i.z)||f(s.x)||f(s.y))}},{key:"_vertexInterp",value:function(t,n,r,i,s,o){var l=n.p[r],c=n.p[i],u=n.g[r],f=n.g[i],h=n.val[r],d=n.val[i],p=t-h,v=d-h,_=0;Math.abs(v)>0&&(_=p/v),_=_>1?1:_,s.lerpVectors(l,c,_),o.lerpVectors(u,f,_)}},{key:"_polygonize",value:function(t,n,r){for(var i=t.cubeIndex,s=0,o=a._arrSize,l=a._firstIndices,c=a._secondIndices,u=a._vertexList,f=a._normalList;s<o;++s)Im[i]&1<<s&&this._vertexInterp(n,t,l[s],c[s],u[s],f[s]);var h=0,d=i*16,p=a._triTable;for(s=0;p[d+s]!==-1;s+=3)r[h].a.p.copy(u[p[d+s]]),r[h].a.n.copy(f[p[d+s]]),r[h].b.p.copy(u[p[d+s+1]]),r[h].b.n.copy(f[p[d+s+1]]),r[h].c.p.copy(u[p[d+s+2]]),r[h].c.n.copy(f[p[d+s+2]]),++h;return h}},{key:"_doGridPosNorms",value:function(t,n,r){for(var i=this._volumetricData,s=this._volumetricData.getData(),o=i.getDimensions(),l=o[0],c=o[1],u=o[2],f=n*i.getStrideX(),h=n*i.getStrideY(),d=n*i.getStrideZ(),p=new b2,v=p.val,_=p.val.length,m=[new b(0,0,0),new b(n,0,0),new b(n,n,0),new b(0,n,0),new b(0,0,n),new b(n,0,n),new b(n,n,n),new b(0,n,n)],g=5,y=new Array(g),x=0;x<g;++x)y[x]=new w2;var S,M=this,E=this._position,N=this._normals;r?S=function(){var X=new b(M._xAxis.x,M._yAxis.y,M._zAxis.z);return function(Y){var ne=Y.p.clone();ne.multiply(X),E.push(ne.add(M._origin)),N.push(Y.n.clone())}}():S=function(){var X=new zt;X.set(M._xAxis.x,M._yAxis.x,M._zAxis.x,M._xAxis.y,M._yAxis.y,M._zAxis.y,M._xAxis.z,M._yAxis.z,M._zAxis.z);var Y=new zt;return Y.set(M._xDir.x,M._yDir.x,M._zDir.x,M._xDir.y,M._yDir.y,M._zDir.y,M._xDir.z,M._yDir.z,M._zDir.z),function(ne){E.push(ne.p.clone().applyMatrix3(X).add(M._origin)),N.push(ne.n.clone().applyMatrix3(Y))}}();for(var B=this._indices,V=0,O=0;O<u-n;O+=n)for(var W=0;W<c-n;W+=n)for(var z=i.getDirectIdx(0,W,O),C=0;C<l-n;C+=n,z+=f){v[0]=s[z],v[1]=s[z+f],v[3]=s[z+h],v[2]=s[z+f+h],v[4]=s[z+d],v[5]=s[z+f+d],v[7]=s[z+h+d],v[6]=s[z+f+h+d];for(var T=0,A=0;A<_;++A)v[A]<t&&(T|=1<<A);if(Im[T]!==0){for(p.cubeIndex=T,A=0;A<_;++A)p.p[A].set(C+m[A].x,W+m[A].y,O+m[A].z),S2(this._gradient,p.p[A],p.g[A]);var F=this._polygonize(p,t,y);for(V+=F,A=0;A<F;++A)B.push(this._numTriangles*3),B.push(this._numTriangles*3+1),B.push(this._numTriangles*3+2),++this._numTriangles,S(y[A].a),S(y[A].b),S(y[A].c)}}return V}},{key:"compute",value:function(t,n,r,i){this._volumetricData=t,this._origin=n,this._gradient=t.computeGradient(),this._doGridPosNorms(r,i,this._prepareAxesAndDirs())}},{key:"_remapIndices",value:function(t,n){for(var r=this._indices,i=Se.allocateTyped(Uint32Array,n),s=0;s<n;++s)r[s]=t[r[s]],i[s]=r[s];this._indices=i}},{key:"_remapVertices",value:function(t,n,r){for(var i=Se.allocateTyped(Float32Array,r*3),s=Se.allocateTyped(Float32Array,r*3),o=0;o<r;++o){var l=t[o];i[o*3]=l.x,i[o*3+1]=l.y,i[o*3+2]=l.z;var c=n[o].normalize();s[o*3]=c.x,s[o*3+1]=c.y,s[o*3+2]=c.z}this._position=i,this._normals=s}},{key:"vertexFusion",value:function(t,n){var r=this._indices.length,i=this._position,s=this._normals,o=i.length|0;if(!(r===0||o===0)){var l=Se.allocateTyped(Uint32Array,o);l[0]=0;for(var c=1,u=1;u<o;++u){for(var f=c-t<0?0:c-t,h=f+n>c?c:f+n,d=-1,p=f;p<h;++p)if(Math.abs(i[u]-i[p])<Number.EPSILON){d=p;break}d!==-1?l[u]=d:(i[c].copy(i[u]),s[c].copy(s[u]),l[u]=c,++c)}this._remapIndices(l,r),this._remapVertices(i,s,c)}}},{key:"setColorVolTex",value:function(t,n,r,i){var s,o,l=this._position.length/3,c=this._position,u=this._origin,f=this._volumetricData.getDimensions(),h=f[0]-1,d=f[1]-1,p=f[2]-1,v=t.getData(),_=t.getStrideX(),m=t.getStrideY(),g=t.getStrideZ(),y,x,S,M;i!==null&&(y=r.getData(),x=r.getStrideX(),S=r.getStrideY(),M=r.getStrideZ());var E=1/this._xAxis.x,N=1/this._yAxis.y,B=1/this._zAxis.z,V=[],O=[],W=Se.allocateTyped(Float32Array,l*3);function z(ke,De,w,L){L[0]=(1-ke)*v[De]+ke*v[w],L[1]=(1-ke)*v[De+1]+ke*v[w+1],L[2]=(1-ke)*v[De+2]+ke*v[w+2]}function C(ke,De,w,L){var R=n[ke];if(R!=null){V[R.index]=R;var j=De*w*L*y[ke];typeof O[R.index]>"u"?O[R.index]=j:O[R.index]+=j}}var T=Se.allocateTyped(Int32Array,l),A=0;for(s=0;s<l;s++){var F=s*3,X=(c[F]-u.x)*E,Y=(c[F+1]-u.y)*N,ne=(c[F+2]-u.z)*B,ae=Math.min(Math.max(X,0),h)|0,xe=Math.min(Math.max(Y,0),d)|0,be=Math.min(Math.max(ne,0),p)|0,ge=X-ae,we=Y-xe,q=ne-be;if(i!=null){V=[],O=[],o=r.getDirectIdx(ae,xe,be),C(o,1-ge,1-we,1-q),C(o+x,ge,1-we,1-q),C(o+S,1-ge,we,1-q),C(o+x+S,ge,we,1-q),C(o+M,1-ge,1-we,q),C(o+x+M,ge,1-we,q),C(o+S+M,1-ge,we,q),C(o+x+S+M,ge,we,q);var Ge=0,Te=-1;for(var Pe in O)O[Pe]>Ge&&(Te=Pe,Ge=O[Pe]);if(Te<0||!i.includesAtom(V[Te])){T[s]=-1;continue}}T[s]=A++;var Ee=ae<h?_:0,_e=xe<d?m:0,ie=be<p?g:0,oe=[0,0,0],K=[0,0,0],de=[0,0,0],he=[0,0,0];o=t.getDirectIdx(ae,xe,be),z(ge,o,o+Ee,oe),z(ge,o+_e,o+Ee+_e,K),z(ge,o+ie,o+Ee+ie,de),z(ge,o+_e+ie,o+Ee+_e+ie,he);var I=[0,0,0];I[0]=(1-we)*oe[0]+we*K[0],I[1]=(1-we)*oe[1]+we*K[1],I[2]=(1-we)*oe[2]+we*K[2];var P=[0,0,0];P[0]=(1-we)*de[0]+we*he[0],P[1]=(1-we)*de[1]+we*he[1],P[2]=(1-we)*de[2]+we*he[2],W[F]=(1-q)*I[0]+q*P[0],W[F+1]=(1-q)*I[1]+q*P[1],W[F+2]=(1-q)*I[2]+q*P[2]}if(this._colors=W,i!=null){for(s=0;s<l;++s){var ee=T[s];ee<0||(this._position[ee*3]=this._position[s*3],this._position[ee*3+1]=this._position[s*3+1],this._position[ee*3+2]=this._position[s*3+2],this._normals[ee*3]=this._normals[s*3],this._normals[ee*3+1]=this._normals[s*3+1],this._normals[ee*3+2]=this._normals[s*3+2],this._colors[ee*3]=this._colors[s*3],this._colors[ee*3+1]=this._colors[s*3+1],this._colors[ee*3+2]=this._colors[s*3+2])}var pe=this._indices.length/3,Me=0;for(s=0;s<pe;++s){var Re=T[this._indices[3*s]],He=T[this._indices[3*s+1]],Oe=T[this._indices[3*s+2]];Re>=0&&He>=0&&Oe>=0&&(this._indices[3*Me]=Re,this._indices[3*Me+1]=He,this._indices[3*Me+2]=Oe,++Me)}this._position=new Float32Array(this._position.buffer.slice(0,A*3*4)),this._normals=new Float32Array(this._normals.buffer.slice(0,A*3*4)),this._colors=new Float32Array(this._colors.buffer.slice(0,A*3*4)),this._indices=new Uint32Array(this._indices.buffer.slice(0,Me*3*4))}}},{key:"toMesh",value:function(){var t=new at;return t.setIndex(new Ze(this._indices,1)),t.setAttribute("position",new Ze(this._position,3)),t.setAttribute("normal",new Ze(this._normals,3)),t.setAttribute("color",new Ze(this._colors,3)),t.computeBoundingSphere(),t}}]),a}();Le(Gn,"_triTable",Fh.prototype.striIndicesMarchCube);Le(Gn,"_arrSize",12);Le(Gn,"_firstIndices",[0,1,2,3,4,5,6,7,0,1,2,3]);Le(Gn,"_secondIndices",[1,2,3,0,5,6,7,4,4,5,6,7]);Le(Gn,"_vertexList",E_(Gn._arrSize));Le(Gn,"_normalList",E_(Gn._arrSize));function M2(a){var e=E2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function E2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var C_=function(a){re(t,a);var e=M2(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){var r=this._opts;this.numVoxels=[128,128,128],this.xAxis=new b(1,0,0),this.yAxis=new b(0,1,0),this.zAxis=new b(0,0,1),this.origin=new b(0,0,0),this._visibilitySelector=r.visibilitySelector,this._calcSurface(r)}},{key:"_findMinMax",value:function(r){for(var i=4,s=r.length/i,o=[r[0],r[1],r[2],r[3]],l=[r[0],r[1],r[2],r[3]],c=1;c<s;++c)for(var u=c*i,f=0;f<i;++f){var h=r[u+f];o[f]=Math.max(h,o[f]),l[f]=Math.min(h,l[f])}return{maxPosRad:o,minPosRad:l}}},{key:"_findNumVoxels",value:function(r,i){var s=this.numVoxels,o=this._findMinMax(r),l=o.minPosRad,c=o.maxPosRad;l[3]>4&&(i.gridSpacing*=l[3]);var u=i.radScale*c[3]*1.7,f=u;f=.65*Math.sqrt(4/3*Math.PI*f*f*f),u=Math.max(u,f);for(var h=0;h<3;++h)l[h]-=u,c[h]+=u;for(h=0;h<3;++h)s[h]=Math.ceil((c[h]-l[h])/i.gridSpacing);this.xAxis.x=(s[0]-1)*i.gridSpacing,this.yAxis.y=(s[1]-1)*i.gridSpacing,this.zAxis.z=(s[2]-1)*i.gridSpacing;var d=Lt(l,3);return this.origin.x=d[0],this.origin.y=d[1],this.origin.z=d[2],{bbox:o,dim:s}}},{key:"_makeSurface",value:function(r,i){var s=new Gn;s.compute(r.volMap,this.origin,i.isoValue,1),s.vertexFusion(9,9),s._numTriangles>0?(s.setColorVolTex(r.volTexMap,r.atomMap,r.atomWeightMap,this._visibilitySelector),this.setIndex(new Ze(s._indices,1)),this.setAttribute("position",new Ze(s._position,3)),this.setAttribute("normal",new Ze(s._normals,3)),this.setAttribute("color",new Ze(s._colors,3))):this.setAttribute("position",new Ze(Se.allocateTyped(Float32Array,0),3))}},{key:"_calcSurface",value:function(r){var i={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};if(i.posRad.length!==0){var s=this._findNumVoxels(i.posRad,r),o=new Vt(this.origin,new b(this.xAxis.x,this.yAxis.y,this.zAxis.z).add(this.origin)),l=this._computeSurface(i,o,s,r);this._makeSurface(l,r)}}}]),t}(M_);function C2(a){var e=A2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function A2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ju=qe.Volume,T2=function(a){re(t,a);var e=C2(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_computeSurface",value:function(r,i,s,o){this._shiftByOrigin(r.posRad);var l={volMap:new ju(Float32Array,this.numVoxels,i),volTexMap:new ju(Float32Array,this.numVoxels,i,3)};return this._visibilitySelector!=null&&(l.atomMap=[],l.atomWeightMap=new ju(Float32Array,this.numVoxels,i)),this.gaussdensity(l,r,null,o),l}},{key:"gaussdensity",value:function(r,i,s,o){var l=i.posRad.length/4,c=i.posRad,u=i.colors,f=this.numVoxels,h=o.radScale,d=o.gaussLim,p=o.gridSpacing,v=1/o.isoValue,_=1/p,m=f[0]-1,g=f[1]-1,y=f[2]-1,x=r.volMap,S=r.volTexMap,M=x.getData(),E=x.getStrideX(),N=S.getData(),B=S.getStrideX(),V;this._visibilitySelector!=null&&(V=r.atomWeightMap.getData());for(var O=r.atomMap,W=0;W<l;++W){var z=W*4,C=c[z+3]*h,T=s===null?1:s[W],A=1/(2*C*C),F=d*C,X=F*F;F*=_;var Y=c[z]*_,ne=Math.max(Y-F|0,0),ae=Math.min(Y+F|0,m);Y=c[z+1]*_;var xe=Math.max(Y-F|0,0),be=Math.min(Y+F|0,g);Y=c[z+2]*_;for(var ge=Math.max(Y-F|0,0),we=Math.min(Y+F|0,y),q=ge*p-c[z+2],Ge=ge;Ge<=we;++Ge,q+=p)for(var Te=xe*p-c[z+1],Pe=xe;Pe<=be;++Pe,Te+=p){var Ee=Te*Te+q*q;if(!(Ee>=X))for(var _e=x.getDirectIdx(ne,Pe,Ge),ie=S.getDirectIdx(ne,Pe,Ge),oe=ne*p-c[z],K=ne;K<=ae;++K,oe+=p,_e+=E,ie+=B){var de=oe*oe+Ee,he=-de*A,I=Math.exp(he)*T;this._visibilitySelector!=null&&I>V[_e]&&(V[_e]=I,O[_e]=i.atoms[W]),M[_e]+=I,I*=v;var P=W*3;N[ie]+=I*u[P],N[ie+1]+=I*u[P+1],N[ie+2]+=I*u[P+2]}}}}},{key:"_shiftByOrigin",value:function(r){for(var i=this.origin.x,s=this.origin.y,o=this.origin.z,l=4,c=r.length/l,u=0;u<c;++u){var f=u*l;r[f]-=i,r[f+1]-=s,r[f+2]-=o}}}]),t}(C_);function R2(a,e,t,n){var r=4,i=a.length/r,s=e[0],o=e[1],l=e[2],c=t[0],u=t[1],f=t[2];function h(A,F){return Math.floor((A-F)/n)}var d=h(c,s)+1,p=h(u,o)+1,v=h(f,l)+1,_=d*p*v,m=p*v,g=function(F,X,Y){return(h(F,s)*p+h(X,o))*v+h(Y,l)},y=[],x,S;for(x=0;x<i;x++){var M=r*x;S=g(a[M],a[M+1],a[M+2]),y[S]===void 0?y[S]=[x]:y[S].push(x)}var E=Se.allocateTyped(Uint32Array,_),N=Se.allocateTyped(Uint16Array,_),B=Se.allocateTyped(Uint32Array,i),V=0,O=0,W;for(x=0;x<_;x++){var z=E[x]=V,C=y[x];if(C!==void 0)for(W=0;W<C.length;W++)B[V]=C[W],V++;var T=V-z;N[x]=T,T>O&&(O=T)}this.neighbourListLength=27*O+1,this.withinRadii=function(A,F,X,Y,ne){var ae=0,xe=h(A,s),be=h(F,o),ge=h(X,l),we=Math.max(0,xe-1),q=Math.max(0,be-1),Ge=Math.max(0,ge-1),Te=Math.min(d-1,xe+1),Pe=Math.min(p-1,be+1),Ee=Math.min(v-1,ge+1);for(x=we;x<=Te;++x){var _e=x*m;for(W=q;W<=Pe;++W)for(var ie=W*v,oe=Ge;oe<=Ee;++oe){S=_e+ie+oe;for(var K=E[S],de=K+N[S],he=K;he<de;he++){var I=B[he],P=r*I,ee=a[P]-A,pe=a[P+1]-F,Me=a[P+2]-X,Re=a[P+3]+Y;ee*ee+pe*pe+Me*Me<=Re*Re&&(ne[ae++]=B[he])}}}ne[ae]=-1}}function L2(a,e,t,n){var r=4,i=a.posRad,s=a.colors,o=a.atoms,l=i.length/r,c=e.bbox,u=c.minPosRad,f=c.maxPosRad,h,d,p,v,_,m=-1,g,y,x,S,M=null,E=null,N=null,B,V,O,W,z,C,T,A=new b(0,0,0),F=new b(0,0,0),X=new b(0,0,0),Y;function ne(K,de,he){for(var I=Se.allocateTyped(K,de),P=0;P<de;++P)I[P]=he;return I}function ae(K,de,he){for(var I=0;I<K.length;I++)K[I]=de+he*I}function xe(){v=t.scaleFactor,g=e.dim,Y=Math.min(5,2+Math.floor(p*v));var K=g[0]*g[1]*g[2];y=ne(Float32Array,K,-1001),x=Se.allocateTyped(Float32Array,K*3),S=Se.allocateTyped(Float32Array,K),N&&(M=Se.allocateTyped(Float32Array,K),E=[]),B=Se.allocateTyped(Float32Array,g[0]),V=Se.allocateTyped(Float32Array,g[1]),O=Se.allocateTyped(Float32Array,g[2]),ae(B,u[0],1/v),ae(V,u[1],1/v),ae(O,u[2],1/v)}function be(){var K=0,de=2*Math.PI/_;z=Se.allocateTyped(Float32Array,_),W=Se.allocateTyped(Float32Array,_);for(var he=0;he<_;he++)z[he]=Math.cos(K),W[he]=Math.sin(K),K+=de}function ge(){C=new R2(i,u,f,2.01*d),T=new Int32Array(C.neighbourListLength)}function we(){p=t.probeRadius,v=t.scaleFactor,_=t.probePositions,N=t.visibilitySelector,h=Se.allocateTyped(Float32Array,l),d=0;for(var K=0;K<l;++K){var de=i[K*r+3]+=p;de>d&&(d=de),h[K]=de*de}xe(),be(),ge(),m=-1}function q(K,de,he,I){var P=r*K,ee=h[K],pe=i[P]-de,Me=i[P+1]-he,Re=i[P+2]-I,He=pe*pe+Me*Me+Re*Re;return He<ee}function Ge(K,de,he,I,P){var ee;if(m!==-1){if(ee=m,ee!==I&&ee!==P&&q(ee,K,de,he))return ee;m=-1}var pe=0;for(ee=T[pe];ee>=0;){if(ee!==I&&ee!==P&&q(ee,K,de,he))return m=ee,ee;ee=T[++pe]}return m=-1,-1}function Te(){for(var K=4,de=K/3,he=1/(2*de*de),I=0;I<l;I++){var P=r*I,ee=i[P],pe=i[P+1],Me=i[P+2],Re=i[P+3],He=h[I];C.withinRadii(ee,pe,Me,Re,T);for(var Oe=Math.ceil(Re*v),ke=Math.floor(v*(ee-u[0])),De=Math.floor(v*(pe-u[1])),w=Math.floor(v*(Me-u[2])),L=Math.max(0,ke-Oe),R=Math.max(0,De-Oe),j=Math.max(0,w-Oe),U=Math.min(g[0],ke+Oe+2),me=Math.min(g[1],De+Oe+2),ye=Math.min(g[2],w+Oe+2),Ne=I*3,Ve=s[Ne],Ie=s[Ne+1],et=s[Ne+2],gt=j;gt<ye;gt++)for(var Mt=O[gt]-Me,ot=g[1]*g[0]*gt,Fe=R;Fe<me;Fe++)for(var Xe=V[Fe]-pe,$=Mt*Mt+Xe*Xe,nt=ot+g[0]*Fe,Z=L;Z<U;Z++){var ut=Z+nt,ce=B[Z]-ee,_t=$+ce*ce;if(_t<He){var Ct=Math.exp(-_t*he),Hr=ut*3;x[Hr]+=Ve*Ct,x[Hr+1]+=Ie*Ct,x[Hr+2]+=et*Ct,S[ut]+=Ct,N!==null&&Ct>M[ut]&&(M[ut]=Ct,E[ut]=o[I]),y[ut]<0&&(y[ut]=-y[ut]);var Wr=Math.sqrt(_t),or=Re/Wr,k=ce*or,te=Xe*or,J=Mt*or;if(k+=ee,te+=pe,J+=Me,Ge(k,te,J,I,-1)===-1){var se=Re-Wr;se<y[ut]&&(y[ut]=se)}}}}}function Pe(K,de){return K.x=K.y=K.z=1,de.x!==0?K.x=(de.y+de.z)/-de.x:de.y!==0?K.y=(de.x+de.z)/-de.y:de.z!==0&&(K.z=(de.x+de.y)/-de.z),K}function Ee(K,de){var he=r*K,I=r*de,P=i[he],ee=i[he+1],pe=i[he+2],Me=i[he+3],Re=A.x=i[I]-P,He=A.y=i[I+1]-ee,Oe=A.z=i[I+2]-pe,ke=i[I+3],De=Re*Re+He*He+Oe*Oe,w=Math.sqrt(De),L=(Me*Me+w*w-ke*ke)/(2*Me*w),R=Me*L;A.normalize(),Pe(F,A),F.normalize(),X.crossVectors(A,F),X.normalize();var j=Math.sqrt(Me*Me-R*R);F.multiplyScalar(j),X.multiplyScalar(j),A.multiplyScalar(R),A.x+=P,A.y+=ee,A.z+=pe,m=-1;for(var U=Y,me=0;me<_;me++){var ye=z[me],Ne=W[me],Ve=A.x+ye*F.x+Ne*X.x,Ie=A.y+ye*F.y+Ne*X.y,et=A.z+ye*F.z+Ne*X.z;if(Ge(Ve,Ie,et,K,de)===-1)for(var gt=Math.floor(v*(Ve-u[0])),Mt=Math.floor(v*(Ie-u[1])),ot=Math.floor(v*(et-u[2])),Fe=Math.max(0,gt-U),Xe=Math.max(0,Mt-U),$=Math.max(0,ot-U),nt=Math.min(g[0],gt+U+2),Z=Math.min(g[1],Mt+U+2),ut=Math.min(g[2],ot+U+2),ce=$;ce<ut;ce++){Oe=et-O[ce];for(var _t=g[1]*g[0]*ce,Ct=Xe;Ct<Z;Ct++){He=Ie-V[Ct];for(var Hr=Oe*Oe+He*He,Wr=_t+g[0]*Ct,or=Fe;or<nt;or++){Re=Ve-B[or],De=Hr+Re*Re;var k=or+Wr,te=y[k];te>0&&De<te*te&&(y[k]=Math.sqrt(De))}}}}}function _e(){for(var K=0;K<l;K++){var de=r*K;C.withinRadii(i[de],i[de+1],i[de+2],i[de+3],T);for(var he=0,I=T[he];I>=0;)K<I&&Ee(K,I),I=T[++he]}}function ie(){for(var K=0,de=y.length;K<de;K++){y[K]<0&&(y[K]=0);var he=S[K];if(he>0){he=1/he;var I=K*3;x[I]*=he,x[I+1]*=he,x[I+2]*=he}}}function oe(){console.time("ContactSurface.getVolume"),console.time("ContactSurface.init"),we(),console.timeEnd("ContactSurface.init"),console.time("ContactSurface.projectPoints"),Te(),console.timeEnd("ContactSurface.projectPoints"),console.time("ContactSurface.projectTorii"),_e(),console.timeEnd("ContactSurface.projectTorii"),ie(),console.timeEnd("ContactSurface.getVolume")}this.build=function(){oe(),this.volTexMap=x,this.weightsMap=M,this.atomMap=E,this.volMap=y}}function P2(a){var e=N2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function N2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Yu=qe.Volume,I2=function(a){re(t,a);var e=P2(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_computeSurface",value:function(r,i,s,o){var l=new L2(r,s,o);l.build();var c={volMap:new Yu(Float32Array,this.numVoxels,i,1,l.volMap),volTexMap:new Yu(Float32Array,this.numVoxels,i,3,l.volTexMap),atomMap:l.atomMap,atomWeightMap:new Yu(Float32Array,this.numVoxels,i,1,l.weightsMap)};return c}}]),t}(C_),k2=H(function a(e,t){G(this,a),this.coord=new b,this.coord.copy(e),this.radius=t,this.colorX=.99999,this.colorY=0,this.colorZ=0,this.atomType=0,this.srcAtom=null}),O2=function(){function a(e,t,n,r,i){G(this,a),this._numAtoms=e,this._atoms=t,this._vBoxMin=new b,this._vBoxMax=new b,this._vBoxMin.copy(n),this._vBoxMax.copy(r),this._probeRadius=i,this._atomsList=null,this._voxelList=null}return H(a,[{key:"createVoxels",value:function(){var t,n,r=4.5,i=this._numAtoms|0,s=this._atoms,o=this._vBoxMax.x-this._vBoxMin.x,l=this._vBoxMax.y-this._vBoxMin.y,c=this._vBoxMax.z-this._vBoxMin.z,u=o<l?o:l;u=c<u?c:u;var f=0,h=0,d;for(d=0;d<i;d++)n=(s[d].radius+this._probeRadius)*2,f=n>f?n:f,h+=n;var p=Math.floor(u/f);p<2&&(p=2),h/=i,this._numCells=p,this._aveRad=h,this._maxRad=f;var v=p,_=p*p,m=p*p*p,g=this._xScale=1/(this._vBoxMax.x-this._vBoxMin.x),y=this._yScale=1/(this._vBoxMax.y-this._vBoxMin.y),x=this._zScale=1/(this._vBoxMax.z-this._vBoxMin.z),S=0,M=g*p,E=y*p,N=x*p;for(d=0;d<i;d++){var B=(s[d].radius+this._probeRadius)*r,V=B*2,O=Math.floor(M*V+.8),W=Math.floor(E*V+.8),z=Math.floor(N*V+.8);O++,W++,z++,S+=O*W*z}this._voxelList=Se.allocateTyped(Int32Array,m);var C=[];if(C.length=S,this._voxelList===null||C===null)return-1;for(d=0;d<m;d++)this._voxelList[d]=-1;for(t=0,d=0;d<i;d++){n=(s[d].radius+this._probeRadius)*r;var T=Math.floor((s[d].coord.x-this._vBoxMin.x-n)*p*g),A=Math.floor((s[d].coord.y-this._vBoxMin.y-n)*p*y),F=Math.floor((s[d].coord.z-this._vBoxMin.z-n)*p*x),X=Math.floor((s[d].coord.x-this._vBoxMin.x+n)*p*g),Y=Math.floor((s[d].coord.y-this._vBoxMin.y+n)*p*y),ne=Math.floor((s[d].coord.z-this._vBoxMin.z+n)*p*x);T=T>=0?T:0,A=A>=0?A:0,F=F>=0?F:0,X=X<p?X:p-1,Y=Y<p?Y:p-1,ne=ne<p?ne:p-1;for(var ae=F;ae<=ne;ae++)for(var xe=A;xe<=Y;xe++)for(var be=T;be<=X;be++){var ge=be+xe*v+ae*_;if(this._voxelList[ge]<0){C[t*2+0]=d,C[t*2+1]=-1,this._voxelList[ge]=t,t++;continue}var we=this._voxelList[ge];this._voxelList[ge]=t,C[t*2+0]=d,C[t*2+1]=we,t++}}return this._atomsList=Int32Array.from(C),0}},{key:"destroyVoxels",value:function(){this._atomsList=null,this._voxelList=null,this._atoms=null,this._vertices=null,this._vBoxMin=null,this._vBoxMax=null}},{key:"forEachRelatedAtom",value:function(t,n){for(var r=Math.floor((t.x-this._vBoxMin.x)*this._numCells*this._xScale),i=Math.floor((t.y-this._vBoxMin.y)*this._numCells*this._yScale),s=Math.floor((t.z-this._vBoxMin.z)*this._numCells*this._zScale),o=r+i*this._numCells+s*this._numCells*this._numCells,l=this._atoms,c=this._voxelList[o];c>=0;c=this._atomsList[c*2+1]){var u=this._atomsList[c*2];n(l[u])}}},{key:"getClosestAtom",value:function(t){var n=null,r=Number.MAX_VALUE;return this.forEachRelatedAtom(t,function(i){var s=t.distanceToSquared(i.coord);s<r&&(r=s,n=i)}),n}},{key:"buildNormals",value:function(t,n,r){for(var i=this,s=0,o=0,l=0,c=0,u,f=0,h=0,d=0,p=0,v=0,_=2.5,m=.1,g=this._aveRad*_,y=g*g,x=-this._aveRad*m,S=function(N){var B=o-N.coord.x,V=l-N.coord.y,O=c-N.coord.z;if(u=B*B+V*V+O*O,!(u>y)){var W=N.radius+i._probeRadius;p=u-W*W,p<0&&(p=-p),v=Math.exp(x*p),f+=B*v,h+=V*v,d+=O*v,s++}},M=0;M<t;M++)o=n[M].x,l=n[M].y,c=n[M].z,s=0,f=h=d=0,this.forEachRelatedAtom(n[M],S),u=f*f+h*h+d*d,s>0&&(p=1/Math.sqrt(u),f*=p,h*=p,d*=p),r[M].x=f,r[M].y=h,r[M].z=d;return 0}},{key:"buildColors",value:function(t,n,r,i){for(var s=this,o=0,l=0,c=0,u=0,f=0,h=.8,d=i,p=d*d,v=[],_=[],m=0,g=function(E){var N=o-E.coord.x,B=l-E.coord.y,V=c-E.coord.z,O=N*N+B*B+V*V;if(!(O>p)){var W=E.radius+s._probeRadius;u=O-W*W,u<0&&(u=-u),f=1/(h+u),v.push([E.colorX,E.colorY,E.colorZ]),_.push(f),m+=f}},y=0;y<t;y++){o=n[y].x,l=n[y].y,c=n[y].z,v=[],_=[],m=0,this.forEachRelatedAtom(n[y],g);for(var x=0;x<v.length;++x){var S=_[x]/m;r[y].x+=v[x][0]*S,r[y].y+=v[x][1]*S,r[y].z+=v[x][2]*S}}return 0}}]),a}(),km=function(){function a(e,t,n){G(this,a),this._maxNumVertices=e,this._maxNumTriangles=t,this._vertices=new Array(e),this._normals=new Array(e),this._colors=null,n&&(this._colors=new Array(e)),this._indices=new Array(t*3),this._numVertices=0,this._numTriangles=0;var r;for(r=0;r<e;r++)this._vertices[r]=new b,this._normals[r]=new b;for(r=0;r<t*3;r++)this._indices[r]=-1;if(n)for(r=0;r<e;r++)this._colors[r]=new b}return H(a,[{key:"destroy",value:function(){this._vertices=null,this._normals=null,this._indices=null}}]),a}();function D2(a){var e=F2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function F2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var B2=3,qu=32768,z2=qe.Element,V2=function(a){re(t,a);var e=D2(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){this._innerBuild();var r=this.getGeo();this.destroy(),this._fromGeo(r)}},{key:"_fromGeo",value:function(r){var i=null,s=Se.allocateTyped(Float32Array,3*r._numVertices),o=Se.allocateTyped(Float32Array,3*r._numVertices);r._colors!==null&&(i=Se.allocateTyped(Float32Array,3*r._numVertices));for(var l=Se.allocateTyped(Uint32Array,3*r._numTriangles),c=0,u=0;c<r._numVertices;c++)s[u+0]=r._vertices[c].x,s[u+1]=r._vertices[c].y,s[u+2]=r._vertices[c].z,o[u+0]=r._normals[c].x,o[u+1]=r._normals[c].y,o[u+2]=r._normals[c].z,u+=3;if(i!==null)for(var f=0,h=0;f<r._numVertices;f++,h+=3)i[h+0]=r._colors[f].x,i[h+1]=r._colors[f].y,i[h+2]=r._colors[f].z;for(var d=r._numTriangles*3,p=0;p<d;p++)l[p]=r._indices[p];this.setIndex(new Ze(l,1)),this.setAttribute("position",new Ze(s,3)),this.setAttribute("normal",new Ze(o,3)),this.setAttribute("color",new Ze(i,3)),this.computeBoundingBox(),this.computeBoundingSphere(),r.destroy()}},{key:"convertToAtomsColored",value:function(r,i){for(var s=r.atoms,o=r.colors,l=0,c=s.length;l<c;l++){var u=s[l].position,f=s[l].element.radius;i[l]=new k2(u,f);var h=s[l].element.number;i[l].atomType=this.getType(h);var d=B2*l;i[l].colorX=o[d++],i[l].colorY=o[d++],i[l].colorZ=o[d],i[l].srcAtom=s[l]}}},{key:"getGeo",value:function(){return this.geoOut}},{key:"destroy",value:function(){this.atoms=null,this.hashLines=null,this.hashEntries=null}},{key:"getBoundingBox",value:function(r,i,s){var o=1e7;i.x=i.y=i.z=o,s.x=s.y=s.z=0-o;for(var l=this.probeRadius*this.atomRadiusScale,c=0,u=0,f=r.length;u<f;u++){var h=r[u].coord,d=r[u].radius+l;c=d>c?d:c,h.x-d<i.x&&(i.x=h.x-d),h.y-d<i.y&&(i.y=h.y-d),h.z-d<i.z&&(i.z=h.z-d),h.x+d>s.x&&(s.x=h.x+d),h.y+d>s.y&&(s.y=h.y+d),h.z+d>s.z&&(s.z=h.z+d)}i.x-=c,i.y-=c,i.z-=c,s.x+=c,s.y+=c,s.z+=c}},{key:"getCornerCoord",value:function(r,i,s,o,l,c,u){var f=1/(c-1),h=s*f,d=o*f,p=l*f;u.x=r.x*(1-h)+i.x*h,u.y=r.y*(1-d)+i.y*d,u.z=r.z*(1-p)+i.z*p}},{key:"buildEdgePoint",value:function(r,i,s,o,l,c){if(s[r]^s[i]){var u=24,f=0-o.pointsValuesLinear[l+u+r],h=o.pointsValuesLinear[l+u+i],d=o.pointsValuesLinear[l+u+r],p=f/(h-d),v=o.pointsValuesLinear[l+r*3+0],_=o.pointsValuesLinear[l+r*3+1],m=o.pointsValuesLinear[l+r*3+2],g=o.pointsValuesLinear[l+i*3+0],y=o.pointsValuesLinear[l+i*3+1],x=o.pointsValuesLinear[l+i*3+2];c.x=v*(1-p)+g*p,c.y=_*(1-p)+y*p,c.z=m*(1-p)+x*p}}},{key:"isTriangleVisible",value:function(r,i,s){var o=this.voxelWorld.getClosestAtom(r),l=this.voxelWorld.getClosestAtom(i),c=this.voxelWorld.getClosestAtom(s);return o===null||l===null||c===null||o.srcAtom===null||l.srcAtom===null||c.srcAtom===null?!1:this.visibilitySelector.includesAtom(o.srcAtom)&&this.visibilitySelector.includesAtom(l.srcAtom)&&this.visibilitySelector.includesAtom(c.srcAtom)}},{key:"addTriangle",value:function(r,i,s){if(this.visibilitySelector&&!this.isTriangleVisible(r,i,s))return!0;var o=this.geoOut;if(o._numTriangles>=this.maxNumTriangles)return!1;var l=this.addVertexToGeo(o,r),c=this.addVertexToGeo(o,i),u=this.addVertexToGeo(o,s);if((l|c|u)<0)return!1;var f=3*o._numTriangles;return o._indices[f+0]=l,o._indices[f+1]=c,o._indices[f+2]=u,o._numTriangles++,!0}},{key:"buildGeoFromCorners",value:function(r,i,s,o,l,c){for(var u=12,f=8,h=r-1,d=r,p=r*r,v=new Array(u),_=0;_<u;_++)v[_]=new b;for(var m=[],g=0;g<f;g++)m[g]=1;for(var y=new b,x=0,S=0,M=0;M<h;M++,S+=p)for(var E=0,N=0;N<h;N++,E+=d)for(var B=0;B<h;B++){if(!c.hasIntersection[x]){x++;continue}var V=c.bitsInside[x];this.getCornerCoord(i,s,B,M,N,r,y);for(var O=x*32,W=0,z=0;W<f;W++)c.pointsValuesLinear[O+z++]=y.x,c.pointsValuesLinear[O+z++]=y.y,c.pointsValuesLinear[O+z++]=y.z;c.pointsValuesLinear[O+3]+=l.x,c.pointsValuesLinear[O+2*3]+=l.x,c.pointsValuesLinear[O+5*3]+=l.x,c.pointsValuesLinear[O+6*3]+=l.x,c.pointsValuesLinear[O+2*3+2]+=l.z,c.pointsValuesLinear[O+3*3+2]+=l.z,c.pointsValuesLinear[O+6*3+2]+=l.z,c.pointsValuesLinear[O+7*3+2]+=l.z,c.pointsValuesLinear[O+4*3+1]+=l.y,c.pointsValuesLinear[O+5*3+1]+=l.y,c.pointsValuesLinear[O+6*3+1]+=l.y,c.pointsValuesLinear[O+7*3+1]+=l.y;for(var C=O+24,T=0;T<f;++T)m[T]=c.pointsValuesLinear[C+T]<0?1:0;this.buildEdgePoint(0,1,m,c,O,v[0]),this.buildEdgePoint(1,2,m,c,O,v[1]),this.buildEdgePoint(2,3,m,c,O,v[2]),this.buildEdgePoint(3,0,m,c,O,v[3]),this.buildEdgePoint(4,5,m,c,O,v[4]),this.buildEdgePoint(5,6,m,c,O,v[5]),this.buildEdgePoint(6,7,m,c,O,v[6]),this.buildEdgePoint(7,4,m,c,O,v[7]),this.buildEdgePoint(0,4,m,c,O,v[8]),this.buildEdgePoint(1,5,m,c,O,v[9]),this.buildEdgePoint(2,6,m,c,O,v[10]),this.buildEdgePoint(3,7,m,c,O,v[11]);for(var A=V*16,F=0,X=0;F<6;F++,X+=3){var Y=c.striIndicesMarchCube[A+X];if(Y<0)break;var ne=c.striIndicesMarchCube[A+X+1],ae=c.striIndicesMarchCube[A+X+2];if(!this.addTriangle(v[Y],v[ne],v[ae]))return-2}x++}return 0}},{key:"getNumIntersectedCells",value:function(r,i,s,o){for(var l=r*r,c=8,u=0,f=0,h=0,d=0;d<i;d++,h+=l)for(var p=0,v=0;v<i;v++,p+=r)for(var _=0;_<i;_++){var m=f*32+24,g=_+p+h;o.pointsValuesLinear[m]=s[g],o.pointsValuesLinear[m+1]=s[g+1],o.pointsValuesLinear[m+2]=s[g+r+1],o.pointsValuesLinear[m+3]=s[g+r],o.pointsValuesLinear[m+4]=s[l+g],o.pointsValuesLinear[m+5]=s[l+g+1],o.pointsValuesLinear[m+6]=s[l+g+r+1],o.pointsValuesLinear[m+7]=s[l+g+r];for(var y=0,x=0;x<c;++x)o.pointsValuesLinear[m+x]<0&&(y|=1<<x);y===0||y===(1<<c)-1?o.hasIntersection[f]=!1:(o.hasIntersection[f]=!0,u++),o.bitsInside[f]=y,f++}return u}},{key:"getType",value:function(r){var i=[0,0,1,1,2,6,3,6,4,6,5,6,6,0,7,3,8,2,9,6,10,6,11,6,12,6,13,6,14,6,15,4,16,5,17,6,18,6,19,6,20,6,21,6,22,6,23,6,24,6,25,6,26,6,27,6,28,6,29,6,30,6,31,6,32,6,33,6,34,6,35,6,36,6,37,6,38,6,39,6,40,6,41,6,42,6,43,6,44,6,45,6,46,6,47,6,48,6,49,6,50,6,51,6,52,6,53,6,54,6,55,6,56,6,57,6,58,6,59,6,60,6,61,6,62,6,63,6,64,6,65,6,66,6,67,6,68,6,69,6,70,6,71,6,72,6,73,6,74,6,75,6,76,6,77,6,78,6,79,6,80,6,81,6,82,6,83,6,84,6,85,6,86,6,87,6,88,6,89,6,90,6,91,6,92,6,93,6,94,6,95,6,96,6,97,6,98,6,99,6,100,6,101,6,102,6,103,6,104,6,105,6,106,6,107,6,108,6,109,6];if(r<1||r>i.length/2||Object.keys(z2.ByAtomicNumber).length*2!==i.length)throw new Error("atomT.length  should be equal Element.ByAtomicNumber.length * 2");return i[r*2]}},{key:"calculateGridCorners",value:function(r,i,s,o,l,c){for(var u=i*i,f=u*i,h=new b,d=new b,p=1e12,v=0;v<f;v++)r[v]=p;for(var _=(i-1)/(o.x-s.x),m=(i-1)/(o.y-s.y),g=(i-1)/(o.z-s.z),y=0,x=l.length;y<x;y++){var S=l[y],M=S.radius+c,E=(S.coord.x-M-s.x)*_,N=(S.coord.y-M-s.y)*m,B=(S.coord.z-M-s.z)*g,V=Math.floor(E),O=Math.floor(N),W=Math.floor(B),z=Math.floor((S.coord.x+M-s.x)*_),C=Math.floor((S.coord.y+M-s.y)*m),T=Math.floor((S.coord.z+M-s.z)*g);z++,C++,T++,z=z<=i-1?z:i-1,C=C<=i-1?C:i-1,T=T<=i-1?T:i-1;for(var A=O;A<=C;A++)for(var F=A*u,X=W;X<=T;X++)for(var Y=X*i,ne=V;ne<=z;ne++){var ae=F+Y+ne;this.getCornerCoord(s,o,ne,A,X,i,h),d.x=h.x-S.coord.x,d.y=h.y-S.coord.y,d.z=h.z-S.coord.z;var xe=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z),be=xe-M;be<r[ae]&&(r[ae]=be)}}}},{key:"createVertexHash",value:function(r,i){if(this.hashLines=Se.allocateTyped(Int32Array,qu*2),this.hashLines===null)return-1;for(var s=0,o=0;s<qu;s++)this.hashLines[o++]=0,this.hashLines[o++]=-1;if(this.maxNumVertices=r,this.maxNumTriangles=i,this.numHashEtriesAllocated=r,this.hashEntries=Se.allocateTyped(Int32Array,2*this.numHashEtriesAllocated),this.hashEntries===null)return-1;for(var l=0,c=0;l<this.numHashEtriesAllocated;l++)this.hashEntries[c++]=-1,this.hashEntries[c++]=-1;return this.numHashEntryIndex=0,0}},{key:"getNewHashEntry",value:function(){if(this.numHashEntryIndex<this.numHashEtriesAllocated){var r=this.numHashEntryIndex;return this.numHashEntryIndex++,r}return-1}},{key:"addVertexToGeo",value:function(r,i){var s,o=.01,l=815851,c=37633,u=2453543,f=1e-6,h=this.marCubeResoultion<<2,d=new b,p=Math.floor(h*(i.x-this.vBoxMin.x)/(this.vBoxMax.x+o-this.vBoxMin.x)),v=Math.floor(h*(i.y-this.vBoxMin.y)/(this.vBoxMax.y+o-this.vBoxMin.y)),_=Math.floor(h*(i.z-this.vBoxMin.z)/(this.vBoxMax.z+o-this.vBoxMin.z)),m=p*l+_*c+v*u;m&=qu-1;var g=m+m;if(this.vBoxMin!==null&&this.vBoxMax!==null)for(s=this.hashLines[g+1];s>=0;s=this.hashEntries[s*2+1]){var y=this.hashEntries[s*2+0];d.copy(r._vertices[y]),d.x-=i.x,d.y-=i.y,d.z-=i.z;var x=d.x*d.x+d.y*d.y+d.z*d.z;if(x<f)return y}if(r._numVertices>=this.maxNumVertices)return-1;var S=r._numVertices;if(r._vertices[S].copy(i),this.vBoxMin!==null&&this.vBoxMax!==null){if(s=this.getNewHashEntry(),s<0)return-1;var M=this.hashLines[g+1];this.hashLines[g+1]=s,this.hashEntries[s*2+0]=S,this.hashEntries[s*2+1]=M,this.hashLines[g+0]++}return r._numVertices++,S}},{key:"modifyExcludedFromGeo",value:function(r,i,s,o,l,c){var u,f,h,d=1.1;function p(){h>0&&c[u]<0&&(c[u]=h),h>c[u]&&(c[u]=h)}for(var v=r*r,_=(r-1)/(o.x-s.x),m=(r-1)/(o.y-s.y),g=(r-1)/(o.z-s.z),y=i*2*(i*2),x=1/(r-1),S=0;S<l._numVertices;S++){var M=l._vertices[S],E=i*d,N=Math.floor((M.x-E-s.x)*_),B=Math.floor((M.y-E-s.y)*m),V=Math.floor((M.z-E-s.z)*g),O=Math.floor((M.x+E-s.x)*_),W=Math.floor((M.y+E-s.y)*m),z=Math.floor((M.z+E-s.z)*g);N=N>=0?N:0,B=B>=0?B:0,V=V>=0?V:0,O=O<=r-1?O:r-1,W=W<=r-1?W:r-1,z=z<=r-1?z:r-1;for(var C=B;C<=W;C++)for(var T=C*v,A=V;A<=z;A++)for(var F=A*r,X=N;X<=O;X++){u=T+F+X;var Y=X*x,ne=s.x*(1-Y)+o.x*Y;Y=C*x;var ae=s.y*(1-Y)+o.y*Y;Y=A*x;var xe=s.z*(1-Y)+o.z*Y,be=ne-M.x,ge=ae-M.y,we=xe-M.z,q=be*be+ge*ge+we*we;q<y&&(f=Math.sqrt(q),h=-(f-i),p())}}return 0}},{key:"_innerBuild",value:function(){var r,i=1.2,s={posRad:this._posRad,colors:this._colors,atoms:this._opts.atoms};this.complex=this._opts.parent,this.atoms=s.atoms,this.meshResolution=this._opts.gridSpacing,this.atomRadiusScale=this._opts.radScale,this.colorMode=this._opts.colorMode,this.probeRadius=this._opts.probeRadius,this.useVertexColors=!0,this.excludeProbe=this._opts.excludeProbe,this.visibilitySelector=this._opts.visibilitySelector,this.geoOut=null,this.hashLines=null,this.hashEntries=null,this.numHashEtriesAllocated=0,this.numHashEntryIndex=0,this.maxNumVertices=0,this.maxNumTriangles=0;var o=new Array(this.atoms.length);this.convertToAtomsColored(s,o);var l=this.vBoxMin=new b,c=this.vBoxMax=new b;this.getBoundingBox(o,l,c);var u=this.marCubeResoultion=this.meshResolution*4,f=u,h=f*f,d=h*f,p=Se.allocateTyped(Float32Array,d),v=this.probeRadius*this.atomRadiusScale;this.calculateGridCorners(p,f,l,c,o,v);var _=u-1,m=new Fh;if(r=m.create(_),r<0)return r;var g=new b;g.x=(c.x-l.x)/_,g.y=(c.y-l.y)/_,g.z=(c.z-l.z)/_;var y=this.getNumIntersectedCells(f,_,p,m),x=Math.floor(y*i),S=Math.floor(y*i*2);if(this.geoOut=new km(x,S,this.useVertexColors),r=this.createVertexHash(x,S),r<0)return r;var M=v;if(this.excludeProbe&&(M=.01),this.voxelWorld=new O2(o.length,o,l,c,M),this.voxelWorld.createVoxels(),r=this.buildGeoFromCorners(u,l,c,p,g,m),this.excludeProbe){if(this.modifyExcludedFromGeo(f,v,l,c,this.geoOut,p),this.geoOut._vertices=null,this.geoOut._colors=null,this.geoOut._indices=null,this.geoOut._normals=null,this.geoOut._numVertices=0,this.geoOut._numTriangles=0,this.geoOut=null,y=this.getNumIntersectedCells(f,_,p,m),x=Math.floor(y*i),S=Math.floor(y*i*2),this.geoOut=new km(x,S,this.useVertexColors),r=this.createVertexHash(x,S),r<0)return r;r=this.buildGeoFromCorners(f,l,c,p,g,m)}this.voxelWorld.buildNormals(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._normals);var E=6.5;return this.excludeProbe&&(E-=1.5),this.useVertexColors&&this.voxelWorld.buildColors(this.geoOut._vertices.length,this.geoOut._vertices,this.geoOut._colors,E),this.voxelWorld.destroyVoxels(),this.voxelWorld=null,m.destroy(),r}}]),t}(M_);function U2(a){var e=G2();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function G2(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function H2(a,e){var t=document.createElement("div");if(t.className=e,typeof a=="string"){var n=document.createElement("span");n.style.fontSize="150%";for(var r=a.split(`
`),i=0,s=r.length;i<s;++i){var o=document.createElement("span"),l=document.createTextNode(r[i]);o.appendChild(l),n.appendChild(o),i<s-1&&n.appendChild(document.createElement("br"))}t.appendChild(n)}else t.appendChild(a);return t.worldPos=new b,t}var W2=function(a){re(t,a);var e=U2(t);function t(n,r){var i;G(this,t),i=e.call(this),i._opts=r,i.items=[],i.needsUpdate=!1;var s=-50,o=-50;switch(r.horizontalAlign){case"left":s=0;break;case"right":s=-100;break}switch(r.verticalAlign){case"top":o=-100;break;case"bottom":o=0;break}var l=new b(r.dx||0,r.dy||0,r.dz||0);return i.userData={translation:"translate(".concat(s,"%, ").concat(o,"%)"),offset:l},i}return H(t,[{key:"setItem",value:function(r,i,s){var o=this._opts,l=this.items[r]||H2(s,"label");l.worldPos.copy(i),l.style.textAlign=o.horizontalAlign,l.style.verticalAlign=o.verticalAlign,this.items[r]=l}},{key:"setColor",value:function(r,i,s){var o=this.items[r];o.opts={color:i,background:s}}},{key:"startUpdate",value:function(){return!0}},{key:"finishUpdate",value:function(){this.needsUpdate=!0,this.dispatchEvent({type:"update"})}},{key:"finalize",value:function(){this.finishUpdate()}},{key:"raycast",value:function(){}},{key:"setOpacity",value:function(){}},{key:"getSubset",value:function(){return[]}}]),t}(gr),mn={InstancedSpheresGeometry:y_,SimpleSpheresGeometry:BT,Simple2CCylindersGeometry:Dh,Instanced2CCylindersGeometry:x_,ExtrudedObjectsGeometry:e2,ChunkedLinesGeometry:w_,TwoColorLinesGeometry:m2,CrossGeometry:_2,QuickSurfGeometry:T2,ContactSurfaceGeometry:I2,SSIsosurfaceGeometry:V2,LabelsGeometry:W2},X2=`float INSTANCED_SPRITE_OVERSCALE = 1.3;\r
\r
attribute vec3 normal;\r
\r
#ifdef NORMALS_TO_G_BUFFER\r
  varying vec3 viewNormal;\r
#endif\r
#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r
  varying vec3 vNormal;\r
#endif\r
\r
#ifdef THICK_LINE\r
  attribute vec4 position; // W contains vert pos or neg offset\r
#else\r
  attribute vec3 position;\r
#endif\r
\r
varying vec3 vWorldPosition;\r
varying vec3 vViewPosition;\r
\r
#ifdef ATTR_ALPHA_COLOR\r
  attribute float alphaColor;\r
  varying float alphaCol;\r
#endif\r
\r
#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
	#if NUM_DIR_LIGHTS > 0\r
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\r
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r
		varying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r
	#endif\r
#endif\r
\r
#ifdef ATTR_COLOR\r
  attribute vec3 color;\r
  varying vec3 vColor;\r
#endif\r
\r
#ifdef ATTR_COLOR2\r
  attribute vec3 color2;\r
  varying vec3 vColor2;\r
  attribute vec2 uv;\r
  #ifndef CYLINDER_SPRITE\r
    varying vec2 vUv;\r
  #endif\r
#endif\r
\r
#ifdef INSTANCED_POS\r
  attribute vec4 offset;\r
  #ifdef SPHERE_SPRITE\r
    varying vec4 instOffset;\r
  varying vec4 spritePosEye;\r
  #endif\r
#endif\r
\r
#ifdef INSTANCED_MATRIX\r
  attribute vec4 matVector1;\r
  attribute vec4 matVector2;\r
  attribute vec4 matVector3;\r
  attribute vec4 invmatVector1;\r
  attribute vec4 invmatVector2;\r
  attribute vec4 invmatVector3;\r
\r
  #ifdef CYLINDER_SPRITE\r
    varying vec4 matVec1;\r
    varying vec4 matVec2;\r
    varying vec4 matVec3;\r
    varying vec4 invmatVec1;\r
    varying vec4 invmatVec2;\r
    varying vec4 invmatVec3;\r
    varying vec4 spritePosEye;\r
  #endif\r
#endif\r
\r
uniform mat4 modelViewMatrix; // optional\r
uniform mat4 projectionMatrix; // optional\r
uniform mat3 normalMatrix; // optional\r
uniform mat4 modelMatrix; // optional\r
\r
#ifdef DASHED_LINE\r
  attribute float lineDistance;\r
  varying float vLineDistance;\r
#endif\r
\r
#ifdef THICK_LINE\r
  attribute vec3 direction;\r
  uniform mat4 projMatrixInv;\r
  uniform vec2 viewport;\r
  uniform float lineWidth;\r
\r
  vec4 transform(vec4 coord){\r
    return projectionMatrix * modelViewMatrix * coord;\r
  }\r
\r
  vec2 project(vec4 device){\r
    vec3 device_normal = device.xyz/device.w;\r
    vec2 clip_pos = (device_normal*0.5+0.5).xy;\r
    return clip_pos * viewport;\r
  }\r
\r
  vec4 unproject(vec2 screen, float z, float w){\r
    vec2 clip_pos = screen/viewport;\r
    vec2 device_normal = clip_pos*2.0-1.0;\r
    return vec4(device_normal*w, z, w);\r
  }\r
#endif\r
\r
\r
/////////////////////////////////////////// Main ///////////////////////////////////////////////\r
void main() {\r
\r
#ifdef ATTR_ALPHA_COLOR\r
  alphaCol = alphaColor;\r
#endif\r
\r
#ifdef INSTANCED_MATRIX\r
  vec3 objectNormal = vec3(\r
    dot(normal, matVector1.xyz),\r
    dot(normal, matVector2.xyz),\r
    dot(normal, matVector3.xyz));\r
#else\r
  vec3 objectNormal = vec3( normal );\r
#endif\r
\r
vec3 transformedNormal = normalMatrix * objectNormal;\r
\r
#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r
  vNormal = normalize(transformedNormal);\r
#endif\r
\r
#ifdef NORMALS_TO_G_BUFFER\r
  viewNormal = normalize(mat3(modelViewMatrix)*objectNormal);\r
#endif\r
\r
  vec4 localPos = vec4(position.xyz, 1.0);\r
  vec4 worldPos = modelMatrix * localPos;\r
  vec4 mvPosition = modelViewMatrix * localPos;\r
\r
// make thick line offset\r
#ifdef THICK_LINE\r
   // get screen pos\r
   vec4 dPos = transform(vec4(position.xyz, 1.0));\r
   vec2 sPos = project(dPos);\r
   // move pos forward\r
   vec3 position2 = position.xyz + direction.xyz * 0.5;\r
   // get screen offset pos\r
   vec4 dPos2 = transform(vec4(position2.xyz, 1.0));\r
   vec2 sPos2 = project(dPos2);\r
   // screen line direction\r
   vec2 sDir = normalize(sPos2 - sPos);\r
   // vertex offset (orthogonal to line direction)\r
   vec2 offset1 = vec2(-sDir.y, sDir.x);\r
   // move screen vertex\r
   vec2 newPos = sPos + offset1 * position.w * lineWidth;\r
   // get moved pos in view space\r
   vec4 dNewPos =  unproject(newPos, dPos.z, dPos.w);\r
   mvPosition.xyz = (projMatrixInv * dNewPos).xyz;\r
#endif // THICK_LINE\r
\r
#ifdef INSTANCED_POS\r
  #ifdef SPHERE_SPRITE\r
    instOffset = offset;\r
\r
    vec4 posEye = modelViewMatrix * vec4( offset.xyz, 1.0 );\r
    float scale = length(modelViewMatrix[0]);\r
    mvPosition = posEye + vec4( position.xyz * offset.w * scale * INSTANCED_SPRITE_OVERSCALE, 0.0 );\r
    posEye.w = offset.w * scale;\r
\r
    spritePosEye = posEye;\r
 #else\r
    localPos = vec4( offset.xyz + position.xyz * offset.w, 1.0 );\r
    worldPos = modelMatrix * localPos;\r
    mvPosition = modelViewMatrix * localPos;\r
  #endif\r
#endif\r
\r
#ifdef INSTANCED_MATRIX\r
  #ifdef CYLINDER_SPRITE\r
    matVec1 = matVector1;\r
    matVec2 = matVector2;\r
    matVec3 = matVector3;\r
    invmatVec1 = invmatVector1;\r
    invmatVec2 = invmatVector2;\r
    invmatVec3 = invmatVector3;\r
\r
    // calculate eye coords of cylinder endpoints\r
    vec4 v = vec4(0, -0.5, 0, 1);\r
    vec4 p1 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r
    v.y = 0.5;\r
    vec4 p2 = modelViewMatrix * vec4(dot(v, matVector1), dot(v, matVector2), dot(v, matVector3), 1.0);\r
\r
    // sprite is placed at the center of cylinder\r
    vec4 posEye;\r
    posEye.xyz = mix(p1.xyz, p2.xyz, 0.5);\r
    posEye.w = 1.0;\r
    spritePosEye = posEye;\r
\r
    // cylinder radius in eye space\r
    float rad = length(modelViewMatrix[0]) * length(vec3(matVector1.x, matVector2.x, matVector3.x));\r
    vec2 spriteSize;\r
    #ifdef ORTHOGRAPHIC_CAMERA\r
      // In ortho projection we skip z coordinate\r
      // basic sprite size at screen plane (covers only cylinder axis)\r
      vec2 spriteSizeScreen = abs(p2.xy - p1.xy);\r
\r
      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * (spriteSizeScreen + 2.0 * rad);\r
    #else\r
      // basic sprite size at screen plane (covers only cylinder axis)\r
      vec2 spriteSizeScreen = abs(p2.xy / p2.z - p1.xy / p1.z);\r
\r
      // full sprite size in eye coords\r
      float minZ = min(abs(p1.z), abs(p2.z));\r
      spriteSize = vec2(1.0, 1.0) * INSTANCED_SPRITE_OVERSCALE * abs(posEye.z) * (spriteSizeScreen + 2.0 * rad / minZ);\r
    #endif\r
\r
    mvPosition = posEye + vec4( position.xy * 0.5 * spriteSize, 0, 0 );\r
  #else\r
    localPos = vec4(dot(localPos, matVector1), dot(localPos, matVector2), dot(localPos, matVector3), 1.0);\r
    worldPos = modelMatrix * localPos;\r
    mvPosition = modelViewMatrix * localPos;\r
  #endif\r
#endif\r
\r
  gl_Position = projectionMatrix * mvPosition;\r
\r
  vWorldPosition = worldPos.xyz;\r
  vViewPosition = - mvPosition.xyz;\r
\r
#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
	#if NUM_DIR_LIGHTS > 0\r
	  vec4 worldPosition;\r
	  // see THREE.WebGLProgram.unrollLoops\r
	  #pragma unroll_loop_start\r
	  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r
      vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * vec4(vWorldPosition, 1.0);\r
      vDirectionalShadowNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(objectNormal, 0.0))).xyz;\r
	  }\r
	  #pragma unroll_loop_end\r
	#endif\r
#endif\r
\r
#ifdef ATTR_COLOR\r
  vColor = color.xyz;\r
#endif\r
\r
#ifdef ATTR_COLOR2\r
  vColor2 = color2;\r
  #ifndef CYLINDER_SPRITE\r
    vUv = uv;\r
  #endif\r
#endif\r
\r
#ifdef DASHED_LINE\r
  vLineDistance = lineDistance;\r
#endif\r
}\r
`,j2=`#if defined (NORMALS_TO_G_BUFFER)\r
  #define fragColor gl_FragData[0]\r
#else\r
  #define fragColor gl_FragColor\r
#endif\r
\r
#ifdef ATTR_ALPHA_COLOR\r
  varying float alphaCol;\r
#endif\r
\r
#ifdef COLOR_FROM_POS\r
  uniform mat4 world2colorMatrix;\r
#endif\r
\r
#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
	#if NUM_DIR_LIGHTS > 0\r
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\r
    uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ]; //only for sprites\r
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\r
		varying vec3 vDirectionalShadowNormal[ NUM_DIR_LIGHTS ];\r
    vec4 vDirLightWorldCoord[ NUM_DIR_LIGHTS ];\r
    vec3 vDirLightWorldNormal[ NUM_DIR_LIGHTS ];\r
\r
    #ifdef SHADOWMAP_PCF_RAND\r
      // We use 4 instead uniform variable or define because this value is used in for(... i < value; ...) with\r
      // unroll_loop and unroll_loop has pattern:\r
      // /#pragma unroll_loop[\\s]+?for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g\r
      uniform vec2 samplesKernel[4]; // 4 is length of _samplesKernel which is defined in UberMaterial.js\r
      uniform sampler2D noiseTex;\r
      uniform vec2 noiseTexelSize;\r
      uniform vec2 srcTexelSize;\r
      uniform mat4 projectionMatrix;\r
    #endif\r
	#endif\r
#endif\r
\r
#ifdef ATTR_COLOR\r
  varying vec3 vColor;\r
#endif\r
\r
#ifdef ATTR_COLOR2\r
  varying vec3 vColor2;\r
  #ifndef CYLINDER_SPRITE\r
    varying vec2 vUv;\r
  #endif\r
#endif\r
\r
uniform vec3 diffuse;\r
uniform vec3 emissive;\r
uniform vec3 specular;\r
uniform float shininess;\r
uniform vec3 fixedColor;\r
uniform float opacity;\r
uniform float zClipValue;\r
uniform float clipPlaneValue;\r
\r
#ifdef NORMALS_TO_G_BUFFER\r
  varying vec3 viewNormal;\r
#endif\r
\r
#define PI 3.14159265359\r
#define RECIPROCAL_PI 0.31830988618\r
#define saturate(a) clamp( a, 0.0, 1.0 )\r
\r
#ifdef USE_FOG\r
  uniform vec3 fogColor;\r
  uniform float fogAlpha;\r
  uniform float fogNear;\r
  uniform float fogFar;\r
#endif\r
\r
varying vec3 vWorldPosition; // world position of the pixel (invalid when INSTANCED_SPRITE is defined)\r
varying vec3 vViewPosition;\r
\r
#if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r
  varying vec3 vNormal;\r
#endif\r
\r
/////////////////////////////////////////// ZSprites ////////////////////////////////////////////////\r
#if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\r
  uniform float nearPlaneValue;\r
#endif\r
\r
#ifdef SPHERE_SPRITE\r
  varying vec4 spritePosEye;\r
#endif\r
\r
#if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
  uniform float zOffset;\r
\r
  #if !defined(USE_LIGHTS) || !defined(SHADOWMAP) || !defined(SHADOWMAP_PCF_RAND) || !(NUM_DIR_LIGHTS > 0)\r
    uniform mat4 projectionMatrix;\r
  #endif\r
\r
  float calcDepthForSprites(vec4 pixelPosEye, float zOffset, mat4 projMatrix) {\r
    vec4 pixelPosScreen = projMatrix * pixelPosEye;\r
    return 0.5 * (pixelPosScreen.z / pixelPosScreen.w + 1.0) + zOffset;\r
  }\r
#endif\r
\r
#ifdef SPHERE_SPRITE\r
  varying vec4 instOffset;\r
  uniform mat4 modelMatrix;\r
  uniform mat4 modelViewMatrix;\r
  uniform mat4 invModelViewMatrix;\r
  uniform mat3 normalMatrix;\r
\r
\r
  bool intersect_ray_sphere(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\r
\r
    // intersect XZ-projected ray with circle\r
    float a = dot(ray, ray);\r
    float b = dot(ray, origin);\r
    float c = dot(origin, origin) - 1.0;\r
    float det = b * b - a * c;\r
    if (det < 0.0) return false;\r
    float t1 = (-b - sqrt(det)) / a;\r
    float t2 = (-b + sqrt(det)) / a;\r
\r
    // calculate both intersection points\r
    vec3 p1 = origin + ray * t1;\r
    vec3 p2 = origin + ray * t2;\r
\r
    // choose nearest point inside frustum\r
    #ifdef ORTHOGRAPHIC_CAMERA\r
      // orthografic camera is used for dirLight sources. So in it for all spheres the point with smaller 't' is visible\r
      // t1 is always smaller than t2 (from calculations)\r
      point = p1;\r
      frontFaced = 1.0;\r
      return true;\r
    #else\r
      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\r
      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\r
      if (t1 >= 0.0) {\r
        point = p1;\r
        frontFaced = 1.0;\r
        return true;\r
      }\r
      if (t2 >= 0.0) {\r
        point = p2;\r
        frontFaced = -1.0;\r
        return true;\r
      }\r
    #endif\r
\r
    return false;\r
  }\r
\r
  bool get_sphere_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\r
    vec3 origin, ray;\r
\r
    #ifdef ORTHOGRAPHIC_CAMERA\r
      // transform vector from sprite center to curPixel into sphere local coords\r
      origin = pixelPosEye.xyz - spritePosEye.xyz;\r
      origin = (invModelViewMatrix * vec4(origin, 0.0)).xyz / instOffset.w;\r
\r
      // transform camera orientation vector into sphere local coords\r
      ray = (invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0)).xyz;\r
    #else\r
      // find point of intersection near plane by the ray from camera to curPixel\r
      vec4 v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\r
\r
      // transform intersection point into sphere local coords\r
      v = invModelViewMatrix * v;\r
      origin = (v.xyz - instOffset.xyz) / instOffset.w;\r
\r
      // transform vector from camera pos to curPixel into sphere local coords\r
      ray = (invModelViewMatrix * vec4(pixelPosEye, 0.0)).xyz;\r
    #endif\r
    ray = normalize(ray);\r
\r
    return intersect_ray_sphere(origin, ray, point, frontFaced);\r
  }\r
#endif\r
\r
#ifdef CYLINDER_SPRITE\r
  varying vec4 matVec1;\r
  varying vec4 matVec2;\r
  varying vec4 matVec3;\r
  varying vec4 invmatVec1;\r
  varying vec4 invmatVec2;\r
  varying vec4 invmatVec3;\r
\r
  uniform mat4 modelMatrix;\r
  uniform mat4 modelViewMatrix;\r
  uniform mat4 invModelViewMatrix;\r
  uniform mat3 normalMatrix;\r
\r
  varying vec4 spritePosEye;\r
\r
  bool intersect_ray_cylinder(in vec3 origin, in vec3 ray, out vec3 point, out float frontFaced) {\r
\r
    // intersect XZ-projected ray with circle\r
    float a = dot(ray.xz, ray.xz);\r
    float b = dot(ray.xz, origin.xz);\r
    float c = dot(origin.xz, origin.xz) - 1.0;\r
    float det = b * b - a * c;\r
    if (det < 0.0) return false;\r
    float t1 = (-b - sqrt(det)) / a;\r
    float t2 = (-b + sqrt(det)) / a;\r
\r
    // calculate both intersection points\r
    vec3 p1 = origin + ray * t1;\r
    vec3 p2 = origin + ray * t2;\r
\r
    float halfHeight = 0.5;\r
\r
    // choose nearest point\r
    #ifdef ORTHOGRAPHIC_CAMERA\r
      // orthografic camera is used for dirLight sources. So in it for all cylinders the point with smaller 't' is visible\r
      // if it is not outside of cylinnder (t1 is always smaller than t2).\r
      if (p1.y >= -halfHeight && p1.y <= halfHeight) {\r
        point = p1;\r
        frontFaced = 1.0;\r
        return true;\r
      }\r
      if (p2.y >= -halfHeight && p2.y <= halfHeight) {\r
        point = p2;\r
        frontFaced = -1.0;\r
        return true;\r
      }\r
    #else\r
      // for perspective camera first intersection can be in front of near plane. If not intersection is p1 else - p2\r
      // t* = 0.0 corresponds to point of intersection near plane by the ray from camera to curPixel\r
      if (t1 >= 0.0 && p1.y >= -halfHeight && p1.y <= halfHeight) {\r
        point = p1;\r
        frontFaced = 1.0;\r
        return true;\r
      }\r
      if (t2 >= 0.0 && p2.y >= -halfHeight && p2.y <= halfHeight) {\r
        point = p2;\r
        frontFaced = -1.0;\r
        return true;\r
      }\r
    #endif\r
\r
    return false;\r
  }\r
\r
  bool get_cylinder_point(in vec3 pixelPosEye, out vec3 point, out float frontFaced) {\r
    vec3 origin, ray;\r
    vec4 v;\r
\r
    #ifdef ORTHOGRAPHIC_CAMERA\r
      // transform vector from sprite center to curPixel into cylinder local coords\r
      v = invModelViewMatrix * vec4(pixelPosEye.xyz - spritePosEye.xyz, 0.0);\r
      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r
\r
      // transform camera orientation vector into cylinder local coords\r
      v = invModelViewMatrix * vec4(0.0, 0.0, -1.0, 0.0);\r
      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r
    #else\r
      // find point of intersection near plane by the ray from camera to curPixel\r
      v = vec4(-(nearPlaneValue / pixelPosEye.z) * pixelPosEye, 1.0);\r
\r
      // transform intersection point into cylinder local coords\r
      v = invModelViewMatrix * v;\r
      origin = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r
\r
      // transform vector from camera pos to curPixel into cylinder local coords\r
      v = invModelViewMatrix * vec4(pixelPosEye, 0.0);\r
      ray = vec3(dot(v, invmatVec1), dot(v, invmatVec2), dot(v, invmatVec3));\r
    #endif\r
    ray = normalize(ray);\r
\r
    return intersect_ray_cylinder(origin, ray, point, frontFaced);\r
  }\r
#endif\r
\r
///////////////////////////////////// Pack and unpack ///////////////////////////////////////////////\r
const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\r
const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\r
\r
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\r
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\r
\r
\r
const float ShiftRight8 = 1. / 256.;\r
\r
vec4 packDepthToRGBA( const in float v ) {\r
  vec4 r = vec4( fract( v * PackFactors ), v );\r
  r.yzw -= r.xyz * ShiftRight8; // tidy overflow\r
  return r * PackUpscale;\r
}\r
\r
float unpackRGBAToDepth( const in vec4 v ) {\r
  return dot( v, UnpackFactors );\r
}\r
\r
////////////////////////////////////////// All Lighting /////////////////////////////////////////////////\r
#ifdef TOON_SHADING\r
  #define LOW_TOON_BORDER 0.0\r
  #define MEDIUM_TOON_BORDER 0.7\r
  #define HIGH_TOON_BORDER 1.0\r
\r
  #define MEDIUM_TOON_RANGE 0.5\r
  #define HIGH_TOON_RANGE 0.95\r
#endif\r
#if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r
  struct ReflectedLight {\r
    vec3 directDiffuse;\r
    vec3 directSpecular;\r
    vec3 indirectDiffuse;\r
  };\r
\r
  struct BlinnPhongMaterial {\r
    vec3  diffuseColor;\r
    vec3  specularColor;\r
    float specularShininess;\r
  };\r
\r
  struct GeometricContext {\r
    vec3 normal;\r
    vec3 viewDir;\r
  };\r
\r
  struct DirectionalLight {\r
    vec3 direction;\r
    vec3 color;\r
  };\r
  uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\r
\r
  struct DirectionalLightShadow {\r
     vec2 shadowMapSize;\r
     float shadowBias;\r
     float shadowRadius;\r
   };\r
  uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHTS ];\r
\r
  uniform vec3 ambientLightColor;\r
\r
  /////////////////////////////////////////// Shadowmap ////////////////////////////////////////////////\r
\r
  #if defined(SHADOWMAP)\r
  	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\r
  		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\r
  	}\r
\r
    float getShadow( sampler2D shadowMap, DirectionalLightShadow dirLight, vec4 shadowCoord, vec3 vViewPosition, vec3 vNormal ) {\r
   	  float shadow = 0.0;\r
\r
      // When shadows for sprites will appear use here for them normals as it done for G-buffer\r
      shadowCoord.xyz += dirLight.shadowBias * vNormal;\r
      shadowCoord.xyz /= shadowCoord.w;\r
\r
      bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\r
      bool inFrustum = all( inFrustumVec );\r
      bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\r
      bool frustumTest = all( frustumTestVec );\r
\r
      if ( frustumTest ) {\r
        #ifdef SHADOWMAP_BASIC\r
      	  shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\r
      	#endif\r
\r
      	#ifdef SHADOWMAP_PCF_SHARP\r
      	  vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r
\r
            float dx0 = - texelSize.x * dirLight.shadowRadius;\r
            float dy0 = - texelSize.y * dirLight.shadowRadius;\r
            float dx1 = + texelSize.x * dirLight.shadowRadius;\r
            float dy1 = + texelSize.y * dirLight.shadowRadius;\r
\r
            shadow = (\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\r
            	texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\r
            ) * ( 1.0 / 9.0 );\r
        #endif\r
\r
        #ifdef SHADOWMAP_PCF_RAND\r
          vec2 texelSize = vec2( 1.0 ) / dirLight.shadowMapSize;\r
\r
          vec4 vUv = ((projectionMatrix * vec4(vViewPosition, 1.0)) + 1.0) / 2.0;\r
          vec2 vUvNoise = vUv.xy / srcTexelSize * noiseTexelSize;\r
\r
          vec2 noiseVec = normalize(texture2D(noiseTex, vUvNoise).rg);\r
          mat2 mNoise = mat2(noiseVec.x, noiseVec.y, -noiseVec.y, noiseVec.x);\r
\r
          vec2 offset;\r
          #pragma unroll_loop_start\r
          for ( int i = 0; i < 4; i ++ ) { // 4 is length of _samplesKernel which is defined in UberMaterial.js\r
            offset = mNoise * ( normalize( samplesKernel[ i ]) * texelSize * dirLight.shadowRadius );\r
            shadow +=  texture2DCompare( shadowMap, shadowCoord.xy + offset, shadowCoord.z );\r
          }\r
          #pragma unroll_loop_end\r
          shadow /= float( 4 ); // 4 is length of _samplesKernel which is defined in UberMaterial.js\r
        #endif\r
      }\r
      return shadow;//(shadow != 1.0) ? 0.5 : 1.0;//vec4(shadow, shadow, shadow, 1.0);\r
   }\r
  #endif\r
\r
  /////////////////////////////////////////// Lighting /////////////////////////////////////////////////\r
\r
  vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\r
    return RECIPROCAL_PI * diffuseColor;\r
  } // validated\r
\r
  vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\r
    // Original approximation by Christophe Schlick '94\r
    //;float fresnel = pow( 1.0 - dotLH, 5.0 );\r
    // Optimized variant (presented by Epic at SIGGRAPH '13)\r
    float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\r
    return ( 1.0 - specularColor ) * fresnel + specularColor;\r
  } // validated\r
\r
  float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\r
    // geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\r
    return 0.25;\r
  }\r
\r
  float D_BlinnPhong( const in float shininess, const in float dotNH ) {\r
    return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\r
  }\r
\r
  vec3 BRDF_Specular_BlinnPhong( const in DirectionalLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\r
    vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\r
    float dotNH = saturate(dot( geometry.normal, halfDir ));\r
    float dotLH = saturate(dot( incidentLight.direction, halfDir ));\r
\r
    vec3 F = F_Schlick( specularColor, dotLH );\r
    float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\r
    float D = D_BlinnPhong( shininess, dotNH );\r
\r
    return F * ( G * D );\r
  } // validated\r
\r
  void RE_Direct_BlinnPhong( const in DirectionalLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight, float penumbra ) {\r
\r
    float dotNL = saturate( dot( geometry.normal, directLight.direction ));\r
    #ifdef TOON_SHADING\r
      if(dotNL < MEDIUM_TOON_RANGE){\r
        dotNL = LOW_TOON_BORDER;\r
      }\r
      else if(dotNL < HIGH_TOON_RANGE){\r
        dotNL = MEDIUM_TOON_BORDER;\r
      }\r
      else{\r
        dotNL = HIGH_TOON_BORDER;\r
      }\r
    #endif\r
\r
    vec3 irradiance = dotNL * directLight.color * PI;\r
    reflectedLight.directDiffuse += penumbra * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r
    reflectedLight.directSpecular += penumbra * irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess );\r
  }\r
\r
  void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\r
    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\r
  }\r
\r
  vec3 calcLighting(const in GeometricContext geometry, const in BlinnPhongMaterial material, vec3 vViewPosition) {\r
    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ));\r
    vec3 irradiance = ambientLightColor * PI;\r
\r
    float shadowMask = 1.0;\r
    // see THREE.WebGLProgram.unrollLoops\r
  	#pragma unroll_loop_start\r
  	  for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r
  	    #ifdef SHADOWMAP\r
  	      shadowMask = getShadow( directionalShadowMap[ i ], directionalLightShadows[ i ], vDirLightWorldCoord[ i ], vViewPosition, vDirLightWorldNormal[ i ] );\r
        #endif\r
\r
  		  if ( shadowMask > 0.0 ) RE_Direct_BlinnPhong( directionalLights[ i ], geometry, material, reflectedLight, shadowMask );\r
  		}\r
  		#pragma unroll_loop_end\r
\r
    RE_IndirectDiffuse_BlinnPhong(irradiance, material, reflectedLight);\r
\r
    return saturate(reflectedLight.indirectDiffuse + reflectedLight.directDiffuse + reflectedLight.directSpecular);\r
  }\r
#endif\r
\r
/////////////////////////////////////////// Dashed Line ///////////////////////////////////////////////\r
#ifdef DASHED_LINE\r
  uniform float dashedLineSize;\r
  uniform float dashedLinePeriod;\r
  varying float vLineDistance;\r
#endif\r
\r
/////////////////////////////////////////// Main ///////////////////////////////////////////////\r
void main() {\r
\r
#ifdef CLIP_PLANE\r
  if (vViewPosition.z < clipPlaneValue) discard;\r
#endif\r
\r
#ifdef ZCLIP\r
  if (vViewPosition.z < zClipValue) discard;\r
#endif\r
\r
#if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
  #if NUM_DIR_LIGHTS > 0\r
    // see THREE.WebGLProgram.unrollLoops\r
    #pragma unroll_loop_start\r
    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r
      vDirLightWorldCoord[ i ] = vDirectionalShadowCoord[ i ];\r
      vDirLightWorldNormal[ i ] = vDirectionalShadowNormal[ i ];\r
    }\r
    #pragma unroll_loop_end\r
  #endif\r
#endif\r
\r
  vec4 pixelPosWorld = vec4(vWorldPosition, 1.0);\r
  vec4 pixelPosEye;\r
\r
#ifdef SPHERE_SPRITE\r
\r
  vec3 viewNormalSprites;\r
  float frontFaced = 1.0;\r
  vec3 normal;\r
\r
/* quick-and-dirty method\r
  normal.xy = ' + INSTANCED_SPRITE_OVERSCALE + ' * (2.0 * vUv - 1.0);\r
  float r2 = dot(normal.xy, normal.xy);\r
  if (r2 > 1.0) discard;\r
  float normalZ = sqrt(1.0 - r2);\r
  normal.z = normalZ;\r
  normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\r
  pixelPosEye = vec4(spritePosEye.xyz, 1.0);\r
  pixelPosEye.z += spritePosEye.w * normalZ;\r
*/\r
\r
  // ray-trace sphere surface\r
  {\r
    vec3 p;\r
    if (!get_sphere_point(-vViewPosition, p, frontFaced)) discard;\r
    vec4 v = vec4(instOffset.xyz + p * instOffset.w, 1.0);\r
    pixelPosWorld = modelMatrix * v;\r
    pixelPosEye = modelViewMatrix * v;\r
    normal = normalize(normalMatrix * p);\r
    #ifdef NORMALS_TO_G_BUFFER\r
      viewNormalSprites = normalize(mat3(modelViewMatrix)*p);\r
    #endif\r
\r
    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
      #if NUM_DIR_LIGHTS > 0\r
        // see THREE.WebGLProgram.unrollLoops\r
        #pragma unroll_loop_start\r
          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r
            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\r
            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(p, 0.0))).xyz;\r
          }\r
        #pragma unroll_loop_end\r
      #endif\r
    #endif\r
  }\r
#endif\r
\r
#ifdef CYLINDER_SPRITE\r
  vec3 normal;\r
  vec3 viewNormalSprites;\r
  float frontFaced = 1.0;\r
  float cylinderY = 0.0;\r
\r
  // ray-trace cylinder surface\r
  {\r
    vec3 p;\r
    if (!get_cylinder_point(-vViewPosition, p, frontFaced)) discard;\r
\r
    cylinderY = 0.5 * (p.y + 1.0);\r
\r
    vec4 v = vec4(p, 1.0);\r
    v = vec4(dot(v, matVec1), dot(v, matVec2), dot(v, matVec3), 1.0);\r
    pixelPosWorld = modelMatrix * v;\r
    pixelPosEye = modelViewMatrix * v;\r
\r
    vec3 localNormal = normalize(vec3(p.x, 0.0, p.z));\r
    normal = vec3(\r
      dot(localNormal, matVec1.xyz),\r
      dot(localNormal, matVec2.xyz),\r
      dot(localNormal, matVec3.xyz));\r
    #ifdef NORMALS_TO_G_BUFFER\r
      viewNormalSprites = normalize(mat3(modelViewMatrix)*normal);\r
    #endif\r
\r
    #if defined(USE_LIGHTS) && defined(SHADOWMAP)\r
      #if NUM_DIR_LIGHTS > 0\r
        // see THREE.WebGLProgram.unrollLoops\r
        #pragma unroll_loop_start\r
          for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\r
            vDirLightWorldCoord[ i ] = directionalShadowMatrix[ i ] * pixelPosWorld;\r
            vDirLightWorldNormal[ i ] = (directionalShadowMatrix[ i ] * (modelMatrix * vec4(normal, 0.0))).xyz;\r
          }\r
        #pragma unroll_loop_end\r
      #endif\r
    #endif\r
\r
    normal = normalize(normalMatrix * normal);\r
  }\r
#endif\r
\r
  #ifdef ATTR_COLOR\r
    vec3 vertexColor = vColor;\r
  #else\r
    vec3 vertexColor = vec3(1.0, 1.0, 1.0);\r
  #endif\r
\r
  #ifdef ATTR_COLOR2\r
    #ifdef CYLINDER_SPRITE\r
      float colorCoef = cylinderY; // cylinder parameter is calculated from ray-tracing\r
    #else\r
      float colorCoef = vUv.y; // cylinder parameter is interpolated as tex coord\r
    #endif\r
      // choose either color or color2\r
    vertexColor = mix(vColor2, vColor, step(0.5, colorCoef));\r
  #endif\r
\r
  // negative red component is a special condition\r
  if (vertexColor.x < 0.0) discard;\r
\r
  #ifdef DASHED_LINE\r
    if ( mod( vLineDistance, dashedLinePeriod ) > dashedLineSize ) discard;\r
  #endif\r
\r
  // transparency prepass writes only z, so we don't need to calc the color\r
  #ifdef PREPASS_TRANSP\r
    fragColor = vec4(1.0, 1.0, 1.0, 1.0);\r
    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r
    #endif\r
    return;\r
  #endif\r
\r
    float totalOpacity = opacity;\r
\r
  #ifdef ATTR_ALPHA_COLOR\r
    totalOpacity *= alphaCol;\r
  #endif\r
\r
  // discard fully transparent pixels\r
  if (totalOpacity == 0.0) discard;\r
\r
  #ifdef FAKE_OPACITY\r
    // discard pixels in checker pattern\r
    vec2 dm_coord = floor(gl_FragCoord.xy);\r
    dm_coord = fract(dm_coord * 0.5);\r
    if (totalOpacity < 1.0 && (dm_coord.x < 0.5 ^^ dm_coord.y < 0.5)) discard;\r
    vec4 diffuseColor = vec4(diffuse, 1.0);\r
  #else\r
    vec4 diffuseColor = vec4(diffuse, totalOpacity);\r
  #endif\r
\r
  float flipNormal;\r
  #if !defined (SPHERE_SPRITE) && !defined (CYLINDER_SPRITE)\r
    flipNormal = 1.0;\r
    #ifdef DOUBLE_SIDED\r
      flipNormal = float( gl_FrontFacing );\r
    #endif\r
    vec3 normal = normalize( vNormal ) * flipNormal;\r
  #endif\r
\r
    diffuseColor.rgb *= vertexColor;\r
\r
  #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
    gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r
  #endif\r
\r
  #ifdef NORMALS_TO_G_BUFFER\r
    #if defined (SPHERE_SPRITE) || defined (CYLINDER_SPRITE)\r
      vec3 viewNormaInColor = viewNormalSprites;\r
    #else\r
      vec3 viewNormaInColor = viewNormal;\r
      float frontFaced = float( gl_FrontFacing );\r
    #endif\r
    // [-1, 1] -> [0, 1]\r
    viewNormaInColor = 0.5 * viewNormaInColor + 0.5;\r
    gl_FragData[1] = vec4(viewNormaInColor, frontFaced);\r
  #endif\r
\r
  #if defined(USE_LIGHTS) && NUM_DIR_LIGHTS > 0\r
    vec3 viewDir;\r
    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
      viewDir = -pixelPosEye.xyz;\r
    #else\r
      viewDir = vViewPosition;\r
    #endif\r
    GeometricContext geometry = GeometricContext(normal, normalize( viewDir ));\r
    BlinnPhongMaterial material = BlinnPhongMaterial(diffuseColor.rgb, specular, shininess);\r
    vec3 outgoingLight = calcLighting(geometry, material, viewDir);\r
  #else\r
    vec3 outgoingLight = diffuseColor.rgb;\r
  #endif\r
\r
  #ifdef COLOR_FROM_DEPTH\r
    float depth = 0.0;\r
    #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
      gl_FragDepthEXT = calcDepthForSprites(pixelPosEye, zOffset, projectionMatrix);\r
      depth = gl_FragDepthEXT;\r
    #else\r
      depth = gl_FragCoord.z;\r
    #endif\r
    fragColor = packDepthToRGBA(depth);\r
    return;\r
  #endif\r
\r
  #ifdef COLOR_FROM_POS\r
    fragColor = world2colorMatrix * pixelPosWorld;\r
  #else\r
    #ifdef OVERRIDE_COLOR\r
      fragColor = vec4(fixedColor, diffuseColor.a);\r
    #else\r
      fragColor = vec4(outgoingLight, diffuseColor.a);//vec4(vNormal, 1.0);\r
    #endif\r
\r
    #ifdef USE_FOG\r
      float viewDistance;\r
      #if defined(SPHERE_SPRITE) || defined(CYLINDER_SPRITE)\r
        viewDistance = abs(pixelPosEye.z);\r
      #else\r
        viewDistance = vViewPosition.z;\r
      #endif\r
      float fogFactor = smoothstep( fogNear, fogFar, viewDistance) * fogAlpha;\r
      #ifdef FOG_TRANSPARENT\r
        fragColor.a = fragColor.a * (1.0 - fogFactor);\r
      #else\r
        fragColor.rgb = mix( fragColor.rgb, fogColor, fogFactor );\r
      #endif\r
    #endif\r
\r
  #endif\r
}\r
`,A_={precision:"mediump",init:function(e){this.precision=e.capabilities.getMaxPrecision("highp")}},T_=4,R_=4,Y2=new Uint8Array([24,52,0,254,145,0,122,0,0,7,170,0,34,214,0,173,8,0,86,249,0,160,4,0,226,46,0,224,211,0,3,157,0,174,247,0,12,182,0,220,216,0,1,109,0,253,154,0]),q2=no,$2=no,Z2=It,K2=It,J2=yc,L_=new fh(Y2,T_,R_,fi,xi,J2,q2,$2,K2,Z2,1);L_.needsUpdate=!0;var $a={noiseWidth:T_,noiseHeight:R_,noiseTexture:L_};function Om(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(a);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(a,r).enumerable})),t.push.apply(t,n)}return t}function Dm(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Om(Object(t),!0).forEach(function(n){Le(a,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):Om(Object(t)).forEach(function(n){Object.defineProperty(a,n,Object.getOwnPropertyDescriptor(t,n))})}return a}function Q2(a){var e=eR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function eR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var tR=[new ve(-.541978,.840393),new ve(.125533,-.992089),new ve(.374329,.927296),new ve(-.105475,.994422)],rR=qi.merge([Ue.fog,Ue.lights,{diffuse:{value:new ze(15658734)},opacity:{value:1},specular:{type:"c",value:new ze(1118481)},shininess:{type:"f",value:30},fixedColor:{type:"c",value:new ze(16777215)},zOffset:{type:"f",value:0},zClipValue:{type:"f",value:0},clipPlaneValue:{type:"f",value:0},nearPlaneValue:{type:"f",value:-.5},invModelViewMatrix:{type:"4fv",value:new Ce},world2colorMatrix:{type:"4fv",value:new Ce},dashedLineSize:{type:"f",value:.1},dashedLinePeriod:{type:"f",value:.2},projMatrixInv:{type:"4fv",value:new Ce},viewport:{type:"v2",value:new ve},lineWidth:{type:"f",value:2},fogAlpha:{type:"f",value:1},samplesKernel:{type:"v2v",value:null},noiseTex:{type:"t",value:null},noiseTexelSize:{type:"v2",value:null},srcTexelSize:{type:"v2",value:null}}]),nR=["shininess","opacity","zOffset","diffuse","specular","fixedColor","zClipCoef","zClipValue","clipPlaneValue","world2colorMatrix","dashedLineSize","dashedLinePeriod","projMatrixInv","viewport","lineWidth","fogAlpha","samplesKernel","noiseTex","noiseTexelSize","srcTexelSize"],iR={diffuse:new ze(16777215),specular:new ze(1118481),shininess:30,opacity:1,fixedColor:new ze(16777215),zOffset:0,zClipCoef:2,zClipValue:0,clipPlaneValue:0,world2colorMatrix:new Ce,dashedLineSize:.1,dashedLinePeriod:.3,projMatrixInv:new Ce,viewport:new ve(800,600),lineWidth:2,fogAlpha:1,samplesKernel:tR,noiseTex:$a.noiseTexture,noiseTexelSize:new ve(1/$a.noiseWidth,1/$a.noiseHeight),srcTexelSize:new ve(1/800,1/600),copy:function(e){this.diffuse.copy(e.diffuse),this.specular.copy(e.specular),this.shininess=e.shininess,this.opacity=e.opacity,this.fixedColor.copy(e.fixedColor),this.zOffset=e.zOffset,this.zClipCoef=e.zClipCoef,this.zClipValue=e.zClipValue,this.clipPlaneValue=e.clipPlaneValue,this.world2colorMatrix.copy(e.world2colorMatrix),this.dashedLineSize=e.dashedLineSize,this.dashedLinePeriod=e.dashedLinePeriod,this.projMatrixInv=e.projMatrixInv,this.viewport=e.viewport,this.lineWidth=e.lineWidth,this.toonShading=e.toonShading,this.fogAlpha=e.fogAlpha,this.samplesKernel=e.samplesKernel,this.noiseTex=e.noiseTex,this.noiseTexelSize=e.noiseTexelSize,this.srcTexelSize=e.srcTexelSize}},Mn=function(a){re(t,a);var e=Q2(t);function t(n){var r;return G(this,t),r=e.call(this,n),r.fog=!0,r.instancedPos=!1,r.instancedMatrix=!1,r.attrColor=!1,r.attrColor2=!1,r.attrAlphaColor=!1,r.overrideColor=!1,r.sphereSprite=!1,r.cylinderSprite=!1,r.zClip=!1,r.clipPlane=!1,r.fakeOpacity=!1,r.prepassTransparancy=!1,r.colorFromPos=!1,r.shadowmap=!1,r.shadowmapType="random",r.colorFromDepth=!1,r.orthoCam=!1,r.dashedLine=!1,r.transparent=!0,r.thickLine=!1,r.fogTransparent=!1,r.normalsToGBuffer=!1,r.toonShading=!1,r.uberOptions=iR,r.setValues(Dm({uniforms:qi.clone(rR),vertexShader:r.precisionString()+X2,fragmentShader:r.precisionString()+j2,lights:!0,fog:!0,side:Yi},n)),r}return H(t,[{key:"precisionString",value:function(){var r=A_.precision,i="precision ".concat(r,` float;
`)+"precision ".concat(r,` int;

`);return i}},{key:"copy",value:function(r){return xt(D(t.prototype),"copy",this).call(this,r),this.fragmentShader=r.fragmentShader,this.vertexShader=r.vertexShader,this.uniforms=qi.clone(r.uniforms),this.defines=Dm({},r.defines),this.extensions=r.extensions,this.fog=r.fog,this.instancedPos=r.instancedPos,this.instancedMatrix=r.instancedMatrix,this.attrColor=r.attrColor,this.attrColor2=r.attrColor2,this.attrAlphaColor=r.attrAlphaColor,this.overrideColor=r.overrideColor,this.sphereSprite=r.sphereSprite,this.cylinderSprite=r.cylinderSprite,this.zClip=r.zClip,this.clipPlane=r.clipPlane,this.fakeOpacity=r.fakeOpacity,this.colorFromPos=r.colorFromPos,this.shadowmap=r.shadowmap,this.shadowmapType=r.shadowmapType,this.colorFromDepth=r.colorFromDepth,this.orthoCam=r.orthoCam,this.prepassTransparancy=r.prepassTransparancy,this.dashedLine=r.dashedLine,this.thickLine=r.thickLine,this.fogTransparent=r.fogTransparent,this.normalsToGBuffer=r.normalsToGBuffer,this.toonShading=r.toonShading,this.uberOptions.copy(r.uberOptions),this}},{key:"createInstance",value:function(){var r=new t;return r.copy(this),r.uberOptions=Object.create(this.uberOptions),r}},{key:"setValues",value:function(r){if(!(typeof r>"u")){xt(D(t.prototype),"setValues",this).call(this,r);var i={},s={};this.fog&&(i.USE_FOG=1),this.instancedPos&&(i.INSTANCED_POS=1),this.instancedMatrix&&(i.INSTANCED_MATRIX=1),this.attrColor&&(i.ATTR_COLOR=1),this.attrColor2&&(i.ATTR_COLOR2=1),this.attrAlphaColor&&(i.ATTR_ALPHA_COLOR=1),this.overrideColor&&(i.OVERRIDE_COLOR=1),this.sphereSprite&&(i.SPHERE_SPRITE=1,s.fragDepth=1),this.cylinderSprite&&(i.CYLINDER_SPRITE=1,s.fragDepth=1),this.zClip&&(i.ZCLIP=1),this.clipPlane&&(i.CLIP_PLANE=1),this.fakeOpacity&&(i.FAKE_OPACITY=1),this.lights&&(i.USE_LIGHTS=1),this.colorFromPos&&(i.COLOR_FROM_POS=1),this.shadowmap&&(i.SHADOWMAP=1,this.shadowmapType==="pcf"?i.SHADOWMAP_PCF_SHARP=1:this.shadowmapType==="random"?i.SHADOWMAP_PCF_RAND=1:i.SHADOWMAP_BASIC=1),this.colorFromDepth&&(i.COLOR_FROM_DEPTH=1),this.orthoCam&&(i.ORTHOGRAPHIC_CAMERA=1),this.prepassTransparancy&&(i.PREPASS_TRANSP=1),this.dashedLine&&(i.DASHED_LINE=1),this.thickLine&&(i.THICK_LINE=1),this.fogTransparent&&(i.FOG_TRANSPARENT=1),this.normalsToGBuffer&&(s.drawBuffers=1,i.NORMALS_TO_G_BUFFER=1),this.toonShading&&(i.TOON_SHADING=1),this.defines=i,this.extensions=s}}},{key:"setUberOptions",value:function(r){if(!(typeof r>"u"))for(var i in r)r.hasOwnProperty(i)&&(this.uberOptions[i]instanceof ze?this.uberOptions[i]=r[i].clone():this.uberOptions[i]=r[i])}},{key:"clone",value:function(r){return r?this.createInstance():er.prototype.clone.call(this)}},{key:"updateUniforms",value:function(){var r=this;nR.forEach(function(i){r.uniforms.hasOwnProperty(i)&&(r.uberOptions[i]instanceof ze||r.uberOptions[i]instanceof Ce?r.uniforms[i].value=r.uberOptions[i].clone():r.uniforms[i].value=r.uberOptions[i])})}}]),t}(Ur);function aR(a){var e=sR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function sR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Zi(a){var e=function(t){re(r,t);var n=aR(r);function r(){var i;G(this,r);for(var s=arguments.length,o=new Array(s),l=0;l<s;l++)o[l]=arguments[l];return i=n.call.apply(n,[this].concat(o)),i.onBeforeRender=r.prototype.onBeforeRender,i}return H(r,[{key:"onBeforeRender",value:function(s,o,l,c,u,f){this._onBeforeRender(s,o,l,c,u,f),this._update()}},{key:"_onBeforeRender",value:function(){}},{key:"_update",value:function(){var s=this.material;s&&s instanceof Mn&&s.updateUniforms()}}]),r}(a);return e}function oR(a){var e=lR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function lR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Fm=Zi(ft),P_=function(a){re(t,a);var e=oR(t);function t(){var n;G(this,t);for(var r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return n=e.call.apply(e,[this].concat(i)),n.castShadow=!0,n.receiveShadow=!0,n}return H(t,[{key:"_onBeforeRender",value:function(r,i,s,o,l,c){Fm.prototype._onBeforeRender.call(this,r,i,s);var u=this.material;u&&u.uniforms.invModelViewMatrix&&(this.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,this.matrixWorld),u.uniforms.invModelViewMatrix.value.copy(this.modelViewMatrix).invert(),u.uniforms.nearPlaneValue.value=s.near,u.uniformsNeedUpdate=!0)}}]),t}(Fm);function cR(a){var e=uR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function uR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Bm=Zi(ft),Fc=function(a){re(t,a);var e=cR(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i.castShadow=!0,i.receiveShadow=!0,i}return H(t,[{key:"_onBeforeRender",value:function(r,i,s){Bm.prototype._onBeforeRender.call(this,r,i,s);var o=this.geometry,l=this.material;if(!(!o.zClip||!l.uberOptions)){var c=.5,u=t._modelView,f=t._mvLength,h=t._center;u.multiplyMatrices(this.matrixWorld,s.matrixWorldInverse);var d=f.setFromMatrixColumn(u,0).length();h.copy(o.boundingSphere.center),this.localToWorld(h),l.uberOptions.zClipValue=s.position.z-h.z-d*(c*o.boundingSphere.radius)}}}]),t}(Bm);Le(Fc,"_mvLength",new b);Le(Fc,"_center",new b);Le(Fc,"_modelView",new Ce);function fR(a){var e=hR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function hR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var dR=function(a){re(t,a);var e=fR(t);function t(n,r){var i;G(this,t),i=e.call(this),i.geometry=n;var s=qr(i);return s.initialized=!1,i.geometry.addEventListener("update",function(){s.update()}),i}return H(t,[{key:"init",value:function(){for(var r=this.children,i=r.length-1;i>=0;--i)this.remove(r[i]);for(var s=this.geometry,o=s.items,l=s.userData,c=0,u=o.length;c<u;++c){var f=o[c];if(f){var h=Se.shallowCloneNode(f),d=new kh(h);d.userData=le.clone(l);var p=d.getElement();p.style.visibility="visible",d.source=f,this.add(d)}}this.initialized=!0}},{key:"update",value:function(){var r=this.geometry;if(r.needsUpdate){var i=this.children;this.initialized||this.init();for(var s=0,o=i.length;s<o;++s){var l=i[s],c=l.source;l.position.copy(c.worldPos),l.userData.color=c.opts.color,l.userData.background=c.opts.background}}}}]),t}(nr);function pR(a){var e=mR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function mR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var vR=Zi(ft),gR=function(a){re(t,a);var e=pR(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i.castShadow=!0,i.receiveShadow=!0,i}return H(t)}(vR);function _R(a){var e=yR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function yR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var xR=Zi(ft),$u=new ve,N_=function(a){re(t,a);var e=_R(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_onBeforeRender",value:function(r,i,s,o,l,c){var u=this.material;u.uberOptions&&(u.uberOptions.projMatrixInv.copy(s.projectionMatrix).invert(),r.getSize($u),u.uberOptions.viewport.set($u.width,$u.height))}}]),t}(xR);function SR(a){var e=bR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function bR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var wR=Zi(ft),MR=function(a){re(t,a);var e=SR(t);function t(){var n;G(this,t);for(var r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return n=e.call.apply(e,[this].concat(i)),n.castShadow=!0,n.receiveShadow=!0,n}return H(t)}(wR),jr={ZClipped:Fc,ZSprite:P_,Text:dR,Line:Zi(ea),LineSegments:Zi(Gr),Mesh:gR,ThickLineMesh:N_,Instanced:MR};function To(a,e){return function(t){t.setValues(a),t.setUberOptions(e)}}function zm(a,e){return{Geometry:function(n,r){return new mn.Instanced2CCylindersGeometry(n,r,a,e)},Object:a?jr.ZSprite:jr.Instanced,initMaterial:To({instancedMatrix:!0,attrColor:!0,attrColor2:!0,attrAlphaColor:!0,cylinderSprite:a})}}function Zu(a,e){var t=a.prototype instanceof S_,n=e.lineWidth||0;return{Geometry:a,Object:t?jr.ThickLineMesh:jr.LineSegments,initMaterial:To({lights:!1,attrColor:!0,attrAlphaColor:!0,thickLine:t},{lineWidth:n})}}function ER(a){return{Geometry:a,Object:jr.Mesh,initMaterial:To({attrColor:!0,attrAlphaColor:!0})}}function Ku(a,e,t,n){var r={wireframe:!!n.wireframe,fakeOpacity:t.now.isoSurfaceFakeOpacity,zClip:n.zClip};return{Geometry:a,Object:jr.ZClipped,initMaterial:To({attrColor:!0,attrAlphaColor:!1,wireframe:r.wireframe,fakeOpacity:r.fakeOpacity,zClip:r.zClip})}}var xr=function(){function a(){G(this,a)}return H(a,null,[{key:"createSpheres",value:function(t,n){var r=n.now.zSprites;return{Geometry:function(s,o){return new mn.InstancedSpheresGeometry(s,o,r)},Object:r?jr.ZSprite:jr.Instanced,initMaterial:To({instancedPos:!0,attrColor:!0,attrAlphaColor:!0,sphereSprite:r})}}},{key:"create2CClosedCylinders",value:function(t,n){return zm(!1,!1)}},{key:"create2CCylinders",value:function(t,n){return zm(n.now.zSprites,!0)}},{key:"create2CLines",value:function(t,n,r){return Zu(mn.TwoColorLinesGeometry,r)}},{key:"createCrosses",value:function(t,n,r){return Zu(mn.CrossGeometry,r)}},{key:"createExtrudedChains",value:function(t,n){return ER(mn.ExtrudedObjectsGeometry)}},{key:"createChunkedLines",value:function(t,n,r){return Zu(mn.ChunkedLinesGeometry,r)}},{key:"createQuickSurface",value:function(t,n,r){return Ku(mn.QuickSurfGeometry,t,n,r)}},{key:"createContactSurface",value:function(t,n,r){return Ku(mn.ContactSurfaceGeometry,t,n,r)}},{key:"createSASSES",value:function(t,n,r){return Ku(mn.SSIsosurfaceGeometry,t,n,r)}},{key:"createLabels",value:function(t,n){return{Geometry:mn.LabelsGeometry,Object:jr.Text,initMaterial:function(){}}}}]),a}();function CR(a){var e=AR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function AR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Bh=function(a){re(t,a);var e=CR(t);function t(n,r,i,s){var o;G(this,t),o=e.call(this),o._geometry=n,o._geoParams=r;var l=i.createInstance();r.initMaterial(l),o._material=l,o._transforms=s.length>0?s:[new Ce];for(var c=o._createMeshes(n),u=0,f=c.length;u<f;++u)o.add(c[u]);return o}return H(t,[{key:"raycast",value:function(r,i){var s=t._ray,o=t._inverseMatrix,l=this.children;s.copy(r.ray);for(var c=0,u=l.length;c<u;++c){var f=l[c];if(Je.belongToSelectLayers(f)){f.updateMatrixWorld();var h=f.matrixWorld;o.copy(h).invert(),r.ray.copy(s).applyMatrix4(o);var d=[];this._geometry.raycast(r,d);for(var p=0,v=d.length;p<v;++p){var _=d[p];_.point&&(_.point.applyMatrix4(h),_.distance=s.origin.distanceTo(_.point)),_.object=f,i[i.length]=_}}}r.ray.copy(s)}},{key:"getSubset",value:function(r){for(var i=this._geometry.getSubset(r),s=[],o=0,l=0,c=i.length;l<c;++l)for(var u=this._createMeshes(i[l]),f=0,h=u.length;f<h;++f)s[o++]=u[f];return s}},{key:"_createMeshes",value:function(r){for(var i=this._transforms,s=this._geoParams.Object,o=this._material,l=[],c=0,u=i.length;c<u;++c){var f=new s(r,o);f.applyMatrix4(i[c]),l[c]=f}return l}}]),t}(lt);Le(Bh,"_inverseMatrix",new Ce);Le(Bh,"_ray",new Ei);function TR(a){var e=RR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function RR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function LR(a,e){var t=[a].concat(e);return a.bind.apply(a,$i(t))}var Bc=function(a){re(t,a);var e=TR(t);function t(n,r,i,s,o,l,c){var u;if(G(this,t),u=e.call(this),u.constructor===t)throw new Error("Can not instantiate abstract class!");return u._selection=r,u._mode=s,u._colorer=i,u._chunksIdc=r.chunks,u._polyComplexity=l,u._geo=new(LR(n.Geometry,u._makeGeoArgs())),u._mesh=new Bh(u._geo,n,c,o),u.add(u._mesh),u._build(),u}return H(t,[{key:"_makeGeoArgs",value:function(){throw new Error("ChemGroup subclass must override _makeGeoArgs() method")}},{key:"getSubset",value:function(r,i){i=i!==void 0?i:!1;var s=this._calcChunksList(r,i);return s.length===0?[]:this._mesh.getSubset(s)}},{key:"_changeSubsetOpacity",value:function(r,i,s){var o=this._calcChunksList(r,s);o.length!==0&&this._geo.setOpacity(o,i)}},{key:"enableSubset",value:function(r,i){i=i!==void 0?i:!0,this._changeSubsetOpacity(r,1,i)}},{key:"disableSubset",value:function(r,i){i=i!==void 0?i:!0,this._changeSubsetOpacity(r,0,i)}}]),t}(na);function PR(a){var e=NR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function NR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var zh=function(a){re(t,a);var e=PR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"raycast",value:function(r,i){var s=this._selection.atoms,o=[];this._mesh.raycast(r,o);for(var l=this._chunksIdc,c=0,u=o.length;c<u;++c)if(o[c].hasOwnProperty("chunkIdx")){var f=l[o[c].chunkIdx];f<s.length&&(o[c].atom=s[f],i.push(o[c]))}}},{key:"_calcChunksList",value:function(r){for(var i=[],s=this._selection.atoms,o=this._chunksIdc,l=0,c=o.length;l<c;++l){var u=s[o[l]];u.mask&r&&i.push(l)}return i}}]),t}(Bc);function IR(a){var e=kR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function kR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Vh=function(a){re(t,a);var e=IR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_build",value:function(){for(var r=this._selection.chunks,i=this._selection,s=i.atoms,o=i.parent,l=this._mode,c=this._colorer,u=this._geo,f=0,h=r.length;f<h;++f){var d=s[r[f]];u.setItem(f,d.position,l.calcAtomRadius(d)),u.setColor(f,c.getAtomColor(d,o))}u.finalize()}},{key:"updateToFrame",value:function(r){for(var i=this._selection.chunks,s=this._selection.atoms,o=this._mode,l=this._colorer,c=r.needsColorUpdate(l),u=this._geo,f=0,h=i.length;f<h;++f){var d=s[i[f]];u.setItem(f,r.getAtomPos(i[f]),o.calcAtomRadius(d)),c&&u.setColor(f,r.getAtomColor(l,d))}u.finalize()}}]),t}(zh);function OR(a){var e=DR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function DR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var FR=function(a){re(t,a);var e=OR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){for(var r=[],i=this._selection,s=i.atoms,o=i.chunks,l=o.length,c=0;c<l;++c)r[c]=s[o[c]];var u=this._mode.getSurfaceOpts();return u.atoms=r,[l,u]}}]),t}(Vh);function BR(a){var e=zR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function zR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var VR=function(a){re(t,a);var e=BR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){for(var r=[],i=this._selection,s=i.atoms,o=i.chunks,l=o.length,c=0;c<l;++c)r[c]=s[o[c]];var u=this._mode.getSurfaceOpts();return u.atoms=r,u.selection=this._selection,u.colorMode=this._colorer,[l,u]}}]),t}(Vh);function UR(a){var e=GR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function GR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function HR(a){var e=a>>16&255,t=a>>8&255,n=a&255;return .2126*e+.7152*t+.0722*n>127?(e=e*3/10,t=t*3/10,n=n*3/10):(e=255-(255-e)*3/10,t=255-(255-t)*3/10,n=255-(255-n)*3/10),e<<16|t<<8|n}function WR(a){var e=a>>16&255,t=a>>8&255,n=a&255;return 255-e<<16|255-t<<8|255-n}function Vm(a){return a.name.getNode()!==null?a.name.getNode():a.getVisualName()}var Um={none:function(e){return e},adjust:HR,inverse:WR};function Gl(a,e){var t;if(Um.hasOwnProperty(e))t=Se.hexColor(Um[e](a));else{var n=parseInt(e,16);!Number.isNaN(n)&&e.toLowerCase().startsWith("0x")?t=Se.hexColor(n):t="#000000"}return t}var Gm={serial:function(e){return e.serial},name:function(e){return e.getVisualName()},elem:function(e){return e.element.name},residue:function(e){return e.residue.getType().getName()},sequence:function(e){return e.residue.getSequence()},chain:function(e){return e.residue.getChain().getName()},hetatm:function(e){return e.isHet()},water:function(e){return e.residue.getType().getName()==="HOH"||e.residue.getType().getName()==="WAT"}},Hm=function(e,t){return t.replace(/\{\{(\s*\w+\s*)\}\}/g,function(n){var r=n.replace(/\s+/g,"");return r=r.substring(2,r.length-2).toLowerCase(),Gm.hasOwnProperty(r)?Gm[r](e):"null"})},XR=function(a){re(t,a);var e=UR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){var r=this._mode.getLabelOpts();return[this._selection.chunks.length,r]}},{key:"_build",value:function(){for(var r=this._mode.getLabelOpts(),i=this._selection.chunks,s=this._selection,o=s.atoms,l=s.parent,c=this._colorer,u=this._geo,f=0,h=i.length;f<h;++f){var d=o[i[f]],p=r.template?Hm(d,r.template):Vm(d);if(p){var v=c.getAtomColor(d,l),_=parseInt(Gl(v,r.fg).substring(1),16),m=r.showBg?parseInt(Gl(v,r.bg).substring(1),16):"transparent";u.setItem(f,d.position,p),u.setColor(f,_,m)}}u.finalize()}},{key:"updateToFrame",value:function(r){for(var i=this._mode.getLabelOpts(),s=this._selection.chunks,o=this._selection.atoms,l=this._colorer,c=this._geo,u=r.needsColorUpdate(l),f=0,h=s.length;f<h;++f){var d=o[s[f]],p=i.template?Hm(d,i.template):Vm(d);if(p){var v=r.getAtomColor(l,d),_=parseInt(Gl(v,i.fg).substring(1),16),m=i.showBg?parseInt(Gl(v,i.bg).substring(1),16):"transparent";c.setItem(f,r.getAtomPos(s[f]),p),u&&c.setColor(f,_,m)}}c.finalize()}}]),t}(zh);function jR(a){var e=YR();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function YR(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Wm(a,e,t,n){var r=Math.sin(a);return e.clone().multiplyScalar(Math.sin((1-n)*a)/r).addScaledVector(t,Math.sin(n*a)/r)}var I_=function(a){re(t,a);var e=jR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_buildInner",value:function(r,i){for(var s=this._selection.chunks,o=new b,l=new b,c=this._segmentsHeight,u=1/c,f=this._colorer,h=this._selection,d=h.cycles,p=h.parent,v=0,_=s[v],m=0,g=d.length;m<g;++m){var y=d[m],x=y.atoms,S=[],M=[],E=y.center,N=y.radius-r,B=x.length,V=0,O=x[B-1].position,W=x[V].position;o.subVectors(O,E),l.subVectors(W,E);for(var z=l.clone().cross(o).normalize();V<B;++V){var C=o.angleTo(l);M[V]=Wm(C,o,l,.5).normalize(),W=x[(V+1)%B].position,o.copy(l),l.subVectors(W,E)}for(V=0;V<B;++V)if(x[V].index===_){for(var T=M[V],A=M[(V+1)%B],F=f.getAtomColor(x[V],p),X=T.angleTo(A),Y=0;Y<=c;++Y)S[Y]=Wm(X,T,A,Y*u).multiplyScalar(N).add(E);i(v++,F,S,E,z),_=s[v]}}}}]),t}(zh);function qR(a){var e=$R();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function $R(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ZR(a,e){for(var t=[],n=0;n<e;++n){var r=-2*n/e*Math.PI;t.push(new b(Math.cos(r)*a,Math.sin(r)*a,0))}return t}var KR=Je.calcChunkMatrix,JR=function(a){re(t,a);var e=qR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){var r=this._segmentsHeight,i=this._mode.getAromRadius(),s=new ve(i,i),o=this._mode.calcStickRadius()+2*i,l=new b,c=[],u=this._geo;this._buildInner(o,function(f,h,d,p,v){for(var _=0;_<=r;++_){var m=d[_],g=m.clone().sub(p).cross(v);l.addVectors(m,g),c[_]=KR(m,l,v,s)}u.setItem(f,c),u.setColor(f,h)}),u.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._polyComplexity,[ZR(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length]}}]),t}(I_);function QR(a){var e=e3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function e3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var t3=function(a){re(t,a);var e=QR(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){var r=this,i=this._geo,s=this._mode.getAromaticOffset();this._buildInner(s,function(o,l,c){for(var u=c[0],f=1;f<=r._segmentsHeight;++f){var h=c[f];i.setSegment(o,f-1,u,h),u=h}i.setColor(o,l)}),i.finalize()}},{key:"_makeGeoArgs",value:function(){return this._segmentsHeight=this._mode.getAromaticArcChunks(),[this._selection.chunks.length,this._segmentsHeight,!0]}}]),t}(I_);function r3(a){var e=n3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function n3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var k_=function(a){re(t,a);var e=r3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"raycast",value:function(r,i){var s=this._selection.residues,o=[];this._mesh.raycast(r,o);for(var l=this._chunksIdc,c=0,u=o.length;c<u;++c)if(o[c].hasOwnProperty("chunkIdx")){var f=l[o[c].chunkIdx];f<s.length&&(o[c].residue=s[f],i.push(o[c]))}}},{key:"_calcChunksList",value:function(r){for(var i=[],s=this._selection.residues,o=this._chunksIdc,l=0,c=o.length;l<c;++l){var u=s[o[l]];u._mask&r&&i.push(l)}return i}}]),t}(Bc);function i3(a){var e=a3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function a3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var O_=function(a){re(t,a);var e=i3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"raycast",value:function(r,i){var s=this._selection.residues,o=[];this._mesh.raycast(r,o);for(var l=this._chunksIdc,c=0,u=o.length;c<u;++c)if(o[c].hasOwnProperty("chunkIdx")){var f=l[Math.floor(o[c].chunkIdx/2)];f<s.length&&(o[c].residue=s[f],i.push(o[c]))}}},{key:"_build",value:function(){for(var r=this._selection,i=r.residues,s=r.parent,o=this._colorer,l=this._geo,c=this._mode.calcStickRadius(),u=0,f=this._selection.chunks,h=0,d=f.length;h<d;++h){var p=i[f[h]],v=o.getResidueColor(p,s);this._processItem(u++,p._cylinders[0],p._cylinders[1],c,v)}l.finalize()}},{key:"_calcChunksList",value:function(r){for(var i=[],s=0,o=this._selection.residues,l=this._chunksIdc,c=0,u=l.length;c<u;++c){var f=o[l[c]];f._mask&r&&(i[s++]=2*c,i[s++]=2*c+1)}return i}},{key:"updateToFrame",value:function(r){for(var i=r.getResidues(),s=this._selection.parent,o=this._colorer,l=this._geo,c=this._mode.calcStickRadius(),u=0,f=this._selection.chunks,h=0,d=f.length;h<d;++h){var p=i[f[h]],v=o.getResidueColor(p,s);this._processItem(u++,p._cylinders[0],p._cylinders[1],c,v)}l.finishUpdate()}}]),t}(k_);function s3(a){var e=o3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function o3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var l3=function(a){re(t,a);var e=s3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length,this._polyComplexity]}},{key:"_processItem",value:function(r,i,s,o,l){var c=this._geo;c.setItem(r,i,s,o),c.setColor(r,l,l)}}]),t}(O_);function c3(a){var e=u3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function u3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var f3=function(a){re(t,a);var e=c3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){return[this._selection.chunks.length*2,this._polyComplexity]}},{key:"_processItem",value:function(r,i,s,o,l){var c=this._geo,u=r*2;c.setItem(u,i,o),c.setColor(u,l),u++,c.setItem(u,s,o),c.setColor(u,l)}}]),t}(O_),Zl={};(function(a){(function(){var e,t,n,r,i,s,o,l,c,u,f,h,d,p,v,_,m,g,y,x,S,M,E,N,B,V,O=Object.prototype.hasOwnProperty,W=function(C,T){for(var A in T)O.call(T,A)&&(C[A]=T[A]);function F(){this.constructor=C}return F.prototype=T.prototype,C.prototype=new F,C.__super__=T.prototype,C};n={METHOD_NEAREST:"nearest",METHOD_LINEAR:"linear",METHOD_CUBIC:"cubic",METHOD_LANCZOS:"lanczos",METHOD_SINC:"sinc",CLIP_CLAMP:"clamp",CLIP_ZERO:"zero",CLIP_PERIODIC:"periodic",CLIP_MIRROR:"mirror",CUBIC_TENSION_DEFAULT:0,CUBIC_TENSION_CATMULL_ROM:0},h={method:n.METHOD_CUBIC,cubicTension:n.CUBIC_TENSION_DEFAULT,clip:n.CLIP_CLAMP,scaleTo:0,sincFilterSize:2,sincWindow:void 0},c=function(C,T){return Math.max(0,Math.min(C,T-1))},f=function(C,T){return C=C%T,C<0&&(C+=T),C},u=function(C,T){var A;return A=2*(T-1),C=f(C,A),C>T-1&&(C=A-C),C},e=function(){function z(C,T){if(this.array=C.slice(0),this.length=this.array.length,!(this.clipHelper={clamp:this.clipHelperClamp,zero:this.clipHelperZero,periodic:this.clipHelperPeriodic,mirror:this.clipHelperMirror}[T.clip]))throw"Invalid clip: "+T.clip}return z.prototype.getClippedInput=function(C){return 0<=C&&C<this.length?this.array[C]:this.clipHelper(C)},z.prototype.clipHelperClamp=function(C){return this.array[c(C,this.length)]},z.prototype.clipHelperZero=function(C){return 0},z.prototype.clipHelperPeriodic=function(C){return this.array[f(C,this.length)]},z.prototype.clipHelperMirror=function(C){return this.array[u(C,this.length)]},z.prototype.interpolate=function(C){throw"Subclasses of AbstractInterpolator must override the interpolate() method."},z}(),i=function(z){W(C,z);function C(){C.__super__.constructor.apply(this,arguments)}return C.prototype.interpolate=function(T){return this.getClippedInput(Math.round(T))},C}(e),r=function(z){W(C,z);function C(){C.__super__.constructor.apply(this,arguments)}return C.prototype.interpolate=function(T){var A;return A=Math.floor(T),T-=A,(1-T)*this.getClippedInput(A)+T*this.getClippedInput(A+1)},C}(e),t=function(z){W(C,z);function C(T,A){this.tangentFactor=1-Math.max(-1,Math.min(1,A.cubicTension)),C.__super__.constructor.apply(this,arguments)}return C.prototype.getTangent=function(T){return this.tangentFactor*(this.getClippedInput(T+1)-this.getClippedInput(T-1))/2},C.prototype.interpolate=function(T){var A,F,X,Y,ne;return A=Math.floor(T),F=[this.getTangent(A),this.getTangent(A+1)],X=[this.getClippedInput(A),this.getClippedInput(A+1)],T-=A,Y=T*T,ne=T*Y,(2*ne-3*Y+1)*X[0]+(ne-2*Y+T)*F[0]+(-2*ne+3*Y)*X[1]+(ne-Y)*F[1]},C}(e),M=Math.sin,s=Math.PI,E=function(C){return C===0?1:M(s*C)/(s*C)},m=function(C){return function(T){return E(T/C)}},y=function(C){return function(T){return E(T)*C(T)}},o=function(z){W(C,z);function C(T,A){if(C.__super__.constructor.apply(this,arguments),this.a=A.sincFilterSize,!A.sincWindow)throw"No sincWindow provided";this.kernel=y(A.sincWindow)}return C.prototype.interpolate=function(T){var A,F,X,Y,ne;for(A=Math.floor(T),X=0,F=Y=A-this.a+1,ne=A+this.a;Y<=ne?F<=ne:F>=ne;Y<=ne?F++:F--)X+=this.kernel(T-F)*this.getClippedInput(F);return X},C}(e),d=function(C,T){var A,F,X,Y;for(Y=[],F=0,X=C.length;F<X;F++)A=C[F],Y.push(A[T]);return Y},g=function(C,T,A){var F,X;return A.join==="0,1"?C:(F=T/(A[1]-A[0]),X=A[0],function(Y){return C(F*(Y-X))})},p=function(C){return Object.prototype.toString.call(C).slice(8,-1)},B=function(C){if(isNaN(C))throw"NaN in Smooth() input";if(p(C)!=="Number")throw"Non-number in Smooth() input";if(!isFinite(C))throw"Infinity in Smooth() input"},V=function(C,T){var A,F,X;if(p(C)!=="Array")throw"Non-vector in Smooth() input";if(C.length!==T)throw"Inconsistent dimension in Smooth() input";for(F=0,X=C.length;F<X;F++)A=C[F],B(A)},v=function(C){return p(C)==="Number"&&isFinite(C)&&!isNaN(C)},x=function(C){var T;switch(T="scaleTo param must be number or array of two numbers",p(C)){case"Number":if(!v(C))throw T;C=[0,C];break;case"Array":if(C.length!==2||!(v(C[0])&&v(C[1])))throw T;break;default:throw T}return C},S=function(C){var T,A,F;T={};for(A in C)O.call(C,A)&&(F=C[A],T[A]=F);return T},l=function(C,T){var A,F,X,Y,ne,ae,xe,be,ge,we,q;T==null&&(T={}),ge={},T=S(T),ge.config=S(T),T.scaleTo==null&&(T.scaleTo=T.period),T.sincFilterSize==null&&(T.sincFilterSize=T.lanczosFilterSize);for(xe in h)O.call(h,xe)&&(q=h[xe],T[xe]==null&&(T[xe]=q));if(!(ne={nearest:i,linear:r,cubic:t,lanczos:o,sinc:o}[T.method]))throw"Invalid method: "+T.method;if(T.method==="lanczos"&&(T.sincWindow=m(T.sincFilterSize)),C.length<2)throw"Array must have at least two elements";ge.count=C.length,we=function(){var Ge,Te,Pe,Ee;switch(p(C[0])){case"Number":if(ge.dimension="scalar",l.deepValidation)for(Ge=0,Pe=C.length;Ge<Pe;Ge++)be=C[Ge],B(be);return Y=new ne(C,T),function(_e){return Y.interpolate(_e)};case"Array":if(ge.dimension=F=C[0].length,!F)throw"Vectors must be non-empty";if(l.deepValidation)for(Te=0,Ee=C.length;Te<Ee;Te++)q=C[Te],V(q,F);return ae=function(){var _e;for(_e=[],X=0;0<=F?X<F:X>F;0<=F?X++:X--)_e.push(new ne(d(C,X),T));return _e}(),function(_e){var ie,oe,K,de;for(de=[],oe=0,K=ae.length;oe<K;oe++)ie=ae[oe],de.push(ie.interpolate(_e));return de};default:throw"Invalid element type: "+p(C[0])}}(),T.clip==="periodic"?A=C.length:A=C.length-1,T.scaleTo||(T.scaleTo=A),ge.domain=x(T.scaleTo),we=g(we,A,ge.domain),ge.domain.sort();for(xe in ge)O.call(ge,xe)&&(q=ge[xe],we[xe]=q);return we};for(_ in n)O.call(n,_)&&(N=n[_],l[_]=N);l.deepValidation=!0,(a!==null?a:window).Smooth=l}).call(s_)})(Zl);var h3=qe.ResidueType,d3=Je.calcChunkMatrix;function Xm(a,e){var t=Zl.Smooth(a,{method:Zl.Smooth.METHOD_CUBIC,clip:Zl.Smooth.CLIP_CLAMP,cubicTension:e,scaleTo:1});return function(n,r){var i=r;i===null&&(i=function(c){return(c*(a.length-1-2)+1)/(a.length-1)});var s=i(n),o=t(s);return new b(o[0],o[1],o[2])}}function Us(a,e,t,n){if(!n._isValid){a[t]=a[t-1],e[t]=e[t-1];return}var r=n._controlPoint;a[t]=[r.x,r.y,r.z];var i=r.clone().add(n._wingVector);e[t]=[i.x,i.y,i.z]}function p3(a,e,t,n){var r=(n._type.flags&h3.Flags.NUCLEIC)!==0,i=r?"C5'":"N",s=r?"C3'":"C",o,l;if(n.forEachAtom(function(m){var g=m.getVisualName();!o&&g===i?o=m.position:!l&&g===s&&(l=m.position)}),o&&l||(o=n._firstAtom.position,l=n._lastAtom.position),o&&l){var c=l.clone().sub(o),u=n._wingVector,f=n._controlPoint,h=f.clone().add(u),d=f.clone().sub(c),p=d.clone().add(u);a[t]=[d.x,d.y,d.z],e[t]=[p.x,p.y,p.z],++t,a[t]=[d.x,d.y,d.z],e[t]=[p.x,p.y,p.z],++t,a[t]=[f.x,f.y,f.z],e[t]=[h.x,h.y,h.z],++t;var v=f.clone().add(c),_=v.clone().add(u);a[t]=[v.x,v.y,v.z],e[t]=[_.x,_.y,_.z],++t,a[t]=[v.x,v.y,v.z],e[t]=[_.x,_.y,_.z]}}function m3(a,e,t,n){var r=n.start,i=n.end;function s(v){return v>r&&a[v-1]._isValid?v-1:v}function o(v){return v<i&&a[v+1]._isValid?v+1:v}var l=[],c=[],u=0;function f(v,_){var m=a[v]._controlPoint.clone().lerp(a[_]._controlPoint,-.25),g=m.clone().add(a[v]._wingVector);c[u]=[m.x,m.y,m.z],l[u++]=[g.x,g.y,g.z],c[u]=[m.x,m.y,m.z],l[u++]=[g.x,g.y,g.z]}var h=s(e),d=o(t);if(h===d)return p3(c,l,u,a[e]),{centerPoints:c,topPoints:l};e===h?f(e,o(e)):(Us(c,l,u++,a[s(h)]),Us(c,l,u++,a[h]));for(var p=e;p<=t;++p)Us(c,l,u++,a[p]);return d===o(d)?f(t,s(t)):(Us(c,l,u++,a[d]),Us(c,l,u,a[o(d)])),{centerPoints:c,topPoints:l}}var v3=function(){function a(e,t,n,r,i,s){G(this,a);var o=m3(e,t,n,s);this._topInterp=Xm(o.topPoints,i),this._centerInterp=Xm(o.centerPoints,i),this._shift=.5/(n-t+2),this._valueStep=(1-2*this._shift)/(2*(n-t+1)*(r-1)),this._segmentsCount=r}return H(a,[{key:"prepareMatrices",value:function(t,n,r){for(var i=this._segmentsCount,s=new Array(i),o=new ve(0,0),l=this._topInterp,c=this._centerInterp,u=this._shift+this._valueStep*(i-1)*t,f=0;f<i;++f){var h=Math.min(1,f/(i-1));o.lerpVectors(n,r,h);var d=l(u,null),p=c(u,null);u+=this._valueStep;var v=c(u,null);s[f]=d3(p.clone(),v.clone(),d.clone().sub(p),o)}return s}}]),a}();function g3(a){var e=_3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function _3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function y3(a,e){for(var t=[],n=0;n<e;++n){var r=Math.PI/2-2*Math.PI*n/e;t.push(new b(Math.cos(r)*a,Math.sin(r)*a,0))}return t}function jm(a,e,t,n,r,i){for(var s=0,o=a.length;s<o;++s)for(var l=a[s].arr,c=a[s].boundaries,u=0,f=l.length;u<f;++u)for(var h=[l[u].start,l[u].end],d=new v3(e,h[0],h[1],t,n,c),p=null,v=l[u].start*2,_=l[u].end*2+1,m=r.getResidueRadius(e[0],0),g=v;g<=_;++g){var y=g/2|0,x=e[y],S=r.getResidueRadius(x,g%2),M=r.getResidueRadius(x,1+g%2),E=d.prepareMatrices(g-h[0]*2,S,M);E.unshift(p===null?E[0]:p);var N=S.x!==M.x||S.y!==M.y,B=S.x!==m.x||S.y!==m.y;i(x,E,N,B),p=E[t],m=M}}var x3=function(a){re(t,a);var e=g3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){var r=this._mode.getHeightSegmentsRatio();return this._segmentsHeight=this._polyComplexity*r|0,[y3(1,this._polyComplexity),this._segmentsHeight+1,this._selection.chunks.length*2]}},{key:"_build",value:function(){var r=this._selection,i=r.residues,s=r.parent,o=this._mode,l=this._colorer,c=o.getTension(),u=this._geo,f=0,h=[];jm(this._selection.subdivs,i,this._segmentsHeight,c,o,function(d,p){var v=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,_=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,m=l.getResidueColor(d,s);h[f]=d._index,u.setItem(f,p,v,_),u.setColor(f++,m)}),this._chunksIdc=h,u.finalize()}},{key:"updateToFrame",value:function(r){var i=this._selection.parent,s=this._mode,o=this._colorer,l=s.getTension(),c=this._geo,u=r.getResidues(),f=0,h=r.needsColorUpdate(o);jm(this._selection.subdivs,u,this._segmentsHeight,l,s,function(d,p){c.setItem(f,p),h&&c.setColor(f,o.getResidueColor(d,i)),f++}),c.finalize()}}]),t}(k_);function S3(a){var e=b3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function b3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var w3=function(a){re(t,a);var e=S3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){for(var r=this._selection.subdivs,i=0,s=0,o=r.length;s<o;++s)for(var l=r[s].arr,c=0,u=l.length;c<u;++c)i+=l[c].end-l[c].start;return[i,this._polyComplexity]}},{key:"_build",value:function(){for(var r=this._selection,i=r.residues,s=r.parent,o=this._mode,l=this._colorer,c=this._geo,u=0,f=[],h=this._selection.subdivs,d=o.calcStickRadius(),p=0,v=h.length;p<v;++p)for(var _=h[p].arr,m=0,g=_.length;m<g;++m)for(var y=_[m].start,x=_[m].end,S=i[y],M=y+1;M<=x;++M){var E=i[M];f[u]={first:S._index,second:E._index},c.setItem(u,S._controlPoint,E._controlPoint,d),c.setColor(u,l.getResidueColor(S,s),l.getResidueColor(E,s)),u++,S=E}this._chunksIdc=f,c.finalize()}},{key:"updateToFrame",value:function(r){for(var i=r.getResidues(),s=this._selection.parent,o=this._mode,l=this._colorer,c=this._geo,u=0,f=this._selection.subdivs,h=o.calcStickRadius(),d=r.needsColorUpdate(l),p=0,v=f.length;p<v;++p)for(var _=f[p].arr,m=0,g=_.length;m<g;++m)for(var y=_[m].start,x=_[m].end,S=i[y],M=y+1;M<=x;++M){var E=i[M];c.setItem(u,S._controlPoint,E._controlPoint,h),d&&c.setColor(u,l.getResidueColor(S,s),l.getResidueColor(E,s)),u++,S=E}c.finalize()}},{key:"raycast",value:function(r,i){var s=[],o=this._selection.residues;this._mesh.raycast(r,s);for(var l=this._chunksIdc,c=0,u=s.length;c<u;++c)if(s[c].hasOwnProperty("chunkIdx")){var f=s[c].chunkIdx,h=l[Math.floor(f/2)],d=f%2===0?h.first:h.second;d<o.length&&(s[c].residue=o[d],i.push(s[c]))}}},{key:"_calcChunksList",value:function(r){for(var i=[],s=this._chunksIdc,o=this._selection.residues,l=0,c=s.length;l<c;++l){var u=s[l];o[u.first]._mask&r&&i.push(l*2),o[u.second]._mask&r&&i.push(l*2+1)}return i}}]),t}(Bc);function M3(a){var e=E3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function E3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function C3(a){return a<2?1:a}var D_=function(a){re(t,a);var e=M3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_makeGeoArgs",value:function(){for(var r=this._mode.drawMultiorderBonds(),i=this._mode.showAromaticLoops(),s=this._selection.chunks,o=this._selection.bonds,l=0,c=0,u=s.length;c<u;++c)l+=this.getBondOrder(o[s[c]],r,i);return[l,this._polyComplexity]}},{key:"getBondOrder",value:function(r,i,s){var o=1;return i&&(!s||r._type!==ta.BondType.AROMATIC)&&(o=C3(r._order)),o}},{key:"raycast",value:function(r,i){var s=this._selection.bonds,o=[];this._mesh.raycast(r,o);for(var l=this._chunksIdc,c=0,u=o.length;c<u;++c)if(o[c].hasOwnProperty("chunkIdx")){var f=o[c].chunkIdx,h=l[Math.floor(f/2)];if(h<s.length){var d=s[h];o[c].atom=f%2===0?d._left:d._right,i.push(o[c])}}}},{key:"_calcChunksList",value:function(r,i){for(var s=[],o=this._selection.bonds,l=this._chunksIdc,c=0,u=l.length;c<u;++c){var f=o[l[c]];f._left.mask&r&&(!i||f._right.mask&r)&&s.push(2*c),f._right.mask&r&&(!i||f._left.mask&r)&&s.push(2*c+1)}return s}}]),t}(Bc);function A3(a){var e=T3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function T3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var R3=function(a){re(t,a);var e=A3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){for(var r=this._selection.chunks,i=this._selection,s=i.bonds,o=i.parent,l=this._mode,c=this._colorer,u=this._geo,f=l.drawMultiorderBonds(),h=l.showAromaticLoops(),d=l.calcStickRadius(),p=l.calcSpaceFraction(),v,_=new b,m=new b,g=0,y=[],x=0,S=r.length;x<S;++x){var M=s[r[x]],E=M._left,N=M._right,B=E.position,V=N.position;v=M.calcNormalDir();for(var O=this.getBondOrder(M,f,h),W=Math.min(l.calcAtomRadius(E),l.calcAtomRadius(N)),z=2*W/O,C=f?Math.min(d,z*.5*(1-p)):d,T=0;T<O;++T){var A=z*(O%2===0?((T/2|0)+.5)*(1-2*(T%2)):((T+1)/2|0)*(-1+2*(T%2)));y[g]=M._index,_.copy(B),_.addScaledVector(v,A),m.copy(V),m.addScaledVector(v,A),u.setItem(g,_,m,C),u.setColor(g++,c.getAtomColor(E,o),c.getAtomColor(N,o))}}u.finalize(),this._chunksIdc=y}},{key:"updateToFrame",value:function(r){for(var i=this._selection.chunks,s=this._selection.bonds,o=this._mode,l=this._colorer,c=this._geo,u=o.drawMultiorderBonds(),f=o.showAromaticLoops(),h=o.calcStickRadius(),d=o.calcSpaceFraction(),p,v=new b,_=new b,m=0,g=r.needsColorUpdate(l),y=0,x=i.length;y<x;++y){var S=s[i[y]],M=S._left,E=S._right,N=r.getAtomPos(M.index).clone(),B=r.getAtomPos(E.index);p=S.calcNormalDir();for(var V=this.getBondOrder(S,u,f),O=Math.min(o.calcAtomRadius(M),o.calcAtomRadius(E)),W=2*O/V,z=u?Math.min(h,W*.5*(1-d)):h,C=0;C<V;++C){var T=W*(V%2===0?((C/2|0)+.5)*(1-2*(C%2)):((C+1)/2|0)*(-1+2*(C%2)));v.copy(N),v.addScaledVector(p,T),_.copy(B),_.addScaledVector(p,T),c.setItem(m,v,_,z),g&&c.setColor(m,r.getAtomColor(l,M),r.getAtomColor(l,E)),m++}}c.finalize()}}]),t}(D_);function L3(a){var e=P3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function P3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Oa=.15,N3=function(a){re(t,a);var e=L3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_build",value:function(){for(var r=this._selection.chunks,i=this._selection,s=i.bonds,o=i.parent,l=this._mode,c=this._colorer,u=this._geo,f=l.drawMultiorderBonds(),h=l.showAromaticLoops(),d=new b,p=new b,v=new b,_=0,m=[],g=0,y=r.length;g<y;++g){var x=s[r[g]],S=x._left,M=x._right,E=S.position,N=M.position,B=S.bonds.length===1,V=M.bonds.length===1;d.subVectors(N,E);for(var O=d.length(),W=x.calcNormalDir(),z=this.getBondOrder(x,f,h),C=0;C<z;++C){p.copy(E),v.copy(N);var T=z%2===0?((C/2|0)+.5)*(1-2*(C%2)):((C+1)/2|0)*(-1+2*(C%2));m[_]=x._index,z===2&&!B&&!V&&(T-=.5,T*=-1),!B&&!V&&z>1&&T!==0&&(p.lerpVectors(E,N,Oa/O),v.lerpVectors(E,N,1-Oa/O)),T*=Oa,p.addScaledVector(W,T),v.addScaledVector(W,T),u.setItem(_,p,v),u.setColor(_++,c.getAtomColor(S,o),c.getAtomColor(M,o))}}u.finalize(),this._chunksIdc=m}},{key:"updateToFrame",value:function(r){for(var i=this._selection.chunks,s=this._selection.bonds,o=this._mode,l=this._colorer,c=this._geo,u=o.drawMultiorderBonds(),f=o.showAromaticLoops(),h=new b,d=new b,p=new b,v=0,_=r.needsColorUpdate(l),m=0,g=i.length;m<g;++m){var y=s[i[m]],x=y._left,S=y._right,M=r.getAtomPos(x.index).clone(),E=r.getAtomPos(S.index),N=x.bonds.length===1,B=S.bonds.length===1;h.subVectors(E,M);for(var V=h.length(),O=y.calcNormalDir(),W=this.getBondOrder(y,u,f),z=0;z<W;++z){d.copy(M),p.copy(E);var C=W%2===0?((z/2|0)+.5)*(1-2*(z%2)):((z+1)/2|0)*(-1+2*(z%2));W===2&&!N&&!B&&(C-=.5,C*=-1),!N&&!B&&W>1&&C!==0&&(d.lerpVectors(M,E,Oa/V),p.lerpVectors(M,E,1-Oa/V)),C*=Oa,d.addScaledVector(O,C),p.addScaledVector(O,C),c.setItem(v,d,p),_&&c.setColor(v,r.getAtomColor(l,x),r.getAtomColor(l,S)),v++}}c.finalize()}}]),t}(D_),Sr={AtomsSphereGroup:Vh,AtomsSurfaceGroup:FR,AtomsSASSESGroupStub:VR,AtomsTextGroup:XR,AromaticTorusGroup:JR,AromaticLinesGroup:t3,NucleicCylindersGroup:l3,NucleicSpheresGroup:f3,ResiduesSubseqGroup:x3,ResiduesTraceGroup:w3,BondsCylinderGroup:R3,BondsLinesGroup:N3};function I3(a){var e=k3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function k3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var F_=function(a){re(t,a);var e=I3(t);function t(n,r,i,s,o,l,c,u){var f;G(this,t),f=e.call(this);var h=qr(f);f._complex=i,f._mode=o;var d=i.getAtoms(),p=i.getTransforms();return i.forEachComponent(function(v){var _=[],m=0;if(v.forEachAtom(function(y){h._checkAtom(y,c)&&(_[m++]=y.index)}),m!==0){var g=new n(r,{atoms:d,chunks:_,parent:i},s,o,p,l,u);g._component=v,h.add(g)}}),f}return H(t,[{key:"_checkAtom",value:function(r,i){return r.mask&i}},{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=0,u=o.length;c<u;++c)if(o[c].getSubset)for(var f=o[c].getSubset(r,i),h=0,d=f.length;h<d;++h){var p=f[h];p._component=o[c]._component,s[l++]=p}return s}}]),t}(na);function O3(a){var e=D3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function D3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var F3=function(a){re(t,a);var e=O3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_checkAtom",value:function(r,i){if(!(r.mask&i))return!1;for(var s=r.bonds,o=0,l=s.length;o<l;++o)if(s[o]._left.mask&i&&s[o]._right.mask&i)return!1;return!0}}]),t}(F_);function B3(a){var e=z3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function z3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var B_=function(a){re(t,a);var e=B3(t);function t(n,r,i,s,o,l,c,u){var f;G(this,t),f=e.call(this);var h=qr(f);f._complex=i;var d=i.getResidues(),p=i.getTransforms();return i.forEachComponent(function(v){var _=0,m=[];if(v.forEachResidue(function(y){h._checkResidue(y,c)&&(m[_++]=y._index)}),_!==0){var g=new n(r,{residues:d,chunks:m,parent:i},s,o,p,l,u);g._component=v,h.add(g)}}),f}return H(t,[{key:"checkResidue",value:function(r,i){return r._mask&i}},{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=0,u=o.length;c<u;++c)if(o[c].getSubset)for(var f=o[c].getSubset(r,i),h=0,d=f.length;h<d;++h){var p=f[h];p._component=o[c]._component,s[l++]=p}return s}}]),t}(na);function V3(a){var e=U3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function U3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var G3=function(a){re(t,a);var e=V3(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_checkResidue",value:function(r,i){return i&r._mask&&r._cylinders!==null}}]),t}(B_);function H3(a){var e=W3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function W3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var X3=function(a){re(t,a);var e=H3(t);function t(n,r,i,s,o,l,c,u){var f;G(this,t),f=e.call(this);var h=qr(f);f._complex=i;var d=i.getResidues(),p=i.getTransforms();return i.forEachComponent(function(v){for(var _=v.getMaskedSubdivSequences(c),m=0,g=[],y=0,x=_.length;y<x;++y)for(var S=_[y].arr,M=0,E=S.length;M<E;++M)for(var N=S[M].start,B=S[M].end;N<=B;++N)g[m++]=d[N]._index;if(m!==0){var V=new n(r,{residues:d,chunks:g,subdivs:_,parent:i},s,o,p,l,u);V._component=v,h.add(V)}}),f}return H(t,[{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=0,u=o.length;c<u;++c)if(o[c].getSubset)for(var f=o[c].getSubset(r,i),h=0,d=f.length;h<d;++h){var p=f[h];p._component=o[c]._component,s[l++]=p}return s}}]),t}(na);function j3(a){var e=Y3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Y3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var q3=function(a){re(t,a);var e=j3(t);function t(n,r,i,s,o,l,c,u){var f;G(this,t),f=e.call(this);var h=qr(f);f._complex=i;var d=i.getBonds(),p=i.getTransforms();return i.forEachComponent(function(v){var _=[],m=0;if(v.forEachBond(function(y){var x=y._left,S=y._right;!(x.mask&c)||!(S.mask&c)||(_[m++]=y._index)}),m!==0){var g=new n(r,{bonds:d,chunks:_,parent:i},s,o,p,l,u);g._component=v,h.add(g)}}),f}return H(t,[{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=0,u=o.length;c<u;++c)if(o[c].getSubset)for(var f=o[c].getSubset(r,i),h=0,d=f.length;h<d;++h){var p=f[h];p._component=o[c]._component,s[l++]=p}return s}}]),t}(na);function $3(a){var e=Z3();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Z3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var K3=function(a){re(t,a);var e=$3(t);function t(n,r,i,s,o,l,c,u){var f;G(this,t),f=e.call(this);var h=qr(f);f._complex=i;var d=i.getAtoms(),p=i.getTransforms();return o.showAromaticLoops()?(i.forEachComponent(function(v){var _=[],m=0,g=[],y=0;v.forEachCycle(function(S){for(var M=S.atoms,E=0,N=0,B=M.length;N<B;++N)M[N].mask&c&&(++E,_[m++]=M[N].index);E>0&&(g[y++]=S)});var x=new n(r,{cycles:g,atoms:d,chunks:_,parent:i},s,o,p,l,u);x._component=v,h.add(x)}),f):ue(f)}return H(t,[{key:"getSubset",value:function(r,i){for(var s=[],o=this.children,l=0,c=0,u=o.length;c<u;++c)if(o[c].getSubset)for(var f=o[c].getSubset(r,i),h=0,d=f.length;h<d;++h){var p=f[h];p._component=o[c]._component,s[l++]=p}return s}}]),t}(na),br={Atoms:F_,OrphanAtoms:F3,Residues:B_,Nucleic:G3,Subseqs:X3,Bonds:q3,Aromatic:K3};function wr(a,e,t){return function(n,r,i,s,o,l){return new e(t,a,n,r,i,s,o,l)}}var J3=function(){function a(){G(this,a)}return H(a,null,[{key:"AtomsSpheres",value:function(t,n){var r=xr.createSpheres(t,n);return wr(r,br.Atoms,Sr.AtomsSphereGroup)}},{key:"OrphanedAtomsCrosses",value:function(t,n,r){var i=xr.createCrosses(t,n,r);return wr(i,br.OrphanAtoms,Sr.AtomsSphereGroup)}},{key:"BondsCylinders",value:function(t,n){var r=xr.create2CCylinders(t,n);return wr(r,br.Bonds,Sr.BondsCylinderGroup)}},{key:"BondsLines",value:function(t,n,r){var i=xr.create2CLines(t,n,r);return wr(i,br.Bonds,Sr.BondsLinesGroup)}},{key:"CartoonChains",value:function(t,n){var r=xr.createExtrudedChains(t,n);return wr(r,br.Subseqs,Sr.ResiduesSubseqGroup)}},{key:"TraceChains",value:function(t,n){var r=xr.create2CClosedCylinders(t,n);return wr(r,br.Subseqs,Sr.ResiduesTraceGroup)}},{key:"NucleicSpheres",value:function(t,n){var r=xr.createSpheres(t,n);return wr(r,br.Nucleic,Sr.NucleicSpheresGroup)}},{key:"NucleicCylinders",value:function(t,n){var r=xr.create2CCylinders(t,n);return wr(r,br.Nucleic,Sr.NucleicCylindersGroup)}},{key:"ALoopsTorus",value:function(t,n){var r=xr.createExtrudedChains(t,n);return wr(r,br.Aromatic,Sr.AromaticTorusGroup)}},{key:"ALoopsLines",value:function(t,n,r){var i=xr.createChunkedLines(t,n,r);return wr(i,br.Aromatic,Sr.AromaticLinesGroup)}},{key:"QuickSurfGeo",value:function(t,n,r){var i=xr.createQuickSurface(t,n,r);return wr(i,br.Atoms,Sr.AtomsSurfaceGroup)}},{key:"ContactSurfaceGeo",value:function(t,n,r){var i=xr.createContactSurface(t,n,r);return wr(i,br.Atoms,Sr.AtomsSurfaceGroup)}},{key:"SASSESSurfaceGeo",value:function(t,n,r){var i=xr.createSASSES(t,n,r);return wr(i,br.Atoms,Sr.AtomsSASSESGroupStub)}},{key:"TextLabelsGeo",value:function(t,n){var r=xr.createLabels(t,n);return wr(r,br.Atoms,Sr.AtomsTextGroup)}}]),a}(),Ar=function(){function a(e){if(G(this,a),this.constructor===a)throw new Error("Can not instantiate abstract class!");this.opts=le.merge(Se.deriveDeep(this.settings.now.modes[this.id],!0),e)}return H(a,[{key:"identify",value:function(){var t=Se.objectsDiff(this.opts,this.settings.now.modes[this.id]);return le.isEmpty(t)?this.id:[this.id,t]}},{key:"buildGeometry",value:function(t,n,r,i){for(var s=this.opts.polyComplexity?this.opts.polyComplexity[this.settings.now.resolution]:0,o=this.depGroups,l=o.length,c=new Je.RCGroup,u=this,f=0;f<l;++f){var h=o[f],d={};if(le.isArray(h)){d=h[1].call(this);var p=h,v=Lt(p,1);h=v[0]}var _=J3[h](null,this.settings,d),m=new _(t,n,u,s,r,i);m.children.length>0&&c.add(m)}return c}}]),a}();Ao(Ar.prototype);Ar.prototype.id="__";Ar.prototype.depGroups=[];function Q3(a){var e=eL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function eL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function tL(){return{lineWidth:this.opts.lineWidth}}var ds=function(a){re(t,a);var e=Q3(t);function t(n){var r;G(this,t),r=e.call(this,n),r.depGroups=r.depGroups.slice(0);for(var i=r.depGroups,s=0,o=i.length;s<o;++s)i[s]=[i[s],tL];return r}return H(t,[{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}},{key:"calcAtomRadius",value:function(){return this.opts.atom}},{key:"getAromaticOffset",value:function(){return this.opts.offsarom}},{key:"getAromaticArcChunks",value:function(){return this.opts.chunkarom}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}}]),t}(Ar);Le(ds,"id","LN");ds.prototype.id="LN";ds.prototype.name="Lines";ds.prototype.shortName="Lines";ds.prototype.depGroups=["ALoopsLines","BondsLines","OrphanedAtomsCrosses"];function rL(a){var e=nL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function nL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ps=function(a){re(t,a);var e=rL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"calcAtomRadius",value:function(r){return this.opts.bond}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),t}(Ar);Le(ps,"id","LC");ps.prototype.id="LC";ps.prototype.name="Licorice";ps.prototype.shortName="Licorice";ps.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];function iL(a){var e=aL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function aL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ms=function(a){re(t,a);var e=iL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"calcAtomRadius",value:function(r){return r.element.radius*this.opts.atom}},{key:"calcStickRadius",value:function(){return this.opts.bond}},{key:"getAromRadius",value:function(){return this.opts.aromrad}},{key:"showAromaticLoops",value:function(){return this.opts.showarom}},{key:"calcSpaceFraction",value:function(){return this.opts.space}},{key:"drawMultiorderBonds",value:function(){return this.opts.multibond}}]),t}(Ar);Le(ms,"id","BS");ms.prototype.id="BS";ms.prototype.name="Balls and Sticks";ms.prototype.shortName="Balls";ms.prototype.depGroups=["AtomsSpheres","BondsCylinders","ALoopsTorus"];function sL(a){var e=oL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function oL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var vs=function(a){re(t,a);var e=sL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"calcAtomRadius",value:function(r){return r.element.radius}}]),t}(Ar);Le(vs,"id","VW");vs.prototype.id="VW";vs.prototype.name="Van der Waals";vs.prototype.shortName="VDW";vs.prototype.depGroups=["AtomsSpheres"];function lL(a){var e=cL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function cL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var gs=function(a){re(t,a);var e=lL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"calcStickRadius",value:function(){return this.opts.radius}}]),t}(Ar);Le(gs,"id","TR");gs.prototype.id="TR";gs.prototype.name="Trace";gs.prototype.shortName="Trace";gs.prototype.depGroups=["TraceChains"];function uL(a){var e=fL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function fL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var _s=function(a){re(t,a);var e=uL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getResidueRadius",value:function(r){return this.TUBE_RADIUS}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(r,i,s,o){var l=this.opts.radius;return this.TUBE_RADIUS=new ve(l,l),Ar.prototype.buildGeometry.call(this,r,i,s,o)}}]),t}(Ar);Le(_s,"id","TU");_s.prototype.id="TU";_s.prototype.name="Tube";_s.prototype.shortName="Tube";_s.prototype.depGroups=["CartoonChains"];function hL(a){var e=dL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function dL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ys=function(a){re(t,a);var e=hL(t);function t(n){var r;return G(this,t),r=e.call(this,n),r.secCache={},r}return H(t,[{key:"getResidueStartRadius",value:function(r){var i=r.getSecondary();if(!i||!i.generic)return this.TUBE_RADIUS;var s=this.secCache[i.generic];return s?i.term===r?s.start:s.center:this.TUBE_RADIUS}},{key:"getResidueEndRadius",value:function(r){var i=r.getSecondary();if(i===null||!i.generic)return this.TUBE_RADIUS;var s=this.secCache[i.generic];return s?i.term===r?this.ARROW_END:s.center:this.TUBE_RADIUS}},{key:"getResidueRadius",value:function(r,i){var s=this.getResidueStartRadius(r);if(i===0)return s;var o=this.getResidueEndRadius(r);return i===2?o:s.clone().lerp(o,i/2)}},{key:"calcStickRadius",value:function(r){return this.opts.radius}},{key:"getHeightSegmentsRatio",value:function(){return this.opts.heightSegmentsRatio}},{key:"getTension",value:function(){return this.opts.tension}},{key:"buildGeometry",value:function(r,i,s,o){var l=this.opts.radius,c=this.opts.depth;this.TUBE_RADIUS=new ve(l,l),this.ARROW_END=new ve(c,l);var u={},f=this.opts.ss;for(var h in f)u[h]={center:new ve(c,f[h].width),start:new ve(c,f[h].arrow)};return this.secCache=u,Ar.prototype.buildGeometry.call(this,r,i,s,o)}}]),t}(Ar);Le(ys,"id","CA");ys.prototype.id="CA";ys.prototype.name="Cartoon";ys.prototype.shortName="Cartoon";ys.prototype.depGroups=["CartoonChains","NucleicSpheres","NucleicCylinders"];function pL(a){var e=mL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function mL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var vL=qe.selectors;function gL(){return{wireframe:this.opts.wireframe,zClip:this.opts.zClip}}var Ro=function(a){re(t,a);var e=pL(t);function t(n){var r;G(this,t),r=e.call(this,n),r.depGroups=r.depGroups.slice(0);for(var i=r.surfaceNames,s=r.depGroups,o=0,l=i.length;o<l;++o)s[s.length]=[i[o],gL];return r}return H(t,[{key:"calcAtomRadius",value:function(r){return r.element.radius}},{key:"getVisibilitySelector",value:function(){var r=null;if(this.opts.subset!==""){var i=vL.parse(this.opts.subset);i.error||(r=i.selector)}return r}}]),t}(Ar);Ro.prototype.isSurface=!0;Ro.prototype.surfaceNames=[];function _L(a){var e=yL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function yL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var xs=function(a){re(t,a);var e=_L(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getSurfaceOpts",value:function(){return{useBeads:!1,isoValue:this.opts.isoValue,gaussLim:this.opts.gaussLim[this.settings.now.resolution],radScale:this.opts.scale,gridSpacing:this.opts.gridSpacing[this.settings.now.resolution],zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),t}(Ro);Le(xs,"id","QS");xs.prototype.id="QS";xs.prototype.name="Quick Surface";xs.prototype.shortName="Quick Surf";xs.prototype.surfaceNames=["QuickSurfGeo"];function xL(a){var e=SL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function SL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Li=function(a){re(t,a);var e=xL(t);function t(n,r){var i;return G(this,t),i=e.call(this,r),i._excludeProbe=n,i}return H(t,[{key:"calcAtomRadius",value:function(r){return r.element.radius}},{key:"getSurfaceOpts",value:function(){return{gridSpacing:this.opts.polyComplexity[this.settings.now.resolution],radScale:this._radScale,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector(),probeRadius:this.opts.probeRadius,excludeProbe:this._excludeProbe}}}]),t}(Ro);Li.prototype.id="SU";Li.prototype.name="Surface";Li.prototype.shortName="Surface";Li.prototype.surfaceNames=["SASSESSurfaceGeo"];Li.prototype._radScale=1;Li.prototype._excludeProbe=!1;function bL(a){var e=wL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function wL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Lo=function(a){re(t,a);var e=bL(t);function t(n){return G(this,t),e.call(this,!1,n)}return H(t)}(Li);Le(Lo,"id","SA");Lo.prototype.id="SA";Lo.prototype.name="Solvent Accessible Surface";Lo.prototype.shortName="SAS";function ML(a){var e=EL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function EL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Po=function(a){re(t,a);var e=ML(t);function t(n){return G(this,t),e.call(this,!0,n)}return H(t)}(Li);Le(Po,"id","SE");Po.prototype.id="SE";Po.prototype.name="Solvent Excluded Surface";Po.prototype.shortName="SES";function CL(a){var e=AL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function AL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var aa=function(a){re(t,a);var e=CL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getSurfaceOpts",value:function(){return{probeRadius:this.opts.probeRadius,radScale:this.opts.polyComplexity[this.settings.now.resolution],scaleFactor:this.opts.polyComplexity[this.settings.now.resolution],gridSpacing:1/this.opts.polyComplexity[this.settings.now.resolution],isoValue:this.opts.isoValue,probePositions:this.opts.probePositions,zClip:this.opts.zClip,visibilitySelector:this.getVisibilitySelector()}}}]),t}(Ro);Le(aa,"id","CS");aa.prototype.id="CS";aa.prototype.name="Contact Surface";aa.prototype.shortName="Contact Surf";aa.prototype.isSurface=!0;aa.prototype.surfaceNames=["ContactSurfaceGeo"];function TL(a){var e=RL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function RL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Ss=function(a){re(t,a);var e=TL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getTemplateOptions",value:function(){return this.opts.template}},{key:"getLabelOpts",value:function(){return le.merge(this.opts,{colors:!0,adjustColor:!0,transparent:!0})}}]),t}(Ar);Le(Ss,"id","TX");Ss.prototype.id="TX";Ss.prototype.name="Text mode";Ss.prototype.shortName="Text";Ss.prototype.depGroups=["TextLabelsGeo"];var Kl=new ia([ds,ps,ms,vs,gs,_s,ys,xs,Lo,Po,aa,Ss]);function Ym(a,e,t){return a<=t?a<0?0:a:t}function LL(a,e,t){var n=1-t,r=a>>16&255,i=a>>8&255,s=a&255,o=e>>16&255,l=e>>8&255,c=e&255,u=n*r+t*o,f=n*i+t*l,h=n*s+t*c;return u<<16|f<<8|h}var No=function(){function a(e,t){G(this,a),this.name=e||"Custom",this.id=t||"CP"}return H(a,[{key:"getElementColor",value:function(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.elementColors[t];return r===void 0&&!n?this.defaultElementColor:r}},{key:"getResidueColor",value:function(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.residueColors[t];return r===void 0&&!n?this.defaultResidueColor:r}},{key:"getChainColor",value:function(t){var n=t.charCodeAt(0);return n=((n<0?0:n>=256?n-256:n)&31)%this.chainColors.length,this.chainColors[n]}},{key:"getSecondaryColor",value:function(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.secondaryColors[t];return r===void 0&&!n?this.defaultSecondaryColor:r}},{key:"getSequentialColor",value:function(t){var n=this.colors,r=n.length;return t<0?n[t%r+r]:n[t%r]}},{key:"getGradientColor",value:function(t,n){var r=this.gradients[n];if(!r)return this.defaultNamedColor;var i=r.length,s=t*(i-1),o=Math.floor(s),l=Ym(o+1,0,i-1);return o=Ym(o,0,i-1),LL(r[o],r[l],s-o)}},{key:"getNamedColor",value:function(t){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.namedColors[t];return r===void 0&&!n?this.defaultNamedColor:r}}]),a}();le.assign(No.prototype,{colors:[16777215,16711680,65280,255,8421504],minRangeColor:0,midRangeColor:8355711,maxRangeColor:16777215,defaultElementColor:16777215,elementColors:{},defaultResidueColor:16777215,residueColors:{},chainColors:[16777215],defaultSecondaryColor:16777215,secondaryColors:{},defaultGradientColor:0,defaultNamedColor:16777215,namedColorsArray:[["indianred",13458524],["lightcoral",15761536],["salmon",16416882],["darksalmon",15308410],["lightsalmon",16752762],["crimson",14423100],["red",16711680],["firebrick",11674146],["darkred",9109504],["pink",16761035],["lightpink",16758465],["hotpink",16738740],["deeppink",16716947],["mediumvioletred",13047173],["palevioletred",14381203],["coral",16744272],["tomato",16737095],["orangered",16729344],["darkorange",16747520],["orange",16753920],["gold",16766720],["yellow",16776960],["lightyellow",16777184],["lemonchiffon",16775885],["lightgoldenrodyellow",16448210],["papayawhip",16773077],["moccasin",16770229],["peachpuff",16767673],["palegoldenrod",15657130],["khaki",15787660],["darkkhaki",12433259],["lavender",15132410],["thistle",14204888],["plum",14524637],["violet",15631086],["orchid",14315734],["fuchsia",16711935],["magenta",16711935],["mediumorchid",12211667],["mediumpurple",9662683],["rebeccapurple",6697881],["blueviolet",9055202],["darkviolet",9699539],["darkorchid",10040012],["darkmagenta",9109643],["purple",8388736],["indigo",4915330],["slateblue",6970061],["mediumslateblue",8087790],["darkslateblue",4734347],["greenyellow",11403055],["chartreuse",8388352],["lawngreen",8190976],["lime",65280],["limegreen",3329330],["palegreen",10025880],["lightgreen",9498256],["mediumspringgreen",64154],["springgreen",65407],["mediumseagreen",3978097],["seagreen",3050327],["forestgreen",2263842],["green",32768],["darkgreen",25600],["yellowgreen",10145074],["olivedrab",7048739],["olive",8421376],["darkolivegreen",5597999],["mediumaquamarine",6737322],["darkseagreen",9419919],["lightseagreen",2142890],["darkcyan",35723],["teal",32896],["aqua",65535],["cyan",65535],["lightcyan",14745599],["paleturquoise",11529966],["aquamarine",8388564],["turquoise",4251856],["mediumturquoise",4772300],["darkturquoise",52945],["cadetblue",6266528],["steelblue",4620980],["lightsteelblue",11584734],["powderblue",11591910],["lightblue",11393254],["skyblue",8900331],["lightskyblue",8900346],["deepskyblue",49151],["dodgerblue",2003199],["cornflowerblue",6591981],["royalblue",4286945],["blue",255],["mediumblue",205],["darkblue",139],["navy",128],["midnightblue",1644912],["cornsilk",16775388],["blanchedalmond",16772045],["bisque",16770244],["navajowhite",16768685],["wheat",16113331],["burlywood",14596231],["tan",13808780],["rosybrown",12357519],["sandybrown",16032864],["goldenrod",14329120],["darkgoldenrod",12092939],["peru",13468991],["chocolate",13789470],["saddlebrown",9127187],["sienna",10506797],["brown",10824234],["maroon",8388608],["white",16777215],["snow",16775930],["honeydew",15794160],["mintcream",16121850],["azure",15794175],["aliceblue",15792383],["ghostwhite",16316671],["whitesmoke",16119285],["seashell",16774638],["beige",16119260],["oldlace",16643558],["floralwhite",16775920],["ivory",16777200],["antiquewhite",16444375],["linen",16445670],["lavenderblush",16773365],["mistyrose",16770273],["gainsboro",14474460],["lightgray",13882323],["silver",12632256],["darkgray",11119017],["gray",8421504],["dimgray",6908265],["lightslategray",7833753],["slategray",7372944],["darkslategray",3100495],["black",0]],namedColors:{},gradients:{rainbow:[255,65535,65280,16776960,16711680],temp:[255,32767,16777215,16744192,16711680],hot:[16777215,16744192,16711680],cold:[16777215,32767,255],"blue-red":[255,16777215,16711680],reds:[16777215,16711680],blues:[16777215,255]}});var z_=No.prototype,qm=z_.namedColorsArray,PL=z_.namedColors;for(var Ju=0,NL=qm.length;Ju<NL;++Ju){var $m=Lt(qm[Ju],2),IL=$m[0],kL=$m[1];PL[IL]=kL}var V_=new No("CPK","CP");V_.elementColors={H:16777215,C:2105376,N:2121983,O:15605776,F:65280,P:8397055,S:16776960,CL:47872,FE:13684944,CO:13684944,NI:13684944,CU:13684944,BR:34816,I:21760};var kn,sa=new No("Jmol","JM");sa.colors=[255,22015,44031,65535,65451,65365,65280,5635840,11271936,16776960,16755456,16733440,16711680,16711765,16711851,16711935,11206911,5570815];sa.elementColors={H:16777215,D:16777152,T:16777120,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:4366e3,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998};sa.defaultResidueColor=12492910;sa.residueColors={ALA:13158600,ARG:1334015,ASN:56540,ASP:15075850,CYS:15132160,GLN:56540,GLU:15075850,GLY:15461355,HIS:8553170,ILE:1016335,LEU:1016335,LYS:1334015,MET:15132160,PHE:3289770,PRO:14456450,SER:16422400,THR:16422400,TRP:11819700,TYR:3289770,VAL:1016335,A:10526975,C:16747595,G:16740464,I:8454143,T:10551200,U:16744576,DA:10526975,DC:16747595,DG:16740464,DI:8454143,DT:10551200,DU:16744576,"+A":10526975,"+C":16747595,"+G":16740464,"+I":8454143,"+T":10551200,"+U":16744576};sa.chainColors=[4294967295,4290826495,4289789872,4294951112,4294967168,4294951167,4289786096,4294955120,4293951616,4294303411,4278239231,4291648604,4284927402,4288335154,4293821166,4278243025,4278255487,4282168177,4278190219,4290623339,4278215680,4286578688,4286611456,4286578816,4278222976,4290283019,4289864226];var Gs=qt.Type;sa.secondaryColors=(kn={},Le(kn,Gs.HELIX_ALPHA,16711808),Le(kn,Gs.HELIX_PI,6291584),Le(kn,Gs.HELIX_310,10485888),Le(kn,Gs.STRAND,16762880),Le(kn,Gs.TURN,6324479),Le(kn,"dna",11403518),Le(kn,"rna",16580962),kn);var si,Hn=new No("VMD","VM");Hn.colors=[255,16711680,6316128,16744448,16776960,8421427,10066329,65280,16777215,16751001,4243648,10879142,8447590,15099571,8408320,8421568];Hn.defaultElementColor=8408320;Hn.elementColors={H:16777215,C:4243391,N:255,O:16711680,P:8421427,S:16776960};Hn.defaultResidueColor=4243648;Hn.residueColors={ALA:255,ARG:16777215,ASN:8421427,ASP:16711680,CYS:16776960,GLN:16744448,GLU:16751001,GLY:16777215,HIS:4243648,ILE:65280,LEU:16751001,LYS:4243648,MET:16776960,PHE:10879142,PRO:8408064,SER:16776960,THR:15099571,TRP:10066329,TYR:65280,VAL:8421427,A:255,C:16744448,G:16776960,T:10879142,U:65280,DA:255,DC:16744448,DG:16776960,DT:10879142,DU:65280,"+A":255,"+C":16744448,"+G":16776960,"+T":10879142,"+U":65280,WAT:4243648,H2O:4243648,HOH:4243648};Hn.chainColors=[16777215].concat(Hn.colors);var Da=qt.Type;Hn.secondaryColors=(si={},Le(si,Da.HELIX_ALPHA,10879142),Le(si,Da.HELIX_310,255),Le(si,Da.HELIX_PI,16711680),Le(si,Da.STRAND,16776960),Le(si,Da.BRIDGE,8421427),Le(si,Da.TURN,4243648),si);var ns=new ia([V_,sa,Hn]),Pr=function(){function a(e){if(G(this,a),this.constructor===a)throw new Error("Can not instantiate abstract class!");this.opts=le.merge(Se.deriveDeep(Q.now.colorers[this.id],!0),e),this.palette=ns.first}return H(a,[{key:"identify",value:function(){var t=Se.objectsDiff(this.opts,Q.now.colorers[this.id]);return le.isEmpty(t)?this.id:[this.id,t]}}]),a}();Pr.prototype.id="__";function OL(a){var e=DL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function DL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Io=function(a){re(t,a);var e=OL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){var s=r.element.name;return s==="C"&&this.opts.carbon>=0?this.opts.carbon:this.palette.getElementColor(s)}},{key:"getResidueColor",value:function(r,i){return this.palette.defaultResidueColor}}]),t}(Pr);Le(Io,"id","EL");Io.prototype.id="EL";Io.prototype.name="Element";Io.prototype.shortName="Element";function FL(a){var e=BL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function BL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ko=function(a){re(t,a);var e=FL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){return this.palette.getResidueColor(r._type._name)}}]),t}(Pr);Le(ko,"id","RT");ko.prototype.id="RT";ko.prototype.name="Residue Type";ko.prototype.shortName="Residue";function zL(a){var e=VL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function VL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Oo=function(a){re(t,a);var e=zL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){var s=r._chain;if(s.minSequence===Number.POSITIVE_INFINITY&&s.maxSequence===Number.NEGATIVE_INFINITY)return this.palette.defaultNamedColor;var o=s.minSequence,l=s.maxSequence>o?s.maxSequence:o+1;return this.palette.getGradientColor((r._sequence-o)/(l-o),this.opts.gradient)}}]),t}(Pr);Le(Oo,"id","SQ");Oo.prototype.id="SQ";Oo.prototype.name="Sequence";Oo.prototype.shortName="Sequence";function UL(a){var e=GL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function GL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Do=function(a){re(t,a);var e=UL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){return this.palette.getChainColor(r.getChain()._name)}}]),t}(Pr);Le(Do,"id","CH");Do.prototype.id="CH";Do.prototype.name="Chain";Do.prototype.shortName="Chain";function HL(a){var e=WL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function WL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var bs=function(a){re(t,a);var e=HL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){if(r._type.flags&Be.Flags.DNA)return this.palette.getSecondaryColor("dna");if(r._type.flags&Be.Flags.RNA)return this.palette.getSecondaryColor("rna");var s=r.getSecondary();if(s){var o=this.palette.getSecondaryColor(s.type,!0);return o===void 0&&(o=this.palette.getSecondaryColor(s.generic)),o}return this.palette.defaultSecondaryColor}}]),t}(Pr);Le(bs,"id","SS");bs.prototype.id="SS";bs.prototype.name="Secondary Structure";bs.prototype.shortName="Structure";function XL(a){var e=jL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function jL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Fo=function(a){re(t,a);var e=XL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.opts.color}},{key:"getResidueColor",value:function(r,i){return this.opts.color}}]),t}(Pr);Le(Fo,"id","UN");Fo.prototype.id="UN";Fo.prototype.name="Uniform";Fo.prototype.shortName="Uniform";function YL(a){var e=qL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function qL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Bo=function(a){re(t,a);var e=YL(t);function t(n){var r;G(this,t),r=e.call(this,n);var i=Et.parse(r.opts.subset);return r._subsetCached=i.error?Et.none():i.selector,r}return H(t,[{key:"getAtomColor",value:function(r,i){return this._subsetCached.includesAtom(r)?this.opts.color:this.opts.baseColor}},{key:"getResidueColor",value:function(r,i){for(var s=this._subsetCached,o=r._atoms,l=0,c=o.length;l<c;++l)if(!s.includesAtom(o[l]))return this.opts.baseColor;return this.opts.color}}]),t}(Pr);Le(Bo,"id","CO");Bo.prototype.id="CO";Bo.prototype.name="Conditional";Bo.prototype.shortName="Conditional";function $L(a){var e=ZL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function ZL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var zo=function(a){re(t,a);var e=$L(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.palette.getChainColor(String.fromCharCode(r.location))}},{key:"getResidueColor",value:function(r,i){return this.palette.defaultResidueColor}}]),t}(Pr);Le(zo,"id","CF");zo.prototype.id="CF";zo.prototype.name="Conformation";zo.prototype.shortName="Conformation";function KL(a){var e=JL();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function JL(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Vo=function(a){re(t,a);var e=KL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){var s=this.opts,o=1;return r.temperature&&s?(s.min===s.max?o=r.temperature>s.max?1:0:o=(r.temperature-s.min)/(s.max-s.min),this.palette.getGradientColor(o,s.gradient)):this.palette.defaultGradientColor}},{key:"getResidueColor",value:function(r,i){var s=this.opts;if(!s)return this.palette.defaultGradientColor;if(r.temperature){var o=0;return s.min===s.max?o=r.temperature>s.max?1:0:o=(r.temperature-s.min)/(s.max-s.min),this.palette.getGradientColor(o,s.gradient)}return this.palette.defaultGradientColor}}]),t}(Pr);Le(Vo,"id","TM");Vo.prototype.id="TM";Vo.prototype.name="Temperature";Vo.prototype.shortName="Temperature";function QL(a){var e=eP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function eP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Uo=function(a){re(t,a);var e=QL(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_getColorByOccupancy",value:function(r,i){if(r!==void 0){var s=1-r;return this.palette.getGradientColor(s,i.gradient)}return this.palette.defaultGradientColor}},{key:"getAtomColor",value:function(r,i){var s=this.opts;return this._getColorByOccupancy(r.occupancy,s)}},{key:"getResidueColor",value:function(r,i){var s=this.opts;return this._getColorByOccupancy(r.occupancy,s)}}]),t}(Pr);Le(Uo,"id","OC");Uo.prototype.id="OC";Uo.prototype.name="Occupancy";Uo.prototype.shortName="Occupancy";function tP(a){var e=rP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function rP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Go=function(a){re(t,a);var e=tP(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){var s=this.palette.defaultResidueColor;if(r._type.hydrophobicity!==void 0){var o=-4.5,l=4.5;s=this.palette.getGradientColor((r._type.hydrophobicity-o)/(l-o),this.opts.gradient)}return s}}]),t}(Pr);Le(Go,"id","HY");Go.prototype.id="HY";Go.prototype.name="Hydrophobicity";Go.prototype.shortName="Hydrophobicity";function nP(a){var e=iP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function iP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Ho=function(a){re(t,a);var e=nP(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){return this.getResidueColor(r.residue,i)}},{key:"getResidueColor",value:function(r,i){var s=r._molecule,o=i.getMoleculeCount();return o>1?this.palette.getGradientColor((s.index-1)/(o-1),this.opts.gradient):this.palette.getGradientColor(0,this.opts.gradient)}}]),t}(Pr);Le(Ho,"id","MO");Ho.prototype.id="MO";Ho.prototype.name="Molecule";Ho.prototype.shortName="Molecule";function aP(a){var e=sP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function sP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function oP(a,e){var t=a>>16&255,n=a>>8&255,r=a&255,i=e*t,s=e*n,o=e*r;return i<<16|s<<8|o}var Wo=function(a){re(t,a);var e=aP(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"getAtomColor",value:function(r,i){var s=this.opts.color,o=oP(s,this.opts.factor);return r.flags&ln.Flags.CARBON?s:o}},{key:"getResidueColor",value:function(r,i){return this.opts.color}}]),t}(Pr);Le(Wo,"id","CB");Wo.prototype.id="CB";Wo.prototype.name="Carbon";Wo.prototype.shortName="Carbon";var Jl=new ia([Io,ko,Oo,Do,bs,Fo,Bo,zo,Vo,Uo,Go,Ho,Wo]);function Yt(a){return new ze(a,a,a)}var lP=[{id:"DF",name:"Diffuse",shortName:"Diffuse",uberOptions:{diffuse:Yt(1),specular:Yt(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"SF",name:"Soft Plastic",shortName:"Soft",uberOptions:{diffuse:Yt(1),specular:Yt(.1),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"PL",name:"Glossy Plastic",shortName:"Glossy",uberOptions:{diffuse:Yt(.56),specular:Yt(.28),shininess:100,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"ME",name:"Metal",shortName:"Metal",uberOptions:{diffuse:Yt(.56),specular:Yt(.55),shininess:30,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!1}},{id:"TR",name:"Transparent",shortName:"Transparent",uberOptions:{diffuse:Yt(1),specular:Yt(0),shininess:1,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"GL",name:"Glass",shortName:"Glass",uberOptions:{diffuse:Yt(.5),specular:Yt(.65),shininess:100,opacity:.5},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!0,toonShading:!1}},{id:"BA",name:"Backdrop",shortName:"Backdrop",uberOptions:{diffuse:Yt(1),specular:Yt(0),shininess:1,opacity:1},values:{lights:!1,fog:!1,depthWrite:!1,transparent:!1,toonShading:!1}},{id:"TN",name:"Toon",shortName:"Toon",uberOptions:{diffuse:Yt(1),specular:Yt(0),shininess:1,opacity:1},values:{lights:!0,fog:!0,depthWrite:!0,transparent:!1,toonShading:!0}},{id:"FL",name:"Flat",shortName:"Flat",uberOptions:{diffuse:Yt(1),specular:Yt(0),shininess:0,opacity:1},values:{lights:!1,fog:!0,depthWrite:!0,transparent:!1}}],Za=new ia(lP);function cP(a,e){var t=[];return a.traverse(function(n){for(var r=0;r<e.length;r++)if(n instanceof e[r]){t[t.length]=n;break}}),t}function Uh(a,e,t){var n=a.material.createInstance();n.setValues(e);var r=new a.constructor(a.geometry,n);return r.material.needsUpdate=!0,r.applyMatrix4(a.matrix),r.layers.set(t),r}function Xo(a,e,t){for(var n=cP(a,e),r=0,i=n.length;r<i;++r){var s=n[r];s.parent&&t(s)}}function uP(a,e){var t=e.length;if(!(t<1)){var n=[ft,Gr,ea];Xo(a,n,function(r){r.applyMatrix4(e[0]);for(var i=1;i<t;++i){var s=new r.constructor(r.geometry,r.material);r.parent.add(s),s.applyMatrix4(e[i])}})}}var fP=function(){var a={prepassTransparancy:!0,fakeOpacity:!1,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1};return function(e,t){t instanceof Mn&&Xo(e,[ft,Gr],function(n){n.material.setValues({prepassTransparancy:!1,fakeOpacity:!1}),n.material.needsUpdate=!0,n.layers.set(Je.LAYERS.TRANSPARENT);var r=Uh(n,a,Je.LAYERS.PREPASS_TRANSPARENT);n.parent.add(r)})}}(),hP=function(){var a={colorFromPos:!0,transparent:!1,colorFromDepth:!1,lights:!1,shadowmap:!1,fog:!1,overrideColor:!1,fogTransparent:!1,attrColor:!1,attrColor2:!1,attrAlphaColor:!1,fakeOpacity:!1};return function(e,t){t instanceof Mn&&Xo(e,[ft,Gr],function(n){var r=Uh(n,a,Je.LAYERS.COLOR_FROM_POSITION);n.parent.add(r)})}}(),dP=function(){var a={colorFromDepth:!0,orthoCam:!0,lights:!1,shadowmap:!1,fog:!1};return function(e,t){t instanceof Mn&&Xo(e,[ft,Gr],function(n){if(!n.receiveShadow&&n.material.shadowmap&&n.material.setValues({shadowmap:!1}),!!n.material.lights&&n.castShadow&&Je.belongToSelectLayers(n)){var r=Uh(n,a,Je.LAYERS.SHADOWMAP);r.isShadowmapMesh=!0,n.parent.add(r)}})}}();function pP(a,e){e instanceof Mn&&Xo(a,[ft,Gr],function(t){t.isShadowmapMesh&&t.parent.remove(t)})}function U_(a,e){function t(n){n instanceof ft&&e(n);for(var r=0,i=n.children.length;r<i;r++)t(n.children[r])}t(a)}function mP(a){var e=a.geometry;if(e instanceof wi){var t=e.attributes;for(var n in t)if(t.hasOwnProperty(n)&&t[n]instanceof Mr){var r=t[n],i=e.index?e.index.array.length/3:0;return i*r.array.length/r.itemSize}return 0}return e instanceof at?e.index?e.index.array.length/3:0:e.faces?e.faces.length:0}function vP(a){var e=0;return U_(a,function(t){e+=mP(t)}),e}var Ka={applyTransformsToMeshes:uP,processTransparentMaterial:fP,processColFromPosMaterial:hP,createShadowmapMaterial:dP,removeShadowmapMaterial:pP,forEachMeshInGroup:U_,countTriangles:vP},gP=qe.selectors,Uf=function(){function a(e,t,n,r){G(this,a);var i={clipPlane:Q.now.draft.clipPlane,fogTransparent:Q.now.bg.transparent,shadowmap:Q.now.shadow.on,shadowmapType:Q.now.shadow.type};this.index=e,this.mode=t,this.colorer=n,this.selector=r,this.selectorString="",this.count=0,this.material=new Mn,this.material.setValues(i),this.material.setUberOptions({fogAlpha:Q.now.fogAlpha}),this.materialPreset=Za.first,this.needsRebuild=!0,this.visible=!0,this.setMode(t)}return H(a,[{key:"markAtoms",value:function(t){return this.count=t.markAtoms(this.selector,1<<this.index),this.needsRebuild=!0,this.count}},{key:"unmarkAtoms",value:function(t){t.clearAtomBits(1<<this.index),this.count=0}},{key:"setMode",value:function(t){this.mode=t}},{key:"setMaterialPreset",value:function(t){this.materialPreset=t,this.material.setUberOptions(t.uberOptions),this.material.setValues(t.values)}},{key:"reset",value:function(){this.geo=null,this.selectionGeo=null}},{key:"buildGeometry",value:function(t){return this.reset(),this.needsRebuild=!1,Q.now.ao&&this.material.setValues({normalsToGBuffer:Q.now.ao}),this.geo=this.mode.buildGeometry(t,this.colorer,1<<this.index,this.material),this.material.uberOptions.opacity<.99&&Q.now.transparency==="prepass"&&Ka.processTransparentMaterial(this.geo,this.material),this.geo.visible=this.visible,Je.processObjRenderOrder(this.geo,this.materialPreset.id),Ka.processColFromPosMaterial(this.geo,this.material),Q.now.shadow.on&&Ka.createShadowmapMaterial(this.geo,this.material),this.geo}},{key:"buildSelectionGeometry",value:function(t){var n=null;if(this.geo&&"getSubset"in this.geo){var r=this.geo.getSubset(t);if(r&&r.length>0){n=new nr,n.matrixAutoUpdate=!1,n.matrix=this.geo.matrix;for(var i=0;i<r.length;i++){var s=r[i];n.add(s)}}}return n&&(n.visible=this.visible),this.selectionGeo=n,this.selectionGeo}},{key:"compare",value:function(t){var n={},r=String(this.selector);(!t||r.valueOf()!==String(t.selector).valueOf())&&(n.selector=r);var i=this.mode.identify();(!t||Array.isArray(i)||i!==t.mode)&&(n.mode=i);var s=this.colorer.identify();return(!t||Array.isArray(s)||s!==t.colorer)&&(n.colorer=s),(!t||this.materialPreset.id!==t.material)&&(n.material=this.materialPreset.id),n}},{key:"change",value:function(t,n,r,i){var s={};if(t.selector){var o=gP.parse(t.selector).selector,l=String(o);this.selectorString!==l&&(s.selector=l,this.selectorString=l,this.selector=o,this.markAtoms(n))}if(t.mode){var c=t.mode;le.isEqual(this.mode.identify(),c)||(s.mode=c,this.setMode(r))}if(t.colorer){var u=t.colorer;le.isEqual(this.colorer.identify(),u)||(s.colorer=u,this.colorer=i)}if(t.material){var f=t.material;le.isEqual(this.materialPreset.id,f)||(s.material=f,this.setMaterialPreset(Za.get(t.material)))}return s}},{key:"show",value:function(t){this.visible=t,this.geo&&(this.geo.visible=t),this.selectionGeo&&(this.selectionGeo.visible=t)}}]),a}();function G_(a){var e=_P();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function _P(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function H_(a,e,t){var n=a.children;if(n)for(var r=0,i=n.length;r<i;++r){var s=n[r];s._component===e&&t(s),s instanceof Je.RCGroup&&H_(s,e,t)}}function W_(){}var yP=function(a){re(t,a);var e=G_(t);function t(n){var r;return G(this,t),r=e.call(this),r._complexVisual=n,r._inProgress=!1,r}return H(t,[{key:"begin",value:function(){var r=this._complexVisual.getComplex();this._componentTransforms=[];for(var i=0;i<r._components.length;++i){var s=r._components[i];this._componentTransforms[s._index]=new lt}return this._inProgress=!0,!0}},{key:"apply",value:function(){if(this._inProgress){for(var r=this._complexVisual.getComplex(),i=0;i<r._components.length;++i)this._bakeComponentTransform(r._components[i]);r.onAtomPositionChanged(),this._resetComponentTransform(),this._complexVisual.finalizeEdit()}}},{key:"discard",value:function(){this._inProgress&&(this._resetComponentTransform(),this._complexVisual.finalizeEdit())}},{key:"getAltObj",value:function(){var r={objects:[],pivot:new b(0,0,0)},i=this._complexVisual,s=i.getSelectedComponent();if(s===null)return r;var o=this._complexVisual.getSelectionGeo(),l=1<<i.getSelectionBit(),c,u,f,h;for(H_(i,s,function(v){r.objects.push(v)}),c=0;c<o.children.length;++c)for(f=o.children[c],u=0;u<f.children.length;++u)h=f.children[u],h.hasOwnProperty("_component")&&h._component===s&&r.objects.push(h);r.objects.push(this._componentTransforms[s._index]);var d=new b(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p=new b(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s.forEachResidue(function(v){var _=v._atoms;for(u=0;u<_.length;++u)_[u].mask&l&&(d.min(_[u].position),p.max(_[u].position))}),r.pivot.lerpVectors(d,p,.5),r}},{key:"_bakeComponentTransform",value:function(r){var i=this._componentTransforms[r._index];i&&(!(i.position.x===0&&i.position.y===0&&i.position.z===0)||!(i.quaternion.x===0&&i.quaternion.y===0&&i.quaternion.z===0&&i.quaternion.w===1))&&(i.updateMatrix(),r.forEachResidue(function(s){for(var o=s._atoms,l=0;l<o.length;++l)o[l].position.applyMatrix4(i.matrix)}))}},{key:"_resetComponentTransform",value:function(){var r=this._complexVisual,i=this._complexVisual.getSelectionGeo(),s,o,l,c;for(s=0;s<this._componentTransforms.length;++s)c=this._componentTransforms[s],c.position.set(0,0,0),c.quaternion.set(0,0,0,1);for(s=0;s<r.children.length;++s)for(l=r.children[s],o=0;o<l.children.length;++o)c=l.children[o],c.hasOwnProperty("_component")&&(c.position.set(0,0,0),c.quaternion.set(0,0,0,1));for(s=0;s<i.children.length;++s)for(l=i.children[s],o=0;o<l.children.length;++o)c=l.children[o],c.hasOwnProperty("_component")&&(c.position.set(0,0,0),c.quaternion.set(0,0,0,1))}}]),t}(W_),xP=function(a){re(t,a);var e=G_(t);function t(n){var r;return G(this,t),r=e.call(this),r._complexVisual=n,r._inProgress=!1,r}return H(t,[{key:"begin",value:function(){var r=this._complexVisual,i=this._complexVisual.getSelectionGeo(),s=this._getSelectionBorderAtoms();if(s.length<1||s.length>2)return Wt.error("Can only edit fragments with one or two bound atoms."),!1;this._fragmentBoundAtoms=s;var o=1<<r.getSelectionBit();r.disableSubset(o,!0);for(var l=0;l<i.children.length;++l)i.children[l].visible=!1;var c=s[0].position.clone();s.length===2&&c.lerp(s[1].position,.5),this._fragmentGeo=new nr,r.add(this._fragmentGeo),this._fragmentGeo.position.copy(c),this._fragmentSelectionGeo=new nr,i.add(this._fragmentSelectionGeo),this._fragmentSelectionGeo.position.copy(c);var u=c.clone();u.negate();for(var f=0;f<r.children.length;++f){var h=r.children[f];if("getSubset"in h){var d=new nr;this._fragmentGeo.add(d);var p=new nr;this._fragmentSelectionGeo.add(p);for(var v=h.getSubset(o,!0),_=0;_<v.length;_++){var m=v[_];d.add(m),m.position.copy(u)}for(var g=h.getSubset(o,!0),y=0;y<g.length;y++){var x=g[y];p.add(x),x.position.copy(u)}}}return Je.applySelectionMaterial(this._fragmentSelectionGeo),this._inProgress=!0,!0}},{key:"apply",value:function(){if(this._inProgress){var r=this._complexVisual,i=r.getSelectionBit(),s=this._fragmentGeo.position,o=this._fragmentGeo.matrix.clone();o.multiply(new Ce().makeTranslation(-s.x,-s.y,-s.z)),this._bakeAtomTransform(o,1<<i),r.enableSubset(1<<i,!0),r.getComplex().onAtomPositionChanged(),r.finalizeEdit()}}},{key:"discard",value:function(){if(this._inProgress){var r=this._complexVisual,i=this._complexVisual.getSelectionGeo();this._fragmentGeo.parent.remove(this._fragmentGeo),r.enableSubset(1<<r.getSelectionBit(),!0);for(var s=0;s<i.children.length;++s){var o=i.children[s];o.visible?i.remove(o):o.visible=!0}r.finalizeEdit()}}},{key:"isFreeRotationAllowed",value:function(){return this._fragmentBoundAtoms.length<2}},{key:"getAltObj",value:function(){var r={objects:[],pivot:new b(0,0,0)};r.objects.push(this._fragmentGeo,this._fragmentSelectionGeo);var i=this._fragmentBoundAtoms;if(i.length===1){if(i[0].bonds.length===1){var s=i[0].bonds[0];r.axis=new b().subVectors(s._right.position,s._left.position),r.axis.normalize(),r.axis.transformDirection(this._complexVisual.matrixWorld)}}else i.length===2&&(r.axis=new b().subVectors(i[1].position,i[0].position),r.axis.normalize(),r.axis.transformDirection(this._complexVisual.matrixWorld));return r}},{key:"_getSelectionBorderAtoms",value:function(){var r=this._complexVisual.getComplex(),i=1<<this._complexVisual.getSelectionBit(),s={};r.forEachBond(function(h){h._left.mask&i?h._right.mask&i||(s[h._left.index]=1):h._right.mask&i&&(s[h._right.index]=1)});for(var o=[],l=Object.keys(s),c=0,u=l.length;c<u;++c){var f=l[c];o.push(r._atoms[f])}return o}},{key:"_bakeAtomTransform",value:function(r,i){this._complexVisual.getComplex().forEachAtom(function(s){s.mask&i&&s.position.applyMatrix4(r)})}}]),t}(W_),Zm={ComponentEditor:yP,FragmentEditor:xP};function SP(a){var e=bP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function bP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ur=qe.selectors;function Fa(a,e){Array.isArray(e)||(e=[e]);var t=e,n=Lt(t,2),r=n[0],i=n[1],s=a.get(r)||a.first;return new s(i)}var gn=function(a){re(t,a);var e=SP(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._complex=r,i._reprList=[],i._repr=null,i._reprListChanged=!0,i._selectionBit=0,i._reprUsedBits=0,i._selectionCount=0,i._selectionGeometry=new nr,i}return H(t,[{key:"getBoundaries",value:function(){return this._complex.getBoundaries()}},{key:"release",value:function(){this._selectionGeometry.parent&&this._selectionGeometry.remove(this._selectionGeometry),go.prototype.release.call(this)}},{key:"getComplex",value:function(){return this._complex}},{key:"getSelectionCount",value:function(){return this._selectionCount}},{key:"getSelectionGeo",value:function(){return this._selectionGeometry}},{key:"getSelectionBit",value:function(){return this._selectionBit}},{key:"getEditor",value:function(){return this._editor}},{key:"resetReps",value:function(r){this._complex&&this._complex.clearAtomBits(-1),this._reprListChanged=!0,this._reprUsedBits=0,this._reprList.length=r.length;for(var i=0,s=r.length;i<s;++i){var o=r[i],l=void 0,c=void 0;if(typeof o.selector=="string"){c=o.selector;var u=ur.parse(c);l=u.selector}else if(typeof o.selector>"u"){c=Q.now.presets.default[0].selector;var f=ur.parse(c);l=f.selector}else l=o.selector,c=l.toString();var h=Fa(Kl,o.mode),d=Fa(Jl,o.colorer),p=Za.get(o.material)||Za.first;this._reprList[i]=new Uf(i,h,d,l),this._reprList[i].setMaterialPreset(p),this._reprList[i].selectorString=c,this._complex&&this._complex.markAtoms(l,1<<i),this._reprUsedBits|=1<<i}this._repr=r.length>0?this._reprList[0]:null,this._selectionBit=r.length,this._reprUsedBits|=1<<this._selectionBit,this._selectionCount=0,this._complex&&this._complex.update()}},{key:"repCount",value:function(){return this._reprList.length}},{key:"repCurrent",value:function(r){return r>=0&&r<this._reprList.length?this._repr=this._reprList[r]:r=this._reprList.indexOf(this._repr),r}},{key:"rep",value:function(r,i){if(!i&&(r===void 0||r instanceof Object)&&(i=r,r=this.repCurrent()),r<0||r>this._reprList.length)return Wt.error("Rep ".concat(r," does not exist!")),null;if(r===this._reprList.length){var s=this.repAdd(i);return Wt.warn("Rep ".concat(r," does not exist! New representation was created.")),{desc:s.desc,index:r,status:"created"}}var o=this._reprList[r],l={selector:o.selectorString,mode:o.mode.identify(),colorer:o.colorer.identify(),material:o.materialPreset.id};if(i){var c=o.change(i,this._complex,Fa(Kl,i.mode),Fa(Jl,i.colorer));if(!le.isEmpty(c)){o.needsRebuild=!0;for(var u in c)c.hasOwnProperty(u)&&(l[u]=c[u],Wt.debug("rep[".concat(r,"].").concat(u," changed to ").concat(c[u])));return c.mode&&o.mode.isSurface&&(Q.now.resolution==="ultra"||Q.now.resolution==="high")&&(Wt.report('Surface resolution was changed to "medium" to avoid hang-ups.'),Q.set("resolution","medium")),{desc:l,index:r,status:"changed"}}}return{desc:l,index:r,status:""}}},{key:"repGet",value:function(r){return(r===void 0||r instanceof Object)&&(r=this.repCurrent()),r<0||r>=this._reprList.length?null:this._reprList[r]}},{key:"_getFreeReprIdx",value:function(){for(var r=this._reprUsedBits,i=0;i<=t.NUM_REPRESENTATION_BITS;++i,r>>=1)if(!(r&1))return i;return-1}},{key:"repAdd",value:function(r){if(this._reprList.length>=t.NUM_REPRESENTATION_BITS)return null;var i=this._getFreeReprIdx();if(i<0)return null;var s=this.buildSelectorFromMask(1<<this._selectionBit),o=Q.now.presets.default[0],l=le.merge({selector:o.selector,mode:o.mode,colorer:o.colorer,material:o.material},r),c=typeof l.selector=="string"?ur.parse(l.selector).selector:l.selector,u=new Uf(this._selectionBit,Fa(Kl,l.mode),Fa(Jl,l.colorer),c);return u.selectorString=c.toString(),u.setMaterialPreset(Za.get(l.material)),u.markAtoms(this._complex),this._reprList.push(u),this._selectionBit=i,this._reprUsedBits|=1<<this._selectionBit,this._complex.markAtoms(s,1<<this._selectionBit),{desc:l,index:this._reprList.length-1}}},{key:"repRemove",value:function(r){r===void 0&&(r=this.repCurrent());var i=this._reprList.length;if(!(r<0||r>=i||i<=1)){var s=this._reprList[r];s.unmarkAtoms(this._complex),this._reprUsedBits&=~(1<<s.index),this._reprList.splice(r,1),s===this._repr&&(--i,r=r<i?r:i-1,this._repr=this._reprList[r]),this._reprListChanged=!0}}},{key:"repHide",value:function(r,i){if(i===void 0&&(i=!0),!(r<0||r>=this._reprList.length)){var s=this._reprList[r];s.show(!i)}}},{key:"select",value:function(r,i){i?this._selectionCount+=this._complex.markAtomsAdditionally(r,1<<this._selectionBit):this._selectionCount=this._complex.markAtoms(r,1<<this._selectionBit),this._complex.updateStructuresMask(),this.rebuildSelectionGeometry()}},{key:"resetSelectionMask",value:function(){this._selectionCount!==0&&(this._selectionCount=0,this._complex&&this._complex.clearAtomBits(1<<this._selectionBit))}},{key:"updateSelectionMask",value:function(r){var i=this,s=r.atom,o=r.residue,l=r.chain,c=r.molecule,u=1<<this._selectionBit,f=~u;if(s)o=s.residue,l=o._chain,c=o._molecule,s.mask&u?(s.mask&=f,o._mask&=f,l._mask&=f,c&&(c.mask&=f),this._selectionCount--):(s.mask|=u,this._selectionCount++,o.collectMask(),l.collectMask(),c&&c.collectMask());else if(o)l=o._chain,c=o._molecule,o._mask&u?(o._mask&=f,l._mask&=f,o.forEachAtom(function(d){d.mask&u&&(d.mask&=f,i._selectionCount--)})):(o._mask|=u,o.forEachAtom(function(d){d.mask&u||(d.mask|=u,i._selectionCount++)}),l.collectMask(),c&&c.collectMask());else if(l||c){var h=l||c;h._mask&u?(h._mask&=f,h.forEachResidue(function(d){d._mask&u&&(d._mask&=f,d.forEachAtom(function(p){p.mask&u&&(p.mask&=f,i._selectionCount--)}),d._mask&=f)})):(h._mask|=u,h.forEachResidue(function(d){if(!(d._mask&u)){d._mask|=u,d.forEachAtom(function(v){v.mask&u||(v.mask|=u,i._selectionCount++)});var p=l?d.getMolecule():d.getChain();p&&p.collectMask()}}))}else this.resetSelectionMask()}},{key:"expandSelection",value:function(){var r=this,i=1<<this._selectionBit,s=1<<31;this._complex.forEachBond(function(l){l._left.mask&i?l._right.mask&i||(l._right.mask|=s):l._right.mask&i&&(l._left.mask|=s)});var o=2147483647;this._complex.forEachAtom(function(l){l.mask&s&&(l.mask=l.mask&o|i,++r._selectionCount)}),this._complex.updateStructuresMask()}},{key:"shrinkSelection",value:function(){var r=this,i=1<<this._selectionBit,s=1<<31;this._complex.forEachBond(function(l){l._left.mask&i?l._right.mask&i||(l._left.mask|=s):l._right.mask&i&&(l._right.mask|=s)}),this._complex.forEachAtom(function(l){l.mask&i&&l.bonds.length===1&&(l.mask|=s)});var o=~(i|s);this._complex.forEachAtom(function(l){l.mask&s&&(l.mask&=o,--r._selectionCount)}),this._complex.updateStructuresMask()}},{key:"getSelectedComponent",value:function(){var r=1<<this._selectionBit,i=null,s=!1;return this._complex.forEachAtom(function(o){o.mask&r&&(i===null?i=o.residue._component:i!==o.residue._component&&(s=!0))}),s?null:i}},{key:"getSelectionCenter",value:function(r,i,s){r.set(0,0,0);var o=0;return this._complex.forEachAtom(function(l){i(l,s)&&(r.add(l.position),o++)}),o===0?!1:(r.divideScalar(o),r.applyMatrix4(this.matrix),!0)}},{key:"needsRebuild",value:function(){if(this._reprListChanged)return!0;for(var r=this._reprList,i=0,s=r.length;i<s;++i){var o=r[i];if(o.needsRebuild)return!0}return!1}},{key:"rebuild",value:function(){var r=this;return Je.clearTree(this),new Promise(function(i){var s=r._complex;if(!s){i();return}var o=!1;setTimeout(function(){console.time("build");for(var l=r._reprList,c=ns.get(Q.now.palette)||ns.first,u=!1,f=0,h=l.length;f<h;++f){var d=l[f];if(d.colorer.palette=c,d.needsRebuild){d.reset();try{d.buildGeometry(s)}catch(p){if(p instanceof Se.OutOfMemoryError)d.needsRebuild=!1,d.reset(),Wt.error("Not enough memory to build geometry for representation ".concat(d.index+1)),o=!0;else throw p}}u=o||u||Je.groupHasGeometryToRender(d.geo),d.geo&&r.add(d.geo)}r._reprListChanged=!1,console.timeEnd("build"),i()},10)})}},{key:"setNeedsRebuild",value:function(){for(var r=this._reprList,i=0,s=r.length;i<s;++i)r[i].needsRebuild=!0}},{key:"rebuildSelectionGeometry",value:function(){var r=1<<this._selectionBit;Je.clearTree(this._selectionGeometry);for(var i=0,s=this._reprList.length;i<s;++i){var o=this._reprList[i],l=o.buildSelectionGeometry(r);if(l){this._selectionGeometry.add(l);for(var c=0;c<l.children.length;c++){var u=l.children[c];if(this._editor&&this._editor._componentTransforms){var f=this._editor._componentTransforms[u._component._index];f&&(u.position.copy(f.position),u.quaternion.copy(f.quaternion))}}Je.applySelectionMaterial(l)}}}},{key:"_buildSelectorFromSortedLists",value:function(r,i,s){var o=this._complex;function l(h){for(var d=[],p=0,v=NaN,_=NaN,m=0,g=h.length;m<g;++m){var y=h[m];y===_+1?_=y:(Number.isNaN(v)||(d[p++]=new ur.Range(v,_)),v=_=y)}return Number.isNaN(v)||(d[p]=new ur.Range(v,_)),d}var c=null;if(s.length===o._chains.length)c=ur.all();else{var u;if(s.length>0&&(u=ur.chain(s),c=c?ur.or(c,u):u),Object.keys(i).length>0)for(var f in i)i.hasOwnProperty(f)&&(u=ur.and(ur.chain(f),ur.residx(l(i[f]))),c=c?ur.or(c,u):u);r.length>0&&(u=ur.serial(l(r)),c=c?ur.or(c,u):u),c||(c=ur.none())}return c}},{key:"buildSelectorFromMask",value:function(r){var i=this._complex,s=[],o={},l=[];return i.forEachChain(function(c){c._mask&r&&s.push(c._name)}),i.forEachResidue(function(c){if(c._mask&r&&!(c._chain._mask&r)){var u=c._chain._name;u in o?o[u].push(c._index):o[u]=[c._index]}}),i.forEachAtom(function(c){c.mask&r&&!(c.residue._mask&r)&&l.push(c.serial)}),this._buildSelectorFromSortedLists(l,o,s)}},{key:"forSelectedResidues",value:function(r){var i=1<<this._selectionBit;this._complex.forEachResidue(function(s){s._mask&i&&r(s)})}},{key:"beginComponentEdit",value:function(){if(this._editor)return null;var r=new Zm.ComponentEditor(this);return r.begin()?(this._editor=r,r):null}},{key:"beginFragmentEdit",value:function(){if(this._editor)return null;var r=new Zm.FragmentEditor(this);return r.begin()?(this._editor=r,r):null}},{key:"finalizeEdit",value:function(){this._editor=null}},{key:"setMaterialValues",value:function(r){for(var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,o=0,l=this._reprList.length;o<l;++o){var c=this._reprList[o];c.material.setValues(r),i&&c.geo.traverse(function(u){u instanceof ft&&(u.material.setValues(r),s!==void 0&&s(u),u.material.needsUpdate=!0)})}}},{key:"setUberOptions",value:function(r){for(var i=0,s=this._reprList.length;i<s;++i){var o=this._reprList[i];o.material.setUberOptions(r)}}},{key:"within",value:function(r,i){var s=this._complex.getVoxelWorld();if(s===null)return!1;var o=1<<this._selectionBit;return this._complex.markAtoms(r,o),s&&s.forEachAtomWithinDistFromMasked(this._complex,o,Number(i),function(l){l.mask|=o}),this._selectionCount=this._complex.countAtomsByMask(o),this._complex.updateStructuresMask(),this.buildSelectorFromMask(o)}}]),t}(go);gn.NUM_REPRESENTATION_BITS=30;var wP=`varying vec3 pos;\r
\r
void main() {\r
  // we're assuming local position is in [-0.5, 0.5]\r
  // we need to offset it to be represented in RGB\r
  pos = position.xyz + 0.5;\r
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r
}`,MP=`varying vec3 pos;\r
\r
void main() {\r
  gl_FragColor = vec4(pos, 0.5);\r
}`,EP=`varying vec4 screenSpacePos;\r
\r
void main() {\r
  screenSpacePos = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r
  gl_Position = screenSpacePos;\r
}`,CP=`uniform mat4 projectionMatrix;\r
\r
// 3D volume texture\r
uniform vec3 volumeDim;    // volume dimensions, pixels\r
uniform sampler2D tileTex; // tiled texture containing all Z-slices of a 3D data\r
uniform vec2 tileTexSize;  // size of tiled texture, pixels\r
uniform vec2 tileStride;   // UV stride between slices in tile tex, pixels\r
\r
uniform vec3 boxAngles;//value of angles({x: alpha, y:beta, z:gamma}) types 1 - if angle is obtuse, 0 - if acute\r
uniform vec3 delta; //Projection box delta's from non-orthogonal origin axes; {x: XY, y : XZ, z: YZ}\r
\r
uniform vec3 _isoLevel0;\r
uniform float _flipV;\r
uniform sampler2D _BFLeft;\r
uniform sampler2D _BFRight;\r
uniform sampler2D _FFLeft;\r
uniform sampler2D _FFRight;\r
uniform sampler2D _WFFLeft;\r
uniform sampler2D _WFFRight;\r
\r
varying vec4 screenSpacePos;\r
\r
#define NO_COLOR vec4(0., 0., 0., 0.)\r
\r
vec4 sample3DTexture(vec3 texCoord) {\r
  // a pair of Z slices is determined by nearest slice border\r
  float zSliceBorder = floor(texCoord.z * volumeDim.z + 0.5);\r
  float zSliceNumber1 = max(zSliceBorder - 1.0, 0.0);\r
  float zSliceNumber2 = min(zSliceBorder, volumeDim.z - 1.0);\r
\r
  float rowTiles = floor(tileTexSize.x / tileStride.x);\r
\r
  // calculate coords in tile texture for both slices\r
  vec2 tileOffset = vec2(mod(zSliceNumber1, rowTiles), floor(zSliceNumber1 / rowTiles));\r
  vec2 texCoordSlice1 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r
  tileOffset = vec2(mod(zSliceNumber2, rowTiles), floor(zSliceNumber2 / rowTiles));\r
  vec2 texCoordSlice2 = (texCoord.xy * volumeDim.xy + tileOffset * tileStride) / tileTexSize.xy;\r
\r
  // bilinear filtering\r
  vec4 colorSlice1 = texture2D(tileTex, texCoordSlice1);\r
  vec4 colorSlice2 = texture2D(tileTex, texCoordSlice2);\r
  float weightSlice2 = texCoord.z * volumeDim.z - (zSliceNumber1 + 0.5);\r
  return mix(colorSlice1, colorSlice2, weightSlice2);\r
}\r
\r
vec4 sample3DTextureInclined(vec3 boxCoord) { // delta:{ x: XY, y : XZ, z: YZ }\r
  vec3 textCoord = boxCoord;\r
  vec2 currDelta = mix(boxCoord.zz, vec2(1., 1.) - boxCoord.zz, boxAngles.yx) * delta.yz;\r
\r
  textCoord.y = (boxCoord.y  - currDelta.y) / (1. - delta.z);\r
  if (textCoord.y < 0.0 || textCoord.y > 1.0)\r
    return NO_COLOR;\r
\r
  currDelta.x += mix(textCoord.y, 1.0 - textCoord.y, boxAngles.z) * delta.x;\r
\r
  textCoord.x = (boxCoord.x - currDelta.x) / (1. - delta.x - delta.y);\r
  if (textCoord.x < 0.0 || textCoord.x > 1.0)\r
    return NO_COLOR;\r
\r
  return sample3DTexture(textCoord);\r
}\r
\r
float CalcColor(vec3 iter, vec3 dir) {\r
  float d = 1. / 128.;\r
  vec3 dx = vec3(d, 0.0, 0.0);\r
  vec3 dy = vec3(0.0, d, 0.0);\r
  vec3 dz = vec3(0.0, 0.0, d);\r
\r
  // #Opt: coordInc.x:(iter + dx).x > 1. ? 0.: sample3DTextureInclined(iter + dx).x,\r
  vec3 coordInc = mix(\r
    vec3(\r
      sample3DTextureInclined(iter + dx).x,\r
      sample3DTextureInclined(iter + dy).x,\r
      sample3DTextureInclined(iter + dz).x\r
    ),\r
    vec3(0. ,0. , 0.),\r
    vec3(floor((iter + dx).x), floor((iter + dy).y), floor((iter + dz).z))\r
  );\r
\r
  // #Opt: coordDec.x:(iter - dx).x < 0. ? 0.: sample3DTextureInclined(iter - dx).x,\r
  vec3 coordDec = mix(\r
    vec3(0. ,0. , 0.),\r
    vec3(\r
      sample3DTextureInclined(iter - dx).x,\r
      sample3DTextureInclined(iter - dy).x,\r
      sample3DTextureInclined(iter - dz).x\r
    ),\r
    vec3(ceil((iter - dx).x), ceil((iter - dy).y), ceil((iter - dz).z))\r
  );\r
\r
  vec3 N = normalize(coordInc - coordDec);\r
  float dif = max(0.0, dot(N, dir));\r
  return dif;\r
}\r
\r
vec3 AccuracyIso(vec3 left, vec3 right, float volLeft, float threshold) {\r
  for (int i = 0; i < 5; i++) {\r
    vec3 iterator = 0.5 * (left + right);\r
    float vol = sample3DTextureInclined(iterator).r;\r
    if ((volLeft - threshold) * (vol - threshold) < 0.)\r
      right = iterator;\r
    else\r
      left = iterator;\r
  }\r
  return 0.5 * (left + right);\r
}\r
\r
vec3 CorrectIso(vec3 left, vec3 right, float tr) {\r
  for (int j = 0; j < 5; j++) {\r
    vec3 iterator = 0.5 * (left + right);\r
    float vol = sample3DTextureInclined(iterator).r;\r
    if (vol < tr)\r
      right = iterator;\r
    else\r
      left = iterator;\r
  }\r
  return 0.5 * (left + right);\r
}\r
\r
vec4 GetIso1(vec3 start, vec3 back, float molDist, vec3 dir, float tr, int count) {\r
  float vol, stepSize = (float(count) + 2.) / float(STEPS_COUNT);\r
  vec3 step = stepSize * dir, iterator = start, left, right;\r
  vec4 acc = NO_COLOR;\r
\r
  for (int i = 0; i < STEPS_COUNT; i++) {\r
    iterator = iterator + step;\r
    vol = sample3DTextureInclined(iterator).r;\r
    if (length(iterator - back) <= stepSize || (vol > tr))\r
      break;\r
  }\r
\r
  if (vol > tr)\r
    acc = vec4(CorrectIso(iterator, iterator - step, tr).xyz, 1.);\r
\r
  return acc;\r
}\r
\r
float easeOut(float x0, float x1, float x) {\r
  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r
  return 1.0 - (1.0 - t) * (1.0 - t);\r
}\r
\r
float easeIn(float x0, float x1, float x) {\r
  float t = clamp((x - x0) / (x1 - x0), 0.0, 1.0);\r
  return t * t;\r
}\r
\r
vec3 GetColSimple(float vol) {\r
  float t = easeOut(_isoLevel0.x, _isoLevel0.y, vol);\r
  float s = easeIn(_isoLevel0.y, _isoLevel0.z, vol);\r
  return vec3(0.5, 0.6, 0.7) * (1.0 - t) + 2.0 * vec3(s, 0, 0);\r
}\r
\r
vec4 VolRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r
  vec4 acc = NO_COLOR, iso;\r
  vec3 iterator = start, sumColor = vec3(0., 0., 0.);\r
  float stepSize, alpha, sumAlpha = 0.0, vol, curStepSize, molD;\r
  vec3 step, col, colOld, right;\r
  float tr0 = _isoLevel0.x;\r
  float dif, r, kd, finish;\r
  int count = 0, stopMol = 0;\r
\r
  for (int k = 0; k < 3; k++) {\r
    stepSize = (float(k) + 2.) / float(STEPS_COUNT);\r
    kd = 140. * tr0 * stepSize;\r
    r = 1. - kd;\r
    step = stepSize * dir;\r
    iso = GetIso1(iterator, back, molDist, dir, tr0, k);\r
    if (iso.a < 0.1 || length(iso.xyz - start) > molDist)\r
      break;\r
    iterator = iso.xyz;\r
    dif = 1.;// CalcColor(iterator, dir);\r
    colOld = GetColSimple(tr0);\r
    curStepSize = stepSize;\r
    for (int i = 0; i < STEPS_COUNT; i++) {\r
      iterator = iterator + step;\r
      molD = length(iterator - start);\r
      vol = sample3DTextureInclined(iterator).r;\r
      finish = distance(iterator, back) - stepSize;\r
      if (finish < 0.0 || vol < tr0 || (sumAlpha > 0.97) || molD > molDist)\r
        break;\r
      alpha = (1. - r);\r
      col = GetColSimple(vol);\r
      vol = sample3DTextureInclined(iterator - 0.5 * step).r;\r
      vec3 colMid = GetColSimple(vol);\r
      sumColor += (1. - sumAlpha) * (colOld + 4.* colMid + col) * alpha / 6.;\r
      sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r
      colOld = col;\r
    } // for i\r
\r
    if (finish < 0.0 || sumAlpha > 0.97)\r
      break;\r
\r
    if (molD > molDist) {\r
      curStepSize = stepSize - (molD - molDist);\r
      right = iterator - (molD - molDist) * dir;\r
      vol = sample3DTextureInclined(right).r;\r
    } else {\r
      vec3 left = iterator - step;\r
      right = CorrectIso(left, iterator, tr0);\r
      curStepSize = distance(left, right);\r
      vol = tr0;\r
    }\r
\r
    alpha = (1. - r) * curStepSize / stepSize;\r
    dif = 1.;// CalcColor(right, dir);\r
    col = GetColSimple(vol);\r
    vol = sample3DTextureInclined(iterator - 0.5 * curStepSize / stepSize * step).r;\r
    vec3 colMid = GetColSimple(vol);\r
    sumColor += (1. - sumAlpha) * (colOld + 4. * colMid + col) * alpha / 6.;\r
    sumAlpha += (1. - sumAlpha) * alpha;// *(1. - 1.0*dif*dif);\r
\r
    if (molD > molDist)\r
      break;\r
  } // for k\r
  acc.rgb = 1. * sumColor / sumAlpha;\r
  acc.a = sumAlpha;\r
  return acc;\r
}\r
\r
vec4 VolRender1(vec3 start, vec3 back, float molDist, vec3 dir) {\r
  float stepSize = 1.0 / float(STEPS_COUNT);\r
  float len = length(back - start);\r
  vec3 step = stepSize * dir;\r
  vec3 iterator = start;\r
  float acc = 0.0;\r
\r
  for (int i = 0; i < STEPS_COUNT; i++) {\r
    if (float(i) * stepSize > len)\r
      break;\r
    iterator = iterator + step;\r
    if (sample3DTextureInclined(iterator).r > _isoLevel0.x)\r
      acc += 10. * sample3DTextureInclined(iterator).r / float(STEPS_COUNT);\r
  }\r
\r
  return vec4(1.,1.,1., acc);\r
}\r
\r
vec4 IsoRender(vec3 start, vec3 back, float molDist, vec3 dir) {\r
  vec4 tst = GetIso1(start, back, 2., dir, _isoLevel0.x, 0);\r
  vec4 col = NO_COLOR;\r
\r
  if (length(tst.xyz - start) < molDist && tst.a > 0.1) {\r
    float dif =  CalcColor(tst.xyz, dir);\r
    dif = 0.9 * dif * dif;\r
    col = vec4(dif, dif, dif, 1);\r
  }\r
  return col;\r
}\r
\r
vec4 VolRender2(vec3 start, vec3 back, float molDist, vec3 dir) {\r
  return sample3DTexture(start);\r
}\r
\r
void main() {\r
  vec3 tc = screenSpacePos.xyz / screenSpacePos.w * 0.5 + 0.5;\r
\r
  if (_flipV > 0.0) {\r
    tc.y = 1.0 - tc.y;\r
  }\r
\r
  vec3 start;\r
  vec3 back;\r
  vec3 molBack;\r
  if (projectionMatrix[0][2] < 0.0) {\r
    start = texture2D(_FFLeft, tc.xy).xyz;\r
    back = texture2D(_BFLeft, tc.xy).xyz;\r
    molBack = texture2D(_WFFLeft, tc.xy).xyz;\r
  } else {\r
    start = texture2D(_FFRight, tc.xy).xyz;\r
    back = texture2D(_BFRight, tc.xy).xyz;\r
    molBack = texture2D(_WFFRight, tc.xy).xyz;\r
  }\r
\r
  vec3 dir = normalize(back - start);\r
\r
  float molDist = 2.0;\r
  if (length(molBack) > 0.001) {\r
    molDist = distance(start, molBack);\r
  }\r
\r
  #ifdef ISO_MODE\r
    gl_FragColor = IsoRender(start, back, molDist, dir);\r
  #else\r
    gl_FragColor = VolRender(start, back, molDist, dir);\r
  #endif\r
}\r
`,AP=`varying vec4 volPos;\r
uniform float aspectRatio;\r
uniform float farZ;\r
uniform float tanHalfFOV;\r
uniform mat4  matWorld2Volume;\r
\r
void main() {\r
  // rescale plane to fill in the whole far plane area seen from camera\r
  vec3 pos = position.xyz;\r
  pos.x = pos.x * tanHalfFOV * farZ * aspectRatio;\r
  pos.y = pos.y * tanHalfFOV * farZ;\r
  // common transformation\r
  gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\r
  // calc pos in volume CS\r
  volPos = matWorld2Volume * modelMatrix * vec4(pos, 1.0);\r
  // we're assuming local position is in [-0.5, 0.5]\r
  // we need to offset it to be represented in RGB\r
  volPos = volPos + 0.5;\r
  volPos.w = 0.5;\r
}\r
`,TP=`varying vec4 volPos;\r
\r
void main() {\r
  gl_FragColor = volPos;\r
}`;function zc(a){var e=RP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function RP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var LP=qi.merge([{volumeDim:{type:"v3",value:new b(512,512,512)},tileTex:{type:"t",value:null},tileTexSize:{type:"v2",value:new ve(512,512)},tileStride:{type:"v2",value:new ve(512,512)},boxAngles:{type:"v3",value:new b(1,1,1)},delta:{type:"v3",value:new b(0,0,0)},_isoLevel0:{type:"v2",value:new b(.5,.75,1)},_flipV:{type:"f",value:0},_BFLeft:{type:"t",value:null},_BFRight:{type:"t",value:null},_FFLeft:{type:"t",value:null},_FFRight:{type:"t",value:null},_WFFLeft:{type:"t",value:null},_WFFRight:{type:"t",value:null}}]);function X_(a,e){var t=qi.clone(e);for(var n in a)t.hasOwnProperty(n)&&(t[n].value=a[n]);return t}function j_(a,e){return{uniforms:X_(a,{}),vertexShader:wP,fragmentShader:MP,transparent:!1,depthTest:!1,depthWrite:!1,side:e}}var PP=function(a){re(t,a);var e=zc(t);function t(n){G(this,t);var r=j_(n,Ut);return e.call(this,r)}return H(t)}(cn),Y_=H(function a(e,t,n,r){G(this,a),this.uniforms=X_(e,t),this.vertexShader=n,this.fragmentShader=r,this.transparent=!1,this.depthTest=!1,this.depthWrite=!1,this.side=ji}),NP=function(a){re(t,a);var e=zc(t);function t(n){G(this,t);var r=qi.merge([{aspectRatio:{type:"f",value:0},farZ:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},matWorld2Volume:{type:"4fv",value:new Ce}}]),i=new Y_(n,r,AP,TP);return e.call(this,i)}return H(t)}(cn),IP=function(a){re(t,a);var e=zc(t);function t(n){G(this,t);var r=j_(n,ji);return e.call(this,r)}return H(t)}(cn),kP=function(a){re(t,a);var e=zc(t);function t(n){var r;G(this,t);var i=new Y_(n,LP,EP,CP);return i.transparent=!0,i.depthTest=!0,r=e.call(this,i),r.updateDefines(),r}return H(t,[{key:"updateDefines",value:function(){this.defines={ISO_MODE:Q.now.modes.VD.isoMode,STEPS_COUNT:Q.now.modes.VD.polyComplexity[Q.now.resolution]*100},this.needsUpdate=!0}}]),t}(cn),dc={BackFacePosMaterial:PP,BackFacePosMaterialFarPlane:NP,FrontFacePosMaterial:IP,VolumeMaterial:kP};function OP(a){var e=DP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function DP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Cn=function(a){re(t,a);var e=OP(t);function t(){var n;G(this,t);var r=new at;n=e.call(this,r),Le(qr(n),"volumeInfo",{}),n.clipPlane=new an;var i=new b(.5,.5,.5);return n.size=i,n.cullFlag=[!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1],n.faces=[{indices:[],norm:new b(0,0,-1)},{indices:[],norm:new b(0,0,1)},{indices:[],norm:new b(0,-1,0)},{indices:[],norm:new b(0,1,0)},{indices:[],norm:new b(-1,0,0)},{indices:[],norm:new b(1,0,0)},{indices:[],norm:new b(0,0,0)}],n.vertices=[new b(-i.x,-i.y,-i.z),new b(-i.x,i.y,-i.z),new b(i.x,-i.y,-i.z),new b(i.x,i.y,-i.z),new b(-i.x,-i.y,i.z),new b(-i.x,i.y,i.z),new b(i.x,-i.y,i.z),new b(i.x,i.y,i.z),new b(0,0,0),new b(0,0,0),new b(0,0,0),new b(0,0,0),new b(0,0,0),new b(0,0,0)],r.setAttribute("position",new Ze(new Float32Array(n.vertices.length*3),3)),n.name="VolumeMesh",n}return H(t,[{key:"_updateVertices",value:function(){var r=t._corners,i=t._edges,s=t._edgeIntersections,o,l=this.clipPlane.normal,c=this.clipPlane.constant,u=this.vertices,f=this.size,h=[0,0,0,0,0,0,0,0],d=[1,1,1,1,1,1,1,1,1,1,1,1],p=new b,v=null;function _(){if(l.x===0)return 0;var W=-(l.dot(p)+c)/l.x;return-f.x<=W&&W<=f.x?(v.set(W,p.y,p.z),W===f.x?2:W===-f.x?-2:1):0}function m(){if(l.y===0)return 0;var W=-(l.dot(p)+c)/l.y;return-f.y<=W&&W<=f.y?(v.set(p.x,W,p.z),W===f.y?2:W===-f.y?-2:1):0}function g(){if(l.z===0)return 0;var W=-(l.dot(p)+c)/l.z;return-f.z<=W&&W<=f.z?(v.set(p.x,p.y,W),W===f.z?2:W===-f.z?-2:1):0}for(var y=0;y<12;++y){var x=i[y];v=s[y],p.set(x[2],x[3],x[4]),p.multiply(f);var S=0;x[2]===0&&(S=_()),x[3]===0&&(S=m()),x[4]===0&&(S=g()),S===-2?h[x[0]]=1:S===2?h[x[1]]=1:S===0&&(d[y]=0)}var M={indices:[],norm:l.clone().negate()},E=8;for(o=0;o<8;++o)h[o]===1&&(u[E].set(r[o][0],r[o][1],r[o][2]).multiply(f),M.indices.push(E++),d[r[o][3]]=0,d[r[o][4]]=0,d[r[o][5]]=0);for(o=0;o<12;++o)d[o]===1&&(u[E].copy(s[o]),M.indices.push(E++));this.faces[6]=M;var N=new b,B=new b;for(this.clipPlane.coplanarPoint(B),o=0;o<u.length;++o)this.cullFlag[o]=!1,o<8?(N.subVectors(u[o],B),this.cullFlag[o]=l.dot(N)>=0):o<8+M.indices.length&&(this.cullFlag[o]=!0);var V=this.geometry.getAttribute("position"),O=0;for(o=0;o<u.length;++o)V.array[O++]=u[o].x,V.array[O++]=u[o].y,V.array[O++]=u[o].z;V.needsUpdate=!0}},{key:"_collectVertices",value:function(r,i){var s,o=this.vertices;for(r.indices=[],s=0;s<o.length;++s)this.cullFlag[s]&&i(o[s])&&r.indices.push(s)}},{key:"_sortIndices",value:function(r,i){var s,o,l=this.vertices,c=[],u=new b;for(s=1;s<r.indices.length;++s)u.subVectors(l[r.indices[s]],l[r.indices[0]]),u.normalize(),u.cross(i),u.negate(),c[s]=r.norm.dot(u);for(s=1;s<r.indices.length-1;++s)for(o=s+1;o<r.indices.length;++o)if(c[o]<c[s]){var f=c[s];c[s]=c[o],c[o]=f,f=r.indices[s],r.indices[s]=r.indices[o],r.indices[o]=f}}},{key:"_updateIndices",value:function(){var r,i,s,o=this.vertices,l=this.size;this._collectVertices(this.faces[0],function(g){return g.z===-l.z}),this._collectVertices(this.faces[1],function(g){return g.z===l.z}),this._collectVertices(this.faces[2],function(g){return g.y===-l.y}),this._collectVertices(this.faces[3],function(g){return g.y===l.y}),this._collectVertices(this.faces[4],function(g){return g.x===-l.x}),this._collectVertices(this.faces[5],function(g){return g.x===l.x});var c=new b,u=new b,f=new b;for(i=0;i<this.faces.length;++i)if(s=this.faces[i],s.indices.length!==0){for(c.set(0,0,0),r=0;r<s.indices.length;++r)c.add(o[s.indices[r]]);c.multiplyScalar(1/s.indices.length),u.subVectors(o[s.indices[0]],c),u.normalize();var h=[];for(r=0;r<s.indices.length;++r)f.subVectors(o[s.indices[r]],c),h[r]=f.dot(u);for(r=1;r<s.indices.length;++r)if(h[r]<h[0]){var d=h[0];h[0]=h[r],h[r]=d;var p=Lt(s.indices,1);d=p[0],s.indices[0]=s.indices[r],s.indices[r]=d}this._sortIndices(s,u)}var v=0;for(i=0;i<this.faces.length;++i)s=this.faces[i],s.indices.length>=3&&(v+=3*(s.indices.length-2));var _=0,m=new Uint16Array(v);for(i=0;i<this.faces.length;++i)for(s=this.faces[i],r=0;r<s.indices.length-2;++r)m[_]=s.indices[0],m[_+1]=s.indices[r+1],m[_+2]=s.indices[r+2],_+=3;this.geometry.setIndex(new Ze(m,1))}},{key:"setDataSource",value:function(r){var i=new dc.VolumeMaterial,s=r.getDimensions(),o=r.getTiledTextureStride(),l=r.buildTiledTexture(),c=r.getBox();i.uniforms.volumeDim.value.set(s[0],s[1],s[2]),i.uniforms.tileTex.value=l,i.uniforms.tileTexSize.value.set(l.image.width,l.image.height),i.uniforms.tileStride.value.set(o[0],o[1]),Object.assign(this.volumeInfo,r.getVolumeInfo());var u=this.volumeInfo;i.uniforms.delta.value.copy(u.delta),i.uniforms.boxAngles.value.set(u.obtuseAngle[0],u.obtuseAngle[1],u.obtuseAngle[2]),this.material=i,c.getSize(this.scale),c.getCenter(this.position)}},{key:"_updateIsoLevel",value:function(){var r=Q.now.modes.VD,i=r.kSigma,s=r.kSigmaMed,o=r.kSigmaMax,l=this.volumeInfo,c=l.dmean-l.dmin,u=l.dmax-l.dmin,f=function(d){return(c+d*l.sd)/u};this.material.uniforms._isoLevel0.value.set(f(i),f(s),f(o))}},{key:"rebuild",value:function(r){var i=t._nearClipPlaneOffset,s=t._pos,o=t._norm,l=t._norm4D,c=t._matrixWorldToLocal,u=t._clipPlane;this._updateIsoLevel(),r.getWorldDirection(o),r.getWorldPosition(s),s.addScaledVector(o,r.near+i),c.copy(this.matrixWorld).invert(),s.applyMatrix4(c),l.set(o.x,o.y,o.z,0),l.applyMatrix4(c),o.copy(l),o.normalize(),u.setFromNormalAndCoplanarPoint(o,s),this.clipPlane.equals(u)||(this.clipPlane=u.clone(),this._updateVertices(),this._updateIndices())}}]),t}(ft);Le(Cn,"_corners",[[-1,-1,-1,0,4,8],[1,-1,-1,0,5,9],[1,1,-1,1,5,10],[-1,1,-1,1,4,11],[-1,-1,1,2,6,8],[1,-1,1,2,7,9],[1,1,1,3,7,10],[-1,1,1,3,6,11]]);Le(Cn,"_edges",[[0,1,0,-1,-1],[2,3,0,1,-1],[4,5,0,-1,1],[6,7,0,1,1],[0,3,-1,0,-1],[1,2,1,0,-1],[4,7,-1,0,1],[5,6,1,0,1],[0,4,-1,-1,0],[1,5,1,-1,0],[2,6,-1,1,0],[3,7,1,1,0]]);Le(Cn,"_edgeIntersections",function(){for(var a=[],e=0;e<12;++e)a.push(new b);return a}());Le(Cn,"_nearClipPlaneOffset",.2);Le(Cn,"_pos",new b);Le(Cn,"_norm",new b);Le(Cn,"_norm4D",new ht);Le(Cn,"_matrixWorldToLocal",new Ce);Le(Cn,"_clipPlane",new an);function FP(a){for(var e=a.length,t=new Float32Array(e*3),n=0;n<e;++n){var r=3*n,i=a[n];t[r]=i.x,t[r+1]=i.y,t[r+2]=i.z}return t}var q_=function(){function a(e,t){G(this,a);var n=t.delta,r=t.obtuseAngle,i=new b;e.getSize(i),i.multiplyScalar(.5);for(var s=this._getBaseVertices(n,r),o=new at,l=[],c=0;c<4;c++)l.push(s[c].clone().multiply(i)),l.push(s[(c+1)%4].clone().multiply(i));for(var u=new b(2*i.x*(1-n.x-n.y),0,0),f=0;f<8;f++)l.push(l[f].clone().add(u));for(var h=0;h<4;h++)l.push(l[h*2].clone()),l.push(l[h*2+8].clone());var d=new b;e.getCenter(d),l.forEach(function(v){return v.add(d)});var p=FP(l);o.setAttribute("position",new Ze(p,3)),this._lines=new Gr(o,new Qi({color:16777215})),this._lines.layers.set(Je.LAYERS.VOLUME)}return H(a,[{key:"_getBaseVertices",value:function(t,n){var r=a._projectionTable,i=function(l,c){var u=t[r[l][0]],f=-.5*(c-1)+c*n[r[l][1]];return f*u},s=[new b(-1+2*(i("XZ",1)+i("XY",1)),-1+2*i("YZ",1),-1),new b(-1+2*(i("XZ",-1)+i("XY",1)),-1+2*i("YZ",-1),1),new b(-1+2*(i("XZ",-1)+i("XY",-1)),1-2*i("YZ",1),1),new b(-1+2*(i("XZ",1)+i("XY",-1)),1-2*i("YZ",-1),-1)];return s}},{key:"getMesh",value:function(){return this._lines}}]),a}();Le(q_,"_projectionTable",{XY:["x",2],XZ:["y",1],YZ:["z",0]});var BP=function(){function a(e,t,n){G(this,a);var r=this._initPlaneGeo(t,n),i=new dc.BackFacePosMaterialFarPlane;this._plane=new jr.Mesh(r,i),this._plane.frustumCulled=!1,this._plane.doubleSided=!0;var s=new Ce;this._plane._onBeforeRender=function(o,l,c,u,f,h){var d=this.material;if(!(!e||!d)){var p=new ht(0,0,-(c.far-.1),1);p.applyMatrix4(c.matrixWorld),this.matrix.identity(),this.matrix.makeTranslation(p.x,p.y,p.z),this.matrixWorld.copy(this.matrix),this.modelViewMatrix.multiplyMatrices(c.matrixWorldInverse,this.matrixWorld),this.normalMatrix.getNormalMatrix(this.modelViewMatrix);var v=e.matrixWorld;s.copy(v).invert(),d.uniforms.aspectRatio.value=c.aspect,d.uniforms.farZ.value=c.far,d.uniforms.tanHalfFOV.value=Math.tan(Vn.DEG2RAD*.5*c.fov),d.uniforms.matWorld2Volume.value=s}},this._plane.layers.set(Je.LAYERS.VOLUME_BFPLANE)}return H(a,[{key:"_initPlaneGeo",value:function(t,n){var r=new at;t=t||1,n=n||1;var i=new Float32Array([-.5*t,.5*n,0,.5*t,.5*n,0,-.5*t,-.5*n,0,.5*t,-.5*n,0]);return r.setAttribute("position",new Ze(i,3)),r.setIndex([0,2,1,2,3,1]),r}},{key:"getMesh",value:function(){return this._plane}}]),a}();function zP(a){var e=VP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function VP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Qu=function(a){re(t,a);var e=zP(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._mesh=new Cn,i._mesh.setDataSource(r),i.add(i._mesh),i._frame=new q_(i.getBoundaries().boundingBox,i._mesh.volumeInfo),i.add(i._frame.getMesh()),i.showFrame(Q.now.modes.VD.frame),i._farPlane=new BP(i._mesh,2,2),i.add(i._farPlane.getMesh()),i}return H(t,[{key:"getBoundaries",value:function(){var r=this._dataSource.getBox(),i=new Lr;return r.getBoundingSphere(i),{boundingBox:r,boundingSphere:i}}},{key:"getMesh",value:function(){return this._mesh}},{key:"showFrame",value:function(r){this._frame.getMesh().material.visible=r}}]),t}(go);function UP(a){var e=GP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function GP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var HP=function(a){re(t,a);var e=UP(t);function t(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return G(this,t),e.call(this,n,["types"])}return H(t,[{key:"find",value:function(r){var i=[];if(r.type)i=this._dict.types[r.type.toLowerCase()]||[];else if(r.source)return this._list.filter(function(s){return s.canProbablyLoad&&s.canProbablyLoad(r.source)});return $i(i)}}]),t}(ia);function WP(a){var e=XP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function XP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Vc=function(a){re(t,a);var e=WP(t);function t(n,r){var i;return G(this,t),i=e.call(this),i._source=n,i._options=r||{},i._abort=!1,i._agent=null,i}return H(t,[{key:"load",value:function(){return Promise.reject(new Error("Loading from this source is not implemented"))}},{key:"abort",value:function(){this._abort=!0,this._agent&&this._agent.abort()}}],[{key:"extractName",value:function(r){}}]),t}(gr);Ao(Vc.prototype);function jP(a){var e=YP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function YP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var $_=function(a){re(t,a);var e=jP(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),r=i._options,i._binary=r.binary===!0,i}return H(t,[{key:"load",value:function(){var r=this;return new Promise(function(i,s){if(r._abort)throw new Error("Loading aborted");var o=r._source,l=r._agent=new FileReader;l.addEventListener("load",function(){i(l.result)}),l.addEventListener("error",function(){s(l.error)}),l.addEventListener("abort",function(){s(new Error("Loading aborted"))}),l.addEventListener("progress",function(c){r.dispatchEvent(c)}),r._binary?l.readAsArrayBuffer(o):l.readAsText(o)})}}],[{key:"canProbablyLoad",value:function(r){return File&&r instanceof File||Blob&&r instanceof Blob}},{key:"extractName",value:function(r){return r&&r.name}}]),t}(Vc);$_.types=["file","blob"];function qP(a){var e=$P();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function $P(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ZP=/^(https?|ftp):\/\//i,Z_=function(a){re(t,a);var e=qP(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),r=i._options,i._binary=r.binary===!0,i}return H(t,[{key:"load",value:function(){var r=this;return new Promise(function(i,s){if(r._abort)throw new Error("Loading aborted");var o=r._source,l=r._agent=new XMLHttpRequest;l.addEventListener("load",function(){l.status===200?i(l.response):s(new Error("HTTP ".concat(l.status," while fetching ").concat(o)))}),l.addEventListener("error",function(){s(new Error("HTTP request failed"))}),l.addEventListener("abort",function(){s(new Error("Loading aborted"))}),l.addEventListener("progress",function(c){r.dispatchEvent(c)}),l.open("GET",o),r._binary?l.responseType="arraybuffer":l.responseType="text",l.send()})}}],[{key:"canProbablyLoad",value:function(r){return le.isString(r)&&ZP.test(r)}},{key:"extractName",value:function(r){if(r){var i=(r.indexOf("?")+1||r.lastIndexOf("#")+1||r.length+1)-1;return r.slice(r.lastIndexOf("/",i)+1,i)}}}]),t}(Vc);Z_.types=["url"];function KP(a){var e=JP();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function JP(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var K_=function(a){re(t,a);var e=KP(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"load",value:function(){var r=this;return new Promise(function(i){if(r._abort)throw new Error("Loading aborted");i(r._source)})}}],[{key:"canProbablyLoad",value:function(r){return!1}}]),t}(Vc);K_.types=["immediate"];var QP=new HP([$_,Z_,K_]);function eN(a){var e=tN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function tN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var rN=function(a){re(t,a);var e=eN(t);function t(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return G(this,t),e.call(this,n,["formats","extensions"])}return H(t,[{key:"find",value:function(r){var i=[];return r.format?i=this._dict.formats[r.format.toLowerCase()]||[]:r.ext&&(i=this._dict.extensions[r.ext.toLowerCase()]||[]),i.length===0&&!r.format&&r.data?this._list.filter(function(s){return s.canProbablyParse&&s.canProbablyParse(r.data)}):$i(i)}}]),t}(ia),zr=function(){function a(e,t){G(this,a),this._data=e,this._options=t||{},this._abort=!1}return H(a,[{key:"parseSync",value:function(){throw new Error("Parsing this type of data is not implemented")}},{key:"parse",value:function(){var t=this;return new Promise(function(n,r){setTimeout(function(){try{return t._abort?r(new Error("Parsing aborted")):n(t.parseSync())}catch(i){return r(i)}})})}},{key:"getModel",value:function(){return this.model._parseHeader(this._data),this.model}},{key:"abort",value:function(){this._abort=!0}}]),a}();Ao(zr.prototype);var J_=function(){function a(){G(this,a),this.matrices=[],this._matrix=null,this._matrixIndex=-1}return H(a,[{key:"parse",value:function(t){var n=this._matrix;if(t.readString(12,18)==="  SMTRY"){var r=t.readCharCode(19)-49,i=t.readString(20,80).trim().split(/\s+/),s=parseInt(i[0],10);(this._matrix===null||s!==this._matrixIndex)&&(this._matrixIndex=s,this._matrix=n=new Ce,this.matrices[this.matrices.length]=n);var o=n,l=o.elements;l[r]=parseFloat(i[1]),l[r+4]=parseFloat(i[2]),l[r+8]=parseFloat(i[3]),l[r+12]=parseFloat(i[4])}}}]),a}();J_.prototype.id=290;var nN=qe.Assembly,Q_=function(){function a(e){G(this,a),this._complex=e,this.assemblies=[],this._assembly=null,this._matrix=null,this._matrixIndex=-1}return H(a,[{key:"parse",value:function(t){var n=this._assembly,r=this._matrix;if(n&&t.readString(12,18)==="  BIOMT"){var i=t.readCharCode(19)-49,s=t.readString(20,80).trim().split(/\s+/),o=parseInt(s[0],10);(this._matrix===null||o!==this._matrixIndex)&&(this._matrixIndex=o,this._matrix=r=new Ce,n.addMatrix(r));var l=r,c=l.elements;c[i]=parseFloat(s[1]),c[i+4]=parseFloat(s[2]),c[i+8]=parseFloat(s[3]),c[i+12]=parseFloat(s[4])}else if(n&&t.readString(35,41)==="CHAINS:")for(var u=t.readString(42,80).split(","),f=0,h=u.length;f<h;++f){var d=u[f].trim();d.length>0&&n.addChain(d)}else t.readString(12,23)==="BIOMOLECULE:"&&(this._matrix=null,this._matrixIndex=-1,this._assembly=n=new nN(this._complex),this.assemblies.push(n))}}]),a}();Q_.prototype.id=350;var e0=function(){function a(e){G(this,a),this._data=e,this._start=0,this._nextCR=-1,this._nextLF=-1,this._next=-1,this._end=e.length,this.next()}return H(a,[{key:"readLine",value:function(){return this._data.slice(this._start,this._next)}},{key:"readChar",value:function(t){return t=this._start+t-1,t<this._next?this._data[t]:" "}},{key:"readCharCode",value:function(t){return t=this._start+t-1,t<this._next?this._data.charCodeAt(t):32}},{key:"readString",value:function(t,n){var r=this._start+t-1,i=this._start+n;return this._data.slice(r,i<this._next?i:this._next)}},{key:"readInt",value:function(t,n){return parseInt(this.readString(t,n),10)}},{key:"readFloat",value:function(t,n){return parseFloat(this.readString(t,n))}},{key:"end",value:function(){return this._start>=this._end}},{key:"next",value:function(){var t=this._next+1;this._start=t<this._end?t:this._end,this._start>this._nextCR&&(this._nextCR=(this._data.indexOf("\r",this._start)+1||this._end+1)-1),this._start>this._nextLF&&(this._nextLF=(this._data.indexOf(`
`,this._start)+1||this._end+1)-1),this._next=this._nextCR+1<this._nextLF?this._nextCR:this._nextLF}}]),a}();function iN(a){var e=aN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function aN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var sN=qe.Complex,Km=qe.Element,oN=qe.Helix,lN=qe.Sheet,cN=qe.Strand,Hl=qe.Bond,uN=qe.Molecule,fN=6;function hN(a){var e=a.trim().length===4;return a.slice(0,e?1:2).trim()}var dN=/^(HEADER\s|COMPND\s|REMARK\s|ATOM {2}|HETATM|MODEL )/i,pN={290:J_,350:Q_},Nt=function(a){re(t,a);var e=iN(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._complex=null,i._chain=null,i._residue=null,i._sheet=null,i._serialAtomMap=null,i._modelId=1,i._compaundFound=!1,i._biomoleculeFound=!1,i._allowedChainsIDs=null,i._lastMolId=-1,i._remarks={},i._remark=null,i._molecules=[],i._molecule=null,i._compndCurrToken="",i._options.fileType="pdb",i}return H(t,[{key:"_finalize",value:function(){this._fixBondsArray(),this._fixChains();var r=this._remarks[290];this._complex.symmetry=le.isUndefined(r)?[]:r.matrices;var i=this._remarks[350];this._complex.units=this._complex.units.concat(le.isUndefined(i)?[]:i.assemblies),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_finalizeMolecules",value:function(){var r={},i,s=this._complex._chains;for(i=0;i<s.length;++i){var o=s[i],l=o._name;r[l]=o}for(i=0;i<this._molecules.length;i++){for(var c=this._molecules[i],u=[],f=0;f<c._chains.length;f++){var h=c._chains[f],d=r[h];u=u.concat(d._residues.slice())}var p=new uN(this._complex,c._name,i+1);p.residues=u,this._complex._molecules[i]=p}}},{key:"_fixChains",value:function(){for(var r={},i=this._complex,s=0;s<i._chains.length;s++){var o=i._chains[s];r[o._name.charCodeAt(0)]=o}}},{key:"_fixBondsArray",value:function(){for(var r=this._serialAtomMap={},i=this._complex,s=i._atoms,o=0,l=s.length;o<l;++o){var c=s[o];r[c.serial]=c}for(var u=i._bonds,f=this.logger,h=0,d=u.length;h<d;++h){var p=u[h];p._right<p._left&&f.debug("_fixBondsArray: Logic error."),p._left=r[p._left]||null,p._right=r[p._right]||null}}},{key:"_parseATOM",value:function(r){if(this._modelId===1){var i=r.readCharCode(1)===72,s=i?r.readInt(7,11):r.readInt(6,11),o=r.readString(13,16),l=r.readChar(17),c=r.readString(18,20).trim(),u=r.readChar(22),f=r.readInt(23,26),h=r.readChar(27),d=r.readFloat(31,38),p=r.readFloat(39,46),v=r.readFloat(47,54),_=r.readFloat(55,60),m=r.readFloat(61,66),g=r.readString(77,78).trim()||hN(o),y=r.readInt(79,80)||0;if(!(this.settings.now.nowater&&(c==="HOH"||c==="WAT"))){o=o.trim();var x=Km.getByName(g),S=Km.Role[o],M=this._chain;(!M||M.getName()!==u)&&(this._chain=M=this._complex.getChain(u)||this._complex.addChain(u),this._residue=null);var E=this._residue;(!E||E.getSequence()!==f||E.getICode()!==h)&&(this._residue=E=M.addResidue(c,f,h));var N=new b(d,p,v);E.addAtom(o,x,N,S,i,s,l,_,m,y)}}}},{key:"_parseENDMDL",value:function(){this._modelId+=1}},{key:"_parseCONECT",value:function(r){var i=r.readInt(7,11),s=r.readInt(12,16),o=r.readInt(17,21),l=r.readInt(22,26),c=r.readInt(27,31),u=this._complex;s&&s>i&&u.addBond(i,s,0,Hl.BondType.UNKNOWN,!0),o&&o>i&&u.addBond(i,o,0,Hl.BondType.UNKNOWN,!0),l&&l>i&&u.addBond(i,l,0,Hl.BondType.UNKNOWN,!0),c&&c>i&&u.addBond(i,c,0,Hl.BondType.UNKNOWN,!0)}},{key:"_parseCOMPND",value:function(r){var i=r.readString(11,80),s=i.indexOf(":");if(this._compndCurrToken=s>0?i.substring(0,s).trim():this._compndCurrToken,this._compndCurrToken==="MOL_ID")this._molecule={_index:"",_chains:[]},this._molecule._index=parseInt(i.substring(s+1,i.indexOf(";")),10),this._molecules.push(this._molecule);else if(this._compndCurrToken==="MOLECULE"&&this._molecule!=null)this._molecule._name=i.substring(s+1,i.indexOf(";")).trim();else if(this._compndCurrToken==="CHAIN"&&this._molecule!=null){var o=i.substring(s+1,80).trim(),l=o[o.length-1];(l===";"||l===",")&&(o=o.slice(0,-1)),o=o.replace(/\s+/g,"");var c=o.split(",");this._molecule._chains=this._molecule._chains.concat(c)}}},{key:"_parseREMARK",value:function(r){var i=r.readInt(8,10),s=this._remarks[i];if(le.isUndefined(s)){var o=pN[i];typeof o=="function"&&(this._remarks[i]=s=new o(this._complex))}le.isUndefined(s)||s.parse(r)}},{key:"_parseHELIX",value:function(r){var i=this,s=[20,22,32,34];this._parseSTRUCTURE(r,s,function(o){i._complex.addHelix(o),i._complex.structures.push(o)})}},{key:"_parseSHEET",value:function(r){var i=this,s=[22,23,33,34];this._parseSTRUCTURE(r,s,function(o){i._complex.addSheet(o)})}},{key:"_parseSTRUCTURE",value:function(r,i,s){var o=0,l=1,c=2,u=3,f=83,h=r.readInt(8,10),d=r.readString(12,14).trim(),p=r.readString(41,70).trim(),v=r.readInt(72,76),_=r.readInt(39,40),m=r.readInt(15,16),g=r.readInt(42,45),y=r.readInt(57,60),x=r.readString(i[o],i[c]+1).charCodeAt(0),S=r.readString(i[c],i[c]+1).charCodeAt(0),M=r.readInt(i[l],i[l]+3),E=r.readString(i[l]+4,i[l]+4),N=0;E.length>0&&(N=E.charCodeAt(0));var B=r.readInt(i[u],i[u]+3);E=r.readString(i[u]+4,i[u]+4);var V=0;E.length>0&&(V=E.charCodeAt(0));var O,W=this._sheet;if(r.readCharCode(1)===f){W!==null&&W.getName()!==d&&(W=null,this._sheet=null),W===null?(this._sheet=O=new lN(d,m),s(O)):O=W;var z=new cN(O,this._complex.getUnifiedSerial(x,M,N),this._complex.getUnifiedSerial(S,B,V),_,g,y);O.addStrand(z),this._complex.structures.push(z)}else O=new oN(_,this._complex.getUnifiedSerial(x,M,N),this._complex.getUnifiedSerial(S,B,V),h,d,p,v),s(O)}},{key:"_parseHEADER",value:function(r){var i=this._complex.metadata;i.classification=r.readString(11,50).trim(),i.date=r.readString(51,59).trim();var s=r.readString(63,66).trim();i.id=s,s&&(this._complex.name=s),i.format="pdb"}},{key:"_parseTITLE",value:function(r){var i=this._complex.metadata;i.title=i.title||[];var s=r.readInt(9,10)||1;i.title[s-1]=r.readString(11,80).trim()}},{key:"parseSync",value:function(){for(var r=new e0(this._data),i=this._complex=new sN;!r.end();){var s=r.readString(1,fN),o=t.tagParsers[s];typeof o=="function"&&o.call(this,r),r.next()}if(this._finalize(),this._serialAtomMap=null,this._sheet=null,this._residue=null,this._chain=null,this._complex=null,i.getAtomCount()===0)throw new Error("The data does not contain valid atoms");return i}}],[{key:"canProbablyParse",value:function(r){return le.isString(r)&&dN.test(r)}}]),t}(zr);Le(Nt,"tagParsers",{HEADER:Nt.prototype._parseHEADER,"TITLE ":Nt.prototype._parseTITLE,"ATOM  ":Nt.prototype._parseATOM,HETATM:Nt.prototype._parseATOM,ENDMDL:Nt.prototype._parseENDMDL,CONECT:Nt.prototype._parseCONECT,COMPND:Nt.prototype._parseCOMPND,REMARK:Nt.prototype._parseREMARK,"HELIX ":Nt.prototype._parseHELIX,"SHEET ":Nt.prototype._parseSHEET,"ATOM 1":Nt.prototype._parseATOM,"ATOM 2":Nt.prototype._parseATOM,"ATOM 3":Nt.prototype._parseATOM,"ATOM 4":Nt.prototype._parseATOM,"ATOM 5":Nt.prototype._parseATOM,"ATOM 6":Nt.prototype._parseATOM,"ATOM 7":Nt.prototype._parseATOM,"ATOM 8":Nt.prototype._parseATOM,"ATOM 9":Nt.prototype._parseATOM});Nt.formats=["pdb"];Nt.extensions=[".pdb",".ent"];function mN(a){var e=vN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function vN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ef=qe.Complex,Ba=qe.Element,gN=qe.SGroup,Jm=qe.Bond,_N={A:0,S:1,D:2,T:3},yN=/\s*<\?xml\b[^?>]*\?>\s*<(?:cml|molecule)\b/i,Gh=function(a){re(t,a);var e=mN(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._complex=null,i._residue=null,i._serialAtomMap=null,i._modelId=1,i._lastMolId=-1,i._readOnlyOneMolecule=!1,i._options.fileType="cml",i}return H(t,[{key:"_rebuidBondIndexes",value:function(r,i){for(var s=r.length,o=0;o<s;o++)for(var l=r[o].id,c=i.length,u=0;u<c;u++){var f=i[u].atomRefs2.split(" ");f[0]===l&&(i[u].start=o),f[1]===l&&(i[u].end=o)}}},{key:"_createSGroup",value:function(r,i){var s=new gN(r.id,r.fieldData,new b(parseFloat(r.x),parseFloat(r.y),0),r.atomRefs,r);r.placement==="Relative"&&(s._center=new b(0,0,0)),r.fieldName==="MDLBG_FRAGMENT_CHARGE"&&(s._charge=parseInt(r.fieldData,10)||0),r.fieldName==="MDLBG_FRAGMENT_COEFFICIENT"&&(s._repeat=parseInt(r.fieldData,10)||1),i.push(s)}},{key:"_extractSGroup",value:function(r,i){if(Array.isArray(i)||(i=[]),r)if(Array.isArray(r))for(var s=r.length,o=0;o<s;o++)r[o].molecule&&(i=i.concat(this._extractSGroup(r[o].molecule))),this._createSGroup(r[o],i);else r.molecule&&r.molecule&&(i=i.concat(this._extractSGroup(r.molecule))),this._createSGroup(r,i);return i}},{key:"_extractSGroups",value:function(r,i){var s=this._extractSGroup(r),o=i.length,l,c;for(l=0;l<o;l++){var u=i[l].id;for(c=0;c<s.length;c++){var f=s[c]._atoms.split(" ")[0];f===u&&(i[l].sgroupRef||(i[l].sgroupRef=[]),i[l].sgroupRef.push(s[c]))}}var h={},d=null,p=1e8,v=new b(p,p,p),_=new b(-1e8,-1e8,-1e8);function m(x){d=h[x],d&&s[c]._atoms.push(d.a)}function g(x){d=h[x],d&&(v.set(Math.min(v.x,d.x),Math.min(v.y,d.y),Math.min(v.z,d.z)),_.set(Math.max(_.x,d.x),Math.max(_.y,d.y),Math.max(_.z,d.z)),m(x))}for(l=0;l<i.length;l++)h[i[l].id]={},h[i[l].id].x=i[l].x2,i[l].x3&&(h[i[l].id].x=i[l].x3),h[i[l].id].x=parseFloat(h[i[l].id].x),h[i[l].id].y=i[l].y2,i[l].y3&&(h[i[l].id].y=i[l].y3),h[i[l].id].y=parseFloat(h[i[l].id].y),h[i[l].id].z="0.0",i[l].z3&&(h[i[l].id].z=i[l].z3),h[i[l].id].z=parseFloat(h[i[l].id].z),h[i[l].id].a=i[l];var y;for(c=0;c<s.length;c++)s[c]._center!==null?(v.set(p,p,p),_.set(-1e8,-1e8,-1e8),y=s[c]._atoms.split(" "),s[c]._atoms=[],y.forEach(g),s[c]._center.addVectors(v,_),s[c]._center.multiplyScalar(.5)):(y=s[c]._atoms.split(" "),s[c]._atoms=[],y.forEach(m));h=null}},{key:"_traverseData",value:function(r){function i(l){return Object.prototype.toString.apply(l)==="[object Array]"}function s(l,c){if(!(l.nodeName==="#text"&&l.nodeValue.trim()==="")){var u={};u.xmlNode=l;var f=c[l.nodeName];f?i(f)?c[l.nodeName].push(u):c[l.nodeName]=[f,u]:c[l.nodeName]=u;var h,d;if(l.attributes)for(h=l.attributes.length,d=0;d<h;d++){var p=l.attributes[d];u[p.nodeName]=p.nodeValue}for(h=l.childNodes.length,d=0;d<h;d++)s(l.childNodes[d],u)}}var o={};return r.childNodes.length&&s(r.childNodes[0],o),o}},{key:"_findSuitableMolecule",value:function(r,i){for(var s in r)if(s!=="xmlNode")if(s==="molecule"){if(r.molecule&&(r.molecule.atomArray&&r.molecule.atomArray.atom&&i.push(r),Array.isArray(r.molecule)))for(var o=0;o<r.molecule.length;o++)r.molecule[o].atomArray&&r.molecule[o].atomArray.atom&&i.push({molecule:r.molecule[o]})}else r[s]&&r[s]!==null&&wn(r[s])==="object"&&this._findSuitableMolecule(r[s],i)}},{key:"_selectComponents",value:function(r){var i=new DOMParser,s=i.parseFromString(r,"application/xml"),o=this._traverseData(s),l,c=this;function u(d){var p=[];if(d.molecule&&d.molecule.atomArray&&d.molecule.atomArray.atom)Array.isArray(d.molecule.atomArray.atom)?p=d.molecule.atomArray.atom:p.push(d.molecule.atomArray.atom);else if(!d.molecule){var v={};return v.atomLabels=null,v.labelsCount=1,v}d.molecule.molecule&&c._extractSGroups(d.molecule.molecule,p);for(var _,m=p.length,g=0;g<m;g++)_=p[g],_.edges=[];var y=[];d.molecule.bondArray&&d.molecule.bondArray.bond&&(Array.isArray(d.molecule.bondArray.bond)?y=d.molecule.bondArray.bond:y.push(d.molecule.bondArray.bond));var x;m=y.length,c._rebuidBondIndexes(p,y);function S(z){return x=y[z],_=p[x.start],!_||(_.edges.push(x.end),_=p[x.end],!_)?!1:(_.edges.push(x.start),!0)}for(var M=0;M<m;M++)if(S(M)){var E=x.xmlNode.getAttribute("order"),N=parseInt(E,10);if(y[M].order=0,y[M].type=Jm.BondType.UNKNOWN,N>1)y[M].order=N;else{var B=_N[E];B!==void 0&&(y[M].order=B,E==="A"&&(y[M].type=Jm.BondType.AROMATIC))}}m=p.length;for(var V=0;V<m;V++)_=p[V],_.edges.sort();var O=c._breadWidthSearch(p,0),W={};return W.atoms=p,W.bonds=y,W.labels=O.atomLabels,W.count=Math.min(1,O.labelsCount),W.curr=-1,W.originalCML=s,W}o.cml?l=o.cml:l=o;var f=[],h=[];return this._findSuitableMolecule(l,h),this._readOnlyOneMolecule&&h.length>1&&h.splice(1,h.length-1),h.forEach(function(d){var p=u(d);p.atoms.length>0&&f.push(p)}),f}},{key:"_packLabel",value:function(r,i){var s=16;return(i<<s)+r}},{key:"_unpackLabel",value:function(r){var i=16,s=(1<<i)-1;return{molId:r>>>i,compId:r&s}}},{key:"_breadWidthSearch",value:function(r,i){var s=new Array(r.length),o;for(o=0;o<s.length;o++)s[o]=this._packLabel(0,i);for(var l=[],c=0,u=r.length;u>0;){c++;var f=-1;for(o=0;o<s.length;o++)if(this._unpackLabel(s[o]).compId===0){f=o;break}if(f<0)break;for(l.push(r[f]),s[f]=this._packLabel(c,i),u--;l.length>0;){var h=l.shift();if(h)for(var d=0;d<h.edges.length;d++)s[h.edges[d]]!==c&&(l.push(r[h.edges[d]]),s[h.edges[d]]=c,u--)}}var p={};return p.atomLabels=s,p.labelsCount=c,p}},{key:"_parseBond",value:function(r,i,s,o){if(r>=0){var l=[Math.min(r,i),Math.max(r,i)];this._complex.addBond(l[0],l[1],s,o,!0)}}},{key:"_fixBondsArray",value:function(){for(var r=this._serialAtomMap={},i=this._complex,s=i._atoms,o=0,l=s.length;o<l;++o){var c=s[o];r[c.serial]=c}for(var u=i._bonds,f=this.logger,h=0,d=u.length;h<d;++h){var p=u[h];p._right<p._left&&f.debug("_fixBondsArray: Logic error."),p._left=r[p._left]||null,p._right=r[p._right]||null}}},{key:"_parseSet",value:function(r){var i=this._complex=new ef,s=r,o=s.curr,l=s.atoms,c=s.labels,u=null,f,h,d=l.length;function p(ne){ne.xmlNodeRef=u,u.x2&&(u.x3=u.x2,delete u.x2),u.y2&&(u.y3=u.y2,delete u.y2),u.z3||(u.z3="0.0"),u.complexAtom=ne}var v={},_=[];for(f=0;f<d;f++)_.push(f);for(_.sort(function(ne,ae){return c[ne]-c[ae]}),f=0;f<d;f++){var m=0,g=c[_[f]];if(this._unpackLabel(g).molId===this._unpackLabel(o).molId){u=l[_[f]];var y=u.elementType;if(u.sgroupRef)for(var x=u.sgroupRef.length,S=0;S<x;++S)i._sgroups.push(u.sgroupRef[S]);if(u.x3||u.x2){var M=this._unpackLabel(g).compId,E=" ",N=M,B=" ",V=M.toString();V.length===1&&(V="0".concat(V));var O="N".concat(V),W=v[E];(!W||W.getName()!==E)&&(v[E]=W=this._complex.getChain(E)||this._complex.addChain(E),this._residue=null);var z=this._residue;(!z||z.getSequence()!==N||z.getICode()!==B)&&(this._residue=z=W.addResidue(O,N,B));var C=null;u.x3?C=new b(parseFloat(u.x3),parseFloat(u.y3),parseFloat(u.z3)):u.x2&&(C=new b(parseFloat(u.x2),parseFloat(u.y2),0));var T=Ba.ByName[u.elementType.toUpperCase()];T||(T=JSON.parse(JSON.stringify(Ba.ByName[Object.keys(Ba.ByName)[Object.keys(Ba.ByName).length-1]])),T.number+=1,T.name=u.elementType.toUpperCase(),T.fullName="Unknown",Ba.ByName[u.elementType.toUpperCase()]=T);var A=parseInt(u.id.replace(/[^0-9]/,""),10),F=z.addAtom(y,T,C,Ba.Role.SG,!0,A," ",1,0,m);u.hydrogenCount&&(F.hydrogenCount=parseInt(u.hydrogenCount,10)),u.mrvValence&&(F.valence=parseInt(u.mrvValence,10)),p(F)}}}for(v=null,f=0;f<s.bonds.length;f++){var X=s.bonds[f];if(this._unpackLabel(c[X.start]).molId===this._unpackLabel(o).molId&&this._unpackLabel(c[X.end]).molId===this._unpackLabel(o).molId){if(u=l[X.start],!u||!l[X.end])continue;this._parseBond(parseInt(u.id.replace(/[^0-9]/,""),10),parseInt(l[X.end].id.replace(/[^0-9]/,""),10),X.order,X.type)}}for(f=0;f<this._complex.getSGroupCount();f++){var Y=this._complex.getSGroups()[f];for(h=0;h<Y._atoms.length;h++)Y._atoms[h]=Y._atoms[h].complexAtom}for(f=0;f<d;f++)this._unpackLabel(c[f]).molId===this._unpackLabel(o).molId&&(u=l[f],u.complexAtom=null,delete u.complexAtom);return this._complex.originalCML=s.originalCML,this._fixBondsArray(),i.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._serialAtomMap=null,this._complex=null,i}},{key:"parseSync",value:function(){var r=[],i=this,s=this._selectComponents(this._data);s.forEach(function(c){c.curr=2,c.count===0&&(c.count=1);for(var u=0;u<c.count;u++)c.curr=u+1,r.push(i._parseSet(c,!1))});var o=0;if(r.forEach(function(c){o+=c.getAtomCount()}),o<=0)throw new Error("The data does not contain valid atoms");if(r.length>1){var l=new ef;return l.joinComplexes(r),l.originalCML=r[0].originalCML,l}return r.length===1?r[0]:new ef}}],[{key:"canProbablyParse",value:function(r){return le.isString(r)&&yN.test(r)}}]),t}(zr);Gh.formats=["cml"];Gh.extensions=[".cml"];var Gf={exports:{}};(function(a,e){(function(t,n){n(e)})(s_,function(t){function n(w,L,R){for(var j=(w.byteLength,0),U=R.length;U>j;j++){var me=R.charCodeAt(j);if(128>me)w.setUint8(L++,me>>>0&127|0);else if(2048>me)w.setUint8(L++,me>>>6&31|192),w.setUint8(L++,me>>>0&63|128);else if(65536>me)w.setUint8(L++,me>>>12&15|224),w.setUint8(L++,me>>>6&63|128),w.setUint8(L++,me>>>0&63|128);else{if(!(1114112>me))throw new Error("bad codepoint "+me);w.setUint8(L++,me>>>18&7|240),w.setUint8(L++,me>>>12&63|128),w.setUint8(L++,me>>>6&63|128),w.setUint8(L++,me>>>0&63|128)}}}function r(w){for(var L=0,R=0,j=w.length;j>R;R++){var U=w.charCodeAt(R);if(128>U)L+=1;else if(2048>U)L+=2;else if(65536>U)L+=3;else{if(!(1114112>U))throw new Error("bad codepoint "+U);L+=4}}return L}function i(w,L,R){var j=wn(w);if(j==="string"){var U=r(w);if(32>U)return L.setUint8(R,160|U),n(L,R+1,w),1+U;if(256>U)return L.setUint8(R,217),L.setUint8(R+1,U),n(L,R+2,w),2+U;if(65536>U)return L.setUint8(R,218),L.setUint16(R+1,U),n(L,R+3,w),3+U;if(4294967296>U)return L.setUint8(R,219),L.setUint32(R+1,U),n(L,R+5,w),5+U}if(w instanceof Uint8Array){var U=w.byteLength,me=new Uint8Array(L.buffer);if(256>U)return L.setUint8(R,196),L.setUint8(R+1,U),me.set(w,R+2),2+U;if(65536>U)return L.setUint8(R,197),L.setUint16(R+1,U),me.set(w,R+3),3+U;if(4294967296>U)return L.setUint8(R,198),L.setUint32(R+1,U),me.set(w,R+5),5+U}if(j==="number"){if(!isFinite(w))throw new Error("Number not finite: "+w);if(Math.floor(w)!==w)return L.setUint8(R,203),L.setFloat64(R+1,w),9;if(w>=0){if(128>w)return L.setUint8(R,w),1;if(256>w)return L.setUint8(R,204),L.setUint8(R+1,w),2;if(65536>w)return L.setUint8(R,205),L.setUint16(R+1,w),3;if(4294967296>w)return L.setUint8(R,206),L.setUint32(R+1,w),5;throw new Error("Number too big 0x"+w.toString(16))}if(w>=-32)return L.setInt8(R,w),1;if(w>=-128)return L.setUint8(R,208),L.setInt8(R+1,w),2;if(w>=-32768)return L.setUint8(R,209),L.setInt16(R+1,w),3;if(w>=-2147483648)return L.setUint8(R,210),L.setInt32(R+1,w),5;throw new Error("Number too small -0x"+(-w).toString(16).substr(1))}if(w===null)return L.setUint8(R,192),1;if(j==="boolean")return L.setUint8(R,w?195:194),1;if(j==="object"){var U,Ve=0,ye=Array.isArray(w);if(ye)U=w.length;else{var Ne=Object.keys(w);U=Ne.length}var Ve;if(16>U?(L.setUint8(R,U|(ye?144:128)),Ve=1):65536>U?(L.setUint8(R,ye?220:222),L.setUint16(R+1,U),Ve=3):4294967296>U&&(L.setUint8(R,ye?221:223),L.setUint32(R+1,U),Ve=5),ye)for(var Ie=0;U>Ie;Ie++)Ve+=i(w[Ie],L,R+Ve);else for(var Ie=0;U>Ie;Ie++){var et=Ne[Ie];Ve+=i(et,L,R+Ve),Ve+=i(w[et],L,R+Ve)}return Ve}throw new Error("Unknown type "+j)}function s(w){var L=wn(w);if(L==="string"){var R=r(w);if(32>R)return 1+R;if(256>R)return 2+R;if(65536>R)return 3+R;if(4294967296>R)return 5+R}if(w instanceof Uint8Array){var R=w.byteLength;if(256>R)return 2+R;if(65536>R)return 3+R;if(4294967296>R)return 5+R}if(L==="number"){if(Math.floor(w)!==w)return 9;if(w>=0){if(128>w)return 1;if(256>w)return 2;if(65536>w)return 3;if(4294967296>w)return 5;throw new Error("Number too big 0x"+w.toString(16))}if(w>=-32)return 1;if(w>=-128)return 2;if(w>=-32768)return 3;if(w>=-2147483648)return 5;throw new Error("Number too small -0x"+w.toString(16).substr(1))}if(L==="boolean"||w===null)return 1;if(L==="object"){var R,j=0;if(Array.isArray(w)){R=w.length;for(var U=0;R>U;U++)j+=s(w[U])}else{var me=Object.keys(w);R=me.length;for(var U=0;R>U;U++){var ye=me[U];j+=s(ye)+s(w[ye])}}if(16>R)return 1+j;if(65536>R)return 3+j;if(4294967296>R)return 5+j;throw new Error("Array or object too long 0x"+R.toString(16))}throw new Error("Unknown type "+L)}function o(w){var L=new ArrayBuffer(s(w)),R=new DataView(L);return i(w,R,0),new Uint8Array(L)}function l(w,L,R){return L?new w(L.buffer,L.byteOffset,L.byteLength/(R||1)):void 0}function c(w){return l(DataView,w)}function u(w){return l(Uint8Array,w)}function f(w){return l(Int8Array,w)}function h(w){return l(Int32Array,w,4)}function d(w){return l(Float32Array,w,4)}function p(w,L){var R=w.length/2;L||(L=new Int16Array(R));for(var j=0,U=0;R>j;++j,U+=2)L[j]=w[U]<<8^w[U+1]<<0;return L}function v(w,L){var R=w.length;L||(L=new Uint8Array(2*R));for(var j=c(L),U=0;R>U;++U)j.setInt16(2*U,w[U]);return u(L)}function _(w,L){var R=w.length/4;L||(L=new Int32Array(R));for(var j=0,U=0;R>j;++j,U+=4)L[j]=w[U]<<24^w[U+1]<<16^w[U+2]<<8^w[U+3]<<0;return L}function m(w,L){var R=w.length;L||(L=new Uint8Array(4*R));for(var j=c(L),U=0;R>U;++U)j.setInt32(4*U,w[U]);return u(L)}function g(w,L){var R=w.length;L||(L=new Float32Array(R/4));for(var j=c(L),U=c(w),me=0,ye=0,Ne=R/4;Ne>me;++me,ye+=4)j.setFloat32(ye,U.getFloat32(ye),!0);return L}function y(w,L,R){var j=w.length,U=1/L;R||(R=new Float32Array(j));for(var me=0;j>me;++me)R[me]=w[me]*U;return R}function x(w,L,R){var j=w.length;R||(R=new Int32Array(j));for(var U=0;j>U;++U)R[U]=Math.round(w[U]*L);return R}function S(w,L){var R,j;if(!L){var U=0;for(R=0,j=w.length;j>R;R+=2)U+=w[R+1];L=new w.constructor(U)}var me=0;for(R=0,j=w.length;j>R;R+=2)for(var ye=w[R],Ne=w[R+1],Ve=0;Ne>Ve;++Ve)L[me]=ye,++me;return L}function M(w){if(w.length===0)return new Int32Array;var L,R,j=2;for(L=1,R=w.length;R>L;++L)w[L-1]!==w[L]&&(j+=2);var U=new Int32Array(j),me=0,ye=1;for(L=1,R=w.length;R>L;++L)w[L-1]!==w[L]?(U[me]=w[L-1],U[me+1]=ye,ye=1,me+=2):++ye;return U[me]=w[w.length-1],U[me+1]=ye,U}function E(w,L){var R=w.length;L||(L=new w.constructor(R)),R&&(L[0]=w[0]);for(var j=1;R>j;++j)L[j]=w[j]+L[j-1];return L}function N(w,L){var R=w.length;L||(L=new w.constructor(R)),L[0]=w[0];for(var j=1;R>j;++j)L[j]=w[j]-w[j-1];return L}function B(w,L){var R,j,U=w instanceof Int8Array?127:32767,me=-U-1,ye=w.length;if(!L){var Ne=0;for(R=0;ye>R;++R)w[R]<U&&w[R]>me&&++Ne;L=new Int32Array(Ne)}for(R=0,j=0;ye>R;){for(var Ve=0;w[R]===U||w[R]===me;)Ve+=w[R],++R;Ve+=w[R],++R,L[j]=Ve,++j}return L}function V(w,L){var R,j=32767,U=-32768,me=w.length,ye=0;for(R=0;me>R;++R){var Ne=w[R];Ne===0?++ye:ye+=Ne===j||Ne===U?2:Ne>0?Math.ceil(Ne/j):Math.ceil(Ne/U)}var Ve=new Int16Array(ye),Ie=0;for(R=0;me>R;++R){var Ne=w[R];if(Ne>=0)for(;Ne>=j;)Ve[Ie]=j,++Ie,Ne-=j;else for(;U>=Ne;)Ve[Ie]=U,++Ie,Ne-=U;Ve[Ie]=Ne,++Ie}return Ve}function O(w,L){return E(S(w),L)}function W(w){return M(N(w))}function z(w,L,R){return y(S(w,h(R)),L,R)}function C(w,L){return M(x(w,L))}function T(w,L,R){return y(E(w,h(R)),L,R)}function A(w,L,R){return N(x(w,L),R)}function F(w,L,R){return y(B(w,h(R)),L,R)}function X(w,L,R){var j=B(w,h(R));return T(j,L,d(j))}function Y(w,L,R){return V(A(w,L))}function ne(me){var L=c(me),R=L.getInt32(0),j=L.getInt32(4),U=me.subarray(8,12),me=me.subarray(12);return[R,me,j,U]}function ae(w,L,R,j){var U=new ArrayBuffer(12+j.byteLength),me=new Uint8Array(U),ye=new DataView(U);return ye.setInt32(0,w),ye.setInt32(4,L),R&&me.set(R,8),me.set(j,12),me}function xe(w){var L=w.length,R=u(w);return ae(2,L,void 0,R)}function be(w){var L=w.length,R=m(w);return ae(4,L,void 0,R)}function ge(w,L){var R=w.length/L,j=m([L]),U=u(w);return ae(5,R,j,U)}function we(w){var L=w.length,R=m(M(w));return ae(6,L,void 0,R)}function q(w){var L=w.length,R=m(W(w));return ae(8,L,void 0,R)}function Ge(w,L){var R=w.length,j=m([L]),U=m(C(w,L));return ae(9,R,j,U)}function Te(w,L){var R=w.length,j=m([L]),U=v(Y(w,L));return ae(10,R,j,U)}function Pe(w){var L={};return pe.forEach(function(R){w[R]!==void 0&&(L[R]=w[R])}),w.bondAtomList&&(L.bondAtomList=be(w.bondAtomList)),w.bondOrderList&&(L.bondOrderList=xe(w.bondOrderList)),L.xCoordList=Te(w.xCoordList,1e3),L.yCoordList=Te(w.yCoordList,1e3),L.zCoordList=Te(w.zCoordList,1e3),w.bFactorList&&(L.bFactorList=Te(w.bFactorList,100)),w.atomIdList&&(L.atomIdList=q(w.atomIdList)),w.altLocList&&(L.altLocList=we(w.altLocList)),w.occupancyList&&(L.occupancyList=Ge(w.occupancyList,100)),L.groupIdList=q(w.groupIdList),L.groupTypeList=be(w.groupTypeList),w.secStructList&&(L.secStructList=xe(w.secStructList)),w.insCodeList&&(L.insCodeList=we(w.insCodeList)),w.sequenceIndexList&&(L.sequenceIndexList=q(w.sequenceIndexList)),L.chainIdList=ge(w.chainIdList,4),w.chainNameList&&(L.chainNameList=ge(w.chainNameList,4)),L}function Ee(w){function L(Ve){for(var Ie={},et=0;Ve>et;et++){var gt=me();Ie[gt]=me()}return Ie}function R(Ve){var Ie=w.subarray(ye,ye+Ve);return ye+=Ve,Ie}function j(Ve){var Ie=w.subarray(ye,ye+Ve);ye+=Ve;var et=65535;if(Ve>et){for(var gt=[],Mt=0;Mt<Ie.length;Mt+=et)gt.push(String.fromCharCode.apply(null,Ie.subarray(Mt,Mt+et)));return gt.join("")}return String.fromCharCode.apply(null,Ie)}function U(Ve){for(var Ie=new Array(Ve),et=0;Ve>et;et++)Ie[et]=me();return Ie}function me(){var Ve,Ie,et=w[ye];if(!(128&et))return ye++,et;if((240&et)===128)return Ie=15&et,ye++,L(Ie);if((240&et)===144)return Ie=15&et,ye++,U(Ie);if((224&et)===160)return Ie=31&et,ye++,j(Ie);if((224&et)===224)return Ve=Ne.getInt8(ye),ye++,Ve;switch(et){case 192:return ye++,null;case 194:return ye++,!1;case 195:return ye++,!0;case 196:return Ie=Ne.getUint8(ye+1),ye+=2,R(Ie);case 197:return Ie=Ne.getUint16(ye+1),ye+=3,R(Ie);case 198:return Ie=Ne.getUint32(ye+1),ye+=5,R(Ie);case 202:return Ve=Ne.getFloat32(ye+1),ye+=5,Ve;case 203:return Ve=Ne.getFloat64(ye+1),ye+=9,Ve;case 204:return Ve=w[ye+1],ye+=2,Ve;case 205:return Ve=Ne.getUint16(ye+1),ye+=3,Ve;case 206:return Ve=Ne.getUint32(ye+1),ye+=5,Ve;case 208:return Ve=Ne.getInt8(ye+1),ye+=2,Ve;case 209:return Ve=Ne.getInt16(ye+1),ye+=3,Ve;case 210:return Ve=Ne.getInt32(ye+1),ye+=5,Ve;case 217:return Ie=Ne.getUint8(ye+1),ye+=2,j(Ie);case 218:return Ie=Ne.getUint16(ye+1),ye+=3,j(Ie);case 219:return Ie=Ne.getUint32(ye+1),ye+=5,j(Ie);case 220:return Ie=Ne.getUint16(ye+1),ye+=3,U(Ie);case 221:return Ie=Ne.getUint32(ye+1),ye+=5,U(Ie);case 222:return Ie=Ne.getUint16(ye+1),ye+=3,L(Ie);case 223:return Ie=Ne.getUint32(ye+1),ye+=5,L(Ie)}throw new Error("Unknown type 0x"+et.toString(16))}var ye=0,Ne=new DataView(w.buffer);return me()}function _e(w,L,R,j){switch(w){case 1:return g(L);case 2:return f(L);case 3:return p(L);case 4:return _(L);case 5:return u(L);case 6:return S(_(L),new Uint8Array(R));case 7:return S(_(L));case 8:return O(_(L));case 9:return z(_(L),_(j)[0]);case 10:return X(p(L),_(j)[0]);case 11:return y(p(L),_(j)[0]);case 12:return F(p(L),_(j)[0]);case 13:return F(f(L),_(j)[0]);case 14:return B(p(L));case 15:return B(f(L))}}function ie(w,L){L=L||{};var R=L.ignoreFields,j={};return Re.forEach(function(U){var me=R?R.indexOf(U)!==-1:!1,ye=w[U];me||ye===void 0||(ye instanceof Uint8Array?j[U]=_e.apply(null,ne(ye)):j[U]=ye)}),j}function oe(w){return String.fromCharCode.apply(null,w).replace(/\0/g,"")}function K(w,L,R){R=R||{};var j,U,me,ye,Ne,Ve,Ie=R.firstModelOnly,et=L.onModel,gt=L.onChain,Mt=L.onGroup,ot=L.onAtom,Fe=L.onBond,Xe=0,$=0,nt=0,Z=0,ut=0,ce=-1,_t=w.chainNameList,Ct=w.secStructList,Hr=w.insCodeList,Wr=w.sequenceIndexList,or=w.atomIdList,k=w.bFactorList,te=w.altLocList,J=w.occupancyList,se=w.bondAtomList,Ae=w.bondOrderList;for(j=0,U=w.chainsPerModel.length;U>j&&!(Ie&&Xe>0);++j){var Qe=w.chainsPerModel[Xe];for(et&&et({chainCount:Qe,modelIndex:Xe}),me=0;Qe>me;++me){var je=w.groupsPerChain[$];if(gt){var We=oe(w.chainIdList.subarray(4*$,4*$+4)),$e=null;_t&&($e=oe(_t.subarray(4*$,4*$+4))),gt({groupCount:je,chainIndex:$,modelIndex:Xe,chainId:We,chainName:$e})}for(ye=0;je>ye;++ye){var tt=w.groupList[w.groupTypeList[nt]],Ke=tt.atomNameList.length;if(Mt){var it=null;Ct&&(it=Ct[nt]);var Ye=null;w.insCodeList&&(Ye=String.fromCharCode(Hr[nt]));var lr=null;Wr&&(lr=Wr[nt]),Mt({atomCount:Ke,groupIndex:nt,chainIndex:$,modelIndex:Xe,groupId:w.groupIdList[nt],groupType:w.groupTypeList[nt],groupName:tt.groupName,singleLetterCode:tt.singleLetterCode,chemCompType:tt.chemCompType,secStruct:it,insCode:Ye,sequenceIndex:lr})}for(Ne=0;Ke>Ne;++Ne){if(ot){var vt=null;or&&(vt=or[Z]);var cr=null;k&&(cr=k[Z]);var At=null;te&&(At=String.fromCharCode(te[Z]));var pn=null;J&&(pn=J[Z]),ot({atomIndex:Z,groupIndex:nt,chainIndex:$,modelIndex:Xe,atomId:vt,element:tt.elementList[Ne],atomName:tt.atomNameList[Ne],formalCharge:tt.formalChargeList[Ne],xCoord:w.xCoordList[Z],yCoord:w.yCoordList[Z],zCoord:w.zCoordList[Z],bFactor:cr,altLoc:At,occupancy:pn})}Z+=1}if(Fe){var Jr=tt.bondAtomList;for(Ne=0,Ve=tt.bondOrderList.length;Ve>Ne;++Ne)Fe({atomIndex1:Z-Ke+Jr[2*Ne],atomIndex2:Z-Ke+Jr[2*Ne+1],bondOrder:tt.bondOrderList[Ne]})}nt+=1}$+=1}if(ut=ce+1,ce=Z-1,Fe&&se)for(Ne=0,Ve=se.length;Ve>Ne;Ne+=2){var Ot=se[Ne],_r=se[Ne+1];(Ot>=ut&&ce>=Ot||_r>=ut&&ce>=_r)&&Fe({atomIndex1:Ot,atomIndex2:_r,bondOrder:Ae?Ae[Ne/2]:null})}Xe+=1}}function de(w){return o(Pe(w))}function he(w,L){w instanceof ArrayBuffer&&(w=new Uint8Array(w));var R;return R=w instanceof Uint8Array?Ee(w):w,ie(R,L)}function I(w,L,R,j){function U(){try{var ye=he(me.response);R(ye)}catch(Ne){j(Ne)}}var me=new XMLHttpRequest;me.addEventListener("load",U,!0),me.addEventListener("error",j,!0),me.responseType="arraybuffer",me.open("GET",L+w.toUpperCase()),me.send()}function P(w,L,R){I(w,ke,L,R)}function ee(w,L,R){I(w,De,L,R)}var pe=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],Me=["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],Re=pe.concat(Me),He="v1.1.0dev",Oe="//mmtf.rcsb.org/v1.0/",ke=Oe+"full/",De=Oe+"reduced/";t.encode=de,t.decode=he,t.traverse=K,t.fetch=P,t.fetchReduced=ee,t.version=He,t.fetchUrl=ke,t.fetchReducedUrl=De,t.encodeMsgpack=o,t.encodeMmtf=Pe,t.decodeMsgpack=Ee,t.decodeMmtf=ie})})(Gf,Gf.exports);var Qm=Gf.exports;function xN(a){var e=SN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function SN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var bN=qe.Complex,wN=qe.Chain,MN=qe.Atom,ev=qe.Element,EN=qe.Helix,CN=qe.Sheet,AN=qe.Strand,TN=qe.Bond,RN=qe.Assembly,LN=qe.Molecule,Hf=function(){function a(e){G(this,a),this._original=Array.from(e),this._original.sort(),this._sum=0;for(var t=0;t<this._original.length;++t)this._sum+=this._original[t]}return H(a,[{key:"compare",value:function(t){var n=t.length;if(n!==this._original.length)return!1;var r=0,i;for(i=0;i<n;++i)r+=t[i];if(r!==this._sum)return!1;var s=Array.from(t);for(s.sort(),i=0;i<n;++i)if(s[i]!==this._original[i])return!1;return!0}}]),a}();Hf.prototype.constructor=Hf;var oi=qt.Type,PN=[oi.HELIX_PI,oi.BEND,oi.HELIX_ALPHA,oi.STRAND,oi.HELIX_310,oi.BRIDGE,oi.TURN,oi.COIL];function NN(a){var e=new Uint8Array(a,0,1);return e[0]}var Uc=function(a){re(t,a);var e=xN(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._options.fileType="mmtf",i}return H(t,[{key:"_onModel",value:function(r){}},{key:"_onChain",value:function(r){if(r.modelIndex===0){var i=new wN(this._complex,r.chainName);this._complex._chains[r.chainIndex]=i,i._index=r.chainIndex}}},{key:"_onGroup",value:function(r){if(r.modelIndex===0&&!(this.settings.now.nowater&&(r.groupName==="HOH"||r.groupName==="WAT"))){var i=this._complex._chains[r.chainIndex],s=r.insCode.charCodeAt(0)?r.insCode:"",o=i.addResidue(r.groupName,r.groupId,s);o._index=r.groupIndex,this._updateSecStructure(this._complex,o,r)}}},{key:"_onAtom",value:function(r){if(r.modelIndex===0){var i=r.altLoc.charCodeAt(0)?r.altLoc:"",s=new MN(r.groupIndex,r.atomName,ev.getByName(r.element.toUpperCase()),new b(r.xCoord,r.yCoord,r.zCoord),ev.Role[r.atomName],!1,r.atomId,i,r.occupancy,r.bFactor,r.formalCharge);this._complex._atoms[r.atomIndex]=s,s.index=r.atomIndex,this._serialAtomMap[r.atomId]=s}}},{key:"_onBond",value:function(r){var i=Math.max(r.atomIndex1,r.atomIndex2);if(!(i>=this._complex._atoms.length)){var s=Math.min(r.atomIndex1,r.atomIndex2);this._complex.addBond(this._complex._atoms[s],this._complex._atoms[i],r.bondOrder,TN.BondType.UNKNOWN,!0)}}},{key:"_updateSecStructure",value:function(r,i,s){var o=[3,-1,1,-1,5];if(!le.isUndefined(s)&&s.secStruct===this._ssType){i._secondary=this._ssStruct,this._ssStruct&&(this._ssStruct.term=i);return}if(!le.isUndefined(s)){var l=PN[s.secStruct];this._ssType=s.secStruct,this._ssStart=i;var c=null;switch(this._ssType){case-1:case 7:break;case 0:case 2:case 4:c=new EN(o[this._ssType],i,i,0,"","",0),r._helices.push(c);break;case 3:{var u=new CN("",0);r._sheets.push(u),c=new AN(u,i,i,0,null,null);break}default:l!==void 0&&(c=new qt(l,i,i));break}this._ssStruct=c,i._secondary=c,c&&r.structures.push(c)}}},{key:"_updateMolecules",value:function(r){var i=r.entityList;if(i)for(var s=r.chainsPerModel[0],o=0;o<i.length;o++){for(var l=i[o],c=l.chainIndexList,u=[],f=0;f<c.length;f++){var h=c[f];if(!(h>=s)){var d=this._complex._chains[h];u=u.concat(d._residues.slice())}}var p=new LN(this._complex,l.description,o+1);p.residues=u,this._complex._molecules[o]=p}}},{key:"_traverse",value:function(r){var i=this,s=this._complex.metadata;s.id=r.structureId,s.title=[],s.title[0]=r.title,s.date=r.releaseDate,s.format="mmtf";var o={onModel:function(c){i._onModel(c)},onChain:function(c){i._onChain(c)},onGroup:function(c){i._onGroup(c)},onAtom:function(c){i._onAtom(c)},onBond:function(c){i._onBond(c)}};this._ssType=-1,this._ssStruct=null,this._ssStart=null,Qm.traverse(r,o),this._updateSecStructure(this._complex),this._updateMolecules(r)}},{key:"_linkAtomsToResidues",value:function(){for(var r=0;r<this._complex._atoms.length;++r){var i=this._complex._atoms[r],s=this._complex._residues[i.residue];i.residue=s,s._atoms.push(i)}}},{key:"_findSynonymousChains",value:function(){for(var r={},i=0;i<this._complex._chains.length;++i){var s=this._complex._chains[i],o=s.getName();r.hasOwnProperty(o)||(r[o]=[]),r[o].push(s._index)}return r}},{key:"_parseAssemblyInfo",value:function(r){var i,s,o,l=[],c=this.logger;for(i=0;i<r.bioAssemblyList.length;++i){var u=r.bioAssemblyList[i];if(u.transformList.length!==0){var f=u.transformList[0].chainIndexList,h=new Hf(f),d={};for(s=0;s<f.length;++s)d[this._complex._chains[f[s]].getName()]=1;var p=[],v=void 0;for(v in d)d.hasOwnProperty(v)&&Array.prototype.push.apply(p,this._chainsByName[v]);h.compare(p)||c.debug("MMTF: Assembly is missing some of the synonymous chains. Skipping...");var _=new RN(this._complex);for(v in d)d.hasOwnProperty(v)&&_.addChain(v);for(_.addMatrix(new Ce().fromArray(u.transformList[0].matrix).transpose()),s=1;s<u.transformList.length;++s){var m=u.transformList[s];if(!h.compare(m.chainIndexList)){c.debug("MMTF: Chain lists differ for different transforms in one assembly. Skipping...");continue}var g=new Ce().fromArray(m.matrix).transpose();for(o=0;o<_.matrices.length&&!_.matrices[o].equals(g);++o);o===_.matrices.length&&_.addMatrix(g)}_.finalize(),l.push(_)}}return l}},{key:"_markHeteroAtoms",value:function(r){for(var i=r.chainsPerModel[0],s=0;s<r.entityList.length;++s){var o=r.entityList[s];if(o.type!=="polymer")for(var l=0;l<o.chainIndexList.length;++l){var c=o.chainIndexList[l];if(!(c>=i))for(var u=this._complex._chains[c],f=0;f<u._residues.length;++f)for(var h=u._residues[f],d=0;d<h._atoms.length;++d)h._atoms[d].het=!0}}}},{key:"_joinSynonymousChains",value:function(){var r,i,s=[],o={};for(r=0;r<this._complex._chains.length;++r){var l=this._complex._chains[r],c=l.getName();if(!o.hasOwnProperty(c)){o[c]=l,l._index=s.length,s.push(l);continue}var u=o[c];for(i=0;i<l._residues.length;++i){var f=l._residues[i];u._residues.push(f),f._chain=u}}this._complex._chains=s}},{key:"parseSync",value:function(){var r=Qm.decode(this._data);return this._complex=new bN,this._serialAtomMap={},this._traverse(r),this._linkAtomsToResidues(),this._markHeteroAtoms(r),this._chainsByName=this._findSynonymousChains(),Array.prototype.push.apply(this._complex.units,this._parseAssemblyInfo(r)),this._joinSynonymousChains(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex}}],[{key:"canProbablyParse",value:function(r){return le.isArrayBuffer(r)&&(NN(r)|1)===223}}]),t}(zr);Uc.formats=["mmtf"];Uc.extensions=[".mmtf"];Uc.binary=!0;function IN(a){var e=kN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function kN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var nn=function(a){re(t,a);var e=IN(t);function t(n,r,i){var s;return G(this,t),s=e.call(this,"data:".concat(r,":").concat(i,": ").concat(n)),Error.captureStackTrace&&Error.captureStackTrace(qr(s),t),s.name="ParsingError",s.parseLine=r,s.parseColumn=i,s}return H(t)}(mo(Error));function Fi(a){return a===32||a===10||a===13||a===9}function tf(a,e,t){for(var n=e.length,r=-1;t<n&&(r=e.charCodeAt(t),!(r===a||r===10));)++t;return r===a?t:-1}function ON(a){var e=0,t=0,n=a.length,r=NaN,i=!0,s=1,o=1,l,c=0,u={},f={},h=[],d=0,p="",v=[],_=0,m;function g(){var M;if((r===46||r===63)&&(e+1>=n||Fi(a.charCodeAt(e+1)))){++o,++e;return}if(i&&r===59){t=e;var E=0;do{if(t=tf(10,a,t+1),t===-1)throw new nn("Unterminated text block found",s,o);++E}while(t+1<n&&a.charCodeAt(t+1)!==r||t+1>=n);return M=a.substring(e+1,t).replace(/\r/g,""),e=t+2,s+=E,o=1,i=!1,M}if(r===39||r===34){t=e;do if(t=tf(r,a,t+1),t===-1)throw new nn("Unterminated quoted string found",s,o);while(t+1<n&&!Fi(a.charCodeAt(t+1)));return M=a.substring(e+1,t),o+=t-e+1,e=t+1,M}for(t=e;t<n&&!Fi(a.charCodeAt(t));)++t;M=a.substring(e,t),o+=t-e,e=t;var N=Number(M);return Number.isNaN(N)?M:N}function y(M){h[d++]=M}function x(M){var E=_%d;return v[E].push(M),++_,M}for(;e<=n;){if(r=a.charCodeAt(e),r!==13)if(r===10)i=!0,++s,o=1;else{if(!(r===32||r===9))if(r===35){if(e=tf(10,a,e+1),e===-1)break;continue}else if(c===0)if((r===68||r===100)&&a.substr(e+1,4).toLowerCase()==="ata_"){for(t=e+5,l=t;t<n&&!Fi(a.charCodeAt(t));)++t;if(o+=t-e,e=t,l<e){u[a.substring(l,e)]=f={},c=1;continue}else throw new nn("Data block name missing",s,o)}else{if(Number.isNaN(r))break;throw new nn("Unexpected character in state ".concat(c),s,o)}else if(c===1)if((r===68||r===100)&&a.substr(e+1,4).toLowerCase()==="ata_"){c=0;continue}else if(r===95){for(t=e+1,l=t;t<n&&!Fi(a.charCodeAt(t));)++t;if(o+=t-e,e=t,l<e){p=a.substring(l,e),c=2;continue}else throw new nn("Tag name missing",s,o)}else if((r===76||r===108)&&a.substr(e+1,4).toLowerCase()==="oop_"){if(e+=5,o+=5,e<n&&!Fi(a.charCodeAt(e)))throw new nn("Unexpected character in state ".concat(c),s,o);h=[],d=0,v=[],_=0,c=3;continue}else{if(Number.isNaN(r))break;throw new nn("Unexpected character in state ".concat(c),s,o)}else if(c===2){if(Number.isNaN(r))break;m=g(),le.set(f,p,m),c=1;continue}else if(c===3)if(r===95){for(t=e+1,l=t;t<n&&!Fi(a.charCodeAt(t));)++t;if(o+=t-e,e=t,l<e){y(a.substring(l,e));continue}else throw new nn("Tag name missing",s,o)}else{if(d>0){for(var S=0;S<d;++S)m=[],v[S]=m,le.set(f,h[S],m);c=4;continue}throw new nn("Data tags are missing inside a loop",s,o)}else if(c===4){(r===68||r===100)&&a.substr(e+1,4).toLowerCase()==="ata_"?c=0:r===95||(r===76||r===108)&&a.substr(e+1,4).toLowerCase()==="oop_"?c=1:Number.isNaN(r)?c=0:x(g());continue}else throw new nn("Unexpected internal state ".concat(c),s,o);i=!1,++o}++e}if(c===2)throw new nn("Unexpected end of file in state ".concat(c),s,o);return u}function t0(a){var e=DN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function DN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var FN=qe.Complex,tv=qe.Element,BN=qe.Helix,zN=qe.Sheet,VN=qe.Strand,UN=qe.Assembly,GN=qe.Molecule,rf=["auth_seq_id","Cartn_x","Cartn_y","Cartn_z","label_atom_id"],HN={helx:"helix",turn:"turn",strn:"strand"};function WN(a){var e=/[A-Za-z]+/.exec(a);return e?HN[e[0].toLowerCase()]:null}function rt(a){return a==null||le.isArray(a)?a:[a]}function XN(a){var e=a.trim().length===4;return a.slice(0,e?1:2).trim()}var rv=function(a){re(t,a);var e=t0(t);function t(n){var r;return G(this,t),r=e.call(this),r.name="AtomDataError",r.message=n,r}return H(t)}(mo(Error));function jN(a){if(!a)return null;var e=rt(a.id),t=a.matrix,n=a.vector;if(!e||!t||!n)return null;for(var r=[],i=0,s=e.length;i<s;++i){for(var o=new Ce,l=o.elements,c=0;c<3;++c){var u=t[c+1];l[c]=rt(u[1])[i],l[c+4]=rt(u[2])[i],l[c+8]=rt(u[3])[i],l[c+12]=rt(n[c+1])[i]}r[e[i]]=o}return r}function YN(a,e){a=le.isString(a)?a:"".concat(a);for(var t=a.replace(/\)\s*\(/g,"!").replace(/[()']/g,""),n=t.split("!"),r=[],i=0,s=n.length;i<s;++i){for(var o=n[i].split(","),l=[],c=0,u=0,f=o.length;u<f;++u){var h=o[u];if(h.includes("-"))for(var d=h.split("-"),p=parseInt(d[0],10),v=parseInt(d[1],10);p<=v;++p)l[c++]=e[p];else l[c++]=e[h]}r.push(l)}var _=[],m=0;function g(y,x){for(var S=0,M=r[y].length;S<M;++S){var E=x?x.clone():new Ce;E.multiplyMatrices(r[y][S],E),y===0?_[m++]=E:g(y-1,E)}}return g(r.length-1),_}var Hh=function(a){re(t,a);var e=t0(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i.asymDict={},i.molecules=[],i._options.fileType="cif",i}return H(t,[{key:"parseSync",value:function(){this.logger.info("Parsing CIF file..");var r=ON(this._data);return this._toComplex(r)}},{key:"_toComplex",value:function(r){var i=new FN,s=r[Object.keys(r)[0]];return this._extractAtoms(i,s),this._extractSecondary(i,s),this._extractAssemblies(i,s),this._extractMolecules(i,s),this._extractMetadata(i,s),i.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing}),i}},{key:"_extractMetadata",value:function(r,i){var s=r.metadata;s.id=i.entry.id,s.classification=i.struct_keywords.pdbx_keywords;var o=i.database_PDB_rev;s.date=o&&o.date_original?o.date_original:"",s.format="cif",s.title=[],s.title[0]=i.struct.title}},{key:"_extractMolecules",value:function(r,i){var s=i.entity,o=rt(s.pdbx_description),l=o.length,c;for(c=0;c<l;c++)this.molecules[c]?this.molecules[c].name=o[c]:this.molecules[c]={name:o[c],residues:[]};var u=r.getMolecules();for(c=0;c<l;c++){var f=this.molecules[c];u[c]=new GN(r,f.name,c+1),u[c].residues=f.residues}}},{key:"_extractAtoms",value:function(r,i){var s=i.atom_site;if(!s)throw new rv("CIF parsing error: atom_site is not specified!");for(var o=0,l=rf.length;o<l;++o)if(!s[rf[o]])throw new rv("CIF parsing error: requires field ".concat(rf[o]," not found!"));for(var c=this.asymDict,u=rt(s.auth_seq_id),f=rt(s.Cartn_x),h=rt(s.Cartn_y),d=rt(s.Cartn_z),p=rt(s.label_atom_id),v=p.length,_=rt(s.group_PDB)||[],m=rt(s.auth_asym_id)||[],g=rt(s.label_asym_id)||[],y=rt(s.id)||[],x=rt(s.pdbx_PDB_ins_code)||[],S=rt(s.label_comp_id)||[],M=rt(s.type_symbol)||[],E=rt(s.B_iso_or_equiv)||[],N=rt(s.occupancy)||[],B=rt(s.pdbx_formal_charge)||[],V=rt(s.label_alt_id)||[],O=rt(s.pdbx_PDB_model_num)||[],W=rt(s.label_entity_id)||[],z=null,C=null,T=0;T<v;++T){var A=O[T]||1;if(A===1){var F=String(m[T]||" ");(!z||z.getName()!==F)&&(z=r.getChain(F)||r.addChain(F)),c[String(g[T]||" ")]=F;var X=u[T],Y=String(x[T]||" "),ne=String(S[T]||"");if(!C||C.getSequence()!==X||C.getICode()!==Y){C=z.addResidue(ne,X,Y);var ae=W[T]-1,xe=this.molecules[ae];xe||(this.molecules[ae]={name:"",residues:[]},xe=this.molecules[ae]),xe.residues.push(C)}var be=p[T],ge=M[T]||XN(be),we=tv.getByName(ge),q=tv.Role[be.trim()],Ge=new b(f[T],h[T],d[T]),Te=_[T]==="HETATM"||!1,Pe=y[T]||T,Ee=E[T]||0,_e=N[T]||0,ie=String(V[T]||""),oe=B[T]||0;C.addAtom(be,we,Ge,q,Te,Pe,ie,_e,Ee,oe)}}}},{key:"_extractSecondary",value:function(r,i){i.struct_conf&&this._extractConfs(r,i.struct_conf),i.struct_sheet_range&&this._extractSheets(r,i.struct_sheet_range)}},{key:"_extractSheets",value:function(r,i){var s=this.asymDict;if(!i.sheet_id||!i.id||!i.beg_label_seq_id||!i.end_label_seq_id||!i.beg_label_asym_id)return;var o=r._sheets;function l(z){for(var C=o.length,T=0;T<C;++T)if(o[T]._name===z)return o[T];return o[C]=new zN(z,0),o[C]}for(var c=rt(i.sheet_id),u=rt(i.id),f=rt(i.beg_auth_seq_id),h=rt(i.end_auth_seq_id),d=rt(i.beg_label_asym_id),p=rt(i.pdbx_beg_PDB_ins_code)||[],v=rt(i.pdbx_end_PDB_ins_code)||[],_=0,m=u.length;_<m;++_){var g=r.getChain(s[d[_]]),y=l(c[_]),x=f[_],S=h[_],M=p[_]||" ",E=v[_]||" ",N=g.findResidue(x,M),B=g.findResidue(S,E);if(!(!N||!B)){for(var V=new VN(y,N[0],B[0],0,null,null),O=g.getResidues(),W=N[1];W<=B[1];++W)O[W]._secondary=V;y.addStrand(V),r.structures.push(V)}}}},{key:"_extractConfs",value:function(r,i){var s=this.asymDict;if(!(!i.conf_type_id||!i.beg_label_seq_id||!i.end_label_seq_id||!i.beg_label_asym_id))for(var o=rt(i.conf_type_id),l=rt(i.beg_auth_seq_id),c=rt(i.pdbx_beg_PDB_ins_code)||[],u=rt(i.end_auth_seq_id),f=rt(i.pdbx_end_PDB_ins_code)||[],h=rt(i.details)||[],d=rt(i.pdbx_PDB_helix_length)||[],p=rt(i.pdbx_PDB_helix_class)||[],v=rt(i.id)||[],_=rt(i.beg_label_asym_id),m=0,g=o.length;m<g;++m){var y=WN(o[m]);if(y){var x=v[m]||o[m],S=r.getChain(s[_[m]]),M=l[m],E=u[m],N=c[m]||" ",B=f[m]||" ",V=S.findResidue(M,N),O=S.findResidue(E,B);if(!(!V||!O)){var W=h[m]||"",z=d[m]||0,C=p[m]||" ",T=void 0;if(y==="helix"){var A=r._helices.length;T=new BN(C,V[0],O[0],A,x,W,z),r.addHelix(T),r.structures.push(T)}else y==="turn"?(T=new qt(qt.Type.TURN,V[0],O[0]),r.structures.push(T)):T=null;if(T)for(var F=S.getResidues(),X=V[1];X<=O[1];++X)F[X]._secondary=T}}}}},{key:"_extractAssemblies",value:function(r,i){var s=this.asymDict,o=i.pdbx_struct_assembly_gen;if(o){var l=rt(o.assembly_id),c=rt(o.oper_expression),u=rt(o.asym_id_list);if(!(!l||!c||!u)){var f=jN(i.pdbx_struct_oper_list);if(f)for(var h=0,d=l.length;h<d;++h){for(var p=new UN(r),v=YN(c[h],f),_=u[h].split(","),m=0,g=_.length;m<g;++m){var y=_[m].trim();y.length>0&&p.addChain(s[y])}p.matrices=v,r.units.push(p)}}}}}],[{key:"canProbablyParse",value:function(r){return le.isString(r)&&/^\s*data_/i.test(r)}}]),t}(zr);Hh.formats=["cif","mmcif"];Hh.extensions=[".cif",".mmcif"];var dt={singular:0,vector:1,array:2,buffer:3},r0=function(){function a(){G(this,a),Le(this,"_xyz2crs",[]),Le(this,"_origin",new b(0,0,0)),this._header={},this._boxSize=new b,this._boxStart=new b,this._header.delta={},this._header.extent=[],this._header.nstart=[],this._header.grid=[],this._header.crs2xyz=[],this._header.cellDims=new b,this._header.angles=[],this._header.origin=new b(0,0,0),this._header.dmin=0,this._header.dmean=0,this._header.dmax=0}return H(a,[{key:"_typedCheck",value:function(){if(le.isTypedArray(this._buff))this._buff=this._buff.buffer;else if(!le.isArrayBuffer(this._buff))throw new TypeError("Expected ArrayBuffer or TypedArray")}},{key:"_fillHeader",value:function(t,n){for(var r in t)if(t.hasOwnProperty(r))switch(t[r][0]){case dt.singular:this._header[r]=n[t[r][1]][t[r][2]];break;case dt.array:this._parseArray(this._header[r],n[t[r][1]],t[r][2]);break;case dt.vector:this._parseVector(this._header[r],n[t[r][1]],t[r][2]);break;case dt.buffer:this._header[r]=new Uint8Array(n[t[r][1]],[t[r][2]]*4,[t[r][3]]*4);break}}},{key:"_parseVector",value:function(t,n,r){var i=[n[r],n[r+1],n[r+2]];t.x=i[0],t.y=i[1],t.z=i[2]}},{key:"_parseArray",value:function(t,n,r){t[0]=n[r],t[1]=n[r+1],t[2]=n[r+2]}},{key:"_parseHeader",value:function(t){}},{key:"_setAxisIndices",value:function(){}},{key:"_setOrigins",value:function(){}},{key:"_getAxis",value:function(){var t=this._header,n=t.cellDims.x/t.grid[0],r=t.cellDims.y/t.grid[1],i=t.cellDims.z/t.grid[2],s=Lt(t.angles,3),o=s[0],l=s[1],c=s[2],u=Math.cos(l),f=(Math.cos(o)-Math.cos(l)*Math.cos(c))/Math.sin(c),h=Math.sqrt(1-u*u-f*f),d=new b(n,0,0),p=new b(Math.cos(c)*r,Math.sin(c)*r,0),v=new b(u*i,f*i,h*i);return[d,p,v]}},{key:"_getXYZdim",value:function(){return[this._header.extent[this._xyz2crs[0]],this._header.extent[this._xyz2crs[1]],this._header.extent[this._xyz2crs[2]]]}},{key:"_getVolumeInfo",value:function(){var t=le.pick(this._header,["dmean","dmin","dmax","sd","delta"]);return t.obtuseAngle=this._header.angles.map(function(n){return+(n>=Math.PI/2)}),t}},{key:"_setBoxParams",value:function(t,n,r){var i=this,s=0,o=0,l=Lt(this._header.angles,3),c=l[0],u=l[1],f=l[2];f>=Math.PI/2&&(s+=Math.abs(n.x)),u>=Math.PI/2&&(s+=Math.abs(r.x)),c>=Math.PI/2&&(o+=Math.abs(r.y)),this._boxStart=new b(this._origin.x-s,this._origin.y-o,this._origin.z),this._boxSize=new b(Math.abs(t.x)+Math.abs(n.x)+Math.abs(r.x),Math.abs(n.y)+Math.abs(r.y),Math.abs(r.z));var h=function(p,v){return Math.abs(p[v])/i._boxSize[v]};this._header.delta.x=h(n,"x"),this._header.delta.y=h(r,"x"),this._header.delta.z=h(r,"y")}},{key:"_getXYZbox",value:function(){return new Vt(this._boxStart.clone(),this._boxStart.clone().add(this._boxSize))}},{key:"_toXYZData",value:function(){}},{key:"parse",value:function(t){return this._parseHeader(t),this._setOrigins(),new Ih(Float32Array,this._getXYZdim(),this._getXYZbox(),1,this._toXYZData(),this._getVolumeInfo())}}]),a}();function n0(a){var e=qN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function qN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var $N={extent:[dt.array,"u32",0],type:[dt.singular,"u32",3],nstart:[dt.array,"i32",4],grid:[dt.array,"u32",7],cellDims:[dt.vector,"f32",10],angles:[dt.array,"f32",13],crs2xyz:[dt.array,"i32",16],dmin:[dt.singular,"f32",19],dmax:[dt.singular,"f32",20],dmean:[dt.singular,"f32",21],ispg:[dt.singular,"u32",22],nsymbt:[dt.singular,"u32",23],lksflg:[dt.singular,"u32",24],customData:[dt.buffer,"buffer",25,9],origin:[dt.vector,"f32",34],map:[dt.buffer,"buffer",52,1],machine:[dt.singular,"u32",53],sd:[dt.singular,"f32",54],nlabel:[dt.singular,"f32",55],label:[dt.buffer,"buffer",56,200]},ZN=function(a){re(t,a);var e=n0(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_parseHeader",value:function(r){this._buff=r,this._typedCheck();var i={};i.u32=new Uint32Array(this._buff,0,56),i.i32=new Int32Array(this._buff,0,56),i.f32=new Float32Array(this._buff,0,56),i.buffer=this._buff;var s=this._header;this._fillHeader($N,i),s.angles.forEach(function(o,l,c){c[l]*=Math.PI/180})}},{key:"_setAxisIndices",value:function(){var r=this._header;r.cellDims.x===0&&r.cellDims.y===0&&r.cellDims.z===0&&r.cellDims.set(1,1,1);var i=this._header.crs2xyz;i[0]===0&&i[1]===0&&i[2]===0&&(i[0]=1,i[1]=2,i[2]=3);var s=this._xyz2crs;s[i[0]-1]=0,s[i[1]-1]=1,s[i[2]-1]=2}},{key:"_setOrigins",value:function(){var r=this._getAxis(),i=Lt(r,3),s=i[0],o=i[1],l=i[2];this._setAxisIndices();var c=this._header,u=this._xyz2crs;if(c.origin.x===0&&c.origin.y===0&&c.origin.z===0?(this._origin.addScaledVector(s,c.nstart[u[0]]),this._origin.addScaledVector(o,c.nstart[u[1]]),this._origin.addScaledVector(l,c.nstart[u[2]])):this._origin=c.origin,s.multiplyScalar(c.extent[u[0]]-1),o.multiplyScalar(c.extent[u[1]]-1),l.multiplyScalar(c.extent[u[2]]-1),c.type===2)this._data=new Float32Array(this._buff,1024+c.nsymbt,c.extent[0]*c.extent[1]*c.extent[2]);else throw new Error("CCP4: Unsupported format ".concat(c.type));this._setBoxParams(s,o,l)}},{key:"_toXYZData",value:function(){var r=this._header,i=this._data,s=this._xyz2crs,o=new Float32Array(i.length),l=this._getXYZdim(),c=l[0],u=l[1],f=0,h=[],d,p,v;for(h[2]=0;h[2]<r.extent[2];h[2]++)for(h[1]=0;h[1]<r.extent[1];h[1]++)for(h[0]=0;h[0]<r.extent[0];h[0]++,f++)d=h[s[0]],p=h[s[1]],v=h[s[2]],o[d+c*(p+u*v)]=i[f];return o}}]),t}(r0),Gc=function(a){re(t,a);var e=n0(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._options.fileType="ccp4",i.model=new ZN,i}return H(t,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canProbablyParse",value:function(r){return!1}}]),t}(zr);Gc.formats=["ccp4"];Gc.extensions=[".ccp4",".map",".mrc"];Gc.binary=!0;function KN(a){var e=JN();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function JN(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var QN=qe.Complex,eI=qe.Element,tI=qe.Molecule,Wh=function(a){re(t,a);var e=KN(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._complex=null,i._atomsInf=null,i._options.fileType="xyz",i._fileName=r.name,i}return H(t,[{key:"_parseToAtomsInf",value:function(r){var i=r.indexOf(`
`),s=parseInt(r.substring(0,i),10),o=r.indexOf(`
`,i+1),l=r.slice(i+1,o).trim();l.length===0&&(l=this._fileName);var c=o+r.substring(o).search(/\S/);if(this._atomsInf=r.substring(c).split(/[\s,]*\n[\s,]*/),!Number.isNaN(s)&&this._atomsInf.length-1!==s){this._complex.error={message:"wrong number of atoms"};return}this._complex.metadata.format="xyz",this._complex.name=l}},{key:"_parseAtomsInf",value:function(){for(var r=!0,i=" ",s=1,o=1,l=0,c=this._complex.addChain("A"),u=c.addResidue("UNK",1," "),f=0;f<this._atomsInf.length-1;f++){var h=this._atomsInf[f].split(/[\s,]+/);if(h.length!==4){this._complex.error={message:"missed parameters"};break}var d=f+1,p=h[0],v=new b(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])),_=eI.getByName(p),m=void 0;u.addAtom(p,_,v,m,r,d,i,s,o,l)}var g=new tI(this._complex,this._complex.name,1);g.residues=u,this._complex._molecules[0]=g}},{key:"parseSync",value:function(){var r=this._complex=new QN;if(this._parseToAtomsInf(this._data),this._parseAtomsInf(),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap}),this._complex=null,this._atomsInf=null,r.error)throw new Error(r.error.message);return r}}],[{key:"canProbablyParse",value:function(r){return le.isString(r)&&/^\s*\d+ *\n[^\n]*\n\s*\w{1,3}\s+-?\d/.test(r)}}]),t}(zr);Le(Wh,"formats",["xyz"]);Le(Wh,"extensions",[".xyz"]);function rI(a){var e=nI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function nI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var iI=qe.Complex,aI=qe.Element,Xh=function(a){re(t,a);var e=rI(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._options.fileType="pubchem+json",i}return H(t,[{key:"parseSync",value:function(){return this.logger.info("Parsing PubChem JSON file..."),this._toComplex(JSON.parse(this._data))}},{key:"_toComplex",value:function(r){var i=new iI,s=r.PC_Compounds&&r.PC_Compounds[0];return s&&(this._extractAtoms(i,s),i.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing})),i}},{key:"_extractAtoms",value:function(r,i){var s=i.atoms&&i.atoms.aid,o=s&&i.atoms.element;if(!o||s.length!==o.length)throw new Error("Unable to parse atom elements");o=le.fromPairs(le.zip(s,o));var l={},c=i.coords&&i.coords[0],u=c&&c.conformers&&c.conformers[0],f=u&&u.x,h=u&&u.y,d=u&&u.z||[];if(s=c&&c.aid,!s||!f||!h)throw new Error("Coordinates are not found in the file");for(var p=r.addChain(" "),v=p.addResidue("UNK",1," "),_=0,m=s.length;_<m;++_){var g=s[_],y=aI.ByAtomicNumber[o[g]],x=new b(f[_],h[_],d[_]||0);l[g]=v.addAtom(y.name,y,x,void 0,!0,g," ",1,0,0)}var S=i.bonds&&i.bonds.aid1,M=i.bonds&&i.bonds.aid2,E=i.bonds&&i.bonds.order||[];if(!(!S||!M||S.length!==M.length))for(var N=0,B=S.length;N<B;++N)r.addBond(l[S[N]],l[M[N]],E[N]||1,0,!0)}}],[{key:"canProbablyParse",value:function(r){return le.isString(r)&&r[0]==="{"}}]),t}(zr);Xh.formats=["pubchem","pubchem+json","pc"];Xh.extensions=[".json"];var sI=function(){function a(e){G(this,a),this._strings=e.split(/\r?\n|\r/),this._currentStart=0,this._currentStringIndx=0}return H(a,[{key:"setStart",value:function(t){t>=this._strings.length?(this._currentStart=this._strings.length-1,this._currentStringIndx=this._strings.length-1):(this._currentStart=t,this._currentStringIndx=t)}},{key:"getNextString",value:function(){return this._strings[++this._currentStringIndx]}},{key:"getCurrentString",value:function(){return this._strings[this._currentStringIndx]}},{key:"getStringFromStart",value:function(t){return this._currentStringIndx=this._currentStart+t,this._strings[this._currentStart+t]}},{key:"findNextDataItem",value:function(){for(var t=this.getNextString(),n=!1;!le.isUndefined(t)&&t.trim()!=="$$$$";){if(t.match(/>\s+<(.*)>/)){n=!0;break}t=this.getNextString()}return n}},{key:"findNextCompoundStart",value:function(){for(var t=this.getCurrentString();!le.isUndefined(t)&&t.trim()!=="$$$$";)t=this.getNextString();return this.setStart(++this._currentStringIndx),this.probablyHaveDataToParse()}},{key:"probablyHaveDataToParse",value:function(){return this._currentStringIndx<this._strings.length-2}}]),a}();function oI(a){var e=lI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function lI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var cI=qe.Complex,uI=qe.Element,On=qe.Bond,fI=qe.Molecule,hI=[0,3,2,1,0,-1,-2,-3],dI=[0,1,2,3,1,1,1,2],pI=[On.BondType.UNKNOWN,On.BondType.COVALENT,On.BondType.COVALENT,On.BondType.COVALENT,On.BondType.AROMATIC,On.BondType.UNKNOWN,On.BondType.AROMATIC,On.BondType.AROMATIC],mI=/.*(M\s\sEND).*|.*(^$$$$).*|.*>\s+<(.+)>.*/,vI=/.*($$$$).*|.*>\s+<(.+)>.*/,nf={SDF:"sdf",MOL:"mol"},gI=["PUBCHEM_IUPAC_TRADITIONAL_NAME",/PUBCHEM_(.+)_NAME/,/(.+)name/,/(.+)NAME/],_I=["PUBCHEM_COMPOUND_CID","id","ID",/.*CID/,/.*ID/,/.*id/],yI=["msg","MSG","message","title","description","desc"],af=["name","id","title"],xI={name:gI,id:_I,title:yI};function SI(a){if(!a)return"A";for(var e=[];a;)e.push(65+a%26),a=Math.trunc(a/26);return e.length>1&&(e.reverse(),e[0]-=1),String.fromCharCode.apply(String,e)}var jh=function(a){re(t,a);var e=oI(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._format="sdf",i._complex=null,i._chain=null,i._residue=null,i._molecules=null,i._metadata={},i._metadata.molecules=[],i._currentMolProps={},i._compoundIndx=-1,i._assemblies=[],i._atomsParsed=0,i._atomsIndexes=[],i}return H(t,[{key:"canProbablyParse",value:function(r){return le.isString(r)&&mI.test(r)}},{key:"_parseHeader",value:function(r){var i={};i.name=r.getStringFromStart(0);var s=parseInt(r.getStringFromStart(1).substr(10,6).trim(),10);i.date=s.toString()||"",i.title=r.getStringFromStart(2),this._metadata.molecules.push(i)}},{key:"_parseAtoms",value:function(r,i){var s,o=this._atomsParsed,l=SI(this._compoundIndx),c="UNK",u=1;this._chain=this._complex.getChain(l)||this._complex.addChain(l),this._residue=this._chain.addResidue(c,u," ");for(var f=0;f<i;f++){s=r.getNextString(),o++;var h=parseFloat(s.substr(0,10)),d=parseFloat(s.substr(10,10)),p=parseFloat(s.substr(20,10)),v=hI[parseInt(s.substr(36,3),10)],_=new b(h,d,p),m=s.substr(31,3).trim().toUpperCase(),g=uI.getByName(m);this._atomsIndexes[m]||(this._atomsIndexes[m]=0),this._atomsIndexes[m]+=1,m+=this._atomsIndexes[m],this._residue.addAtom(m,g,_,void 0,!0,o," ",1,0,v)}}},{key:"_parseBonds",value:function(r,i){for(var s,o=0;o<i;o++){s=r.getNextString();var l=parseInt(s.substr(0,3),10)+this._atomsParsed,c=parseInt(s.substr(3,3),10)+this._atomsParsed,u=parseInt(s.substr(6,3),10);if(l>c){var f=[c,l];l=f[0],c=f[1]}this._complex.addBond(l,c,dI[u]||1,pI[u]||On.BondType.UNKNOWN,!0)}}},{key:"_parseMOL",value:function(r){this._compoundIndx++,this._parseHeader(r);var i=r.getStringFromStart(3),s=parseInt(i.substr(0,3),10),o=parseInt(i.substr(3,3),10);this._parseAtoms(r,s),this._parseBonds(r,o),this._atomsParsed+=s,this._metadata.molecules[this._compoundIndx]._residues=[],this._metadata.molecules[this._compoundIndx]._residues.push(this._residue)}},{key:"_parseDataItem",value:function(r){for(var i=r.getCurrentString(),s=[],o=r.getNextString();o.trim()!=="";)s.push(o),o=r.getNextString();if(s.length===1){var l=s,c=Lt(l,1);s=c[0]}this._currentMolProps[i.replace(/[<>]/g,"").trim()]=s}},{key:"_parseCompound",value:function(r){if(this._parseMOL(r),this._format===nf.SDF){for(this._currentMolProps={};r.findNextDataItem();)this._parseDataItem(r);if(Object.keys(this._currentMolProps).length!==0){var i=this._metadata.molecules[this._compoundIndx];i.props=this._currentMolProps,this._tryToUpdateMoleculeData(i)}}}},{key:"_fixBondsArray",value:function(){for(var r=this._serialAtomMap,i=this._complex,s=i._bonds,o=0;o<s.length;o++){var l=s[o];l._right<l._left&&console.log("_fixBondsArray: Logic error."),l._left=r[l._left]||null,l._right=r[l._right]||null}}},{key:"_buildAssemblies",value:function(){var r=this._complex._chains;if(r.length===1)return this._assemblies;for(var i=0;i<r.length;i++){var s=new Lh(this._complex),o=new Ce;s.addMatrix(o),s.addChain(r[i]._name),this._assemblies.push(s)}return this._assemblies}},{key:"_buildMolecules",value:function(){this._complex._molecules=[];for(var r=this._metadata.molecules,i=0;i<r.length;i++){var s=new fI(this._complex,r[i].name,i+1);s.residues=r[i]._residues,this._complex._molecules[i]=s}return this._complex._molecules}},{key:"_searchTag",value:function(r,i){for(var s=0;s<i.length;s++)if(r instanceof RegExp&&r.test(i[s].tag)||r===i[s].tag)return i[s].data}},{key:"_tryToFind",value:function(r,i){for(var s=0;s<r.length;s++){var o=this._searchTag(r[s],i);if(o)return o}}},{key:"_tryToUpdateMoleculeData",value:function(r){for(var i=!1,s=0;s<af.length;s++){var o=xI[af[s]],l=this._tryToFind(o,r.props);l&&(r[af[s]]=l,i=!0)}return r.name=r.name||r.id,r.name.match(/^\d+$/)&&(r.name="CID: ".concat(r.name)),i}},{key:"_finalizeMetadata",value:function(){var r=this._metadata.molecules,i=this._complex.metadata,s=this._complex;if(r.length===1)s.name=r[0].name,i.title=r[0].title,i.date=r[0].date,i.properties=r[0].props;else if(r.length>1){i.molecules=[];for(var o=0;o<r.length;o++)i.molecules.push({name:r[o].name,date:r[o].date,title:r[o].title,properties:r[o].props})}}},{key:"_finalize",value:function(){for(var r=this._serialAtomMap={},i=this._complex._atoms,s=0;s<i.length;s++){var o=i[s];r[o.serial]=o}this._complex._finalizeBonds(),this._fixBondsArray(),this._finalizeMetadata(),this._buildAssemblies(),this._complex.units=this._complex.units.concat(this._assemblies),this._buildMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:!1,enableEditing:!1,serialAtomMap:this._serialAtomMap})}},{key:"defineFormat",value:function(r){var i;return vI.test(r)?i=nf.SDF:i=nf.MOL,i}},{key:"parseSync",value:function(){var r=this._complex=new cI,i=new sI(this._data);this._format=this.defineFormat(this._data),r.metadata.format=this._format;do this._parseCompound(i);while(i.findNextCompoundStart());return this._finalize(),r}}]),t}(zr);jh.formats=["mol","sdf"];jh.extensions=[".mol",".sdf"];function i0(a){var e=bI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function bI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var wI={nstart:[dt.array,"i16",0],extent:[dt.array,"i16",3],grid:[dt.array,"i16",6],cellDims:[dt.vector,"i16",9],angles:[dt.array,"i16",12],div:[dt.singular,"i16",15],adder:[dt.singular,"i16",16],scaleFactor:[dt.singular,"i16",17]},MI=function(a){re(t,a);var e=i0(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"_parseHeader",value:function(r){this._buff=r,this._typedCheck();var i={};if(i.i16=new Int16Array(this._buff),i.i16[18]!==100)for(var s=0,o=i.i16.length;s<o;++s){var l=i.i16[s];i.i16[s]=(l&255)<<8|l>>8&255}if(i.i16[18]!==100)throw new Error("DSN6: Incorrect format ");var c=this._header;this._fillHeader(wI,i),c.cellDims.multiplyScalar(1/c.scaleFactor),c.angles.forEach(function(u,f,h){h[f]*=Math.PI/180/c.scaleFactor}),c.div/=100}},{key:"_setAxisIndices",value:function(){this._xyz2crs[0]=0,this._xyz2crs[1]=1,this._xyz2crs[2]=2}},{key:"_setOrigins",value:function(){var r=this._header,i=this._getAxis(),s=Lt(i,3),o=s[0],l=s[1],c=s[2];this._setAxisIndices(),this._origin.addScaledVector(o,r.nstart[0]),this._origin.addScaledVector(l,r.nstart[1]),this._origin.addScaledVector(c,r.nstart[2]),o.multiplyScalar(r.extent[0]),l.multiplyScalar(r.extent[1]),c.multiplyScalar(r.extent[2]),this._setBoxParams(o,l,c)}},{key:"_pointCalculate",value:function(r,i,s,o,l,c,u){var f=this._header;if(l<f.extent[0]&&o<f.extent[1]&&s<f.extent[2]){var h=l+f.extent[0]*(o+f.extent[1]*s);r[h]=(i[c.counter]-f.adder)/f.div,++c.counter}else return c.counter+=8-u,!1;return!0}},{key:"_blockCalculate",value:function(r,i,s,o,l,c){for(var u=0;u<8;++u)for(var f=8*s+u,h=0;h<8;++h)for(var d=8*o+h,p=!0,v=0;p&&v<8;){var _=8*l+v;p=this._pointCalculate(r,i,f,d,_,c,v),v++}}},{key:"_toXYZData",value:function(){var r=this._header,i=new Uint8Array(this._buff),s=new Float32Array(r.extent[0]*r.extent[1]*r.extent[2]),o=new b(r.extent[0]/8,r.extent[1]/8,r.extent[2]/8),l={};l.counter=512;for(var c=0;c<o.z;++c)for(var u=0;u<o.y;++u)for(var f=0;f<o.x;++f)this._blockCalculate(s,i,c,u,f,l);return this._calculateInfoParams(s),s}},{key:"_calculateInfoParams",value:function(r){this._header.dmean/=r.length;for(var i=0,s=r[0],o=r[0],l=0;l<r.length;l++)i+=Math.pow(this._header.dmean-r[l],2),r[l]<s&&(s=r[l]),r[l]>o&&(o=r[l]);this._header.sd=Math.sqrt(i/r.length),this._header.dmax=o,this._header.dmin=s}}]),t}(r0),Hc=function(a){re(t,a);var e=i0(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._options.fileType="dsn6",i.model=new MI,i}return H(t,[{key:"parseSync",value:function(){return this.model.parse(this._data)}}],[{key:"canParse",value:function(r,i){return r?r instanceof ArrayBuffer&&zr.checkDataTypeOptions(i,"dsn6"):!1}},{key:"canProbablyParse",value:function(r){return!1}}]),t}(zr);Hc.formats=["dsn6"];Hc.extensions=[".dsn6",".omap"];Hc.binary=!0;function EI(a){var e=CI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function CI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var AI=function(a){re(t,a);var e=EI(t);function t(n){var r;return G(this,t),r=e.call(this,n),r._next=-1,r.next(),r}return H(t,[{key:"getNext",value:function(){return this._next}}]),t}(e0);function TI(a){var e=RI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function RI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var LI=qe.Complex,nv=qe.Element,PI=qe.Molecule,Yh=function(a){re(t,a);var e=TI(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._time=null,i._numAtoms=null,i._residueNumber=null,i._residueName="",i._atomName="",i._atomNumber=null,i._atomPosition=[],i._atomVelocity=[],i._complex=null,i._molecules=[],i._molecule=null,i._options.filetype="gro",i}return H(t,[{key:"canProbablyParse",value:function(r){return le.isString(this._data)&&/^\s*[^\n]*\n\s*\d+ *\n\s*\d+[^\n\d]{3}\s*\w+\s*\d+\s*-?\d/.test(r)}},{key:"_parseTitle",value:function(r){var i=this._complex.metadata;i.id=r.readLine().trim(),i.name=i.id.slice(i.id.lastIndexOf("\\")+1,i.id.lastIndexOf(".")),i.format="gro"}},{key:"_parseNumberOfAtoms",value:function(r){if(this._numAtoms=r.readInt(0,r.getNext()),Number.isNaN(this._numAtoms))throw new Error("Line 2 is not representing atom number. Consider checking input file")}},{key:"_parseAtom",value:function(r){this._residueNumber=r.readInt(1,5),this._residueName=r.readString(6,10).trim(),this._atomName=r.readString(11,15).trim(),this._atomNumber=r.readInt(16,20);var i=r.readFloat(21,28)*10,s=r.readFloat(29,36)*10,o=r.readFloat(37,45)*10;if(Number.isNaN(i)||Number.isNaN(s)||Number.isNaN(o)){this._complex.error={message:'Atom position is invalid in "'.concat(r.readLine(),'"')};return}var l=nv.getByName(this._atomName[0]);if(l.fullName==="Unknown"){this._complex.error={message:"".concat(this._atomName[0]," hasn't been recognised as an atom name.")};return}var c=nv.Role[this._atomName],u=this._chain;u||(this._chain=u=this._complex.addChain("A"));var f=this._residue;(!f||f.getSequence()!==this._residueNumber)&&(this._residue=f=u.addResidue(this._residueName,this._residueNumber," ")),this._atomPosition=new b(i,s,o);var h=!0,d=" ",p=1,v=1,_=0;f.addAtom(this._atomName,l,this._atomPosition,c,h,this._atomNumber,d,p,v,_)}},{key:"_finalize",value:function(){var r=new PI(this._complex,this._complex.metadata.name,1);r.residues=this._chain._residues,r._chains=this._chain,this._complex._molecules[0]=r,this._molecules.push(r),this._complex.finalize({needAutoBonding:!0,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"parseSync",value:function(){var r=this._complex=new LI,i=new AI(this._data),s=0;for(this._parseTitle(i),i.next(),this._parseNumberOfAtoms(i),i.next(),s=0;s<this._numAtoms&&!i.end();++s)this._parseAtom(i),i.next();if(s<this._numAtoms&&(this._complex.error={message:"File ended unexpectedly."}),r.error)throw new Error(r.error.message);return this._finalize(),this._atomPosition=null,this._complex=null,this._molecules=null,this._molecule=null,r}}]),t}(zr);Yh.formats=["gro"];Yh.extensions=[".gro"];function NI(a){var e=II();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function II(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var kI=qe.Complex,iv=qe.Element,Dn=qe.Bond,OI=qe.Molecule,DI={un:0,1:1,2:2,3:3,ar:1,am:1,nc:0,du:1},FI={un:Dn.BondType.UNKNOWN,1:Dn.BondType.COVALENT,2:Dn.BondType.COVALENT,3:Dn.BondType.COVALENT,ar:Dn.BondType.AROMATIC,am:Dn.BondType.COVALENT,nc:Dn.BondType.UNKNOWN,du:Dn.BondType.COVALENT},BI=/\d+$/,a0=/\s+/;function av(a){return a.trim().split(a0)}var qh=function(a){re(t,a);var e=NI(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._complex=null,i._chain=null,i._residue=null,i._compoundIndx=-1,i._molecules=[],i._molecule=null,i._currPosIdx=0,i._currStartIdx=0,i._serialAtomMap={},i._options.fileType="mol2",i}return H(t,[{key:"_parseRawStrings",value:function(r){return r.split(/\r?\n|\r/)}},{key:"_toStringFromStart",value:function(r,i){var s=this._currStartIdx+r;this._currPosIdx=s<i.length?s:this._currStartIdx}},{key:"_toHeaderString",value:function(r,i){for(this._toStringFromStart(0,i);this._currPosIdx<i.length;){if(i[this._currPosIdx].match("@<TRIPOS>".concat(r)))return;this._currPosIdx++}this._toStringFromStart(0,i)}},{key:"_toStringFromHeader",value:function(r,i,s){this._toHeaderString(r,s);var o=this._currPosIdx+i;s[this._currPosIdx].match("@<TRIPOS>".concat(r))&&o<s.length&&(this._currPosIdx=o)}},{key:"_setStart",value:function(r,i){r>=i.length?this._currStartIdx=this._currPosIdx=i.length-1:this._currStartIdx=this._currPosIdx=r}},{key:"_probablyHaveDataToParse",value:function(r){return this._currPosIdx<r.length-2}},{key:"_findNextCompoundStart",value:function(r){for(;this._currPosIdx<r.length&&r[this._currPosIdx].trim()!=="@<TRIPOS>MOLECULE>";)this._currPosIdx++;return this._setStart(++this._currPosIdx,r),this._probablyHaveDataToParse(r)}},{key:"_parseMolecule",value:function(r){this._toHeaderString("MOLECULE",r);var i=this._complex.metadata;i.name=r[++this._currPosIdx],i.format="mol2",this._molecule={_index:"",_chains:[]},this._molecule._index=this._compoundIndx+1,this._molecules.push(this._molecule)}},{key:"_parseAtoms",value:function(r,i){this._toHeaderString("ATOM",i);for(var s=0;s<r;s++){var o=av(i[++this._currPosIdx]);if(o.length<6)throw new Error("MOL2 parsing error: Not enough information to create atom!");var l=parseInt(o[0],10),c=o[1],u=parseFloat(o[2]),f=parseFloat(o[3]),h=parseFloat(o[4]),d=o[5].split(".")[0].toUpperCase(),p=0;o.length>=9&&(p=parseFloat(o[8])||0);var v=this._chain;if(v||(this._chain=v=this._complex.getChain("A")||this._complex.addChain("A"),this._residue=null),!!this._setResidue(o)){var _=!1,m=" ",g=1,y=0,x=iv.getByName(d),S=iv.Role[c],M=new b(u,f,h);this._residue.addAtom(c,x,M,S,_,l,m,g,y,p)}}}},{key:"_setResidue",value:function(r){var i=1,s="UNK";if(r.length>=7&&(i=parseInt(r[6],10)),r.length>=8&&r[7]!=="<0>"&&(s=r[7].replace(BI,"")),this.settings.now.nowater&&(s==="HOH"||s==="WAT"))return!1;var o=this._residue,l=this._chain;return(!o||o.getSequence()!==i)&&(this._residue=l.addResidue(s,i,"A")),!0}},{key:"_parseBonds",value:function(r,i){this._toHeaderString("BOND",i);for(var s=0;s<r;s++){var o=av(i[++this._currPosIdx]);if(o.length<3)throw new Error("MOL2 parsing error: Missing information about bonds!");var l=parseInt(o[1],10),c=parseInt(o[2],10),u=o[3];if(l>c){var f=[c,l];l=f[0],c=f[1]}this._complex.addBond(l,c,DI[u]||0,FI[u]||Dn.BondType.UNKNOWN,!0)}}},{key:"_fixSerialAtoms",value:function(){for(var r=this._complex._atoms,i=0;i<r.length;i++){var s=r[i];this._serialAtomMap[s.serial]=s}}},{key:"_fixBondsArray",value:function(){var r=this._serialAtomMap,i=this._complex;if(Object.keys(r).length===0)throw new Error("MOL2 parsing error: Missing atom information!");for(var s=i._bonds,o=0;o<s.length;o++){var l=s[o];l._left=r[l._left]||null,l._right=r[l._right]||null}}},{key:"_finalizeMolecules",value:function(){var r=this._complex._chains[0];this._complex._molecules=[];for(var i=0;i<this._molecules.length;i++){var s=this._molecules[i],o=r._residues,l=new OI(this._complex,s._name,i+1);l.residues=o,this._complex._molecules[i]=l}}},{key:"_finalize",value:function(){this._complex._finalizeBonds(),this._fixSerialAtoms(),this._fixBondsArray(),this._finalizeMolecules(),this._complex.finalize({needAutoBonding:!1,detectAromaticLoops:this.settings.now.aromatic,enableEditing:this.settings.now.editing,serialAtomMap:this._serialAtomMap})}},{key:"_parseCompound",value:function(r){this._compoundIndx++,this._parseMolecule(r),this._toStringFromHeader("MOLECULE",2,r);var i=r[this._currPosIdx].trim().split(a0),s=i[0],o=i[1];this._parseAtoms(s,r),this._parseBonds(o,r)}},{key:"parseSync",value:function(){var r=this._complex=new kI,i=this._parseRawStrings(this._data);do this._parseCompound(i);while(this._findNextCompoundStart(i));return this._finalize(),r}}]),t}(zr);qh.formats=["mol2"];qh.extensions=[".mol2",".ml2",".sy2"];var zI=new rN([Nt,Hh,Uc,Wh,Gh,Xh,jh,Gc,Hc,Yh,qh]);function VI(a){var e=UI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function UI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var GI=function(a){re(t,a);var e=VI(t);function t(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return G(this,t),e.call(this,n,["formats"])}return H(t,[{key:"find",value:function(r){var i=[];return r.format&&(i=this._dict.formats[r.format.toLowerCase()]||[]),$i(i)}}]),t}(ia),$h=function(){function a(e,t){G(this,a),this._source=e,this._options=t||{},this._abort=!1}return H(a,[{key:"exportSync",value:function(){throw new Error("Exporting to this source is not implemented")}},{key:"export",value:function(){var t=this;return new Promise(function(n,r){setTimeout(function(){try{return t._abort?r(new Error("Export aborted")):n(t.exportSync())}catch(i){return r(i)}})})}},{key:"abort",value:function(){this._abort=!0}}]),a}();Ao($h.prototype);var HI=function(){function a(){G(this,a),this._resultArray=[],this._currentStr=-1,this._tag=null,this._fixedNumeration=!1,this._numeration=!1,this._tagStrNum=0}return H(a,[{key:"getResult",value:function(){return this.writeString(`
`,81,81),this._resultArray.join("")}},{key:"_currentStrLength",value:function(){var t=this._resultArray[this._currentStr];return t?t.length:0}},{key:"newTag",value:function(t,n){t?this._tag=t:this._tag=null,le.isUndefined(n)?(this._numeration=!1,this._fixedNumeration=!1,this._tagStrNum=0):le.isNumber(n)?(this._tagStrNum=n,this._numeration=!0,this._fixedNumeration=!0):le.isBoolean(n)&&(this._tagStrNum=0,this._numeration=n,this._fixedNumeration=!1)}},{key:"newString",value:function(t){this.writeString(`
`,81,81),this._currentStr++,this._resultArray.push(""),t?this.writeString(t,1,6):this._tag&&this.writeString(this._tag,1,6),this._numeration&&(this._fixedNumeration||this._tagStrNum++,this._tagStrNum!==1&&this.writeString(this._tagStrNum.toString(),10,8))}},{key:"writeEntireString",value:function(t,n,r){n||(n=81);for(var i=0;i<t.length;i++)this._currentStrLength()===n&&i!==t.length-1&&(this.newString(),r&&this.writeString(r.tag,r.begin,r.end)),t[i]===`
`?this.newString():this.writeString(t[i])}},{key:"writeString",value:function(t,n,r){var i=this._resultArray[this._currentStr],s,o=i?i.length:0;if(!le.isUndefined(t)){le.isNumber(n)||(n=o+1),le.isNumber(r)||(r=o+t.length),le.isString(t)?s=t:s=t.toString();var l=n<r?r:n,c=n<r?n:r;if(s.length>Math.abs(n-r)+1&&(s=s.substr(0,Math.abs(n-r+1))),c>o+1)this._resultArray[this._currentStr]+=" ".repeat(c-o-1);else if(c<=o){var u=this._resultArray[this._currentStr];this._resultArray[this._currentStr]=u.slice(0,c-1)}if(r<n){var f=n-r+1;s=" ".repeat(f-s.length)+s}c===11&&this._numeration&&this._tagStrNum!==1&&(s=" ".concat(s)),this._resultArray[this._currentStr]+=s,i=this._resultArray[this._currentStr],l>i.length&&(this._resultArray[this._currentStr]+=" ".repeat(l-i.length))}}},{key:"writeBondsArray",value:function(t,n){for(var r=this._getSubArrays(t,4),i=0;i<r.length;i++){this.newString(),this.writeString(n.serial,11,7);for(var s=0;s<r[i].length;s++){var o=r[i][s]._left.serial===n.serial?r[i][s]._right.serial:r[i][s]._left.serial;this.writeString(o,16+5*s,12+5*s)}}}},{key:"_getSubArrays",value:function(t,n){for(var r=[],i=0;i<t.length;i+=n)r.push(t.slice(i,i+n));return r}},{key:"writeMatrix",value:function(t,n,r){for(var i=0;i<3;i++){this.newString(),this.writeString(r,14,18),this.writeString((i+1).toString(),19,19),this.writeString(n.toString(),23,20);for(var s=0;s<3;s++){var o=parseFloat(t.elements[i*4+s]).toFixed(6);this.writeString(o.toString(),33+s*10,24+s*10)}var l=parseFloat(t.elements[i*4+3]).toFixed(5);this.writeString(l.toString(),68,55)}}},{key:"writeMatrices",value:function(t,n){if(t)for(var r=new Ce,i=0;i<t.length;i++)r.copy(t[i]).transpose(),this.writeMatrix(r,i+1,n)}}]),a}();function WI(a){var e=XI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function XI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Zh=function(a){re(t,a);var e=WI(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._tags=["HEADER","TITLE","COMPND","REMARK","HELIX","SHEET","ATOM and HETATM","CONECT"],i._result=null,i._tagExtractors={HEADER:i._extractHEADER,TITLE:i._extractTITLE,"ATOM and HETATM":i._extractATOM,CONECT:i._extractCONECT,COMPND:i._extractCOMPND,REMARK:i._extractREMARK,HELIX:i._extractHELIX,SHEET:i._extractSHEET},i._stringForRemark350=`COORDINATES FOR A COMPLETE MULTIMER REPRESENTING THE KNOWN
BIOLOGICALLY SIGNIFICANT OLIGOMERIZATION STATE OF THE
MOLECULE CAN BE GENERATED BY APPLYING BIOMT TRANSFORMATIONS
GIVEN BELOW.  BOTH NON-CRYSTALLOGRAPHIC AND
CRYSTALLOGRAPHIC OPERATIONS ARE GIVEN.`,i._stringForRemark290=`CRYSTALLOGRAPHIC SYMMETRY TRANSFORMATIONS
THE FOLLOWING TRANSFORMATIONS OPERATE ON THE ATOM/HETATM
RECORDS IN THIS ENTRY TO PRODUCE CRYSTALLOGRAPHICALLY
RELATED MOLECULES.`,i}return H(t,[{key:"exportSync",value:function(){var r=new HI;if(!this._source)return this._result;for(var i=0;i<this._tags.length;i++){var s=this._tags[i],o=this._tagExtractors[s];typeof o=="function"&&o.call(this,r)}return this._result=r.getResult(),this._result}},{key:"_extractHEADER",value:function(r){if(this._source.metadata){var i=this._source.metadata;r.newTag("HEADER"),r.newString(),i.classification&&r.writeString(i.classification,11,50),i.date&&r.writeString(i.date,51,59),i.id&&r.writeString(i.id,63,66)}}},{key:"_extractTITLE",value:function(r){if(this._source.metadata){var i=this._source.metadata;if(i.title){r.newTag("TITLE",!0);for(var s=0;s<i.title.length;s++)r.newString(),r.writeString(i.title[s],11,80)}}}},{key:"_extractCONECT",value:function(r){if(this._source._atoms){var i=this._source._atoms;r.newTag("CONECT");for(var s=0;s<i.length;s++){var o=i[s].bonds.filter(function(l){return l._fixed});o.length!==0&&r.writeBondsArray(o.reverse(),i[s])}}}},{key:"_extractSHEET",value:function(r){if(this._source._sheets){r.newTag("SHEET");for(var i=this._source._sheets,s=0;s<i.length;s++)if(i[s]._strands)for(var o=i[s]._strands,l=0;l<o.length;l++)r.newString(),r.writeString(l+1,10,8),r.writeString(i[s]._name,14,12),r.writeString(o.length,16,15),r.writeString(o[l].init._type._name,18,20),r.writeString(o[l].init._chain._name,22,22),r.writeString(o[l].init._sequence,26,23),r.writeString(o[l].init._icode,27,27),r.writeString(o[l].term._type._name,29,31),r.writeString(o[l].init._chain._name,33,33),r.writeString(o[l].term._sequence,37,34),r.writeString(o[l].term._icode,38,38),r.writeString(o[l].sense,40,39)}}},{key:"_extractHELIX",value:function(r){if(this._source._helices){r.newTag("HELIX");for(var i=this._source._helices,s=0;s<i.length;s++){var o=i[s],l=le.invert(i_);r.newString(),r.writeString(o.serial,10,8),r.writeString(o.name,14,12),r.writeString(o.init._type._name,16,18),r.writeString(o.init._chain._name,20,20),r.writeString(o.init._sequence,25,22),r.writeString(o.init._icode,26,26),r.writeString(o.term._type._name,28,30),r.writeString(o.term._chain._name,32,32),r.writeString(o.term._sequence,37,34),r.writeString(o.term._icode,38,38),r.writeString(l[o.type],40,39),r.writeString(o.comment,41,70),r.writeString(o.length,76,72)}}}},{key:"_extractATOM",value:function(r){if(this._source._atoms)for(var i=this._source._atoms,s=0;s<i.length;s++){var o=i[s].het?"HETATM":"ATOM";r.newString(o);var l=i[s].element.name.length>1||i[s].name.length>3?13:14;r.writeString(i[s].serial,11,7),r.writeString(i[s].name,l,16),r.writeString(String.fromCharCode(i[s].location),17,17),r.writeString(i[s].residue._type._name,20,18),r.writeString(i[s].residue._chain._name,22,22),r.writeString(i[s].residue._sequence,26,23),r.writeString(i[s].residue._icode,27,27),r.writeString(i[s].position.x.toFixed(3),38,31),r.writeString(i[s].position.y.toFixed(3),46,39),r.writeString(i[s].position.z.toFixed(3),54,47),r.writeString(i[s].occupancy.toFixed(2),60,55),r.writeString(i[s].temperature.toFixed(2),66,61),r.writeString(i[s].element.name,78,77),i[s].charge&&r.writeString(i[s].charge,79,80)}}},{key:"_extractCOMPND",value:function(r){if(this._source._molecules){var i=this._source._molecules;r.newTag("COMPND",!0);for(var s=0;s<i.length;s++){var o=this._getMoleculeChains(i[s]);r.newString(),r.writeString("MOL_ID: ".concat(i[s].index,";"),11,80),r.newString(),r.writeString("MOLECULE: ".concat(i[s].name,";"),11,80),r.newString(),r.writeString("CHAIN: ",11,18);var l="".concat(o.join(", "),";");r.writeEntireString(l,81)}}}},{key:"_extractREMARK",value:function(r){this._Remark290(r),this._Remark350(r)}},{key:"_Remark290",value:function(r){if(this._source.symmetry&&this._source.symmetry.length!==0){var i=this._source.symmetry;r.newTag("REMARK",290),r.newString(),r.newString(),r.writeEntireString(this._stringForRemark290),r.writeMatrices(i,"SMTRY"),r.newString(),r.newString(),r.writeString("REMARK: NULL",11,80)}}},{key:"_Remark350",value:function(r){if(this._source.units){var i=this._source.units,s=0;r.newTag("REMARK",350),r.newString(),r.newString(),r.writeEntireString(this._stringForRemark350);for(var o=i.filter(function(f){return f instanceof Lh}),l=0;l<o.length;l++){r.newString(),r.newString(),s++,r.writeString("BIOMOLECULE: ".concat(s),11,80);var c=o[l].chains.join(", ");r.newString(),r.writeString("APPLY THE FOLLOWING TO CHAINS: "),r.writeEntireString(c,69,{tag:"AND CHAINS: ",begin:31,end:42});var u=o[l].matrices;r.writeMatrices(u,"BIOMT")}}}},{key:"_getMoleculeChains",value:function(r){function i(o){return o._chain._name}var s=r.residues.map(i);return s.filter(function(o,l){return s.indexOf(o)===l})}}]),t}($h);Zh.formats=["pdb"];Zh.SourceClass=Co;var za=3,Hs=3,sf=4;function sv(a,e,t,n){t[n]=a[e],t[n+1]=a[e+1],t[n+2]=a[e+2]}function jI(a,e,t,n,r){t[n]=a[e],t[n+1]=a[e+1],t[n+2]=a[e+2],t[n+3]=r}var Ws=new ht;function ov(a,e,t,n,r){Ws.set(a[e],a[e+1],a[e+2],r.w),Ws.applyMatrix4(r.matrix),t[n]=Ws.x,t[n+1]=Ws.y,t[n+2]=Ws.z}function of(a,e,t,n,r){if(!((e.array.length-e.start)/e.stride<t||(a.array.length-a.start)/a.stride<t))if(a.stride===e.stride)e.array.set(a.array,e.start);else for(var i=e.start,s=a.start,o=0;o<t;++o,i+=e.stride,s+=a.stride)n(a.array,s,e.array,i,r)}var lf=function(){function a(){G(this,a),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.lastPos=0,this.lastNorm=0,this.lastCol=0,this.lastIdx=0}return H(a,[{key:"init",value:function(t,n){this.positions=new Float32Array(t*za),this.normals=new Float32Array(t*Hs),this.colors=new Float32Array(t*sf),this.indices=new Int32Array(n)}},{key:"setPositions",value:function(t,n,r,i){var s={array:t,start:n,stride:i},o={array:this.positions,start:this.lastPos,stride:za};of(s,o,r,sv),this.lastPos+=r*za}},{key:"setTransformedPositions",value:function(t,n,r,i,s){for(var o=this.lastPos,l=n,c={matrix:s,w:1},u=0;u<r;++u,l+=i,o+=za)ov(t,l,this.positions,o,c);this.lastPos+=r*za}},{key:"setNormals",value:function(t,n,r,i){var s={array:t,start:n,stride:i},o={array:this.normals,start:this.lastNorm,stride:Hs};of(s,o,r,sv),this.lastNorm+=r*Hs}},{key:"setTransformedNormals",value:function(t,n,r,i,s){for(var o=this.lastNorm,l=n,c={matrix:s,w:0},u=0;u<r;++u,l+=i,o+=Hs)ov(t,l,this.normals,o,c);this.lastNorm+=r*Hs}},{key:"setColors",value:function(t,n,r,i){var s={array:t,start:n,stride:i},o={array:this.colors,start:this.lastCol,stride:sf};of(s,o,r,jI,1),this.lastCol+=r*sf}},{key:"setIndices",value:function(t,n,r){this.indices.set(t,this.lastIdx),this.lastIdx+=r}},{key:"setShiftedIndices",value:function(t,n,r){var i=t.map(function(s){return s+r});this.setIndices(i,0,n)}},{key:"getVerticesNumber",value:function(){return this.lastPos/za}},{key:"addInstance",value:function(t,n){var r=this.getVerticesNumber();this.setShiftedIndices(n.indices,n.indices.length,r);var i=n.itemSize;this.setTransformedPositions(n.positions,0,n.vertsCount,i.position,t),this.setTransformedNormals(n.normals,0,n.vertsCount,i.normal,t),this.setColors(n.colors,0,n.vertsCount,i.color)}}]),a}(),s0=function(){function a(){G(this,a),this.positions=null,this.normals=null,this.colors=null,this.indices=null,this.vertsCount=0,this.itemSize=null}return H(a,[{key:"init",value:function(t,n){var r=t.attributes;this.itemSize={position:r.position.itemSize,normal:r.normal.itemSize,color:r.color.itemSize}}}]),a}();function YI(a){var e=qI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function qI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var lv=function(a){re(t,a);var e=YI(t);function t(){return G(this,t),e.apply(this,arguments)}return H(t,[{key:"init",value:function(r,i){xt(D(t.prototype),"init",this).call(this,r,i);var s=r.attributes,o=s.position,l=s.normal,c=r.index;this.vertsCount=o.count,this.positions=o.array,this.normals=l.array,this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this.indices=c.array}},{key:"setColors",value:function(r){for(var i=0,s=0,o=this.colors.length,l=this.itemSize.color;s<o;s+=l)this.colors[i++]=r.r,this.colors[i++]=r.g,this.colors[i++]=r.b}}]),t}(s0);function $I(a){var e=ZI();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function ZI(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var KI=function(a){re(t,a);var e=$I(t);function t(){var n;return G(this,t),n=e.call(this),n._cutRawStart=0,n._cutRawEnd=0,n._facesPerSlice=0,n}return H(t,[{key:"init",value:function(r,i){xt(D(t.prototype),"init",this).call(this,r,i);var s=r.attributes.position,o=r.index;this.vertsCount=s.count+i.addPerCylinder,this._facesPerSlice=i.addPerCylinder,this.positions=new Float32Array(this.vertsCount*s.itemSize),this.normals=new Float32Array(this.vertsCount*this.itemSize.normal),this.colors=new Float32Array(this.vertsCount*this.itemSize.color),this._extendVertices(r,i),this.indices=new Uint32Array(o.count),this._extendIndices(r,i)}},{key:"_extendVertices",value:function(r,i){var s=r.attributes.position,o=r.attributes.normal,l=r.getGeoParams(),c=1;this._cutRawStart=c*l.radialSegments,this._cutRawEnd=this._cutRawStart+i.addPerCylinder;{var u=s.array.slice(0,this._cutRawEnd*s.itemSize);this.positions.set(u,0),u=o.array.slice(0,this._cutRawEnd*o.itemSize),this.normals.set(u,0)}{var f=s.array.slice(this._cutRawStart*s.itemSize,s.array.length);this.positions.set(f,this._cutRawEnd*s.itemSize),f=o.array.slice(this._cutRawStart*o.itemSize,o.array.length),this.normals.set(f,this._cutRawEnd*o.itemSize)}}},{key:"_extendIndices",value:function(r,i){var s=r.index,o=6,l=i.addPerCylinder*o,c=i.addPerCylinder,u=s.array.slice(l,s.count);u=u.map(function(f){return f+c}),this.indices.set(s.array,0),this.indices.set(u,l)}},{key:"_setColorRange",value:function(r,i,s,o){for(var l=o.length,c=r;c<i;c+=l)s.set(o,c)}},{key:"setColors",value:function(r,i){var s=this.itemSize.color,o=this._cutRawEnd*s,l=o*2;if(this._setColorRange(0,o,this.colors,r.toArray()),this._setColorRange(o,l,this.colors,i.toArray()),l<this.colors.length){var c=(this._facesPerSlice+1)*s,u=l+c;this._setColorRange(l,u,this.colors,i.toArray());var f=u+c;this._setColorRange(u,f,this.colors,r.toArray())}}}]),t}(s0),JI=function(){function a(){G(this,a),this._materials=[],this._models=[]}return H(a,[{key:"process",value:function(t){this._extractModelsAndMaterials(t);var n=this._flattenModels();return{name:t.name,models:n,materials:this._materials}}},{key:"_extractModelsAndMaterials",value:function(t){var n=this,r=new ah;r.set(Je.LAYERS.DEFAULT),r.enable(Je.LAYERS.TRANSPARENT),t.traverse(function(i){i instanceof ft&&i.layers.test(r)&&n.checkExportAbility(i)&&(i.geometry.type==="InstancedBufferGeometry"?n._collectInstancedGeoInfo(i):n._collectGeoInfo(i))})}},{key:"_reworkIndices",value:function(t){for(var n=3,r=n-1;r<t.length;r+=n)t[r]*=-1,t[r]--}},{key:"_flattenModels",value:function(){var t=0;function n(p){return p+t}for(var r=[],i=0,s=this._models.length;i<s;i++){var o=this._models[i],l=[],c=[],u=[],f=[];t=0;for(var h=0;h<o.length;h++){var d=o[h];l.push(d.indices.map(n)),t+=d.getVerticesNumber(),c.push(d.positions),u.push(d.normals),f.push(d.colors)}l=Se.mergeTypedArraysUnsafe(l),this._reworkIndices(l),c=Se.mergeTypedArraysUnsafe(c),u=Se.mergeTypedArraysUnsafe(u),f=Se.mergeTypedArraysUnsafe(f),r.push({indices:l,positions:c,normals:u,colors:f,verticesCount:t})}return r}},{key:"checkExportAbility",value:function(t){return t.geometry.attributes.position.count===0?!1:t instanceof P_?(Wt.warn("Currently we cannot export 'sprites' modes, like BS, WV, LC. Please turn of settings 'zSprites' and try again"),!1):t instanceof N_?(Wt.warn("Currently we cannot export Lines mode"),!1):!0}},{key:"_collectGeoInfo",value:function(t){var n=t.geometry,r=n.attributes,i=r.position,s=r.color,o=r.normal,l=n.index,c=t.matrix,u=new lf,f=i.count;u.init(f,l.count),c.isIdentity()?(u.setPositions(i.array,0,f,i.itemSize),u.setNormals(o.array,0,f,o.itemSize)):(u.setTransformedPositions(i.array,0,f,i.itemSize,c),u.setTransformedNormals(o.array,0,f,o.itemSize,c)),u.setColors(s.array,0,f,s.itemSize),u.setIndices(l.array,0,l.count);var h=this._collectMaterialInfo(t);this._addToPool(u,h)}},{key:"_collectSpheresInfo",value:function(t){var n=t.geometry,r=n.attributes,i=r.position,s=r.color,o=n.index,l=t.matrix,c=new lf,u=t.geometry.instanceCount,f=i.count,h=o.count;c.init(u*f,u*h);var d=new lv;d.init(t.geometry);for(var p=new Ce,v=new Ce,_=new ze,m=0;m<u;++m){var g=m*s.itemSize;_.fromArray(s.array,g),d.setColors(_),this._getSphereInstanceMatrix(t.geometry,m,p),v.multiplyMatrices(l,p),c.addInstance(v,d)}var y=this._collectMaterialInfo(t);this._addToPool(c,y)}},{key:"_collectCylindersInfo",value:function(t){var n=t.geometry,r=n.attributes,i=r.position,s=r.color,o=r.color2,l=n.index,c=t.matrix,u=new lf,f=t.geometry.instanceCount,h=new lv;h.init(t.geometry);var d=this._gatherCylindersColoringInfo(t.geometry),p=null;d.needToSplit>0&&(p=new KI,p.init(t.geometry,d));var v=d.addPerCylinder*d.needToSplit,_=i.count,m=l.count;u.init(f*_+v,f*m);for(var g=new Ce,y=new Ce,x=new ze,S=new ze,M={},E=0;E<f;++E){var N=E*s.itemSize;d.is2Colored[E]?(x.fromArray(o.array,N),S.fromArray(s.array,N),p&&(p.setColors(x,S),M=p)):(x.fromArray(s.array,N),h.setColors(x),M=h),this._getCylinderInstanceMatrix(t.geometry,E,g),y.multiplyMatrices(c,g),u.addInstance(y,M)}var B=this._collectMaterialInfo(t);this._addToPool(u,B)}},{key:"_addToPool",value:function(t,n){var r=this._checkExistingMaterial(n);if(r<0)this._models.push([t]),this._materials.push(n);else{var i=this._models[r];i.push(t)}}},{key:"_checkExistingMaterial",value:function(t){return le.findIndex(this._materials,function(n){return le.isEqual(n,t)})}},{key:"_gatherCylindersColoringInfo",value:function(t){for(var n=t.instanceCount,r=t.attributes.color.array,i=t.attributes.color2.array,s=t.attributes.color.itemSize,o=new Array(n),l=0,c=0,u=0;u<n;u++,c+=s){var f=Math.abs(r[c]-i[c])>1e-7||Math.abs(r[c+1]-i[c+1])>1e-7||Math.abs(r[c+2]-i[c+2])>1e-7;o[u]=f,l+=f}var h=t.getGeoParams(),d=h.radialSegments;return{is2Colored:o,needToSplit:l,addPerCylinder:d}}},{key:"_collectInstancedGeoInfo",value:function(t){t.geometry instanceof y_?this._collectSpheresInfo(t):t.geometry instanceof x_&&this._collectCylindersInfo(t)}},{key:"_collectMaterialInfo",value:function(t){var n=t.material.uberOptions;return{diffuse:n.diffuse.toArray(),opacity:n.opacity,shininess:n.shininess,specular:n.specular.toArray()}}},{key:"_getCylinderInstanceMatrix",value:function(t,n,r){var i=t.attributes.matVector1.array,s=t.attributes.matVector2.array,o=t.attributes.matVector3.array,l=n*4;r.set(i[l],i[l+1],i[l+2],i[l+3],s[l],s[l+1],s[l+2],s[l+3],o[l],o[l+1],o[l+2],o[l+3],0,0,0,1)}},{key:"_getSphereInstanceMatrix",value:function(t,n,r){var i=t.attributes.offset,s=n*i.itemSize,o=i.array[s],l=i.array[s+1],c=i.array[s+2],u=i.array[s+3];r.set(u,0,0,o,0,u,0,l,0,0,u,c,0,0,0,1)}}]),a}(),QI=`
Definitions:  {
  Version: 100
  Count: 3
  ObjectType: "Model" {
    Count: 1
  }
  ObjectType: "Geometry" {
    Count: 1
  }
  ObjectType: "Material" {
    Count: 1
  }
  ObjectType: "Pose" {
    Count: 1
  }
  ObjectType: "GlobalSettings" {
    Count: 1
  }
} `,ek=`Properties60: {
      Property: "QuaternionInterpolate", "bool", "",0
      Property: "Visibility", "Visibility", "A",1
      Property: "Lcl Translation", "Lcl Translation", "A",0.000000000000000,0.000000000000000,-1789.238037109375000
      Property: "Lcl Rotation", "Lcl Rotation", "A",0.000009334667643,-0.000000000000000,0.000000000000000
      Property: "Lcl Scaling", "Lcl Scaling", "A",1.000000000000000,1.000000000000000,1.000000000000000
      Property: "RotationOffset", "Vector3D", "",0,0,0
      Property: "RotationPivot", "Vector3D", "",0,0,0
      Property: "ScalingOffset", "Vector3D", "",0,0,0
      Property: "ScalingPivot", "Vector3D", "",0,0,0
      Property: "TranslationActive", "bool", "",0
      Property: "TranslationMin", "Vector3D", "",0,0,0
      Property: "TranslationMax", "Vector3D", "",0,0,0
      Property: "TranslationMinX", "bool", "",0
      Property: "TranslationMinY", "bool", "",0
      Property: "TranslationMinZ", "bool", "",0
      Property: "TranslationMaxX", "bool", "",0
      Property: "TranslationMaxY", "bool", "",0
      Property: "TranslationMaxZ", "bool", "",0
      Property: "RotationOrder", "enum", "",0
      Property: "RotationSpaceForLimitOnly", "bool", "",0
      Property: "AxisLen", "double", "",10
      Property: "PreRotation", "Vector3D", "",0,0,0
      Property: "PostRotation", "Vector3D", "",0,0,0
      Property: "RotationActive", "bool", "",0
      Property: "RotationMin", "Vector3D", "",0,0,0
      Property: "RotationMax", "Vector3D", "",0,0,0
      Property: "RotationMinX", "bool", "",0
      Property: "RotationMinY", "bool", "",0
      Property: "RotationMinZ", "bool", "",0
      Property: "RotationMaxX", "bool", "",0
      Property: "RotationMaxY", "bool", "",0
      Property: "RotationMaxZ", "bool", "",0
      Property: "RotationStiffnessX", "double", "",0
      Property: "RotationStiffnessY", "double", "",0
      Property: "RotationStiffnessZ", "double", "",0
      Property: "MinDampRangeX", "double", "",0
      Property: "MinDampRangeY", "double", "",0
      Property: "MinDampRangeZ", "double", "",0
      Property: "MaxDampRangeX", "double", "",0
      Property: "MaxDampRangeY", "double", "",0
      Property: "MaxDampRangeZ", "double", "",0
      Property: "MinDampStrengthX", "double", "",0
      Property: "MinDampStrengthY", "double", "",0
      Property: "MinDampStrengthZ", "double", "",0
      Property: "MaxDampStrengthX", "double", "",0
      Property: "MaxDampStrengthY", "double", "",0
      Property: "MaxDampStrengthZ", "double", "",0
      Property: "PreferedAngleX", "double", "",0
      Property: "PreferedAngleY", "double", "",0
      Property: "PreferedAngleZ", "double", "",0
      Property: "InheritType", "enum", "",0
      Property: "ScalingActive", "bool", "",0
      Property: "ScalingMin", "Vector3D", "",1,1,1
      Property: "ScalingMax", "Vector3D", "",1,1,1
      Property: "ScalingMinX", "bool", "",0
      Property: "ScalingMinY", "bool", "",0
      Property: "ScalingMinZ", "bool", "",0
      Property: "ScalingMaxX", "bool", "",0
      Property: "ScalingMaxY", "bool", "",0
      Property: "ScalingMaxZ", "bool", "",0
      Property: "GeometricTranslation", "Vector3D", "",0,0,0
      Property: "GeometricRotation", "Vector3D", "",0,0,0
      Property: "GeometricScaling", "Vector3D", "",1,1,1
      Property: "LookAtProperty", "object", ""
      Property: "UpVectorProperty", "object", ""
      Property: "Show", "bool", "",1
      Property: "NegativePercentShapeSupport", "bool", "",1
      Property: "DefaultAttributeIndex", "int", "",0
      Property: "Color", "Color", "A+",0,0,0
      Property: "Size", "double", "",100
      Property: "Look", "enum", "",1
    }`,tk=`
    LayerElementMaterial: 0 {
      Version: 101
      Name: ""
      MappingInformationType: "AllSame"
      ReferenceInformationType: "Direct"
      Materials: 0
    }`,rk=`
    Layer: 0 {
      Version: 100
      LayerElement:  {
        Type: "LayerElementNormal"
        TypedIndex: 0
      }
      LayerElement:  {
        Type: "LayerElementColor"
        TypedIndex: 0
      }
      LayerElement:  {
        Type: "LayerElementMaterial"
        TypedIndex: 0
      }
    }`,nk=`GlobalSettings: {
    Version: 1000
    Properties60:  {
      Property: "UpAxis", "int", "",1
      Property: "UpAxisSign", "int", "",1
      Property: "FrontAxis", "int", "",2
      Property: "FrontAxisSign", "int", "",1
      Property: "CoordAxis", "int", "",0
      Property: "CoordAxisSign", "int", "",1
      Property: "UnitScaleFactor", "double", "",1
    }
  }`,ik=function(){function a(){G(this,a),this._resultArray=[],this._info=null}return H(a,[{key:"getResult",value:function(t){return this._info=t,this._resultArray.push(this._writeHeader()),this._resultArray.push(this._writeDefinitions()),this._resultArray.push(this._writeObjects(t.models,t.materials)),this._resultArray.push(this._writeRelations()),this._resultArray.push(this._writeConnections()),this._info=null,this._resultArray.join("")}},{key:"_writeHeader",value:function(){var t=1003,n=6100,r=new Date,i=1e3,s="Miew FBX Exporter v".concat(this._info.version);return`; FBX 6.1.0 project file
; Created by `.concat(s,` Copyright (c) 2015-2020 EPAM Systems, Inc.
; For support please contact miew@epam.com
; ----------------------------------------------------

FBXHeaderExtension:  {
  FBXHeaderVersion: `).concat(t,`
  FBXVersion: `).concat(n,`
  CreationTimeStamp:  {
    Version: `).concat(i,`
    Year: `).concat(r.getFullYear(),`
    Month: `).concat(r.getMonth()+1,` 
    Day: `).concat(r.getDate(),`
    Hour: `).concat(r.getHours(),`
    Minute: `).concat(r.getMinutes(),`
    Second: `).concat(r.getSeconds(),`
    Millisecond: `).concat(r.getMilliseconds(),`
  }
  Creator: "`).concat(s,`"
  OtherFlags:  {
    FlagPLE: 0
  }
}
CreationTime: "`).concat(r,`"
Creator: "`).concat(s,`"  
`)}},{key:"_writeDefinitions",value:function(){return`
; Object definitions
;------------------------------------------------------------------

`.concat(QI,`
`)}},{key:"_models",value:function(){for(var t=232,n="",r=this._info.models,i=0;i<r.length;++i){var s=r[i],o=s.verticesCount;n+=`
  Model: "Model::`.concat(this._info.name,"_").concat(i,`", "Mesh" {
    Version: `).concat(t,` 
    `).concat(ek,`
    `).concat(this._verticesIndices(s.positions,s.indices),`
    `).concat(this._normalLayer(s.normals),` 
    `).concat(this._colorLayer(s.colors,o),` 
    `).concat(tk,`  
    `).concat(rk,`
  }`)}return n}},{key:"_materials",value:function(){for(var t=102,n="",r=this._info.materials,i=0;i<r.length;++i){var s=r[i];n+=`
  Material: "Material::`.concat(this._info.name,"_").concat(i,`_default", "" {
    Version: `).concat(t,`
    ShadingModel: "lambert"
    MultiLayer: 0
    `).concat(this._materialProperties(s),`
  }`)}return n}},{key:"_writeObjects",value:function(){return`
; Object properties
;------------------------------------------------------------------

Objects:  {
  `.concat(this._models(),`
  `).concat(this._materials(),`
  `).concat(nk,`
}
`)}},{key:"_writeRelations",value:function(){for(var t="",n=0;n<this._info.models.length;++n)t+=`
  Model: "Model::`.concat(this._info.name,"_").concat(n,`", "Mesh" {
  }`);for(var r="",i=0;i<this._info.materials.length;++i)r+=`
  Material: "Material::`.concat(this._info.name,"_").concat(i,`_default", "" {
  }`);return`
; Object relations
;------------------------------------------------------------------

Relations:  {
  `.concat(t,`
  Model: "Model::Producer Perspective", "Camera" {
  }
  Model: "Model::Producer Top", "Camera" {
  }
  Model: "Model::Producer Bottom", "Camera" {
  }
  Model: "Model::Producer Front", "Camera" {
  }
  Model: "Model::Producer Back", "Camera" {
  }
  Model: "Model::Producer Right", "Camera" {
  }
  Model: "Model::Producer Left", "Camera" {
  }
  Model: "Model::Camera Switcher", "CameraSwitcher" {
  }
  `).concat(r,`
}`)}},{key:"_writeConnections",value:function(){for(var t="",n=this._info.name,r=0;r<this._info.models.length;++r)t+=`
  Connect: "OO", "Model::`.concat(n,"_").concat(r,'", "Model::Scene"');for(var i="",s=0;s<this._info.materials.length;++s)i+=`
  Connect: "OO", "Material::`.concat(n,"_").concat(s,'_default", "Model::').concat(n,"_").concat(s,'"');return`
; Object connections
;------------------------------------------------------------------

Connections:  {
  `.concat(t,`
  `).concat(i,`
}`)}},{key:"_floatArrayToString",value:function(t){for(var n=[],r=0;r<t.length;++r)n[r]=t[r].toFixed(6);return n.join(",")}},{key:"_colorLayer",value:function(t,n){var r=0,i=101,s="",o=this._floatArrayToString(t),l=$i(Array(n).keys());return`
    LayerElementColor: `.concat(r,` {
      Version: `).concat(i,`
      Name: "`).concat(s,`"
      MappingInformationType: "ByVertice"
      ReferenceInformationType: "Direct"
      Colors: `).concat(o,`
      ColorIndex: `).concat(l,`
    }`)}},{key:"_normalLayer",value:function(t){var n=0,r=101,i="",s=this._floatArrayToString(t);return`
    LayerElementNormal: `.concat(n,` {
      Version: `).concat(r,`
      Name: "`).concat(i,`"
      MappingInformationType: "ByVertice"
      ReferenceInformationType: "Direct" 
      Normals: `).concat(s,`
    }`)}},{key:"_verticesIndices",value:function(t,n){var r=0,i=1,s="Y",o="CullingOff",l=124,c=this._floatArrayToString(t);return"MultiLayer: ".concat(r,`
    MultiTake: `).concat(i,`
    Shading: `).concat(s,`
    Culling: "`).concat(o,`"
    Vertices: `).concat(c,`
    PolygonVertexIndex: `).concat(n,`
    GeometryVersion: `).concat(l)}},{key:"_materialProperties",value:function(t){return`Properties60:  {
      Property: "ShadingModel", "KString", "", "Lambert"
      Property: "MultiLayer", "bool", "",0
      Property: "EmissiveColor", "ColorRGB", "",0,0,0
      Property: "EmissiveFactor", "double", "",0.0000
      Property: "AmbientColor", "ColorRGB", "",1,1,1
      Property: "AmbientFactor", "double", "",0.0000
      Property: "DiffuseColor", "ColorRGB", "",`.concat(t.diffuse,`
      Property: "DiffuseFactor", "double", "",1.0000
      Property: "Bump", "Vector3D", "",0,0,0
      Property: "TransparentColor", "ColorRGB", "",1,1,1
      Property: "TransparencyFactor", "double", "",0.0000
      Property: "SpecularColor", "ColorRGB", "",`).concat(t.specular,`
      Property: "SpecularFactor", "double", "",1.0000
      Property: "ShininessExponent", "double", "",`).concat(t.shininess,`
      Property: "ReflectionColor", "ColorRGB", "",0,0,0
      Property: "ReflectionFactor", "double", "",1
      Property: "Ambient", "ColorRGB", "",1,1,1
      Property: "Diffuse", "ColorRGB", "",`).concat(t.diffuse,`
      Property: "Specular", "ColorRGB", "",`).concat(t.specular,`
      Property: "Shininess", "double", "",`).concat(t.shininess,`
      Property: "Opacity", "double", "",`).concat(t.opacity,`
      Property: "Reflectivity", "double", "",0
    }`)}}]),a}();function ak(a){var e=sk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function sk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Kh=function(a){re(t,a);var e=ak(t);function t(n,r){var i;return G(this,t),i=e.call(this,n,r),i._data=n,i._version=r.miewVersion||"0.0-UNSPECIFIED",i._extractor=new JI,i}return H(t,[{key:"exportSync",value:function(){var r=new ik;if(!this._source)return this._result;var i=this._extractor.process(this._data);return i.version=this._version,this._result=r.getResult(i),this._result}}]),t}($h);Kh.formats=["fbx"];Kh.SourceClass=gn;var ok=new GI([Zh,Kh]),vi={loaders:QP,parsers:zI,exporters:ok},Xs=new ze,lk=function(){function a(){G(this,a),this._width=0,this._height=0,this._widthHalf=0,this._heightHalf=0,this._vector=new b,this._viewMatrix=new Ce,this._projectionMatrix=new Ce,this._domElement=document.createElement("div"),this._domElement.style.overflow="hidden",this._domElement.style.position="absolute",this._domElement.style.top="0",this._domElement.style.zIndex="0",this._domElement.style.pointerEvents="none"}return H(a,[{key:"getElement",value:function(){return this._domElement}},{key:"reset",value:function(){for(var t=this.getElement();t.firstChild;)t.removeChild(t.firstChild)}},{key:"setSize",value:function(t,n){this._width=t,this._height=n,this._widthHalf=this._width/2,this._heightHalf=this._height/2,this._domElement.style.width="".concat(t,"px"),this._domElement.style.height="".concat(n,"px")}},{key:"_renderObject",value:function(t,n,r){function i(v,_,m){return Xs.setHex(v),Xs.lerp(_,m),"#".concat(Xs.getHexString())}function s(v){return Xs.setHex(v),"#".concat(Xs.getHexString())}if(t instanceof kh){if(this._vector.setFromMatrixPosition(t.matrixWorld),t.userData!==void 0&&t.userData.offset!==void 0){var o=new b(t.userData.offset.x,t.userData.offset.y,0);this._vector.add(o.multiplyScalar(t.matrixWorld.getMaxScaleOnAxis()))}this._vector.applyMatrix4(this._viewMatrix);var l=this._vector.z>-n.near?"hidden":"visible",c=1e4*(n.far- -this._vector.z)/(n.far-n.near),u=t.getElement();if(typeof r.fog>"u")u.style.color=s(t.userData.color),t.userData.background!=="transparent"&&(u.style.background=s(t.userData.background));else{var f=Vn.smoothstep(-this._vector.z,r.fog.near,r.fog.far);u.style.color=i(t.userData.color,r.fog.color,f),t.userData.background!=="transparent"&&(u.style.background=i(t.userData.background,r.fog.color,f))}this._vector.applyMatrix4(this._projectionMatrix);var h="".concat(t.userData!=={}?t.userData.translation:"translate(-50%, -50%) ","translate(").concat(this._vector.x*this._widthHalf+this._widthHalf,"px,").concat(-this._vector.y*this._heightHalf+this._heightHalf,"px)");u.style.visibility=l,u.style.WebkitTransform=h,u.style.MozTransform=h,u.style.oTransform=h,u.style.transform=h,u.style.zIndex=Number(c).toFixed(0),u.parentNode!==this._domElement&&this._domElement.appendChild(u)}for(var d=0,p=t.children.length;d<p;d++)this._renderObject(t.children[d],n,r)}},{key:"render",value:function(t,n){t.updateMatrixWorld(),n.parent===null&&n.updateMatrixWorld(),n.matrixWorldInverse.copy(n.matrixWorld).invert(),this._viewMatrix.copy(n.matrixWorldInverse),this._projectionMatrix.copy(n.projectionMatrix),this._renderObject(t,n,t)}}]),a}(),Jh=37,Qh=38,ed=39,td=40,bt={NONE:-1,ROTATE:0,TRANSLATE:1,SCALE:2,TRANSLATE_PIVOT:3},ck=.1,Wf=new Xt,ui=new Ce;function Wn(a,e,t,n){this.objects=a;var r=Lt(a,1);this.object=r[0],this.camera=e,this.pivot=t,this.axis=new b(0,0,1),this.options=n,this.lastRotation={axis:new b,angle:0}}Wn.prototype._rotate=function(){var a=new b,e=new Xt,t=new b,n=new Ce;return function(r){var i=this.pivot.x===0&&this.pivot.y===0&&this.pivot.z===0;if(n.copy(this.object.matrix),i?n.multiply(ui.makeRotationFromQuaternion(r)):(n.multiply(ui.makeTranslation(this.pivot.x,this.pivot.y,this.pivot.z)),n.multiply(ui.makeRotationFromQuaternion(r)),n.multiply(ui.makeTranslation(-this.pivot.x,-this.pivot.y,-this.pivot.z))),n.decompose(a,e,t),!i)for(var s=0;s<this.objects.length;++s)this.objects[s].position.copy(a);for(var o=0;o<this.objects.length;++o)this.objects[o].quaternion.copy(e),this.objects[o].updateMatrix()}}();Wn.prototype.setObjects=function(a){this.objects=a;var e=Lt(a,1);this.object=e[0]};Wn.prototype.rotate=function(){var a={axis:new b,angle:0};return function(e,t,n,r){this.mouse2rotation(a,t,n,r),e.setFromAxisAngle(a.axis,a.angle),a.angle&&this._rotate(e),this.lastRotation=a}}();Wn.prototype.translate=function(){var a=new b,e=new b;return function(t){a.set(t.x/this.camera.projectionMatrix.elements[0],t.y/this.camera.projectionMatrix.elements[5],0);var n=a.length();a.normalize(),a.transformDirection(ui.copy(this.object.matrixWorld).invert()),e.copy(this.pivot),this.object.localToWorld(e),n*=Math.abs(e.z-this.camera.position.z),n/=this.object.matrixWorld.getMaxScaleOnAxis();for(var r=0;r<this.objects.length;++r)this.objects[r].translateOnAxis(a,n)}}();Wn.prototype.update=function(){var a=new b;return function(e,t){if(Q.now.autoRotation!==0)return Q.now.autoRotationAxisFixed||this.lastRotation.axis.length()===0?a.set(0,1,0).transformDirection(ui.copy(this.object.matrixWorld).invert()):a.copy(this.lastRotation.axis),this._rotate(Wf.setFromAxisAngle(a,Q.now.autoRotation*e)),!0;if(this.options.intertia&&this.lastRotation.angle){var n=this.lastRotation.angle*Math.pow(1-this.options.dynamicDampingFactor,40*t);if(Math.abs(n)<=this.options.intertiaThreshold)this.lastRotation.angle=0;else return this._rotate(Wf.setFromAxisAngle(this.lastRotation.axis,n)),!0}return!1}}();Wn.prototype.stop=function(){this.lastRotation.angle=0};Wn.prototype.mouse2rotation=function(){var a=new b,e=new b,t=new b,n=new b,r=new b,i=new b,s=new ve;return function(o,l,c,u){if(u)o.axis.copy(this.axis),o.angle=this.options.axisRotateFactor*(c.y-l.y);else{s.subVectors(c,l);var f=s.length();if(f===0)return;a.copy(this.pivot),this.object.localToWorld(a),e.subVectors(this.camera.position,a),t.copy(e).normalize(),n.copy(this.camera.up).normalize(),r.crossVectors(n,t).normalize(),n.setLength(s.y),r.setLength(s.x),i.copy(n.add(r)),o.axis.crossVectors(i,e),o.angle=-f*this.options.rotateFactor}o.axis.transformDirection(ui.copy(this.object.matrixWorld).invert()),o.angle<0&&(o.axis.negate(),o.angle=-o.angle)}}();function st(a,e,t,n,r){gr.call(this);var i=this;this.object=a,this.objectPivot=e,this.camera=t,this.domElement=typeof n<"u"?n:document,this.getAltObj=r,this.enabled=!0,this.hotkeysEnabled=!0,this.screen={left:0,top:0,width:0,height:0},this.options={rotateFactor:Math.PI,axisRotateFactor:4*Math.PI,intertia:!0,dynamicDampingFactor:.1,intertiaThreshold:.001},this._state=bt.NONE,this._mousePrevPos=new ve,this._mouseCurPos=new ve,this._mainObj=new Wn([this.object],this.camera,new b(0,0,0),this.options),this._altObj=new Wn([this.object],this.camera,new b(0,0,0),this.options),this._affectedObj=this._mainObj,this._isAltObjFreeRotationAllowed=!0,this._isTranslationAllowed=!0,this._isKeysTranslatingObj=!1,this._pressedKeys=[],this._clock=new Nc,this._clock.start(),this._lastUpdateTime=this._clock.getElapsedTime(),this._listeners=[{obj:i.domElement,type:"mousedown",handler:function(c){i.mousedown(c)}},{obj:i.domElement,type:"mouseup",handler:function(c){i.mouseup(c)}},{obj:i.domElement,type:"mousemove",handler:function(c){i.mousemove(c)}},{obj:i.domElement,type:"mousewheel",handler:function(c){i.mousewheel(c)}},{obj:i.domElement,type:"DOMMouseScroll",handler:function(c){i.mousewheel(c)}},{obj:i.domElement,type:"mouseout",handler:function(c){i.mouseup(c)}},{obj:i.domElement,type:"touchstart",handler:function(c){i.touchstartend(c)}},{obj:i.domElement,type:"touchend",handler:function(c){i.touchstartend(c)}},{obj:i.domElement,type:"touchmove",handler:function(c){i.touchmove(c)}},{obj:i.getKeyBindObject(),type:"keydown",handler:function(c){i.keydownup(c)}},{obj:i.getKeyBindObject(),type:"keyup",handler:function(c){i.keydownup(c)}},{obj:window,type:"resize",handler:function(){i.handleResize()}},{obj:window,type:"blur",handler:function(){i.resetKeys()}},{obj:i.domElement,type:"contextmenu",handler:function(c){i.contextmenu(c)}}];for(var s=0;s<this._listeners.length;s++){var o=this._listeners[s];o.obj.addEventListener(o.type,o.handler)}this.handleResize(),this.resetKeys(),this.update()}st.prototype=Object.create(gr.prototype);st.prototype.constructor=st;st.prototype.resetKeys=function(){this._pressedKeys[Jh]=!1,this._pressedKeys[Qh]=!1,this._pressedKeys[ed]=!1,this._pressedKeys[td]=!1};st.prototype.contextmenu=function(a){a.stopPropagation(),a.preventDefault()};st.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var a=this.domElement.getBoundingClientRect(),e=this.domElement.ownerDocument.documentElement;this.screen.left=a.left+window.pageXOffset-e.clientLeft,this.screen.top=a.top+window.pageYOffset-e.clientTop,this.screen.width=a.width,this.screen.height=a.height}};st.prototype.enable=function(a){this.enabled=a};st.prototype.enableHotkeys=function(a){this.hotkeysEnabled=a};st.prototype.allowTranslation=function(a){this._isTranslationAllowed=a};st.prototype.allowAltObjFreeRotation=function(a){this._isAltObjFreeRotationAllowed=a};st.prototype.keysTranslateObj=function(a){this._isKeysTranslatingObj=a};st.prototype.isEditingAltObj=function(){return(this._state===bt.ROTATE||this._state===bt.TRANSLATE)&&this._affectedObj===this._altObj};st.prototype.convertMouseToOnCircle=function(a,e,t){var n=Math.min(this.screen.width,this.screen.height);if(n===0){a.set(0,0);return}a.set((e-this.screen.width*.5-this.screen.left)/n,(.5*this.screen.height+this.screen.top-t)/n)};st.prototype.convertMouseToViewport=function(a,e,t){if(this.screen.width===0||this.screen.height===0){a.set(0,0);return}a.set(2*(e-this.screen.width*.5-this.screen.left)/this.screen.width,2*(.5*this.screen.height+this.screen.top-t)/this.screen.height)};st.prototype.stop=function(){this._mainObj.stop(),this._altObj.stop()};st.prototype.rotateByMouse=function(){var a=new Xt;return function(e){this._affectedObj.rotate(a,this._mousePrevPos,this._mouseCurPos,e),this.dispatchEvent({type:"change",action:"rotate",quaternion:a})}}();st.prototype.rotate=function(a){this.object.quaternion.multiply(a),this.dispatchEvent({type:"change",action:"rotate",quaternion:a})};st.prototype.getOrientation=function(){return this.object.quaternion};st.prototype.setOrientation=function(a){this.object.quaternion.copy(a)};st.prototype.translate=function(){var a=new ve;return function(){a.subVectors(this._mouseCurPos,this._mousePrevPos),this._affectedObj.translate(a),this.dispatchEvent({type:"change",action:"translate"})}}();st.prototype.getScale=function(){return this.object.scale.x};st.prototype.setScale=function(a){this.object.scale.set(a,a,a)};st.prototype.scale=function(a){a<=0||(this.setScale(this.object.scale.x*a),this.dispatchEvent({type:"change",action:"zoom",factor:a}))};st.prototype.update=function(){var a=new ve;return function(){var e=this._clock.getElapsedTime(),t=e-this._lastUpdateTime;if(this._state===bt.NONE){var n=e-this._lastMouseMoveTime;(this._mainObj.update(t,n)||this._altObj.update(t,n))&&this.dispatchEvent({type:"change",action:"auto"})}if(this._isKeysTranslatingObj){var r=Number(this._pressedKeys[ed])-Number(this._pressedKeys[Jh]),i=Number(this._pressedKeys[Qh])-Number(this._pressedKeys[td]);if(r!==0||i!==0){var s=t,o=this.getAltObj();o.objects.length>0&&(this._altObj.setObjects(o.objects),this._altObj.pivot=o.pivot,"axis"in o?this._altObj.axis=o.axis.clone():this._altObj.axis.set(0,0,1),a.set(s*r,s*i),this._altObj.translate(a),this.dispatchEvent({type:"change",action:"translate"}))}}this._lastUpdateTime=e}}();st.prototype.reset=function(){this._state=bt.NONE,this.object.quaternion.copy(Wf.set(0,0,0,1))};st.prototype.mousedown=function(a){if(!(this.enabled===!1||this._state!==bt.NONE)){if(a.preventDefault(),a.stopPropagation(),this._state===bt.NONE)if(a.button===0){this._affectedObj.stop();var e=!1;if(a.altKey){var t=this.getAltObj();e=t.objects.length>0,e&&(this._altObj.setObjects(t.objects),this._altObj.pivot=t.pivot,"axis"in t?this._altObj.axis=t.axis.clone():this._altObj.axis.set(0,0,1))}this._affectedObj=e?this._altObj:this._mainObj,this._state=e&&a.ctrlKey&&this._isTranslationAllowed?bt.TRANSLATE:bt.ROTATE}else a.button===2&&(this._state=bt.TRANSLATE_PIVOT);this._state===bt.ROTATE&&(this.convertMouseToOnCircle(this._mouseCurPos,a.pageX,a.pageY),this._mousePrevPos.copy(this._mouseCurPos)),(this._state===bt.TRANSLATE||this._state===bt.TRANSLATE_PIVOT)&&(this.convertMouseToViewport(this._mouseCurPos,a.pageX,a.pageY),this._mousePrevPos.copy(this._mouseCurPos))}};st.prototype.mousemove=function(a){if(!(this.enabled===!1||this._state===bt.NONE))switch(a.preventDefault(),a.stopPropagation(),this._state){case bt.ROTATE:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,a.pageX,a.pageY),this.rotateByMouse(a.altKey&&!this._isAltObjFreeRotationAllowed||a.shiftKey),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case bt.TRANSLATE:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,a.pageX,a.pageY),this.translate();break;case bt.TRANSLATE_PIVOT:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToViewport(this._mouseCurPos,a.pageX,a.pageY),this.translatePivotByMouse();break}};st.prototype.mousewheel=function(a){if(!(this.enabled===!1||!Q.now.zooming||this._state!==bt.NONE||a.shiftKey)){a.preventDefault();var e=0;a.wheelDelta?e=a.wheelDelta/40:a.detail&&(e=-a.detail/3);var t=1+e*.05;t=Math.max(t,.01),this.scale(t)}};st.prototype.mouseup=function(a){this.enabled===!1||this._state===bt.NONE||(a.preventDefault(),a.stopPropagation(),this._state=bt.NONE,this._clock.getElapsedTime()-this._lastMouseMoveTime>ck&&this._affectedObj.stop())};st.prototype.touchstartend=function(a){if(this.enabled!==!1)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:this._state=bt.ROTATE,this.convertMouseToOnCircle(this._mouseCurPos,a.touches[0].pageX,a.touches[0].pageY),this._mousePrevPos.copy(this._mouseCurPos);break;case 2:{this._mainObj.stop(),this._altObj.stop(),this._state=bt.SCALE;var e=a.touches[0].pageX-a.touches[1].pageX,t=a.touches[0].pageY-a.touches[1].pageY;this._touchDistanceCur=this._touchDistanceStart=Math.sqrt(e*e+t*t),this._scaleStart=this.object.scale.x;break}default:this._state=bt.NONE}};st.prototype.touchmove=function(a){if(!(this.enabled===!1||this._state===bt.NONE))switch(a.preventDefault(),a.stopPropagation(),this._state){case bt.ROTATE:this._mousePrevPos.copy(this._mouseCurPos),this.convertMouseToOnCircle(this._mouseCurPos,a.touches[0].pageX,a.touches[0].pageY),this.rotateByMouse(!1),this._lastMouseMoveTime=this._clock.getElapsedTime();break;case bt.SCALE:if(Q.now.zooming){var e=a.touches[0].pageX-a.touches[1].pageX,t=a.touches[0].pageY-a.touches[1].pageY;this._touchDistanceCur=Math.sqrt(e*e+t*t);var n=this._scaleStart*this._touchDistanceCur/this._touchDistanceStart,r=n/this.object.scale.x;this.scale(r)}break}};st.prototype.keydownup=function(a){if(!(this.enabled===!1||this.hotkeysEnabled===!1))switch(a.keyCode){case Jh:case Qh:case ed:case td:this._pressedKeys[a.keyCode]=a.type==="keydown",a.preventDefault(),a.stopPropagation();break}};st.prototype.getKeyBindObject=function(){return window.top};st.prototype.dispose=function(){for(var a=0;a<this._listeners.length;a++){var e=this._listeners[a];e.obj.removeEventListener(e.type,e.handler)}};st.prototype.translatePivotByMouse=function(){var a=new ve;return function(){a.subVectors(this._mouseCurPos,this._mousePrevPos),this.translatePivotInWorld(Q.now.translationSpeed*a.x,Q.now.translationSpeed*a.y,0)}}();st.prototype.translatePivotInWorld=function(a,e,t){var n=this.objectPivot.position;n.applyMatrix4(this.object.matrixWorld),n.setX(n.x+a),n.setY(n.y+e),n.setZ(n.z+t),n.applyMatrix4(ui.copy(this.object.matrixWorld).invert()),this.dispatchEvent({type:"change",action:"translatePivot"})};st.prototype.translatePivot=function(a,e,t){var n=this.objectPivot.position;n.setX(n.x+a),n.setY(n.y+e),n.setZ(n.z+t),this.dispatchEvent({type:"change",action:"translatePivot"})};st.prototype.setPivot=function(a){this.objectPivot.position.copy(a),this.dispatchEvent({type:"change",action:"translatePivot"})};function Tr(a,e,t){gr.call(this);var n=this;this.gfxObj=a,this.camera=e,this.domElement=typeof t<"u"?t:document,this.screen={left:0,top:0,width:0,height:0},this._lastMousePos=new ve(0,0),this._mouseTotalDist=0,this._lastClickBeginTime=-1e3,this._lastClickPos=new ve(0,0),this._clickBeginTime=0,this._clock=new Nc,this._clock.start(),this._listeners=[{obj:n.domElement,type:"mousedown",handler:function(o){n.mousedown(o)}},{obj:n.domElement,type:"mouseup",handler:function(o){n.mouseup(o)}},{obj:n.domElement,type:"mousemove",handler:function(o){n.mousemove(o)}},{obj:n.domElement,type:"touchstart",handler:function(o){n.touchstart(o)}},{obj:n.domElement,type:"touchend",handler:function(o){n.touchend(o)}},{obj:window,type:"resize",handler:function(){n.handleResize()}}];for(var r=0;r<this._listeners.length;r++){var i=this._listeners[r];i.obj.addEventListener(i.type,i.handler)}this.handleResize()}Tr.prototype=Object.create(gr.prototype);Tr.prototype.constructor=Tr;Tr.prototype.reset=function(){this.picked={},this.dispatchEvent({type:"newpick",obj:{}})};Tr.prototype.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var a=this.domElement.getBoundingClientRect(),e=this.domElement.ownerDocument.documentElement;this.screen.left=a.left+window.pageXOffset-e.clientLeft,this.screen.top=a.top+window.pageYOffset-e.clientTop,this.screen.width=a.width,this.screen.height=a.height}};Tr.prototype.pickObject=function(a){if(!this.gfxObj){this.picked={},this.dispatchEvent({type:"newpick",obj:{}});return}var e=this.gfxObj,t=new zg;t.ray.origin.setFromMatrixPosition(this.camera.matrixWorld),t.ray.direction.set(a.x,a.y,.5).unproject(this.camera).sub(t.ray.origin).normalize();var n=Q.now.draft.clipPlane&&this.clipPlaneValue?this.clipPlaneValue:1/0,r=Q.now.fog&&this.fogFarValue?this.fogFarValue:1/0,i=t.intersectVisibleObject(e,this.camera,n,r);if(!i){this.picked={},this.dispatchEvent({type:"newpick",obj:{}});return}var s={};if(i.residue||i.atom){var o=i.residue||i.atom.residue;Q.now.pick==="chain"?s={chain:o.getChain()}:Q.now.pick==="molecule"?s={molecule:o.getMolecule()}:i.residue||Q.now.pick==="residue"?s={residue:o}:i.atom&&(s={atom:i.atom})}this.picked=s,this.dispatchEvent({type:"newpick",obj:s})};Tr.prototype.getMouseInViewport=function(a,e){return new ve((a-this.screen.left)/this.screen.width*2-1,-(e-this.screen.top)/this.screen.height*2+1)};Tr.prototype.mousedown=function(a){a.preventDefault(),a.stopPropagation(),a.button===0&&(this._lastMousePos=this.getMouseInViewport(a.pageX,a.pageY),this._mouseTotalDist=0,this._clickBeginTime=this._clock.getElapsedTime())};Tr.prototype.mousemove=function(a){a.preventDefault(),a.stopPropagation();var e=this.getMouseInViewport(a.pageX,a.pageY);this._mouseTotalDist+=e.sub(this._lastMousePos).length()};Tr.prototype.mouseup=function(a){var e=this;if(a.preventDefault(),a.stopPropagation(),a.button===0&&this._mouseTotalDist<.01){var t=this._clock.getElapsedTime(),n=this.getMouseInViewport(a.pageX,a.pageY),r=t-this._lastClickBeginTime;if(r<.7){var i=new ve().subVectors(n,this._lastClickPos);if(i.length()<.01){this.dispatchEvent({type:"dblclick",obj:this.picked}),this._lastClickPos=n,this._lastClickBeginTime=-1e3;return}}setTimeout(function(){e.pickObject(n)},0),this._lastClickPos=n,this._lastClickBeginTime=this._clickBeginTime}};Tr.prototype.touchstart=function(a){a.preventDefault(),a.stopPropagation(),a.touches.length===1&&(this._lastTouchdownPos=this.getMouseInViewport(a.touches[0].pageX,a.touches[0].pageY))};Tr.prototype.touchend=function(a){var e=this;if(a.preventDefault(),a.stopPropagation(),a.touches.length===0&&a.changedTouches.length===1){var t=this.getMouseInViewport(a.changedTouches[0].pageX,a.changedTouches[0].pageY),n=t.sub(this._lastTouchdownPos).length();n<.01&&setTimeout(function(){e.pickObject(e._lastTouchdownPos)},0)}};Tr.prototype.dispose=function(){for(var a=0;a<this._listeners.length;a++){var e=this._listeners[a];e.obj.removeEventListener(e.type,e.handler)}};var uk=function(){function a(e,t){G(this,a),this._target=e,this._targetCamera=t,this._camera=new Bt(t.fov,t.aspect,1,100),this._object=new lC(1),this._scene=new pi,this._scene.add(this._object),this._full=new ve,this._update()}return H(a,[{key:"_update",value:function(){var t=this._targetCamera.fov,n=this._camera;n.aspect=this._targetCamera.aspect,n.setMinimalFov(t),n.setDistanceToFit(1,t),n.updateProjectionMatrix(),this._object.quaternion.copy(this._target.quaternion)}},{key:"render",value:function(t){this._update(),t.getSize(this._full);var n=this._full.width*.25,r=this._full.height*.25,i=t.autoClear;t.autoClear=!1,t.setViewport(0,0,n,r),t.clear(!1,!0,!1),t.render(this._scene,this._camera),t.setViewport(0,0,this._full.width,this._full.height),t.autoClear=i}}]),a}(),fk=12,hk=268435200,dk=8,pk=255,mk=12,vk=4293918720,gk=20,_k=1048575,yk=4026531840,xk=28,Sk=1<<19,bk=1<<20,wk=1,Mk=2,Ek=["helix","strand"],cv=["fs","ps","ns","us"];function Ck(a,e){for(var t=e._residues,n=t.length,r=new Uint8Array(n),i=e._atoms,s=0,o=a.length;s<o;++s){var l=i[s];r[l.residue._index]=a[s]}for(var c=[],u=0;u<n;){if(r[u]!==0){for(var f=u,h=r[u];u<n-1&&r[u+1]===h&&t[u].isConnected(t[u+1]);)++u;c.push({start:f,end:u,type:Ek[h-1]})}++u}return c}function cf(a){return a>=Sk?a-bk:a}var o0=function(){function a(e,t,n){G(this,a),this._complex=e,this._secondary=null,this.isLoading=!1,this._framesRange={start:0,end:-1},this.frameIsReady=!1,this._buffer=null,this._frameRequest=null,this._callbacks=n,typeof t=="function"?(this._framesRequestLength=1,this._downloadDataFn=t):this.parseBinaryData(t,!0),this.reset(),this.setFrame(0)}return H(a,[{key:"_prepareBuffer",value:function(t,n){if(t==null&&(t=0),n==null&&(n=t+this._framesRequestLength),this._framesCount!==void 0&&(n=Math.min(this._framesCount-1,n)),this._downloadDataFn){var r=this,i=function(l){if(r.isLoading=!1,r._callbacks&&typeof r._callbacks.onLoadStatusChanged=="function"&&r._callbacks.onLoadStatusChanged(),r._buffer={data:l,state:"ready",start:t,end:n},r._frameRequest!==null){var c=r._frameRequest;r._frameRequest=null,r.setFrame(c)}},s=function(){r.isLoading=!1,r._callbacks&&typeof r._callbacks.onError=="function"&&r._callbacks.onError("Streaming failed")};this._buffer||(this._buffer={}),this._buffer.state="downloading",this.isLoading=!0,r._callbacks&&typeof r._callbacks.onLoadStatusChanged=="function"&&r._callbacks.onLoadStatusChanged(),this._downloadDataFn({start:t,end:n+1},i,s)}}},{key:"_parseBuffer",value:function(){if(this._buffer&&this._buffer.state==="ready"){this._framesRange={start:this._buffer.start,end:this._buffer.end},this.parseBinaryData(this._buffer.data,!1);var t=(this._buffer.end+1)%this._framesCount;if(t>=this._framesCount&&(t=0),this._buffer={state:"none"},this._prepareBuffer(t,t+this._framesRequestLength),this._frameRequest!==null){var n=this._frameRequest;this._frameRequest=null,this.setFrame(n)}}}},{key:"parseBinaryData",value:function(t){var n=new DataView(t),r=0,i=n.getUint32(r,!0);r+=4;var s=n.getUint32(r,!0);this._framesCount=s,this._framesRange.end=this._framesRange.end>0?Math.min(this._framesRange.end,s-1):s-1,r+=4,this._atomsCount=i;var o=1024*1024;this._framesRequestLength=Math.ceil(o/(i*8));var l=this._framesRange.end-this._framesRange.start+1;if(i!==this._complex._atoms.length||t.byteLength!==fk+l*i*8)throw new Error;for(var c=this._complex,u=n.getUint32(r,!0),f=0;u>1e3&&f<cv.length-1;)u/=1e3,++f;this._timeStep="".concat(u.toString()," ").concat(cv[f]),r+=4;for(var h=[],d=new Float32Array(l*i*3),p=0,v=new Int8Array(i),_=0;_<l;++_){for(var m=0;m<i;++m){var g=n.getUint32(r,!0);r+=4;var y=n.getUint32(r,!0);r+=4;var x=(y&yk)>>>xk,S=cf((y&hk)>>>dk>>0),M=cf(((y&pk)<<mk|(g&vk)>>>gk)>>0),E=cf((g&_k)>>0);v[m]=0,x>0&&x<4?v[m]=wk:x===4&&(v[m]=Mk),d[p++]=S/100,d[p++]=M/100,d[p++]=E/100}h.push(Ck(v,c))}this._secondaryData=h,this._data=d}},{key:"nextFrame",value:function(){this.setFrame((this._currFrame+1)%this._framesCount)}},{key:"needsColorUpdate",value:function(t){return t instanceof bs}},{key:"getAtomColor",value:function(t,n){return t.getResidueColor(this._residues[n.residue._index],this._complex)}},{key:"getResidueColor",value:function(t,n){return t.getResidueColor(this._residues[n._index],this._complex)}},{key:"_updateSecondary",value:function(){var t,n=this._residues,r=n.length;for(t=0;t<r;++t)n[t]._secondary=null;var i=this._secondaryData[this._currFrame-this._framesRange.start];for(t=0,r=i.length;t<r;++t)for(var s=i[t],o=s.start,l=s.end,c={_start:n[o],_end:n[l],type:s.type,generic:s.generic},u=o;u<=l;++u)n[u]._secondary=c}},{key:"reset",value:function(){var t=this._complex._residues,n=t.length;this._residues=new Array(n);for(var r=this._residues,i=function(){return this._secondary},s=0;s<n;++s)r[s]={_type:t[s]._type,_isValid:t[s]._isValid,_controlPoint:null,_wingVector:null,_secondary:null,getSecondary:i}}},{key:"setFrame",value:function(t){if(this.frameIsReady=!1,t>=this._framesRange.start&&t<=this._framesRange.end)this._currFrame=t,this._cachedResidues=!1,this._updateSecondary(),this.frameIsReady=!0;else if(this._frameRequest=t,!this._buffer)this._prepareBuffer(t);else{var n=this;switch(this._buffer.state){case"none":this._prepareBuffer(t);break;case"ready":n._parseBuffer();break}}}},{key:"disableEvents",value:function(){this._callbacks=null}},{key:"getAtomPos",value:function(t){var n=a._vec,r=this,i=r._data,s=(r._atomsCount*(r._currFrame-r._framesRange.start)+t)*3;return n.set(i[s],i[s+1],i[s+2]),n}},{key:"getResidues",value:function(){return this._cachedResidues?this._residues:(this._complex.updateToFrame(this),this._residues)}}]),a}();Le(o0,"_vec",new b);var l0=function(){function a(e,t){if(G(this,a),this.constructor===a)throw new Error("Can not instantiate abstract class!");this.params=e,this.opts=le.merge(Se.deriveDeep(Q.now.objects[this.type],!0),t),this.needsRebuild=!1,this._mesh=null,this.id=null}return H(a,[{key:"identify",value:function(){var t={type:this.type,params:this.params},n=Se.objectsDiff(this.opts,Q.now.modes[this.id]);return le.isEmpty(n)||(t.opts=n),t}},{key:"toString",value:function(){var t="o=".concat(this.type,",").concat(this.params.join(",")),n=Se.compareOptionsWithDefaults(this.opts,Q.defaults.objects[this.type]);return t+n}},{key:"getGeometry",value:function(){return this._mesh}},{key:"destroy",value:function(){this._mesh&&Je.destroyObject(this._mesh)}}]),a}();l0.prototype.type="__";function Ak(a){var e=Tk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Tk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var _o=function(a){re(t,a);var e=Ak(t);function t(n,r){var i;if(G(this,t),i=e.call(this,n,r),n.length<2)throw new Error("Wrong number of argumets on line object creation!");var s=Lt(n,2);return i._id1=s[0],i._id2=s[1],i}return H(t,[{key:"_getAtomFromName",value:function(r,i){var s=" - Wrong atom format it must be '#CHAIN_NAME.#RESIDUE_NUMBER.#ATOM_NAME' (e.g. 'A.38.CO1')",o=r.getAtomByFullname(i);if(!o)throw new Error(i+s);return o}},{key:"build",value:function(r){var i=new at;this._atom1=this._getAtomFromName(r,this._id1),this._atom2=this._getAtomFromName(r,this._id2);var s=this._atom1.position,o=this._atom2.position,l=new Float32Array([s.x,s.y,s.z,o.x,o.y,o.z]);i.setAttribute("position",new Ze(l,3)),i.computeBoundingBox();var c=new Mn;c.setValues({lights:!1,overrideColor:!0,dashedLine:!0,fogTransparent:Q.now.bg.transparent}),this._line=new jr.Line(i,c),this._line.computeLineDistances(),this._line.material.setUberOptions({fixedColor:new ze(this.opts.color),dashedLineSize:this.opts.dashSize,dashedLinePeriod:this.opts.dashSize+this.opts.gapSize}),this._line.material.updateUniforms(),this._line.raycast=function(f,h){},this._mesh=this._line;var u=r.getTransforms();u.length>0&&(this._mesh=new nr,this._mesh.add(this._line),Ka.applyTransformsToMeshes(this._mesh,u))}},{key:"updateToFrame",value:function(r){if(!(!this._atom1||!this._atom2||!this._line)){var i=this._line.geometry;i.vertices[0].copy(r.getAtomPos(this._atom1.index)),i.vertices[1].copy(r.getAtomPos(this._atom2.index)),this._line.computeLineDistances(),i.computeBoundingSphere(),i.verticesNeedUpdate=!0}}}]),t}(l0);_o.prototype.constructor=_o;_o.prototype.type="line";var Rk=`precision highp float;\r
\r
uniform sampler2D srcTex;\r
uniform vec2 srcTexSize;\r
uniform vec2 thickness;\r
varying vec2 vUv;\r
\r
#ifdef DEPTH_OUTLINE\r
  uniform sampler2D srcDepthTex; //depthTexture\r
  uniform vec3 color;\r
  uniform float threshold;\r
#endif\r
\r
void main() {\r
\r
  vec2 pixelSize = thickness / srcTexSize;\r
\r
  #ifdef DEPTH_OUTLINE\r
    float c00 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,-pixelSize.y)).x;\r
    float c01 = texture2D(srcDepthTex, vUv + vec2(0,-pixelSize.y)).x;\r
    float c02 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,-pixelSize.y)).x;\r
    float c10 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,0)).x;\r
    float c12 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,0)).x;\r
    float c20 = texture2D(srcDepthTex, vUv + vec2(-pixelSize.x,pixelSize.y)).x;\r
    float c21 = texture2D(srcDepthTex, vUv + vec2(0,pixelSize.y)).x;\r
    float c22 = texture2D(srcDepthTex, vUv + vec2(pixelSize.x,pixelSize.y)).x;\r
\r
    float horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r
    float vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r
\r
    float grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r
\r
    gl_FragColor = ( grad > threshold ) ? vec4(color.rgb, 1.0) : gl_FragColor = texture2D(srcTex, vUv);\r
\r
  #else\r
    vec4 c00 = texture2D(srcTex, vUv + vec2(-pixelSize.x,-pixelSize.y));\r
    vec4 c01 = texture2D(srcTex, vUv + vec2(0,-pixelSize.y));\r
    vec4 c02 = texture2D(srcTex, vUv + vec2(pixelSize.x,-pixelSize.y));\r
    vec4 c10 = texture2D(srcTex, vUv + vec2(-pixelSize.x,0));\r
    vec4 c12 = texture2D(srcTex, vUv + vec2(pixelSize.x,0));\r
    vec4 c20 = texture2D(srcTex, vUv + vec2(-pixelSize.x,pixelSize.y));\r
    vec4 c21 = texture2D(srcTex, vUv + vec2(0,pixelSize.y));\r
    vec4 c22 = texture2D(srcTex, vUv + vec2(pixelSize.x,pixelSize.y));\r
\r
    vec4 horizEdge = - c00 - 2.0 * c01 - c02 + c20 + 2.0 * c21 + c22;\r
    vec4 vertEdge  = - c00 - 2.0 * c10 - c20 + c02 + 2.0 * c12 + c22;\r
\r
    vec4 grad = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);\r
    gl_FragColor = grad;\r
  #endif\r
}\r
`;function Lk(a){var e=Pk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Pk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Xf=function(a){re(t,a);var e=Lk(t);function t(n){var r;G(this,t),r=e.call(this,n);var i={uniforms:{srcTex:{type:"t",value:null},srcDepthTex:{type:"t",value:null},srcTexSize:{type:"v2",value:new ve(512,512)},color:{type:"v3",value:null},threshold:{type:"f",value:null},opacity:{type:"f",value:1},thickness:{type:"v2",value:new ve(1,1)}},vertexShader:Ri,fragmentShader:Rk,transparent:!0,depthTest:!1,depthWrite:!1};return r.setValues(i),r}return H(t,[{key:"copy",value:function(r){xt(D(t.prototype),"copy",this).call(this,r),this.depth=r.depth}},{key:"setValues",value:function(r){if(!(typeof r>"u")){xt(D(t.prototype),"setValues",this).call(this,r);var i={};this.depth&&(i.DEPTH_OUTLINE=1),this.defines=i}}}]),t}(Ur);Xf.prototype.depth=!1;var Nk=`precision highp float;\r
\r
// edge end finding algorithm parameters\r
#define FXAA_QUALITY_PS 8\r
#define FXAA_QUALITY_P0 1.0\r
#define FXAA_QUALITY_P1 1.5\r
#define FXAA_QUALITY_P2 2.0\r
#define FXAA_QUALITY_P3 2.0\r
#define FXAA_QUALITY_P4 2.0\r
#define FXAA_QUALITY_P5 2.0\r
#define FXAA_QUALITY_P6 4.0\r
#define FXAA_QUALITY_P7 12.0\r
// constants\r
float fxaaQualityEdgeThreshold = 0.125;\r
float fxaaQualityEdgeThresholdMin = 0.0625;\r
float fxaaQualitySubpix = 0.7; //0.65;\r
// global params\r
uniform sampler2D srcTex;\r
uniform vec2 srcTexelSize;\r
uniform vec3 bgColor;\r
// from vs\r
varying vec2 vUv;\r
//=====================================================================//\r
// calc luminance from rgb\r
//'float FxaaLuma(vec3 rgb) {return rgb.y * (0.587/0.299) + rgb.x; } // Lotte's idea about game luminance\r
float FxaaLuma(vec3 rgb) {return dot(rgb, vec3(0.299, 0.587, 0.114)); } // real luminance calculation\r
                                                                           // for non-real scene rendering\r
// texture sampling by pixel position(coords) and offset(in pixels)\r
 vec3 FxaaTex(sampler2D tex, vec2 pos, vec2 off,  vec2 res ) {\r
  #ifdef BG_TRANSPARENT\r
    vec4 color = texture2D( tex, pos + off * res );\r
    return mix(color.rgb, bgColor, 1.0 - color.a);\r
  #else\r
    return texture2D( tex, pos + off * res ).xyz;\r
  #endif\r
}\r
vec3 FxaaTexTop(sampler2D tex, vec2 pos) {\r
  #ifdef BG_TRANSPARENT\r
    vec4 color = texture2D( tex, pos );\r
    return mix(color.rgb, bgColor, 1.0 - color.a);\r
  #else\r
    return texture2D( tex, pos).xyz;\r
  #endif\r
}\r
vec4 FxaaTexTopAlpha(sampler2D tex, vec2 pos) {\r
  return texture2D( tex, pos);\r
}\r
\r
//=====================================================================//\r
void main() {\r
  // renaming\r
  vec2 posM = vUv;\r
  // get luminance for neighbours\r
  float lumaS = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, 1.0 ), srcTexelSize));\r
  float lumaE = FxaaLuma(FxaaTex(srcTex, posM, vec2( 1.0, 0.0 ), srcTexelSize));\r
  float lumaN = FxaaLuma(FxaaTex(srcTex, posM, vec2( 0.0, -1.0 ), srcTexelSize));\r
  float lumaW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, 0.0 ), srcTexelSize));\r
  float lumaM = FxaaLuma(FxaaTexTop(srcTex, posM));\r
  // find max and min luminance\r
  float rangeMax = max(max(lumaN, lumaW), max(lumaE, max(lumaS, lumaM)));\r
  float rangeMin = min(min(lumaN, lumaW), min(lumaE, min(lumaS, lumaM)));\r
  // calc maximum non-edge range\r
  float rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;\r
  float range = rangeMax - rangeMin;\r
  float rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);\r
  // exit when luma contrast is small (is not edge)\r
  if(range < rangeMaxClamped){\r
    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r
    return;\r
  }\r
  float subpixRcpRange = 1.0/range;\r
  // note: the sampling coordinates can be calculated in vertex shader but the approach doesn't affect performance\r
  // visibly, thus we decided to leave calculation here for better readability.\r
  // calc other neighbours luminance\r
  float lumaNE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0, -1.0 ), srcTexelSize));\r
  float lumaSW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0,  1.0 ), srcTexelSize));\r
  float lumaSE = FxaaLuma(FxaaTex(srcTex, posM, vec2(  1.0,  1.0 ), srcTexelSize));\r
  float lumaNW = FxaaLuma(FxaaTex(srcTex, posM, vec2( -1.0, -1.0 ), srcTexelSize));\r
/*--------------span calculation and subpix amount calulation-----------------*/\r
  float lumaNS = lumaN + lumaS;\r
  float lumaWE = lumaW + lumaE;\r
  float subpixNSWE = lumaNS + lumaWE;\r
  float edgeHorz1 = (-2.0 * lumaM) + lumaNS;\r
  float edgeVert1 = (-2.0 * lumaM) + lumaWE;\r
/*--------------------------------------------------------------------------*/\r
  float lumaNESE = lumaNE + lumaSE;\r
  float lumaNWNE = lumaNW + lumaNE;\r
  float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;\r
  float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;\r
/*--------------------------------------------------------------------------*/\r
  float lumaNWSW = lumaNW + lumaSW;\r
  float lumaSWSE = lumaSW + lumaSE;\r
  float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);\r
  float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);\r
  float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;\r
  float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;\r
  float edgeHorz = abs(edgeHorz3) + edgeHorz4;\r
  float edgeVert = abs(edgeVert3) + edgeVert4;\r
/*--------------------subpix amount calulation------------------------------*/\r
  float subpixNWSWNESE = lumaNWSW + lumaNESE;\r
  float lengthSign = srcTexelSize.x;\r
  bool horzSpan = edgeHorz >= edgeVert;\r
   // debug  code edge span visualization\r
/*'  if (horzSpan)\r
      gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\r
  else\r
    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\r
  return;*/\r
  float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;\r
/*--------------------------------------------------------------------------*/\r
  if(!horzSpan) lumaN = lumaW;\r
  if(!horzSpan) lumaS = lumaE;\r
  if(horzSpan) lengthSign = srcTexelSize.y;\r
  float subpixB = (subpixA * (1.0/12.0)) - lumaM;\r
/*--------------------------------------------------------------------------*/\r
  float gradientN = lumaN - lumaM;\r
  float gradientS = lumaS - lumaM;\r
  float lumaNN = lumaN + lumaM;\r
  float lumaSS = lumaS + lumaM;\r
  bool pairN = abs(gradientN) >= abs(gradientS);\r
  float gradient = max(abs(gradientN), abs(gradientS));\r
  if(pairN) lengthSign = -lengthSign;\r
  float subpixC = clamp(abs(subpixB) * subpixRcpRange, 0.0, 1.0);\r
/*--------------------------------------------------------------------------*/\r
  vec2 posB;\r
  posB = posM;\r
  vec2 offNP;\r
  offNP.x = (!horzSpan) ? 0.0 : srcTexelSize.x;\r
  offNP.y = ( horzSpan) ? 0.0 : srcTexelSize.y;\r
  if(!horzSpan) posB.x += lengthSign * 0.5;\r
  if( horzSpan) posB.y += lengthSign * 0.5;\r
/*--------------------------------------------------------------------------*/\r
  vec2 posN;\r
  posN = posB - offNP * FXAA_QUALITY_P0;\r
  vec2 posP;\r
  posP = posB + offNP * FXAA_QUALITY_P0;\r
  float subpixD = ((-2.0)*subpixC) + 3.0;\r
  float lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN));\r
  float subpixE = subpixC * subpixC;\r
  float lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP));\r
/*--------------------------------------------------------------------------*/\r
  if(!pairN) lumaNN = lumaSS;\r
  float gradientScaled = gradient * 1.0/4.0;\r
  float lumaMM = lumaM - lumaNN * 0.5;\r
  float subpixF = subpixD * subpixE;\r
  bool lumaMLTZero = lumaMM < 0.0;\r
/*---------------------looped edge-end search-------------------------------*/\r
  lumaEndN -= lumaNN * 0.5;\r
  lumaEndP -= lumaNN * 0.5;\r
  bool doneN = abs(lumaEndN) >= gradientScaled;\r
  bool doneP = abs(lumaEndP) >= gradientScaled;\r
  if(!doneN) posN -= offNP * FXAA_QUALITY_P1;\r
  bool doneNP = (!doneN) || (!doneP);\r
  if(!doneP) posP += offNP * FXAA_QUALITY_P1;\r
/*--------------------------------------------------------------------------*/\r
  if(doneNP) {\r
    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
    doneN = abs(lumaEndN) >= gradientScaled;\r
    doneP = abs(lumaEndP) >= gradientScaled;\r
    if(!doneN) posN -= offNP * FXAA_QUALITY_P2;\r
    doneNP = (!doneN) || (!doneP);\r
    if(!doneP) posP += offNP * FXAA_QUALITY_P2;\r
/*--------------------------------------------------------------------------*/\r
    #if (FXAA_QUALITY_PS > 3)\r
      if(doneNP) {\r
        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
        doneN = abs(lumaEndN) >= gradientScaled;\r
        doneP = abs(lumaEndP) >= gradientScaled;\r
        if(!doneN) posN -= offNP * FXAA_QUALITY_P3;\r
        doneNP = (!doneN) || (!doneP);\r
        if(!doneP) posP += offNP * FXAA_QUALITY_P3;\r
/*--------------------------------------------------------------------------*/\r
        #if (FXAA_QUALITY_PS > 4)\r
          if(doneNP) {\r
            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
            doneN = abs(lumaEndN) >= gradientScaled;\r
            doneP = abs(lumaEndP) >= gradientScaled;\r
            if(!doneN) posN -= offNP * FXAA_QUALITY_P4;\r
            doneNP = (!doneN) || (!doneP);\r
            if(!doneP) posP += offNP * FXAA_QUALITY_P4;\r
/*--------------------------------------------------------------------------*/\r
            #if (FXAA_QUALITY_PS > 5)\r
               if(doneNP) {\r
                 if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
                 if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
                 if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
                 if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
                 doneN = abs(lumaEndN) >= gradientScaled;\r
                 doneP = abs(lumaEndP) >= gradientScaled;\r
                 if(!doneN) posN -= offNP * FXAA_QUALITY_P5;\r
                 doneNP = (!doneN) || (!doneP);\r
                 if(!doneP) posP += offNP * FXAA_QUALITY_P5;\r
/*--------------------------------------------------------------------------*/\r
                 #if (FXAA_QUALITY_PS > 6)\r
                   if(doneNP) {\r
                     if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
                     if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
                     if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
                     if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
                     doneN = abs(lumaEndN) >= gradientScaled;\r
                     doneP = abs(lumaEndP) >= gradientScaled;\r
                     if(!doneN) posN -= offNP * FXAA_QUALITY_P6;\r
                     doneNP = (!doneN) || (!doneP);\r
                     if(!doneP) posP += offNP * FXAA_QUALITY_P6;\r
/*--------------------------------------------------------------------------*/\r
                     #if (FXAA_QUALITY_PS > 7)\r
                       if(doneNP) {\r
                         if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(srcTex, posN.xy));\r
                         if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(srcTex, posP.xy));\r
                         if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;\r
                         if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;\r
                         doneN = abs(lumaEndN) >= gradientScaled;\r
                         doneP = abs(lumaEndP) >= gradientScaled;\r
                         if(!doneN) posN -= offNP * FXAA_QUALITY_P7;\r
                         doneNP = (!doneN) || (!doneP);\r
                         if(!doneP) posP += offNP * FXAA_QUALITY_P7;\r
/*--------------------------------------------------------------------------*/\r
                       }\r
                     #endif\r
                   }\r
                 #endif\r
               }\r
             #endif\r
           }\r
         #endif\r
      }\r
    #endif\r
  }\r
/*----------------calculate subpix offset due to edge ends-------------------*/\r
  float dstN = posM.x - posN.x;\r
  float dstP = posP.x - posM.x;\r
  if(!horzSpan) dstN = posM.y - posN.y;\r
  if(!horzSpan) dstP = posP.y - posM.y;\r
/*--------------------------------------------------------------------------*/\r
  bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;\r
  float spanLength = (dstP + dstN);\r
  bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;\r
  float spanLengthRcp = 1.0 / spanLength;\r
/*--------------------------------------------------------------------------*/\r
  bool directionN = dstN < dstP;\r
  float dst = min(dstN, dstP);\r
  bool goodSpan = directionN ? goodSpanN : goodSpanP;\r
  float subpixG = subpixF * subpixF;\r
  float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;\r
  float subpixH = subpixG * fxaaQualitySubpix;\r
/*-----------------calc texture offest using subpix-------------------------*/\r
  float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;\r
  float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);\r
\r
  float offset = pixelOffsetSubpix * lengthSign;\r
  #ifdef BG_TRANSPARENT\r
    // get original texel\r
    vec4 rgbaA = FxaaTexTopAlpha(srcTex, posM);\r
    // calc step to blended texel\r
    vec2 step = sign((!horzSpan) ? vec2 (offset, 0.0) : vec2 (0.0, offset));\r
    // get neighboring texel\r
    vec4 rgbaB = FxaaTexTopAlpha(srcTex, posM + step * srcTexelSize);\r
    //  calc blend factor from offset\r
    float f = (!horzSpan) ? offset / srcTexelSize.x : offset / srcTexelSize.y;\r
    f = abs(f);\r
    // calc alpha (special formula to emulate blending with bg)\r
    gl_FragColor.a = 1.0 - mix(1.0 - rgbaA.a, 1.0 - rgbaB.a, f);\r
    // calc color (special formula to emulate blending with bg)\r
    gl_FragColor.rgb = mix(rgbaA.rgb * rgbaA.a, rgbaB.rgb * rgbaB.a, f) / gl_FragColor.a;\r
  #else\r
    if(!horzSpan) {\r
       posM.x += offset;\r
    } else {\r
       posM.y += offset;\r
    }\r
    gl_FragColor = FxaaTexTopAlpha(srcTex, posM);\r
  #endif\r
  return;\r
}\r
`;function Ik(a){var e=kk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function kk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var c0=function(a){re(t,a);var e=Ik(t);function t(n){var r;return G(this,t),r=e.call(this,n),r.setValues({uniforms:{srcTex:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ve(1/512,1/512)},bgColor:{type:"c",value:new ze(16777215)}},vertexShader:Ri,fragmentShader:Nk,transparent:!1,depthTest:!1,depthWrite:!1}),r.setValues(n),r}return H(t,[{key:"copy",value:function(r){xt(D(t.prototype),"copy",this).call(this,r),this.depth=r.depth}},{key:"setValues",value:function(r){if(!(typeof r>"u")){xt(D(t.prototype),"setValues",this).call(this,r);var i={};this.bgTransparent&&(i.BG_TRANSPARENT=1),this.defines=i}}}]),t}(Ur);c0.prototype.bgTransparent=!1;var Ok=`precision highp float;\r
#define EPSILON 0.0000001\r
\r
#define MAX_SAMPLES_COUNT 32\r
uniform vec3 samplesKernel[MAX_SAMPLES_COUNT];\r
uniform sampler2D noiseTexture;\r
uniform vec2      noiseTexelSize;\r
uniform sampler2D diffuseTexture;\r
uniform sampler2D depthTexture;\r
uniform sampler2D normalTexture;\r
uniform vec2      srcTexelSize;\r
uniform vec2      camNearFar;\r
uniform mat4      projMatrix;\r
\r
uniform float aspectRatio;\r
uniform float tanHalfFOV;\r
\r
uniform float kernelRadius;\r
uniform float depthThreshold;\r
uniform float factor;\r
\r
varying vec2 vUv;\r
\r
float CalcViewZ(vec2 screenPos)\r
{\r
  float depth = texture2D(depthTexture, screenPos).x;\r
  // [0, 1]->[-1, 1]\r
  float clipedZ = 2.0 * depth - 1.0;\r
  // see THREE.js camera.makeFrustum for projection details\r
  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r
}\r
\r
vec3 ViewPosFromDepth(vec2 screenPos)\r
{\r
  vec3 viewPos;\r
  viewPos.z = CalcViewZ(screenPos);\r
  //[0, 1]->[-1, 1]\r
  vec2 projPos = 2.0 * screenPos - 1.0;\r
  // reconstruct viewposition in right-handed sc with z to viewer\r
  viewPos.xy = vec2(\r
                    projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r
                    projPos.y * tanHalfFOV * abs(viewPos.z)\r
                   );\r
  return viewPos;\r
}\r
\r
void main() {\r
  vec3 viewPos = ViewPosFromDepth(vUv);\r
  // remap coordinates to prevent noise exture rescale\r
  vec2 vUvNoise = vUv / srcTexelSize * noiseTexelSize;\r
  vec4 normalData = texture2D(normalTexture, vUv);\r
  // return for background fragments (their normals are zero vectors)\r
  if (length(normalData.rgb) < EPSILON) {\r
    // 0.0 in alpha component means that it is background fragment\r
    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\r
    return;\r
  }\r
  //[0, 1] -> [-1, 1]\r
  vec3 normal = (normalData.rgb * 2.0 - 1.0);\r
  // normalData.a store 1.0 if normal was build for frontfaced surface\r
  // and 0.0 in other case\r
  if (normalData.a < EPSILON) {\r
    normal *= -1.0;\r
  }\r
  // get random vector for sampling sphere rotation\r
  vec3 randN = texture2D(noiseTexture, vUvNoise).rgb * 2.0 - 1.0;\r
  randN = normalize(randN);\r
  // build TBN (randomly rotated around normal)\r
  vec3 tangent   = normalize(randN - normal * dot(randN, normal));\r
  vec3 bitangent = cross(tangent, normal);\r
  mat3 TBN = mat3(tangent, bitangent, normal);\r
  // calc AO value\r
  float AO = 0.0;\r
  for (int i = 0 ; i < MAX_SAMPLES_COUNT ; i++) {\r
    // rotate sampling kernel around normal\r
    vec3 reflectedSample = TBN * samplesKernel[i];\r
    // get sample\r
    vec3 samplePos = viewPos + reflectedSample * kernelRadius;\r
\r
    // project sample to screen to get sample's screen pos\r
    vec4 SampleScrPos = vec4(samplePos, 1.0);\r
    // eye -> clip\r
    SampleScrPos = projMatrix * SampleScrPos;\r
    // normalize\r
    SampleScrPos.xy /= SampleScrPos.w;\r
    //[-1, 1] -> [0, 1]\r
    SampleScrPos.xy = (SampleScrPos.xy + vec2(1.0)) * 0.5;\r
\r
    // get view z for sample projected to the objct surface\r
    float sampleDepth = CalcViewZ(SampleScrPos.xy);\r
    // calc occlusion made by object surface at the sample\r
    AO += step(samplePos.z, sampleDepth);\r
  }\r
  // calc result AO-map color\r
  AO = 1.0 - max(0.0, AO / float(MAX_SAMPLES_COUNT) * factor);\r
  // write value to AO-map\r
  gl_FragColor = vec4(AO, AO, AO, 1.0);\r
}\r
`;function Dk(a){var e=Fk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Fk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Bk=[new b(.295184,.077723,.068429),new b(-.271976,-.365221,.838363),new b(.547713,.467576,.488515),new b(.662808,-.031733,.584758),new b(-.025717,.218955,.657094),new b(-.310153,-.365223,.370701),new b(-.101407,-.006313,.747665),new b(-.769138,.360399,.086847),new b(-.271988,-.27514,.905353),new b(.09674,-.566901,.700151),new b(.562872,-.735136,.094647),new b(.379877,.359278,.190061),new b(.519064,-.023055,.405068),new b(-.301036,.114696,.088885),new b(-.282922,.598305,.487214),new b(-.181859,.25167,.679702),new b(-.191463,-.635818,.512919),new b(-.293655,.427423,.078921),new b(-.267983,.680534,.13288),new b(.139611,.319637,.477439),new b(-.352086,.31104,.653913),new b(.321032,.805279,.487345),new b(.073516,.820734,.414183),new b(-.155324,.589983,.41146),new b(.335976,.170782,.527627),new b(.46346,-.355658,.167689),new b(.222654,.59655,.769406),new b(.922138,-.04207,.147555),new b(-.72705,-.329192,.369826),new b(-.090731,.53382,.463767),new b(-.323457,-.876559,.238524),new b(-.663277,-.372384,.342856)],zk=function(a){re(t,a);var e=Dk(t);function t(){var n;return G(this,t),n=e.call(this),n.setValues({uniforms:{noiseTexture:{type:"t",value:$a.noiseTexture},noiseTexelSize:{type:"v2",value:new ve(1/$a.noiseWidth,1/$a.noiseHeight)},diffuseTexture:{type:"t",value:null},normalTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ve(1/512,1/512)},camNearFar:{type:"v2",value:new ve(1,10)},projMatrix:{type:"mat4",value:new Ce},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},samplesKernel:{type:"v3v",value:Bk},kernelRadius:{type:"f",value:1},depthThreshold:{type:"f",value:1},factor:{type:"f",value:1}},vertexShader:Ri,fragmentShader:Ok,transparent:!1,depthTest:!1,depthWrite:!1}),n}return H(t)}(Ur),Vk=`precision highp float;\r
#define EPSILON 0.0000001\r
\r
#define MAX_SAMPLES_COUNT 5\r
uniform float samplesOffsets[MAX_SAMPLES_COUNT];\r
uniform sampler2D aoMap;\r
uniform sampler2D depthTexture;\r
uniform vec2      srcTexelSize;\r
\r
varying vec2 vUv;\r
\r
void main() {\r
  float x = vUv.x;\r
  float y = vUv.y;\r
  vec4 res = vec4(0.0);\r
  res.a = texture2D(aoMap, vec2(x, y )).a;\r
  // return for background fragments (0.0 in alpha component means that it is background fragment)\r
  if (res.a < EPSILON) {\r
    gl_FragColor = res;\r
    return;\r
  }\r
\r
  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r
  float weightSum = 0.0;\r
  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r
    if (texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).a < EPSILON) {\r
      continue;\r
    }\r
    vec2 samplePos = vec2(x + samplesOffsets[i] * srcTexelSize.x, y);\r
    float depth = texture2D(depthTexture, samplePos).x;\r
    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r
    res.rgb += texture2D(aoMap, vec2(x + samplesOffsets[i] * srcTexelSize.x, y )).rgb * weight;\r
    weightSum += weight;\r
  }\r
  res.rgb = res.rgb / weightSum;\r
  gl_FragColor = res;\r
}\r
`;function Uk(a){var e=Gk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Gk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Hk=[-2,-1,0,1,2],Wk=function(a){re(t,a);var e=Uk(t);function t(){var n;return G(this,t),n=e.call(this),n.setValues({uniforms:{depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ve(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:Hk}},vertexShader:Ri,fragmentShader:Vk,transparent:!1,depthTest:!1,depthWrite:!1}),n}return H(t)}(Ur),Xk=`precision highp float;\r
#define EPSILON 0.0000001\r
\r
#define MAX_SAMPLES_COUNT 5\r
uniform float samplesOffsets[MAX_SAMPLES_COUNT];\r
uniform sampler2D diffuseTexture;\r
uniform sampler2D aoMap;\r
uniform sampler2D depthTexture;\r
uniform vec2      srcTexelSize;\r
\r
uniform mat4  projMatrix;\r
uniform float aspectRatio;\r
uniform float tanHalfFOV;\r
\r
#ifdef USE_FOG\r
  uniform vec2 fogNearFar;\r
  uniform vec4 fogColor;\r
#endif\r
varying vec2 vUv;\r
\r
float CalcViewZ(vec2 screenPos)\r
{\r
  float depth = texture2D(depthTexture, screenPos).x;\r
  // [0, 1]->[-1, 1]\r
  float clipedZ = 2.0 * depth - 1.0;\r
  // see THREE.js camera.makeFrustum for projection details\r
  return (-projMatrix[3][2] / (clipedZ + projMatrix[2][2]));\r
}\r
\r
vec3 ViewPosFromDepth(vec2 screenPos)\r
{\r
  vec3 viewPos;\r
  viewPos.z = CalcViewZ(screenPos);\r
  //[0, 1]->[-1, 1]\r
  vec2 projPos = 2.0 * screenPos - 1.0;\r
  // reconstruct viewposition in right-handed sc with z to viewer\r
  viewPos.xy = vec2(\r
  projPos.x * aspectRatio * tanHalfFOV * abs(viewPos.z),\r
  projPos.y * tanHalfFOV * abs(viewPos.z)\r
  );\r
  return viewPos;\r
}\r
\r
void main() {\r
  vec3 viewPos = ViewPosFromDepth(vUv);\r
  float x = vUv.x;\r
  float y = vUv.y;\r
  vec4 color = texture2D(diffuseTexture, vec2(x, y));\r
  vec4 res = vec4(0.0);\r
  res.a = texture2D(aoMap, vec2(x, y )).a;\r
  // return for background fragments (0.0 in alpha component means that it is background fragment)\r
  if (res.a < EPSILON) {\r
    gl_FragColor = color;\r
    return;\r
  }\r
\r
  float pixelDepth = texture2D(depthTexture, vec2(x, y)).x;\r
  float weightSum = 0.0;\r
  for (int i = 0; i < MAX_SAMPLES_COUNT; ++i) {\r
    if (texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).a < EPSILON) {\r
      continue;\r
    }\r
    vec2 samplePos = vec2(x, y + samplesOffsets[i] * srcTexelSize.y);\r
    float depth = texture2D(depthTexture, samplePos).x;\r
    float weight = (1.0 / (0.0001 + abs(depth - pixelDepth)));\r
    res.rgb += texture2D(aoMap, vec2(x, y + samplesOffsets[i] * srcTexelSize.y)).rgb * weight;\r
    weightSum += weight;\r
  }\r
  res.rgb /= weightSum;\r
\r
  #if defined(USE_FOG) && !defined(FOG_TRANSPARENT)\r
    // Add fog to the result value\r
    // Proper way to get an image with fog and ao requires formula:\r
    //          gl_FragColor = fragColor*AO*(1-fogFactor) + fogColor*fogFactor\r
    // But we have already fogged molecule to add AO too. Let's split the straight formula into our real steps!\r
    // We have:  AO, fogFactor, fogColor,\r
    //          color = fragColor*(1-fogFactor) + fogColor*fogFactor (it comes from diffuseTexture,\r
    //                                                                where molecule has been already drawn with fog)\r
    // Transform:\r
    //          fragColor*AO*(1-fogFactor) + fogColor*fogFactor =\r
    //        = [fragColor*(1-fogFactor) = color - fogColor*fogFactor] =\r
    //        = (color - fogColor*fogFactor)*AO + fogColor*fogFactor =\r
    //        = color*AO + fogColor*fogFactor*(1 - AO)\r
    // Result:  gl_FragColor = color*AO + fogColor*fogFactor*(1 - AO)\r
    float fogFactor = smoothstep(fogNearFar.x, fogNearFar.y, - viewPos.z) * fogColor.a;\r
    gl_FragColor.rgb = color.rgb * res.rgb + fogColor.rgb * fogFactor *(vec3(1.0, 1.0, 1.0) - res.rgb);\r
  #else\r
    gl_FragColor.rgb = color.rgb * res.rgb;\r
  #endif\r
  gl_FragColor.a = color.a;\r
}\r
`;function jk(a){var e=Yk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Yk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var qk=[-2,-1,0,1,2],rd=function(a){re(t,a);var e=jk(t);function t(n){var r;return G(this,t),r=e.call(this,n),r.setValues({uniforms:{diffuseTexture:{type:"t",value:null},depthTexture:{type:"t",value:null},srcTexelSize:{type:"v2",value:new ve(1/512,1/512)},aoMap:{type:"t",value:null},samplesOffsets:{type:"fv1",value:qk},projMatrix:{type:"mat4",value:new Ce},aspectRatio:{type:"f",value:0},tanHalfFOV:{type:"f",value:0},fogNearFar:{type:"v2",value:new ve(100,100)},fogColor:{type:"v4",value:new ht(0,.5,0,1)}},vertexShader:Ri,fragmentShader:Xk,transparent:!1,depthTest:!1,depthWrite:!1}),r.setValues(n),r}return H(t,[{key:"setValues",value:function(r){if(!(typeof r>"u")){xt(D(t.prototype),"setValues",this).call(this,r);var i={};this.useFog&&(i.USE_FOG=1),this.fogTransparent&&(i.FOG_TRANSPARENT=1),this.defines=i}}}]),t}(Ur);rd.prototype.useFog=!0;rd.prototype.fogTransparent=!1;var $k=`precision highp float;\r
\r
uniform sampler2D srcL;\r
uniform sampler2D srcR;\r
varying vec2 vUv;\r
\r
void main() {\r
  vec4 l = texture2D(srcL, vUv);\r
  vec4 r = texture2D(srcR, vUv);\r
  gl_FragColor = vec4(l.r, r.g, r.b, 1.0);\r
}\r
`;function Zk(a){var e=Kk();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function Kk(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Jk=function(a){re(t,a);var e=Zk(t);function t(){var n;G(this,t),n=e.call(this);var r={uniforms:{srcL:{type:"t",value:null},srcR:{type:"t",value:null}},vertexShader:Ri,fragmentShader:$k,transparent:!1,depthTest:!1,depthWrite:!1};return n.setValues(r),n}return H(t)}(Ur),Qk=function(){function a(){G(this,a),this.position=new b(0,0,0),this.scale=1,this.orientation=new Xt(0,0,0,1)}return H(a,[{key:"set",value:function(t,n,r){this.position=t,this.scale=n,this.orientation=r}}]),a}(),eO=1.5,tO=function(){function a(){G(this,a)}return H(a,[{key:"setup",value:function(t,n){this._startTime=void 0,this._endTime=void 0,this._isPaused=!1,this._srcView=t,this._dstView=n,this._isMoving=!1}},{key:"isMoving",value:function(){return this._isMoving}},{key:"wasStarted",value:function(){return typeof this._startTime<"u"&&typeof this._endTime<"u"}},{key:"start",value:function(){this._startTime=Date.now();var t=Q.now.interpolateViews?eO*1e3:0;this._endTime=this._startTime+t,this._isMoving=!0}},{key:"getCurrentView",value:function(){if(typeof this._srcView>"u"||typeof this._dstView>"u"||!this._isMoving||!this.wasStarted())return{success:!1};var t=this.createView(),n=Date.now();if(n>this._endTime)return t=this._dstView,this.reset(),{success:!0,view:t};var r=(n-this._startTime)/(this._endTime-this._startTime);return t.position.copy(this._srcView.position),t.position.lerp(this._dstView.position,r),t.scale=(1-r)*this._srcView.scale+r*this._dstView.scale,t.orientation.copy(this._srcView.orientation),t.orientation.slerp(this._dstView.orientation,r),{success:!0,view:t}}},{key:"reset",value:function(){this._startTime=this._endTime=0,this._isMoving=!1}},{key:"pause",value:function(){this._isPaused||(this.setup(this.getCurrentView().view,this._dstView),this._isPaused=!0)}},{key:"resume",value:function(){this._isPaused=!1}},{key:"createView",value:function(){return new Qk}}]),a}(),rO=4e3,nO="Cnt";function iO(a,e){for(var t=a.length,n=[],r=0,i=0;i<t;r++,i+=e)n[r]=a.slice(i,i+e);return n}function hn(a,e){this.context=a,this._opts=le.merge({path:"/"},e)}Ao(hn.prototype);hn.prototype.removeCookie=function(a){var e=this._toCount(a),t=this._getSimpleCookie(e);if(!t){this._removeSimpleCookie(a);return}this._removeSimpleCookie(e),t=parseInt(t,10);for(var n=0;n<t;++n)this._removeSimpleCookie(a+n)};hn.prototype.setCookie=function(a,e){this.removeCookie(a),e=encodeURIComponent(e);var t=iO(e,rO-a.length-1),n=t.length;if(n===1){this._setSimpleCookie(a,e);return}var r=this._toCount(a);this._setSimpleCookie(r,n.toString());for(var i=0;i<n;++i)this._setSimpleCookie(a+i,t[i])};hn.prototype.getCookie=function(a){var e=this._toCount(a),t=this._getSimpleCookie(e);if(!t)return this._getSimpleCookie(a);t=parseInt(t,10);for(var n=[],r=0;r<t;++r)n[r]=this._getSimpleCookie(a+r);return n.join("")};hn.prototype._toCount=function(a){return a+nO};hn.prototype._removeSimpleCookie=function(a){document.cookie="".concat(a,"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;")};hn.prototype._getExpirationDate=function(){var a=new Date,e=10;return a.setFullYear(a.getFullYear()+e),a};hn.prototype._setSimpleCookie=function(a,e){document.cookie="".concat(a,"=").concat(e,";expires=").concat(this._getExpirationDate().toUTCString(),";path=").concat(this._opts.path)};hn.prototype._getSimpleCookie=function(a){var e=document.cookie.match(new RegExp("(?:^|; )".concat(a,"=([^;]*)")));return e?decodeURIComponent(e[1]):""};hn.prototype._exists=function(a){return document.cookie.match(new RegExp("(?:^|; )".concat(a,"=([^;]*)")))};function aO(a){function e(s){s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR";var o=null;function l(){o.removeEventListener("end",l),s.textContent="ENTER VR",o=null}function c(u){u.addEventListener("end",l),a._gfx.renderer.xr.setReferenceSpaceType("local"),a._gfx.renderer.xr.setSession(u),s.textContent="EXIT VR",o=u}s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){if(o===null){var u={optionalFeatures:["local-floor","bounded-floor"]};navigator.xr.requestSession("immersive-vr",u).then(c),a.moveSceneBehindHeadset()}else o.end()}}function t(s){s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.textContent="VR NOT FOUND",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function n(s){s.style.position="absolute",s.style.bottom="20px",s.style.padding="12px 6px",s.style.border="1px solid #fff",s.style.borderRadius="4px",s.style.background="transparent",s.style.color="#fff",s.style.font="normal 13px sans-serif",s.style.textAlign="center",s.style.opacity="0.5",s.style.outline="none",s.style.zIndex="999"}if("xr"in navigator){var r=document.createElement("button");return r.style.display="none",n(r),navigator.xr.isSessionSupported("immersive-vr").then(function(s){return s?e(r):t(r)}),r}var i=document.createElement("a");return i.href="https://webvr.info",i.innerHTML="WEBXR NOT SUPPORTED",i.style.left="calc(50% - 90px)",i.style.width="180px",i.style.textDecoration="none",n(i),i}var sO=function(){function a(e){G(this,a),this._mainCamera=new Bt,this._button=null,this._onToggle=e,this._molContainer=new Je.RCGroup,this._user=new Je.RCGroup,this._scalingPivot=new lt,this._user.add(this._scalingPivot),this._controller1=null,this._controller2=null,this._pressedGripsCounter=0,this._distance=0,this._gfx=null}return H(a,[{key:"startScalingByControllers",value:function(){this._distance=this._controller1.position.distanceTo(this._controller2.position),Je.getMiddlePoint(this._controller1.position,this._controller2.position,this._scalingPivot.position),this._scalingPivot.scale.set(1,1,1),this._scalingPivot.updateMatrix(),this._scalingPivot.updateMatrixWorld(),this._scalingPivot.addSavingWorldTransform(this._molContainer)}},{key:"stopScalingByControllers",value:function(){this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsDown",value:function(t){this._pressedGripsCounter++,this._pressedGripsCounter===2?this.startScalingByControllers():this._pressedGripsCounter===1&&t.target.addSavingWorldTransform(this._molContainer)}},{key:"handleGripsUp",value:function(t){if(this._pressedGripsCounter--,this._pressedGripsCounter===1){this.stopScalingByControllers();var n=t.target===this._controller1?this._controller2:this._controller1;n.addSavingWorldTransform(this._molContainer)}else this._pressedGripsCounter===0&&this._gfx.scene.addSavingWorldTransform(this._molContainer)}},{key:"enable",value:function(t){if(!t){Wt.warn("WebVR couldn't be enabled, because gfx is not defined");return}this._gfx=t;var n=t.renderer,r=t.camera;if(!n)throw new Error("No renderer is available to toggle WebVR");if(!r)throw new Error("No camera is available to toggle WebVR");n.xr.enabled=!0,this._button?this._button.style.display="block":(this._button=aO(this),document.body.appendChild(this._button)),this._mainFog=Q.now.fog,Q.set("fog",!1),this._plugVRNodesIntoScene(t,n),this._setControllersListeners(),this._onToggle&&this._onToggle(!0)}},{key:"_plugVRNodesIntoScene",value:function(t,n){this._mainCamera.copy(t.camera),t.scene.add(this._user),t.scene.add(this._molContainer),this._molContainer.add(t.root),this._controller1=n.xr.getController(0),this._controller2=n.xr.getController(1);var r=this._createControllerMesh();this._controller1.add(r),this._controller2.add(r.clone()),this._user.add(this._controller1),this._user.add(this._controller2)}},{key:"_setControllersListeners",value:function(){var t=this;this._controller1.addEventListener("selectstart",function(n){t.handleGripsDown(n)}),this._controller1.addEventListener("selectend",function(n){t.handleGripsUp(n)}),this._controller2.addEventListener("selectstart",function(n){t.handleGripsDown(n)}),this._controller2.addEventListener("selectend",function(n){t.handleGripsUp(n)}),this._controller1.addEventListener("squeezestart",function(n){t.handleGripsDown(n)}),this._controller1.addEventListener("squeezeend",function(n){t.handleGripsUp(n)}),this._controller2.addEventListener("squeezestart",function(n){t.handleGripsDown(n)}),this._controller2.addEventListener("squeezeend",function(n){t.handleGripsUp(n)})}},{key:"disable",value:function(){if(this._gfx){var t=this._gfx,n=t.renderer,r=t.camera;if(!n)throw new Error("No renderer is available to toggle WebVR");n.setAnimationLoop(null);var i=n.xr.getSession();i&&i.end(),n.xr.enabled=!1,this._button&&(this._button.style.display="none"),Q.set("fog",this._mainFog),this._unplugVRNodesFromScene(r),this._onToggle&&this._onToggle(!1)}}},{key:"_unplugVRNodesFromScene",value:function(t){this._mainCamera&&t&&t.copy(this._mainCamera);var n=this._molContainer.children[0];n&&this._gfx.scene.add(n),this._molContainer.parent.remove(this._molContainer),this._user&&this._gfx.scene.remove(this._user),this._molContainer=null,this._user=null,this._scalingPivot=null,this._user=null,this._controller1=null,this._controller2=null}},{key:"_createControllerMesh",value:function(){var t=new wo(.04,.04,.3),n=new Mn;n.setValues({lights:!1,overrideColor:!0}),n.setUberOptions({fixedColor:new ze(4474111)}),n.updateUniforms();var r=new ft(t,n);return r.rotateX(-Math.PI/2),r}},{key:"updateMoleculeScale",value:function(){if(!(!this._controller1||!this._controller2)){var t=this;if(t._pressedGripsCounter===2){Je.getMiddlePoint(t._controller1.position,t._controller2.position,t._scalingPivot.position);var n=t._controller1.position.distanceTo(t._controller2.position),r=n/t._distance;t._scalingPivot.scale.multiplyScalar(r),t._distance=n}}}},{key:"moveSceneBehindHeadset",value:function(){var t=this._gfx,n=t.camera,r=this._molContainer;r.matrix.identity(),r.position.set(0,0,-4),r.updateMatrix(),r.matrixWorld.multiplyMatrices(n.matrixWorld,r.matrix),t.scene.addSavingWorldTransform(r),this._onToggle&&this._onToggle(!0)}},{key:"getCanvas",value:function(){var t=this._gfx;return t&&t.renderer?t.renderer.domElement:null}}]),a}(),oO=`precision highp float;\r
\r
varying vec2 vUv;\r
uniform sampler2D srcTex;\r
uniform vec3 aberration;\r
\r
void main() {\r
  vec2 uv = vUv * 2.0 - 1.0;\r
  \r
  gl_FragColor.r = texture2D(srcTex, 0.5 * (uv * aberration[0] + 1.0)).r;\r
  gl_FragColor.g = texture2D(srcTex, 0.5 * (uv * aberration[1] + 1.0)).g;\r
  gl_FragColor.b = texture2D(srcTex, 0.5 * (uv * aberration[2] + 1.0)).b;\r
  gl_FragColor.a = 1.0;\r
}`;function lO(a){var e=cO();return function(){var n=D(a),r;if(e){var i=D(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return ue(this,r)}}function cO(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Wl=qe.selectors,uO=qe.Atom,fO=qe.Residue,hO=qe.Chain,dO=qe.Molecule,Pt={COMPLEX:0,COMPONENT:1,FRAGMENT:2},jf="Could not find suitable loader for this source",pO="Could not find suitable parser for this source",Xl=Se.createElement;function mO(a,e,t){a.near=e-t*Q.now.fogNearFactor,a.far=e+t*Q.now.fogFarFactor}function uv(a){var e=a.lastIndexOf(".");return e>=0&&(a=a.substr(0,e)),a}function vO(a){var e=!1;return a.forEachComponent(function(t){t.forEachResidue(function(n){n._isValid&&(e=!0)})}),e}function fv(a,e,t){var n=100;t!==void 0?a.debug("".concat(e,"... ").concat(Math.floor(t*n),"%")):a.debug("".concat(e,"..."))}function jl(){return Q.now.fogColorEnable?Q.now.fogColor:Q.now.bg.color}function uf(a,e){for(var t=a;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(e)}function hv(a){return a.getExtension("EXT_frag_depth")}function dv(a){return a.getExtension("WEBGL_depth_texture")&&a.getExtension("WEBGL_draw_buffers")}var gO=/^(?:(pdb|cif|mmtf|ccp4|dsn6):\s*)?(\d[a-z\d]{3})$/i,_O=/^(?:pc|pubchem):\s*([a-z]+)$/i,yO=/^([a-z][a-z\d\-+.]*):/i;function xO(a,e){if(!le.isString(a))return a;var t=gO.exec(a);if(t){var n=Lt(t,3),r=n[1],i=r===void 0?"pdb":r,s=n[2];switch(i=i.toLowerCase(),s=s.toUpperCase(),i){case"pdb":a="https://files.rcsb.org/download/".concat(s,".pdb");break;case"cif":a="https://files.rcsb.org/download/".concat(s,".cif");break;case"mmtf":a="https://mmtf.rcsb.org/v1.0/full/".concat(s);break;case"ccp4":a="https://www.ebi.ac.uk/pdbe/coordinates/files/".concat(s.toLowerCase(),".ccp4");break;case"dsn6":a="https://edmaps.rcsb.org/maps/".concat(s.toLowerCase(),"_2fofc.dsn6");break;default:throw new Error("Unexpected data format shortcut")}return e.fileType=i,e.fileName="".concat(s,".").concat(i),e.sourceType="url",a}var o=_O.exec(a);if(o){var l=o[1].toLowerCase();return a="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/".concat(l,"/JSON?record_type=3d"),e.fileType="pubchem",e.fileName="".concat(l,".json"),e.sourceType="url",a}return(e.sourceType==="url"||e.sourceType===void 0)&&(e.sourceType="url",yO.test(a)||(a=Se.resolveURL(a))),a}function SO(a){var e=a.binary;if(a.fileType!==void 0){var t=le.head(vi.parsers.find({format:a.fileType}));if(t)e=t.binary||!1;else throw new Error("Could not find suitable parser for this format")}if(e===void 0&&a.fileExt!==void 0){var n=le.head(vi.parsers.find({ext:a.fileExt}));n&&(e=n.binary||!1)}a.fileExt!==void 0&&a.fileExt.toLowerCase()===".man"&&(a.binary=!0,a.animation=!0),e!==void 0&&a.binary!==void 0&&a.binary!==e&&a.context.logger.warn("Overriding incorrect binary mode"),a.binary=e||!1}function bO(a,e,t){return new Promise(function(n){if(t.shouldCancel())throw new Error("Operation cancelled");t.notify({type:"fetching"}),a=xO(a,e);var r=le.head(vi.loaders.find({type:e.sourceType,source:a}));if(!r)throw new Error(jf);var i=e.fileName||r.extractName(a);if(i){var s=Se.splitFileName(i),o=Lt(s,2),l=o[0],c=o[1];le.defaults(e,{name:l,fileExt:c,fileName:i})}SO(e);var u=le.get(e,"preset.expression");if(!le.isUndefined(u)&&(u=JSON.parse(u),u&&u.settings))for(var f=["singleUnit"],h=0,d=f.length;h<d;++h){var p=f[h],v=le.get(u.settings,p);le.isUndefined(v)||Q.set(p,v)}var _=new r(a,e);_.context=e.context,t.addEventListener("cancel",function(){return _.abort()}),_.addEventListener("progress",function(g){g.lengthComputable&&g.total>0?fv(_.logger,"Fetching",g.loaded/g.total):fv(_.logger,"Fetching")}),console.time("fetch");var m=_.load().then(function(g){return console.timeEnd("fetch"),e.context.logger.info("Fetching finished"),t.notify({type:"fetchingDone",data:g}),g}).catch(function(g){throw console.timeEnd("fetch"),e.context.logger.debug(g.message),g.stack&&e.context.logger.debug(g.stack),e.context.logger.error("Fetching failed"),t.notify({type:"fetchingDone",error:g}),g});n(m)})}function wO(a,e,t){if(t.shouldCancel())return Promise.reject(new Error("Operation cancelled"));t.notify({type:"parsing"});var n=le.head(vi.parsers.find({format:e.fileType,ext:e.fileExt,data:a}));if(!n)return Promise.reject(new Error("Could not find suitable parser"));var r=new n(a,e);return r.context=e.context,t.addEventListener("cancel",function(){return r.abort()}),console.time("parse"),r.parse().then(function(i){return console.timeEnd("parse"),t.notify({type:"parsingDone",data:i}),i}).catch(function(i){throw console.timeEnd("parse"),e.error=i,e.context.logger.debug(i.message),i.stack&&e.context.logger.debug(i.stack),e.context.logger.error("Parsing failed"),t.notify({type:"parsingDone",error:i}),i})}function MO(a,e){return a.mask&1<<e}function EO(a,e){return e.selector.includesAtom(a)}var vr=function(a){re(t,a);var e=lO(t);function t(n){var r;G(this,t),r=e.call(this),r._opts=le.merge({settingsCookie:"settings",cookiePath:"/"},n),r._gfx=null,r._interpolator=new tO,r._container=n&&n.container||document.getElementById("miew-container")||le.head(document.getElementsByClassName("miew-container"))||document.body,r._containerRoot=r._container,r._running=!1,r._halting=!1,r._building=!1,r._needRender=!0,r._hotKeysEnabled=!0,r.settings=Q;var i=Wt;i.console=!1,i.level="info",r.logger=i,r._cookies=new hn(qr(r)),r.restoreSettings(),n&&n.settings&&r.settings.set(n.settings),r._spinner=null,r._loading=[],r._animInterval=null,r._visuals={},r._curVisualName=null,r._objects=[],r._sourceWindow=null,r.reset(),r._repr&&i.debug("Selected ".concat(r._repr.mode.name," mode with ").concat(r._repr.colorer.name," colorer."));var s=qr(r);return t.registeredPlugins.forEach(function(o){o.call(s)}),r._initOnSettingsChanged(),r.shadowMatrix=new Ce,r.direction=new b,r.OBB={center:new b,halfSize:new b},r._bSphereForOneVisual=new Lr,r._bBoxForOneVisual=new Vt,r._bBox=new Vt,r._invMatrix=new Ce,r._points=[new b,new b,new b,new b],r._anaglyphMat=new Jk,r._size=new ve,r._scene=new pi,r._camera=new ls(-1,1,1,-1,-500,1e3),r._material=new Ur({uniforms:{srcTex:{type:"t",value:null},aberration:{type:"fv3",value:new b(1)}},vertexShader:Ri,fragmentShader:oO,transparent:!1,depthTest:!1,depthWrite:!1}),r._geo=Je.buildDistorionMesh(10,10,Q.now.debug.stereoBarrel),r._outlineMaterial=new Xf({depth:!0}),r.pars={minFilter:It,magFilter:It,format:Ft},r.VERSION="0.10.0+20220125.134627.b36f6a2-mod",r}return H(t,[{key:"getMaxRepresentationCount",value:function(){return gn.NUM_REPRESENTATION_BITS}},{key:"_updateShadowCamera",value:function(){this._gfx.scene.updateMatrixWorld();for(var r=0;r<this._gfx.scene.children.length;r++)if(this._gfx.scene.children[r].type==="DirectionalLight"){var i=this._gfx.scene.children[r];this.shadowMatrix.copy(i.shadow.camera.matrixWorldInverse),this.getOBB(this.shadowMatrix,this.OBB),this.direction.subVectors(i.target.position,i.position),i.position.subVectors(this.OBB.center,this.direction),i.target.position.copy(this.OBB.center),i.shadow.bias=.09,i.shadow.camera.bottom=-this.OBB.halfSize.y,i.shadow.camera.top=this.OBB.halfSize.y,i.shadow.camera.right=this.OBB.halfSize.x,i.shadow.camera.left=-this.OBB.halfSize.x,i.shadow.camera.near=this.direction.length()-this.OBB.halfSize.z,i.shadow.camera.far=this.direction.length()+this.OBB.halfSize.z,i.shadow.camera.updateProjectionMatrix()}}},{key:"init",value:function(){var r=this._container,i=Se.createElement("div",{class:"miew-canvas"});uf(r,i),this._container=i;var s=document.createDocumentFragment();if(s.appendChild(this._msgMode=Xl("div",{class:"mode-message overlay"},Xl("p",{},"COMPONENT EDIT MODE"))),s.appendChild(this._msgAtomInfo=Xl("div",{class:"atom-info overlay"},Xl("p",{},""))),r.appendChild(s),this._gfx!==null)return!0;var o=this;this._showMessage("Viewer is being initialized...");try{this._initGfx(),this._initListeners(),this._spinner=new pC({lines:13,length:28,width:14,radius:42,color:"#fff",zIndex:700}),window.top.addEventListener("keydown",function(f){o._onKeyDown(f)}),window.top.addEventListener("keyup",function(f){o._onKeyUp(f)}),this._objectControls=new st(this._gfx.root,this._gfx.pivot,this._gfx.camera,this._gfx.renderer.domElement,function(){return o._getAltObj()}),this._objectControls.addEventListener("change",function(f){switch(Q.now.shadow.on&&o._updateShadowCamera(),f.action){case"rotate":o.dispatchEvent({type:"rotate",quaternion:f.quaternion});break;case"zoom":o.dispatchEvent({type:"zoom",factor:f.factor});break;default:o.dispatchEvent({type:f.action})}o.dispatchEvent({type:"transform"}),o._needRender=!0});var l=this._gfx;this._picker=new Tr(l.root,l.camera,l.renderer.domElement),this._picker.addEventListener("newpick",function(f){o._onPick(f)}),this._picker.addEventListener("dblclick",function(f){o.center(f)})}catch(f){if(f.name==="TypeError"&&f.message==="Cannot read property 'getExtension' of null")this._showMessage("Could not create WebGL context.");else if(f.message.search(/webgl/i)>1)this._showMessage(f.message);else throw this._showMessage("Viewer initialization failed."),f;return!1}var c=this._opts&&this._opts.load;if(c){var u=this._opts&&this._opts.type;this.load(c,{fileType:u,keepRepsInfo:!0})}return!0}},{key:"term",value:function(){this._showMessage("Viewer has been terminated."),this._loading.forEach(function(r){r.cancel()}),this._loading.length=0,this.halt(),this._gfx=null}},{key:"_showMessage",value:function(r){var i=document.createElement("div");i.setAttribute("class","miew-message"),i.appendChild(document.createElement("p")).appendChild(document.createTextNode(r)),uf(this._container,i)}},{key:"_showCanvas",value:function(){uf(this._container,this._gfx.renderer.domElement)}},{key:"_requestAnimationFrame",value:function(r){var i=this._gfx.renderer.xr;if(i&&i.enabled){this._gfx.renderer.setAnimationLoop(r);return}requestAnimationFrame(r)}},{key:"_initGfx",value:function(){var r={width:this._container.clientWidth,height:this._container.clientHeight},i={preserveDrawingBuffer:!0,alpha:!0,premultipliedAlpha:!1};Q.now.antialias&&(i.antialias=!0),r.renderer2d=new lk,r.renderer=new pg(i),r.renderer.shadowMap.enabled=Q.now.shadow.on,r.renderer.shadowMap.autoUpdate=!1,r.renderer.shadowMap.type=Qf,A_.init(r.renderer),hv(r.renderer.getContext())||Q.set("zSprites",!1),dv(r.renderer.getContext())||Q.set("ao",!1),r.renderer.autoClear=!1,r.renderer.setPixelRatio(window.devicePixelRatio),r.renderer.setSize(r.width,r.height),r.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent),r.renderer.clearColor(),r.renderer2d.setSize(r.width,r.height),r.camera=new Bt(Q.now.camFov,r.width/r.height,Q.now.camNear,Q.now.camFar),r.camera.setMinimalFov(Q.now.camFov),r.camera.position.z=Q.now.camDistance,r.camera.updateProjectionMatrix(),r.camera.layers.set(Je.LAYERS.DEFAULT),r.camera.layers.enable(Je.LAYERS.VOLUME),r.camera.layers.enable(Je.LAYERS.VOLUME_BFPLANE),r.stereoCam=new Bg,r.scene=new pi;var s=jl();r.scene.fog=new lo(s,Q.now.camNear,Q.now.camFar),r.root=new Je.RCGroup,r.scene.add(r.root),r.pivot=new Je.RCGroup,r.root.add(r.pivot),r.selectionScene=new pi,r.selectionRoot=new nr,r.selectionRoot.matrixAutoUpdate=!1,r.selectionScene.add(r.selectionRoot),r.selectionPivot=new nr,r.selectionPivot.matrixAutoUpdate=!1,r.selectionRoot.add(r.selectionPivot);var o=new Og(16777215,.45);o.position.set(0,.414,1),o.layers.enable(Je.LAYERS.TRANSPARENT),o.castShadow=!0,o.shadow.bias=.09,o.shadow.radius=Q.now.shadow.radius,o.shadow.camera.layers.set(Je.LAYERS.SHADOWMAP);var l=r.renderer.getPixelRatio(),c=Math.max(r.width,r.height)*l;o.shadow.mapSize.width=c,o.shadow.mapSize.height=c,o.target.position.set(0,0,0),r.scene.add(o),r.scene.add(o.target);var u=new Dg(6710886);u.layers.enable(Je.LAYERS.TRANSPARENT),r.scene.add(u),r.axes=new uk(r.root,r.camera);var f=r.width*l,h=r.height*l;r.offscreenBuf=new Gt(f,h,{minFilter:pt,magFilter:It,format:Ft,depthBuffer:!0}),r.renderer.getContext().getExtension("WEBGL_depth_texture")&&(r.offscreenBuf.depthTexture=new yg,r.offscreenBuf.depthTexture.type=io),r.offscreenBuf2=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,depthBuffer:!1}),r.offscreenBuf3=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,depthBuffer:!1}),r.offscreenBuf4=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,depthBuffer:!1}),r.volBFTex=r.offscreenBuf3,r.volFFTex=r.offscreenBuf4,r.volWFFTex=r.offscreenBuf,r.renderer.getContext().getExtension("OES_texture_float")?(r.offscreenBuf5=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,type:yn,depthBuffer:!1}),r.offscreenBuf6=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,type:yn,depthBuffer:!1}),r.offscreenBuf7=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,type:yn,depthBuffer:!0}),r.volBFTex=r.offscreenBuf5,r.volFFTex=r.offscreenBuf6,r.volWFFTex=r.offscreenBuf7):this.logger.warn("Device doesn't support OES_texture_float extension"),r.stereoBufL=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,depthBuffer:!1}),r.stereoBufR=new Gt(f,h,{minFilter:pt,magFilter:pt,format:Ft,depthBuffer:!1}),this._gfx=r,this._showCanvas(),this._embedWebXR(Q.now.stereo==="WEBVR"),this._container.appendChild(r.renderer2d.getElement());var d=new yC;d.domElement.style.position="absolute",d.domElement.style.right="0",d.domElement.style.bottom="0",this._container.appendChild(d.domElement),this._fps=d,this._fps.show(Q.now.fps)}},{key:"_initListeners",value:function(){var r=this;window.addEventListener("resize",function(){r._onResize()})}},{key:"_makeUniqueVisualName",value:function(r){if(!r)return Math.random().toString();for(var i=r,s=1;this._visuals.hasOwnProperty(i);)i="".concat(r," (").concat(s.toString(),")"),s++;return i}},{key:"_addVisual",value:function(r){if(!r)return null;var i=this._makeUniqueVisualName(r.name);return r.name=i,this._visuals[i]=r,this._gfx.pivot.add(r),r.getSelectionGeo&&this._gfx.selectionPivot.add(r.getSelectionGeo()),i}},{key:"_removeVisual",value:function(r){var i="",s=null;r instanceof go?(i=r.name,s=r):typeof r=="string"&&(i=r,s=this._visuals[i]),!(!s||!this._visuals.hasOwnProperty(i)||this._visuals[i]!==s)&&(i===this._curVisualName&&(this._curVisualName=void 0),delete this._visuals[i],s.release(),this._needRender=!0)}},{key:"_forEachVisual",value:function(r){for(var i in this._visuals)this._visuals.hasOwnProperty(i)&&r(this._visuals[i])}},{key:"_releaseAllVisuals",value:function(){if(!(!this._gfx||!this._gfx.pivot)){for(var r in this._visuals)this._visuals.hasOwnProperty(r)&&this._visuals[r].release();this._visuals={}}}},{key:"_forEachComplexVisual",value:function(r){if(!(!this._gfx||!this._gfx.pivot))for(var i in this._visuals)this._visuals.hasOwnProperty(i)&&this._visuals[i]instanceof gn&&r(this._visuals[i])}},{key:"_getComplexVisual",value:function(r){r=r||this._curVisualName;var i=null,s=null;return this._forEachComplexVisual(function(o){i=o,o.name===r&&(s=o)}),s||i}},{key:"_getVolumeVisual",value:function(){var r=null;return this._forEachVisual(function(i){i instanceof Qu&&(r=i)}),r}},{key:"_getVisualForComplex",value:function(r){if(!r)return null;var i=null;return this._forEachComplexVisual(function(s){s.getComplex()===r&&(i=s)}),i}},{key:"getVisuals",value:function(){return Object.keys(this._visuals)}},{key:"getComplexVisualsCount",value:function(){var r=0;return this._forEachComplexVisual(function(){return r++}),r}},{key:"getCurrentVisual",value:function(){return this._curVisualName}},{key:"setCurrentVisual",value:function(r){this._visuals[r]&&(this._curVisualName=r)}},{key:"run",value:function(){var r=this;if(!this._running){if(this._running=!0,this._halting){this._halting=!1;return}this._objectControls.enable(!0),this._interpolator.resume(),this._requestAnimationFrame(function(){return r._onTick()})}}},{key:"halt",value:function(){this._running&&(this._discardComponentEdit(),this._discardFragmentEdit(),this._objectControls.enable(!1),this._interpolator.pause(),this._halting=!0)}},{key:"enableHotKeys",value:function(r){this._hotKeysEnabled=r,this._objectControls.enableHotkeys(r)}},{key:"_onResize",value:function(){this._needRender=!0;var r=this._gfx;r.width=this._container.clientWidth,r.height=this._container.clientHeight,r.camera.aspect=r.width/r.height,r.camera.setMinimalFov(Q.now.camFov),r.camera.updateProjectionMatrix(),r.renderer.setSize(r.width,r.height),r.renderer2d.setSize(r.width,r.height),this.dispatchEvent({type:"resize"})}},{key:"_resizeOffscreenBuffers",value:function(r,i,s){var o=this._gfx;s=s||"NONE";var l=s==="NONE"||s==="ANAGLYPH",c=l?1:.5;o.offscreenBuf.setSize(c*r,i),o.offscreenBuf2.setSize(c*r,i),o.offscreenBuf3.setSize(c*r,i),o.offscreenBuf4.setSize(c*r,i),o.offscreenBuf5&&o.offscreenBuf5.setSize(c*r,i),o.offscreenBuf6&&o.offscreenBuf6.setSize(c*r,i),o.offscreenBuf7&&o.offscreenBuf7.setSize(c*r,i),l&&(o.stereoBufL.setSize(r,i),o.stereoBufR.setSize(r,i))}},{key:"_onTick",value:function(){var r=this;if(this._halting){this._running=!1,this._halting=!1;return}this._fps.update(),this._requestAnimationFrame(function(){return r._onTick()}),this._onUpdate(),this._needRender&&(this._onRender(),this._needRender=!Q.now.suspendRender||Q.now.stereo==="WEBVR")}},{key:"_getBSphereRadius",value:function(){var r=0;return this._forEachVisual(function(i){r=Math.max(r,i.getBoundaries().boundingSphere.radius)}),r*this._objectControls.getScale()}},{key:"getOBB",value:function(r,i){var s=this;this._bBox.makeEmpty(),this._forEachVisual(function(f){s._bSphereForOneVisual.copy(f.getBoundaries().boundingSphere),s._bSphereForOneVisual.applyMatrix4(f.matrixWorld).applyMatrix4(r),s._bSphereForOneVisual.getBoundingBox(s._bBoxForOneVisual),s._bBox.union(s._bBoxForOneVisual)}),this._bBox.getCenter(i.center),this._invMatrix.copy(r).invert(),i.center.applyMatrix4(this._invMatrix);var o=this._bBox.min,l=this._bBox.max;this._points[0].set(o.x,o.y,o.z),this._points[1].set(l.x,o.y,o.z),this._points[2].set(o.x,l.y,o.z),this._points[3].set(o.x,o.y,l.z);for(var c=0,u=this._points.length;c<u;c++)this._points[c].applyMatrix4(this._invMatrix);i.halfSize.set(Math.abs(this._points[0].x-this._points[1].x),Math.abs(this._points[0].y-this._points[2].y),Math.abs(this._points[0].z-this._points[3].z)).multiplyScalar(.5)}},{key:"_updateFog",value:function(){var r=this._gfx;if(Q.now.fog){if(typeof r.scene.fog>"u"||r.scene.fog===null){var i=jl();r.scene.fog=new lo(i),this._setUberMaterialValues({fog:Q.now.fog})}mO(r.scene.fog,r.camera.position.z,this._getBSphereRadius())}else r.scene.fog&&(r.scene.fog=void 0,this._setUberMaterialValues({fog:Q.now.fog}))}},{key:"_onUpdate",value:function(){this.isScriptingCommandAvailable!==void 0&&this.isScriptingCommandAvailable()&&!this._building&&this.callNextCmd(),this._objectControls.update(),this._forEachComplexVisual(function(r){r.getComplex().update()}),Q.now.autobuild&&!this._loading.length&&!this._building&&this._needRebuild()&&this.rebuild(),!this._loading.length&&!this._building&&!this._needRebuild()&&this._updateView(),this._updateFog(),this._gfx.renderer.xr.enabled&&this.webVR.updateMoleculeScale()}},{key:"_onRender",value:function(){var r=this._gfx;r.scene.updateMatrixWorld(),r.camera.updateMatrixWorld(),this._clipPlaneUpdateValue(this._getBSphereRadius()),this._fogFarUpdateValue(),r.renderer.setRenderTarget(null),r.renderer.clear(),this._renderFrame(Q.now.stereo)}},{key:"_renderFrame",value:function(r){var i=this._gfx,s=i.renderer;s.getSize(this._size),r!=="NONE"&&(i.camera.focus=i.camera.position.z,i.stereoCam.aspect=1,r==="ANAGLYPH"?i.stereoCam.update(i.camera):i.stereoCam.updateHalfSized(i.camera,Q.now.camFov));var o=i.renderer.getPixelRatio();switch(this._resizeOffscreenBuffers(this._size.width*o,this._size.height*o,r),this._renderShadowMap(),r){case"WEBVR":case"NONE":this._renderScene(i.camera,!1);break;case"SIMPLE":case"DISTORTED":s.setScissorTest(!0),s.setScissor(0,0,this._size.width/2,this._size.height),s.setViewport(0,0,this._size.width/2,this._size.height),this._renderScene(this._gfx.stereoCam.cameraL,r==="DISTORTED"),s.setScissor(this._size.width/2,0,this._size.width/2,this._size.height),s.setViewport(this._size.width/2,0,this._size.width/2,this._size.height),this._renderScene(this._gfx.stereoCam.cameraR,r==="DISTORTED"),s.setScissorTest(!1);break;case"ANAGLYPH":this._renderScene(this._gfx.stereoCam.cameraL,!1,i.stereoBufL),this._renderScene(this._gfx.stereoCam.cameraR,!1,i.stereoBufR),s.setRenderTarget(null),this._anaglyphMat.uniforms.srcL.value=i.stereoBufL.texture,this._anaglyphMat.uniforms.srcR.value=i.stereoBufR.texture,i.renderer.renderScreenQuad(this._anaglyphMat);break}i.renderer2d.render(i.scene,i.camera),Q.now.axes&&i.axes&&!i.renderer.xr.enabled&&i.axes.render(s)}},{key:"_onBgColorChanged",value:function(){var r=this._gfx,i=jl();r&&(r.scene.fog&&r.scene.fog.color.set(i),r.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent)),this._needRender=!0}},{key:"_onFogColorChanged",value:function(){var r=this._gfx,i=jl();r&&r.scene.fog&&r.scene.fog.color.set(i),this._needRender=!0}},{key:"_setUberMaterialValues",value:function(r){this._gfx.root.traverse(function(i){(i instanceof ft||i instanceof Gr||i instanceof ea)&&i.material instanceof Mn&&(i.material.setValues(r),i.material.needsUpdate=!0)})}},{key:"_enableMRT",value:function(r,i,s){var o=this._gfx,l=o.renderer.getContext(),c=l.getExtension("WEBGL_draw_buffers"),u=o.renderer.properties;if(!r){c.drawBuffersWEBGL([l.COLOR_ATTACHMENT0,null]);return}o.renderer.setRenderTarget(s);var f=u.get(s.texture).__webglTexture;l.bindTexture(l.TEXTURE_2D,f),o.renderer.setRenderTarget(i);var h=u.get(i).__webglFramebuffer,d=u.get(i.texture).__webglTexture;l.bindFramebuffer(l.FRAMEBUFFER,h),h.width=i.width,h.height=i.height,l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,d,0),l.framebufferTexture2D(l.FRAMEBUFFER,c.COLOR_ATTACHMENT1_WEBGL,l.TEXTURE_2D,f,0),c.drawBuffersWEBGL([l.COLOR_ATTACHMENT0,c.COLOR_ATTACHMENT1_WEBGL])}},{key:"_renderScene",value:function(r,i,s){i=i||!1,s=s||null;var o=this._gfx;if(o.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent),o.renderer.setRenderTarget(s),o.renderer.clear(),o.renderer.xr.enabled){o.renderer.render(o.scene,r);return}o.renderer.setClearColor(0,0),o.renderer.setRenderTarget(o.offscreenBuf4),o.renderer.clearColor(),o.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent),o.renderer.setRenderTarget(o.offscreenBuf),o.renderer.clear();var l=this._getComplexVisual()!==null,c=this._getVolumeVisual(),u=l&&Q.now.ao;u&&this._enableMRT(!0,o.offscreenBuf,o.offscreenBuf4),Q.now.transparency==="prepass"?this._renderWithPrepassTransparency(r,o.offscreenBuf):Q.now.transparency==="standard"&&(o.renderer.setRenderTarget(o.offscreenBuf),o.renderer.render(o.scene,r)),u&&this._enableMRT(!1,null,null);var f=l&&Q.now.outline.on,h=l&&Q.now.fxaa,d=c!==null&&c.getMesh().material!=null,p=u||f||d||h||i?o.offscreenBuf2:s,v=o.offscreenBuf;u?(this._performAO(v,o.offscreenBuf4,o.offscreenBuf.depthTexture,p,o.offscreenBuf3,o.offscreenBuf2),!h&&!i&&!d&&!f&&(v=p,p=s,o.renderer.setRenderTarget(p),o.renderer.renderScreenQuadFromTex(v.texture,1))):(o.renderer.setRenderTarget(p),o.renderer.renderScreenQuadFromTex(v.texture,1)),f&&(v=p,p=d||h||i?o.offscreenBuf3:s,v!=null&&this._renderOutline(r,o.offscreenBuf,v,p)),this._renderSelection(r,o.offscreenBuf,p),d&&(o.renderer.setRenderTarget(o.offscreenBuf),o.renderer.renderScreenQuadFromTex(p.texture,1),p=o.offscreenBuf,this._renderVolume(c,r,p,o.volBFTex,o.volFFTex,o.volWFFTex),!h&&!i&&(o.renderer.setRenderTarget(s),o.renderer.renderScreenQuadFromTex(p.texture,1))),v=p,h&&(p=i?o.offscreenBuf4:s,this._performFXAA(v,p),v=p),i&&(p=s,this._performDistortion(v,p,!0))}},{key:"_performDistortion",value:function(r,i,s){this._scene.add(new jr.Mesh(this._geo,this._material)),this._gfx.renderer.setRenderTarget(i),this._gfx.renderer.clear(),s?(this._material.uniforms.srcTex.value=r.texture,this._material.uniforms.aberration.value.set(.995,1,1.01),this._gfx.renderer.render(this._scene,this._camera)):this._gfx.renderer.renderScreenQuadFromTexWithDistortion(r,Q.now.debug.stereoBarrel)}},{key:"_renderOutline",value:function(r,i,s,o){var l=this,c=l._gfx;this._outlineMaterial.uniforms.srcTex.value=s.texture,this._outlineMaterial.uniforms.srcDepthTex.value=i.depthTexture,this._outlineMaterial.uniforms.srcTexSize.value.set(i.width,i.height),this._outlineMaterial.uniforms.color.value=new ze(Q.now.outline.color),this._outlineMaterial.uniforms.threshold.value=Q.now.outline.threshold,this._outlineMaterial.uniforms.thickness.value=new ve(Q.now.outline.thickness,Q.now.outline.thickness),c.renderer.setRenderTarget(o),c.renderer.renderScreenQuad(this._outlineMaterial)}},{key:"_renderShadowMap",value:function(){if(Q.now.shadow.on){var r=this._gfx,i=r.renderer.getRenderTarget(),s=r.renderer.getActiveCubeFace(),o=r.renderer.getActiveMipmapLevel(),l=r.renderer.state;l.setBlending(zn),l.buffers.color.setClear(1,1,1,1),l.buffers.depth.setTest(!0),l.setScissorTest(!1);for(var c=0;c<r.scene.children.length;c++)if(r.scene.children[c].type==="DirectionalLight"){var u=r.scene.children[c];u.shadow.map==null&&(u.shadow.map=new Gt(u.shadow.mapSize.width,u.shadow.mapSize.height,this.pars),u.shadow.camera.updateProjectionMatrix()),u.shadow.updateMatrices(u),r.renderer.setRenderTarget(u.shadow.map),r.renderer.clear(),r.renderer.render(r.scene,u.shadow.camera)}r.renderer.setRenderTarget(i,s,o)}}},{key:"_hasSelectionToRender",value:function(){for(var r=this._gfx.selectionPivot,i=0;i<r.children.length;i++){var s=r.children[i];if(s.children.length>0)return!0}return!1}},{key:"_renderSelection",value:function(r,i,s){var o=new Xf,l=this,c=l._gfx;c.renderer.setClearColor("black",0),c.renderer.setRenderTarget(i),c.renderer.clear(!0,!1,!1),l._hasSelectionToRender()?(c.selectionRoot.matrix=c.root.matrix,c.selectionPivot.matrix=c.pivot.matrix,c.renderer.render(c.selectionScene,r)):c.renderer.renderDummyQuad(),c.renderer.setRenderTarget(s),c.renderer.renderScreenQuadFromTex(i.texture,.6),o.uniforms.srcTex.value=i.texture,o.uniforms.srcTexSize.value.set(i.width,i.height),c.renderer.renderScreenQuad(o)}},{key:"_checkVolumeRenderingSupport",value:function(r){if(!r)return!1;var i=this._gfx,s=i.renderer.getRenderTarget();i.renderer.setRenderTarget(r);var o=i.renderer.getContext(),l=o.checkFramebufferStatus(o.FRAMEBUFFER);return i.renderer.setRenderTarget(s),l!==o.FRAMEBUFFER_COMPLETE?(this.logger.warn("Device doesn't support electron density rendering"),!1):!0}},{key:"_renderVolume",value:function(r,i,s,o,l,c){var u=new dc.BackFacePosMaterial,f=new dc.FrontFacePosMaterial,h=new Ce().makeTranslation(.5,.5,.5),d=new Ce,p,v=this._gfx;if(typeof p>"u"&&(p=this._checkVolumeRenderingSupport(o)),!!p){var _=r.getMesh();_.rebuild(v.camera),v.renderer.setClearColor("black",0),v.renderer.setRenderTarget(o),v.renderer.clear(),v.renderer.setRenderTarget(l),v.renderer.clear(),v.renderer.setRenderTarget(c),v.renderer.clear(),v.renderer.setRenderTarget(o),i.layers.set(Je.LAYERS.VOLUME_BFPLANE),v.renderer.render(v.scene,i),i.layers.set(Je.LAYERS.VOLUME),v.scene.overrideMaterial=u,v.renderer.render(v.scene,i),v.renderer.setRenderTarget(l),i.layers.set(Je.LAYERS.VOLUME),v.scene.overrideMaterial=f,v.renderer.render(v.scene,i),v.scene.overrideMaterial=null,i.layers.set(Je.LAYERS.DEFAULT),d.copy(_.matrixWorld).invert(),Mn.prototype.uberOptions.world2colorMatrix.multiplyMatrices(h,d),i.layers.set(Je.LAYERS.COLOR_FROM_POSITION),v.renderer.setRenderTarget(c),v.renderer.render(v.scene,i);var m=_.material;m.uniforms._BFRight.value=o.texture,m.uniforms._FFRight.value=l.texture,m.uniforms._WFFRight.value=c.texture,i.layers.set(Je.LAYERS.VOLUME),v.renderer.setRenderTarget(s),v.renderer.render(v.scene,i),i.layers.set(Je.LAYERS.DEFAULT)}}},{key:"_renderWithPrepassTransparency",value:function(r,i){var s=this._gfx;s.renderer.setRenderTarget(i),r.layers.set(Je.LAYERS.DEFAULT),s.renderer.render(s.scene,r),r.layers.set(Je.LAYERS.PREPASS_TRANSPARENT),s.renderer.getContext().colorMask(!1,!1,!1,!1),s.renderer.render(s.scene,r),s.renderer.getContext().colorMask(!0,!0,!0,!0),r.layers.set(Je.LAYERS.TRANSPARENT),s.renderer.render(s.scene,r),r.layers.set(Je.LAYERS.DEFAULT)}},{key:"_performFXAA",value:function(r,i){var s=new c0;if(!(typeof r>"u"||typeof i>"u")){var o=this._gfx;o.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent),o.renderer.setRenderTarget(i),o.renderer.clear(),s.uniforms.srcTex.value=r.texture,s.uniforms.srcTexelSize.value.set(1/r.width,1/r.height),s.uniforms.bgColor.value.set(Q.now.bg.color),s.bgTransparent!==Q.now.bg.transparent&&(s.setValues({bgTransparent:Q.now.bg.transparent}),s.needsUpdate=!0),o.renderer.renderScreenQuad(s)}}},{key:"_performAO",value:function(r,i,s,o,l,c){var u=new zk,f=new Wk,h=new rd,d=new b;if(!(!r||!i||!s||!o||!l||!c)){var p=this._gfx,v=Math.tan(Vn.DEG2RAD*.5*p.camera.fov);u.uniforms.diffuseTexture.value=r.texture,u.uniforms.depthTexture.value=s,u.uniforms.normalTexture.value=i.texture,u.uniforms.srcTexelSize.value.set(1/r.width,1/r.height),u.uniforms.camNearFar.value.set(p.camera.near,p.camera.far),u.uniforms.projMatrix.value=p.camera.projectionMatrix,u.uniforms.aspectRatio.value=p.camera.aspect,u.uniforms.tanHalfFOV.value=v,p.root.matrix.extractScale(d),u.uniforms.kernelRadius.value=Q.now.debug.ssaoKernelRadius*d.x,u.uniforms.depthThreshold.value=2*this._getBSphereRadius(),u.uniforms.factor.value=Q.now.debug.ssaoFactor,p.renderer.setRenderTarget(c),p.renderer.renderScreenQuad(u),f.uniforms.aoMap.value=c.texture,f.uniforms.srcTexelSize.value.set(1/c.width,1/c.height),f.uniforms.depthTexture.value=s,p.renderer.setRenderTarget(l),p.renderer.renderScreenQuad(f),h.uniforms.aoMap.value=l.texture,h.uniforms.diffuseTexture.value=r.texture,h.uniforms.srcTexelSize.value.set(1/l.width,1/l.height),h.uniforms.depthTexture.value=s,h.uniforms.projMatrix.value=p.camera.projectionMatrix,h.uniforms.aspectRatio.value=p.camera.aspect,h.uniforms.tanHalfFOV.value=v;var _=p.scene.fog;_&&(h.uniforms.fogNearFar.value.set(_.near,_.far),h.uniforms.fogColor.value.set(_.color.r,_.color.g,_.color.b,Q.now.fogAlpha)),(h.useFog!==Q.now.fog||h.fogTransparent!==Q.now.bg.transparent)&&(h.setValues({useFog:Q.now.fog,fogTransparent:Q.now.bg.transparent}),h.needsUpdate=!0),p.renderer.setRenderTarget(o),p.renderer.renderScreenQuad(h)}}},{key:"reset",value:function(){this._picker&&this._picker.reset(),this._lastPick=null,this._releaseAllVisuals(),this._setEditMode(Pt.COMPLEX),this._resetObjects(),this._gfx&&(Je.clearTree(this._gfx.pivot),this._gfx.renderer2d.reset()),this.setNeedRender()}},{key:"_resetScene",value:function(){this._objectControls.reset(),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.resetReps(),this.resetPivot(),this.rebuildAll()}},{key:"resetView",value:function(){this._picker&&this._picker.reset(),this._setEditMode(Pt.COMPLEX),this._resetScene(),this._forEachComplexVisual(function(r){r.updateSelectionMask({}),r.rebuildSelectionGeometry()})}},{key:"_export",value:function(r){var i=le.head(vi.exporters.find({format:r}));if(!i)return this.logger.error("Could not find suitable exporter for this source"),Promise.reject(new Error("Could not find suitable exporter for this source"));if(this.dispatchEvent({type:"exporting"}),this._visuals[this._curVisualName]instanceof gn){var s=null;i.SourceClass===gn?s=this._visuals[this._curVisualName]:i.SourceClass===Co&&(s=this._visuals[this._curVisualName]._complex);var o=new i(s,{miewVersion:t.VERSION});return o.export().then(function(l){return l})}return this._visuals[this._curVisualName]instanceof Qu?Promise.reject(new Error("Sorry, exporter for volume data not implemented yet")):Promise.reject(new Error("Unexpected format of data"))}},{key:"load",value:function(r,i){var s=this;i=le.merge({},i,{context:this}),this.settings.now.use.multiFile||(this._loading.length&&(this._loading.forEach(function(c){c.cancel()}),this._loading.length=0),i.animation||this.reset(!0)),this._interpolator.reset(),this.dispatchEvent({type:"loading",options:i,source:r});var o=new KC;this._loading.push(o),o.addEventListener("notification",function(c){s.dispatchEvent(c.slaveEvent)}),this._spinner.spin(this._container);var l=function(u){var f=s._loading.indexOf(o);return f!==-1&&s._loading.splice(f,1),s._spinner.stop(),s._refreshTitle(),o.notify({type:"loadingDone",anything:u}),u};return bO(r,i,o).then(function(c){return wO(c,i,o)}).then(function(c){var u=s._onLoad(c,i);return l(u)}).catch(function(c){throw s.logger.error("Could not load data"),s.logger.debug(c),l(c)})}},{key:"unload",value:function(r){this._removeVisual(r||this.getCurrentVisual()),this.resetPivot(),Q.now.shadow.on&&this._updateShadowCamera()}},{key:"_startAnimation",value:function(r){this._stopAnimation();var i=this,s=this._getComplexVisual();if(s===null){this.logger.error("Unable to start animation - no molecule is loaded.");return}try{this._frameInfo=new o0(s.getComplex(),r,{onLoadStatusChanged:function(){i.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:i._isAnimating,isLoading:i._frameInfo?i._frameInfo.isLoading:!0}})},onError:function(l){i._stopAnimation(),i.logger.error(l)}})}catch{this.logger.error("Animation file does not fit to current complex!");return}this._continueAnimation()}},{key:"_pauseAnimation",value:function(){this._animInterval!==null&&(this._isAnimating=!1,clearInterval(this._animInterval),this._animInterval=null,this._frameInfo&&this.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:this._isAnimating,isLoading:this._frameInfo.isLoading}}))}},{key:"_continueAnimation",value:function(){this._isAnimating=!0;var r=1e3/Q.now.maxfps;r=Number.isNaN(r)?0:r;var i=this,s=i._gfx.pivot,o=this._getComplexVisual();o&&(o.resetSelectionMask(),o.rebuildSelectionGeometry(),this._msgAtomInfo.style.opacity=0),this._animInterval=setInterval(function(){if(i.dispatchEvent({type:"mdPlayerStateChanged",state:{isPlaying:i._isAnimating,isLoading:i._frameInfo.isLoading}}),i._frameInfo.frameIsReady){s.updateToFrame(i._frameInfo),i._updateObjsToFrame(i._frameInfo),i._refreshTitle(" Frame ".concat(i._frameInfo._currFrame," of ").concat(i._frameInfo._framesCount," time interval - ").concat(i._frameInfo._timeStep));try{i._frameInfo.nextFrame()}catch{i.logger.error("Error during animation"),i._stopAnimation();return}i._needRender=!0}},r)}},{key:"_stopAnimation",value:function(){this._animInterval!==null&&(clearInterval(this._animInterval),this._frameInfo.disableEvents(),this._frameInfo=null,this._animInterval=null,this.dispatchEvent({type:"mdPlayerStateChanged",state:null}))}},{key:"_onLoad",value:function(r,i){var s=this._gfx,o=null;if(i.animation)return this._refreshTitle(),this._startAnimation(r),null;if(this._stopAnimation(),(!i||!i.keepRepsInfo)&&(this._opts.reps=null,this._opts._objects=null),r.id==="Complex"){var l=r;i.fileName?l.name=l.name||uv(i.fileName).toUpperCase():i.amberFileName?l.name=l.name||uv(i.amberFileName).toUpperCase():l.name="Dynamic ".concat(i.fileType," molecule"),o=this._addVisual(new gn(l.name,l)),this._curVisualName=o;var c=this.info();if(this.logger.info("Parsed ".concat(i.fileName," (").concat(c.atoms," atoms, ").concat(c.bonds," bonds, ").concat(c.residues," residues, ").concat(c.chains," chains).")),le.isNumber(this._opts.unit)&&l.setCurrentUnit(this._opts.unit),!i.preset)if(Q.now.autoPreset)switch(i.fileType){case"cml":this.resetReps("small");break;case"pdb":case"mmtf":case"cif":vO(l)?this.resetReps("macro"):this.resetReps("small");break;default:this.resetReps("default");break}else this.resetReps("default")}else r.id==="Volume"&&(this.resetEd(),o=this._onLoadEd(r));return s.camera.updateProjectionMatrix(),this._updateFog(),s.root.resetTransform(),this.resetPivot(),this._objectControls.setScale(Q.now.radiusToFit/this._getBSphereRadius()),this._resetObjects(),Q.now.autoResolution&&this._tweakResolution(),Q.now.shadow.on&&this._updateShadowCamera(),this._opts.view&&(this.view(this._opts.view),delete this._opts.view),this._refreshTitle(),o}},{key:"resetEd",value:function(){this._edLoader&&(this._edLoader.abort(),this._edLoader=null),this._removeVisual(this._getVolumeVisual()),this._needRender=!0}},{key:"loadEd",value:function(r){var i=this;this.resetEd();var s=le.head(vi.loaders.find({source:r}));if(!s)return this.logger.error(jf),Promise.reject(new Error(jf));var o=this._edLoader=new s(r,{binary:!0});return o.context=this,o.load().then(function(l){var c=le.head(vi.parsers.find({format:"ccp4"}));if(!c)throw new Error(pO);var u=new c(l);return u.context=i,u.parse().then(function(f){i._onLoadEd(f)})}).catch(function(l){i.logger.error("Could not load ED data"),i.logger.debug(l)})}},{key:"_onLoadEd",value:function(r){r.normalize();var i=new Qu("volume",r);i.getMesh().layers.set(Je.LAYERS.VOLUME);var s=this._addVisual(i);return this._needRender=!0,s}},{key:"_needRebuild",value:function(){var r=!1;return this._forEachComplexVisual(function(i){r=r||i.needsRebuild()}),r}},{key:"_rebuildObjects",value:function(){var r=this,i=this._gfx,s,o,l=[];for(s=0;s<i.pivot.children.length;++s){var c=i.pivot.children[s];c instanceof go||l.push(c)}for(s=0;s<l.length;++s)l[s].parent.remove(l[s]);setTimeout(function(){var u=r._objects;for(s=0,o=u.length;s<o;++s){var f=u[s];f.needsRebuild&&f.build(),f.getGeometry()&&i.pivot.add(f.getGeometry())}},10)}},{key:"changeUnit",value:function(r,i){var s=this._getComplexVisual(i);if(!s)throw new Error("There is no complex to change!");function o(){var l=s?s.getComplex().getCurrentUnit():0,c=l>0?"Bio molecule ".concat(l):"Asymmetric unit";return"Current unit: ".concat(l," (").concat(c,")")}return r===void 0||(le.isString(r)&&(r=Math.max(parseInt(r,10),0)),s.getComplex().setCurrentUnit(r)&&(this._resetScene(),this._updateInfoPanel())),o()}},{key:"rebuild",value:function(){var r=this;if(this._building){this.logger.warn("Miew.rebuild(): already building!");return}this._building=!0,this.dispatchEvent({type:"rebuilding"}),this._rebuildObjects(),this._gfx.renderer2d.reset();var i=[];this._forEachComplexVisual(function(o){o.needsRebuild()&&i.push(o.rebuild().then(function(){return new Promise(function(l){o.rebuildSelectionGeometry(),l()})}))});var s=this;this._spinner.spin(this._container),Promise.all(i).then(function(){s._spinner.stop(),s._needRender=!0,s._refreshTitle(),r.dispatchEvent({type:"buildingDone"}),s._building=!1})}},{key:"rebuildAll",value:function(){this._forEachComplexVisual(function(r){r.setNeedsRebuild()})}},{key:"_refreshTitle",value:function(r){var i;r=r===void 0?"":r;var s=this._getComplexVisual();if(s){i=s.getComplex().name;var o=s.repGet(s.repCurrent());i+=o?"  ".concat(o.mode.name," Mode"):""}else i=Object.keys(this._visuals).length>0?"Unknown":"No Data";i+=r,this.dispatchEvent({type:"titleChanged",data:i})}},{key:"setNeedRender",value:function(){this._needRender=!0}},{key:"_extractRepresentation",value:function(){var r=this,i=[];this._forEachComplexVisual(function(s){if(s.getSelectionCount()!==0){var o=s.buildSelectorFromMask(1<<s.getSelectionBit()),l=Q.now.presets.default,c=s.repAdd({selector:o,mode:l[0].mode.id,colorer:l[0].colorer.id,material:l[0].material.id});if(!c){s.repCount()===gn.NUM_REPRESENTATION_BITS&&r.logger.warn("Number of representations is limited to ".concat(gn.NUM_REPRESENTATION_BITS));return}r.dispatchEvent({type:"repAdded",index:c.index,name:s.name}),s.repCurrent(c.index),i.push(s.name)}}),i.length>0&&this.logger.report("New representation from selection for complexes: ".concat(i.join(", ")))}},{key:"_setReps",value:function(r){r=r||this._opts&&this._opts.reps||[],this._forEachComplexVisual(function(i){return i.resetReps(r)})}},{key:"applyPreset",value:function(r){for(var i=Q.now.presets,s=[r||Q.defaults.preset,Q.defaults.preset,Object.keys(i)[0]],o=null,l=0;!o&&l<s.length;++l)Q.set("preset",s[l]),o=i[Q.now.preset],o||this.logger.warn('Unknown preset "'.concat(Q.now.preset,'"'));this._setReps(o)}},{key:"resetReps",value:function(r){var i=this._opts&&this._opts.reps;i?this._setReps(i):this.applyPreset(r)}},{key:"repCount",value:function(r){var i=this._getComplexVisual(r);return i?i.repCount():0}},{key:"repCurrent",value:function(r,i){var s=this._getComplexVisual(i),o=s?s.repCurrent(r):-1;return r&&o!==r&&this.logger.warn("Representation ".concat(r," was not found. Current rep remains unchanged.")),o}},{key:"rep",value:function(r,i){var s=this._getComplexVisual("");if(!s)return null;var o=s.rep(r,i);return o.status==="created"?this.dispatchEvent({type:"repAdded",index:o.index,name:s.name}):o.status==="changed"&&this.dispatchEvent({type:"repChanged",index:o.index,name:s.name}),o.desc}},{key:"repGet",value:function(r,i){var s=this._getComplexVisual(i);return s?s.repGet(r):null}},{key:"repAdd",value:function(r,i){var s=this._getComplexVisual(i);if(!s)return-1;var o=s.repAdd(r);return o?(this.dispatchEvent({type:"repAdded",index:o.index,name:i}),o.index):-1}},{key:"repRemove",value:function(r,i){var s=this._getComplexVisual(i);s&&(s.repRemove(r),this.dispatchEvent({type:"repRemoved",index:r,name:i}))}},{key:"repHide",value:function(r,i,s){this._needRender=!0;var o=this._getComplexVisual(s);return o?o.repHide(r,i):null}},{key:"_setEditMode",value:function(r){this._editMode=r;var i=this._msgMode;if(i&&(i.style.opacity=r===Pt.COMPLEX?0:1,r!==Pt.COMPLEX)){var s=i.getElementsByTagName("p")[0];s.innerHTML=r===Pt.COMPONENT?"COMPONENT EDIT MODE":"FRAGMENT EDIT MODE"}this.dispatchEvent({type:"editModeChanged",data:r===Pt.COMPLEX})}},{key:"_enterComponentEditMode",value:function(){if(this._editMode===Pt.COMPLEX){var r=[];this._forEachComplexVisual(function(i){var s=i.beginComponentEdit();s&&r.push(s)}),r!==[]&&(this._editors=r,this.logger.info("COMPONENT EDIT MODE -- ON"),this._setEditMode(Pt.COMPONENT),this._objectControls.keysTranslateObj(!0))}}},{key:"_applyComponentEdit",value:function(){if(this._editMode===Pt.COMPONENT){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var r=0;r<this._editors.length;++r)this._editors[r].apply();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (applied)"),this._setEditMode(Pt.COMPLEX),this.rebuildAll()}}},{key:"_discardComponentEdit",value:function(){if(this._editMode===Pt.COMPONENT){this._objectControls.stop(),this._objectControls.keysTranslateObj(!1);for(var r=0;r<this._editors.length;++r)this._editors[r].discard();this._editors=[],this.logger.info("COMPONENT EDIT MODE -- OFF (discarded)"),this._setEditMode(Pt.COMPLEX),this._needRender=!0,this.rebuildAll()}}},{key:"_enterFragmentEditMode",value:function(){if(this._editMode===Pt.COMPLEX){var r=[];if(this._forEachComplexVisual(function(s){s instanceof gn&&s.getSelectionCount()>0&&r.push(s)}),r.length===1){var i=r[0].beginFragmentEdit();i&&(this._editors=[i],this.logger.info("FRAGMENT EDIT MODE -- ON (single bond)"),this._setEditMode(Pt.FRAGMENT),this._objectControls.allowTranslation(!1),this._objectControls.allowAltObjFreeRotation(i.isFreeRotationAllowed()),this._needRender=!0)}}}},{key:"_applyFragmentEdit",value:function(){if(this._editMode===Pt.FRAGMENT){this._objectControls.stop();for(var r=0;r<this._editors.length;++r)this._editors[r].apply();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (applied)"),this._setEditMode(Pt.COMPLEX),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this.rebuildAll()}}},{key:"_discardFragmentEdit",value:function(){if(this._editMode===Pt.FRAGMENT){this._objectControls.stop();for(var r=0;r<this._editors.length;++r)this._editors[r].discard();this._editors=[],this.logger.info("FRAGMENT EDIT MODE -- OFF (discarded)"),this._setEditMode(Pt.COMPLEX),this._objectControls.allowTranslation(!0),this._objectControls.allowAltObjFreeRotation(!0),this._needRender=!0}}},{key:"_onPick",value:function(r){if(!Q.now.picking||this._animInterval!==null||this._editMode===Pt.FRAGMENT||this._objectControls.isEditingAltObj())return;var i=null;r.obj.atom?(i=r.obj.atom.residue.getChain().getComplex(),this._lastPick=r.obj.atom):r.obj.residue?(i=r.obj.residue.getChain().getComplex(),this._lastPick=r.obj.residue):r.obj.chain?(i=r.obj.chain.getComplex(),this._lastPick=r.obj.chain):r.obj.molecule?(i=r.obj.molecule.complex,this._lastPick=r.obj.molecule):this._lastPick=null;function s(l){l.updateSelectionMask(r.obj),l.rebuildSelectionGeometry()}if(i){var o=this._getVisualForComplex(i);o&&(s(o),this._needRender=!0)}else this._forEachComplexVisual(s),this._needRender=!0;this._updateInfoPanel(),this.dispatchEvent(r)}},{key:"_onKeyDown",value:function(r){if(!(!this._running||!this._hotKeysEnabled))switch(r.keyCode){case 67:Q.now.editing&&this._enterComponentEditMode();break;case 70:Q.now.editing&&this._enterFragmentEditMode();break;case 65:switch(this._editMode){case Pt.COMPONENT:this._applyComponentEdit();break;case Pt.FRAGMENT:this._applyFragmentEdit();break}break;case 68:switch(this._editMode){case Pt.COMPONENT:this._discardComponentEdit();break;case Pt.FRAGMENT:this._discardFragmentEdit();break}break;case 83:r.preventDefault(),r.stopPropagation(),Q.set("ao",!Q.now.ao),this._needRender=!0;break;case 107:r.preventDefault(),r.stopPropagation(),this._forEachComplexVisual(function(i){i.expandSelection(),i.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0;break;case 109:r.preventDefault(),r.stopPropagation(),this._forEachComplexVisual(function(i){i.shrinkSelection(),i.rebuildSelectionGeometry()}),this._updateInfoPanel(),this._needRender=!0;break}}},{key:"_onKeyUp",value:function(r){!this._running||!this._hotKeysEnabled||r.keyCode===88&&this._extractRepresentation()}},{key:"_updateInfoPanel",value:function(){var r=this._msgAtomInfo.getElementsByTagName("p")[0],i,s,o=0;for(this._forEachComplexVisual(function(d){o+=d.getSelectionCount()});r.firstChild;)r.removeChild(r.firstChild);if(o===0){this._msgAtomInfo.style.opacity=0;return}var l="".concat(String(o)," atom").concat(o!==1?"s":""," selected");this._lastPick!==null&&(l+=", the last pick:");var c="",u="",f="";if(this._lastPick instanceof uO){i=this._lastPick,s=i.residue,u=i.name;var h=i.location!==32?String.fromCharCode(i.location):"";c="".concat(i.element.fullName," #").concat(i.serial).concat(h,":       ").concat(s._chain._name,".").concat(s._type._name).concat(s._sequence).concat(s._icode.trim(),"."),c+=u,f="Coord: (".concat(i.position.x.toFixed(2).toString(),",     ").concat(i.position.y.toFixed(2).toString(),",     ").concat(i.position.z.toFixed(2).toString(),")")}else this._lastPick instanceof fO?(s=this._lastPick,c="".concat(s._type._fullName,":       ").concat(s._chain._name,".").concat(s._type._name).concat(s._sequence).concat(s._icode.trim())):this._lastPick instanceof hO?c="chain ".concat(this._lastPick._name):this._lastPick instanceof dO&&(c="molecule ".concat(this._lastPick._name));r.appendChild(document.createTextNode(l)),c!==""&&(r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(c))),f!==""&&(r.appendChild(document.createElement("br")),r.appendChild(document.createTextNode(f))),this._msgAtomInfo.style.opacity=1}},{key:"_getAltObj",value:function(){if(this._editors){for(var r=null,i=0;i<this._editors.length;++i){var s=this._editors[i].getAltObj();if(s.objects.length>0){if(r){r=null;break}r=s}}if(r)return r}return{objects:[],pivot:new b(0,0,0)}}},{key:"resetPivot",value:function(){var r=new Vt,i=new b;r.makeEmpty(),this._forEachVisual(function(s){r.union(s.getBoundaries().boundingBox)}),r.getCenter(i),this._objectControls.setPivot(i.negate()),this.dispatchEvent({type:"transform"})}},{key:"setPivotResidue",value:function(r){var i=new b,s=this._getVisualForComplex(r.getChain().getComplex());if(s){if(r._controlPoint)i.copy(r._controlPoint);else{for(var o=0,l=0,c=0,u=r._atoms.length,f=0;f<u;++f){var h=r._atoms[f].position;o+=h.x/u,l+=h.y/u,c+=h.z/u}i.set(o,l,c)}i.applyMatrix4(s.matrix).negate(),this._objectControls.setPivot(i),this.dispatchEvent({type:"transform"})}}},{key:"setPivotAtom",value:function(r){var i=new b,s=this._getVisualForComplex(r.residue.getChain().getComplex());s&&(i.copy(r.position),i.applyMatrix4(s.matrix).negate(),this._objectControls.setPivot(i),this.dispatchEvent({type:"transform"}))}},{key:"getSelectionCenter",value:function(r,i,s){var o=new b(0,0,0);r.set(0,0,0);var l=0;return this._forEachComplexVisual(function(c){c.getSelectionCenter(o,i,s||c.getSelectionBit())&&(r.add(o),l++)}),l===0?!1:(r.divideScalar(l),r.negate(),!0)}},{key:"setPivotSubset",value:function(r){var i=new b(0,0,0),s=r?EO:MO;this.getSelectionCenter(i,s,r)?(this._objectControls.setPivot(i),this.dispatchEvent({type:"transform"})):this.logger.warn("selection is empty. Center operation not performed")}},{key:"screenshot",value:function(r,i){var s=this._gfx,o=s.renderer.domElement.width,l=s.renderer.domElement.height;function c(y){return Math.tan(Vn.degToRad(.5*y))}function u(y){return Vn.radToDeg(Math.atan(y))*2}function f(){var y,x=Se.getBrowser();if(x===Se.browserType.SAFARI){var S=document.createElement("canvas"),M=S.getContext("2d");S.width=r===void 0?o:r,S.height=i===void 0?l:i,M.drawImage(s.renderer.domElement,0,0,S.width,S.height),y=S.toDataURL("image/png")}else y=s.renderer.domElement.toDataURL("image/png");return y}i=i||r;var h;if(r===void 0&&i===void 0||r===o&&i===l)h=f();else{var d=s.camera.aspect,p=s.camera.fov,v=c(s.camera.fov),_=Math.min(s.width,s.height),m=v*_/s.height,g=r/i;s.renderer.setPixelRatio(1),s.camera.aspect=g,s.camera.fov=u(m/Math.min(g,1)),s.camera.updateProjectionMatrix(),s.renderer.setDrawingBufferSize(r,i,1),this._renderFrame(Q.now.stereo),h=f(),s.renderer.setPixelRatio(window.devicePixelRatio),s.camera.aspect=d,s.camera.fov=p,s.camera.updateProjectionMatrix(),s.renderer.setDrawingBufferSize(s.width,s.height,window.devicePixelRatio),this._needRender=!0}return h}},{key:"screenshotSave",value:function(r,i,s){var o=this.screenshot(i,s);Se.shotDownload(o,r)}},{key:"save",value:function(r){var i=this;this._export(r.fileType).then(function(s){var o=i._visuals[i._curVisualName]._complex.name;Se.download(s,o,r.fileType),i._refreshTitle(),i.dispatchEvent({type:"exportingDone"})}).catch(function(s){i.logger.error("Could not export data"),i.logger.debug(s),i._refreshTitle(),i.dispatchEvent({type:"exportingDone",error:s})})}},{key:"_tweakResolution",value:function(){var r=[["poor",100],["low",500],["medium",1e3],["high",5e3],["ultra",Number.MAX_VALUE]],i=0;if(this._forEachComplexVisual(function(l){i+=l.getComplex().getAtomCount()}),i>0){for(var s=this._gfxScore*1e6/i,o=0;o<r.length;++o)if(s<r[o][1]){this._autoChangeResolution(r[o][0]);break}}}},{key:"_autoChangeResolution",value:function(r){r!==Q.now.resolution&&this.logger.report('Your rendering resolution was changed to "'.concat(r,'" for best performance.')),Q.now.resolution=r}},{key:"saveSettings",value:function(){this._cookies.setCookie(this._opts.settingsCookie,JSON.stringify(this.settings.getDiffs(!0)))}},{key:"restoreSettings",value:function(){try{var r=this._cookies.getCookie(this._opts.settingsCookie),i=r?JSON.parse(r):{};this.settings.applyDiffs(i,!0)}catch(s){this.logger.error("Cookies parse error: ".concat(s.message))}}},{key:"resetSettings",value:function(){this.settings.reset()}},{key:"setOptions",value:function(r){typeof r=="string"&&(r=t.options.fromAttr(r)),r.reps&&(this._opts.reps=null),le.merge(this._opts,r),r.settings&&this.set(r.settings),this._opts._objects=r._objects,this._resetObjects(),r.load&&this.load(r.load,{fileType:r.type}),r.preset&&(Q.now.preset=r.preset),r.reps&&this.resetReps(r.preset),this._opts.view&&(this.view(this._opts.view),delete this._opts.view);var i=this._getComplexVisual();i&&(i.getComplex().resetCurrentUnit(),le.isNumber(r.unit)&&i.getComplex().setCurrentUnit(r.unit),this.resetView(),this.rebuildAll())}},{key:"info",value:function(r){var i=this._getComplexVisual(r);if(!i)return{};var s=i.getComplex(),o=s.metadata;return{id:o.id||s.name||"UNKNOWN",title:o.title&&o.title.join(" ")||"UNKNOWN DATA",atoms:s.getAtomCount(),bonds:s.getBondCount(),residues:s.getResidueCount(),chains:s.getChainCount()}}},{key:"addObject",value:function(r,i){var s=null;if(r.type===_o.prototype.type&&(s=_o),s===null)throw new Error("Unknown scene object type - ".concat(r.type));try{var o=new s(r.params,r.opts);this._addSceneObject(o)}catch(l){if(!i)this.logger.debug("Error during scene object creation: ".concat(l.message));else throw l}this._needRender=!0}},{key:"_addSceneObject",value:function(r){var i=this._getComplexVisual();r.build&&i&&(r.build(i.getComplex()),this._gfx.pivot.add(r.getGeometry()));var s=this._objects;s[s.length]=r}},{key:"_updateObjsToFrame",value:function(r){for(var i=this._objects,s=0,o=i.length;s<o;++s)i[s].updateToFrame&&i[s].updateToFrame(r)}},{key:"_resetObjects",value:function(){var r=this._opts._objects;if(this._objects=[],r)for(var i=0,s=r.length;i<s;++i)this.addObject(r[i],!1)}},{key:"removeObject",value:function(r){var i=this._objects[r];if(!i)throw new Error("Scene object with index ".concat(r," does not exist"));i.destroy(),this._objects.splice(r,1),this._needRender=!0}},{key:"getURL",value:function(r){return Ff.toURL(this.getState(le.defaults(r,{compact:!0,settings:!1,view:!1})))}},{key:"getScript",value:function(r){return Ff.toScript(this.getState(le.defaults(r,{compact:!0,settings:!0,view:!0})))}},{key:"_compareReps",value:function(r,i){var s={},o=0;r&&(o=r.repCount());var l=Q.defaults.presets[Q.now.preset],c=i;l===void 0||l.length>o?(c=!1,s.preset="empty"):Q.now.preset!==Q.defaults.preset&&(s.preset=Q.now.preset);for(var u=[],f=!0,h=0,d=o;h<d;++h)u[h]=r.repGet(h).compare(c?l[h]:null),le.isEmpty(u[h])||(f=!1);return f||(s.reps=u),s}},{key:"getState",value:function(r){var i={};r=le.defaults(r,{compact:!0,settings:!1,view:!1});var s=this._getComplexVisual();if(s!==null){var o=s.getComplex(),l=o.metadata;if(l.id){var c=l.format?"".concat(l.format,":"):"";i.load=c+l.id}var u=o.getCurrentUnit();u!==1&&(i.unit=u)}var f=this._compareReps(s,r.compact);f.preset&&(i.preset=f.preset),f.reps&&(i.reps=f.reps);for(var h=this._objects,d=[],p=0,v=h.length;p<v;++p)d[p]=h[p].identify();if(h.length>0&&(i._objects=d),r.view&&(i.view=this.view()),r.settings){var _=this.settings.getDiffs(!1);le.isEmpty(_)||(i.settings=_)}return i}},{key:"get",value:function(r,i){return Q.get(r,i)}},{key:"_clipPlaneUpdateValue",value:function(r){var i=Math.max(this._gfx.camera.position.z-r*Q.now.draft.clipPlaneFactor,Q.now.camNear),s={clipPlaneValue:i};this._forEachComplexVisual(function(u){u.setUberOptions(s)});for(var o=0,l=this._objects.length;o<l;++o){var c=this._objects[o];c._line&&c._line.material.setUberOptions(s)}this._picker!==null&&(this._picker.clipPlaneValue=i)}},{key:"_fogFarUpdateValue",value:function(){this._picker!==null&&(this._gfx.scene.fog?this._picker.fogFarValue=this._gfx.scene.fog.far:this._picker.fogFarValue=void 0)}},{key:"_updateShadowmapMeshes",value:function(r){this._forEachComplexVisual(function(i){for(var s=i._reprList,o=0,l=s.length;o<l;++o){var c=s[o];r(c.geo,c.material)}})}},{key:"_updateMaterials",value:function(r){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0;this._forEachComplexVisual(function(u){return u.setMaterialValues(r,i,s)});for(var o=0,l=this._objects.length;o<l;++o){var c=this._objects[o];c._line&&(c._line.material.setValues(r),c._line.material.needsUpdate=!0)}}},{key:"_fogAlphaChanged",value:function(){this._forEachComplexVisual(function(r){r.setUberOptions({fogAlpha:Q.now.fogAlpha})})}},{key:"_embedWebXR",value:function(){var r=this;if(Q.now.stereo!=="WEBVR"){this.webVR&&this.webVR.disable(),this.webVR=null;return}this.webVR||(this.webVR=new sO(function(){r._requestAnimationFrame(function(){return r._onTick()}),r._needRender=!0,r._onResize()})),this.webVR.enable(this._gfx)}},{key:"_initOnSettingsChanged",value:function(){var r=this,i=function(o,l){o=le.isArray(o)?o:[o],o.forEach(function(c){r.settings.addEventListener("change:".concat(c),l)})};i("modes.VD.frame",function(){var s=r._getVolumeVisual();s!==null&&(s.showFrame(Q.now.modes.VD.frame),r._needRender=!0)}),i("modes.VD.isoMode",function(){var s=r._getVolumeVisual();s!==null&&(s.getMesh().material.updateDefines(),r._needRender=!0)}),i("bg.color",function(){r._onBgColorChanged()}),i("ao",function(){if(Q.now.ao&&!dv(r._gfx.renderer.getContext()))r.logger.warn("Your device or browser does not support ao"),Q.set("ao",!1);else{var s={normalsToGBuffer:Q.now.ao};r._setUberMaterialValues(s)}}),i("zSprites",function(){Q.now.zSprites&&!hv(r._gfx.renderer.getContext())&&(r.logger.warn("Your device or browser does not support zSprites"),Q.set("zSprites",!1)),r.rebuildAll()}),i("fogColor",function(){r._onFogColorChanged()}),i("fogColorEnable",function(){r._onFogColorChanged()}),i("bg.transparent",function(s){var o=r._gfx;o&&o.renderer.setClearColor(Q.now.bg.color,+!Q.now.bg.transparent),r._updateMaterials({fogTransparent:s.value}),r.rebuildAll()}),i("draft.clipPlane",function(s){r._updateMaterials({clipPlane:s.value}),r.rebuildAll()}),i("shadow.on",function(s){var o={shadowmap:s.value,shadowmapType:Q.now.shadow.type},l=r._gfx;l&&(l.renderer.shadowMap.enabled=!!o.shadowmap),r._updateMaterials(o,!0),o.shadowmap?(r._updateShadowCamera(),r._updateShadowmapMeshes(Ka.createShadowmapMaterial)):r._updateShadowmapMeshes(Ka.removeShadowmapMaterial),r._needRender=!0}),i("shadow.type",function(s){Q.now.shadow.on&&(r._updateMaterials({shadowmapType:s.value},!0),r._needRender=!0)}),i("shadow.radius",function(s){for(var o=0;o<r._gfx.scene.children.length;o++)if(r._gfx.scene.children[o].shadow!==void 0){var l=r._gfx.scene.children[o];l.shadow.radius=s.value,r._needRender=!0}}),i("fps",function(){r._fps.show(Q.now.fps)}),i(["fog","fogNearFactor","fogFarFactor"],function(){r._updateFog(),r._needRender=!0}),i("fogAlpha",function(){var s=Q.now.fogAlpha;(s<0||s>1)&&r.logger.warn("fogAlpha must belong range [0,1]"),r._fogAlphaChanged(),r._needRender=!0}),i("autoResolution",function(s){s.value&&!r._gfxScore&&r.logger.warn("Benchmarks are missed, autoresolution will not work! Autoresolution should be set during miew startup.")}),i("stereo",function(){r._embedWebXR(Q.now.stereo==="WEBVR"),r._needRender=!0}),i(["transparency","palette"],function(){r.rebuildAll()}),i("resolution",function(){r.rebuildAll();var s=r._getVolumeVisual();s&&(s.getMesh().material.updateDefines(),r._needRender=!0)}),i(["axes","fxaa","ao","outline.on","outline.color","outline.threshold","outline.thickness"],function(){r._needRender=!0})}},{key:"set",value:function(r,i){Q.set(r,i)}},{key:"select",value:function(r,i){var s=this._getComplexVisual();if(s){var o=r;le.isString(r)&&(o=Wl.parse(r).selector),s.select(o,i),this._lastPick=null,this._updateInfoPanel(),this._needRender=!0}}},{key:"view",value:function(r){var i="1",s=this,o=this._gfx.pivot,l=[],c="ZXY";function u(){var h=o.position,d=s._objectControls.getScale()/Q.now.radiusToFit,p=new Un;return p.setFromQuaternion(s._objectControls.getOrientation(),c),l=[h.x,h.y,h.z,d,p.x,p.y,p.z],i+Se.arrayToBase64(l,Float32Array)}function f(){r.length===40&&(r="0".concat(r));var h=r[0];if(l=Se.arrayFromBase64(r.substr(1),Float32Array),h!==i)if(h==="0")l[3]/=8;else{s.logger.warn("Encoded view version mismatch, stored as ".concat(h," vs ").concat(i," expected"));return}var d=s._interpolator,p=d.createView();p.position.copy(o.position),p.scale=s._objectControls.getScale(),p.orientation.copy(s._objectControls.getOrientation());var v=d.createView();v.position.set(l[0],l[1],l[2]),s._getComplexVisual()&&v.position.sub(s._getComplexVisual().position),v.scale=l[3],v.orientation.setFromEuler(new Un(l[4],l[5],l[6],c)),d.setup(p,v)}return typeof r>"u"?u():(f(),r)}},{key:"_updateView",value:function(){var r=this,i=this._gfx.pivot,s=this._interpolator;if(s.wasStarted()||s.start(),!!s.isMoving()){var o=s.getCurrentView();if(o.success){var l=o.view;i.position.copy(l.position),r._objectControls.setScale(l.scale*Q.now.radiusToFit),r._objectControls.setOrientation(l.orientation),this.dispatchEvent({type:"transform"}),r._needRender=!0}}}},{key:"translate",value:function(r,i,s){this._objectControls.translatePivot(r,i,s),this.dispatchEvent({type:"transform"}),this._needRender=!0}},{key:"rotate",value:function(r,i,s){this._objectControls.rotate(new Xt().setFromEuler(new Un(r,i,s,"XYZ"))),this.dispatchEvent({type:"transform"}),this._needRender=!0}},{key:"scale",value:function(r){if(r<=0)throw new RangeError("Scale should be greater than zero");this._objectControls.scale(r),this.dispatchEvent({type:"transform"}),this._needRender=!0}},{key:"center",value:function(r){if(r===void 0){this.setPivotSubset(),this._needRender=!0;return}if(r.obj!==void 0&&("atom"in r.obj||"residue"in r.obj)){"atom"in r.obj?this.setPivotAtom(r.obj.atom):this.setPivotResidue(r.obj.residue),this._needRender=!0;return}if(r.obj===void 0&&r!==""){var i=Wl.parse(r);if(i.error===void 0){this.setPivotSubset(i),this._needRender=!0;return}}this.resetPivot(),this._needRender=!0}},{key:"within",value:function(r,i){var s=this._getComplexVisual();if(!s)return Wl.None();r instanceof String&&(r=Wl.parse(r));var o=s.within(r,i);return o&&(s.rebuildSelectionGeometry(),this._needRender=!0),o}},{key:"projected",value:function(r,i){var s=this._getComplexVisual(i);if(!s)return!1;var o=s.getComplex().getAtomByFullname(r);if(o===null)return!1;var l=o.position.clone();return this._gfx.pivot.updateMatrixWorldRecursive(),this._gfx.camera.updateMatrixWorldRecursive(),this._gfx.pivot.localToWorld(l),l.project(this._gfx.camera),{x:(l.x+1)*.5*this._gfx.width,y:(1-l.y)*.5*this._gfx.height}}},{key:"dssp",value:function(r){var i=this._getComplexVisual(r);i&&(i.getComplex().dssp(),i._reprList.forEach(function(s){(s.mode.id==="CA"||s.colorer.id==="SS")&&(s.needsRebuild=!0)}))}},{key:"exportCML",value:function(){var r=this;function i(u){var f=new b,h=new b,d=new b;u.extractBasis(f,h,d),f.normalize(),h.normalize(),d.normalize();var p=new Ce;return p.identity(),p.makeBasis(f,h,d),p}function s(u){var f=r._gfx.root,h=i(f.matrixWorld),d=new ht(0,0,0,0),p=new ht(0,0,0,0),v=null,_=null;u.forEachAtom(function(m){m.xmlNodeRef&&m.xmlNodeRef.xmlNode&&(v=m.xmlNodeRef.xmlNode,_=m.position,d.set(_.x,_.y,_.z,1),d.applyMatrix4(h),v.setAttribute("x3",d.x.toString()),v.setAttribute("y3",d.y.toString()),v.setAttribute("z3",d.z.toString()),v.removeAttribute("x2"),v.removeAttribute("y2"))}),u.forEachSGroup(function(m){if(m.xmlNodeRef&&m.xmlNodeRef.xmlNode){v=m.xmlNodeRef.xmlNode,_=m.getPosition(),d.set(_.x,_.y,_.z,1);var g=m.getCentralPoint();g===null?d.applyMatrix4(h):(p.set(g.x,g.y,g.z,0),d.add(p),d.applyMatrix4(h),p.set(g.x,g.y,g.z,1),p.applyMatrix4(h),d.sub(p)),v.setAttribute("x",d.x.toString()),v.setAttribute("y",d.y.toString()),v.setAttribute("z",d.z.toString())}})}var o=r._getComplexVisual(),l=o?o.getComplex():null;if(l&&l.originalCML){s(l);var c=new XMLSerializer;return c.serializeToString(l.originalCML)}return null}},{key:"motm",value:function(){Q.set({fogColorEnable:!0,fogColor:0,outline:{on:!0,threshold:.01},bg:{color:16777215}}),this._forEachComplexVisual(function(r){for(var i=[],s=r.getComplex(),o=ns.get(Q.now.palette),l=0;l<s.getChainCount();l++){var c=s._chains[l]._name,u=o.getChainColor(c);i[l]={selector:"chain ".concat(c),mode:"VW",colorer:["CB",{color:u,factor:.9}],material:"FL"}}r.resetReps(i)})}}]),t}(gr);le.assign(vr,{VERSION:vr.VERSION,registeredPlugins:[],chem:qe,io:vi,modes:Kl,colorers:Jl,materials:Za,palettes:ns,options:Ff,settings:Q,utils:Se,gfx:{Representation:Uf}});var CO=function(){var a=function(ot,Fe,Xe,$){for(Xe=Xe||{},$=ot.length;$--;Xe[ot[$]]=Fe);return Xe},e=[1,60],t=[1,62],n=[1,63],r=[1,65],i=[1,66],s=[1,67],o=[1,68],l=[1,69],c=[1,80],u=[1,72],f=[1,73],h=[1,74],d=[1,75],p=[1,99],v=[1,76],_=[1,100],m=[1,79],g=[1,51],y=[1,81],x=[1,82],S=[1,84],M=[1,83],E=[1,85],N=[1,96],B=[1,97],V=[1,98],O=[1,86],W=[1,87],z=[1,64],C=[1,70],T=[1,71],A=[1,77],F=[1,78],X=[1,53],Y=[1,54],ne=[1,55],ae=[1,61],xe=[1,88],be=[1,89],ge=[1,90],we=[1,91],q=[1,92],Ge=[1,93],Te=[1,94],Pe=[1,95],Ee=[1,101],_e=[1,102],ie=[1,103],oe=[1,104],K=[1,105],de=[1,56],he=[1,57],I=[1,58],P=[1,59],ee=[1,115],pe=[1,111],Me=[1,114],Re=[1,112],He=[1,113],Oe=[1,118],ke=[1,117],De=[1,134],w=[1,149],L=[1,150],R=[1,157],j=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],U=[5,6,7,9,13,14,15,17,18,19,20,23,25,26,27,30,33,34,35,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,71,72,74,77,78,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,101],me=[5,6,7,9,13,15,17,18,19,20,23,25,26,27,30,33,34,37,38,41,43,45,46,49,52,54,55,56,58,59,62,64,65,66,70,72,82,83,84,85,86,87,88,89,90,91,92,93,94,95],ye=[5,70,72],Ne=[5,74],Ve=[71,101],Ie={trace:function(){},yy:{},symbols_:{error:2,Program:3,Command:4,EOF:5,RESET:6,BUILD:7,ALL:8,HELP:9,Path:10,MOTM:11,OneArgCommand:12,GET:13,STRING:14,SET:15,Value:16,SET_SAVE:17,SET_RESTORE:18,SET_RESET:19,PRESET:20,AddRepresentation:21,EditRepresentation:22,REMOVE:23,RepresentationReference:24,HIDE:25,SHOW:26,LIST:27,EXPAND_KEY:28,SELECTOR_KEY:29,SELECT:30,AS:31,WordAll:32,SELECTOR:33,WITHIN:34,NUMBER:35,OF:36,MATERIAL:37,IDENTIFIER:38,ModeCMD:39,ColorCMD:40,VIEW:41,BASE_64:42,UNIT:43,DSSP:44,SCALE:45,ROTATE:46,AxesList:47,TRANSLATE:48,CENTER:49,GetURLBranch:50,Screenshot:51,LINE:52,ArgList:53,LISTOBJ:54,REMOVEOBJ:55,URL:56,VIEW_KEY:57,SCREENSHOT:58,LOAD:59,Url:60,FILE_KEY:61,ADD:62,Description:63,REP:64,MODE:65,COLOR:66,Descriptor:67,RepresentationOwnProperty:68,RepresentationOwnPropertyOpts:69,DESC_KEY:70,"=":71,DESC_KEY_OPTS:72,AxesArg:73,DESC_KEY_AXES:74,Arg:75,PathWoDescKey:76,HEX:77,BOOL:78,Word:79,CommandSetWoDESC_KEY:80,DescKeys:81,CLEAR:82,FILE_LIST:83,FILE_REGISTER:84,FILE_DELETE:85,PRESET_ADD:86,PRESET_DELETE:87,PRESET_UPDATE:88,PRESET_RENAME:89,PRESET_OPEN:90,CREATE_SCENARIO:91,RESET_SCENARIO:92,DELETE_SCENARIO:93,ADD_SCENARIO_ITEM:94,LIST_SCENARIO:95,PDB_KEY:96,DELAY_KEY:97,PRST_KEY:98,DESCRIPTION_KEY:99,CommandSet:100,".":101,PresetPath:102,"/":103,HexOrNumber:104,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"RESET",7:"BUILD",8:"ALL",9:"HELP",11:"MOTM",13:"GET",14:"STRING",15:"SET",17:"SET_SAVE",18:"SET_RESTORE",19:"SET_RESET",20:"PRESET",23:"REMOVE",25:"HIDE",26:"SHOW",27:"LIST",28:"EXPAND_KEY",29:"SELECTOR_KEY",30:"SELECT",31:"AS",33:"SELECTOR",34:"WITHIN",35:"NUMBER",36:"OF",37:"MATERIAL",38:"IDENTIFIER",41:"VIEW",42:"BASE_64",43:"UNIT",44:"DSSP",45:"SCALE",46:"ROTATE",48:"TRANSLATE",49:"CENTER",52:"LINE",54:"LISTOBJ",55:"REMOVEOBJ",56:"URL",57:"VIEW_KEY",58:"SCREENSHOT",59:"LOAD",61:"FILE_KEY",62:"ADD",64:"REP",65:"MODE",66:"COLOR",70:"DESC_KEY",71:"=",72:"DESC_KEY_OPTS",74:"DESC_KEY_AXES",77:"HEX",78:"BOOL",82:"CLEAR",83:"FILE_LIST",84:"FILE_REGISTER",85:"FILE_DELETE",86:"PRESET_ADD",87:"PRESET_DELETE",88:"PRESET_UPDATE",89:"PRESET_RENAME",90:"PRESET_OPEN",91:"CREATE_SCENARIO",92:"RESET_SCENARIO",93:"DELETE_SCENARIO",94:"ADD_SCENARIO_ITEM",95:"LIST_SCENARIO",96:"PDB_KEY",97:"DELAY_KEY",98:"PRST_KEY",99:"DESCRIPTION_KEY",101:".",103:"/"},productions_:[0,[3,2],[3,1],[4,1],[4,1],[4,2],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,3],[4,3],[4,1],[4,1],[4,1],[4,1],[4,2],[4,1],[4,1],[4,2],[4,2],[4,2],[4,2],[4,1],[4,2],[4,2],[4,2],[4,4],[4,2],[4,6],[4,2],[4,1],[4,1],[4,1],[4,2],[4,2],[4,1],[4,2],[4,1],[4,2],[4,2],[4,2],[4,1],[4,2],[4,1],[4,1],[4,3],[4,3],[4,4],[4,4],[4,1],[4,2],[50,1],[50,2],[50,2],[50,3],[50,3],[51,1],[51,2],[51,3],[12,2],[12,2],[12,2],[21,1],[21,2],[21,2],[21,3],[22,2],[22,3],[39,2],[39,3],[40,2],[40,3],[24,1],[24,1],[63,1],[63,2],[63,3],[63,4],[67,1],[67,1],[67,2],[68,3],[69,3],[47,1],[47,2],[73,2],[53,1],[53,2],[75,3],[16,1],[16,1],[16,1],[16,1],[16,1],[79,1],[79,1],[32,1],[32,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[80,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[81,1],[100,1],[100,1],[76,1],[76,3],[76,3],[10,1],[10,1],[10,3],[10,3],[10,3],[60,1],[102,1],[102,3],[104,1],[104,1]],performAction:function(ot,Fe,Xe,$,nt,Z,ut){var ce=Z.length-1;switch(nt){case 1:return Z[ce-1];case 3:this.$=$.miew.reset(!1),$.ClearContext(),$.miew.resetReps("empty");break;case 4:this.$=$.miew.rebuild();break;case 5:this.$=$.miew.rebuildAll(),$.miew.rebuild();break;case 6:this.$=$.echo($.utils.help().toString());break;case 7:this.$=$.echo($.utils.help(Z[ce]).toString());break;case 8:this.$=$.miew.motm();break;case 10:case 11:this.$=$.utils.propagateProp(Z[ce]),$.echo($.miew.get(Z[ce]).toString());break;case 12:case 13:this.$=$.miew.set(Z[ce-1],$.utils.propagateProp(Z[ce-1],Z[ce]));break;case 14:this.$=$.miew.saveSettings();break;case 15:this.$=$.miew.restoreSettings();break;case 16:this.$=$.miew.resetSettings();break;case 17:this.$=$.miew.resetReps();break;case 18:this.$=$.miew.applyPreset(Z[ce]);break;case 21:this.$=$.miew.repRemove(Z[ce]),$.representations.remove(Z[ce]);break;case 22:this.$=$.miew.repHide(Z[ce]);break;case 23:this.$=$.miew.repHide(Z[ce],!1);break;case 24:this.$=$.echo($.utils.listRep($.miew,$.representations,Z[ce],"-e"));break;case 25:this.$=$.echo($.utils.list($.miew,$.representations));break;case 26:this.$=$.echo($.utils.list($.miew,$.representations,Z[ce]));break;case 27:this.$=$.echo($.utils.listSelector($.miew,$.Context));break;case 28:this.$=$.miew.select($.utils.checkArg(Z[ce-1].toLowerCase(),Z[ce],!0));break;case 29:this.$=$.Context[Z[ce].toLowerCase()]=$.utils.checkArg(Z[ce-3].toLowerCase(),Z[ce-2],!0),$.miew.select($.Context[Z[ce].toLowerCase()]);break;case 30:this.$=$.miew.rep($.miew.repCurrent(),{selector:$.utils.checkArg(Z[ce-1].toLowerCase(),Z[ce])});break;case 31:this.$=$.Context[Z[ce].toLowerCase()]=$.miew.within($.utils.checkArg("select",Z[ce-2],!0),Number(Z[ce-4]));break;case 32:this.$=$.miew.rep($.miew.repCurrent(),{material:$.utils.checkArg(Z[ce-1].toLowerCase(),Z[ce].toUpperCase())});break;case 35:this.$=$.echo($.miew.view());break;case 36:case 37:this.$=$.miew.view(Z[ce]);break;case 38:this.$=$.echo($.miew.changeUnit());break;case 39:this.$=$.echo($.miew.changeUnit(Z[ce]));break;case 40:this.$=$.miew.dssp();break;case 41:this.$=$.miew.scale(Z[ce]);break;case 42:for(var _t=0,Ct=Z[ce].length;_t<Ct;_t++)$.miew.rotate(Z[ce][_t].x*Math.PI/180,Z[ce][_t].y*Math.PI/180,Z[ce][_t].z*Math.PI/180);break;case 43:for(var _t=0,Ct=Z[ce].length;_t<Ct;_t++)$.miew.translate(Z[ce][_t].x||0,Z[ce][_t].y||0,Z[ce][_t].z||0);break;case 44:this.$=$.miew.center();break;case 45:this.$=$.miew.center(Z[ce]);break;case 48:case 49:this.$=$.miew.addObject({type:"line",params:[Z[ce-1],Z[ce]]},!0);break;case 50:case 51:this.$=$.miew.addObject({type:"line",params:[Z[ce-2],Z[ce-1]],opts:Z[ce].toJSO($.utils,"objects","line")},!0);break;case 52:this.$=$.echo($.utils.listObjs($.miew));break;case 53:this.$=$.miew.removeObject(Z[ce]);break;case 54:this.$=$.echo($.miew.getURL({view:!1,settings:!1}));break;case 55:this.$=$.echo($.miew.getURL({view:!1,settings:!0}));break;case 56:this.$=$.echo($.miew.getURL({view:!0,settings:!1}));break;case 57:case 58:this.$=$.echo($.miew.getURL({view:!0,settings:!0}));break;case 59:this.$=$.miew.screenshotSave();break;case 60:this.$=$.miew.screenshotSave("",Number(Z[ce]));break;case 61:this.$=$.miew.screenshotSave("",Number(Z[ce-1]),Number(Z[ce]));break;case 62:case 63:case 64:this.$=$.utils.load($.miew,Z[ce]),$.representations.clear();break;case 65:this.$=$.echo($.representations.add($.miew.repAdd()));break;case 66:this.$=$.echo($.representations.add(Z[ce],$.miew.repAdd()));break;case 67:this.$=$.echo($.representations.add($.miew.repAdd(Z[ce])));break;case 68:this.$=$.echo($.representations.add(Z[ce-1],$.miew.repAdd(Z[ce])));break;case 69:this.$=$.miew.rep(Z[ce]),$.miew.repCurrent(Z[ce]);break;case 70:this.$=$.miew.rep(Z[ce-1],Z[ce]),$.miew.repCurrent(Z[ce-1]);break;case 71:this.$=$.miew.rep($.miew.repCurrent(),{mode:$.utils.checkArg(Z[ce-1].toLowerCase(),Z[ce].toUpperCase())});break;case 72:this.$=$.miew.rep($.miew.repCurrent(),{mode:new Array($.utils.checkArg(Z[ce-2].toLowerCase(),Z[ce-1].toUpperCase()),Z[ce].toJSO($.utils,Z[ce-2],Z[ce-1].toUpperCase()))});break;case 73:this.$=$.miew.rep($.miew.repCurrent(),{colorer:$.utils.checkArg(Z[ce-1].toLowerCase(),Z[ce].toUpperCase())});break;case 74:this.$=$.miew.rep($.miew.repCurrent(),{colorer:new Array($.utils.checkArg(Z[ce-2].toLowerCase(),Z[ce-1].toUpperCase()),Z[ce].toJSO($.utils,Z[ce-2],Z[ce-1].toUpperCase()))});break;case 75:this.$=Number($.representations.get(Z[ce]));break;case 76:case 92:this.$=Number(Z[ce]);break;case 77:this.$=Z[ce];break;case 78:this.$=$.assign(Z[ce-1],Z[ce]);break;case 79:this.$=$.assign(Z[ce-2],Z[ce-1],Z[ce]);break;case 80:this.$=$.assign(Z[ce-3],Z[ce-2],Z[ce-1],Z[ce]);break;case 81:case 82:this.$=$.CreateObjectPair(Z[ce].key,Z[ce].val);break;case 83:this.$=$.CreateObjectPair(Z[ce-1].key,new Array(Z[ce-1].val,Z[ce].toJSO($.utils,Z[ce-1].key,Z[ce-1].val)));break;case 84:case 85:this.$=Object.create({key:$.keyRemap(Z[ce-2]),val:$.utils.checkArg(Z[ce-2],Z[ce])});break;case 86:this.$=[Z[ce]];break;case 87:this.$=Z[ce-1].concat(Z[ce]);break;case 88:this.$=$.CreateObjectPair(Z[ce-1].toLowerCase(),Number(Z[ce]));break;case 89:this.$=new $.ArgList(Z[ce]);break;case 90:this.$=Z[ce-1].append(Z[ce]);break;case 91:this.$=new $.Arg(Z[ce-2],Z[ce]);break;case 93:this.$=parseInt(Z[ce]);break;case 94:this.$=JSON.parse(Z[ce]);break;case 95:case 96:this.$=String(Z[ce]);break;case 157:case 158:case 161:case 162:case 163:this.$=Z[ce-2]+Z[ce-1]+Z[ce];break;case 166:this.$=Z[ce-2]=Z[ce-2]+Z[ce-1]+Z[ce];break}},table:[{3:1,4:2,5:[1,3],6:[1,4],7:[1,5],9:[1,6],11:[1,7],12:8,13:[1,9],15:[1,10],17:[1,11],18:[1,12],19:[1,13],20:[1,14],21:15,22:16,23:[1,17],25:[1,18],26:[1,19],27:[1,20],30:[1,21],33:[1,22],34:[1,23],37:[1,24],39:25,40:26,41:[1,27],43:[1,28],44:[1,29],45:[1,30],46:[1,31],48:[1,32],49:[1,33],50:34,51:35,52:[1,36],54:[1,37],55:[1,38],56:[1,44],58:[1,45],59:[1,39],62:[1,40],64:[1,41],65:[1,42],66:[1,43]},{1:[3]},{5:[1,46]},{1:[2,2]},{5:[2,3]},{5:[2,4],8:[1,47]},{5:[2,6],6:e,7:t,9:n,10:48,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:49,80:52,81:50,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{5:[2,8]},{5:[2,9]},{6:e,7:t,9:n,10:106,13:r,14:[1,107],15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:49,80:52,81:50,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{6:e,7:t,9:n,10:108,13:r,14:[1,109],15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:49,80:52,81:50,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{5:[2,14]},{5:[2,15]},{5:[2,16]},{5:[2,17],14:ee,16:110,35:pe,38:Me,77:Re,78:He},{5:[2,19]},{5:[2,20]},{24:116,35:Oe,38:ke},{24:119,35:Oe,38:ke},{24:120,35:Oe,38:ke},{5:[2,25],24:121,28:[1,122],29:[1,123],35:Oe,38:ke},{14:[1,124]},{14:[1,125]},{35:[1,126]},{38:[1,127]},{5:[2,33]},{5:[2,34]},{5:[2,35],14:[1,128],42:[1,129]},{5:[2,38],35:[1,130]},{5:[2,40]},{35:[1,131]},{47:132,73:133,74:De},{47:135,73:133,74:De},{5:[2,44],14:[1,136]},{5:[2,46]},{5:[2,47]},{6:e,7:t,9:n,10:138,13:r,14:[1,137],15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:49,80:52,81:50,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{5:[2,52]},{35:[1,139]},{14:[1,143],38:[1,141],60:140,61:[1,142]},{5:[2,65],38:[1,144],63:145,67:146,68:147,69:148,70:w,72:L},{24:151,35:Oe,38:ke},{38:[1,152]},{38:[1,153]},{5:[2,54],29:[1,154],57:[1,155]},{5:[2,59],35:[1,156]},{1:[2,1]},{5:[2,5]},{5:[2,7],101:R},a(j,[2,159]),a(j,[2,160]),a(U,[2,97]),a(U,[2,98]),a(j,[2,147]),a(j,[2,148]),a(j,[2,149]),a(j,[2,150]),a(j,[2,151]),a(j,[2,152]),a(j,[2,153]),a(U,[2,101]),a(U,[2,102]),a(U,[2,103]),a(U,[2,104]),a(U,[2,105]),a(U,[2,106]),a(U,[2,107]),a(U,[2,108]),a(U,[2,109]),a(U,[2,110]),a(U,[2,111]),a(U,[2,112]),a(U,[2,113]),a(U,[2,114]),a(U,[2,115]),a(U,[2,116]),a(U,[2,117]),a(U,[2,118]),a(U,[2,119]),a(U,[2,120]),a(U,[2,121]),a(U,[2,122]),a(U,[2,123]),a(U,[2,124]),a(U,[2,125]),a(U,[2,126]),a(U,[2,127]),a(U,[2,128]),a(U,[2,129]),a(U,[2,130]),a(U,[2,131]),a(U,[2,132]),a(U,[2,133]),a(U,[2,134]),a(U,[2,135]),a(U,[2,136]),a(U,[2,137]),a(U,[2,138]),a(U,[2,139]),a(U,[2,140]),a(U,[2,141]),a(U,[2,142]),a(U,[2,143]),a(U,[2,144]),a(U,[2,145]),a(U,[2,146]),{5:[2,10],101:R},{5:[2,11]},{14:ee,16:158,35:pe,38:Me,77:Re,78:He,101:R},{14:ee,16:159,35:pe,38:Me,77:Re,78:He},{5:[2,18]},a(me,[2,92]),a(me,[2,93]),a(me,[2,94]),a(me,[2,95]),a(me,[2,96]),{5:[2,21]},a(ye,[2,75]),a(ye,[2,76]),{5:[2,22]},{5:[2,23]},{5:[2,24]},{5:[2,26]},{5:[2,27]},{5:[2,28],31:[1,160]},{5:[2,30]},{36:[1,161]},{5:[2,32]},{5:[2,36]},{5:[2,37]},{5:[2,39]},{5:[2,41]},{5:[2,42],73:162,74:De},a(Ne,[2,86]),{35:[1,163]},{5:[2,43],73:162,74:De},{5:[2,45]},{14:[1,164]},{6:e,7:t,9:n,10:165,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:49,80:52,81:50,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P,101:R},{5:[2,53]},{5:[2,62]},{5:[2,63]},{5:[2,64]},{5:[2,164]},{5:[2,66],63:166,67:146,68:147,69:148,70:w,72:L},{5:[2,67]},{5:[2,77],67:167,68:147,69:148,70:w,72:L},a(ye,[2,81]),a(ye,[2,82],{80:52,53:168,75:169,76:170,79:171,6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K}),{71:[1,172]},{71:[1,173]},{5:[2,69],63:174,67:146,68:147,69:148,70:w,72:L},{5:[2,71],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,53:175,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:169,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,73],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,53:176,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:169,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,55],57:[1,177]},{5:[2,56],29:[1,178]},{5:[2,60],35:[1,179]},{6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,35:[1,181],37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:180,80:52,81:182,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{5:[2,12]},{5:[2,13]},{6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,32:183,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:184,80:52,81:185,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{14:[1,186]},a(Ne,[2,87]),a(Ne,[2,88]),{5:[2,48],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,53:187,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:169,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,49],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,53:188,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:169,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,101:R},{5:[2,68]},{5:[2,78],67:189,68:147,69:148,70:w,72:L},a(ye,[2,83],{80:52,76:170,79:171,75:190,6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K}),a(me,[2,89]),{71:[1,191],101:[1,192]},a(Ve,[2,156]),{14:ee,16:193,35:pe,38:Me,77:Re,78:He},{14:ee,16:194,35:pe,38:Me,77:Re,78:He},{5:[2,70]},{5:[2,72],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:190,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,74],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:190,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,57]},{5:[2,58]},{5:[2,61]},a(j,[2,161]),a(j,[2,162]),a(j,[2,163]),{5:[2,29]},{5:[2,99]},{5:[2,100]},{31:[1,195]},{5:[2,50],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:190,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,51],6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,75:190,76:170,79:171,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},{5:[2,79],67:196,68:147,69:148,70:w,72:L},a(me,[2,90]),{14:ee,16:197,35:pe,38:Me,77:Re,78:He},{6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,33:v,34:_,35:[1,199],37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,79:198,80:52,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K},a(ye,[2,84]),a(me,[2,85]),{6:e,7:t,9:n,13:r,15:i,17:s,18:o,19:l,20:c,23:u,25:f,26:h,27:d,30:p,32:200,33:v,34:_,37:m,38:g,41:y,43:x,45:S,46:M,49:E,52:N,54:B,55:V,56:O,58:W,59:z,62:C,64:T,65:A,66:F,70:X,72:Y,74:ne,79:184,80:52,81:185,82:ae,83:xe,84:be,85:ge,86:we,87:q,88:Ge,89:Te,90:Pe,91:Ee,92:_e,93:ie,94:oe,95:K,96:de,97:he,98:I,99:P},{5:[2,80]},a(me,[2,91]),a(Ve,[2,157]),a(Ve,[2,158]),{5:[2,31]}],defaultActions:{3:[2,2],4:[2,3],7:[2,8],8:[2,9],11:[2,14],12:[2,15],13:[2,16],15:[2,19],16:[2,20],25:[2,33],26:[2,34],29:[2,40],34:[2,46],35:[2,47],37:[2,52],46:[2,1],47:[2,5],107:[2,11],110:[2,18],116:[2,21],119:[2,22],120:[2,23],121:[2,24],122:[2,26],123:[2,27],125:[2,30],127:[2,32],128:[2,36],129:[2,37],130:[2,39],131:[2,41],136:[2,45],139:[2,53],140:[2,62],141:[2,63],142:[2,64],143:[2,164],145:[2,67],158:[2,12],159:[2,13],166:[2,68],174:[2,70],177:[2,57],178:[2,58],179:[2,61],183:[2,29],184:[2,99],185:[2,100],196:[2,80],200:[2,31]},parseError:function(ot,Fe){if(Fe.recoverable)this.trace(ot);else{var Xe=new Error(ot);throw Xe.hash=Fe,Xe}},parse:function(ot){var Fe=this,Xe=[0],$=[],nt=[null],Z=[],ut=this.table,ce="",_t=0,Ct=0,Hr=2,Wr=1,or=Z.slice.call(arguments,1),k=Object.create(this.lexer),te={yy:{}};for(var J in this.yy)Object.prototype.hasOwnProperty.call(this.yy,J)&&(te.yy[J]=this.yy[J]);k.setInput(ot,te.yy),te.yy.lexer=k,te.yy.parser=this,typeof k.yylloc>"u"&&(k.yylloc={});var se=k.yylloc;Z.push(se);var Ae=k.options&&k.options.ranges;typeof te.yy.parseError=="function"?this.parseError=te.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;function Qe(){var At;return At=$.pop()||k.lex()||Wr,typeof At!="number"&&(At instanceof Array&&($=At,At=$.pop()),At=Fe.symbols_[At]||At),At}for(var je,We,$e,tt,Ke={},it,Ye,lr,vt;;){if(We=Xe[Xe.length-1],this.defaultActions[We]?$e=this.defaultActions[We]:((je===null||typeof je>"u")&&(je=Qe()),$e=ut[We]&&ut[We][je]),typeof $e>"u"||!$e.length||!$e[0]){var cr="";vt=[];for(it in ut[We])this.terminals_[it]&&it>Hr&&vt.push("'"+this.terminals_[it]+"'");k.showPosition?cr="Parse error on line "+(_t+1)+`:
`+k.showPosition()+`
Expecting `+vt.join(", ")+", got '"+(this.terminals_[je]||je)+"'":cr="Parse error on line "+(_t+1)+": Unexpected "+(je==Wr?"end of input":"'"+(this.terminals_[je]||je)+"'"),this.parseError(cr,{text:k.match,token:this.terminals_[je]||je,line:k.yylineno,loc:se,expected:vt})}if($e[0]instanceof Array&&$e.length>1)throw new Error("Parse Error: multiple actions possible at state: "+We+", token: "+je);switch($e[0]){case 1:Xe.push(je),nt.push(k.yytext),Z.push(k.yylloc),Xe.push($e[1]),je=null,Ct=k.yyleng,ce=k.yytext,_t=k.yylineno,se=k.yylloc;break;case 2:if(Ye=this.productions_[$e[1]][1],Ke.$=nt[nt.length-Ye],Ke._$={first_line:Z[Z.length-(Ye||1)].first_line,last_line:Z[Z.length-1].last_line,first_column:Z[Z.length-(Ye||1)].first_column,last_column:Z[Z.length-1].last_column},Ae&&(Ke._$.range=[Z[Z.length-(Ye||1)].range[0],Z[Z.length-1].range[1]]),tt=this.performAction.apply(Ke,[ce,Ct,_t,te.yy,$e[1],nt,Z].concat(or)),typeof tt<"u")return tt;Ye&&(Xe=Xe.slice(0,-1*Ye*2),nt=nt.slice(0,-1*Ye),Z=Z.slice(0,-1*Ye)),Xe.push(this.productions_[$e[1]][0]),nt.push(Ke.$),Z.push(Ke._$),lr=ut[Xe[Xe.length-2]][Xe[Xe.length-1]],Xe.push(lr);break;case 3:return!0}}return!0}},et=function(){var Mt={EOF:1,parseError:function(Fe,Xe){if(this.yy.parser)this.yy.parser.parseError(Fe,Xe);else throw new Error(Fe)},setInput:function(Fe,Xe){return this.yy=Xe||this.yy||{},this._input=Fe,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var Fe=this._input[0];this.yytext+=Fe,this.yyleng++,this.offset++,this.match+=Fe,this.matched+=Fe;var Xe=Fe.match(/(?:\r\n?|\n).*/g);return Xe?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),Fe},unput:function(Fe){var Xe=Fe.length,$=Fe.split(/(?:\r\n?|\n)/g);this._input=Fe+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-Xe),this.offset-=Xe;var nt=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),$.length-1&&(this.yylineno-=$.length-1);var Z=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:$?($.length===nt.length?this.yylloc.first_column:0)+nt[nt.length-$.length].length-$[0].length:this.yylloc.first_column-Xe},this.options.ranges&&(this.yylloc.range=[Z[0],Z[0]+this.yyleng-Xe]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){if(this.options.backtrack_lexer)this._backtrack=!0;else return this.parseError("Lexical error on line "+(this.yylineno+1)+`. You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).
`+this.showPosition(),{text:"",token:null,line:this.yylineno});return this},less:function(Fe){this.unput(this.match.slice(Fe))},pastInput:function(){var Fe=this.matched.substr(0,this.matched.length-this.match.length);return(Fe.length>20?"...":"")+Fe.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var Fe=this.match;return Fe.length<20&&(Fe+=this._input.substr(0,20-Fe.length)),(Fe.substr(0,20)+(Fe.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var Fe=this.pastInput(),Xe=new Array(Fe.length+1).join("-");return Fe+this.upcomingInput()+`
`+Xe+"^"},test_match:function(Fe,Xe){var $,nt,Z;if(this.options.backtrack_lexer&&(Z={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(Z.yylloc.range=this.yylloc.range.slice(0))),nt=Fe[0].match(/(?:\r\n?|\n).*/g),nt&&(this.yylineno+=nt.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:nt?nt[nt.length-1].length-nt[nt.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+Fe[0].length},this.yytext+=Fe[0],this.match+=Fe[0],this.matches=Fe,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(Fe[0].length),this.matched+=Fe[0],$=this.performAction.call(this,this.yy,this,Xe,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),$)return $;if(this._backtrack){for(var ut in Z)this[ut]=Z[ut];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var Fe,Xe,$,nt;this._more||(this.yytext="",this.match="");for(var Z=this._currentRules(),ut=0;ut<Z.length;ut++)if($=this._input.match(this.rules[Z[ut]]),$&&(!Xe||$[0].length>Xe[0].length)){if(Xe=$,nt=ut,this.options.backtrack_lexer){if(Fe=this.test_match($,Z[ut]),Fe!==!1)return Fe;if(this._backtrack){Xe=!1;continue}else return!1}else if(!this.options.flex)break}return Xe?(Fe=this.test_match(Xe,Z[nt]),Fe!==!1?Fe:!1):this._input===""?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+`. Unrecognized text.
`+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var Fe=this.next();return Fe||this.lex()},begin:function(Fe){this.conditionStack.push(Fe)},popState:function(){var Fe=this.conditionStack.length-1;return Fe>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(Fe){return Fe=this.conditionStack.length-1-Math.abs(Fe||0),Fe>=0?this.conditionStack[Fe]:"INITIAL"},pushState:function(Fe){this.begin(Fe)},stateStackSize:function(){return this.conditionStack.length},options:{"case-insensitive":!0},performAction:function(Fe,Xe,$,nt){switch($){case 0:break;case 1:return"";case 2:return"";case 3:return 42;case 4:return 35;case 5:return 77;case 6:return 78;case 7:return 78;case 8:return 8;case 9:return 6;case 10:return 82;case 11:return 7;case 12:return 9;case 13:return 59;case 14:return 13;case 15:return 15;case 16:return 17;case 17:return 18;case 18:return 19;case 19:return 20;case 20:return 11;case 21:return 62;case 22:return 64;case 23:return 23;case 24:return 25;case 25:return 26;case 26:return 27;case 27:return 30;case 28:return 34;case 29:return 33;case 30:return 65;case 31:return 66;case 32:return 37;case 33:return 41;case 34:return 43;case 35:return 52;case 36:return 54;case 37:return 55;case 38:return 46;case 39:return 48;case 40:return 45;case 41:return 49;case 42:return 56;case 43:return 58;case 44:return 44;case 45:return 83;case 46:return 84;case 47:return 85;case 48:return 86;case 49:return 87;case 50:return 88;case 51:return 89;case 52:return 90;case 53:return 91;case 54:return 92;case 55:return 93;case 56:return 94;case 57:return 95;case 58:return 70;case 59:return 70;case 60:return 72;case 61:return 72;case 62:return 74;case 63:return 74;case 64:return 74;case 65:return 31;case 66:return 36;case 67:return 96;case 68:return 97;case 69:return 98;case 70:return 99;case 71:return Xe.yytext=Fe.utils.unquoteString(Xe.yytext),14;case 72:return 38;case 73:return 5;case 74:return 101;case 75:return 103;case 76:return"\\";case 77:return 28;case 78:return 61;case 79:return 29;case 80:return 57;case 81:return 71}},rules:[/^(?:\s+)/i,/^(?:[#].*)/i,/^(?:\/\/.*)/i,/^(?:([_A-Z0-9\/\+]+==))/i,/^(?:-?[0-9]+(\.[0-9]+)?\b)/i,/^(?:0[xX][0-9A-F]+\b)/i,/^(?:false\b)/i,/^(?:true\b)/i,/^(?:all\b)/i,/^(?:reset\b)/i,/^(?:clear\b)/i,/^(?:build\b)/i,/^(?:help\b)/i,/^(?:load\b)/i,/^(?:get\b)/i,/^(?:set\b)/i,/^(?:set_save\b)/i,/^(?:set_restore\b)/i,/^(?:set_reset\b)/i,/^(?:preset\b)/i,/^(?:motm\b)/i,/^(?:add\b)/i,/^(?:rep\b)/i,/^(?:remove\b)/i,/^(?:hide\b)/i,/^(?:show\b)/i,/^(?:list\b)/i,/^(?:select\b)/i,/^(?:within\b)/i,/^(?:selector\b)/i,/^(?:mode\b)/i,/^(?:color\b)/i,/^(?:material\b)/i,/^(?:view\b)/i,/^(?:unit\b)/i,/^(?:line\b)/i,/^(?:listobj\b)/i,/^(?:removeobj\b)/i,/^(?:rotate\b)/i,/^(?:translate\b)/i,/^(?:scale\b)/i,/^(?:center\b)/i,/^(?:url\b)/i,/^(?:screenshot\b)/i,/^(?:dssp\b)/i,/^(?:file_list\b)/i,/^(?:file_register\b)/i,/^(?:file_delete\b)/i,/^(?:preset_add\b)/i,/^(?:preset_delete\b)/i,/^(?:preset_update\b)/i,/^(?:preset_rename\b)/i,/^(?:preset_open\b)/i,/^(?:create_scenario\b)/i,/^(?:reset_scenario\b)/i,/^(?:delete_scenario\b)/i,/^(?:add_scenario_item\b)/i,/^(?:list_scenario\b)/i,/^(?:s\b)/i,/^(?:mt\b)/i,/^(?:m\b)/i,/^(?:c\b)/i,/^(?:x\b)/i,/^(?:y\b)/i,/^(?:z\b)/i,/^(?:as\b)/i,/^(?:of\b)/i,/^(?:pdb\b)/i,/^(?:delay\b)/i,/^(?:prst\b)/i,/^(?:desc\b)/i,/^(?:((?:"(?:\\.|[^\\"])*"|'(?:\\.|[^\\'])*')))/i,/^(?:([_A-Z0-9]+))/i,/^(?:$)/i,/^(?:\.)/i,/^(?:\/)/i,/^(?:\\)/i,/^(?:-e\b)/i,/^(?:-f\b)/i,/^(?:-s\b)/i,/^(?:-v\b)/i,/^(?:=)/i],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81],inclusive:!0}}};return Mt}();Ie.lexer=et;function gt(){this.yy={}}return gt.prototype=Ie,Ie.Parser=gt,new gt}(),gi={parser:CO},nd={$help:["Rendering mode shortcut","    BS - balls and sticks mode","    LN - lines mode","    LC - licorice mode","    VW - van der waals mode","    TR - trace mode","    TU - tube mode","    CA - cartoon mode","    SA - isosurface mode","    QS - quick surface mode","    SE - solvent excluded mode","    TX - text mode"],BS:{$help:["   Balls and sticks","      aromrad = <number> #aromatic radius","      atom = <number>    #atom radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic",`      space = <number>   #space value
`]},CA:{$help:["   Cartoon","      arrow = <number>   #arrow size","      depth = <number>   #depth of surface","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius","      tension = <number> #",`      width = <number>  #secondary width
`]},LN:{$help:["   Lines","      atom = <number>    #atom radius","      chunkarom = <number>","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic",`      offsarom = <number>
`]},LC:{$help:["   Licorice","      aromrad = <number> #aromatic radius","      bond = <number>    #bond radius","      multibond = <bool> #use multibond","      showarom = <bool>  #show aromatic",`      space = <number>   #space value
`]},VW:{$help:["   Van der Waals",`      nothing
`]},TR:{$help:["   Trace",`      radius = <number>  #tube radius
`]},TU:{$help:["   Tube","      heightSegmentsRatio = <number>","      radius = <number>  #tube radius",`      tension = <number> 
`]},SA:{$help:["   Surface",`      zClip = <bool> #clip z plane
`]},QS:{$help:["   Quick surface","      isoValue = <number>","      scale = <number>","      wireframe = <bool>",`      zClip = <bool> #clip z plane
`]},SE:{$help:["   Solvent excluded surface",`      zClip = <bool> #clip z plane
`]},TX:{$help:["   Text mode",'      template = <format string> string that can include "{{ id }}"',"          it will be replaced by value, id can be one of next:",`          serial, name, type, sequence, residue, chain, hetatm, water
`,'      horizontalAlign = <string> {"left", "right", "center"}','      verticalAlign = <string> {"top", "bottom", "middle"}',"      dx = <number> #offset along x","      dy = <number> #offset along y","      dz = <number> #offset along z","      fg = <string> #text color modificator","           could be keyword, named color or hex","      fg = <string> #back color modificator","           could be keyword, named color or hex","      showBg = <bool> #if set show background","           plate under text"]}},id={$help:["Coloring mode shortcut","    EL - color by element","    CH - color by chain","    SQ - color by sequence","    RT - color by residue type","    SS - color by secondary structure","    UN - uniform"],UN:{$help:["Parameters of coloring modes customization","   Uniform",`      color = <number|color> #RGB->HEX->dec
`],color:{$help:Object.keys(ns.get(Q.now.palette).namedColors).sort().join(`
`)}}},u0={$help:["Material shortcut","    DF - diffuse","    TR - transparent","    SF - soft plastic","    PL - glossy plastic","    ME - metal","    GL - glass"]},pv={$help:["Short (packed) representation description as a set of variables","    s=<EXPRESSION>","        selector property","    m=<MODE_ID>[!<PARAMETER>:<VALUE>[,...]]","        render mode property","    c=<COLORER_ID>[!<PARAMETER>:<VALUE>[,...]]","        color mode property","    mt=<MATERIAL_ID>","        material property"],s:{$help:"Selection expression string as it is in menu->representations->selection"},m:nd,c:id,mt:u0},mv={$help:["Parameters of rendering modes customization: modes","Parameters of colorer customization: colorers","Autobuild: autobuild = (<number>|<bool>)"],modes:nd,colorers:id},ff={$help:["help (<cmd name>| <path to property>)","You can get detailed information about command options",`   using "help cmd.opt.opt.[...]"
`,"   you can use one line comments","   everything started from (#|//) will be skipped",`   Example: >build //some comment
`,"List of available commands:"],reset:{$help:["Reload current object, delete all representations","    Nothing will work until load new object"]},load:{$help:["load (<PDBID>|<URL>|-f [<*.NC FILE URL STRING>])","    Load new pdb object from selected source"],PDBID:{$help:"pdb id in remote molecule database"},URL:{$help:"url to source file"},f:{$help:["open file system dialog to fetch local file","optionally you can determine trajectory file","via URL for *.top model"]}},clear:{$help:"No args. Clear terminal"},add:{$help:["add [<REP_NAME>] [<DESCRIPTION>]","    Add new item to representation set with","    default or <DESCRIPTION> params"],REP_NAME:{$help:"Identifier string [_,a-z,A-Z,0-9] can not start from digit"},DESCRIPTION:pv},rep:{$help:["rep [<REP_NAME>|<REP_INDEX>] [<DESCRIPTION>]","    set current representation by name or index","    edit current representation by <DESCRIPTION>"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"},DESCRIPTION:pv},remove:{$help:["remove (<REP_NAME>|<REP_INDEX>)","Remove representation by name or index"],REP_NAME:{$help:["Identifier string [_,a-z,A-Z,0-9] can not start from digit","Must be declared before"]},REP_INDEX:{$help:"Index of available representation"}},selector:{$help:["selector <EXPRESSION>","   set selector from EXPRESSION to current representation"],EXPRESSION:{$help:"Selection expression string as it is in menu->representations->selection"}},mode:{$help:["mode <MODE_ID> [<PARAMETER>=<VALUE>...]","   set rendering mode and apply parameters to current representation"],MODE_ID:nd},color:{$help:["color <COLORER_ID> [<PARAMETER>=<VALUE>...]","   set colorer and apply parameters to current representation"],COLORER_ID:id},material:{$help:["material <MATERIAL_ID>","   set material to current representation"],MATERIAL_ID:u0},build:{$help:"build help str",add:{$help:"build.add",new:{$help:["add.new","add.new new line 1","add.new new line 2","add.new new line 3"]}},del:{$help:"build.del"}},list:{$help:["list [-e|-s|<REP_NAME>|<REP_INDEX>]","Print representations if no args print list of representations","    -e expand list and show all representations","    -s show all user-registered selectors","    <REP_NAME>|<REP_INDEX> show only current representation"]},hide:{$help:["hide (<REP_NAME>|<REP_INDEX>)","Hide representation referenced in args"]},show:{$help:["show (<REP_NAME>|<REP_INDEX>)","Show representation referenced in args"]},get:{$help:["get <PARAMETER>","Print <PARAMETER> value","    <PARAMETER> - path to option use get.PARAMETER to get more info"],PARAMETER:mv},set:{$help:["set <PARAMETER> <VALUE>","Set <PARAMETER> with <VALUE>","    <PARAMETER> - path to option use set.PARAMETER to get more info"],PARAMETER:mv},set_save:{$help:["set_save","Save current settings to cookie"]},set_restore:{$help:["set_restore","Load and apply settings from cookie"]},set_reset:{$help:["set_reset","Reset current settings to the defaults"]},preset:{$help:["preset [<PRESET>]","Reset current representation or set preset to <PRESET>"],PRESET:{$help:["default","wire","small","macro"]}},unit:{$help:["unit [<unit_id>]","Change current biological structure view. Zero <unit_id> value means asymmetric unit,","positive values set an assembly with corresponding number.","Being called with no parameters command prints current unit information."]},view:{$help:["view [<ENCODED_VIEW>]","Get current encoded view or set if ENCODED_VIEW placed as argument"],ENCODED_VIEW:{$help:["encoded view matrix string (binary code)"]}},rotate:{$help:["rotate (x|y|z) [<DEGREES>] [(x|y|z) [<DEGREES>]]...","Rotate scene"]},scale:{$help:["scale <SCALE>","Scale scene"]},select:{$help:["select <SELECTOR_STRING> [as <SELECTOR_NAME>]","Select atoms using selector defined in SELECTOR_STRING","    and if SELECTOR_NAME is defined register it in viewer","    you can use it later as a complex selector"]},within:{$help:["within <DISTANCE> of <SELECTOR_STRING> as <SELECTOR_NAME>","Build within named selector","    DISTANCE        <number>","    SELECTOR_STRING <string(selection language)>","    SELECTOR_NAME   <identifier>"]},url:{$help:["url [-s] [-v]","Report URL encoded scene","    if -s set that include settings in the URL","    if -v set that include view in the URL"]},screenshot:{$help:["screenshot [<WIDTH> [<HEIGHT>]]","Make a screenshot of the scene","    WIDTH  <number> in pixels","    HEIGHT <number> in pixels, equal to WIDTH by default"]},line:{$help:["line <first_atom_path> <second_atom_path> [<PARAMETER>=<VALUE>]","Draw dashed line between two specified atoms"]},removeobj:{$help:["removeobj <id>","Remove scene object by its index. Indices could be obtained by <listobj> command"]},listobj:{$help:["listobj","Display the list of all existing scene objects"]}},ad=vr.chem.selectors,AO=vr.modes,TO=vr.colorers,RO=vr.materials,vv=vr.palettes,LO=vr.options,Yl=vr.settings;function PO(){}var f0=function(){var a=new PO;return function(){return a}}(),NO=function(){function a(){G(this,a),this.representationMap={},this.representationID={}}return H(a,[{key:"get",value:function(t){return this.representationMap[t]||this.representationID[t]||"<no name>"}},{key:"add",value:function(t,n){if(t===-1)return"Can not create representation: there is no data";if(n!==void 0)if(!this.representationMap.hasOwnProperty(t))this.representationMap[t.toString()]=n,this.representationID[n]=t.toString();else return"This name has already existed, registered without name";return"Representation ".concat(t," successfully added")}},{key:"remove",value:function(t){t&&this.representationID.hasOwnProperty(t)&&(delete this.representationMap[this.representationID[t]],delete this.representationID[t]);var n=Object.keys(this.representationID).sort();for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];i>t&&(this.representationID[i-1]=this.representationID[i],this.representationMap[this.representationID[i]]-=1,delete this.representationID[i])}}},{key:"clear",value:function(){this.representationMap={},this.representationID={}}}]),a}(),IO=new NO;function pc(a){var e={s:"selector",m:"mode",c:"colorer",mt:"material",mode:"modes",color:"colorers",colorer:"colorers",select:"selector",material:"materials",selector:"selector"},t=e[a];return t===void 0?a:t}var kO=function(){function a(){G(this,a)}return H(a,[{key:"list",value:function(t,n,r){var i="";if(t&&n!==void 0&&(r===void 0||r==="-e"))for(var s=t.repCount(),o=0;o<s;o++)i+=this.listRep(t,n,o,r);return i}},{key:"listRep",value:function(t,n,r,i){var s="",o=t.repGet(r);if(!o)return Wt.warn("Rep ".concat(r," does not exist!")),s;var l=r,c=n.get(l),u=o.mode,f=o.colorer,h=o.selectorString,d=o.materialPreset;return s+="#".concat(l," : ").concat(u.name).concat(c==="<no name>"?"":", ".concat(c),`
`),i!==void 0&&(s+='    selection : "'.concat(h,`"
`),s+="    mode      : (".concat(u.id,"), ").concat(u.name,`
`),s+="    colorer   : (".concat(f.id,"), ").concat(f.name,`
`),s+="    material  : (".concat(d.id,"), ").concat(d.name,`
`)),s}},{key:"listSelector",value:function(t,n){var r="";for(var i in n)n.hasOwnProperty(i)&&(r+="".concat(i,' : "').concat(n[i],`"
`));return r}},{key:"listObjs",value:function(t){var n=t._objects;if(!n||!Array.isArray(n)||n.length===0)return"There are no objects on the scene";for(var r=[],i=0,s=n.length;i<s;++i)r[i]="".concat(i,": ").concat(n[i].toString());return r.join(`
`)}},{key:"joinHelpStr",value:function(t){return t instanceof Array?t.join(`
`):t}},{key:"help",value:function(t){if(le.isUndefined(t))return"".concat(this.joinHelpStr(ff.$help),`
`).concat(le.slice(le.sortBy(le.keys(ff)),1).join(", "),`
`);var n=le.get(ff,t);return le.isUndefined(n)?this.help():"".concat(this.joinHelpStr(n.$help),`
`)}},{key:"load",value:function(t,n){if(!(t===void 0||n===void 0||n==="-f")){t.awaitWhileCMDisInProcess();var r=function(){return t.finishAwaitingCMDInProcess()};t.load(n).then(r,r)}}},{key:"checkArg",value:function(t,n,r){if(t!==void 0&&n!==void 0){if(pc(t)==="selector"){var i=ad.parse(n);if(i.error!==void 0){var s={message:i.error};throw s}return r!==void 0&&r?i.selector:n}for(var o={colorers:TO,modes:AO,materials:RO},l=t,c;l!==c;)c=l,l=pc(c);if(o[l].get(n)===void 0){var u={message:"".concat(n," is not existed in ").concat(l)};throw u}return n}return f0}},{key:"propagateProp",value:function(t,n){if(t!==void 0){var r={},i=LO.adapters[wn(le.get(Yl.defaults,t))];if(i===void 0){var s={message:"".concat(t," is not existed")};throw s}if((t.endsWith(".color")||t.endsWith(".baseColor")||t.endsWith(".EL.carbon"))&&typeof n!="number"&&(n=vv.get(Yl.now.palette).getNamedColor(n)),t.endsWith(".fg")||t.endsWith(".bg"))if(typeof n!="number"){var o=vv.get(Yl.now.palette).getNamedColor(n,!0);o!==void 0&&(n="0x".concat(o.toString(16)))}else n="0x".concat(n.toString(16));if(t.endsWith(".template")&&(n=n.replace(/\\n/g,`
`)),n!==void 0&&i(n)!==n&&i(n)!==n>0)throw r={message:"".concat(t,' must be a "').concat(wn(le.get(Yl.defaults,t)),'"')},r}return n}},{key:"unquoteString",value:function(t){return Se.unquoteString(t)}}]),a}(),OO=new kO;function DO(a,e){var t={};return t[a]=e,t}function Wc(a){if(a instanceof this.constructor)return a;a instanceof Array?this._values=a.slice(0):a?this._values=[a]:this._values=[]}Wc.prototype.append=function(a){var e=this._values;return e[e.length]=a,this};Wc.prototype.remove=function(a){var e=this._values,t=e.indexOf(a);return t>=0&&e.splice(t,1),this};Wc.prototype.toJSO=function(a,e,t){for(var n={},r=this._values,i=0,s=r.length;i<s;++i)le.set(n,r[i].id,a.propagateProp("".concat(pc(e),".").concat(t,".").concat(r[i].id),r[i].val));return n};function FO(a,e){this.id=a,this.val=e}var Nr=Object.create({});Nr.Arg=FO;Nr.ArgList=Wc;Nr.miew=null;Nr.echo=null;Nr.representations=IO;Nr.utils=OO;Nr.assign=le.assign;Nr.CreateObjectPair=DO;Nr.keyRemap=pc;Nr.Context=ad.Context;Nr.ClearContext=ad.ClearContext;Nr.NULL=f0;Nr.notimplemented=function(){return this.NULL};vr.prototype.script=function(a,e,t){gi.parser.yy.miew=this,gi.parser.yy.echo=e,gi.parser.yy.error=t,this.cmdQueue===void 0&&(this.cmdQueue=[]),this.commandInAction===void 0&&(this.commandInAction=!1),this.cmdQueue=this.cmdQueue.concat(a.split(`
`))};vr.prototype.awaitWhileCMDisInProcess=function(){this.commandInAction=!0};vr.prototype.finishAwaitingCMDInProcess=function(){this.commandInAction=!1};vr.prototype.isScriptingCommandAvailable=function(){return this.commandInAction!==void 0&&!this.commandInAction&&this.cmdQueue!==void 0&&this.cmdQueue.length>0};vr.prototype.callNextCmd=function(){if(this.isScriptingCommandAvailable()){var a=this.cmdQueue.shift(),e={};e.success=!1;try{gi.parser.parse(a),e.success=!0}catch(t){e.error=t.message,gi.parser.yy.error(e.error),this.finishAwaitingCMDInProcess()}return e}return""};gi.parser.yy=Nr;gi.parser.yy.parseError=gi.parser.parseError;function BO(a,e){var t=fr.useRef(null),n=fr.useCallback(function(o){t.current=o,s()},[]),r=fr.useRef(null),i=fr.useRef(),s=function(){var l=null;t.current?l=t.current:e&&(e instanceof HTMLElement?l=e:l=e.current),r.current!==l&&(i.current&&(i.current(),i.current=null),r.current=l,l&&(i.current=a(l)))};return fr.useEffect(function(){s()},[e]),n}function zO(a){a===void 0&&(a={});var e=a.onResize,t=fr.useRef(void 0);t.current=e;var n=fr.useRef(),r=fr.useState({width:void 0,height:void 0}),i=r[0],s=r[1],o=fr.useRef(!1);fr.useEffect(function(){return function(){o.current=!0}},[]);var l=fr.useRef({width:void 0,height:void 0}),c=BO(function(u){return n.current||(n.current=new ResizeObserver(function(f){if(Array.isArray(f)){var h=f[0],d=Math.round(h.contentRect.width),p=Math.round(h.contentRect.height);if(l.current.width!==d||l.current.height!==p){var v={width:d,height:p};t.current?t.current(v):(l.current.width=d,l.current.height=p,o.current||s(v))}}})),n.current.observe(u),function(){n.current&&n.current.unobserve(u)}},a.ref);return fr.useMemo(function(){return{ref:c,width:i.width,height:i.height}},[c,i?i.width:null,i?i.height:null])}var dn=function(e){return"@@redux-saga/"+e},VO=dn("CANCEL_PROMISE"),h0=dn("CHANNEL_END"),d0=dn("IO"),gv=dn("MATCH"),p0=dn("MULTICAST"),m0=dn("SAGA_ACTION"),UO=dn("SELF_CANCELLATION"),GO=dn("TASK"),Ja=dn("TASK_CANCEL"),v0=dn("TERMINATE"),HO=dn("LOCATION"),g0=function(e){return e==null},Ql=function(e){return e!=null},Rr=function(e){return typeof e=="function"},sd=function(e){return typeof e=="string"},Pi=Array.isArray,Xc=function(e){return e&&Rr(e.then)},od=function(e){return e&&Rr(e.next)&&Rr(e.throw)},_v=function a(e){return e&&(sd(e)||y0(e)||Rr(e)||Pi(e)&&e.every(a))},ld=function(e){return e&&Rr(e.take)&&Rr(e.close)},_0=function(e){return Rr(e)&&e.hasOwnProperty("toString")},y0=function(e){return!!e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype},WO=function(e){return ld(e)&&e[p0]},XO=function(e){return function(){return e}},jO=XO(!0),hr=function(){},YO=function(e){return e},cd=function(e,t){Xi(e,t),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(t).forEach(function(n){e[n]=t[n]})},qO=function(e,t){var n;return(n=[]).concat.apply(n,t.map(e))};function jc(a,e){var t=a.indexOf(e);t>=0&&a.splice(t,1)}function $O(a){var e=!1;return function(){e||(e=!0,a())}}var ZO=function(e){throw e},KO=function(e){return{value:e,done:!0}};function Yf(a,e,t){e===void 0&&(e=ZO),t===void 0&&(t="iterator");var n={meta:{name:t},next:a,throw:e,return:KO,isSagaIterator:!0};return typeof Symbol<"u"&&(n[Symbol.iterator]=function(){return n}),n}function JO(a,e){var t=e.sagaStack;console.error(a),console.error(t)}var x0=function(e){return Array.apply(null,new Array(e))},QO=function(e){return function(t){return e(Object.defineProperty(t,m0,{value:!0}))}},S0=function(e){return e===v0},b0=function(e){return e===Ja},w0=function(e){return S0(e)||b0(e)};function M0(a,e){var t=Object.keys(a),n=t.length,r=0,i,s=Pi(a)?x0(n):{},o={};function l(){r===n&&(i=!0,e(s))}return t.forEach(function(c){var u=function(h,d){i||(d||w0(h)?(e.cancel(),e(h,d)):(s[c]=h,r++,l()))};u.cancel=hr,o[c]=u}),e.cancel=function(){i||(i=!0,t.forEach(function(c){return o[c].cancel()}))},o}function ud(a){return{name:a.name||"anonymous",location:E0(a)}}function E0(a){return a[HO]}function eD(){for(var a=arguments.length,e=new Array(a),t=0;t<a;t++)e[t]=arguments[t];return e.length===0?function(n){return n}:e.length===1?e[0]:e.reduce(function(n,r){return function(){return n(r.apply(void 0,arguments))}})}var tD="Channel's Buffer overflow!",rD=1,nD=3,C0=4;function iD(a,e){a===void 0&&(a=10);var t=new Array(a),n=0,r=0,i=0,s=function(u){t[r]=u,r=(r+1)%a,n++},o=function(){if(n!=0){var u=t[i];return t[i]=null,n--,i=(i+1)%a,u}},l=function(){for(var u=[];n;)u.push(o());return u};return{isEmpty:function(){return n==0},put:function(u){if(n<a)s(u);else{var f;switch(e){case rD:throw new Error(tD);case nD:t[r]=u,r=(r+1)%a,i=r;break;case C0:f=2*a,t=l(),n=t.length,r=t.length,i=0,t.length=f,a=f,s(u);break}}},take:o,flush:l}}var aD=function(e){return iD(e,C0)},ec="TAKE",A0="PUT",sD="ALL",oD="RACE",T0="CALL",lD="CPS",fd="FORK",cD="JOIN",uD="CANCEL",fD="SELECT",hD="ACTION_CHANNEL",dD="CANCELLED",pD="FLUSH",mD="GET_CONTEXT",vD="SET_CONTEXT",Wi=function(e,t){var n;return n={},n[d0]=!0,n.combinator=!1,n.type=e,n.payload=t,n},gD=function(e){return Wi(fd,Xi({},e.payload,{detached:!0}))};function _D(a,e){if(a===void 0&&(a="*"),_v(a))return Ql(e)&&console.warn("take(pattern) takes one argument but two were provided. Consider passing an array for listening to several action types"),Wi(ec,{pattern:a});if(WO(a)&&Ql(e)&&_v(e))return Wi(ec,{channel:a,pattern:e});if(ld(a))return Ql(e)&&console.warn("take(channel) takes one argument but two were provided. Second argument is ignored."),Wi(ec,{channel:a})}function yv(a,e){return g0(e)&&(e=a,a=void 0),Wi(A0,{channel:a,action:e})}function R0(a,e){var t=null,n;return Rr(a)?n=a:(Pi(a)?(t=a[0],n=a[1]):(t=a.context,n=a.fn),t&&sd(n)&&Rr(t[n])&&(n=t[n])),{context:t,fn:n,args:e}}function yD(a){for(var e=arguments.length,t=new Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];return Wi(T0,R0(a,t))}function hd(a){for(var e=arguments.length,t=new Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];return Wi(fd,R0(a,t))}function xD(a){for(var e=arguments.length,t=new Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];return gD(hd.apply(void 0,[a].concat(t)))}function SD(){var a={};return a.promise=new Promise(function(e,t){a.resolve=e,a.reject=t}),a}var L0=[],Yc=0;function bD(a){try{dd(),a()}finally{I0()}}function P0(a){L0.push(a),Yc||(dd(),k0())}function N0(a){try{return dd(),a()}finally{k0()}}function dd(){Yc++}function I0(){Yc--}function k0(){I0();for(var a;!Yc&&(a=L0.shift())!==void 0;)bD(a)}var wD=function(e){return function(t){return e.some(function(n){return pd(n)(t)})}},MD=function(e){return function(t){return e(t)}},xv=function(e){return function(t){return t.type===String(e)}},ED=function(e){return function(t){return t.type===e}},O0=function(){return jO};function pd(a){var e=a==="*"?O0:sd(a)?xv:Pi(a)?wD:_0(a)?xv:Rr(a)?MD:y0(a)?ED:null;if(e===null)throw new Error("invalid pattern: "+a);return e(a)}var to={type:h0},md=function(e){return e&&e.type===h0};function CD(a){a===void 0&&(a=aD());var e=!1,t=[];function n(o){if(!e){if(t.length===0)return a.put(o);var l=t.shift();l(o)}}function r(o){e&&a.isEmpty()?o(to):a.isEmpty()?(t.push(o),o.cancel=function(){jc(t,o)}):o(a.take())}function i(o){if(e&&a.isEmpty()){o(to);return}o(a.flush())}function s(){if(!e){e=!0;var o=t;t=[];for(var l=0,c=o.length;l<c;l++){var u=o[l];u(to)}}}return{take:r,put:n,flush:i,close:s}}function AD(){var a,e=!1,t=[],n=t,r=function(){n===t&&(n=t.slice())},i=function(){e=!0;var o=t=n;n=[],o.forEach(function(l){l(to)})};return a={},a[p0]=!0,a.put=function(o){if(!e){if(md(o)){i();return}for(var l=t=n,c=0,u=l.length;c<u;c++){var f=l[c];f[gv](o)&&(f.cancel(),f(o))}}},a.take=function(o,l){if(l===void 0&&(l=O0),e){o(to);return}o[gv]=l,r(),n.push(o),o.cancel=$O(function(){r(),jc(n,o)})},a.close=i,a}function D0(){var a=AD(),e=a.put;return a.put=function(t){if(t[m0]){e(t);return}P0(function(){e(t)})},a}var Gi=0,Bn=1,tc=2,F0=3;function vd(a,e){var t=a[VO];Rr(t)&&(e.cancel=t),a.then(e,function(n){e(n,!0)})}var jo=0,B0=function(){return++jo},Zt;function TD(a,e){return a.isSagaIterator?{name:a.meta.name}:ud(e)}function RD(a){var e=a.context,t=a.fn,n=a.args;try{var r=t.apply(e,n);if(od(r))return r;var i=!1,s=function(l){return i?{value:l,done:!0}:(i=!0,{value:r,done:!Xc(r)})};return Yf(s)}catch(o){return Yf(function(){throw o})}}function LD(a,e,t){var n=e.channel,r=e.action,i=e.resolve;P0(function(){var s;try{s=(n?n.put:a.dispatch)(r)}catch(o){t(o,!0);return}i&&Xc(s)?vd(s,t):t(s)})}function PD(a,e,t){var n=e.channel,r=n===void 0?a.channel:n,i=e.pattern,s=e.maybe,o=function(c){if(c instanceof Error){t(c,!0);return}if(md(c)&&!s){t(v0);return}t(c)};try{r.take(o,Ql(i)?pd(i):null)}catch(l){t(l,!0);return}t.cancel=o.cancel}function ND(a,e,t,n){var r=e.context,i=e.fn,s=e.args,o=n.task;try{var l=i.apply(r,s);if(Xc(l)){vd(l,t);return}if(od(l)){qc(a,l,o.context,jo,ud(i),!1,t);return}t(l)}catch(c){t(c,!0)}}function ID(a,e,t){var n=e.context,r=e.fn,i=e.args;try{var s=function(l,c){g0(l)?t(c):t(l,!0)};r.apply(n,i.concat(s)),s.cancel&&(t.cancel=s.cancel)}catch(o){t(o,!0)}}function kD(a,e,t,n){var r=e.context,i=e.fn,s=e.args,o=e.detached,l=n.task,c=RD({context:r,fn:i,args:s}),u=TD(c,i);N0(function(){var f=qc(a,c,l.context,jo,u,o,void 0);o?t(f):f.isRunning()?(l.queue.addTask(f),t(f)):f.isAborted()?l.queue.abort(f.error()):t(f)})}function OD(a,e,t,n){var r=n.task,i=function(l,c){if(l.isRunning()){var u={task:r,cb:c};c.cancel=function(){l.isRunning()&&jc(l.joiners,u)},l.joiners.push(u)}else l.isAborted()?c(l.error(),!0):c(l.result())};if(Pi(e)){if(e.length===0){t([]);return}var s=M0(e,t);e.forEach(function(o,l){i(o,s[l])})}else i(e,t)}function hf(a){a.isRunning()&&a.cancel()}function DD(a,e,t,n){var r=n.task;e===UO?hf(r):Pi(e)?e.forEach(hf):hf(e),t()}function FD(a,e,t,n){var r=n.digestEffect,i=jo,s=Object.keys(e);if(s.length===0){t(Pi(e)?[]:{});return}var o=M0(e,t);s.forEach(function(l){r(e[l],i,o[l],l)})}function BD(a,e,t,n){var r=n.digestEffect,i=jo,s=Object.keys(e),o=Pi(e)?x0(s.length):{},l={},c=!1;s.forEach(function(u){var f=function(d,p){c||(p||w0(d)?(t.cancel(),t(d,p)):(t.cancel(),c=!0,o[u]=d,t(o)))};f.cancel=hr,l[u]=f}),t.cancel=function(){c||(c=!0,s.forEach(function(u){return l[u].cancel()}))},s.forEach(function(u){c||r(e[u],i,l[u],u)})}function zD(a,e,t){var n=e.selector,r=e.args;try{var i=n.apply(void 0,[a.getState()].concat(r));t(i)}catch(s){t(s,!0)}}function VD(a,e,t){var n=e.pattern,r=e.buffer,i=CD(r),s=pd(n),o=function c(u){md(u)||a.channel.take(c,s),i.put(u)},l=i.close;i.close=function(){o.cancel(),l()},a.channel.take(o,s),t(i)}function UD(a,e,t,n){var r=n.task;t(r.isCancelled())}function GD(a,e,t){e.flush(t)}function HD(a,e,t,n){var r=n.task;t(r.context[e])}function WD(a,e,t,n){var r=n.task;cd(r.context,e),t()}var XD=(Zt={},Zt[ec]=PD,Zt[A0]=LD,Zt[sD]=FD,Zt[oD]=BD,Zt[T0]=ND,Zt[lD]=ID,Zt[fd]=kD,Zt[cD]=OD,Zt[uD]=DD,Zt[fD]=zD,Zt[hD]=VD,Zt[dD]=UD,Zt[pD]=GD,Zt[mD]=HD,Zt[vD]=WD,Zt);function jD(a,e,t){var n=[],r,i=!1;l(a);var s=function(){return n};function o(u){e(),c(),t(u,!0)}function l(u){n.push(u),u.cont=function(f,h){i||(jc(n,u),u.cont=hr,h?o(f):(u===a&&(r=f),n.length||(i=!0,t(r))))}}function c(){i||(i=!0,n.forEach(function(u){u.cont=hr,u.cancel()}),n=[])}return{addTask:l,cancelAll:c,abort:o,getTasks:s}}function z0(a,e){return a+"?"+e}function YD(a){var e=E0(a);if(e){var t=e.code,n=e.fileName,r=e.lineNumber,i=t+"  "+z0(n,r);return i}return""}function Sv(a){var e=a.name,t=a.location;return t?e+"  "+z0(t.fileName,t.lineNumber):e}function qD(a){var e=qO(function(t){return t.cancelledTasks},a);return e.length?["Tasks cancelled due to error:"].concat(e).join(`
`):""}var gd=null,ro=[],$D=function(e){e.crashedEffect=gd,ro.push(e)},V0=function(){gd=null,ro.length=0},ZD=function(e){gd=e},KD=function(){var e=ro[0],t=ro.slice(1),n=e.crashedEffect?YD(e.crashedEffect):null,r="The above error occurred in task "+Sv(e.meta)+(n?` 
 when executing effect `+n:"");return[r].concat(t.map(function(i){return"    created by "+Sv(i.meta)}),[qD(ro)]).join(`
`)};function JD(a,e,t,n,r,i,s){var o;s===void 0&&(s=hr);var l=Gi,c,u,f=null,h=[],d=Object.create(t),p=jD(e,function(){h.push.apply(h,p.getTasks().map(function(S){return S.meta.name}))},_);function v(){l===Gi&&(l=Bn,p.cancelAll(),_(Ja,!1))}function _(x,S){if(!S)x===Ja?l=Bn:l!==Bn&&(l=F0),c=x,f&&f.resolve(x);else{if(l=tc,$D({meta:r,cancelledTasks:h}),y.isRoot){var M=KD();V0(),a.onError(x,{sagaStack:M})}u=x,f&&f.reject(x)}y.cont(x,S),y.joiners.forEach(function(E){E.cb(x,S)}),y.joiners=null}function m(x){cd(d,x)}function g(){return f||(f=SD(),l===tc?f.reject(u):l!==Gi&&f.resolve(c)),f.promise}var y=(o={},o[GO]=!0,o.id=n,o.meta=r,o.isRoot=i,o.context=d,o.joiners=[],o.queue=p,o.cancel=v,o.cont=s,o.end=_,o.setContext=m,o.toPromise=g,o.isRunning=function(){return l===Gi},o.isCancelled=function(){return l===Bn||l===Gi&&e.status===Bn},o.isAborted=function(){return l===tc},o.result=function(){return c},o.error=function(){return u},o);return y}function qc(a,e,t,n,r,i,s){var o=a.finalizeRunEffect(d);h.cancel=hr;var l={meta:r,cancel:f,status:Gi},c=JD(a,l,t,n,r,i,s),u={task:c,digestEffect:p};function f(){l.status===Gi&&(l.status=Bn,h(Ja))}return s&&(s.cancel=c.cancel),h(),c;function h(v,_){try{var m;_?(m=e.throw(v),V0()):b0(v)?(l.status=Bn,h.cancel(),m=Rr(e.return)?e.return(Ja):{done:!0,value:Ja}):S0(v)?m=Rr(e.return)?e.return():{done:!0}:m=e.next(v),m.done?(l.status!==Bn&&(l.status=F0),l.cont(m.value)):p(m.value,n,h)}catch(g){if(l.status===Bn)throw g;l.status=tc,l.cont(g,!0)}}function d(v,_,m){if(Xc(v))vd(v,m);else if(od(v))qc(a,v,c.context,_,r,!1,m);else if(v&&v[d0]){var g=XD[v.type];g(a,v.payload,m,u)}else m(v)}function p(v,_,m,g){g===void 0&&(g="");var y=B0();a.sagaMonitor&&a.sagaMonitor.effectTriggered({effectId:y,parentEffectId:_,label:g,effect:v});var x;function S(M,E){x||(x=!0,m.cancel=hr,a.sagaMonitor&&(E?a.sagaMonitor.effectRejected(y,M):a.sagaMonitor.effectResolved(y,M)),E&&ZD(v),m(M,E))}S.cancel=hr,m.cancel=function(){x||(x=!0,S.cancel(),S.cancel=hr,a.sagaMonitor&&a.sagaMonitor.effectCancelled(y))},o(v,y,S)}}function QD(a,e){for(var t=a.channel,n=t===void 0?D0():t,r=a.dispatch,i=a.getState,s=a.context,o=s===void 0?{}:s,l=a.sagaMonitor,c=a.effectMiddlewares,u=a.onError,f=u===void 0?JO:u,h=arguments.length,d=new Array(h>2?h-2:0),p=2;p<h;p++)d[p-2]=arguments[p];var v=e.apply(void 0,d),_=B0();l&&(l.rootSagaStarted=l.rootSagaStarted||hr,l.effectTriggered=l.effectTriggered||hr,l.effectResolved=l.effectResolved||hr,l.effectRejected=l.effectRejected||hr,l.effectCancelled=l.effectCancelled||hr,l.actionDispatched=l.actionDispatched||hr,l.rootSagaStarted({effectId:_,saga:e,args:d}));var m;if(c){var g=eD.apply(void 0,c);m=function(S){return function(M,E,N){var B=function(O){return S(O,E,N)};return g(B)(M)}}}else m=YO;var y={channel:n,dispatch:QO(r),getState:i,sagaMonitor:l,onError:f,finalizeRunEffect:m};return N0(function(){var x=qc(y,v,o,_,ud(e),!0,void 0);return l&&l.effectResolved(_,x),x})}function e4(a){var e={},t=e.context,n=t===void 0?{}:t,r=e.channel,i=r===void 0?D0():r,s=e.sagaMonitor,o=ty(e,["context","channel","sagaMonitor"]),l;function c(u){var f=u.getState,h=u.dispatch;return l=QD.bind(null,Xi({},o,{context:n,channel:i,dispatch:h,getState:f,sagaMonitor:s})),function(d){return function(p){s&&s.actionDispatched&&s.actionDispatched(p);var v=d(p);return i.put(p),v}}}return c.run=function(){return l.apply(void 0,arguments)},c.setContext=function(u){cd(n,u)},c}function sn(a){for(var e=arguments.length,t=Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];throw Error("[Immer] minified error nr: "+a+(t.length?" "+t.map(function(r){return"'"+r+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function Mi(a){return!!a&&!!a[Rt]}function Xn(a){var e;return!!a&&(function(t){if(!t||typeof t!="object")return!1;var n=Object.getPrototypeOf(t);if(n===null)return!0;var r=Object.hasOwnProperty.call(n,"constructor")&&n.constructor;return r===Object||typeof r=="function"&&Function.toString.call(r)===c4}(a)||Array.isArray(a)||!!a[Tv]||!!(!((e=a.constructor)===null||e===void 0)&&e[Tv])||_d(a)||yd(a))}function Ki(a,e,t){t===void 0&&(t=!1),ws(a)===0?(t?Object.keys:es)(a).forEach(function(n){t&&typeof n=="symbol"||e(n,a[n],a)}):a.forEach(function(n,r){return e(r,n,a)})}function ws(a){var e=a[Rt];return e?e.i>3?e.i-4:e.i:Array.isArray(a)?1:_d(a)?2:yd(a)?3:0}function Qa(a,e){return ws(a)===2?a.has(e):Object.prototype.hasOwnProperty.call(a,e)}function t4(a,e){return ws(a)===2?a.get(e):a[e]}function U0(a,e,t){var n=ws(a);n===2?a.set(e,t):n===3?a.add(t):a[e]=t}function G0(a,e){return a===e?a!==0||1/a==1/e:a!=a&&e!=e}function _d(a){return o4&&a instanceof Map}function yd(a){return l4&&a instanceof Set}function Ui(a){return a.o||a.t}function xd(a){if(Array.isArray(a))return Array.prototype.slice.call(a);var e=W0(a);delete e[Rt];for(var t=es(e),n=0;n<t.length;n++){var r=t[n],i=e[r];i.writable===!1&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(e[r]={configurable:!0,writable:!0,enumerable:i.enumerable,value:a[r]})}return Object.create(Object.getPrototypeOf(a),e)}function Sd(a,e){return e===void 0&&(e=!1),bd(a)||Mi(a)||!Xn(a)||(ws(a)>1&&(a.set=a.add=a.clear=a.delete=r4),Object.freeze(a),e&&Ki(a,function(t,n){return Sd(n,!0)},!0)),a}function r4(){sn(2)}function bd(a){return a==null||typeof a!="object"||Object.isFrozen(a)}function Sn(a){var e=Kf[a];return e||sn(18,a),e}function n4(a,e){Kf[a]||(Kf[a]=e)}function qf(){return yo}function df(a,e){e&&(Sn("Patches"),a.u=[],a.s=[],a.v=e)}function mc(a){$f(a),a.p.forEach(i4),a.p=null}function $f(a){a===yo&&(yo=a.l)}function bv(a){return yo={p:[],l:yo,h:a,m:!0,_:0}}function i4(a){var e=a[Rt];e.i===0||e.i===1?e.j():e.g=!0}function pf(a,e){e._=e.p.length;var t=e.p[0],n=a!==void 0&&a!==t;return e.h.O||Sn("ES5").S(e,a,n),n?(t[Rt].P&&(mc(e),sn(4)),Xn(a)&&(a=vc(e,a),e.l||gc(e,a)),e.u&&Sn("Patches").M(t[Rt].t,a,e.u,e.s)):a=vc(e,t,[]),mc(e),e.u&&e.v(e.u,e.s),a!==H0?a:void 0}function vc(a,e,t){if(bd(e))return e;var n=e[Rt];if(!n)return Ki(e,function(o,l){return wv(a,n,e,o,l,t)},!0),e;if(n.A!==a)return e;if(!n.P)return gc(a,n.t,!0),n.t;if(!n.I){n.I=!0,n.A._--;var r=n.i===4||n.i===5?n.o=xd(n.k):n.o,i=r,s=!1;n.i===3&&(i=new Set(r),r.clear(),s=!0),Ki(i,function(o,l){return wv(a,n,r,o,l,t,s)}),gc(a,r,!1),t&&a.u&&Sn("Patches").N(n,t,a.u,a.s)}return n.o}function wv(a,e,t,n,r,i,s){if(Mi(r)){var o=vc(a,r,i&&e&&e.i!==3&&!Qa(e.R,n)?i.concat(n):void 0);if(U0(t,n,o),!Mi(o))return;a.m=!1}else s&&t.add(r);if(Xn(r)&&!bd(r)){if(!a.h.D&&a._<1)return;vc(a,r),e&&e.A.l||gc(a,r)}}function gc(a,e,t){t===void 0&&(t=!1),!a.l&&a.h.D&&a.m&&Sd(e,t)}function mf(a,e){var t=a[Rt];return(t?Ui(t):a)[e]}function Mv(a,e){if(e in a)for(var t=Object.getPrototypeOf(a);t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}}function li(a){a.P||(a.P=!0,a.l&&li(a.l))}function vf(a){a.o||(a.o=xd(a.t))}function Zf(a,e,t){var n=_d(e)?Sn("MapSet").F(e,t):yd(e)?Sn("MapSet").T(e,t):a.O?function(r,i){var s=Array.isArray(r),o={i:s?1:0,A:i?i.A:qf(),P:!1,I:!1,R:{},l:i,t:r,k:null,o:null,j:null,C:!1},l=o,c=xo;s&&(l=[o],c=qs);var u=Proxy.revocable(l,c),f=u.revoke,h=u.proxy;return o.k=h,o.j=f,h}(e,t):Sn("ES5").J(e,t);return(t?t.A:qf()).p.push(n),n}function a4(a){return Mi(a)||sn(22,a),function e(t){if(!Xn(t))return t;var n,r=t[Rt],i=ws(t);if(r){if(!r.P&&(r.i<4||!Sn("ES5").K(r)))return r.t;r.I=!0,n=Ev(t,i),r.I=!1}else n=Ev(t,i);return Ki(n,function(s,o){r&&t4(r.t,s)===o||U0(n,s,e(o))}),i===3?new Set(n):n}(a)}function Ev(a,e){switch(e){case 2:return new Map(a);case 3:return Array.from(a)}return xd(a)}function s4(){function a(i,s){var o=r[i];return o?o.enumerable=s:r[i]=o={configurable:!0,enumerable:s,get:function(){var l=this[Rt];return xo.get(l,i)},set:function(l){var c=this[Rt];xo.set(c,i,l)}},o}function e(i){for(var s=i.length-1;s>=0;s--){var o=i[s][Rt];if(!o.P)switch(o.i){case 5:n(o)&&li(o);break;case 4:t(o)&&li(o)}}}function t(i){for(var s=i.t,o=i.k,l=es(o),c=l.length-1;c>=0;c--){var u=l[c];if(u!==Rt){var f=s[u];if(f===void 0&&!Qa(s,u))return!0;var h=o[u],d=h&&h[Rt];if(d?d.t!==f:!G0(h,f))return!0}}var p=!!s[Rt];return l.length!==es(s).length+(p?0:1)}function n(i){var s=i.k;if(s.length!==i.t.length)return!0;var o=Object.getOwnPropertyDescriptor(s,s.length-1);if(o&&!o.get)return!0;for(var l=0;l<s.length;l++)if(!s.hasOwnProperty(l))return!0;return!1}var r={};n4("ES5",{J:function(i,s){var o=Array.isArray(i),l=function(u,f){if(u){for(var h=Array(f.length),d=0;d<f.length;d++)Object.defineProperty(h,""+d,a(d,!0));return h}var p=W0(f);delete p[Rt];for(var v=es(p),_=0;_<v.length;_++){var m=v[_];p[m]=a(m,u||!!p[m].enumerable)}return Object.create(Object.getPrototypeOf(f),p)}(o,i),c={i:o?5:4,A:s?s.A:qf(),P:!1,I:!1,R:{},l:s,t:i,k:l,o:null,g:!1,C:!1};return Object.defineProperty(l,Rt,{value:c,writable:!0}),l},S:function(i,s,o){o?Mi(s)&&s[Rt].A===i&&e(i.p):(i.u&&function l(c){if(c&&typeof c=="object"){var u=c[Rt];if(u){var f=u.t,h=u.k,d=u.R,p=u.i;if(p===4)Ki(h,function(y){y!==Rt&&(f[y]!==void 0||Qa(f,y)?d[y]||l(h[y]):(d[y]=!0,li(u)))}),Ki(f,function(y){h[y]!==void 0||Qa(h,y)||(d[y]=!1,li(u))});else if(p===5){if(n(u)&&(li(u),d.length=!0),h.length<f.length)for(var v=h.length;v<f.length;v++)d[v]=!1;else for(var _=f.length;_<h.length;_++)d[_]=!0;for(var m=Math.min(h.length,f.length),g=0;g<m;g++)h.hasOwnProperty(g)||(d[g]=!0),d[g]===void 0&&l(h[g])}}}}(i.p[0]),e(i.p))},K:function(i){return i.i===4?t(i):n(i)}})}var Cv,yo,wd=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",o4=typeof Map<"u",l4=typeof Set<"u",Av=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",H0=wd?Symbol.for("immer-nothing"):((Cv={})["immer-nothing"]=!0,Cv),Tv=wd?Symbol.for("immer-draftable"):"__$immer_draftable",Rt=wd?Symbol.for("immer-state"):"__$immer_state",c4=""+Object.prototype.constructor,es=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(a){return Object.getOwnPropertyNames(a).concat(Object.getOwnPropertySymbols(a))}:Object.getOwnPropertyNames,W0=Object.getOwnPropertyDescriptors||function(a){var e={};return es(a).forEach(function(t){e[t]=Object.getOwnPropertyDescriptor(a,t)}),e},Kf={},xo={get:function(a,e){if(e===Rt)return a;var t=Ui(a);if(!Qa(t,e))return function(r,i,s){var o,l=Mv(i,s);return l?"value"in l?l.value:(o=l.get)===null||o===void 0?void 0:o.call(r.k):void 0}(a,t,e);var n=t[e];return a.I||!Xn(n)?n:n===mf(a.t,e)?(vf(a),a.o[e]=Zf(a.A.h,n,a)):n},has:function(a,e){return e in Ui(a)},ownKeys:function(a){return Reflect.ownKeys(Ui(a))},set:function(a,e,t){var n=Mv(Ui(a),e);if(n!=null&&n.set)return n.set.call(a.k,t),!0;if(!a.P){var r=mf(Ui(a),e),i=r==null?void 0:r[Rt];if(i&&i.t===t)return a.o[e]=t,a.R[e]=!1,!0;if(G0(t,r)&&(t!==void 0||Qa(a.t,e)))return!0;vf(a),li(a)}return a.o[e]===t&&(t!==void 0||e in a.o)||Number.isNaN(t)&&Number.isNaN(a.o[e])||(a.o[e]=t,a.R[e]=!0),!0},deleteProperty:function(a,e){return mf(a.t,e)!==void 0||e in a.t?(a.R[e]=!1,vf(a),li(a)):delete a.R[e],a.o&&delete a.o[e],!0},getOwnPropertyDescriptor:function(a,e){var t=Ui(a),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:a.i!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty:function(){sn(11)},getPrototypeOf:function(a){return Object.getPrototypeOf(a.t)},setPrototypeOf:function(){sn(12)}},qs={};Ki(xo,function(a,e){qs[a]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}}),qs.deleteProperty=function(a,e){return qs.set.call(this,a,e,void 0)},qs.set=function(a,e,t){return xo.set.call(this,a[0],e,t,a[0])};var u4=function(){function a(t){var n=this;this.O=Av,this.D=!0,this.produce=function(r,i,s){if(typeof r=="function"&&typeof i!="function"){var o=i;i=r;var l=n;return function(v){var _=this;v===void 0&&(v=o);for(var m=arguments.length,g=Array(m>1?m-1:0),y=1;y<m;y++)g[y-1]=arguments[y];return l.produce(v,function(x){var S;return(S=i).call.apply(S,[_,x].concat(g))})}}var c;if(typeof i!="function"&&sn(6),s!==void 0&&typeof s!="function"&&sn(7),Xn(r)){var u=bv(n),f=Zf(n,r,void 0),h=!0;try{c=i(f),h=!1}finally{h?mc(u):$f(u)}return typeof Promise<"u"&&c instanceof Promise?c.then(function(v){return df(u,s),pf(v,u)},function(v){throw mc(u),v}):(df(u,s),pf(c,u))}if(!r||typeof r!="object"){if((c=i(r))===void 0&&(c=r),c===H0&&(c=void 0),n.D&&Sd(c,!0),s){var d=[],p=[];Sn("Patches").M(r,c,d,p),s(d,p)}return c}sn(21,r)},this.produceWithPatches=function(r,i){if(typeof r=="function")return function(c){for(var u=arguments.length,f=Array(u>1?u-1:0),h=1;h<u;h++)f[h-1]=arguments[h];return n.produceWithPatches(c,function(d){return r.apply(void 0,[d].concat(f))})};var s,o,l=n.produce(r,i,function(c,u){s=c,o=u});return typeof Promise<"u"&&l instanceof Promise?l.then(function(c){return[c,s,o]}):[l,s,o]},typeof(t==null?void 0:t.useProxies)=="boolean"&&this.setUseProxies(t.useProxies),typeof(t==null?void 0:t.autoFreeze)=="boolean"&&this.setAutoFreeze(t.autoFreeze)}var e=a.prototype;return e.createDraft=function(t){Xn(t)||sn(8),Mi(t)&&(t=a4(t));var n=bv(this),r=Zf(this,t,void 0);return r[Rt].C=!0,$f(n),r},e.finishDraft=function(t,n){var r=t&&t[Rt],i=r.A;return df(i,n),pf(void 0,i)},e.setAutoFreeze=function(t){this.D=t},e.setUseProxies=function(t){t&&!Av&&sn(20),this.O=t},e.applyPatches=function(t,n){var r;for(r=n.length-1;r>=0;r--){var i=n[r];if(i.path.length===0&&i.op==="replace"){t=i.value;break}}r>-1&&(n=n.slice(r+1));var s=Sn("Patches").$;return Mi(t)?s(t,n):this.produce(t,function(o){return s(o,n)})},a}(),Vr=new u4,X0=Vr.produce;Vr.produceWithPatches.bind(Vr);Vr.setAutoFreeze.bind(Vr);Vr.setUseProxies.bind(Vr);Vr.applyPatches.bind(Vr);Vr.createDraft.bind(Vr);Vr.finishDraft.bind(Vr);var j0=function(){var a=function(e,t){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(n[i]=r[i])},a(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");a(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}}(),f4=function(a,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,r,i,s;return s={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function o(c){return function(u){return l([c,u])}}function l(c){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,r&&(i=c[0]&2?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[c[0]&2,i.value]),c[0]){case 0:case 1:i=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,r=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!i||c[1]>i[0]&&c[1]<i[3])){t.label=c[1];break}if(c[0]===6&&t.label<i[1]){t.label=i[1],i=c;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(c);break}i[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(a,t)}catch(u){c=[6,u],r=0}finally{n=i=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}},is=function(a,e){for(var t=0,n=e.length,r=a.length;t<n;t++,r++)a[r]=e[t];return a},h4=Object.defineProperty,d4=Object.defineProperties,p4=Object.getOwnPropertyDescriptors,Rv=Object.getOwnPropertySymbols,m4=Object.prototype.hasOwnProperty,v4=Object.prototype.propertyIsEnumerable,Lv=function(a,e,t){return e in a?h4(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t},_i=function(a,e){for(var t in e||(e={}))m4.call(e,t)&&Lv(a,t,e[t]);if(Rv)for(var n=0,r=Rv(e);n<r.length;n++){var t=r[n];v4.call(e,t)&&Lv(a,t,e[t])}return a},gf=function(a,e){return d4(a,p4(e))},g4=function(a,e,t){return new Promise(function(n,r){var i=function(l){try{o(t.next(l))}catch(c){r(c)}},s=function(l){try{o(t.throw(l))}catch(c){r(c)}},o=function(l){return l.done?n(l.value):Promise.resolve(l.value).then(i,s)};o((t=t.apply(a,e)).next())})},_4=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?xf:xf.apply(null,arguments)};function y4(a){if(typeof a!="object"||a===null)return!1;var e=Object.getPrototypeOf(a);if(e===null)return!0;for(var t=e;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return e===t}function yi(a,e){function t(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];if(e){var i=e.apply(void 0,n);if(!i)throw new Error("prepareAction did not return an object");return _i(_i({type:a,payload:i.payload},"meta"in i&&{meta:i.meta}),"error"in i&&{error:i.error})}return{type:a,payload:n[0]}}return t.toString=function(){return""+a},t.type=a,t.match=function(n){return n.type===a},t}var x4=function(a){j0(e,a);function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=a.apply(this,t)||this;return Object.setPrototypeOf(r,e.prototype),r}return Object.defineProperty(e,Symbol.species,{get:function(){return e},enumerable:!1,configurable:!0}),e.prototype.concat=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return a.prototype.concat.apply(this,t)},e.prototype.prepend=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.length===1&&Array.isArray(t[0])?new(e.bind.apply(e,is([void 0],t[0].concat(this)))):new(e.bind.apply(e,is([void 0],t.concat(this))))},e}(Array),S4=function(a){j0(e,a);function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=a.apply(this,t)||this;return Object.setPrototypeOf(r,e.prototype),r}return Object.defineProperty(e,Symbol.species,{get:function(){return e},enumerable:!1,configurable:!0}),e.prototype.concat=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return a.prototype.concat.apply(this,t)},e.prototype.prepend=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.length===1&&Array.isArray(t[0])?new(e.bind.apply(e,is([void 0],t[0].concat(this)))):new(e.bind.apply(e,is([void 0],t.concat(this))))},e}(Array);function Jf(a){return Xn(a)?X0(a,function(){}):a}function b4(a){return typeof a=="boolean"}function w4(){return function(e){return M4(e)}}function M4(a){a===void 0&&(a={});var e=a.thunk,t=e===void 0?!0:e;a.immutableCheck,a.serializableCheck,a.actionCreatorCheck;var n=new x4;return t&&(b4(t)?n.push(Ad):n.push(Ad.withExtraArgument(t.extraArgument))),n}function E4(a){var e=w4(),t=a,n=t.reducer,r=n===void 0?void 0:n,i=t.middleware,s=i===void 0?e():i,o=t.devTools,l=o===void 0?!0:o,c=t.preloadedState,u=c===void 0?void 0:c,f=t.enhancers,h=f===void 0?void 0:f,d;if(typeof r=="function")d=r;else if(y4(r))d=ry(r);else throw new Error('"reducer" is a required argument, and must be a function or an object of functions that can be passed to combineReducers');var p=s;typeof p=="function"&&(p=p(e));var v=ny.apply(void 0,p),_=xf;l&&(_=_4(_i({trace:!1},typeof l=="object"&&l)));var m=new S4(v),g=m;Array.isArray(h)?g=is([v],h):typeof h=="function"&&(g=h(m));var y=_.apply(void 0,g);return iy(d,u,y)}function Y0(a){var e={},t=[],n,r={addCase:function(i,s){var o=typeof i=="string"?i:i.type;if(!o)throw new Error("`builder.addCase` cannot be called with an empty action type");if(o in e)throw new Error("`builder.addCase` cannot be called with two reducers for the same action type");return e[o]=s,r},addMatcher:function(i,s){return t.push({matcher:i,reducer:s}),r},addDefaultCase:function(i){return n=i,r}};return a(r),[e,t,n]}function C4(a){return typeof a=="function"}function A4(a,e,t,n){t===void 0&&(t=[]);var r=typeof e=="function"?Y0(e):[e,t,n],i=r[0],s=r[1],o=r[2],l;if(C4(a))l=function(){return Jf(a())};else{var c=Jf(a);l=function(){return c}}function u(f,h){f===void 0&&(f=l());var d=is([i[h.type]],s.filter(function(p){var v=p.matcher;return v(h)}).map(function(p){var v=p.reducer;return v}));return d.filter(function(p){return!!p}).length===0&&(d=[o]),d.reduce(function(p,v){if(v)if(Mi(p)){var _=p,m=v(_,h);return m===void 0?p:m}else{if(Xn(p))return X0(p,function(g){return v(g,h)});var m=v(p,h);if(m===void 0){if(p===null)return p;throw Error("A case reducer on a non-draftable value must not return undefined")}return m}return p},f)}return u.getInitialState=l,u}function T4(a,e){return a+"/"+e}function R4(a){var e=a.name;if(!e)throw new Error("`name` is a required option for createSlice");var t=typeof a.initialState=="function"?a.initialState:Jf(a.initialState),n=a.reducers||{},r=Object.keys(n),i={},s={},o={};r.forEach(function(u){var f=n[u],h=T4(e,u),d,p;"reducer"in f?(d=f.reducer,p=f.prepare):d=f,i[u]=d,s[h]=d,o[u]=p?yi(h,p):yi(h)});function l(){var u=typeof a.extraReducers=="function"?Y0(a.extraReducers):[a.extraReducers],f=u[0],h=f===void 0?{}:f,d=u[1],p=d===void 0?[]:d,v=u[2],_=v===void 0?void 0:v,m=_i(_i({},h),s);return A4(t,function(g){for(var y in m)g.addCase(y,m[y]);for(var x=0,S=p;x<S.length;x++){var M=S[x];g.addMatcher(M.matcher,M.reducer)}_&&g.addDefaultCase(_)})}var c;return{name:e,reducer:function(u,f){return c||(c=l()),c(u,f)},actions:o,caseReducers:i,getInitialState:function(){return c||(c=l()),c.getInitialState()}}}var L4="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW",P4=function(a){a===void 0&&(a=21);for(var e="",t=a;t--;)e+=L4[Math.random()*64|0];return e},N4=["name","message","stack","code"],_f=function(){function a(e,t){this.payload=e,this.meta=t}return a}(),Pv=function(){function a(e,t){this.payload=e,this.meta=t}return a}(),I4=function(a){if(typeof a=="object"&&a!==null){for(var e={},t=0,n=N4;t<n.length;t++){var r=n[t];typeof a[r]=="string"&&(e[r]=a[r])}return e}return{message:String(a)}};(function(){function a(e,t,n){var r=yi(e+"/fulfilled",function(c,u,f,h){return{payload:c,meta:gf(_i({},h||{}),{arg:f,requestId:u,requestStatus:"fulfilled"})}}),i=yi(e+"/pending",function(c,u,f){return{payload:void 0,meta:gf(_i({},f||{}),{arg:u,requestId:c,requestStatus:"pending"})}}),s=yi(e+"/rejected",function(c,u,f,h,d){return{payload:h,error:(n&&n.serializeError||I4)(c||"Rejected"),meta:gf(_i({},d||{}),{arg:f,requestId:u,rejectedWithValue:!!h,requestStatus:"rejected",aborted:(c==null?void 0:c.name)==="AbortError",condition:(c==null?void 0:c.name)==="ConditionError"})}}),o=typeof AbortController<"u"?AbortController:function(){function c(){this.signal={aborted:!1,addEventListener:function(){},dispatchEvent:function(){return!1},onabort:function(){},removeEventListener:function(){},reason:void 0,throwIfAborted:function(){}}}return c.prototype.abort=function(){},c}();function l(c){return function(u,f,h){var d=n!=null&&n.idGenerator?n.idGenerator(c):P4(),p=new o,v;function _(g){v=g,p.abort()}var m=function(){return g4(this,null,function(){var g,y,x,S,M,E,N;return f4(this,function(B){switch(B.label){case 0:return B.trys.push([0,4,,5]),S=(g=n==null?void 0:n.condition)==null?void 0:g.call(n,c,{getState:f,extra:h}),O4(S)?[4,S]:[3,2];case 1:S=B.sent(),B.label=2;case 2:if(S===!1||p.signal.aborted)throw{name:"ConditionError",message:"Aborted due to condition callback returning false."};return M=new Promise(function(V,O){return p.signal.addEventListener("abort",function(){return O({name:"AbortError",message:v||"Aborted"})})}),u(i(d,c,(y=n==null?void 0:n.getPendingMeta)==null?void 0:y.call(n,{requestId:d,arg:c},{getState:f,extra:h}))),[4,Promise.race([M,Promise.resolve(t(c,{dispatch:u,getState:f,extra:h,requestId:d,signal:p.signal,abort:_,rejectWithValue:function(V,O){return new _f(V,O)},fulfillWithValue:function(V,O){return new Pv(V,O)}})).then(function(V){if(V instanceof _f)throw V;return V instanceof Pv?r(V.payload,d,c,V.meta):r(V,d,c)})])];case 3:return x=B.sent(),[3,5];case 4:return E=B.sent(),x=E instanceof _f?s(null,d,c,E.payload,E.meta):s(E,d,c),[3,5];case 5:return N=n&&!n.dispatchConditionRejection&&s.match(x)&&x.meta.condition,N||u(x),[2,x]}})})}();return Object.assign(m,{abort:_,requestId:d,arg:c,unwrap:function(){return m.then(k4)}})}}return Object.assign(l,{pending:i,rejected:s,fulfilled:r,typePrefix:e})}return a.withTypes=function(){return a},a})();function k4(a){if(a.meta&&a.meta.rejectedWithValue)throw a.payload;if(a.error)throw a.error;return a.payload}function O4(a){return a!==null&&typeof a=="object"&&typeof a.then=="function"}var Md="listenerMiddleware";yi(Md+"/add");yi(Md+"/removeAll");yi(Md+"/remove");var Nv;typeof queueMicrotask=="function"&&queueMicrotask.bind(typeof window<"u"?window:typeof rc<"u"?rc:globalThis);s4();var Iv=function(e){return{done:!0,value:e}},yf={};function D4(a){return ld(a)?"channel":_0(a)?String(a):Rr(a)?a.name:String(a)}function F4(a,e,t){var n,r,i,s=e;function o(l,c){if(s===yf)return Iv(l);if(c&&!r)throw s=yf,c;n&&n(l);var u=c?a[r](c):a[s]();return s=u.nextState,i=u.effect,n=u.stateUpdater,r=u.errorState,s===yf?Iv(l):i}return Yf(o,function(l){return o(null,l)},t)}function B4(a,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),r=2;r<t;r++)n[r-2]=arguments[r];var i={done:!1,value:_D(a)},s=function(u){return{done:!1,value:hd.apply(void 0,[e].concat(n,[u]))}},o,l=function(u){return o=u};return F4({q1:function(){return{nextState:"q2",effect:i,stateUpdater:l}},q2:function(){return{nextState:"q1",effect:s(o)}}},"q1","takeEvery("+D4(a)+", "+e.name+")")}function z4(a,e){for(var t=arguments.length,n=new Array(t>2?t-2:0),r=2;r<t;r++)n[r-2]=arguments[r];return hd.apply(void 0,[B4,a,e].concat(n))}var V4={isInitialized:!1,data:void 0,error:void 0},q0=R4({name:"init",initialState:V4,reducers:{INIT:function(e){e.isInitialized=!1,e.data=void 0,e.error=void 0},INIT_SUCCESS:function(e,t){e.isInitialized=!0,e.data=t.payload,e.error=void 0},INIT_FAIL:function(e,t){e.isInitialized=!1,e.data=void 0,e.error=t.payload}}}),Ed=q0.actions,U4=Ed.INIT,G4=Ed.INIT_SUCCESS,H4=Ed.INIT_FAIL,W4=q0.reducer,X4=as.mark($0),j4=as.mark(Z0),Y4=function(e){return new Promise(function(t){return setTimeout(function(){return t("data fetched from ".concat(e))},2e3)})},q4="some/url";function $0(){var a;return as.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,yD(Y4,q4);case 3:return a=t.sent,t.next=6,yv(G4(a));case 6:t.next=12;break;case 8:return t.prev=8,t.t0=t.catch(0),t.next=12,yv(H4("SAMPLE ERROR"));case 12:case"end":return t.stop()}},X4,null,[[0,8]])}function Z0(){return as.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,z4(U4,$0);case 2:case"end":return e.stop()}},j4)}var $4=as.mark(K0);function K0(){return as.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,xD(Z0);case 2:case"end":return e.stop()}},$4)}var J0=e4(),Z4=E4({reducer:{init:W4},middleware:function(e){return e().concat(J0)}});J0.run(K0);var kv={palette:{accent:{main:"#2E6DA4",dark:"#204D74",light:"#337AB7"},primary:{main:"#DDD",light:"#FFF",dark:"#DDD"},secondary:{main:"#333",light:"#C0C0C0",dark:"#383838"}},typography:{fontSize:16,fontFamily:"sans-serif"}};function Ov(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(a);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(a,r).enumerable})),t.push.apply(t,n)}return t}function K4(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ov(Object(t),!0).forEach(function(n){ly(a,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):Ov(Object(t)).forEach(function(n){Object.defineProperty(a,n,Object.getOwnPropertyDescriptor(t,n))})}return a}var Dv={smallWidth:800,smallHeight:400},J4=ay(),a5=function(e){var t=e.onInit,n=e.options,r=e.theme,i=r?le.merge(kv,r):kv,s=fr.useRef(null),o=zO({ref:s}),l=o.width,c=o.height,u=c&&c<=Dv.smallHeight||l&&l<=Dv.smallWidth,f=function(d){var p=d.miew.palette;return{backgroundColor:u?p.accent.main:p.primary.main,height:"100%",width:"100%","& > .miew-canvas":{height:"100%",width:"100%"}}};return fr.useLayoutEffect(function(){var h=new vr(K4({container:s==null?void 0:s.current},n));h.init()&&h.run(),typeof t=="function"&&t(h)},[n,t]),$c(oy,{store:Z4,children:cy(sy,{theme:le.merge(J4,{miew:i}),children:[$c(dy,{},void 0),$c("div",{ref:s,css:f},void 0)]},void 0)},void 0)};export{a5 as default};
